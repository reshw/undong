This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/settings.local.json
.env.example
.gitignore
.npmrc
deno.lock
docs/ARCHITECTURE.md
docs/database/APPLY_CARDIO_NORMALIZATION.md
docs/database/cardio_normalization.sql
docs/database/check_table_structure.sql
docs/database/club_dashboard_function.sql
docs/database/club_dashboard_widgets_migration.sql
docs/database/club_system_migration.sql
docs/database/club_system_no_rls.sql
docs/database/diagnose_and_fix.sql
docs/database/disable_rls_for_dev.sql
docs/database/find_base_table.sql
docs/database/fix_club_rls.sql
docs/database/fix_duration_type.sql
docs/database/matrix_classification_migration.sql
docs/database/migrate_data_only.sql
docs/database/migrations/migrate_test01_to_kakao.sql
docs/database/migrations/migrate-user-data.ts
docs/database/migrations/MIGRATION_GUIDE.md
docs/database/quest_builder_migration.sql
docs/database/README.md
docs/database/schema.sql
docs/database/two_track_challenge_migration.sql
docs/database/type_specific_metrics_migration.sql
docs/database/xp_system_migration.sql
docs/database/zero_copy_view_migration.sql
docs/features/club_dashboard_data_structure.md
docs/features/club_dashboard_widgets.md
docs/features/hall_of_fame_carousel.md
docs/features/smart_active_squad_implementation.md
docs/guides/how_to_add_new_badge.md
docs/PROJECT_OVERVIEW.md
docs/README.md
eslint.config.js
index.html
KAKAO_LOGIN_GUIDE.md
netlify.toml
netlify/functions/parse-workout.ts
package.json
public/vite.svg
README.md
src/App.css
src/App.tsx
src/assets/react.svg
src/components/BottomNav.tsx
src/components/challenge/ChallengeWizard.tsx
src/components/Footer.css
src/components/Footer.tsx
src/components/Header.tsx
src/components/KakaoCallback.tsx
src/components/KakaoLogin.tsx
src/config/features.ts
src/contexts/AuthContext.tsx
src/features/normalize/normalizeText.ts
src/features/parse/aiParserSchema.ts
src/features/parse/normalizeCardio.ts
src/features/parse/parseWithGPT.ts
src/features/parse/parseWorkoutText.ts
src/features/speech/useSpeechRecognition.ts
src/features/speech/useWhisperRecording.ts
src/index.css
src/lib/supabase.ts
src/main.tsx
src/pages/ChallengeDetail.tsx
src/pages/Club.tsx
src/pages/ClubDetail.tsx
src/pages/CreateClub.tsx
src/pages/Dashboard.tsx
src/pages/History.tsx
src/pages/JoinClub.tsx
src/pages/Login.tsx
src/pages/PrivacyPolicy.tsx
src/pages/Recommend.tsx
src/pages/Signup.tsx
src/pages/TermsOfService.tsx
src/pages/TodoList.tsx
src/services/authService.ts
src/services/challengeService.ts
src/services/clubService.ts
src/storage/challengeStorage.ts
src/storage/clubStorage.ts
src/storage/logStorage.ts
src/storage/supabaseStorage.ts
src/types/challenge.ts
src/types/index.ts
src/types/speech.d.ts
src/utils/ai.ts
src/utils/ai/parseWorkoutAPI.ts
src/utils/calculateMetrics.ts
src/utils/dashboardLogic.ts
src/utils/gemini.ts
src/utils/openai.ts
src/utils/workoutDisplay.ts
supabase_kakao_login_migration.sql
supabase_user_profiles.sql
tmp.txt
tmpclaude-25ef-cwd
tmpclaude-2bc3-cwd
tmpclaude-3174-cwd
tmpclaude-3b66-cwd
tmpclaude-40b2-cwd
tmpclaude-67b8-cwd
tmpclaude-910b-cwd
tmpclaude-a1b0-cwd
tmpclaude-ab04-cwd
tmpclaude-af09-cwd
tmpclaude-cb16-cwd
tmpclaude-d783-cwd
tmpclaude-ee76-cwd
tsconfig.app.json
tsconfig.json
tsconfig.node.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".npmrc">
legacy-peer-deps=true
</file>

<file path="deno.lock">
{
  "version": "5",
  "remote": {
    "https://edge.netlify.com/": "fd941d61d88673d5f28aab283fb86fcc50f08a3bc80ee5470498fcfa88c65cfb",
    "https://edge.netlify.com/bootstrap/config.ts": "6a2ce0e544e15e8f8883a5c18da5948e37fd0f2619f68cb31f3af53c51817025",
    "https://edge.netlify.com/bootstrap/context.ts": "e97240232121e2f369f6546ce961490f34d961ea1ea54be3ff09633e3f08373f",
    "https://edge.netlify.com/bootstrap/cookie.ts": "8b0baae708989ca183c6f3b4ab3d029e6abcbc2e43f93edeb0ff447b3bbc3a05",
    "https://edge.netlify.com/bootstrap/edge_function.ts": "b8253e86aa83c67341f5cfedeba5049d77fbf84dcab7eceff7566b7728ae9b39",
    "https://edge.netlify.com/bootstrap/globals/types.ts": "eaa6148ded3121d8dee62dd91c86e7fe76601df0f3ca8d7962243a30f4c8935f"
  },
  "workspace": {
    "packageJson": {
      "dependencies": [
        "npm:@eslint/js@^9.39.1",
        "npm:@google/generative-ai@~0.24.1",
        "npm:@supabase/supabase-js@^2.89.0",
        "npm:@types/node@^24.10.1",
        "npm:@types/react-dom@^19.2.3",
        "npm:@types/react@^19.2.5",
        "npm:@vitejs/plugin-react@^5.1.1",
        "npm:eslint-plugin-react-hooks@^7.0.1",
        "npm:eslint-plugin-react-refresh@~0.4.24",
        "npm:eslint@^9.39.1",
        "npm:globals@^16.5.0",
        "npm:openai@^6.15.0",
        "npm:react-dom@^19.2.0",
        "npm:react-router-dom@^7.11.0",
        "npm:react@^19.2.0",
        "npm:typescript-eslint@^8.46.4",
        "npm:typescript@~5.9.3",
        "npm:vite@^7.2.4"
      ]
    }
  }
}
</file>

<file path="docs/ARCHITECTURE.md">
# Voice Workout Log - Architecture

ì´ ë¬¸ì„œëŠ” Voice Workout Logì˜ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ë¥¼ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ëª©ì°¨
1. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”](#ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜-ê°œìš”)
2. [ë ˆì´ì–´ êµ¬ì¡°](#ë ˆì´ì–´-êµ¬ì¡°)
3. [ì£¼ìš” ì»´í¬ë„ŒíŠ¸](#ì£¼ìš”-ì»´í¬ë„ŒíŠ¸)
4. [ë°ì´í„° í”Œë¡œìš°](#ë°ì´í„°-í”Œë¡œìš°)
5. [ë³´ì•ˆ ì•„í‚¤í…ì²˜](#ë³´ì•ˆ-ì•„í‚¤í…ì²˜)
6. [ìƒíƒœ ê´€ë¦¬](#ìƒíƒœ-ê´€ë¦¬)
7. [ì—ëŸ¬ ì²˜ë¦¬](#ì—ëŸ¬-ì²˜ë¦¬)
8. [ì„±ëŠ¥ ìµœì í™”](#ì„±ëŠ¥-ìµœì í™”)
9. [í™•ì¥ì„± ê³ ë ¤ì‚¬í•­](#í™•ì¥ì„±-ê³ ë ¤ì‚¬í•­)

---

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°œìš”

Voice Workout LogëŠ” **3-Tier ì•„í‚¤í…ì²˜**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ SPA(Single Page Application)ì…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Presentation Layer              â”‚
â”‚  (React Components, Pages, UI)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Application Layer               â”‚
â”‚  (Hooks, Services, Features, Utils)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Data Layer                      â”‚
â”‚  (Supabase Storage, Local Storage)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         External Services               â”‚
â”‚  (Supabase, Kakao, Gemini, OpenAI)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í•µì‹¬ ì„¤ê³„ ì›ì¹™
1. **ê´€ì‹¬ì‚¬ì˜ ë¶„ë¦¬**: UI, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ë°ì´í„° ê³„ì¸µ ëª…í™•íˆ êµ¬ë¶„
2. **ë‹¨ì¼ ì±…ì„ ì›ì¹™**: ê° ëª¨ë“ˆì€ í•˜ë‚˜ì˜ ëª…í™•í•œ ì±…ì„ë§Œ ê°€ì§
3. **ì˜ì¡´ì„± ì—­ì „**: ìƒìœ„ ë ˆì´ì–´ê°€ í•˜ìœ„ ë ˆì´ì–´ì— ì˜ì¡´í•˜ì§€ë§Œ, ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ê²°í•©ë„ ë‚®ì¶¤
4. **í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±**: ê° ë ˆì´ì–´ë¥¼ ë…ë¦½ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„

---

## ë ˆì´ì–´ êµ¬ì¡°

### 1. Presentation Layer (í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µ)

**ìœ„ì¹˜**: `src/components/`, `src/pages/`

**ì±…ì„**:
- ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ë Œë”ë§
- ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
- ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœë¥¼ UIë¡œ í‘œí˜„

**ì£¼ìš” ì»´í¬ë„ŒíŠ¸**:
- **Pages**: ë¼ìš°íŠ¸ë³„ í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸ (Dashboard, History, TodoList ë“±)
- **Components**: ì¬ì‚¬ìš© ê°€ëŠ¥í•œ UI ì»´í¬ë„ŒíŠ¸ (Header, BottomNav ë“±)

**íŠ¹ì§•**:
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í¬í•¨í•˜ì§€ ì•ŠìŒ
- Propsë¥¼ í†µí•œ ë°ì´í„° ì „ë‹¬
- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ í†µí•œ ìƒìœ„ ê³„ì¸µê³¼ì˜ í†µì‹ 

**ì˜ˆì‹œ**:
```tsx
// History.tsx (í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸)
function History() {
  const { user } = useAuth();
  const [logs, setLogs] = useState<WorkoutLog[]>([]);

  // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ì„œë¹„ìŠ¤ ê³„ì¸µì— ìœ„ì„
  useEffect(() => {
    if (user) {
      supabaseStorage.getAllLogs(user.id).then(setLogs);
    }
  }, [user]);

  return (
    <div>
      {logs.map(log => (
        <LogCard key={log.id} log={log} />
      ))}
    </div>
  );
}
```

---

### 2. Application Layer (ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ)

**ìœ„ì¹˜**: `src/features/`, `src/services/`, `src/utils/`, `src/hooks/`

**ì±…ì„**:
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„
- ì™¸ë¶€ API í˜¸ì¶œ ë° ë°ì´í„° ë³€í™˜
- ë„ë©”ì¸ ê·œì¹™ ì ìš©

**ì£¼ìš” ëª¨ë“ˆ**:

#### Features (ê¸°ëŠ¥ ëª¨ë“ˆ)
ë„ë©”ì¸ë³„ë¡œ ê·¸ë£¹í™”ëœ ê¸°ëŠ¥ êµ¬í˜„

- **speech/**: ìŒì„± ì¸ì‹
  - `useSpeechRecognition.ts`: Web Speech API í›…
  - `useWhisperRecording.ts`: Whisper API ë…¹ìŒ ë° ì „ì†¡

- **parse/**: AI í…ìŠ¤íŠ¸ íŒŒì‹±
  - `parseWorkoutText.ts`: ë©”ì¸ íŒŒì‹± ë¡œì§
  - `parseWithGPT.ts`: GPT/Gemini API í˜¸ì¶œ

- **normalize/**: í…ìŠ¤íŠ¸ ì •ê·œí™”
  - `normalizeText.ts`: ì…ë ¥ í…ìŠ¤íŠ¸ ì •ì œ

#### Services (ì„œë¹„ìŠ¤)
ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ì˜ í†µí•©

- **authService.ts**: ì¸ì¦ ê´€ë ¨ ë¡œì§
  - Kakao OAuth ì²˜ë¦¬
  - Supabase ì„¸ì…˜ ê´€ë¦¬
  - ì‚¬ìš©ì ìƒì„± ë° ì¡°íšŒ

#### Utils (ìœ í‹¸ë¦¬í‹°)
ê³µí†µ í—¬í¼ í•¨ìˆ˜

- **ai.ts**: AI ê³µí†µ ìœ í‹¸ë¦¬í‹°
- **gemini.ts**: Gemini API ë˜í¼
- **openai.ts**: OpenAI API ë˜í¼

**ì˜ˆì‹œ**:
```ts
// parseWorkoutText.ts (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
export async function parseWorkoutText(text: string): Promise<Workout[]> {
  // 1. í…ìŠ¤íŠ¸ ì •ê·œí™”
  const normalized = normalizeText(text);

  // 2. AI íŒŒì‹± ì‹œë„
  try {
    const workouts = await parseWithGPT(normalized);
    return workouts;
  } catch (error) {
    console.error('AI parsing failed:', error);
    return [];
  }
}
```

---

### 3. Data Layer (ë°ì´í„° ê³„ì¸µ)

**ìœ„ì¹˜**: `src/storage/`, `src/lib/`

**ì±…ì„**:
- ë°ì´í„° ì˜ì†í™”
- CRUD ì‘ì—…
- ë°ì´í„° ì†ŒìŠ¤ ì¶”ìƒí™”

**ì£¼ìš” ëª¨ë“ˆ**:

#### Storage
- **supabaseStorage.ts**: Supabase ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ
  - ëª¨ë“  Supabase ì¿¼ë¦¬ë¥¼ ì´ íŒŒì¼ì— ì§‘ì¤‘
  - RLS ì •ì±… ì ìš©ëœ ì•ˆì „í•œ ë°ì´í„° ì ‘ê·¼

- **logStorage.ts**: (ë ˆê±°ì‹œ) ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ (í–¥í›„ ì œê±° ì˜ˆì •)

#### Lib
- **supabase.ts**: Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”

**ë°ì´í„° ì ‘ê·¼ íŒ¨í„´**:
```ts
// supabaseStorage.ts
export const supabaseStorage = {
  // ìš´ë™ ê¸°ë¡ ì¡°íšŒ
  async getAllLogs(userId: string): Promise<WorkoutLog[]> {
    const { data, error } = await supabase
      .from('workout_logs')
      .select(`
        *,
        workouts (*)
      `)
      .eq('user_id', userId)
      .order('date', { ascending: false });

    if (error) throw error;
    return transformToWorkoutLogs(data);
  },

  // ìš´ë™ ê¸°ë¡ ì €ì¥
  async saveLog(log: WorkoutLog): Promise<void> {
    // íŠ¸ëœì­ì…˜ ë¡œì§
    const { data: logData, error: logError } = await supabase
      .from('workout_logs')
      .insert([{ /* log data */ }])
      .select()
      .single();

    if (logError) throw logError;

    // ê°œë³„ ìš´ë™ ì €ì¥
    const workoutsToInsert = log.workouts.map(workout => ({
      log_id: logData.id,
      ...workout
    }));

    const { error: workoutsError } = await supabase
      .from('workouts')
      .insert(workoutsToInsert);

    if (workoutsError) throw workoutsError;
  }
};
```

---

### 4. External Services Layer

Voice Workout LogëŠ” ë‹¤ìŒ ì™¸ë¶€ ì„œë¹„ìŠ¤ì— ì˜ì¡´í•©ë‹ˆë‹¤:

#### Supabase
- **PostgreSQL**: ë°ì´í„° ì €ì¥
- **Auth**: ì¸ì¦ ë° ì„¸ì…˜ ê´€ë¦¬
- **RLS**: Row Level Securityë¡œ ë°ì´í„° ê²©ë¦¬
- **Storage** (í–¥í›„): í”„ë¡œí•„ ì´ë¯¸ì§€ ë“±

#### Kakao API
- **OAuth 2.0**: ì†Œì…œ ë¡œê·¸ì¸
- **ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ**: í”„ë¡œí•„, ì´ë©”ì¼

#### Google Generative AI (Gemini)
- **í…ìŠ¤íŠ¸ ìƒì„±**: ìš´ë™ í…ìŠ¤íŠ¸ íŒŒì‹±
- **ì¶”ì²œ ì‹œìŠ¤í…œ**: ë§ì¶¤ ìš´ë™ ë£¨í‹´ ìƒì„±

#### OpenAI
- **GPT-4**: í…ìŠ¤íŠ¸ íŒŒì‹± (ëŒ€ì²´ ì˜µì…˜)
- **Whisper**: ìŒì„±-í…ìŠ¤íŠ¸ ë³€í™˜

---

## ì£¼ìš” ì»´í¬ë„ŒíŠ¸

### ì¸ì¦ í”Œë¡œìš° (AuthContext + authService)

```
User clicks "Kakao Login"
  â†“
Redirect to Kakao OAuth
  â†“
User authorizes
  â†“
Callback to /auth/kakao/callback
  â†“
KakaoCallback.tsx:
  - Extract access_token from URL
  - Call authService.getKakaoUserInfo(token)
  - Call authService.checkUserExistsByKakaoId(kakaoId)
  â†“
If user exists:
  - Create Supabase session
  - Redirect to /dashboard
  â†“
If new user:
  - Redirect to /signup
  - User fills in gender + goals
  - Call authService.registerKakaoUser(userData)
  - Create Supabase session
  - Redirect to /dashboard
```

**AuthContext.tsx**:
```tsx
interface AuthContextType {
  user: User | null;
  loading: boolean;
  signOut: () => Promise<void>;
}

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Supabase ì„¸ì…˜ ë¦¬ìŠ¤ë„ˆ
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        if (session?.user) {
          // Supabase auth user â†’ ìš°ë¦¬ DBì˜ user ì¡°íšŒ
          const userData = await authService.getUserBySupabaseId(session.user.id);
          setUser(userData);
        } else {
          setUser(null);
        }
        setLoading(false);
      }
    );

    return () => subscription.unsubscribe();
  }, []);

  return (
    <AuthContext.Provider value={{ user, loading, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}
```

---

### ìŒì„± ì…ë ¥ í”Œë¡œìš°

#### Web Speech API (useSpeechRecognition)
```tsx
export function useSpeechRecognition() {
  const [isListening, setIsListening] = useState(false);
  const [transcript, setTranscript] = useState('');
  const recognitionRef = useRef<SpeechRecognition | null>(null);

  useEffect(() => {
    if (!('webkitSpeechRecognition' in window)) {
      console.error('Speech recognition not supported');
      return;
    }

    const recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'ko-KR';

    recognition.onresult = (event) => {
      const result = event.results[0][0].transcript;
      setTranscript(result);
    };

    recognitionRef.current = recognition;
  }, []);

  const startListening = () => {
    recognitionRef.current?.start();
    setIsListening(true);
  };

  const stopListening = () => {
    recognitionRef.current?.stop();
    setIsListening(false);
  };

  return { isListening, transcript, startListening, stopListening };
}
```

#### Whisper API (useWhisperRecording)
```tsx
export function useWhisperRecording() {
  const [isRecording, setIsRecording] = useState(false);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const chunksRef = useRef<Blob[]>([]);

  const startRecording = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (e) => {
      chunksRef.current.push(e.data);
    };

    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(chunksRef.current, { type: 'audio/webm' });
      chunksRef.current = [];

      // Whisper APIë¡œ ì „ì†¡
      const transcript = await transcribeWithWhisper(audioBlob);
      // ... ì²˜ë¦¬
    };

    mediaRecorderRef.current = mediaRecorder;
    mediaRecorder.start();
    setIsRecording(true);
  };

  const stopRecording = () => {
    mediaRecorderRef.current?.stop();
    setIsRecording(false);
  };

  return { isRecording, startRecording, stopRecording };
}

async function transcribeWithWhisper(audioBlob: Blob): Promise<string> {
  const formData = new FormData();
  formData.append('file', audioBlob, 'recording.webm');
  formData.append('model', 'whisper-1');

  const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${import.meta.env.VITE_OPENAI_API_KEY}`,
    },
    body: formData,
  });

  const data = await response.json();
  return data.text;
}
```

---

### AI íŒŒì‹± í”Œë¡œìš°

```
ì›ë³¸ í…ìŠ¤íŠ¸: "ë²¤ì¹˜í”„ë ˆìŠ¤ 80í‚¤ë¡œ 10ê°œì”© 3ì„¸íŠ¸"
  â†“
normalizeText() â†’ "ë²¤ì¹˜í”„ë ˆìŠ¤ 80kg 10reps 3sets"
  â†“
parseWithGPT() â†’ Gemini/GPT API í˜¸ì¶œ
  â†“
AI ì‘ë‹µ: JSON ë°°ì—´
[
  {
    "name": "ë²¤ì¹˜í”„ë ˆìŠ¤",
    "type": "strength",
    "weight_kg": 80,
    "sets": 3,
    "reps": 10
  }
]
  â†“
TypeScript Workout[] ê°ì²´ë¡œ ë³€í™˜
```

**parseWithGPT.ts**:
```ts
export async function parseWithGPT(text: string): Promise<Workout[]> {
  const prompt = `
ë‹¤ìŒ ìš´ë™ ê¸°ë¡ í…ìŠ¤íŠ¸ë¥¼ JSON ë°°ì—´ë¡œ íŒŒì‹±í•˜ì„¸ìš”.

ì…ë ¥: "${text}"

ì¶œë ¥ í˜•ì‹:
[
  {
    "name": "ìš´ë™ ì´ë¦„",
    "type": "strength" | "cardio" | "stretching" | "sports",
    "sets": ìˆ«ì ë˜ëŠ” null,
    "reps": ìˆ«ì ë˜ëŠ” null,
    "weight_kg": ìˆ«ì ë˜ëŠ” null,
    "duration_min": ìˆ«ì ë˜ëŠ” null,
    "note": "ì¶”ê°€ ë©”ëª¨ ë˜ëŠ” null"
  }
]

ë°˜ë“œì‹œ ìœ íš¨í•œ JSONë§Œ ë°˜í™˜í•˜ì„¸ìš”.
`;

  const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
  const result = await model.generateContent(prompt);
  const response = await result.response;
  const jsonText = response.text().replace(/```json\n?/g, '').replace(/```\n?/g, '');

  const workouts = JSON.parse(jsonText);
  return workouts;
}
```

---

## ë°ì´í„° í”Œë¡œìš°

### ìš´ë™ ê¸°ë¡ ì €ì¥ í”Œë¡œìš°

```
[History.tsx]
  User clicks "ìŒì„± ì…ë ¥"
    â†“
  useSpeechRecognition.startListening()
    â†“
  Web Speech API â†’ transcript
    â†“
  User clicks "íŒŒì‹±"
    â†“
  parseWorkoutText(transcript)
    â†“
  [parseWorkoutText.ts]
    normalizeText(transcript)
      â†“
    parseWithGPT(normalized)
      â†“
    [parseWithGPT.ts]
      Gemini API call
        â†“
      JSON response â†’ Workout[]
    â†“
  [History.tsx]
    User confirms parsed workouts
      â†“
    supabaseStorage.saveLog({ date, workouts, rawText, ... })
      â†“
    [supabaseStorage.ts]
      INSERT into workout_logs
        â†“
      INSERT into workouts (batch)
        â†“
      SUCCESS
    â†“
  [History.tsx]
    Show success message
    Refresh logs list
```

### ìš´ë™ ì¶”ì²œ í”Œë¡œìš°

```
[Recommend.tsx]
  User clicks "ì¶”ì²œ ë°›ê¸°"
    â†“
  Load user profile + recent workout logs
    â†“
  Build context:
    - User goals: "ê·¼ë ¥ í–¥ìƒ, ì£¼ 5íšŒ ìš´ë™"
    - Recent workouts: [ë²¤ì¹˜í”„ë ˆìŠ¤, ìŠ¤ì¿¼íŠ¸, ...]
    â†“
  Call Gemini API with prompt:
    "ì‚¬ìš©ìì˜ ëª©í‘œì™€ ìµœê·¼ ìš´ë™ ì´ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ
     ì˜¤ëŠ˜ì˜ ìš´ë™ ë£¨í‹´ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”."
    â†“
  Gemini response:
    "ì˜¤ëŠ˜ì€ í•˜ì²´ ìš´ë™ì„ ì¶”ì²œí•©ë‹ˆë‹¤.
     1. ìŠ¤ì¿¼íŠ¸ 80kg 12reps 4sets
     2. ë ˆê·¸í”„ë ˆìŠ¤ 120kg 10reps 3sets
     ..."
    â†“
  Display recommendation
    â†“
  User clicks "íˆ¬ë‘ì— ì¶”ê°€"
    â†“
  Parse AI response â†’ DailyTodo object
    â†“
  Save to local state or Supabase (í–¥í›„)
```

---

## ë³´ì•ˆ ì•„í‚¤í…ì²˜

### Row Level Security (RLS)

Supabase RLSë¥¼ í†µí•´ ë°ì´í„° ê²©ë¦¬ ë° ì ‘ê·¼ ì œì–´.

#### users í…Œì´ë¸”
```sql
-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë ˆì½”ë“œë§Œ ì½ê¸° ê°€ëŠ¥
CREATE POLICY "Users can read own data"
  ON users FOR SELECT
  USING (auth.uid() = id);

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë ˆì½”ë“œë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Users can update own data"
  ON users FOR UPDATE
  USING (auth.uid() = id);
```

#### workout_logs í…Œì´ë¸”
```sql
-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë¡œê·¸ë§Œ ì½ê¸° ê°€ëŠ¥
CREATE POLICY "Users can read own logs"
  ON workout_logs FOR SELECT
  USING (auth.uid() = user_id);

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë¡œê·¸ë§Œ ì‚½ì… ê°€ëŠ¥
CREATE POLICY "Users can insert own logs"
  ON workout_logs FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë¡œê·¸ë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Users can update own logs"
  ON workout_logs FOR UPDATE
  USING (auth.uid() = user_id);

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë¡œê·¸ë§Œ ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Users can delete own logs"
  ON workout_logs FOR DELETE
  USING (auth.uid() = user_id);
```

#### workouts í…Œì´ë¸”
```sql
-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë¡œê·¸ì— ì†í•œ ìš´ë™ë§Œ ì½ê¸° ê°€ëŠ¥
CREATE POLICY "Users can read own workouts"
  ON workouts FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM workout_logs
      WHERE workout_logs.id = workouts.log_id
        AND workout_logs.user_id = auth.uid()
    )
  );

-- ì‚½ì…/ìˆ˜ì •/ì‚­ì œë„ ë™ì¼í•œ íŒ¨í„´
```

### ì¸ì¦ ë³´ì•ˆ

#### Kakao OAuth í”Œë¡œìš°
1. **Authorization Code Grant** ì‚¬ìš© (ê°€ì¥ ì•ˆì „í•œ OAuth í”Œë¡œìš°)
2. **Access Tokenì€ ì„œë²„ì—ì„œë§Œ ì‚¬ìš©** (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìµœì†Œ ë…¸ì¶œ)
3. **Supabase Sessionìœ¼ë¡œ ë³€í™˜** í›„ JWT í† í° ì‚¬ìš©

#### í™˜ê²½ ë³€ìˆ˜ ë³´ì•ˆ
- API í‚¤ëŠ” `.env` íŒŒì¼ì— ì €ì¥
- `.env`ëŠ” `.gitignore`ì— í¬í•¨
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…

#### CORS ì •ì±…
- SupabaseëŠ” í—ˆìš©ëœ ë„ë©”ì¸ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
- Kakao OAuth Redirect URIëŠ” í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë“±ë¡ í•„ìš”

---

## ìƒíƒœ ê´€ë¦¬

### ë¡œì»¬ ìƒíƒœ (useState)
ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” UI ìƒíƒœ
- í¼ ì…ë ¥ê°’
- ëª¨ë‹¬ ì—´ë¦¼/ë‹«í˜
- ë¡œë”© ìŠ¤í”¼ë„ˆ

### Context API (AuthContext)
ì „ì—­ì ìœ¼ë¡œ ê³µìœ í•´ì•¼ í•˜ëŠ” ìƒíƒœ
- í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì
- ì¸ì¦ ë¡œë”© ìƒíƒœ

### ì„œë²„ ìƒíƒœ (Supabase)
ë°±ì—”ë“œì—ì„œ ê´€ë¦¬í•˜ëŠ” ë°ì´í„°
- ìš´ë™ ê¸°ë¡
- ì‚¬ìš©ì í”„ë¡œí•„
- (í˜„ì¬ëŠ” ì§ì ‘ fetch, í–¥í›„ React Query ë„ì… ê³ ë ¤)

### ìƒíƒœ ê´€ë¦¬ íŒ¨í„´
```tsx
// âŒ ë‚˜ìœ ì˜ˆ: ì„œë²„ ìƒíƒœë¥¼ ë¡œì»¬ ìƒíƒœë¡œ ì¤‘ë³µ ê´€ë¦¬
const [user, setUser] = useState(null);
useEffect(() => {
  fetchUser().then(setUser);
}, []);

// âœ… ì¢‹ì€ ì˜ˆ: Contextë¡œ ì „ì—­ ê´€ë¦¬
const { user } = useAuth();

// âœ… ë” ì¢‹ì€ ì˜ˆ: React Query (í–¥í›„)
const { data: user, isLoading } = useQuery('user', fetchUser);
```

---

## ì—ëŸ¬ ì²˜ë¦¬

### ê³„ì¸µë³„ ì—ëŸ¬ ì²˜ë¦¬ ì „ëµ

#### Data Layer
```ts
export async function getAllLogs(userId: string): Promise<WorkoutLog[]> {
  const { data, error } = await supabase
    .from('workout_logs')
    .select('*')
    .eq('user_id', userId);

  if (error) {
    console.error('Failed to fetch logs:', error);
    throw new Error('ìš´ë™ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }

  return data;
}
```

#### Application Layer
```ts
export async function parseWorkoutText(text: string): Promise<Workout[]> {
  try {
    return await parseWithGPT(text);
  } catch (error) {
    console.error('AI parsing failed:', error);
    // í´ë°±: ë¹ˆ ë°°ì—´ ë˜ëŠ” ê¸°ë³¸ íŒŒì‹±
    return [];
  }
}
```

#### Presentation Layer
```tsx
function History() {
  const [error, setError] = useState<string | null>(null);

  const handleSaveLog = async (log: WorkoutLog) => {
    try {
      await supabaseStorage.saveLog(log);
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } catch (error) {
      setError('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
  };

  return (
    <div>
      {error && <ErrorMessage message={error} />}
      {/* ... */}
    </div>
  );
}
```

### ì—ëŸ¬ íƒ€ì…ë³„ ì²˜ë¦¬

| ì—ëŸ¬ ìœ í˜• | ì²˜ë¦¬ ë°©ë²• |
|---------|---------|
| ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ | ì¬ì‹œë„ ë¡œì§ + ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ |
| ì¸ì¦ ì—ëŸ¬ | ë¡œê·¸ì•„ì›ƒ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜ |
| ê¶Œí•œ ì—ëŸ¬ | 403 ì—ëŸ¬ í‘œì‹œ + ê³ ê°ì„¼í„° ì•ˆë‚´ |
| ìœ íš¨ì„± ê²€ì¦ ì‹¤íŒ¨ | í¼ í•„ë“œë³„ ì—ëŸ¬ ë©”ì‹œì§€ |
| AI API ì—ëŸ¬ | í´ë°± íŒŒì‹± ë˜ëŠ” ìˆ˜ë™ ì…ë ¥ ì•ˆë‚´ |

---

## ì„±ëŠ¥ ìµœì í™”

### í˜„ì¬ ì ìš©ëœ ìµœì í™”

#### 1. ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…
```tsx
// React.lazyë¡œ í˜ì´ì§€ë³„ ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…
const Dashboard = lazy(() => import('./pages/Dashboard'));
const History = lazy(() => import('./pages/History'));
```

#### 2. ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”
```ts
// âœ… ê´€ê³„ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ì¡°íšŒ (N+1 ë¬¸ì œ ë°©ì§€)
const { data } = await supabase
  .from('workout_logs')
  .select(`
    *,
    workouts (*)
  `)
  .eq('user_id', userId);

// âŒ ë‚˜ìœ ì˜ˆ: ê° ë¡œê·¸ë§ˆë‹¤ ë³„ë„ ì¿¼ë¦¬
for (const log of logs) {
  const workouts = await supabase
    .from('workouts')
    .select('*')
    .eq('log_id', log.id);
}
```

#### 3. ì¸ë±ìŠ¤ í™œìš©
```sql
-- workout_logs í…Œì´ë¸”ì— ë³µí•© ì¸ë±ìŠ¤
CREATE INDEX idx_workout_logs_user_date
  ON workout_logs(user_id, date DESC);

-- ìì£¼ ì¡°ì¸ë˜ëŠ” ì™¸ë˜ í‚¤ì— ì¸ë±ìŠ¤
CREATE INDEX idx_workouts_log_id
  ON workouts(log_id);
```

### í–¥í›„ ìµœì í™” ê³„íš

#### 1. React Query ë„ì…
```tsx
// ìºì‹±, ì¬ì‹œë„, ë‚™ê´€ì  ì—…ë°ì´íŠ¸ ë“±
const { data: logs } = useQuery(
  ['logs', userId],
  () => supabaseStorage.getAllLogs(userId),
  {
    staleTime: 5 * 60 * 1000, // 5ë¶„ê°„ ìºì‹œ ìœ ì§€
    cacheTime: 10 * 60 * 1000,
  }
);
```

#### 2. ë¬´í•œ ìŠ¤í¬ë¡¤ (Pagination)
```tsx
const { data, fetchNextPage } = useInfiniteQuery(
  ['logs', userId],
  ({ pageParam = 0 }) => supabaseStorage.getLogsPaginated(userId, pageParam),
  {
    getNextPageParam: (lastPage) => lastPage.nextCursor,
  }
);
```

#### 3. ì´ë¯¸ì§€ ìµœì í™” (í–¥í›„ í”„ë¡œí•„ ì´ë¯¸ì§€ ì¶”ê°€ ì‹œ)
- WebP í˜•ì‹ ì‚¬ìš©
- Lazy loading
- Thumbnail ìƒì„±

---

## í™•ì¥ì„± ê³ ë ¤ì‚¬í•­

### 1. í´ëŸ½ ì‹œìŠ¤í…œ ì¶”ê°€ ì‹œ ì•„í‚¤í…ì²˜

#### ë°ì´í„° ëª¨ë¸
```sql
-- í´ëŸ½ í…Œì´ë¸”
CREATE TABLE clubs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  owner_id UUID REFERENCES users(id),
  is_public BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- í´ëŸ½ ë©¤ë²„ í…Œì´ë¸”
CREATE TABLE club_members (
  club_id UUID REFERENCES clubs(id),
  user_id UUID REFERENCES users(id),
  role TEXT CHECK (role IN ('owner', 'admin', 'member')),
  joined_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (club_id, user_id)
);

-- ê³µìœ ëœ ìš´ë™ ê¸°ë¡
CREATE TABLE shared_workouts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  log_id UUID REFERENCES workout_logs(id),
  club_id UUID REFERENCES clubs(id),
  shared_by UUID REFERENCES users(id),
  shared_at TIMESTAMPTZ DEFAULT now()
);
```

#### RLS ì •ì±… (ë©€í‹°í…Œë„ŒíŠ¸)
```sql
-- í´ëŸ½ ë©¤ë²„ë§Œ í´ëŸ½ ë°ì´í„° ì½ê¸° ê°€ëŠ¥
CREATE POLICY "Club members can read club data"
  ON clubs FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM club_members
      WHERE club_members.club_id = clubs.id
        AND club_members.user_id = auth.uid()
    )
  );

-- ê³µìœ ëœ ìš´ë™ ê¸°ë¡ì€ í´ëŸ½ ë©¤ë²„ë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Club members can read shared workouts"
  ON shared_workouts FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM club_members
      WHERE club_members.club_id = shared_workouts.club_id
        AND club_members.user_id = auth.uid()
    )
  );
```

#### Real-time ê¸°ëŠ¥ (Supabase Realtime)
```tsx
// í´ëŸ½ í”¼ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
useEffect(() => {
  const subscription = supabase
    .channel('club-feed')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'shared_workouts',
        filter: `club_id=eq.${clubId}`
      },
      (payload) => {
        setFeed(prev => [payload.new, ...prev]);
      }
    )
    .subscribe();

  return () => subscription.unsubscribe();
}, [clubId]);
```

### 2. ì„±ëŠ¥ í™•ì¥

#### ë°ì´í„°ë² ì´ìŠ¤ ìƒ¤ë”© (í–¥í›„ ëŒ€ê·œëª¨ í™•ì¥ ì‹œ)
- ì‚¬ìš©ì ID ê¸°ë°˜ ìˆ˜í‰ ìƒ¤ë”©
- í´ëŸ½ ID ê¸°ë°˜ ìƒ¤ë”© (í´ëŸ½ ë°ì´í„°)

#### CDN í™œìš©
- ì •ì  ìì‚° (ì´ë¯¸ì§€, CSS, JS)
- Vercel/Netlify Edge Functions

#### ìºì‹± ì „ëµ
- Redis for session storage (í–¥í›„)
- Service Worker for offline support (PWA)

### 3. ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

#### í–¥í›„ ë„ì… ê³„íš
- **Sentry**: ì—ëŸ¬ ëª¨ë‹ˆí„°ë§
- **Google Analytics**: ì‚¬ìš©ì í–‰ë™ ë¶„ì„
- **Supabase Logs**: ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

---

## ê°œë°œ ì›Œí¬í”Œë¡œìš°

### ë¡œì»¬ ê°œë°œ
```bash
npm install
npm run dev  # Vite dev server on http://localhost:5173
```

### ë¹Œë“œ
```bash
npm run build  # TypeScript ì»´íŒŒì¼ + Vite ë¹Œë“œ
```

### ë°°í¬
1. Vercel/Netlifyì— ì—°ê²°
2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
3. Git push â†’ ìë™ ë°°í¬

---

## ì°¸ê³  ìë£Œ

- [Supabase Docs](https://supabase.com/docs)
- [React Docs](https://react.dev/)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [Vite Guide](https://vitejs.dev/guide/)
- [Clean Architecture (Robert C. Martin)](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

---

**ì´ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ ì§„í™”ì— ë”°ë¼ ì§€ì†ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.**
</file>

<file path="docs/database/APPLY_CARDIO_NORMALIZATION.md">
# Cardio Normalization - ì ìš© ê°€ì´ë“œ

## ğŸ“Œ ê°œìš”

ìœ ì‚°ì†Œ ìš´ë™ì˜ ì¢…ëª©ë³„ ë‚œì´ë„ ì°¨ì´ë¥¼ ë³´ì •í•˜ì—¬ ê³µì •í•œ ë­í‚¹ì„ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

**í•µì‹¬ ì›ì¹™:**
- ê¸°ë¡ì€ ì›ë³¸ ê·¸ëŒ€ë¡œ ì €ì¥
- ë¹ˆ í•„ë“œ(ê±°ë¦¬, ì†ë„ ë“±)ê°€ ìˆìœ¼ë©´ ê³„ì‚°í•´ì„œ ì±„ì›€
- ëŒ€ì‹œë³´ë“œ ì§‘ê³„ ì‹œì—ë§Œ í™˜ì‚° ë¹„ìœ¨(multiplier) ì ìš©
- UIì—ì„œ ì•„ì´ì½˜ìœ¼ë¡œ í™˜ì‚° ë¹„ìœ¨ ëª…ì‹œ

## ğŸ¯ í™˜ì‚° ë¹„ìœ¨

| ì¹´í…Œê³ ë¦¬ | ì¢…ëª© ì˜ˆì‹œ | í™˜ì‚° ë¹„ìœ¨ | ì´ìœ  |
|---------|----------|---------|------|
| Running | ëŸ¬ë‹, íŠ¸ë ˆë“œë°€ | 100% (Ã—1.0) | ê¸°ì¤€ |
| Stepmill | ì²œêµ­ì˜ê³„ë‹¨, ìŠ¤í…ë°€, ë“±ì‚° | 100% (Ã—1.0) | ëŸ¬ë‹ê³¼ ë™ë“±í•œ ê°•ë„ |
| Rowing | ë¡œì‰ë¨¸ì‹ , ì¡°ì • | 60% (Ã—0.6) | ìƒì²´ ì¤‘ì‹¬, ì²´ì¤‘ ë¶€í•˜ ì ìŒ |
| Cycle | ì‚¬ì´í´, ì‹¤ë‚´ìì „ê±° | 40% (Ã—0.4) | ì•‰ì•„ì„œ í•˜ëŠ” ìš´ë™ |
| Other | ì—˜ë¦½í‹°ì»¬, ì¤„ë„˜ê¸°, ìˆ˜ì˜ | 30% (Ã—0.3) | ê¸°íƒ€ ìœ ì‚°ì†Œ |

## ğŸ“‹ ì ìš© ìˆœì„œ

### 1ë‹¨ê³„: SQL í•¨ìˆ˜ ìƒì„±

```bash
# Supabase SQL Editorì—ì„œ ì‹¤í–‰
```

**íŒŒì¼:** `docs/database/cardio_normalization.sql`

ì´ íŒŒì¼ì€ ë‹¤ìŒ í•¨ìˆ˜ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤:
- `get_cardio_category(workout_name)`: ìš´ë™ëª… â†’ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
- `get_cardio_multiplier(category)`: ì¹´í…Œê³ ë¦¬ â†’ í™˜ì‚° ë¹„ìœ¨
- `calculate_adjusted_distance(distance_km, adjusted_dist_km, workout_name)`: ìµœì¢… í™˜ì‚° ê±°ë¦¬ ê³„ì‚°

### 2ë‹¨ê³„: í´ëŸ½ ëŒ€ì‹œë³´ë“œ í•¨ìˆ˜ ì—…ë°ì´íŠ¸

```bash
# Supabase SQL Editorì—ì„œ ì‹¤í–‰
```

**íŒŒì¼:** `docs/database/club_dashboard_function.sql`

ë³€ê²½ ì‚¬í•­:
- Hall of Fame ë°°ì§€ "ì§€ì¹  ì¤„ ëª¨ë¥´ëŠ” ì‹¬ì¥" â†’ í™˜ì‚° ê±°ë¦¬ ì ìš©
- Leaderboard Cardio ìˆœìœ„ â†’ í™˜ì‚° ê±°ë¦¬ ì ìš©

**ì¤‘ìš”:** ê¸°ì¡´ `get_club_dashboard()` í•¨ìˆ˜ë¥¼ ì™„ì „íˆ êµì²´í•©ë‹ˆë‹¤.

### 3ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ í™•ì¸

ë‹¤ìŒ íŒŒì¼ë“¤ì´ ìë™ìœ¼ë¡œ ìƒˆ í™˜ì‚° ë¹„ìœ¨ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:
- âœ… `src/features/parse/normalizeCardio.ts` (ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜)
- âœ… `src/pages/Dashboard.tsx` (ê°œì¸ ëŒ€ì‹œë³´ë“œ)
- âœ… `src/pages/ClubDetail.tsx` (í´ëŸ½ ëŒ€ì‹œë³´ë“œ - RPC í˜¸ì¶œ)

ë³€ê²½ ì‚¬í•­ ì—†ìŒ - ì´ë¯¸ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

## ğŸ” ì‘ë™ ë°©ì‹

### ê±°ë¦¬ ê³„ì‚° íë¦„

```
ì›ë³¸ ë°ì´í„°
  â†“
[1] ì¸í´ë¼ì¸ ë³´ì • (ìˆëŠ” ê²½ìš°)
  distance_km â†’ adjusted_dist_km
  ì˜ˆ: 5km @ 10% incline â†’ 10km
  â†“
[2] ì¹´í…Œê³ ë¦¬ ê°ì§€
  workout.name â†’ cardio category
  ì˜ˆ: "ì‚¬ì´í´" â†’ 'cycle'
  â†“
[3] í™˜ì‚° ë¹„ìœ¨ ì ìš©
  adjusted_dist_km Ã— multiplier
  ì˜ˆ: 10km Ã— 0.4 = 4.0km
  â†“
ìµœì¢… ë­í‚¹ ë°˜ì˜ ê±°ë¦¬
```

### ì˜ˆì‹œ

**ëŸ¬ë‹ (100%)**
- ì…ë ¥: 5km ëŸ¬ë‹
- ê³„ì‚°: 5km Ã— 1.0 = 5.0km
- ë­í‚¹ ë°˜ì˜: 5.0km

**ì‚¬ì´í´ (40%)**
- ì…ë ¥: 10km ì‚¬ì´í´
- ê³„ì‚°: 10km Ã— 0.4 = 4.0km
- ë­í‚¹ ë°˜ì˜: 4.0km

**ì¸í´ë¼ì¸ ëŸ¬ë‹ (100%)**
- ì…ë ¥: 5km ëŸ¬ë‹ @ 10% incline
- ì¸í´ë¼ì¸ ë³´ì •: 5km â†’ 10km (adjusted_dist_km)
- ì¹´í…Œê³ ë¦¬ ë³´ì •: 10km Ã— 1.0 = 10.0km
- ë­í‚¹ ë°˜ì˜: 10.0km

**ì¸í´ë¼ì¸ ì‚¬ì´í´ (40%)**
- ì…ë ¥: 10km ì‚¬ì´í´ @ ë ˆë²¨ 5
- ì €í•­ ë³´ì •: 10km â†’ 12.5km (adjusted_dist_km)
- ì¹´í…Œê³ ë¦¬ ë³´ì •: 12.5km Ã— 0.4 = 5.0km
- ë­í‚¹ ë°˜ì˜: 5.0km

## âœ… í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

### SQL í•¨ìˆ˜ í…ŒìŠ¤íŠ¸

```sql
-- 1. ì¹´í…Œê³ ë¦¬ ë§¤í•‘ í™•ì¸
SELECT get_cardio_category('ëŸ¬ë‹'); -- 'running'
SELECT get_cardio_category('ì‚¬ì´í´'); -- 'cycle'
SELECT get_cardio_category('ë¡œì‰ë¨¸ì‹ '); -- 'rowing'

-- 2. í™˜ì‚° ë¹„ìœ¨ í™•ì¸
SELECT get_cardio_multiplier('running'); -- 1.0
SELECT get_cardio_multiplier('cycle'); -- 0.4
SELECT get_cardio_multiplier('rowing'); -- 0.6

-- 3. í™˜ì‚° ê±°ë¦¬ ê³„ì‚° í™•ì¸
SELECT calculate_adjusted_distance(10, NULL, 'ëŸ¬ë‹'); -- 10.0
SELECT calculate_adjusted_distance(10, NULL, 'ì‚¬ì´í´'); -- 4.0
SELECT calculate_adjusted_distance(5, 10, 'ëŸ¬ë‹'); -- 10.0 (adjusted_dist_km ìš°ì„ )
```

### í´ëŸ½ ëŒ€ì‹œë³´ë“œ í…ŒìŠ¤íŠ¸

1. âœ… Hall of Fame ë°°ì§€ "ì§€ì¹  ì¤„ ëª¨ë¥´ëŠ” ì‹¬ì¥" ê°’ í™•ì¸
   - ì—¬ëŸ¬ ì¢…ëª© ì„ì—¬ìˆì„ ë•Œ í™˜ì‚° ê±°ë¦¬ í•©ê³„ê°€ ë§ëŠ”ì§€
2. âœ… Leaderboard Cardio ìˆœìœ„ í™•ì¸
   - ëŸ¬ë‹ ìœ ì € vs ì‚¬ì´í´ ìœ ì € ìˆœìœ„ê°€ ê³µì •í•œì§€
3. âœ… ë‹¨ìœ„ í‘œì‹œ í™•ì¸: "km í™˜ì‚°" ë˜ëŠ” "km ëŸ¬ë‹" â†’ "km í™˜ì‚°"

### ê°œì¸ ëŒ€ì‹œë³´ë“œ í…ŒìŠ¤íŠ¸

1. âœ… Dashboard.tsx ì›”ê°„ í†µê³„ "ì´ ê±°ë¦¬" í™•ì¸
   - ì—¬ëŸ¬ ì¢…ëª©ì˜ í™˜ì‚° ê±°ë¦¬ê°€ ì˜¬ë°”ë¥´ê²Œ í•©ì‚°ë˜ëŠ”ì§€
2. âœ… ì½˜ì†” ì—ëŸ¬ ì—†ëŠ”ì§€ í™•ì¸

## ğŸ› ë¬¸ì œ í•´ê²°

### SQL í•¨ìˆ˜ê°€ ìƒì„±ë˜ì§€ ì•ŠëŠ” ê²½ìš°

```sql
-- ê¸°ì¡´ í•¨ìˆ˜ ì œê±° í›„ ì¬ìƒì„±
DROP FUNCTION IF EXISTS get_cardio_category(TEXT);
DROP FUNCTION IF EXISTS get_cardio_multiplier(TEXT);
DROP FUNCTION IF EXISTS calculate_adjusted_distance(NUMERIC, NUMERIC, TEXT);
```

ê·¸ ë‹¤ìŒ `cardio_normalization.sql` íŒŒì¼ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.

### "function ... does not exist" ì˜¤ë¥˜

ì›ì¸: SQL í•¨ìˆ˜ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ê±°ë‚˜ íŒŒë¼ë¯¸í„° íƒ€ì…ì´ ë§ì§€ ì•ŠìŒ

í•´ê²°:
1. `cardio_normalization.sql` íŒŒì¼ ë¨¼ì € ì‹¤í–‰
2. `club_dashboard_function.sql` íŒŒì¼ ì‹¤í–‰

### í™˜ì‚° ê±°ë¦¬ê°€ 0ìœ¼ë¡œ ë‚˜ì˜¤ëŠ” ê²½ìš°

ì›ì¸: `distance_km`ì™€ `adjusted_dist_km` ëª¨ë‘ NULL

í•´ê²°: Workout ë°ì´í„°ì— ìµœì†Œí•œ `distance_km` ë˜ëŠ” `duration_min`ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

## ğŸ“ í–¥í›„ ê°œì„  ì‚¬í•­

### Phase 1 (í˜„ì¬) âœ…
- í´ëŸ½ ëŒ€ì‹œë³´ë“œ í™˜ì‚° ë¹„ìœ¨ ì ìš©
- ê°œì¸ ëŒ€ì‹œë³´ë“œ í™˜ì‚° ë¹„ìœ¨ ì ìš©

### Phase 2 (ì˜ˆì •)
- UIì— ì•„ì´ì½˜ í‘œì‹œ (ğŸƒ Ã—1.0, ğŸš´ Ã—0.4 ë“±)
- Workout ìƒì„¸ í˜ì´ì§€ì— í™˜ì‚° ê±°ë¦¬ ì•ˆë‚´
- "ì›ë³¸ ê±°ë¦¬ vs í™˜ì‚° ê±°ë¦¬" ë¹„êµ UI

### Phase 3 (ì˜ˆì •)
- ì¹´í…Œê³ ë¦¬ë³„ í‚¤ì›Œë“œ ê´€ë¦¬ UI
- ì‚¬ìš©ì ì •ì˜ í™˜ì‚° ë¹„ìœ¨ (í´ëŸ½ë³„ ì„¤ì •)

## ğŸ“š ê´€ë ¨ íŒŒì¼

### Backend (SQL)
- `docs/database/cardio_normalization.sql` - í™˜ì‚° ë¹„ìœ¨ ê³„ì‚° í•¨ìˆ˜
- `docs/database/club_dashboard_function.sql` - í´ëŸ½ ëŒ€ì‹œë³´ë“œ RPC í•¨ìˆ˜

### Frontend (TypeScript)
- `src/features/parse/normalizeCardio.ts` - ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
- `src/pages/Dashboard.tsx` - ê°œì¸ ëŒ€ì‹œë³´ë“œ
- `src/pages/ClubDetail.tsx` - í´ëŸ½ ëŒ€ì‹œë³´ë“œ
- `src/types/index.ts` - Workout íƒ€ì… ì •ì˜

### Documentation
- `docs/specs/cardio_normalization.md` - ê¸°ëŠ¥ ëª…ì„¸ì„œ (ì‚¬ìš©ì ì œê³µ)
- `docs/database/APPLY_CARDIO_NORMALIZATION.md` - ì´ íŒŒì¼
</file>

<file path="docs/database/cardio_normalization.sql">
-- ============================================
-- Cardio Normalization Helper Functions
-- ìœ ì‚°ì†Œ í™˜ì‚° ë¹„ìœ¨ ì ìš©ì„ ìœ„í•œ SQL í•¨ìˆ˜
-- ============================================

-- ìš´ë™ëª… â†’ ì¹´í…Œê³ ë¦¬ ë§¤í•‘ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION get_cardio_category(workout_name TEXT)
RETURNS TEXT AS $$
BEGIN
  workout_name := LOWER(workout_name);

  -- Running (100%)
  IF workout_name LIKE ANY(ARRAY['%ëŸ¬ë‹%', '%íŠ¸ë ˆë“œë°€%', '%ë‹¬ë¦¬ê¸°%', '%ì¡°ê¹…%', '%ë§ˆë¼í†¤%', '%ëŸ°ë‹%', '%ë›°ê¸°%', '%running%', '%treadmill%', '%jogging%']) THEN
    RETURN 'running';

  -- Stepmill (100%)
  ELSIF workout_name LIKE ANY(ARRAY['%ì²œêµ­ì˜ê³„ë‹¨%', '%ìŠ¤í…ë°€%', '%ë§ˆì´ë§ˆìš´í‹´%', '%ë“±ì‚°%', '%ìŠ¤í…Œí¼%', '%ê³„ë‹¨%', '%ìŠ¤í…ë¨¸ì‹ %', '%stepmill%', '%stairmaster%', '%stepper%']) THEN
    RETURN 'stepmill';

  -- Rowing (60%)
  ELSIF workout_name LIKE ANY(ARRAY['%ë¡œì‰%', '%ì¡°ì •%', '%ë…¸ì “ê¸°%', '%rowing%', '%rower%']) THEN
    RETURN 'rowing';

  -- Cycle (40%)
  ELSIF workout_name LIKE ANY(ARRAY['%ì‚¬ì´í´%', '%ìì „ê±°%', '%ë”°ë¦‰ì´%', '%ìŠ¤í”¼ë‹%', '%ë°”ì´í¬%', '%cycle%', '%bike%', '%spinning%']) THEN
    RETURN 'cycle';

  -- Other (30%)
  ELSE
    RETURN 'other';
  END IF;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- ì¹´í…Œê³ ë¦¬ â†’ í™˜ì‚° ë¹„ìœ¨ ë§¤í•‘ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION get_cardio_multiplier(category TEXT)
RETURNS NUMERIC AS $$
BEGIN
  CASE category
    WHEN 'running' THEN RETURN 1.0;
    WHEN 'stepmill' THEN RETURN 1.0;
    WHEN 'rowing' THEN RETURN 0.6;
    WHEN 'cycle' THEN RETURN 0.4;
    WHEN 'other' THEN RETURN 0.3;
    ELSE RETURN 1.0;
  END CASE;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- í™˜ì‚° ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (ì§‘ê³„ ì‹œ ì‚¬ìš©)
-- 1ìˆœìœ„: adjusted_dist_km (ì¸í´ë¼ì¸ ë³´ì •ëœ ê±°ë¦¬)
-- 2ìˆœìœ„: distance_km (ì›ë³¸ ê±°ë¦¬)
-- ê·¸ í›„ cardio category multiplier ì ìš©
CREATE OR REPLACE FUNCTION calculate_adjusted_distance(
  distance_km NUMERIC,
  adjusted_dist_km NUMERIC,
  workout_name TEXT
)
RETURNS NUMERIC AS $$
DECLARE
  base_distance NUMERIC;
  category TEXT;
  multiplier NUMERIC;
BEGIN
  -- ì¸í´ë¼ì¸ ë³´ì •ëœ ê±°ë¦¬ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë³¸ ê±°ë¦¬
  base_distance := COALESCE(adjusted_dist_km, distance_km, 0);

  IF base_distance = 0 THEN
    RETURN 0;
  END IF;

  category := get_cardio_category(workout_name);
  multiplier := get_cardio_multiplier(category);

  RETURN ROUND((base_distance * multiplier)::NUMERIC, 2);
END;
$$ LANGUAGE plpgsql IMMUTABLE;
</file>

<file path="docs/database/check_table_structure.sql">
-- Check if club_challenges is a table or view
SELECT
  table_name,
  table_type
FROM information_schema.tables
WHERE table_name = 'club_challenges';

-- Check current columns
SELECT
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'club_challenges'
ORDER BY ordinal_position;

-- Check if rules or theme_color columns already exist
SELECT EXISTS (
  SELECT 1
  FROM information_schema.columns
  WHERE table_name = 'club_challenges' AND column_name = 'rules'
) as rules_exists,
EXISTS (
  SELECT 1
  FROM information_schema.columns
  WHERE table_name = 'club_challenges' AND column_name = 'theme_color'
) as theme_color_exists;
</file>

<file path="docs/database/club_dashboard_function.sql">
-- ============================================
-- Club Dashboard Function (2026-01-21 v3)
-- Change Log:
-- 1. Remove: ì…ë ¥ ì‹œê°„ ê¸°ë°˜ ë°°ì§€ ì‚­ì œ (ë¯¸ë¼í´ëª¨ë‹, ì˜¬ë¹¼ë¯¸)
-- 2. Add: 'ì—°ì† ì¶œì„(Streak)' & 'ìœ¡ê°í˜• ë©¤ë²„(Variety)' ì¶”ê°€
-- 3. Fix: ì›Œì»¤í™€ë¦­ ê³µì •ì„± ìœ ì§€ (ì¶œì„ ì¼ìˆ˜ ê¸°ì¤€)
-- ============================================

CREATE OR REPLACE FUNCTION get_club_dashboard(p_club_id UUID, p_current_user_id UUID DEFAULT NULL)
RETURNS JSONB AS $$
DECLARE
  v_badges JSONB;
  v_squad JSONB;
  v_leaderboards JSONB;
BEGIN

  -- 1. ğŸ† Hall of Fame (ë°°ì§€ ê³„ì‚°)
  WITH member_logs AS (
    SELECT
      wl.user_id, wl.created_at, wl.date,
      w.type, w.category, w.name, w.volume_kg, w.distance_km, w.adjusted_dist_km, w.run_count
    FROM workout_logs wl
    JOIN workouts w ON w.workout_log_id = wl.id
    WHERE wl.user_id IN (SELECT user_id FROM club_members WHERE club_id = p_club_id)
      AND wl.is_private = false
      AND wl.created_at >= NOW() - INTERVAL '30 days'
  ),
  -- Streak(ì—°ì† ì¶œì„) ê³„ì‚°ì„ ìœ„í•œ CTE
  daily_logs AS (
    SELECT DISTINCT user_id, date FROM member_logs
  ),
  streaks AS (
    SELECT user_id, COUNT(*) as days
    FROM (
        SELECT user_id, date,
               -- ë‚ ì§œì—ì„œ í–‰ë²ˆí˜¸ë¥¼ ë¹¼ì„œ ê·¸ë£¹í•‘ (ì—°ì†ëœ ë‚ ì§œë©´ ê°™ì€ ê·¸ë£¹ì´ ë¨)
               date - CAST(ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY date) || ' days' AS INTERVAL) as grp
        FROM daily_logs
    ) t
    GROUP BY user_id, grp
    -- ì–´ì œë‚˜ ì˜¤ëŠ˜ ê¸°ë¡ì´ ìˆì–´ì•¼ 'í˜„ì¬ ì§„í–‰ì¤‘ì¸' ìŠ¤íŠ¸ë¦­ìœ¼ë¡œ ì¸ì •
    HAVING MAX(date) >= CURRENT_DATE - INTERVAL '1 day' 
  ),
  badge_winners AS (
    -- ğŸ”¥ ì›Œì»¤í™€ë¦­ (ì›”ê°„ ìµœë‹¤ ì¶œì„)
    (SELECT user_id, 'effort' as type, 'ì›Œì»¤í™€ë¦­' as title, 'ğŸ”¥' as icon, 
            count(distinct date) as val, 'ì¼ ì¶œì„' as unit
     FROM member_logs GROUP BY user_id ORDER BY val DESC LIMIT 1)
     
    UNION ALL
    
    -- âš¡ ì‘ì‹¬ì‚¼ì¼ íƒ€íŒŒ (í˜„ì¬ ì—°ì† ì¶œì„ 1ìœ„) - NEW
    (SELECT user_id, 'effort' as type, 'ë©ˆì¶”ì§€ ì•ŠëŠ” ê¸°ê´€ì°¨' as title, 'ğŸš‚' as icon, 
            days as val, 'ì¼ ì—°ì†' as unit
     FROM streaks ORDER BY days DESC LIMIT 1)

    UNION ALL
    
    -- ğŸ¨ ìœ¡ê°í˜• ë©¤ë²„ (ì¢…ëª© ë‹¤ì–‘ì„± 1ìœ„) - NEW
    (SELECT user_id, 'effort' as type, 'ìœ¡ê°í˜• ë©¤ë²„' as title, 'ğŸ’' as icon, 
            count(DISTINCT COALESCE(type, category)) as val, 'ê°œ ì¢…ëª©' as unit
     FROM member_logs 
     GROUP BY user_id 
     HAVING count(DISTINCT COALESCE(type, category)) >= 2 -- ìµœì†Œ 2ê°œ ì¢…ëª© ì´ìƒ
     ORDER BY val DESC LIMIT 1)
     
    UNION ALL
    
    -- ğŸ‹ï¸ 3ëŒ€ 500 ê¿ˆë‚˜ë¬´ (ë³¼ë¥¨ í‚¹)
    (SELECT user_id, 'strength' as type, '3ëŒ€ 500 ê¿ˆë‚˜ë¬´' as title, 'ğŸ¦' as icon, sum(volume_kg)::int as val, 'kg ë³¼ë¥¨' as unit
     FROM member_logs WHERE type = 'strength' GROUP BY user_id HAVING sum(volume_kg) > 0 ORDER BY val DESC LIMIT 1)
     
    UNION ALL
    
    -- ğŸƒ ê°•ì²  ì‹¬ì¥ (ê±°ë¦¬ í‚¹) - í™˜ì‚° ê±°ë¦¬ ì ìš©
    (SELECT user_id, 'cardio' as type, 'ì§€ì¹  ì¤„ ëª¨ë¥´ëŠ” ì‹¬ì¥' as title, 'ğŸ«€' as icon,
            round(sum(calculate_adjusted_distance(distance_km, adjusted_dist_km, name))::numeric, 1) as val, 'km í™˜ì‚°' as unit
     FROM member_logs WHERE type = 'cardio' GROUP BY user_id
     HAVING sum(calculate_adjusted_distance(distance_km, adjusted_dist_km, name)) > 0 ORDER BY val DESC LIMIT 1)
     
    UNION ALL
    
    -- ğŸ‚ ì„¤ì›ì˜ ì§€ë°°ì (ìŠ¤ë…¸ë³´ë“œ í‚¹)
    (SELECT user_id, 'snowboard' as type, 'ì„¤ì›ì˜ ì§€ë°°ì' as title, 'â„ï¸' as icon, sum(run_count)::int as val, 'ëŸ°' as unit
     FROM member_logs WHERE category = 'snowboard' GROUP BY user_id HAVING sum(run_count) > 0 ORDER BY val DESC LIMIT 1)
  )
  SELECT jsonb_agg(
    jsonb_build_object(
      'userId', u.id,
      'userName', u.display_name,
      'userProfile', u.profile_image,
      'type', bw.type,
      'title', bw.title,
      'icon', bw.icon,
      'description', bw.val || bw.unit,
      'isMe', (u.id = p_current_user_id)
    ) ORDER BY (u.id = p_current_user_id) DESC, random()
  ) INTO v_badges
  FROM badge_winners bw
  JOIN users u ON u.id = bw.user_id;


  -- 2. ğŸ‘¥ Active Squad (ìœ ì§€)
  SELECT jsonb_agg(
    jsonb_build_object(
      'userId', user_id,
      'displayName', display_name,
      'profileImage', profile_image,
      'mainActivity', workout_name,
      'workoutCount', workout_count,
      'activityType', activity_type,
      'lastActiveDate', last_active_date
    ) ORDER BY 
      CASE WHEN activity_type = 'today' THEN 1 ELSE 2 END,
      last_active_date DESC
  ) INTO v_squad
  FROM (
    SELECT DISTINCT ON (wl.user_id)
      wl.user_id,
      u.display_name,
      u.profile_image,
      w.name as workout_name,
      COUNT(*) OVER (PARTITION BY wl.user_id) as workout_count,
      CASE 
        WHEN wl.date = CURRENT_DATE THEN 'today'
        ELSE 'yesterday'
      END as activity_type,
      wl.created_at as last_active_date
    FROM workout_logs wl
    JOIN users u ON u.id = wl.user_id
    JOIN workouts w ON w.workout_log_id = wl.id
    WHERE wl.user_id IN (SELECT user_id FROM club_members WHERE club_id = p_club_id)
      AND wl.is_private = false
      AND wl.date >= CURRENT_DATE - 1
    ORDER BY wl.user_id, wl.created_at DESC
  ) squad_sub;


  -- 3. ğŸ“Š Leaderboards (ìœ ì§€ - ë¡œì§ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ ì—†ì´ í¬í•¨)
  v_leaderboards := jsonb_build_object(
    'cardio', (
        SELECT COALESCE(jsonb_agg(jsonb_build_object('userId', user_id, 'displayName', display_name, 'profileImage', profile_image, 'value', total_val) ORDER BY total_val DESC), '[]'::jsonb)
        FROM (
            SELECT wl.user_id, u.display_name, u.profile_image,
                   ROUND(SUM(calculate_adjusted_distance(w.distance_km, w.adjusted_dist_km, w.name))::numeric, 1) as total_val
            FROM workout_logs wl JOIN users u ON u.id = wl.user_id JOIN workouts w ON w.workout_log_id = wl.id
            WHERE wl.user_id IN (SELECT user_id FROM club_members WHERE club_id = p_club_id)
              AND wl.is_private = false
              AND wl.created_at >= NOW() - INTERVAL '30 days'
              AND w.type = 'cardio'
            GROUP BY wl.user_id, u.display_name, u.profile_image
            HAVING SUM(calculate_adjusted_distance(w.distance_km, w.adjusted_dist_km, w.name)) > 0
            LIMIT 10
        ) t
    ),
    'strength', (
        SELECT COALESCE(jsonb_agg(jsonb_build_object('userId', user_id, 'displayName', display_name, 'profileImage', profile_image, 'value', total_val) ORDER BY total_val DESC), '[]'::jsonb)
        FROM (
            SELECT wl.user_id, u.display_name, u.profile_image, ROUND(SUM(COALESCE(w.volume_kg, w.sets * w.reps * w.weight_kg, 0))::numeric, 0) as total_val
            FROM workout_logs wl JOIN users u ON u.id = wl.user_id JOIN workouts w ON w.workout_log_id = wl.id
            WHERE wl.user_id IN (SELECT user_id FROM club_members WHERE club_id = p_club_id) AND wl.is_private = false AND wl.created_at >= NOW() - INTERVAL '30 days' AND (w.type = 'strength' OR w.category IN ('gym', 'home'))
            GROUP BY wl.user_id, u.display_name, u.profile_image HAVING SUM(COALESCE(w.volume_kg, 0)) > 0 LIMIT 10
        ) t
    ),
    'snowboard', (
        SELECT COALESCE(jsonb_agg(jsonb_build_object('userId', user_id, 'displayName', display_name, 'profileImage', profile_image, 'value', total_val) ORDER BY total_val DESC), '[]'::jsonb)
        FROM (
            SELECT wl.user_id, u.display_name, u.profile_image, SUM(COALESCE(w.run_count, 0)) as total_val
            FROM workout_logs wl JOIN users u ON u.id = wl.user_id JOIN workouts w ON w.workout_log_id = wl.id
            WHERE wl.user_id IN (SELECT user_id FROM club_members WHERE club_id = p_club_id) AND wl.is_private = false AND wl.created_at >= NOW() - INTERVAL '30 days' AND w.category = 'snowboard'
            GROUP BY wl.user_id, u.display_name, u.profile_image HAVING SUM(COALESCE(w.run_count, 0)) > 0 LIMIT 10
        ) t
    )
  );

  RETURN jsonb_build_object(
    'badges', COALESCE(v_badges, '[]'::jsonb),
    'squad', COALESCE(v_squad, '[]'::jsonb),
    'leaderboards', v_leaderboards
  );
END;
$$ LANGUAGE plpgsql STABLE;
</file>

<file path="docs/database/club_dashboard_widgets_migration.sql">
-- Club Dashboard Widget System Migration
-- Allows club owners to customize widget order and visibility

-- Add dashboard_config column to clubs table
ALTER TABLE clubs
ADD COLUMN IF NOT EXISTS dashboard_config JSONB DEFAULT jsonb_build_object(
  'widgets', jsonb_build_array(
    jsonb_build_object('id', 'live_ticker', 'type', 'live_ticker', 'visible', true, 'order', 0),
    jsonb_build_object('id', 'hall_of_fame', 'type', 'hall_of_fame', 'visible', true, 'order', 1),
    jsonb_build_object('id', 'daily_squad', 'type', 'daily_squad', 'visible', true, 'order', 2),
    jsonb_build_object('id', 'leaderboard_cardio', 'type', 'leaderboard', 'visible', true, 'order', 3, 'config', jsonb_build_object('metricType', 'cardio')),
    jsonb_build_object('id', 'leaderboard_strength', 'type', 'leaderboard', 'visible', true, 'order', 4, 'config', jsonb_build_object('metricType', 'strength')),
    jsonb_build_object('id', 'leaderboard_snowboard', 'type', 'leaderboard', 'visible', true, 'order', 5, 'config', jsonb_build_object('metricType', 'snowboard'))
  )
);

-- Add comment
COMMENT ON COLUMN clubs.dashboard_config IS 'Dashboard widget configuration: widget types, visibility, and order';

-- Example dashboard_config structure:
-- {
--   "widgets": [
--     {
--       "id": "live_ticker",
--       "type": "live_ticker",
--       "visible": true,
--       "order": 0
--     },
--     {
--       "id": "hall_of_fame",
--       "type": "hall_of_fame",
--       "visible": true,
--       "order": 1
--     },
--     {
--       "id": "daily_squad",
--       "type": "daily_squad",
--       "visible": true,
--       "order": 2
--     },
--     {
--       "id": "leaderboard_cardio",
--       "type": "leaderboard",
--       "visible": true,
--       "order": 3,
--       "config": {
--         "metricType": "cardio"
--       }
--     },
--     {
--       "id": "leaderboard_strength",
--       "type": "leaderboard",
--       "visible": true,
--       "order": 4,
--       "config": {
--         "metricType": "strength"
--       }
--     },
--     {
--       "id": "leaderboard_snowboard",
--       "type": "leaderboard",
--       "visible": true,
--       "order": 5,
--       "config": {
--         "metricType": "snowboard"
--       }
--     }
--   ]
-- }
</file>

<file path="docs/database/club_system_migration.sql">
-- Club System Migration
-- í´ëŸ½ ì‹œìŠ¤í…œë§Œ ì¶”ê°€í•˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

-- ============================================
-- 1. Helper Function (if not exists)
-- ============================================
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- 2. Clubs System Tables (Phase 1)
-- ============================================

-- Clubs Table
CREATE TABLE IF NOT EXISTS clubs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  is_public BOOLEAN DEFAULT false,
  invite_code UUID DEFAULT gen_random_uuid() UNIQUE NOT NULL,
  owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for clubs table
CREATE INDEX IF NOT EXISTS idx_clubs_owner_id ON clubs(owner_id);
CREATE INDEX IF NOT EXISTS idx_clubs_invite_code ON clubs(invite_code);
CREATE INDEX IF NOT EXISTS idx_clubs_is_public ON clubs(is_public) WHERE is_public = true;

-- Comments
COMMENT ON TABLE clubs IS 'í´ëŸ½ (ìš´ë™ ê·¸ë£¹)';
COMMENT ON COLUMN clubs.name IS 'í´ëŸ½ ì´ë¦„';
COMMENT ON COLUMN clubs.description IS 'í´ëŸ½ ì„¤ëª…';
COMMENT ON COLUMN clubs.is_public IS 'ê³µê°œ í´ëŸ½ ì—¬ë¶€ (true: ê²€ìƒ‰ ê°€ëŠ¥, false: ì´ˆëŒ€ ë§í¬ë§Œ)';
COMMENT ON COLUMN clubs.invite_code IS 'ì´ˆëŒ€ ë§í¬ìš© UUID (ì˜ˆ: /join/{invite_code})';
COMMENT ON COLUMN clubs.owner_id IS 'í´ëŸ½ ì†Œìœ ì ID';

-- Club Members Table (N:M relationship)
CREATE TABLE IF NOT EXISTS club_members (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(club_id, user_id)
);

-- Indexes for club_members table
CREATE INDEX IF NOT EXISTS idx_club_members_club_id ON club_members(club_id);
CREATE INDEX IF NOT EXISTS idx_club_members_user_id ON club_members(user_id);
CREATE INDEX IF NOT EXISTS idx_club_members_role ON club_members(role);

-- Comments
COMMENT ON TABLE club_members IS 'í´ëŸ½ ë©¤ë²„ì‹­';
COMMENT ON COLUMN club_members.club_id IS 'í´ëŸ½ ID';
COMMENT ON COLUMN club_members.user_id IS 'ì‚¬ìš©ì ID';
COMMENT ON COLUMN club_members.role IS 'ì—­í•  (owner: ì†Œìœ ì, admin: ê´€ë¦¬ì, member: ì¼ë°˜ ë©¤ë²„)';

-- Club Feeds Table (shared workout logs)
CREATE TABLE IF NOT EXISTS club_feeds (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  workout_log_id UUID NOT NULL REFERENCES workout_logs(id) ON DELETE CASCADE,
  shared_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(club_id, workout_log_id)
);

-- Indexes for club_feeds table
CREATE INDEX IF NOT EXISTS idx_club_feeds_club_id ON club_feeds(club_id);
CREATE INDEX IF NOT EXISTS idx_club_feeds_user_id ON club_feeds(user_id);
CREATE INDEX IF NOT EXISTS idx_club_feeds_workout_log_id ON club_feeds(workout_log_id);
CREATE INDEX IF NOT EXISTS idx_club_feeds_shared_at ON club_feeds(shared_at DESC);

-- Comments
COMMENT ON TABLE club_feeds IS 'í´ëŸ½ì— ê³µìœ ëœ ìš´ë™ ê¸°ë¡ í”¼ë“œ';
COMMENT ON COLUMN club_feeds.club_id IS 'í´ëŸ½ ID';
COMMENT ON COLUMN club_feeds.user_id IS 'ê³µìœ í•œ ì‚¬ìš©ì ID';
COMMENT ON COLUMN club_feeds.workout_log_id IS 'ê³µìœ ëœ ìš´ë™ ê¸°ë¡ ID';

-- ============================================
-- 3. Challenges System Tables (Phase 2)
-- ============================================

-- Club Challenges Table
CREATE TABLE IF NOT EXISTS club_challenges (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  challenge_type TEXT NOT NULL DEFAULT 'total_workouts' CHECK (
    challenge_type IN ('total_workouts', 'total_volume', 'total_duration', 'total_distance')
  ),
  target_value INTEGER NOT NULL,
  current_value INTEGER DEFAULT 0,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'completed', 'failed')),
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for club_challenges table
CREATE INDEX IF NOT EXISTS idx_club_challenges_club_id ON club_challenges(club_id);
CREATE INDEX IF NOT EXISTS idx_club_challenges_status ON club_challenges(status);
CREATE INDEX IF NOT EXISTS idx_club_challenges_end_date ON club_challenges(end_date);

-- Comments
COMMENT ON TABLE club_challenges IS 'í´ëŸ½ í•©ì‚° ì±Œë¦°ì§€ (ë³´ìŠ¤ ë ˆì´ë“œ ì»¨ì…‰)';
COMMENT ON COLUMN club_challenges.club_id IS 'í´ëŸ½ ID';
COMMENT ON COLUMN club_challenges.title IS 'ì±Œë¦°ì§€ ì œëª©';
COMMENT ON COLUMN club_challenges.challenge_type IS 'ì±Œë¦°ì§€ íƒ€ì… (total_workouts: ì´ ìš´ë™ ìˆ˜, total_volume: ì´ ë³¼ë¥¨, total_duration: ì´ ì‹œê°„, total_distance: ì´ ê±°ë¦¬)';
COMMENT ON COLUMN club_challenges.target_value IS 'ëª©í‘œ ê°’ (ì˜ˆ: 1000íšŒ, 50000kg, 3000ë¶„)';
COMMENT ON COLUMN club_challenges.current_value IS 'í˜„ì¬ ë‹¬ì„± ê°’';
COMMENT ON COLUMN club_challenges.start_date IS 'ì‹œì‘ì¼ (YYYY-MM-DD)';
COMMENT ON COLUMN club_challenges.end_date IS 'ì¢…ë£Œì¼ (YYYY-MM-DD)';
COMMENT ON COLUMN club_challenges.status IS 'ìƒíƒœ (active: ì§„í–‰ ì¤‘, completed: ì™„ë£Œ, failed: ì‹¤íŒ¨)';

-- Challenge Contributions Table
CREATE TABLE IF NOT EXISTS challenge_contributions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  challenge_id UUID NOT NULL REFERENCES club_challenges(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  workout_log_id UUID NOT NULL REFERENCES workout_logs(id) ON DELETE CASCADE,
  contribution_value INTEGER NOT NULL,
  contributed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(challenge_id, workout_log_id)
);

-- Indexes for challenge_contributions table
CREATE INDEX IF NOT EXISTS idx_challenge_contributions_challenge_id ON challenge_contributions(challenge_id);
CREATE INDEX IF NOT EXISTS idx_challenge_contributions_user_id ON challenge_contributions(user_id);

-- Comments
COMMENT ON TABLE challenge_contributions IS 'ì±Œë¦°ì§€ì— ëŒ€í•œ ê°œë³„ ê¸°ì—¬ (ìš´ë™ ê¸°ë¡)';
COMMENT ON COLUMN challenge_contributions.challenge_id IS 'ì±Œë¦°ì§€ ID';
COMMENT ON COLUMN challenge_contributions.user_id IS 'ê¸°ì—¬í•œ ì‚¬ìš©ì ID';
COMMENT ON COLUMN challenge_contributions.workout_log_id IS 'ê¸°ì—¬í•œ ìš´ë™ ê¸°ë¡ ID';
COMMENT ON COLUMN challenge_contributions.contribution_value IS 'ê¸°ì—¬ ê°’ (ìš´ë™ ìˆ˜, ë³¼ë¥¨, ì‹œê°„, ê±°ë¦¬ ë“±)';

-- ============================================
-- 4. Triggers for Clubs System
-- ============================================

-- Trigger for clubs table
DROP TRIGGER IF EXISTS update_clubs_updated_at ON clubs;
CREATE TRIGGER update_clubs_updated_at
  BEFORE UPDATE ON clubs
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Trigger for club_challenges table
DROP TRIGGER IF EXISTS update_club_challenges_updated_at ON club_challenges;
CREATE TRIGGER update_club_challenges_updated_at
  BEFORE UPDATE ON club_challenges
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 5. Row Level Security (RLS) Policies for Clubs
-- ============================================

-- Enable RLS on clubs tables
ALTER TABLE clubs ENABLE ROW LEVEL SECURITY;
ALTER TABLE club_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE club_feeds ENABLE ROW LEVEL SECURITY;
ALTER TABLE club_challenges ENABLE ROW LEVEL SECURITY;
ALTER TABLE challenge_contributions ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist (to avoid conflicts)
DROP POLICY IF EXISTS "Users can view public clubs or their own clubs" ON clubs;
DROP POLICY IF EXISTS "Users can insert their own clubs" ON clubs;
DROP POLICY IF EXISTS "Club owners can update their clubs" ON clubs;
DROP POLICY IF EXISTS "Club owners can delete their clubs" ON clubs;

DROP POLICY IF EXISTS "Members can view their club memberships" ON club_members;
DROP POLICY IF EXISTS "Users can join clubs" ON club_members;
DROP POLICY IF EXISTS "Owners and admins can update memberships" ON club_members;
DROP POLICY IF EXISTS "Owners and admins can delete memberships" ON club_members;

DROP POLICY IF EXISTS "Members can view club feeds" ON club_feeds;
DROP POLICY IF EXISTS "Members can share to club feeds" ON club_feeds;
DROP POLICY IF EXISTS "Users can delete their own feeds" ON club_feeds;

DROP POLICY IF EXISTS "Members can view club challenges" ON club_challenges;
DROP POLICY IF EXISTS "Owners and admins can create challenges" ON club_challenges;
DROP POLICY IF EXISTS "Owners and admins can update challenges" ON club_challenges;
DROP POLICY IF EXISTS "Owners and admins can delete challenges" ON club_challenges;

DROP POLICY IF EXISTS "Members can view contributions" ON challenge_contributions;
DROP POLICY IF EXISTS "Members can contribute" ON challenge_contributions;
DROP POLICY IF EXISTS "Users can delete their contributions" ON challenge_contributions;

-- Clubs Policies
CREATE POLICY "Users can view public clubs or their own clubs"
  ON clubs FOR SELECT
  USING (is_public = true OR id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid()));

CREATE POLICY "Users can insert their own clubs"
  ON clubs FOR INSERT
  WITH CHECK (owner_id = auth.uid());

CREATE POLICY "Club owners can update their clubs"
  ON clubs FOR UPDATE
  USING (owner_id = auth.uid())
  WITH CHECK (owner_id = auth.uid());

CREATE POLICY "Club owners can delete their clubs"
  ON clubs FOR DELETE
  USING (owner_id = auth.uid());

-- Club Members Policies (ë¬´í•œ ì¬ê·€ ë°©ì§€ë¥¼ ìœ„í•´ ë‹¨ìˆœí™”)
CREATE POLICY "Members can view club memberships"
  ON club_members FOR SELECT
  USING (true); -- ëª¨ë“  ë©¤ë²„ì‹­ ì¡°íšŒ ê°€ëŠ¥ (í´ëŸ½ ë©¤ë²„ì¸ì§€ëŠ” ì•± ë ˆë²¨ì—ì„œ í•„í„°ë§)

CREATE POLICY "Users can join clubs"
  ON club_members FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can update their own role"
  ON club_members FOR UPDATE
  USING (user_id = auth.uid());

CREATE POLICY "Users can leave clubs"
  ON club_members FOR DELETE
  USING (user_id = auth.uid());

-- Club Feeds Policies
CREATE POLICY "Members can view club feeds"
  ON club_feeds FOR SELECT
  USING (club_id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid()));

CREATE POLICY "Members can share to club feeds"
  ON club_feeds FOR INSERT
  WITH CHECK (
    user_id = auth.uid() AND
    club_id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid())
  );

CREATE POLICY "Users can delete their own feeds"
  ON club_feeds FOR DELETE
  USING (user_id = auth.uid());

-- Club Challenges Policies
CREATE POLICY "Members can view club challenges"
  ON club_challenges FOR SELECT
  USING (club_id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid()));

CREATE POLICY "Owners and admins can create challenges"
  ON club_challenges FOR INSERT
  WITH CHECK (
    created_by = auth.uid() AND
    club_id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid() AND role IN ('owner', 'admin'))
  );

CREATE POLICY "Owners and admins can update challenges"
  ON club_challenges FOR UPDATE
  USING (club_id IN (
    SELECT club_id FROM club_members WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  ));

CREATE POLICY "Owners and admins can delete challenges"
  ON club_challenges FOR DELETE
  USING (club_id IN (
    SELECT club_id FROM club_members WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  ));

-- Challenge Contributions Policies
CREATE POLICY "Members can view contributions"
  ON challenge_contributions FOR SELECT
  USING (challenge_id IN (
    SELECT id FROM club_challenges WHERE club_id IN (
      SELECT club_id FROM club_members WHERE user_id = auth.uid()
    )
  ));

CREATE POLICY "Members can contribute"
  ON challenge_contributions FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can delete their contributions"
  ON challenge_contributions FOR DELETE
  USING (user_id = auth.uid());

-- ============================================
-- 6. Helper Functions
-- ============================================

-- Function to increment challenge current_value
CREATE OR REPLACE FUNCTION increment_challenge_value(
  p_challenge_id UUID,
  p_increment INTEGER
)
RETURNS void AS $$
BEGIN
  UPDATE club_challenges
  SET current_value = current_value + p_increment,
      updated_at = NOW()
  WHERE id = p_challenge_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
</file>

<file path="docs/database/club_system_no_rls.sql">
-- Club System Migration (RLS ë¹„í™œì„±í™” ë²„ì „)
-- í”„ë¡œí† íƒ€ì… ë‹¨ê³„ì—ì„œëŠ” RLSë¥¼ ë¹„í™œì„±í™”í•˜ê³  ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ê¶Œí•œ ê´€ë¦¬

-- ============================================
-- 1. Helper Function (if not exists)
-- ============================================
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- 2. Clubs System Tables (Phase 1)
-- ============================================

-- Clubs Table
CREATE TABLE IF NOT EXISTS clubs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  is_public BOOLEAN DEFAULT false,
  invite_code UUID DEFAULT gen_random_uuid() UNIQUE NOT NULL,
  owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for clubs table
CREATE INDEX IF NOT EXISTS idx_clubs_owner_id ON clubs(owner_id);
CREATE INDEX IF NOT EXISTS idx_clubs_invite_code ON clubs(invite_code);
CREATE INDEX IF NOT EXISTS idx_clubs_is_public ON clubs(is_public) WHERE is_public = true;

-- Club Members Table (N:M relationship)
CREATE TABLE IF NOT EXISTS club_members (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(club_id, user_id)
);

-- Indexes for club_members table
CREATE INDEX IF NOT EXISTS idx_club_members_club_id ON club_members(club_id);
CREATE INDEX IF NOT EXISTS idx_club_members_user_id ON club_members(user_id);
CREATE INDEX IF NOT EXISTS idx_club_members_role ON club_members(role);

-- Club Feeds Table (shared workout logs)
CREATE TABLE IF NOT EXISTS club_feeds (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  workout_log_id UUID NOT NULL REFERENCES workout_logs(id) ON DELETE CASCADE,
  shared_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(club_id, workout_log_id)
);

-- Indexes for club_feeds table
CREATE INDEX IF NOT EXISTS idx_club_feeds_club_id ON club_feeds(club_id);
CREATE INDEX IF NOT EXISTS idx_club_feeds_user_id ON club_feeds(user_id);
CREATE INDEX IF NOT EXISTS idx_club_feeds_workout_log_id ON club_feeds(workout_log_id);
CREATE INDEX IF NOT EXISTS idx_club_feeds_shared_at ON club_feeds(shared_at DESC);

-- ============================================
-- 3. Challenges System Tables (Phase 2)
-- ============================================

-- Club Challenges Table
CREATE TABLE IF NOT EXISTS club_challenges (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  challenge_type TEXT NOT NULL DEFAULT 'total_workouts' CHECK (
    challenge_type IN ('total_workouts', 'total_volume', 'total_duration', 'total_distance')
  ),
  target_value INTEGER NOT NULL,
  current_value INTEGER DEFAULT 0,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'completed', 'failed')),
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for club_challenges table
CREATE INDEX IF NOT EXISTS idx_club_challenges_club_id ON club_challenges(club_id);
CREATE INDEX IF NOT EXISTS idx_club_challenges_status ON club_challenges(status);
CREATE INDEX IF NOT EXISTS idx_club_challenges_end_date ON club_challenges(end_date);

-- Challenge Contributions Table
CREATE TABLE IF NOT EXISTS challenge_contributions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  challenge_id UUID NOT NULL REFERENCES club_challenges(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  workout_log_id UUID NOT NULL REFERENCES workout_logs(id) ON DELETE CASCADE,
  contribution_value INTEGER NOT NULL,
  contributed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(challenge_id, workout_log_id)
);

-- Indexes for challenge_contributions table
CREATE INDEX IF NOT EXISTS idx_challenge_contributions_challenge_id ON challenge_contributions(challenge_id);
CREATE INDEX IF NOT EXISTS idx_challenge_contributions_user_id ON challenge_contributions(user_id);

-- ============================================
-- 4. Triggers for Clubs System
-- ============================================

-- Trigger for clubs table
DROP TRIGGER IF EXISTS update_clubs_updated_at ON clubs;
CREATE TRIGGER update_clubs_updated_at
  BEFORE UPDATE ON clubs
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Trigger for club_challenges table
DROP TRIGGER IF EXISTS update_club_challenges_updated_at ON club_challenges;
CREATE TRIGGER update_club_challenges_updated_at
  BEFORE UPDATE ON club_challenges
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 5. RLS ë¹„í™œì„±í™” (í”„ë¡œí† íƒ€ì… ë‹¨ê³„)
-- ============================================

-- ê¸°ì¡´ ì •ì±… ëª¨ë‘ ì‚­ì œ
DROP POLICY IF EXISTS "Users can view public clubs or their own clubs" ON clubs;
DROP POLICY IF EXISTS "Users can insert their own clubs" ON clubs;
DROP POLICY IF EXISTS "Club owners can update their clubs" ON clubs;
DROP POLICY IF EXISTS "Club owners can delete their clubs" ON clubs;

DROP POLICY IF EXISTS "Members can view club memberships" ON club_members;
DROP POLICY IF EXISTS "Members can view their club memberships" ON club_members;
DROP POLICY IF EXISTS "Users can join clubs" ON club_members;
DROP POLICY IF EXISTS "Owners and admins can update memberships" ON club_members;
DROP POLICY IF EXISTS "Users can update their own role" ON club_members;
DROP POLICY IF EXISTS "Owners and admins can delete memberships" ON club_members;
DROP POLICY IF EXISTS "Users can leave clubs" ON club_members;

DROP POLICY IF EXISTS "Members can view club feeds" ON club_feeds;
DROP POLICY IF EXISTS "Members can share to club feeds" ON club_feeds;
DROP POLICY IF EXISTS "Users can delete their own feeds" ON club_feeds;

DROP POLICY IF EXISTS "Members can view club challenges" ON club_challenges;
DROP POLICY IF EXISTS "Owners and admins can create challenges" ON club_challenges;
DROP POLICY IF EXISTS "Owners and admins can update challenges" ON club_challenges;
DROP POLICY IF EXISTS "Owners and admins can delete challenges" ON club_challenges;

DROP POLICY IF EXISTS "Members can view contributions" ON challenge_contributions;
DROP POLICY IF EXISTS "Members can contribute" ON challenge_contributions;
DROP POLICY IF EXISTS "Users can delete their contributions" ON challenge_contributions;

-- RLS ë¹„í™œì„±í™”
ALTER TABLE clubs DISABLE ROW LEVEL SECURITY;
ALTER TABLE club_members DISABLE ROW LEVEL SECURITY;
ALTER TABLE club_feeds DISABLE ROW LEVEL SECURITY;
ALTER TABLE club_challenges DISABLE ROW LEVEL SECURITY;
ALTER TABLE challenge_contributions DISABLE ROW LEVEL SECURITY;

-- ============================================
-- 6. Helper Functions
-- ============================================

-- Function to increment challenge current_value
CREATE OR REPLACE FUNCTION increment_challenge_value(
  p_challenge_id UUID,
  p_increment INTEGER
)
RETURNS void AS $$
BEGIN
  UPDATE club_challenges
  SET current_value = current_value + p_increment,
      updated_at = NOW()
  WHERE id = p_challenge_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
</file>

<file path="docs/database/diagnose_and_fix.sql">
-- Diagnose and fix club_challenges structure
-- club_challengesì˜ ì‹¤ì œ êµ¬ì¡° íŒŒì•… ë° ìˆ˜ì •
--
-- ì‘ì„±ì¼: 2026-01-20

-- ============================================
-- STEP 1: Diagnose - What is club_challenges?
-- ============================================

-- Check if it's a table or view
SELECT
  'club_challenges structure' as info,
  table_schema,
  table_name,
  table_type
FROM information_schema.tables
WHERE table_name = 'club_challenges';

-- Get current columns
SELECT
  'Current columns in club_challenges' as info,
  column_name,
  data_type,
  is_nullable
FROM information_schema.columns
WHERE table_name = 'club_challenges'
ORDER BY ordinal_position;

-- If it's a view, get the definition
SELECT
  'View definition (if applicable)' as info,
  table_name,
  view_definition
FROM information_schema.views
WHERE table_name = 'club_challenges';

-- Find all challenge-related base tables
SELECT
  'All challenge-related base tables' as info,
  schemaname,
  tablename
FROM pg_tables
WHERE tablename LIKE '%challenge%'
ORDER BY tablename;

-- ============================================
-- STEP 2: Try to find and modify base table
-- ============================================

-- First, let's see what pg_class says
SELECT
  'From pg_class' as info,
  relname as table_name,
  relkind as type,
  CASE relkind
    WHEN 'r' THEN 'ordinary table'
    WHEN 'v' THEN 'view'
    WHEN 'm' THEN 'materialized view'
    ELSE relkind::text
  END as type_description
FROM pg_class
WHERE relname = 'club_challenges';

-- ============================================
-- STEP 3: Manual fix options
-- ============================================

-- Option A: If there's a base table with a different name, modify it
-- (Replace 'actual_table_name' with the real table name found above)
-- ALTER TABLE actual_table_name ADD COLUMN IF NOT EXISTS rules JSONB;
-- ALTER TABLE actual_table_name ADD COLUMN IF NOT EXISTS theme_color TEXT DEFAULT '#8b5cf6';

-- Option B: If it's truly a view, we might need to drop and recreate it
-- But first, save the view definition:
-- (Copy the view_definition from Step 1 results before dropping)

-- Option C: Create the columns in the schema that the view uses
-- (This requires knowing which schema/table the view is based on)

SELECT 'Please review the results above and determine:
1. Is club_challenges a view or table?
2. If it is a view, what is the base table name?
3. Share the view_definition so we can recreate it with new columns' as next_steps;
</file>

<file path="docs/database/disable_rls_for_dev.sql">
-- Disable RLS for Development
-- ì•±ì´ Supabase Authë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ RLSë¥¼ ì„ì‹œë¡œ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
-- ì£¼ì˜: í”„ë¡œë•ì…˜ì—ì„œëŠ” ë°˜ë“œì‹œ Supabase Authë¥¼ êµ¬í˜„í•˜ê³  RLSë¥¼ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤!

-- Club ê´€ë ¨ í…Œì´ë¸” RLS ë¹„í™œì„±í™”
ALTER TABLE clubs DISABLE ROW LEVEL SECURITY;
ALTER TABLE club_members DISABLE ROW LEVEL SECURITY;
ALTER TABLE club_feeds DISABLE ROW LEVEL SECURITY;

-- Challenge ê´€ë ¨ í…Œì´ë¸” RLS ë¹„í™œì„±í™”
ALTER TABLE challenges DISABLE ROW LEVEL SECURITY;
ALTER TABLE challenge_participants DISABLE ROW LEVEL SECURITY;

-- ê¸°ì¡´ ì •ì±… ëª¨ë‘ ì œê±° (ì •ë¦¬)
DROP POLICY IF EXISTS "Users can view public clubs or their own clubs" ON clubs;
DROP POLICY IF EXISTS "Users can insert their own clubs" ON clubs;
DROP POLICY IF EXISTS "Club owners can update their clubs" ON clubs;
DROP POLICY IF EXISTS "Club owners can delete their clubs" ON clubs;

DROP POLICY IF EXISTS "Members can view club memberships" ON club_members;
DROP POLICY IF EXISTS "Users can join clubs" ON club_members;
DROP POLICY IF EXISTS "Users can update their own role" ON club_members;
DROP POLICY IF EXISTS "Users can leave clubs" ON club_members;

DROP POLICY IF EXISTS "Members can view club feeds" ON club_feeds;
DROP POLICY IF EXISTS "Members can share to club feeds" ON club_feeds;
DROP POLICY IF EXISTS "Users can delete their own feeds" ON club_feeds;

DROP POLICY IF EXISTS "Anyone can view global challenges" ON challenges;
DROP POLICY IF EXISTS "Club members can view club challenges" ON challenges;
DROP POLICY IF EXISTS "Club owners and admins can create club challenges" ON challenges;
DROP POLICY IF EXISTS "Club owners and admins can update club challenges" ON challenges;
DROP POLICY IF EXISTS "Club owners and admins can delete club challenges" ON challenges;

DROP POLICY IF EXISTS "Users can view their own participations" ON challenge_participants;
DROP POLICY IF EXISTS "Users can contribute to challenges" ON challenge_participants;
DROP POLICY IF EXISTS "Users can delete their own participations" ON challenge_participants;

-- í™•ì¸
SELECT schemaname, tablename, rowsecurity
FROM pg_tables
WHERE tablename IN ('clubs', 'club_members', 'club_feeds', 'challenges', 'challenge_participants');
</file>

<file path="docs/database/find_base_table.sql">
-- Find the base table behind club_challenges view
-- club_challenges ë·°ì˜ ì‹¤ì œ ê¸°ë³¸ í…Œì´ë¸” ì°¾ê¸°

-- ============================================
-- Step 1: Confirm it's a view
-- ============================================

SELECT
  table_schema,
  table_name,
  table_type
FROM information_schema.tables
WHERE table_name = 'club_challenges';

-- ============================================
-- Step 2: Get view definition
-- ============================================

SELECT
  table_schema,
  table_name,
  view_definition
FROM information_schema.views
WHERE table_name = 'club_challenges';

-- ============================================
-- Step 3: Find all challenge-related tables
-- ============================================

SELECT
  table_schema,
  table_name,
  table_type
FROM information_schema.tables
WHERE table_name LIKE '%challenge%'
ORDER BY table_type, table_name;

-- ============================================
-- Step 4: Check for base tables in public schema
-- ============================================

SELECT
  schemaname,
  tablename,
  tableowner
FROM pg_tables
WHERE tablename LIKE '%challenge%';
</file>

<file path="docs/database/fix_club_rls.sql">
-- Fix Club RLS Policies
-- í´ëŸ½ ìƒì„± ì‹œ RLS ì˜¤ë¥˜ í•´ê²°

-- Enable RLS
ALTER TABLE clubs ENABLE ROW LEVEL SECURITY;
ALTER TABLE club_members ENABLE ROW LEVEL SECURITY;

-- Drop existing policies
DROP POLICY IF EXISTS "Users can view public clubs or their own clubs" ON clubs;
DROP POLICY IF EXISTS "Users can insert their own clubs" ON clubs;
DROP POLICY IF EXISTS "Club owners can update their clubs" ON clubs;
DROP POLICY IF EXISTS "Club owners can delete their clubs" ON clubs;

DROP POLICY IF EXISTS "Members can view club memberships" ON club_members;
DROP POLICY IF EXISTS "Users can join clubs" ON club_members;
DROP POLICY IF EXISTS "Users can update their own role" ON club_members;
DROP POLICY IF EXISTS "Users can leave clubs" ON club_members;

-- Create Clubs Policies
CREATE POLICY "Users can view public clubs or their own clubs"
  ON clubs FOR SELECT
  USING (is_public = true OR id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid()));

CREATE POLICY "Users can insert their own clubs"
  ON clubs FOR INSERT
  WITH CHECK (owner_id = auth.uid());

CREATE POLICY "Club owners can update their clubs"
  ON clubs FOR UPDATE
  USING (owner_id = auth.uid())
  WITH CHECK (owner_id = auth.uid());

CREATE POLICY "Club owners can delete their clubs"
  ON clubs FOR DELETE
  USING (owner_id = auth.uid());

-- Create Club Members Policies
CREATE POLICY "Members can view club memberships"
  ON club_members FOR SELECT
  USING (true);

CREATE POLICY "Users can join clubs"
  ON club_members FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can update their own role"
  ON club_members FOR UPDATE
  USING (user_id = auth.uid());

CREATE POLICY "Users can leave clubs"
  ON club_members FOR DELETE
  USING (user_id = auth.uid());
</file>

<file path="docs/database/fix_duration_type.sql">
-- Fix duration_min type: INTEGER â†’ NUMERIC
-- ì†Œìˆ˜ì  ìš´ë™ ì‹œê°„ ì§€ì› (ì˜ˆ: 45.3ë¶„, 1.5ì‹œê°„)
--
-- ì‘ì„±ì¼: 2026-01-20

-- duration_minì„ INTEGERì—ì„œ NUMERICìœ¼ë¡œ ë³€ê²½
ALTER TABLE workouts
ALTER COLUMN duration_min TYPE NUMERIC USING duration_min::NUMERIC;

-- ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
COMMENT ON COLUMN workouts.duration_min IS 'ìš´ë™ ì‹œê°„ (ë¶„, ì†Œìˆ˜ì  í—ˆìš©)';

-- í™•ì¸
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'workouts' AND column_name = 'duration_min';
</file>

<file path="docs/database/migrate_data_only.sql">
-- Challenge Maker: Data migration only (skip constraints)
-- VIEWì—ì„œëŠ” constraintë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ë§Œ ìˆ˜í–‰
--
-- ì‘ì„±ì¼: 2026-01-20

-- ============================================
-- Step 1: Add column comments (safe for views)
-- ============================================

COMMENT ON COLUMN club_challenges.rules IS 'Quest Builder í•„í„°ë§ ê·œì¹™ (JSONB):
{
  target_metric: "volume_kg" | "adjusted_dist_km" | "duration_min" | "run_count" | "workout_count" | "attendance_days",
  filter: {
    category?: string[],
    type?: string[],
    keyword_include?: string[],
    keyword_exclude?: string[]
  },
  aggregation: "sum" | "count",
  goal_value: number,
  unit: string
}';

COMMENT ON COLUMN club_challenges.theme_color IS 'UI í…Œë§ˆ ìƒ‰ìƒ (hex code)';

-- ============================================
-- Step 2: Migrate existing data
-- ============================================

-- Only update rows where rules is NULL
UPDATE club_challenges
SET rules = jsonb_build_object(
  'target_metric',
  CASE challenge_type
    WHEN 'total_volume' THEN 'volume_kg'
    WHEN 'total_distance' THEN 'adjusted_dist_km'
    WHEN 'total_duration' THEN 'duration_min'
    WHEN 'total_workouts' THEN 'workout_count'
    ELSE 'workout_count'
  END,
  'filter', jsonb_build_object(),
  'aggregation', 'sum',
  'goal_value', target_value,
  'unit',
  CASE challenge_type
    WHEN 'total_volume' THEN 'kg'
    WHEN 'total_distance' THEN 'km'
    WHEN 'total_duration' THEN 'ë¶„'
    WHEN 'total_workouts' THEN 'íšŒ'
    ELSE 'íšŒ'
  END
)
WHERE rules IS NULL;

-- ============================================
-- Step 3: Set default theme_color for existing rows
-- ============================================

UPDATE club_challenges
SET theme_color = '#8b5cf6'
WHERE theme_color IS NULL;

-- ============================================
-- Step 4: Verify migration
-- ============================================

-- Check columns exist
SELECT
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'club_challenges' AND column_name IN ('rules', 'theme_color', 'challenge_type')
ORDER BY column_name;

-- Check data migration
SELECT
  id,
  title,
  challenge_type,
  target_value,
  rules,
  theme_color,
  created_at
FROM club_challenges
ORDER BY created_at DESC
LIMIT 5;

-- Summary
SELECT
  COUNT(*) as total_challenges,
  COUNT(rules) as with_rules,
  COUNT(CASE WHEN rules IS NOT NULL THEN 1 END) as rules_not_null,
  COUNT(theme_color) as with_theme
FROM club_challenges;

-- ============================================
-- Step 5: Test custom challenge type
-- ============================================

-- This will work if the base table allows 'custom' type
-- If it fails, we need to modify the base table constraint
SELECT 'Testing custom type - if this runs, constraint is OK' as test_result;
</file>

<file path="docs/database/migrations/migrate_test01_to_kakao.sql">
-- Migrate test01 user data to Kakao user
-- test01 ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‚¬ìš©ìë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜

-- Step 1: ë¨¼ì € ì¹´ì¹´ì˜¤ ì‚¬ìš©ìì˜ IDë¥¼ í™•ì¸í•©ë‹ˆë‹¤
-- Supabase SQL Editorì—ì„œ ì‹¤í–‰:
-- SELECT id, username, display_name, kakao_id FROM users WHERE kakao_id IS NOT NULL;
-- ë˜ëŠ”
-- SELECT id, username, display_name FROM users WHERE username LIKE 'kakao_%';

-- Step 2: test01 ì‚¬ìš©ìì˜ IDë¥¼ í™•ì¸í•©ë‹ˆë‹¤
-- SELECT id, username, display_name FROM users WHERE username = 'tester01';

-- Step 3: ì•„ë˜ ë³€ìˆ˜ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”
DO $$
DECLARE
    v_test01_user_id UUID := 'ì—¬ê¸°ì—_test01_ì‚¬ìš©ì_IDë¥¼_ì…ë ¥í•˜ì„¸ìš”'; -- test01 ì‚¬ìš©ìì˜ ì‹¤ì œ ID
    v_kakao_user_id UUID := 'ì—¬ê¸°ì—_ì¹´ì¹´ì˜¤_ì‚¬ìš©ì_IDë¥¼_ì…ë ¥í•˜ì„¸ìš”';   -- ì¹´ì¹´ì˜¤ ì‚¬ìš©ìì˜ ì‹¤ì œ ID
    v_affected_logs INTEGER;
BEGIN
    -- workout_logsì˜ user_idë¥¼ ë³€ê²½
    -- ON CONFLICT ë°©ì§€ë¥¼ ìœ„í•´ íŠ¸ëœì­ì…˜ ì‚¬ìš©
    UPDATE workout_logs
    SET user_id = v_kakao_user_id
    WHERE user_id = v_test01_user_id;

    GET DIAGNOSTICS v_affected_logs = ROW_COUNT;
    RAISE NOTICE '% workout logs migrated', v_affected_logs;

    -- user_profilesì˜ user_idë¥¼ ë³€ê²½
    UPDATE user_profiles
    SET user_id = v_kakao_user_id
    WHERE user_id = v_test01_user_id;

    RAISE NOTICE 'User profile migrated (if exists)';

    -- ì„ íƒì‚¬í•­: test01 ì‚¬ìš©ì ì‚­ì œ
    -- DELETE FROM users WHERE id = v_test01_user_id;
    -- RAISE NOTICE 'Test01 user deleted';

    RAISE NOTICE 'Migration completed successfully!';
END $$;

-- ============================================
-- ë˜ëŠ” ê°„ë‹¨í•œ ë°©ë²• (IDë¥¼ ì§ì ‘ ì…ë ¥):
-- ============================================

-- 1. test01ê³¼ ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ID í™•ì¸
SELECT
    id,
    username,
    display_name,
    kakao_id,
    provider
FROM users
WHERE username IN ('tester01', 'kakao_YOUR_KAKAO_ID')
ORDER BY username;

-- 2. ìœ„ì—ì„œ í™•ì¸í•œ IDë¥¼ ì•„ë˜ì— ì…ë ¥í•˜ê³  ì‹¤í–‰
-- UPDATE workout_logs
-- SET user_id = 'YOUR_KAKAO_USER_UUID'
-- WHERE user_id = 'YOUR_TEST01_USER_UUID';

-- UPDATE user_profiles
-- SET user_id = 'YOUR_KAKAO_USER_UUID'
-- WHERE user_id = 'YOUR_TEST01_USER_UUID';

-- 3. (ì„ íƒ) test01 ì‚¬ìš©ì ì‚­ì œ
-- DELETE FROM users WHERE id = 'YOUR_TEST01_USER_UUID';

-- ============================================
-- ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦
-- ============================================

-- ì¹´ì¹´ì˜¤ ì‚¬ìš©ìì˜ ëª¨ë“  workout logs í™•ì¸
SELECT
    wl.id,
    wl.date,
    wl.raw_text,
    COUNT(w.id) as workout_count
FROM workout_logs wl
LEFT JOIN workouts w ON w.workout_log_id = wl.id
WHERE wl.user_id = 'YOUR_KAKAO_USER_UUID'
GROUP BY wl.id, wl.date, wl.raw_text
ORDER BY wl.created_at DESC;

-- test01 ì‚¬ìš©ìì— ë‚¨ì€ ë°ì´í„° í™•ì¸ (0ì´ì–´ì•¼ í•¨)
SELECT COUNT(*) FROM workout_logs WHERE user_id = 'YOUR_TEST01_USER_UUID';
</file>

<file path="docs/database/migrations/migrate-user-data.ts">
// Migration Tool: Transfer workout_logs from one user to another
// ì‚¬ìš©ë²•: npx tsx migrate-user-data.ts

import { createClient } from '@supabase/supabase-js';
import * as readline from 'readline';

// Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
const supabaseUrl = process.env.VITE_SUPABASE_URL || '';
const supabaseKey = process.env.VITE_SUPABASE_PUBLISHABLE_KEY || '';

if (!supabaseUrl || !supabaseKey) {
  console.error('âŒ Error: Supabase credentials not found in .env file');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// ì‚¬ìš©ì ì…ë ¥ì„ ë°›ëŠ” í•¨ìˆ˜
function askQuestion(query: string): Promise<string> {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  return new Promise((resolve) =>
    rl.question(query, (answer) => {
      rl.close();
      resolve(answer);
    })
  );
}

// UUID ìœ íš¨ì„± ê²€ì‚¬
function isValidUUID(uuid: string): boolean {
  const uuidRegex =
    /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  return uuidRegex.test(uuid);
}

// ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
async function getUserInfo(userId: string) {
  const { data, error } = await supabase
    .from('users')
    .select('id, username, display_name, email, provider, kakao_id')
    .eq('id', userId)
    .single();

  if (error) throw error;
  return data;
}

// workout_logs ê°œìˆ˜ ì¡°íšŒ
async function getWorkoutLogsCount(userId: string) {
  const { count, error } = await supabase
    .from('workout_logs')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId);

  if (error) throw error;
  return count || 0;
}

// ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
async function migrateUserData(fromUserId: string, toUserId: string) {
  console.log('\nğŸ”„ Starting migration...');

  // workout_logs ì—…ë°ì´íŠ¸
  const { error: logsError } = await supabase
    .from('workout_logs')
    .update({ user_id: toUserId })
    .eq('user_id', fromUserId);

  if (logsError) {
    console.error('âŒ Error updating workout_logs:', logsError);
    throw logsError;
  }

  // user_profiles ì—…ë°ì´íŠ¸ (ìˆë‹¤ë©´)
  const { error: profileError } = await supabase
    .from('user_profiles')
    .update({ user_id: toUserId })
    .eq('user_id', fromUserId);

  // user_profilesê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì—ëŸ¬ ë¬´ì‹œ
  if (profileError && profileError.code !== 'PGRST116') {
    console.warn('âš ï¸  Warning: Could not update user_profiles:', profileError);
  }

  console.log('âœ… Migration completed successfully!');
}

// ë©”ì¸ í•¨ìˆ˜
async function main() {
  console.log('====================================');
  console.log('ğŸ”§ User Data Migration Tool');
  console.log('====================================\n');

  try {
    // Step 1: ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ
    console.log('ğŸ“‹ Fetching all users...\n');
    const { data: users, error: usersError } = await supabase
      .from('users')
      .select('id, username, display_name, provider, kakao_id')
      .order('created_at', { ascending: false });

    if (usersError) throw usersError;

    console.log('Available users:');
    console.log('----------------------------------------');
    for (const user of users || []) {
      const logsCount = await getWorkoutLogsCount(user.id);
      console.log(
        `${user.username.padEnd(25)} | ${user.display_name.padEnd(15)} | ${user.provider.padEnd(8)} | ${logsCount} logs | ID: ${user.id}`
      );
    }
    console.log('----------------------------------------\n');

    // Step 2: ì›ë³¸ ì‚¬ìš©ì ID ì…ë ¥
    const fromUserId = await askQuestion(
      'Enter SOURCE user ID (ë°ì´í„°ë¥¼ ì˜®ê¸¸ ì›ë³¸ ì‚¬ìš©ì ID): '
    );

    if (!isValidUUID(fromUserId.trim())) {
      console.error('âŒ Error: Invalid UUID format');
      process.exit(1);
    }

    const fromUser = await getUserInfo(fromUserId.trim());
    const fromLogsCount = await getWorkoutLogsCount(fromUserId.trim());

    console.log(`\nâœ… Source user found:`);
    console.log(`   Username: ${fromUser.username}`);
    console.log(`   Display Name: ${fromUser.display_name}`);
    console.log(`   Provider: ${fromUser.provider}`);
    console.log(`   Workout Logs: ${fromLogsCount}`);

    // Step 3: ëŒ€ìƒ ì‚¬ìš©ì ID ì…ë ¥
    const toUserId = await askQuestion(
      '\nEnter TARGET user ID (ë°ì´í„°ë¥¼ ë°›ì„ ëŒ€ìƒ ì‚¬ìš©ì ID): '
    );

    if (!isValidUUID(toUserId.trim())) {
      console.error('âŒ Error: Invalid UUID format');
      process.exit(1);
    }

    const toUser = await getUserInfo(toUserId.trim());
    const toLogsCount = await getWorkoutLogsCount(toUserId.trim());

    console.log(`\nâœ… Target user found:`);
    console.log(`   Username: ${toUser.username}`);
    console.log(`   Display Name: ${toUser.display_name}`);
    console.log(`   Provider: ${toUser.provider}`);
    console.log(`   Current Workout Logs: ${toLogsCount}`);

    // Step 4: í™•ì¸
    console.log('\nâš ï¸  WARNING: This will transfer ALL workout logs!');
    console.log(`   FROM: ${fromUser.username} (${fromLogsCount} logs)`);
    console.log(`   TO:   ${toUser.username} (currently ${toLogsCount} logs)`);
    console.log(`   TOTAL after migration: ${fromLogsCount + toLogsCount} logs\n`);

    const confirm = await askQuestion(
      'Are you sure you want to proceed? (yes/no): '
    );

    if (confirm.toLowerCase() !== 'yes') {
      console.log('âŒ Migration cancelled.');
      process.exit(0);
    }

    // Step 5: ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
    await migrateUserData(fromUserId.trim(), toUserId.trim());

    // Step 6: ê²°ê³¼ í™•ì¸
    const finalFromCount = await getWorkoutLogsCount(fromUserId.trim());
    const finalToCount = await getWorkoutLogsCount(toUserId.trim());

    console.log('\nğŸ“Š Migration Results:');
    console.log(`   ${fromUser.username}: ${fromLogsCount} â†’ ${finalFromCount} logs`);
    console.log(`   ${toUser.username}: ${toLogsCount} â†’ ${finalToCount} logs`);

    // Step 7: ì›ë³¸ ì‚¬ìš©ì ì‚­ì œ ì˜µì…˜
    if (finalFromCount === 0) {
      console.log('\nğŸ’¡ The source user now has 0 workout logs.');
      const deleteUser = await askQuestion(
        'Do you want to DELETE the source user? (yes/no): '
      );

      if (deleteUser.toLowerCase() === 'yes') {
        const { error: deleteError } = await supabase
          .from('users')
          .delete()
          .eq('id', fromUserId.trim());

        if (deleteError) {
          console.error('âŒ Error deleting user:', deleteError);
        } else {
          console.log('âœ… Source user deleted successfully!');
        }
      }
    }

    console.log('\nâœ¨ All done!\n');
  } catch (error) {
    console.error('\nâŒ Error:', error);
    process.exit(1);
  }
}

main();
</file>

<file path="docs/database/migrations/MIGRATION_GUIDE.md">
# User Data Migration Guide

test01 ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¡œ ì˜®ê¸°ëŠ” ê°€ì´ë“œì…ë‹ˆë‹¤.

## ë°©ë²• 1: TypeScript ë„êµ¬ ì‚¬ìš© (ê¶Œì¥)

### 1ë‹¨ê³„: í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
npm install -D tsx
```

### 2ë‹¨ê³„: ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬ ì‹¤í–‰

```bash
npx tsx migrate-user-data.ts
```

### 3ë‹¨ê³„: í™”ë©´ ì•ˆë‚´ì— ë”°ë¼ ì§„í–‰

1. ëª¨ë“  ì‚¬ìš©ì ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤
2. SOURCE user ID (test01 ì‚¬ìš©ì ID) ì…ë ¥
3. TARGET user ID (ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ID) ì…ë ¥
4. í™•ì¸ í›„ 'yes' ì…ë ¥
5. ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!

### ì˜ˆì‹œ ì¶œë ¥

```
====================================
ğŸ”§ User Data Migration Tool
====================================

ğŸ“‹ Fetching all users...

Available users:
----------------------------------------
tester01                  | í…ŒìŠ¤í„°          | local    | 15 logs | ID: xxx-xxx-xxx
kakao_1234567890          | í™ê¸¸ë™          | kakao    | 0 logs  | ID: yyy-yyy-yyy
----------------------------------------

Enter SOURCE user ID (ë°ì´í„°ë¥¼ ì˜®ê¸¸ ì›ë³¸ ì‚¬ìš©ì ID): xxx-xxx-xxx

âœ… Source user found:
   Username: tester01
   Display Name: í…ŒìŠ¤í„°
   Provider: local
   Workout Logs: 15

Enter TARGET user ID (ë°ì´í„°ë¥¼ ë°›ì„ ëŒ€ìƒ ì‚¬ìš©ì ID): yyy-yyy-yyy

âœ… Target user found:
   Username: kakao_1234567890
   Display Name: í™ê¸¸ë™
   Provider: kakao
   Current Workout Logs: 0

âš ï¸  WARNING: This will transfer ALL workout logs!
   FROM: tester01 (15 logs)
   TO:   kakao_1234567890 (currently 0 logs)
   TOTAL after migration: 15 logs

Are you sure you want to proceed? (yes/no): yes

ğŸ”„ Starting migration...
âœ… Migration completed successfully!

ğŸ“Š Migration Results:
   tester01: 15 â†’ 0 logs
   kakao_1234567890: 0 â†’ 15 logs

ğŸ’¡ The source user now has 0 workout logs.
Do you want to DELETE the source user? (yes/no): yes
âœ… Source user deleted successfully!

âœ¨ All done!
```

## ë°©ë²• 2: Supabase SQL Editorì—ì„œ ì§ì ‘ ì‹¤í–‰

### 1ë‹¨ê³„: ì‚¬ìš©ì ID í™•ì¸

Supabase Dashboard â†’ SQL Editorì—ì„œ ì‹¤í–‰:

```sql
SELECT
    id,
    username,
    display_name,
    provider,
    kakao_id
FROM users
ORDER BY created_at DESC;
```

### 2ë‹¨ê³„: workout_logs ê°œìˆ˜ í™•ì¸

```sql
SELECT
    u.username,
    u.display_name,
    COUNT(wl.id) as log_count
FROM users u
LEFT JOIN workout_logs wl ON wl.user_id = u.id
GROUP BY u.id, u.username, u.display_name
ORDER BY log_count DESC;
```

### 3ë‹¨ê³„: ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

ì•„ë˜ SQLì—ì„œ UUIDë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½í•˜ê³  ì‹¤í–‰:

```sql
-- 1. workout_logs ì´ì „
UPDATE workout_logs
SET user_id = 'YOUR_KAKAO_USER_UUID'
WHERE user_id = 'YOUR_TEST01_USER_UUID';

-- 2. user_profiles ì´ì „ (ìˆë‹¤ë©´)
UPDATE user_profiles
SET user_id = 'YOUR_KAKAO_USER_UUID'
WHERE user_id = 'YOUR_TEST01_USER_UUID';

-- 3. ê²°ê³¼ í™•ì¸
SELECT
    u.username,
    COUNT(wl.id) as log_count
FROM users u
LEFT JOIN workout_logs wl ON wl.user_id = u.id
WHERE u.id IN ('YOUR_TEST01_USER_UUID', 'YOUR_KAKAO_USER_UUID')
GROUP BY u.id, u.username;

-- 4. (ì„ íƒ) test01 ì‚¬ìš©ì ì‚­ì œ
-- DELETE FROM users WHERE id = 'YOUR_TEST01_USER_UUID';
```

## ë°©ë²• 3: ê°„í¸ ìŠ¤í¬ë¦½íŠ¸ (package.json)

### package.jsonì— ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€

```json
{
  "scripts": {
    "migrate": "tsx migrate-user-data.ts"
  }
}
```

### ì‹¤í–‰

```bash
npm run migrate
```

## ì£¼ì˜ì‚¬í•­

1. **ë°±ì—…**: ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ì— Supabaseì—ì„œ ë°ì´í„° ë°±ì—… ê¶Œì¥
2. **í…ŒìŠ¤íŠ¸**: ê°€ëŠ¥í•˜ë©´ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ë¨¼ì € ì‹¤í–‰
3. **ë³µêµ¬ ë¶ˆê°€**: ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì›ë³¸ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ë©´ ë³µêµ¬ ë¶ˆê°€ëŠ¥
4. **ê´€ê³„ ìœ ì§€**: workoutsëŠ” workout_log_idë¡œ ìë™ìœ¼ë¡œ ì—°ê²°ë˜ë¯€ë¡œ ë³„ë„ ì‘ì—… ë¶ˆí•„ìš”

## ë¬¸ì œ í•´ê²°

### "Invalid UUID format" ì˜¤ë¥˜
- UUID í˜•ì‹ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸ (ì˜ˆ: `123e4567-e89b-12d3-a456-426614174000`)
- ì•ë’¤ ê³µë°± ì œê±°

### "User not found" ì˜¤ë¥˜
- ì‚¬ìš©ì IDê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
- Supabase Dashboardì—ì„œ ì§ì ‘ ì¡°íšŒ

### RLS (Row Level Security) ì˜¤ë¥˜
- Supabase service role keyë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜
- RLS ì •ì±…ì„ ì¼ì‹œì ìœ¼ë¡œ ë¹„í™œì„±í™” í›„ ì‹¤í–‰

## ì™„ë£Œ í›„ í™•ì¸ì‚¬í•­

âœ… ì¹´ì¹´ì˜¤ ì‚¬ìš©ìì˜ workout_logs ê°œìˆ˜ í™•ì¸
âœ… ì•±ì—ì„œ ë¡œê·¸ì¸ í›„ ë°ì´í„° ì •ìƒ í‘œì‹œ í™•ì¸
âœ… test01 ì‚¬ìš©ì ë¡œê·¸ ê°œìˆ˜ 0ê°œ í™•ì¸
âœ… (ì„ íƒ) test01 ì‚¬ìš©ì ì‚­ì œ
</file>

<file path="docs/database/quest_builder_migration.sql">
-- ============================================
-- Quest Builder Migration (2026-01-21)
-- ============================================
-- ì‹¤í–‰: Supabase SQL Editorì— ë³µì‚¬ & Run ë²„íŠ¼ í´ë¦­
-- ============================================

-- 1. Add columns to challenges table (NOT the view!)
ALTER TABLE challenges ADD COLUMN IF NOT EXISTS rules JSONB;
ALTER TABLE challenges ADD COLUMN IF NOT EXISTS theme_color TEXT DEFAULT '#8b5cf6';

-- 2. Allow 'custom' challenge type
ALTER TABLE challenges DROP CONSTRAINT IF EXISTS challenges_goal_metric_check;
ALTER TABLE challenges ADD CONSTRAINT challenges_goal_metric_check
  CHECK (goal_metric IN ('total_workouts', 'total_volume', 'total_duration', 'total_distance', 'custom'));

-- 3. Update club_challenges view to expose new columns (ADD AT END!)
CREATE OR REPLACE VIEW club_challenges AS
SELECT
  id, club_id, title, description,
  goal_metric as challenge_type,
  goal_value as target_value,
  current_value,
  start_date, end_date, status,
  created_by, created_at, updated_at,
  rules, theme_color  -- NEW (ë§¨ ëì— ì¶”ê°€)
FROM challenges
WHERE scope = 'club';

-- 4. Migrate existing club challenges
UPDATE challenges
SET rules = jsonb_build_object(
  'target_metric', CASE goal_metric
    WHEN 'total_volume' THEN 'volume_kg'
    WHEN 'total_distance' THEN 'adjusted_dist_km'
    WHEN 'total_duration' THEN 'duration_min'
    ELSE 'workout_count'
  END,
  'filter', '{}'::jsonb,
  'aggregation', 'sum',
  'goal_value', goal_value,
  'unit', CASE goal_metric
    WHEN 'total_volume' THEN 'kg'
    WHEN 'total_distance' THEN 'km'
    WHEN 'total_duration' THEN 'ë¶„'
    ELSE 'íšŒ'
  END
)
WHERE scope = 'club' AND rules IS NULL;

-- 5. Verify (should show all club challenges with rules)
SELECT id, title, challenge_type, rules, theme_color
FROM club_challenges
ORDER BY created_at DESC
LIMIT 3;
</file>

<file path="docs/database/README.md">
# Database Migrations

## ì‹¤í–‰ ë°©ë²•
Supabase Dashboard â†’ SQL Editor â†’ íŒŒì¼ ë‚´ìš© ë³µì‚¬ & Run

---

## íŒŒì¼ ëª©ë¡

### ğŸ—ï¸ ì´ˆê¸° ìŠ¤í‚¤ë§ˆ (ì´ë¯¸ ì‹¤í–‰ë¨)
- **two_track_challenge_migration.sql** - challenges í…Œì´ë¸” ìƒì„± (Global + Club ì±Œë¦°ì§€ ì‹œìŠ¤í…œ)
- **club_system_migration.sql** - í´ëŸ½ ì‹œìŠ¤í…œ í…Œì´ë¸” ìƒì„±
- **schema.sql** - ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### ğŸ”§ ê¸°ëŠ¥ ì¶”ê°€ ë§ˆì´ê·¸ë ˆì´ì…˜
- **quest_builder_migration.sql** - ì±Œë¦°ì§€ì— rules/theme_color ì»¬ëŸ¼ ì¶”ê°€ (Quest Builderìš©)
- **club_dashboard_widgets_migration.sql** - í´ëŸ½ ëŒ€ì‹œë³´ë“œ ìœ„ì ¯ ì„¤ì • ì»¬ëŸ¼ ì¶”ê°€
- **zero_copy_view_migration.sql** - Zero-Copy View íŒ¨í„´ êµ¬í˜„
- **type_specific_metrics_migration.sql** - Typeë³„ ì§€í‘œ ì»¬ëŸ¼ ì¶”ê°€
- **matrix_classification_migration.sql** - 2-Axis ë§¤íŠ¸ë¦­ìŠ¤ ë¶„ë¥˜ ì»¬ëŸ¼ ì¶”ê°€
- **xp_system_migration.sql** - XP ì‹œìŠ¤í…œ ì»¬ëŸ¼ ì¶”ê°€

### ğŸ” ë³´ì•ˆ ì„¤ì •
- **fix_club_rls.sql** - RLS ì •ì±… ìˆ˜ì •
- **disable_rls_for_dev.sql** - ê°œë°œ ëª¨ë“œìš© RLS ë¹„í™œì„±í™”

### ğŸ› ë²„ê·¸ ìˆ˜ì •
- **fix_duration_type.sql** - duration íƒ€ì… ìˆ˜ì •

---

## ì£¼ì˜ì‚¬í•­
1. ë§ˆì´ê·¸ë ˆì´ì…˜ì€ **í•œ ë²ˆë§Œ** ì‹¤í–‰í•˜ì„¸ìš”
2. ì‹¤í–‰ ì „ ë°±ì—… ê¶Œì¥
3. ì—ëŸ¬ ë°œìƒ ì‹œ SQL Editorì˜ ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸
</file>

<file path="docs/database/schema.sql">
-- Voice Workout Log - Complete Database Schema
-- ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

-- ============================================
-- 1. Users Table (ì´ë¯¸ ì¡´ì¬í•œë‹¤ë©´ SKIP)
-- ============================================
CREATE TABLE IF NOT EXISTS users (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  display_name TEXT NOT NULL,
  email TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- Kakao login fields
  kakao_id TEXT UNIQUE,
  provider TEXT DEFAULT 'local',
  profile_image TEXT,
  phone_number TEXT,
  birthyear TEXT,
  gender TEXT,
  nickname TEXT
);

-- Indexes for users table
CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
CREATE INDEX IF NOT EXISTS idx_users_kakao_id ON users(kakao_id);
CREATE INDEX IF NOT EXISTS idx_users_provider ON users(provider);

-- Comments
COMMENT ON TABLE users IS 'ì‚¬ìš©ì ì •ë³´';
COMMENT ON COLUMN users.kakao_id IS 'ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ê³ ìœ  ID';
COMMENT ON COLUMN users.provider IS 'ë¡œê·¸ì¸ ì œê³µì (local, kakao)';
COMMENT ON COLUMN users.profile_image IS 'í”„ë¡œí•„ ì´ë¯¸ì§€ URL';
COMMENT ON COLUMN users.phone_number IS 'ì „í™”ë²ˆí˜¸';
COMMENT ON COLUMN users.birthyear IS 'ì¶œìƒë…„ë„';
COMMENT ON COLUMN users.gender IS 'ì„±ë³„ (male, female)';
COMMENT ON COLUMN users.nickname IS 'ì¹´ì¹´ì˜¤ ë‹‰ë„¤ì„';

-- ============================================
-- 2. Workout Logs Table
-- ============================================
CREATE TABLE IF NOT EXISTS workout_logs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  date TEXT NOT NULL,
  raw_text TEXT NOT NULL,
  normalized_text TEXT,
  memo TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for workout_logs table
CREATE INDEX IF NOT EXISTS idx_workout_logs_user_id ON workout_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_workout_logs_date ON workout_logs(date);
CREATE INDEX IF NOT EXISTS idx_workout_logs_created_at ON workout_logs(created_at);

-- Comments
COMMENT ON TABLE workout_logs IS 'ìš´ë™ ê¸°ë¡ ë¡œê·¸';
COMMENT ON COLUMN workout_logs.user_id IS 'ì‚¬ìš©ì ID';
COMMENT ON COLUMN workout_logs.date IS 'ìš´ë™ ë‚ ì§œ (YYYY-MM-DD)';
COMMENT ON COLUMN workout_logs.raw_text IS 'ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì›ë³¸ í…ìŠ¤íŠ¸';
COMMENT ON COLUMN workout_logs.normalized_text IS 'ì •ê·œí™”ëœ í…ìŠ¤íŠ¸';
COMMENT ON COLUMN workout_logs.memo IS 'ë©”ëª¨';

-- ============================================
-- 3. Workouts Table
-- ============================================
CREATE TABLE IF NOT EXISTS workouts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  workout_log_id UUID NOT NULL REFERENCES workout_logs(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  type TEXT NOT NULL,
  sets INTEGER,
  reps INTEGER,
  weight_kg NUMERIC,
  duration_min INTEGER,
  note TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for workouts table
CREATE INDEX IF NOT EXISTS idx_workouts_log_id ON workouts(workout_log_id);
CREATE INDEX IF NOT EXISTS idx_workouts_name ON workouts(name);
CREATE INDEX IF NOT EXISTS idx_workouts_type ON workouts(type);

-- Comments
COMMENT ON TABLE workouts IS 'ê°œë³„ ìš´ë™ ìƒì„¸ ì •ë³´';
COMMENT ON COLUMN workouts.workout_log_id IS 'ìš´ë™ ê¸°ë¡ ë¡œê·¸ ID';
COMMENT ON COLUMN workouts.name IS 'ìš´ë™ ì´ë¦„';
COMMENT ON COLUMN workouts.type IS 'ìš´ë™ íƒ€ì…';
COMMENT ON COLUMN workouts.sets IS 'ì„¸íŠ¸ ìˆ˜';
COMMENT ON COLUMN workouts.reps IS 'ë°˜ë³µ íšŸìˆ˜';
COMMENT ON COLUMN workouts.weight_kg IS 'ë¬´ê²Œ (kg)';
COMMENT ON COLUMN workouts.duration_min IS 'ìš´ë™ ì‹œê°„ (ë¶„)';
COMMENT ON COLUMN workouts.note IS 'ìš´ë™ ë©”ëª¨';

-- ============================================
-- 4. User Profiles Table
-- ============================================
CREATE TABLE IF NOT EXISTS user_profiles (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  goals TEXT NOT NULL,
  raw_input TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id)
);

-- Index for user_profiles table
CREATE INDEX IF NOT EXISTS idx_user_profiles_user_id ON user_profiles(user_id);

-- Comments
COMMENT ON TABLE user_profiles IS 'ì‚¬ìš©ì ìš´ë™ ëª©í‘œ í”„ë¡œí•„';
COMMENT ON COLUMN user_profiles.user_id IS 'ì‚¬ìš©ì ID';
COMMENT ON COLUMN user_profiles.goals IS 'ìš´ë™ ëª©í‘œ';
COMMENT ON COLUMN user_profiles.raw_input IS 'ì‚¬ìš©ì ì›ë³¸ ì…ë ¥';

-- ============================================
-- 5. Triggers for auto-updating timestamps
-- ============================================

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for users table
DROP TRIGGER IF EXISTS update_users_updated_at ON users;
CREATE TRIGGER update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Trigger for workout_logs table
DROP TRIGGER IF EXISTS update_workout_logs_updated_at ON workout_logs;
CREATE TRIGGER update_workout_logs_updated_at
  BEFORE UPDATE ON workout_logs
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Trigger for user_profiles table
DROP TRIGGER IF EXISTS update_user_profiles_updated_at ON user_profiles;
CREATE TRIGGER update_user_profiles_updated_at
  BEFORE UPDATE ON user_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 6. Row Level Security (RLS) Policies
-- ============================================

-- Enable RLS on all tables
ALTER TABLE workout_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE workouts ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Workout Logs Policies
CREATE POLICY "Users can view their own workout logs"
  ON workout_logs FOR SELECT
  USING (user_id = auth.uid());

CREATE POLICY "Users can insert their own workout logs"
  ON workout_logs FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can update their own workout logs"
  ON workout_logs FOR UPDATE
  USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can delete their own workout logs"
  ON workout_logs FOR DELETE
  USING (user_id = auth.uid());

-- Workouts Policies
CREATE POLICY "Users can view their own workouts"
  ON workouts FOR SELECT
  USING (workout_log_id IN (
    SELECT id FROM workout_logs WHERE user_id = auth.uid()
  ));

CREATE POLICY "Users can insert their own workouts"
  ON workouts FOR INSERT
  WITH CHECK (workout_log_id IN (
    SELECT id FROM workout_logs WHERE user_id = auth.uid()
  ));

CREATE POLICY "Users can update their own workouts"
  ON workouts FOR UPDATE
  USING (workout_log_id IN (
    SELECT id FROM workout_logs WHERE user_id = auth.uid()
  ));

CREATE POLICY "Users can delete their own workouts"
  ON workouts FOR DELETE
  USING (workout_log_id IN (
    SELECT id FROM workout_logs WHERE user_id = auth.uid()
  ));

-- User Profiles Policies
CREATE POLICY "Users can view their own profile"
  ON user_profiles FOR SELECT
  USING (user_id = auth.uid());

CREATE POLICY "Users can insert their own profile"
  ON user_profiles FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can update their own profile"
  ON user_profiles FOR UPDATE
  USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can delete their own profile"
  ON user_profiles FOR DELETE
  USING (user_id = auth.uid());

-- ============================================
-- 7. Clubs System Tables (Phase 1)
-- ============================================

-- Clubs Table
CREATE TABLE IF NOT EXISTS clubs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  is_public BOOLEAN DEFAULT false,
  invite_code UUID DEFAULT gen_random_uuid() UNIQUE NOT NULL,
  owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for clubs table
CREATE INDEX IF NOT EXISTS idx_clubs_owner_id ON clubs(owner_id);
CREATE INDEX IF NOT EXISTS idx_clubs_invite_code ON clubs(invite_code);
CREATE INDEX IF NOT EXISTS idx_clubs_is_public ON clubs(is_public) WHERE is_public = true;

-- Comments
COMMENT ON TABLE clubs IS 'í´ëŸ½ (ìš´ë™ ê·¸ë£¹)';
COMMENT ON COLUMN clubs.name IS 'í´ëŸ½ ì´ë¦„';
COMMENT ON COLUMN clubs.description IS 'í´ëŸ½ ì„¤ëª…';
COMMENT ON COLUMN clubs.is_public IS 'ê³µê°œ í´ëŸ½ ì—¬ë¶€ (true: ê²€ìƒ‰ ê°€ëŠ¥, false: ì´ˆëŒ€ ë§í¬ë§Œ)';
COMMENT ON COLUMN clubs.invite_code IS 'ì´ˆëŒ€ ë§í¬ìš© UUID (ì˜ˆ: /join/{invite_code})';
COMMENT ON COLUMN clubs.owner_id IS 'í´ëŸ½ ì†Œìœ ì ID';

-- Club Members Table (N:M relationship)
CREATE TABLE IF NOT EXISTS club_members (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(club_id, user_id)
);

-- Indexes for club_members table
CREATE INDEX IF NOT EXISTS idx_club_members_club_id ON club_members(club_id);
CREATE INDEX IF NOT EXISTS idx_club_members_user_id ON club_members(user_id);
CREATE INDEX IF NOT EXISTS idx_club_members_role ON club_members(role);

-- Comments
COMMENT ON TABLE club_members IS 'í´ëŸ½ ë©¤ë²„ì‹­';
COMMENT ON COLUMN club_members.club_id IS 'í´ëŸ½ ID';
COMMENT ON COLUMN club_members.user_id IS 'ì‚¬ìš©ì ID';
COMMENT ON COLUMN club_members.role IS 'ì—­í•  (owner: ì†Œìœ ì, admin: ê´€ë¦¬ì, member: ì¼ë°˜ ë©¤ë²„)';

-- Club Feeds Table (shared workout logs)
CREATE TABLE IF NOT EXISTS club_feeds (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  workout_log_id UUID NOT NULL REFERENCES workout_logs(id) ON DELETE CASCADE,
  shared_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(club_id, workout_log_id)
);

-- Indexes for club_feeds table
CREATE INDEX IF NOT EXISTS idx_club_feeds_club_id ON club_feeds(club_id);
CREATE INDEX IF NOT EXISTS idx_club_feeds_user_id ON club_feeds(user_id);
CREATE INDEX IF NOT EXISTS idx_club_feeds_workout_log_id ON club_feeds(workout_log_id);
CREATE INDEX IF NOT EXISTS idx_club_feeds_shared_at ON club_feeds(shared_at DESC);

-- Comments
COMMENT ON TABLE club_feeds IS 'í´ëŸ½ì— ê³µìœ ëœ ìš´ë™ ê¸°ë¡ í”¼ë“œ';
COMMENT ON COLUMN club_feeds.club_id IS 'í´ëŸ½ ID';
COMMENT ON COLUMN club_feeds.user_id IS 'ê³µìœ í•œ ì‚¬ìš©ì ID';
COMMENT ON COLUMN club_feeds.workout_log_id IS 'ê³µìœ ëœ ìš´ë™ ê¸°ë¡ ID';

-- ============================================
-- 8. Challenges System Tables (Phase 2)
-- ============================================

-- Club Challenges Table
CREATE TABLE IF NOT EXISTS club_challenges (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  club_id UUID NOT NULL REFERENCES clubs(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  challenge_type TEXT NOT NULL DEFAULT 'total_workouts' CHECK (
    challenge_type IN ('total_workouts', 'total_volume', 'total_duration', 'total_distance')
  ),
  target_value INTEGER NOT NULL,
  current_value INTEGER DEFAULT 0,
  start_date TEXT NOT NULL,
  end_date TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'completed', 'failed')),
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for club_challenges table
CREATE INDEX IF NOT EXISTS idx_club_challenges_club_id ON club_challenges(club_id);
CREATE INDEX IF NOT EXISTS idx_club_challenges_status ON club_challenges(status);
CREATE INDEX IF NOT EXISTS idx_club_challenges_end_date ON club_challenges(end_date);

-- Comments
COMMENT ON TABLE club_challenges IS 'í´ëŸ½ í•©ì‚° ì±Œë¦°ì§€ (ë³´ìŠ¤ ë ˆì´ë“œ ì»¨ì…‰)';
COMMENT ON COLUMN club_challenges.club_id IS 'í´ëŸ½ ID';
COMMENT ON COLUMN club_challenges.title IS 'ì±Œë¦°ì§€ ì œëª©';
COMMENT ON COLUMN club_challenges.challenge_type IS 'ì±Œë¦°ì§€ íƒ€ì… (total_workouts: ì´ ìš´ë™ ìˆ˜, total_volume: ì´ ë³¼ë¥¨, total_duration: ì´ ì‹œê°„, total_distance: ì´ ê±°ë¦¬)';
COMMENT ON COLUMN club_challenges.target_value IS 'ëª©í‘œ ê°’ (ì˜ˆ: 1000íšŒ, 50000kg, 3000ë¶„)';
COMMENT ON COLUMN club_challenges.current_value IS 'í˜„ì¬ ë‹¬ì„± ê°’';
COMMENT ON COLUMN club_challenges.start_date IS 'ì‹œì‘ì¼ (YYYY-MM-DD)';
COMMENT ON COLUMN club_challenges.end_date IS 'ì¢…ë£Œì¼ (YYYY-MM-DD)';
COMMENT ON COLUMN club_challenges.status IS 'ìƒíƒœ (active: ì§„í–‰ ì¤‘, completed: ì™„ë£Œ, failed: ì‹¤íŒ¨)';

-- Challenge Contributions Table
CREATE TABLE IF NOT EXISTS challenge_contributions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  challenge_id UUID NOT NULL REFERENCES club_challenges(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  workout_log_id UUID NOT NULL REFERENCES workout_logs(id) ON DELETE CASCADE,
  contribution_value INTEGER NOT NULL,
  contributed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(challenge_id, workout_log_id)
);

-- Indexes for challenge_contributions table
CREATE INDEX IF NOT EXISTS idx_challenge_contributions_challenge_id ON challenge_contributions(challenge_id);
CREATE INDEX IF NOT EXISTS idx_challenge_contributions_user_id ON challenge_contributions(user_id);

-- Comments
COMMENT ON TABLE challenge_contributions IS 'ì±Œë¦°ì§€ì— ëŒ€í•œ ê°œë³„ ê¸°ì—¬ (ìš´ë™ ê¸°ë¡)';
COMMENT ON COLUMN challenge_contributions.challenge_id IS 'ì±Œë¦°ì§€ ID';
COMMENT ON COLUMN challenge_contributions.user_id IS 'ê¸°ì—¬í•œ ì‚¬ìš©ì ID';
COMMENT ON COLUMN challenge_contributions.workout_log_id IS 'ê¸°ì—¬í•œ ìš´ë™ ê¸°ë¡ ID';
COMMENT ON COLUMN challenge_contributions.contribution_value IS 'ê¸°ì—¬ ê°’ (ìš´ë™ ìˆ˜, ë³¼ë¥¨, ì‹œê°„, ê±°ë¦¬ ë“±)';

-- ============================================
-- 9. Triggers for Clubs System
-- ============================================

-- Trigger for clubs table
DROP TRIGGER IF EXISTS update_clubs_updated_at ON clubs;
CREATE TRIGGER update_clubs_updated_at
  BEFORE UPDATE ON clubs
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Trigger for club_challenges table
DROP TRIGGER IF EXISTS update_club_challenges_updated_at ON club_challenges;
CREATE TRIGGER update_club_challenges_updated_at
  BEFORE UPDATE ON club_challenges
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 10. Row Level Security (RLS) Policies for Clubs
-- ============================================

-- Enable RLS on clubs tables
ALTER TABLE clubs ENABLE ROW LEVEL SECURITY;
ALTER TABLE club_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE club_feeds ENABLE ROW LEVEL SECURITY;
ALTER TABLE club_challenges ENABLE ROW LEVEL SECURITY;
ALTER TABLE challenge_contributions ENABLE ROW LEVEL SECURITY;

-- Clubs Policies
CREATE POLICY "Users can view public clubs or their own clubs"
  ON clubs FOR SELECT
  USING (is_public = true OR id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid()));

CREATE POLICY "Users can insert their own clubs"
  ON clubs FOR INSERT
  WITH CHECK (owner_id = auth.uid());

CREATE POLICY "Club owners can update their clubs"
  ON clubs FOR UPDATE
  USING (owner_id = auth.uid())
  WITH CHECK (owner_id = auth.uid());

CREATE POLICY "Club owners can delete their clubs"
  ON clubs FOR DELETE
  USING (owner_id = auth.uid());

-- Club Members Policies
CREATE POLICY "Members can view their club memberships"
  ON club_members FOR SELECT
  USING (user_id = auth.uid() OR club_id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid()));

CREATE POLICY "Users can join clubs"
  ON club_members FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Owners and admins can update memberships"
  ON club_members FOR UPDATE
  USING (club_id IN (
    SELECT club_id FROM club_members WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  ));

CREATE POLICY "Owners and admins can delete memberships"
  ON club_members FOR DELETE
  USING (club_id IN (
    SELECT club_id FROM club_members WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  ));

-- Club Feeds Policies
CREATE POLICY "Members can view club feeds"
  ON club_feeds FOR SELECT
  USING (club_id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid()));

CREATE POLICY "Members can share to club feeds"
  ON club_feeds FOR INSERT
  WITH CHECK (
    user_id = auth.uid() AND
    club_id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid())
  );

CREATE POLICY "Users can delete their own feeds"
  ON club_feeds FOR DELETE
  USING (user_id = auth.uid());

-- Club Challenges Policies
CREATE POLICY "Members can view club challenges"
  ON club_challenges FOR SELECT
  USING (club_id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid()));

CREATE POLICY "Owners and admins can create challenges"
  ON club_challenges FOR INSERT
  WITH CHECK (
    created_by = auth.uid() AND
    club_id IN (SELECT club_id FROM club_members WHERE user_id = auth.uid() AND role IN ('owner', 'admin'))
  );

CREATE POLICY "Owners and admins can update challenges"
  ON club_challenges FOR UPDATE
  USING (club_id IN (
    SELECT club_id FROM club_members WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  ));

CREATE POLICY "Owners and admins can delete challenges"
  ON club_challenges FOR DELETE
  USING (club_id IN (
    SELECT club_id FROM club_members WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  ));

-- Challenge Contributions Policies
CREATE POLICY "Members can view contributions"
  ON challenge_contributions FOR SELECT
  USING (challenge_id IN (
    SELECT id FROM club_challenges WHERE club_id IN (
      SELECT club_id FROM club_members WHERE user_id = auth.uid()
    )
  ));

CREATE POLICY "Members can contribute"
  ON challenge_contributions FOR INSERT
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can delete their contributions"
  ON challenge_contributions FOR DELETE
  USING (user_id = auth.uid());

-- ============================================
-- 11. Helper Functions
-- ============================================

-- Function to increment challenge current_value
CREATE OR REPLACE FUNCTION increment_challenge_value(
  p_challenge_id UUID,
  p_increment INTEGER
)
RETURNS void AS $$
BEGIN
  UPDATE club_challenges
  SET current_value = current_value + p_increment,
      updated_at = NOW()
  WHERE id = p_challenge_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- 12. Sample Data (Optional)
-- ============================================

-- Insert test user (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í›„ ì´ ì‚¬ìš©ìëŠ” ì‚­ì œ ê°€ëŠ¥)
-- INSERT INTO users (username, display_name, email, provider)
-- VALUES ('tester01', 'í…ŒìŠ¤í„°', 'test@example.com', 'local')
-- ON CONFLICT (username) DO NOTHING;
</file>

<file path="docs/database/type_specific_metrics_migration.sql">
-- Type-Specific Metrics Migration
-- "ë§Œêµ­ê³µí†µ ì ìˆ˜" ëŒ€ì‹  Typeë³„ ì „ìš© ë¹„êµ ì§€í‘œ ì‚¬ìš©
--
-- ì² í•™:
-- - ì¹´ë””ì˜¤ëŠ” ì¹´ë””ì˜¤ë¼ë¦¬ (adjusted_dist_km)
-- - ê·¼ë ¥ì€ ê·¼ë ¥ë¼ë¦¬ (volume_kg)
-- - ìŠ¤ë…¸ë³´ë“œëŠ” ìŠ¤ë…¸ë³´ë“œë¼ë¦¬ (run_count)
--
-- ì‘ì„±ì¼: 2026-01-20

-- ============================================
-- 1. workouts í…Œì´ë¸”ì— ìƒˆë¡œìš´ ì»¬ëŸ¼ ì¶”ê°€
-- ============================================

-- ê¸°ë³¸ ìœ ì‚°ì†Œ í•„ë“œ (ì—†ìœ¼ë©´ ì¶”ê°€)
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS distance_km NUMERIC; -- ê±°ë¦¬ (km)

ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS pace TEXT; -- í˜ì´ìŠ¤ ("5:30" = 5ë¶„ 30ì´ˆ/km)

-- Target ë¶€ìœ„ (ê·¼ë ¥ ìš´ë™ ìƒì„¸ ë¶„ë¥˜)
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS target TEXT DEFAULT 'none' CHECK (
  target IN ('upper', 'lower', 'core', 'full', 'none')
);

-- ìœ ì‚°ì†Œ ìƒì„¸ ì •ë³´
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS speed_kph NUMERIC; -- ì†ë„ (km/h)

ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS incline_percent NUMERIC; -- ê²½ì‚¬ë„ (%)

ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS resistance_level NUMERIC; -- ì €í•­ ë ˆë²¨ (ì‚¬ì´í´/ë¡œì‰)

-- ğŸƒ ì¹´ë””ì˜¤ ì „ìš© ì§€í‘œ
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS adjusted_dist_km NUMERIC; -- í‰ì§€ í™˜ì‚° ê±°ë¦¬ (ì¸í´ë¼ì¸ ë³´ì •)

-- ğŸ‹ï¸ ê·¼ë ¥ ì „ìš© ì§€í‘œ
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS volume_kg NUMERIC; -- ì´ ë³¼ë¥¨ (ë¬´ê²Œ * ì„¸íŠ¸ * íšŸìˆ˜)

-- ğŸ‚ ìŠ¤ë…¸ë³´ë“œ/Skill ì „ìš© ì§€í‘œ
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS run_count INTEGER; -- ëŸ° ìˆ˜ / ì‹œë„ íšŸìˆ˜

-- ============================================
-- 2. ì¸ë±ìŠ¤ ì¶”ê°€ (ë¦¬ë”ë³´ë“œ ì¿¼ë¦¬ ì„±ëŠ¥ í–¥ìƒ)
-- ============================================

CREATE INDEX IF NOT EXISTS idx_workouts_target ON workouts(target);
CREATE INDEX IF NOT EXISTS idx_workouts_adjusted_dist ON workouts(adjusted_dist_km);
CREATE INDEX IF NOT EXISTS idx_workouts_volume ON workouts(volume_kg);
CREATE INDEX IF NOT EXISTS idx_workouts_run_count ON workouts(run_count);

-- ============================================
-- 3. ì½”ë©˜íŠ¸ ì¶”ê°€
-- ============================================

COMMENT ON COLUMN workouts.distance_km IS 'ê±°ë¦¬ (km, ìœ ì‚°ì†Œ ìš´ë™)';
COMMENT ON COLUMN workouts.pace IS 'í˜ì´ìŠ¤ (ì˜ˆ: "5:30" = 5ë¶„ 30ì´ˆ/km)';
COMMENT ON COLUMN workouts.target IS 'íƒ€ê²Ÿ ë¶€ìœ„ (upper: ìƒì²´, lower: í•˜ì²´, core: ì½”ì–´, full: ì „ì‹ , none: ë¯¸ì§€ì •)';
COMMENT ON COLUMN workouts.speed_kph IS 'ì†ë„ (km/h, ìœ ì‚°ì†Œ ìš´ë™)';
COMMENT ON COLUMN workouts.incline_percent IS 'ê²½ì‚¬ë„ (%, íŠ¸ë ˆë“œë°€/ëŸ¬ë‹)';
COMMENT ON COLUMN workouts.resistance_level IS 'ì €í•­ ë ˆë²¨ (ì‚¬ì´í´/ë¡œì‰ ë“±)';
COMMENT ON COLUMN workouts.adjusted_dist_km IS '[ì¹´ë””ì˜¤ ë­í‚¹ìš©] í‰ì§€ í™˜ì‚° ê±°ë¦¬ = ê±°ë¦¬ + (ê±°ë¦¬ Ã— ì¸í´ë¼ì¸% Ã— 0.1)';
COMMENT ON COLUMN workouts.volume_kg IS '[ê·¼ë ¥ ë­í‚¹ìš©] ì´ ë³¼ë¥¨ = ë¬´ê²Œ(kg) Ã— ì„¸íŠ¸ Ã— íšŸìˆ˜';
COMMENT ON COLUMN workouts.run_count IS '[ìŠ¤ë…¸ë³´ë“œ/ìŠ¤í‚¬ ë­í‚¹ìš©] ëŸ° ìˆ˜ / ì‹œë„ íšŸìˆ˜';

-- ============================================
-- 4. ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
-- ============================================

-- 4-1. Target ìë™ íƒœê¹… (ê·¼ë ¥ ìš´ë™ë§Œ)
-- Core ìš´ë™
UPDATE workouts
SET target = 'core'
WHERE type = 'strength'
  AND (
    name ~* '(í”Œë­í¬|í¬ëŸ°ì¹˜|ë ˆê·¸ë ˆì´ì¦ˆ|ë°ë“œë²„ê·¸|íí„°ì¹˜|ì‹œí‹°ë“œ ë‹ˆì—…|ëŸ¬ì‹œì•ˆ íŠ¸ìœ„ìŠ¤íŠ¸|ab|ë³µê·¼)'
  )
  AND target = 'none';

-- Upper ìš´ë™
UPDATE workouts
SET target = 'upper'
WHERE type = 'strength'
  AND (
    name ~* '(ë²¤ì¹˜|í”„ë ˆìŠ¤|í’€ì—…|ì¹œì—…|í‘¸ì‰¬ì—…|ë¤ë²¨|ìˆ„ë”|ë ˆí„°ëŸ´|ë°”ë²¨ë¡œìš°|ë«í’€|ë”¥ìŠ¤|ì²´ìŠ¤íŠ¸|ìƒì²´)'
  )
  AND target = 'none';

-- Lower ìš´ë™
UPDATE workouts
SET target = 'lower'
WHERE type = 'strength'
  AND (
    name ~* '(ìŠ¤ì¿¼íŠ¸|ë°ë“œë¦¬í”„íŠ¸|ë ˆê·¸í”„ë ˆìŠ¤|ë ˆê·¸ì»¬|ë ˆê·¸ìµìŠ¤í…ì…˜|ëŸ°ì§€|ì¹¼í”„|í•˜ì²´)'
  )
  AND target = 'none';

-- Full ìš´ë™
UPDATE workouts
SET target = 'full'
WHERE type = 'strength'
  AND (
    name ~* '(ë²„í”¼|í´ë¦°|ìŠ¤ë‚´ì¹˜|ì¼€í‹€ë²¨|ìŠ¤ìœ™|ì „ì‹ )'
  )
  AND target = 'none';

-- 4-2. ğŸ‹ï¸ ê·¼ë ¥: ì´ ë³¼ë¥¨ ê³„ì‚°
UPDATE workouts
SET volume_kg = COALESCE(weight_kg, 0) * COALESCE(sets, 0) * COALESCE(reps, 0)
WHERE type = 'strength'
  AND weight_kg IS NOT NULL
  AND sets IS NOT NULL
  AND reps IS NOT NULL;

-- 4-3. ğŸƒ ì¹´ë””ì˜¤: í‰ì§€ í™˜ì‚° ê±°ë¦¬ ê³„ì‚°
-- ê³µì‹: Distance + (Distance Ã— Incline% Ã— 0.1)
UPDATE workouts
SET adjusted_dist_km =
  distance_km + (distance_km * COALESCE(incline_percent, 0) * 0.1)
WHERE type = 'cardio'
  AND distance_km IS NOT NULL;

-- ê±°ë¦¬ê°€ ì—†ê³  ì‹œê°„ë§Œ ìˆëŠ” ê²½ìš°: ëŒ€ëµì  í™˜ì‚° (1ì‹œê°„ = 10km ê¸°ì¤€)
UPDATE workouts
SET adjusted_dist_km = (duration_min / 60.0) * 10
WHERE type = 'cardio'
  AND distance_km IS NULL
  AND duration_min IS NOT NULL
  AND adjusted_dist_km IS NULL;

-- 4-4. ğŸ‚ ìŠ¤ë…¸ë³´ë“œ/Skill: repsë¥¼ run_countë¡œ ë³µì‚¬
UPDATE workouts
SET run_count = reps
WHERE (type = 'skill' OR category = 'snowboard')
  AND reps IS NOT NULL;

-- ============================================
-- 5. ê¸°ì¡´ effort_score, primary_metric_value ì»¬ëŸ¼ ì œê±° (ìˆë‹¤ë©´)
-- ============================================

-- ë§Œì•½ ì´ì „ì— ìƒì„±í–ˆë˜ ì»¬ëŸ¼ì´ ìˆë‹¤ë©´ ì‚­ì œ
ALTER TABLE workouts DROP COLUMN IF EXISTS effort_score;
ALTER TABLE workouts DROP COLUMN IF EXISTS primary_metric_value;

-- ============================================
-- 6. í™•ì¸ ì¿¼ë¦¬
-- ============================================

-- 6-1. Target ë¶„í¬ í™•ì¸
SELECT
  target,
  COUNT(*) as count,
  ARRAY_AGG(DISTINCT name ORDER BY name) as sample_names
FROM workouts
WHERE type = 'strength'
GROUP BY target
ORDER BY count DESC;

-- 6-2. ì¹´ë””ì˜¤ í™˜ì‚° ê±°ë¦¬ ìƒìœ„ 10
SELECT
  name,
  distance_km as original_dist,
  incline_percent,
  adjusted_dist_km,
  created_at
FROM workouts
WHERE type = 'cardio' AND adjusted_dist_km IS NOT NULL
ORDER BY adjusted_dist_km DESC
LIMIT 10;

-- 6-3. ê·¼ë ¥ ë³¼ë¥¨ ìƒìœ„ 10
SELECT
  name,
  weight_kg,
  sets,
  reps,
  volume_kg,
  created_at
FROM workouts
WHERE type = 'strength' AND volume_kg IS NOT NULL
ORDER BY volume_kg DESC
LIMIT 10;

-- 6-4. ìŠ¤ë…¸ë³´ë“œ ëŸ° ìˆ˜ ìƒìœ„ 10
SELECT
  name,
  run_count,
  duration_min,
  created_at
FROM workouts
WHERE (category = 'snowboard' OR type = 'skill') AND run_count IS NOT NULL
ORDER BY run_count DESC
LIMIT 10;

-- 6-5. í†µê³„ ìš”ì•½
SELECT
  'Total workouts' as metric,
  COUNT(*) as value
FROM workouts
UNION ALL
SELECT
  'Strength with volume' as metric,
  COUNT(*) as value
FROM workouts
WHERE volume_kg IS NOT NULL
UNION ALL
SELECT
  'Cardio with adjusted distance' as metric,
  COUNT(*) as value
FROM workouts
WHERE adjusted_dist_km IS NOT NULL
UNION ALL
SELECT
  'Skill with run count' as metric,
  COUNT(*) as value
FROM workouts
WHERE run_count IS NOT NULL;
</file>

<file path="docs/database/xp_system_migration.sql">
-- XP System & Enhanced Workout Tracking Migration
-- Target ë¶€ìœ„, ìœ ì‚°ì†Œ ìƒì„¸, XP ì ìˆ˜ ì¶”ê°€
--
-- ì‘ì„±ì¼: 2026-01-20

-- ============================================
-- 1. workouts í…Œì´ë¸”ì— ìƒˆë¡œìš´ ì»¬ëŸ¼ ì¶”ê°€
-- ============================================

-- Target ë¶€ìœ„ (ê·¼ë ¥ ìš´ë™ ìƒì„¸ ë¶„ë¥˜)
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS target TEXT DEFAULT 'none' CHECK (
  target IN ('upper', 'lower', 'core', 'full', 'none')
);

-- ìœ ì‚°ì†Œ ìƒì„¸ ì •ë³´
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS speed_kph NUMERIC; -- ì†ë„ (km/h)

ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS incline_percent NUMERIC; -- ê²½ì‚¬ë„ (%)

ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS resistance_level NUMERIC; -- ì €í•­ ë ˆë²¨

-- XP ì‹œìŠ¤í…œ
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS primary_metric_value NUMERIC; -- ì¢…ëª©ë³„ ëŒ€í‘œ ê°’

ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS effort_score NUMERIC; -- í†µí•© ì ìˆ˜ (XP)

-- ============================================
-- 2. ì¸ë±ìŠ¤ ì¶”ê°€ (ì¿¼ë¦¬ ì„±ëŠ¥ í–¥ìƒ)
-- ============================================

CREATE INDEX IF NOT EXISTS idx_workouts_target ON workouts(target);
CREATE INDEX IF NOT EXISTS idx_workouts_effort_score ON workouts(effort_score);

-- ============================================
-- 3. ì½”ë©˜íŠ¸ ì¶”ê°€
-- ============================================

COMMENT ON COLUMN workouts.target IS 'íƒ€ê²Ÿ ë¶€ìœ„ (upper: ìƒì²´, lower: í•˜ì²´, core: ì½”ì–´, full: ì „ì‹ , none: ë¯¸ì§€ì •)';
COMMENT ON COLUMN workouts.speed_kph IS 'ì†ë„ (km/h, ìœ ì‚°ì†Œ ìš´ë™)';
COMMENT ON COLUMN workouts.incline_percent IS 'ê²½ì‚¬ë„ (%, íŠ¸ë ˆë“œë°€/ëŸ¬ë‹)';
COMMENT ON COLUMN workouts.resistance_level IS 'ì €í•­ ë ˆë²¨ (ì‚¬ì´í´/ë¡œì‰ ë“±)';
COMMENT ON COLUMN workouts.primary_metric_value IS 'ì¢…ëª©ë³„ ëŒ€í‘œ ê°’ (ë³¼ë¥¨, ê±°ë¦¬ ë“±)';
COMMENT ON COLUMN workouts.effort_score IS 'í†µí•© ì ìˆ˜ (XP) - ìš´ë™ ê°•ë„ ë¹„êµìš©';

-- ============================================
-- 4. ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
-- ============================================

-- Core ìš´ë™ ìë™ íƒœê¹… (ì´ë¦„ ê¸°ë°˜)
UPDATE workouts
SET target = 'core'
WHERE type = 'strength'
  AND (
    name ~* '(í”Œë­í¬|í¬ëŸ°ì¹˜|ë ˆê·¸ë ˆì´ì¦ˆ|ë°ë“œë²„ê·¸|íí„°ì¹˜|ì‹œí‹°ë“œ ë‹ˆì—…|ëŸ¬ì‹œì•ˆ íŠ¸ìœ„ìŠ¤íŠ¸)'
  )
  AND target = 'none';

-- Upper ìš´ë™ ìë™ íƒœê¹…
UPDATE workouts
SET target = 'upper'
WHERE type = 'strength'
  AND (
    name ~* '(ë²¤ì¹˜|í”„ë ˆìŠ¤|í’€ì—…|ì¹œì—…|í‘¸ì‰¬ì—…|ë¤ë²¨|ìˆ„ë”|ë ˆí„°ëŸ´|ë°”ë²¨ë¡œìš°|ë«í’€)'
  )
  AND target = 'none';

-- Lower ìš´ë™ ìë™ íƒœê¹…
UPDATE workouts
SET target = 'lower'
WHERE type = 'strength'
  AND (
    name ~* '(ìŠ¤ì¿¼íŠ¸|ë°ë“œë¦¬í”„íŠ¸|ë ˆê·¸í”„ë ˆìŠ¤|ë ˆê·¸ì»¬|ë ˆê·¸ìµìŠ¤í…ì…˜|ëŸ°ì§€|ì¹¼í”„)'
  )
  AND target = 'none';

-- Full ìš´ë™ ìë™ íƒœê¹…
UPDATE workouts
SET target = 'full'
WHERE type = 'strength'
  AND (
    name ~* '(ë²„í”¼|í´ë¦°|ìŠ¤ë‚´ì¹˜|ì¼€í‹€ë²¨|ìŠ¤ìœ™)'
  )
  AND target = 'none';

-- ============================================
-- 5. XP ì ìˆ˜ ê³„ì‚° (ì„ì‹œ - ì¶”í›„ ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬)
-- ============================================

-- Strength: Total Volume / 100
UPDATE workouts
SET
  primary_metric_value = COALESCE(weight_kg, 0) * COALESCE(sets, 0) * COALESCE(reps, 0),
  effort_score = (COALESCE(weight_kg, 0) * COALESCE(sets, 0) * COALESCE(reps, 0)) / 100
WHERE type = 'strength'
  AND weight_kg IS NOT NULL
  AND sets IS NOT NULL
  AND reps IS NOT NULL;

-- Cardio: Distance (with incline adjustment)
UPDATE workouts
SET
  primary_metric_value = distance_km,
  effort_score = distance_km + (distance_km * COALESCE(incline_percent, 0) * 0.1)
WHERE type = 'cardio'
  AND distance_km IS NOT NULL;

-- Cardio: Time-based (when no distance)
UPDATE workouts
SET
  primary_metric_value = duration_min,
  effort_score = duration_min * 0.5
WHERE type = 'cardio'
  AND distance_km IS NULL
  AND duration_min IS NOT NULL;

-- ============================================
-- 6. í™•ì¸ ì¿¼ë¦¬
-- ============================================

-- Target ë¶„í¬ í™•ì¸
SELECT
  target,
  COUNT(*) as count,
  ARRAY_AGG(DISTINCT name) as sample_names
FROM workouts
WHERE type = 'strength'
GROUP BY target
ORDER BY count DESC;

-- XP ì ìˆ˜ ìƒìœ„ 10ê°œ ìš´ë™
SELECT
  name,
  type,
  target,
  primary_metric_value,
  effort_score,
  created_at
FROM workouts
WHERE effort_score IS NOT NULL
ORDER BY effort_score DESC
LIMIT 10;

-- í†µê³„ ìš”ì•½
SELECT
  'Total workouts' as metric,
  COUNT(*) as value
FROM workouts
UNION ALL
SELECT
  'Workouts with target' as metric,
  COUNT(*) as value
FROM workouts
WHERE target != 'none'
UNION ALL
SELECT
  'Workouts with XP' as metric,
  COUNT(*) as value
FROM workouts
WHERE effort_score IS NOT NULL;
</file>

<file path="docs/database/zero_copy_view_migration.sql">
-- Zero-Copy View Architecture Migration
-- "Push" ë°©ì‹(club_feeds ë³µì œ)ì—ì„œ "Pull" ë°©ì‹(RLS ê¸°ë°˜ ì¡°íšŒ)ìœ¼ë¡œ ì „í™˜
--
-- í•µì‹¬ ê°œë…:
-- - club_feeds í…Œì´ë¸”ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ , workout_logsë¥¼ ì§ì ‘ ì¡°íšŒ
-- - is_private í•„ë“œë¡œ ê³µê°œ/ë¹„ê³µê°œ ì œì–´
-- - RLSë¡œ ê°™ì€ í´ëŸ½ ë©¤ë²„ì˜ ê³µê°œ ê¸°ë¡ë§Œ ì¡°íšŒ ê°€ëŠ¥
--
-- ì‘ì„±ì¼: 2026-01-20

-- ============================================
-- 1. workout_logs í…Œì´ë¸”ì— is_private í•„ë“œ ì¶”ê°€
-- ============================================

-- is_private í•„ë“œ ì¶”ê°€ (ê¸°ë³¸ê°’: false = ê³µê°œ)
ALTER TABLE workout_logs
ADD COLUMN IF NOT EXISTS is_private BOOLEAN DEFAULT false;

-- ì¸ë±ìŠ¤ ì¶”ê°€ (ê³µê°œ ë¡œê·¸ ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ)
CREATE INDEX IF NOT EXISTS idx_workout_logs_is_private ON workout_logs(is_private);

-- ì½”ë©˜íŠ¸
COMMENT ON COLUMN workout_logs.is_private IS 'ë¹„ê³µê°œ ì—¬ë¶€ (true: ë‚˜ë§Œ ë³´ê¸°, false: í´ëŸ½ ë©¤ë²„ì™€ ê³µìœ )';

-- ============================================
-- 2. workout_logs RLS ì •ì±… ì—…ë°ì´íŠ¸
-- ============================================

-- ê¸°ì¡´ SELECT ì •ì±… ì‚­ì œ
DROP POLICY IF EXISTS "Users can view their own workout logs" ON workout_logs;

-- ìƒˆë¡œìš´ SELECT ì •ì±… ìƒì„±
-- Policy 1: ë‚´ ê¸°ë¡ì€ í•­ìƒ ë³¼ ìˆ˜ ìˆìŒ (ê³µê°œ/ë¹„ê³µê°œ ë¬´ê´€)
CREATE POLICY "Users can view their own workout logs"
  ON workout_logs FOR SELECT
  USING (user_id = auth.uid());

-- Policy 2: ê°™ì€ í´ëŸ½ ë©¤ë²„ì˜ ê³µê°œ ê¸°ë¡ì€ ë³¼ ìˆ˜ ìˆìŒ
CREATE POLICY "Club members can view shared workout logs"
  ON workout_logs FOR SELECT
  USING (
    is_private = false -- ê³µê°œëœ ê¸°ë¡ë§Œ
    AND EXISTS (
      -- ë‚˜ì™€ ë¡œê·¸ ì‘ì„±ìê°€ ê°™ì€ í´ëŸ½ì— ì†Œì†ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
      SELECT 1
      FROM club_members AS my_club
      JOIN club_members AS their_club
        ON my_club.club_id = their_club.club_id
      WHERE my_club.user_id = auth.uid() -- ë‚˜
        AND their_club.user_id = workout_logs.user_id -- ë¡œê·¸ ì‘ì„±ì
    )
  );

-- ============================================
-- 3. workouts RLS ì •ì±… ì—…ë°ì´íŠ¸
-- ============================================

-- ê¸°ì¡´ SELECT ì •ì±… ì‚­ì œ
DROP POLICY IF EXISTS "Users can view their own workouts" ON workouts;

-- ìƒˆë¡œìš´ SELECT ì •ì±… ìƒì„±
-- Policy 1: ë‚´ ì›Œí¬ì•„ì›ƒì€ í•­ìƒ ë³¼ ìˆ˜ ìˆìŒ
CREATE POLICY "Users can view their own workouts"
  ON workouts FOR SELECT
  USING (workout_log_id IN (
    SELECT id FROM workout_logs WHERE user_id = auth.uid()
  ));

-- Policy 2: ê°™ì€ í´ëŸ½ ë©¤ë²„ì˜ ê³µê°œ ì›Œí¬ì•„ì›ƒì€ ë³¼ ìˆ˜ ìˆìŒ
CREATE POLICY "Club members can view shared workouts"
  ON workouts FOR SELECT
  USING (
    workout_log_id IN (
      SELECT id FROM workout_logs
      WHERE is_private = false
        AND EXISTS (
          SELECT 1
          FROM club_members AS my_club
          JOIN club_members AS their_club
            ON my_club.club_id = their_club.club_id
          WHERE my_club.user_id = auth.uid()
            AND their_club.user_id = workout_logs.user_id
        )
    )
  );

-- ============================================
-- 4. ê¸°ì¡´ ë°ì´í„° ì²˜ë¦¬
-- ============================================

-- ê¸°ì¡´ ëª¨ë“  ë¡œê·¸ë¥¼ ê³µê°œë¡œ ì„¤ì • (ê¸°ë³¸ê°’)
UPDATE workout_logs
SET is_private = false
WHERE is_private IS NULL;

-- ============================================
-- 5. club_feeds í…Œì´ë¸” (Deprecation Notice)
-- ============================================

-- club_feeds í…Œì´ë¸”ì€ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
-- í•˜ì§€ë§Œ ê¸°ì¡´ ë°ì´í„° ë³´ì¡´ì„ ìœ„í•´ í…Œì´ë¸”ì€ ìœ ì§€
-- ë‚˜ì¤‘ì— ì™„ì „íˆ ì‚­ì œí•  ìˆ˜ ìˆìŒ

COMMENT ON TABLE club_feeds IS '[DEPRECATED] ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ. Zero-Copy View Architectureë¡œ ì „í™˜ë¨. workout_logsë¥¼ ì§ì ‘ ì¡°íšŒí•˜ì„¸ìš”.';

-- ============================================
-- 6. í—¬í¼ ë·° (Optional)
-- ============================================

-- í´ëŸ½ë³„ ê³µê°œ ë¡œê·¸ ì¡°íšŒë¥¼ ìœ„í•œ ë·° (ì„±ëŠ¥ ìµœì í™” ì˜µì…˜)
CREATE OR REPLACE VIEW club_workout_logs AS
SELECT
  wl.*,
  cm.club_id,
  u.display_name AS user_display_name,
  u.profile_image AS user_profile_image
FROM workout_logs wl
JOIN users u ON wl.user_id = u.id
JOIN club_members cm ON wl.user_id = cm.user_id
WHERE wl.is_private = false;

COMMENT ON VIEW club_workout_logs IS 'í´ëŸ½ë³„ ê³µê°œ ì›Œí¬ì•„ì›ƒ ë¡œê·¸ ë·° (RLS ì ìš©ë¨)';

-- ============================================
-- 7. í™•ì¸ ì¿¼ë¦¬
-- ============================================

-- workout_logs ì»¬ëŸ¼ í™•ì¸
SELECT column_name, data_type, column_default, is_nullable
FROM information_schema.columns
WHERE table_name = 'workout_logs'
  AND column_name IN ('id', 'user_id', 'is_private')
ORDER BY ordinal_position;

-- RLS ì •ì±… í™•ì¸
SELECT schemaname, tablename, policyname, cmd, qual
FROM pg_policies
WHERE tablename IN ('workout_logs', 'workouts')
ORDER BY tablename, policyname;
</file>

<file path="docs/features/club_dashboard_data_structure.md">
# í´ëŸ½ ëŒ€ì‹œë³´ë“œ ë°ì´í„° êµ¬ì¡° ë° ì·¨í•© ë°©ì‹

## ğŸ“Š í˜„ì¬ êµ¬í˜„ ìƒíƒœ (2026-01-20)

í´ëŸ½ ëŒ€ì‹œë³´ë“œëŠ” **Zero-Copy View ì•„í‚¤í…ì²˜**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.
ë©¤ë²„ë“¤ì˜ `workout_logs` í…Œì´ë¸”ì„ RLS ì •ì±…ìœ¼ë¡œ ì§ì ‘ ì¡°íšŒí•˜ì—¬ ì‹¤ì‹œê°„ í†µê³„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

---

## 1. ë°ì´í„° ì†ŒìŠ¤

### í•¨ìˆ˜: `getClubMemberLogs(clubId: string)`
**ìœ„ì¹˜:** `src/storage/clubStorage.ts`

**ì¿¼ë¦¬ ë¡œì§:**
```typescript
// 1ë‹¨ê³„: í´ëŸ½ ë©¤ë²„ user_id ì¡°íšŒ
SELECT user_id FROM club_members WHERE club_id = clubId

// 2ë‹¨ê³„: ë©¤ë²„ë“¤ì˜ ê³µê°œ ìš´ë™ ë¡œê·¸ ì¡°íšŒ
SELECT
  id, user_id, date, raw_text, normalized_text, memo, is_private,
  workouts (
    id, name, category, type, target,
    sets, reps, weight_kg, duration_min, distance_km, pace,
    speed_kph, incline_percent, resistance_level,
    adjusted_dist_km, volume_kg, run_count, note
  ),
  users (display_name, profile_image)
FROM workout_logs
WHERE user_id IN (memberUserIds)
  AND is_private = false
ORDER BY created_at DESC
```

**ë°˜í™˜ ë°ì´í„° êµ¬ì¡°:**
```typescript
WorkoutLog[] = [
  {
    id: string;
    userId: string;
    userDisplayName: string;
    userProfileImage: string | null;
    date: string;  // YYYY-MM-DD
    rawText: string;
    normalizedText: string;
    memo: string | null;
    createdAt: number;
    isPrivate: boolean;
    workouts: Workout[];  // ê° ë¡œê·¸ì— ì—¬ëŸ¬ ìš´ë™ í¬í•¨
  }
]
```

---

## 2. í´ëŸ½ í†µê³„ (ClubStats ì»´í¬ë„ŒíŠ¸)

### ğŸ“ˆ í˜„ì¬ í‘œì‹œ ì§€í‘œ

| ì§€í‘œ | ê³„ì‚° ë°©ì‹ | ë°ì´í„° íƒ€ì… |
|------|----------|-----------|
| **ì´ ìš´ë™ ìˆ˜** | `members.reduce((sum, log) => sum + log.workouts.length, 0)` | `number` |
| **í™œì„± ë©¤ë²„** | `new Set(members.map(log => log.userId)).size` | `number` |
| **ì´ë²ˆ ì£¼ ìš´ë™** | ìµœê·¼ 7ì¼ ë¡œê·¸ì˜ ìš´ë™ ìˆ˜ í•©ê³„ | `number` |
| **ì´ ê¸°ë¡** | `members.length` (ë¡œê·¸ ì„¸ì…˜ ìˆ˜) | `number` |

### ğŸ“Š ì½”ë“œ êµ¬í˜„
```typescript
const ClubStats = ({ members }: { members: WorkoutLog[] }) => {
  // ì´ ìš´ë™ ìˆ˜ (ëª¨ë“  ë¡œê·¸ì˜ workouts ë°°ì—´ í•©ì‚°)
  const totalWorkouts = members.reduce((sum, log) => sum + log.workouts.length, 0);

  // í™œì„± ë©¤ë²„ (ì¤‘ë³µ ì œê±°)
  const activeMembers = new Set(members.map((log) => log.userId)).size;

  // ì´ ê¸°ë¡ (ì„¸ì…˜ ìˆ˜)
  const totalLogs = members.length;

  // ìµœê·¼ 7ì¼ í™œë™
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
  const recentLogs = members.filter((log) => new Date(log.createdAt) >= sevenDaysAgo);
  const weeklyWorkouts = recentLogs.reduce((sum, log) => sum + log.workouts.length, 0);

  return (
    <div className="stats-grid">
      <StatCard label="ì´ ìš´ë™ ìˆ˜" value={totalWorkouts} />
      <StatCard label="í™œì„± ë©¤ë²„" value={activeMembers + "ëª…"} />
      <StatCard label="ì´ë²ˆ ì£¼" value={weeklyWorkouts + " ìš´ë™"} />
      <StatCard label="ì´ ê¸°ë¡" value={totalLogs} />
    </div>
  );
};
```

---

## 3. ë¦¬ë”ë³´ë“œ (LeaderboardSection ì»´í¬ë„ŒíŠ¸)

### ğŸ† Typeë³„ ë…ë¦½ ë¦¬ê·¸

í´ëŸ½ ëŒ€ì‹œë³´ë“œëŠ” **3ê°œì˜ ë…ë¦½ ë¦¬ë”ë³´ë“œ**ë¥¼ ìš´ì˜í•©ë‹ˆë‹¤:

#### 3.1 ğŸƒ ìœ ì‚°ì†Œ í‚¹ (Cardio Leaderboard)
- **ì§€í‘œ:** `adjusted_dist_km` (í‰ì§€ í™˜ì‚° ê±°ë¦¬)
- **ê³„ì‚° ê³µì‹:** `ê±°ë¦¬(km) + (ê±°ë¦¬(km) Ã— ì¸í´ë¼ì¸(%) Ã— 0.1)`
- **í•„í„°:** `workout.type === 'cardio'`

#### 3.2 ğŸ‹ï¸ ìŠ¤íŠ¸ë ìŠ¤ í‚¹ (Strength Leaderboard)
- **ì§€í‘œ:** `volume_kg` (ì´ ë³¼ë¥¨)
- **ê³„ì‚° ê³µì‹:** `ë¬´ê²Œ(kg) Ã— ì„¸íŠ¸ Ã— íšŸìˆ˜`
- **í•„í„°:** `workout.type === 'strength'`

#### 3.3 ğŸ‚ ìŠ¬ë¡œí”„ í‚¹ (Snowboard/Skill Leaderboard)
- **ì§€í‘œ:** `run_count` (ëŸ° ìˆ˜)
- **ê³„ì‚° ê³µì‹:** `reps` (ì‹œë„ íšŸìˆ˜)
- **í•„í„°:** `workout.category === 'snowboard'`

### ğŸ“Š ë¦¬ë”ë³´ë“œ ì§‘ê³„ ë¡œì§

```typescript
const LeaderboardSection = ({ members, metricType }) => {
  // 1. ì‚¬ìš©ìë³„ ì§‘ê³„ Map ìƒì„±
  const userMetrics = new Map<string, UserMetric>();

  // 2. ëª¨ë“  ë¡œê·¸ë¥¼ ìˆœíšŒí•˜ë©° ì§‘ê³„
  members.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existingMetric = userMetrics.get(log.userId) || {
      userId: log.userId,
      displayName: log.userDisplayName,
      profileImage: log.userProfileImage || null,
      value: 0,
    };

    // 3. ê° ìš´ë™ì˜ Typeë³„ ì§€í‘œ í•©ì‚°
    log.workouts.forEach((workout) => {
      let value = 0;

      switch (metricType) {
        case 'cardio':
          if (workout.type === 'cardio' && workout.adjusted_dist_km) {
            value = workout.adjusted_dist_km;
          }
          break;
        case 'strength':
          if (workout.type === 'strength' && workout.volume_kg) {
            value = workout.volume_kg;
          }
          break;
        case 'snowboard':
          if (workout.category === 'snowboard' && workout.run_count) {
            value = workout.run_count;
          }
          break;
      }

      existingMetric.value += value;
    });

    userMetrics.set(log.userId, existingMetric);
  });

  // 4. ì •ë ¬ ë° ìƒìœ„ 10ëª… ì¶”ì¶œ
  const rankings = Array.from(userMetrics.values())
    .filter((m) => m.value > 0)
    .sort((a, b) => b.value - a.value)
    .slice(0, 10);

  return rankings;
};
```

### ğŸ¨ ìˆœìœ„ í‘œì‹œ
- ğŸ¥‡ 1ìœ„: ê¸ˆìƒ‰ (`#FFD700`)
- ğŸ¥ˆ 2ìœ„: ì€ìƒ‰ (`#C0C0C0`)
- ğŸ¥‰ 3ìœ„: ë™ìƒ‰ (`#CD7F32`)
- 4-10ìœ„: ê¸°ë³¸ ìƒ‰ìƒ

---

## 4. ë°ì´í„° íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ClubDetailPage                            â”‚
â”‚                                                             â”‚
â”‚  useEffect(() => {                                          â”‚
â”‚    if (tab === 'dashboard') {                               â”‚
â”‚      const logs = await getClubMemberLogs(clubId);  â”€â”€â”€â”€â”  â”‚
â”‚      setMemberLogs(logs);                                 â”‚  â”‚
â”‚    }                                                      â”‚  â”‚
â”‚  }, [tab, clubId]);                                       â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”˜
                                                            â”‚
                                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  getClubMemberLogs()                        â”‚
â”‚                                                             â”‚
â”‚  1. SELECT club_members WHERE club_id = X                  â”‚
â”‚  2. SELECT workout_logs                                     â”‚
â”‚       WHERE user_id IN (members)                            â”‚
â”‚       AND is_private = false                                â”‚
â”‚  3. JOIN workouts, users                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WorkoutLog[] (memberLogs)                      â”‚
â”‚                                                             â”‚
â”‚  [                                                          â”‚
â”‚    {                                                        â”‚
â”‚      userId: "user-123",                                    â”‚
â”‚      userDisplayName: "ê¹€ë¯¼ìˆ˜",                             â”‚
â”‚      workouts: [                                            â”‚
â”‚        {                                                    â”‚
â”‚          name: "íŠ¸ë ˆë“œë°€",                                   â”‚
â”‚          type: "cardio",                                    â”‚
â”‚          adjusted_dist_km: 10.5,  â† ì¸í´ë¼ì¸ ë³´ì • ì™„ë£Œ      â”‚
â”‚        },                                                   â”‚
â”‚        {                                                    â”‚
â”‚          name: "ìŠ¤ì¿¼íŠ¸",                                     â”‚
â”‚          type: "strength",                                  â”‚
â”‚          volume_kg: 2400,  â† ë¬´ê²Œ*ì„¸íŠ¸*íšŸìˆ˜ ê³„ì‚° ì™„ë£Œ       â”‚
â”‚        }                                                    â”‚
â”‚      ]                                                      â”‚
â”‚    },                                                       â”‚
â”‚    ...                                                      â”‚
â”‚  ]                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                        â”‚
                    â–¼                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ClubStats         â”‚  â”‚  LeaderboardSection â”‚
        â”‚                     â”‚  â”‚                     â”‚
        â”‚ - ì´ ìš´ë™ ìˆ˜         â”‚  â”‚ - ìœ ì‚°ì†Œ í‚¹ ğŸƒ       â”‚
        â”‚ - í™œì„± ë©¤ë²„          â”‚  â”‚ - ìŠ¤íŠ¸ë ìŠ¤ í‚¹ ğŸ‹ï¸    â”‚
        â”‚ - ì´ë²ˆ ì£¼ ìš´ë™       â”‚  â”‚ - ìŠ¬ë¡œí”„ í‚¹ ğŸ‚      â”‚
        â”‚ - ì´ ê¸°ë¡           â”‚  â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ì„±ëŠ¥ ìµœì í™”

### 5.1 Zero-Copy ì•„í‚¤í…ì²˜
- âœ… ë°ì´í„° ì¤‘ë³µ ì €ì¥ ì—†ìŒ (club_feeds í…Œì´ë¸” ë¯¸ì‚¬ìš©)
- âœ… Single Source of Truth (workout_logs)
- âœ… RLSë¡œ ë³´ì•ˆ ë³´ì¥

### 5.2 ì¸ë±ìŠ¤ í™œìš©
```sql
-- ë¦¬ë”ë³´ë“œ ì¿¼ë¦¬ ì„±ëŠ¥ í–¥ìƒ
CREATE INDEX idx_workouts_adjusted_dist ON workouts(adjusted_dist_km);
CREATE INDEX idx_workouts_volume ON workouts(volume_kg);
CREATE INDEX idx_workouts_run_count ON workouts(run_count);
```

### 5.3 í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì§‘ê³„
- ì„œë²„ì—ì„œ ì›ë³¸ ë°ì´í„° ì „ì†¡
- ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤ì‹œê°„ ì§‘ê³„ (Map ìë£Œêµ¬ì¡° í™œìš©)
- ë¶ˆí•„ìš”í•œ DB ì¿¼ë¦¬ ìµœì†Œí™”

---

## 6. í™•ì¥ ê°€ëŠ¥ì„±

### 6.1 ì¶”ê°€ ê°€ëŠ¥í•œ í†µê³„ ì§€í‘œ
- [ ] í‰ê·  ìš´ë™ ê°•ë„ (ë‚œì´ë„ í‰ê· )
- [ ] ì—°ì† ìš´ë™ ì¼ìˆ˜ (Streak)
- [ ] ì£¼ê°„ í™œë™ ê·¸ë˜í”„
- [ ] Typeë³„ ë¶„í¬ë„ (íŒŒì´ ì°¨íŠ¸)
- [ ] ì‹œê°„ëŒ€ë³„ í™œë™ íˆíŠ¸ë§µ
- [ ] ë©¤ë²„ë³„ ì„±ì¥ ì¶”ì´
- [ ] í´ëŸ½ ì „ì²´ ëª©í‘œ ë‹¬ì„±ë¥ 

### 6.2 ì¶”ê°€ ê°€ëŠ¥í•œ ë¦¬ë”ë³´ë“œ
- [ ] ğŸ¯ ì—°ì† ì¶œì„ì™• (Streak King)
- [ ] ğŸ’ ì˜¬ë¼ìš´ë” (ëª¨ë“  Type ê³¨ê³ ë£¨)
- [ ] âš¡ ê°•ë„ì™• (ë‚œì´ë„ í‰ê· )
- [ ] ğŸ“… ì£¼ë§ ì „ì‚¬ (ì£¼ë§ í™œë™)
- [ ] ğŸŒ… ìƒˆë²½ ë¶€ëŒ€ (ì˜¤ì „ 6ì‹œ ì „ ìš´ë™)

### 6.3 ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜ ìš”ì†Œ
- [ ] ë±ƒì§€ ì‹œìŠ¤í…œ (ì²« 100km, ë³¼ë¥¨ 10í†¤ ë“±)
- [ ] ë ˆë²¨ ì‹œìŠ¤í…œ (í´ëŸ½ ê²½í—˜ì¹˜)
- [ ] ë„ì „ ê³¼ì œ (Achievement)
- [ ] íƒ€ì´í‹€ íšë“ (ì›”ê°„ í‚¹ ìœ ì§€ ì‹œ)

---

## 7. ë°ì´í„° ì˜ˆì‹œ

### ì…ë ¥ ë°ì´í„° (getClubMemberLogs ë°˜í™˜ê°’)
```json
[
  {
    "id": "log-001",
    "userId": "user-123",
    "userDisplayName": "ê¹€ë¯¼ìˆ˜",
    "userProfileImage": "https://...",
    "date": "2026-01-20",
    "createdAt": 1737350400000,
    "workouts": [
      {
        "name": "íŠ¸ë ˆë“œë°€",
        "category": "gym",
        "type": "cardio",
        "distance_km": 5.0,
        "incline_percent": 10,
        "adjusted_dist_km": 10.0,
        "duration_min": 30
      },
      {
        "name": "ìŠ¤ì¿¼íŠ¸",
        "category": "gym",
        "type": "strength",
        "target": "lower",
        "weight_kg": 100,
        "sets": 5,
        "reps": 5,
        "volume_kg": 2500
      }
    ]
  }
]
```

### ì¶œë ¥ ë°ì´í„° (ë¦¬ë”ë³´ë“œ)
```json
{
  "cardio": [
    { "userId": "user-123", "displayName": "ê¹€ë¯¼ìˆ˜", "value": 45.5 },
    { "userId": "user-456", "displayName": "ì´ì˜í¬", "value": 38.2 }
  ],
  "strength": [
    { "userId": "user-123", "displayName": "ê¹€ë¯¼ìˆ˜", "value": 12500 },
    { "userId": "user-789", "displayName": "ë°•ì² ìˆ˜", "value": 8000 }
  ],
  "snowboard": [
    { "userId": "user-999", "displayName": "ìµœë³´ë”", "value": 25 }
  ]
}
```

---

## 8. ê°œì„  ì•„ì´ë””ì–´ ë¸Œë ˆì¸ìŠ¤í† ë° ê°€ì´ë“œ

í˜„ì¬ êµ¬ì¡°ì—ì„œ ê°œì„ í•  ìˆ˜ ìˆëŠ” ë°©í–¥:

1. **ì¬ë¯¸ ìš”ì†Œ ì¶”ê°€**
   - í˜„ì¬: ë‹¨ìˆœ ìˆ«ì ë‚˜ì—´
   - ê°œì„ : ìŠ¤í† ë¦¬í…”ë§, ë¹„ìœ , ì´ëª¨ì§€ í™œìš©

2. **ë¹„êµ ê°€ëŠ¥ì„±**
   - í˜„ì¬: ì ˆëŒ€ê°’ë§Œ í‘œì‹œ
   - ê°œì„ : ì§€ë‚œì£¼ ëŒ€ë¹„, í´ëŸ½ í‰ê·  ëŒ€ë¹„

3. **ì‹œê°í™”**
   - í˜„ì¬: í…ìŠ¤íŠ¸ ì¤‘ì‹¬
   - ê°œì„ : ì°¨íŠ¸, ê·¸ë˜í”„, í”„ë¡œê·¸ë ˆìŠ¤ ë°”

4. **ê°œì¸í™”**
   - í˜„ì¬: ì „ì²´ í†µê³„ë§Œ
   - ê°œì„ : "ë‚´ ìˆœìœ„", "ë‚´ ê¸°ì—¬ë„" í‘œì‹œ

5. **ì†Œì…œ ê¸°ëŠ¥**
   - í˜„ì¬: ì¡°ìš©í•œ ë¦¬ë”ë³´ë“œ
   - ê°œì„ : ì‘ì›, ëŒ“ê¸€, ë°˜ì‘

---

## 9. ê¸°ìˆ  ìŠ¤íƒ

- **í”„ë¡ íŠ¸ì—”ë“œ:** React + TypeScript
- **ìƒíƒœ ê´€ë¦¬:** useState (ë¡œì»¬)
- **ë°ì´í„° í˜ì¹­:** Supabase JS SDK
- **ìŠ¤íƒ€ì¼ë§:** Inline Styles + CSS Classes
- **ê³„ì‚° ë¡œì§:** `src/utils/calculateMetrics.ts`

---

**ë¬¸ì„œ ì‘ì„±ì¼:** 2026-01-20
**ì‘ì„±ì:** Claude Code
**ë²„ì „:** 1.0.0
</file>

<file path="docs/features/club_dashboard_widgets.md">
# Club Dashboard Widget System

## ê°œìš”

í´ëŸ½ ëŒ€ì‹œë³´ë“œëŠ” ìœ„ì ¯ ê¸°ë°˜ ì‹œìŠ¤í…œìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©°, í´ëŸ½ì¥/ê´€ë¦¬ìê°€ ìœ„ì ¯ì˜ ìˆœì„œì™€ í‘œì‹œ ì—¬ë¶€ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì´ ìœ„ì ¯ ìˆ˜**: 6ê°œ (ê¸°ë³¸ ìœ„ì ¯ 3ê°œ + ë¦¬ë”ë³´ë“œ ìœ„ì ¯ 3ê°œ)

---

## ìœ„ì ¯ ëª©ë¡

### 1. ğŸ“¡ Live Ticker (ì‹¤ì‹œê°„ í™œë™ í”¼ë“œ)

**ID**: `live_ticker`
**íƒ€ì…**: `live_ticker`
**ê¸°ë³¸ ìˆœì„œ**: 0 (ìµœìƒë‹¨)

#### ê¸°ëŠ¥
- í´ëŸ½ ë©¤ë²„ë“¤ì˜ ìµœê·¼ ìš´ë™ í™œë™ì„ ë‰´ìŠ¤ í‹°ì»¤ ìŠ¤íƒ€ì¼ë¡œ í‘œì‹œ
- ìµœëŒ€ 15ê°œ í•­ëª© í‘œì‹œ
- ê° í•­ëª©ì—ëŠ” ì•„ì´ì½˜, í™œë™ í…ìŠ¤íŠ¸, íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨

#### ë°ì´í„° ì†ŒìŠ¤
- `getClubMemberLogs(clubId)` - í´ëŸ½ ë©¤ë²„ë“¤ì˜ ê³µìœ ëœ ìš´ë™ ë¡œê·¸

#### í‘œì‹œ ì •ë³´
- ìš´ë™ ì¢…ë¥˜ ì•„ì´ì½˜ (ğŸ‹ï¸, ğŸƒ, ğŸ‚ ë“±)
- "[ìœ ì €ëª…]ë‹˜ì´ [ìš´ë™ëª…] ê¸°ë¡"
- ì‹œê°„ (HH:MM í˜•ì‹)

#### ì½”ë“œ ìœ„ì¹˜
- **ì»´í¬ë„ŒíŠ¸**: `src/pages/ClubDetail.tsx:344` (`LiveTicker`)
- **ë¡œì§**: `src/utils/dashboardLogic.ts` (`generateTickerItems`)

#### ìŠ¤íƒ€ì¼
- ë‹¤í¬ ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ (#1e293b â†’ #0f172a)
- ì¢Œì¸¡ ë³´ë¼ìƒ‰ ë³´ë”
- ìŠ¤í¬ë¡¤ ê°€ëŠ¥ (ìµœëŒ€ ë†’ì´ 200px)

---

### 2. ğŸ† Hall of Fame (ëª…ì˜ˆì˜ ì „ë‹¹) - Carousel

**ID**: `hall_of_fame`
**íƒ€ì…**: `hall_of_fame`
**ê¸°ë³¸ ìˆœì„œ**: 1

#### ê¸°ëŠ¥
- **Carousel(ìŠ¬ë¼ì´ë“œ)** í˜•íƒœë¡œ ì—¬ëŸ¬ ë©¤ë²„ì˜ ì„±ê³¼ë¥¼ ë™ì‹œì— í‘œì‹œ
- í•œ ìœ ì €ê°€ ì—¬ëŸ¬ ë°°ì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆìŒ (ìµœëŒ€ 6ê°œ)
- **Me-first Sorting**: ì ‘ì†í•œ ë³¸ì¸ì˜ ë°°ì§€ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ë§¨ ì•ì— ë°°ì¹˜
- Snap Scroll + Peekingìœ¼ë¡œ ì§ê´€ì ì¸ UX

#### 6ê°€ì§€ ë°°ì§€ ì‹œìŠ¤í…œ (ì£¼ê°„ ë°ì´í„° ê¸°ì¤€)

| ë°°ì§€ | ì•„ì´ì½˜ | íƒ€ì… | ì¡°ê±´ |
|------|--------|------|------|
| ì›Œì»¤í™€ë¦­ | ğŸ”¥ | effort (Yellow) | ì´ ìš´ë™ íšŸìˆ˜ 1ìœ„ |
| ë¯¸ë¼í´ ëª¨ë‹ | ğŸŒ… | time (Orange) | 04-08ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„ |
| ì˜¬ë¹¼ë¯¸ íŒŒìˆ˜ê¾¼ | ğŸ¦‰ | time (Orange) | 22-03ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„ |
| 3ëŒ€ 500 ê¿ˆë‚˜ë¬´ | ğŸ‹ï¸ | strength (Red) | ì´ ë³¼ë¥¨(kg) 1ìœ„ |
| ì§€ì¹  ì¤„ ëª¨ë¥´ëŠ” ì‹¬ì¥ | ğŸƒ | cardio (Blue) | í™˜ì‚° ê±°ë¦¬(km) 1ìœ„ |
| ì„¤ì›ì˜ ì§€ë°°ì | ğŸ‚ | consistency (Purple) | ìŠ¤ë…¸ë³´ë“œ ëŸ° ìˆ˜ 1ìœ„ |

#### ë°ì´í„° ì†ŒìŠ¤
- `getClubMemberLogs(clubId)` - ìµœê·¼ 7ì¼ í•„í„°ë§
- ë°°ì§€ ê³„ì‚°: `calculateHofBadges(logs, currentUserId)`

#### í‘œì‹œ ì •ë³´
- **Me ì¹´ë“œ** (ë³¸ì¸):
  - â­ ME ë±ƒì§€ (ì¢Œì¸¡ ìƒë‹¨)
  - ì§„í•œ ë°°ê²½ + ë‘êº¼ìš´ í…Œë‘ë¦¬(3px)
  - ê¸€ë¡œìš° íš¨ê³¼ (`0 0 20px ${color}44`)
  - ìµœìš°ì„  ë°°ì¹˜ (ë§¨ ì•)
- **Others ì¹´ë“œ**:
  - ì—°í•œ ë°°ê²½ + ì–‡ì€ í…Œë‘ë¦¬(2px)
  - ê¸€ë¡œìš° ì—†ìŒ
- ê³µí†µ: í”„ë¡œí•„, ìœ ì € ì´ë¦„, ë°°ì§€ íƒ€ì´í‹€, ìˆ˜ì¹˜, ì„¤ëª…

#### ì½”ë“œ ìœ„ì¹˜
- **ì»´í¬ë„ŒíŠ¸**: `src/pages/ClubDetail.tsx:667` (`HallOfFame`)
- **ë¡œì§**: `src/utils/dashboardLogic.ts:42` (`calculateHofBadges`)
- **íƒ€ì…**: `src/utils/dashboardLogic.ts:21` (`HofBadge`)
- **CSS**: `src/App.css` (ëë¶€ë¶„, `.hall-of-fame-carousel`)

#### ìŠ¤íƒ€ì¼
- ë‹¤í¬ ê·¸ë¼ë°ì´ì…˜ ë°°ê²½
- ê°€ë¡œ Carousel ë ˆì´ì•„ì›ƒ (Snap Scroll)
- ì¹´ë“œ í¬ê¸°: ê³ ì • 280px
- Peeking: ë‹¤ìŒ ì¹´ë“œê°€ 16px ë³´ì„
- ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ (ê¹”ë”í•œ UI)
- ë°°ì§€ íƒ€ì…ë³„ ìƒ‰ìƒ ê·¸ë¼ë°ì´ì…˜

#### ì¥ì 
- ğŸ¯ **ì£¼ì¸ê³µ ëŠë‚Œ**: ë‚´ ë°°ì§€ê°€ ë§¨ ì• â†’ ì¦‰ì‹œ ì„±ì·¨ê°
- ğŸ”¥ **ë‹¤ìˆ˜ ë™ê¸° ë¶€ì—¬**: ì—¬ëŸ¬ ë°°ì§€ë¡œ ë‹¤ì–‘í•œ ì„±ê³¼ ì¸ì •
- ğŸ‘€ **ê³µê°„ íš¨ìœ¨**: Carouselë¡œ ë§ì€ ì •ë³´ë¥¼ ì‘ì€ ê³µê°„ì—
- âœ¨ **ì‹œê°ì  ì¦ê±°ì›€**: ìŠ¤í¬ë¡¤í•˜ë©° ë©¤ë²„ë“¤ì˜ ì„±ê³¼ íƒìƒ‰

#### ìƒì„¸ ë¬¸ì„œ
- [Hall of Fame Carousel êµ¬í˜„ ë¬¸ì„œ](./hall_of_fame_carousel.md)

---

### 3. ğŸ‘¥ Active Squad (Smart Active Squad)

**ID**: `daily_squad`
**íƒ€ì…**: `daily_squad`
**ê¸°ë³¸ ìˆœì„œ**: 2

#### ê¸°ëŠ¥
- **Smart Mix ì•Œê³ ë¦¬ì¦˜**: ì˜¤ëŠ˜ + ì–´ì œ ìš´ë™í•œ ë©¤ë²„ë¥¼ í•¨ê»˜ í‘œì‹œ
- ì˜¤ëŠ˜ ìš´ë™í•œ ë©¤ë²„ê°€ 4ëª… ë¯¸ë§Œì´ë©´ ì–´ì œ ìš´ë™í•œ ë©¤ë²„ ì¶”ê°€
- ì˜¤ëŠ˜+ì–´ì œ ëª¨ë‘ ì—†ìœ¼ë©´ ê°€ì¥ ìµœê·¼ í™œë™í•œ ë©¤ë²„ 3ëª… í‘œì‹œ
- ë©¤ë²„ë³„ ìš´ë™ ê°œìˆ˜ì™€ ë©”ëª¨ í‘œì‹œ
- í™œë™ ì‹œì ì— ë”°ë¥¸ ì‹œê°ì  êµ¬ë¶„ (Today/Yesterday/Recent ë±ƒì§€)

#### ì•Œê³ ë¦¬ì¦˜ (getSmartSquad)
```typescript
1. ì˜¤ëŠ˜ ìš´ë™í•œ ë©¤ë²„ â†’ activityType: 'today'
2. ì˜¤ëŠ˜ ë©¤ë²„ < 4ëª… â†’ ì–´ì œ ìš´ë™í•œ ë©¤ë²„ ì¶”ê°€ (activityType: 'yesterday')
3. ì˜¤ëŠ˜+ì–´ì œ = 0ëª… â†’ ìµœê·¼ í™œë™ ë©¤ë²„ 3ëª… (activityType: 'recent')
4. ì¤‘ë³µ ì œê±°: í•œ ìœ ì €ì˜ ìµœì‹  ê¸°ë¡ë§Œ í‘œì‹œ
```

#### ë°ì´í„° ì†ŒìŠ¤
- `getClubMemberLogs(clubId)` - ì „ì²´ ë¡œê·¸
- í•„í„°ë§ ë¡œì§: `getSmartSquad()` í•¨ìˆ˜

#### í‘œì‹œ ì •ë³´
- **Today ë©¤ë²„** (ğŸ”¥ Today ë±ƒì§€):
  - ë³´ë¼ìƒ‰ í…Œë‘ë¦¬ (#8b5cf6)
  - ë°ì€ ë³´ë¼ìƒ‰ ë°°ê²½
  - í”„ë¡œí•„ ì´ë¯¸ì§€ì— ë³´ë¼ìƒ‰ í…Œë‘ë¦¬
  - 100% ë¶ˆíˆ¬ëª…ë„
- **Yesterday ë©¤ë²„** (âš¡ Yesterday ë±ƒì§€):
  - ì ì„  íšŒìƒ‰ í…Œë‘ë¦¬ (#64748b)
  - ê¸°ë³¸ ë°°ê²½
  - í”„ë¡œí•„ ì´ë¯¸ì§€ì— íšŒìƒ‰ í…Œë‘ë¦¬
  - 85% ë¶ˆíˆ¬ëª…ë„ (í†¤ë‹¤ìš´)
- **Recent ë©¤ë²„**:
  - íšŒìƒ‰ì¡° ë°°ê²½
  - 70% ë¶ˆíˆ¬ëª…ë„
- ê³µí†µ: ìš´ë™ ê°œìˆ˜, ë©”ëª¨, ì£¼ í™œë™ ì•„ì´ì½˜

#### ì½”ë“œ ìœ„ì¹˜
- **ì»´í¬ë„ŒíŠ¸**: `src/pages/ClubDetail.tsx:800` (`DailySquad`)
- **ë¡œì§**: `src/utils/dashboardLogic.ts:456` (`getSmartSquad`)
- **íƒ€ì…**: `src/utils/dashboardLogic.ts:344` (`SquadMember`)

#### ìŠ¤íƒ€ì¼
- ë‹¤í¬ ê·¸ë¼ë°ì´ì…˜ ë°°ê²½
- ê°€ë¡œ ìŠ¤í¬ë¡¤ ì¹´ë“œ ë ˆì´ì•„ì›ƒ
- ê° ë©¤ë²„ ì¹´ë“œ: ìµœì†Œ ë„ˆë¹„ 160px
- ë©”ëª¨ ë§í’ì„ :
  - Today: ë³´ë¼ìƒ‰ (#8b5cf6)
  - Yesterday/Recent: íšŒìƒ‰ (#64748b)

#### ì¥ì 
- ğŸ¯ **Empty State ìµœì†Œí™”**: ì˜¤ì „ ì‹œê°„ëŒ€ì—ë„ ì–´ì œ ë©¤ë²„ í‘œì‹œë¡œ í™œê¸°ì°¬ ëŒ€ì‹œë³´ë“œ
- ğŸ”¥ **ì‹¤ì‹œê°„ ë°˜ì˜**: ì˜¤ëŠ˜ ìš´ë™í•˜ë©´ ì¦‰ì‹œ "Today" ë±ƒì§€ë¡œ ìµœìƒë‹¨ ë°°ì¹˜
- ğŸ‘€ **ëª…í™•í•œ êµ¬ë¶„**: ë±ƒì§€ì™€ ìƒ‰ìƒìœ¼ë¡œ í™œë™ ì‹œì  ì§ê´€ì ìœ¼ë¡œ êµ¬ë¶„
- ğŸ¨ **ì‹œê°ì  ìš°ì„ ìˆœìœ„**: ë¶ˆíˆ¬ëª…ë„ë¡œ Today > Yesterday > Recent ìˆœì„œ ê°•ì¡°

---

### 4. ğŸƒ Leaderboard - Cardio (ìœ ì‚°ì†Œ í‚¹)

**ID**: `leaderboard_cardio`
**íƒ€ì…**: `leaderboard`
**ê¸°ë³¸ ìˆœì„œ**: 3
**Config**: `{ metricType: 'cardio' }`

#### ê¸°ëŠ¥
- ìœ ì‚°ì†Œ ìš´ë™ ê±°ë¦¬ ê¸°ì¤€ ë¦¬ë”ë³´ë“œ
- ìƒìœ„ 10ëª… í‘œì‹œ
- 1~3ìœ„ ë©”ë‹¬ í‘œì‹œ

#### ì¸¡ì • ì§€í‘œ
- **Metric**: í‰ì§€ í™˜ì‚° ê±°ë¦¬ (Adjusted Distance)
- **ë‹¨ìœ„**: km
- **í•„í„°**: `workout.type === 'cardio'`

#### ë°ì´í„° ì†ŒìŠ¤
- `getClubMemberLogs(clubId)` - ê° ìš´ë™ì˜ `adjusted_dist_km` í•©ì‚°

#### í‘œì‹œ ì •ë³´
- ìˆœìœ„ (1~10ìœ„)
- ë©”ë‹¬ (ğŸ¥‡ğŸ¥ˆğŸ¥‰)
- í”„ë¡œí•„ ì´ë¯¸ì§€ or ì•„ë°”íƒ€
- ìœ ì € ì´ë¦„
- ì´ ê±°ë¦¬ (km)

#### ì½”ë“œ ìœ„ì¹˜
- **ì»´í¬ë„ŒíŠ¸**: `src/pages/ClubDetail.tsx:690` (`LeaderboardSection`)
- **ë©”íŠ¸ë¦­ ê³„ì‚°**: `src/utils/calculateMetrics.ts`

---

### 5. ğŸ‹ï¸ Leaderboard - Strength (ìŠ¤íŠ¸ë ìŠ¤ í‚¹)

**ID**: `leaderboard_strength`
**íƒ€ì…**: `leaderboard`
**ê¸°ë³¸ ìˆœì„œ**: 4
**Config**: `{ metricType: 'strength' }`

#### ê¸°ëŠ¥
- ê·¼ë ¥ ìš´ë™ ë³¼ë¥¨ ê¸°ì¤€ ë¦¬ë”ë³´ë“œ
- ìƒìœ„ 10ëª… í‘œì‹œ
- 1~3ìœ„ ë©”ë‹¬ í‘œì‹œ

#### ì¸¡ì • ì§€í‘œ
- **Metric**: ì´ ë³¼ë¥¨ (Volume)
- **ë‹¨ìœ„**: kg
- **í•„í„°**: `workout.type === 'strength'`
- **ê³„ì‚°ì‹**: `sets Ã— reps Ã— weight_kg`

#### ë°ì´í„° ì†ŒìŠ¤
- `getClubMemberLogs(clubId)` - ê° ìš´ë™ì˜ `volume_kg` í•©ì‚°

#### í‘œì‹œ ì •ë³´
- ìˆœìœ„ (1~10ìœ„)
- ë©”ë‹¬ (ğŸ¥‡ğŸ¥ˆğŸ¥‰)
- í”„ë¡œí•„ ì´ë¯¸ì§€ or ì•„ë°”íƒ€
- ìœ ì € ì´ë¦„
- ì´ ë³¼ë¥¨ (kg, ì²œ ë‹¨ìœ„ ì½¤ë§ˆ)

#### ì½”ë“œ ìœ„ì¹˜
- **ì»´í¬ë„ŒíŠ¸**: `src/pages/ClubDetail.tsx:690` (`LeaderboardSection`)
- **ë©”íŠ¸ë¦­ ê³„ì‚°**: `src/utils/calculateMetrics.ts`

---

### 6. ğŸ‚ Leaderboard - Snowboard (ìŠ¬ë¡œí”„ í‚¹)

**ID**: `leaderboard_snowboard`
**íƒ€ì…**: `leaderboard`
**ê¸°ë³¸ ìˆœì„œ**: 5
**Config**: `{ metricType: 'snowboard' }`

#### ê¸°ëŠ¥
- ìŠ¤ë…¸ë³´ë“œ ëŸ° ìˆ˜ ê¸°ì¤€ ë¦¬ë”ë³´ë“œ
- ìƒìœ„ 10ëª… í‘œì‹œ
- 1~3ìœ„ ë©”ë‹¬ í‘œì‹œ

#### ì¸¡ì • ì§€í‘œ
- **Metric**: ëŸ° ìˆ˜ (Run Count)
- **ë‹¨ìœ„**: íšŒ
- **í•„í„°**: `workout.category === 'snowboard'`

#### ë°ì´í„° ì†ŒìŠ¤
- `getClubMemberLogs(clubId)` - ê° ìš´ë™ì˜ `run_count` í•©ì‚°

#### í‘œì‹œ ì •ë³´
- ìˆœìœ„ (1~10ìœ„)
- ë©”ë‹¬ (ğŸ¥‡ğŸ¥ˆğŸ¥‰)
- í”„ë¡œí•„ ì´ë¯¸ì§€ or ì•„ë°”íƒ€
- ìœ ì € ì´ë¦„
- ì´ ëŸ° ìˆ˜ (íšŒ)

#### ì½”ë“œ ìœ„ì¹˜
- **ì»´í¬ë„ŒíŠ¸**: `src/pages/ClubDetail.tsx:690` (`LeaderboardSection`)
- **ë©”íŠ¸ë¦­ ê³„ì‚°**: `src/utils/calculateMetrics.ts`

---

## ìœ„ì ¯ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ë°ì´í„° êµ¬ì¡°

#### DashboardConfig (JSONB in DB)
```typescript
{
  "widgets": [
    {
      "id": "live_ticker",
      "type": "live_ticker",
      "visible": true,
      "order": 0
    },
    {
      "id": "leaderboard_cardio",
      "type": "leaderboard",
      "visible": true,
      "order": 3,
      "config": {
        "metricType": "cardio"
      }
    }
  ]
}
```

#### Widget Type ì •ì˜
```typescript
type DashboardWidgetType = 'live_ticker' | 'hall_of_fame' | 'daily_squad' | 'leaderboard';

interface DashboardWidget {
  id: string;                    // ê³ ìœ  ì‹ë³„ì
  type: DashboardWidgetType;     // ìœ„ì ¯ íƒ€ì…
  visible: boolean;              // í‘œì‹œ ì—¬ë¶€
  order: number;                 // ìˆœì„œ (0ë¶€í„° ì‹œì‘)
  config?: {                     // ìœ„ì ¯ë³„ ì¶”ê°€ ì„¤ì •
    metricType?: 'cardio' | 'strength' | 'snowboard';
    [key: string]: any;
  };
}
```

### íŒŒì¼ êµ¬ì¡°

```
src/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ ClubDetail.tsx              # ë©”ì¸ í˜ì´ì§€, ìœ„ì ¯ ë Œë”ë§
â”œâ”€â”€ types/
â”‚   â””â”€â”€ index.ts                    # DashboardWidget íƒ€ì… ì •ì˜
â”œâ”€â”€ storage/
â”‚   â””â”€â”€ clubStorage.ts              # updateDashboardConfig() í•¨ìˆ˜
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ dashboardLogic.ts           # íƒ€ì´í‹€, ìŠ¤ì¿¼ë“œ, í‹°ì»¤ ë¡œì§
â”‚   â””â”€â”€ calculateMetrics.ts         # ë©”íŠ¸ë¦­ ê³„ì‚° í•¨ìˆ˜
â””â”€â”€ components/
    â””â”€â”€ challenge/
        â””â”€â”€ ChallengeWizard.tsx     # ì±Œë¦°ì§€ ìƒì„± ë§ˆë²•ì‚¬

docs/
â””â”€â”€ database/
    â””â”€â”€ club_dashboard_widgets_migration.sql  # DB ë§ˆì´ê·¸ë ˆì´ì…˜
```

---

## ìœ„ì ¯ í¸ì§‘ ê¸°ëŠ¥

### ê¶Œí•œ
- **Owner**: ëª¨ë“  í¸ì§‘ ê°€ëŠ¥
- **Admin**: ëª¨ë“  í¸ì§‘ ê°€ëŠ¥
- **Member**: ì½ê¸°ë§Œ ê°€ëŠ¥

### í¸ì§‘ ëª¨ë“œ

#### ì§„ì…
- "ğŸ¨ ëŒ€ì‹œë³´ë“œ í¸ì§‘" ë²„íŠ¼ í´ë¦­

#### ê¸°ëŠ¥
1. **ìˆœì„œ ë³€ê²½**: â†‘â†“ ë²„íŠ¼ìœ¼ë¡œ ìœ„ì ¯ ìˆœì„œ ì¡°ì •
2. **í‘œì‹œ/ìˆ¨ê¹€**: ğŸ‘ï¸ ë²„íŠ¼ìœ¼ë¡œ í† ê¸€
3. **ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°**: ë³€ê²½ì‚¬í•­ ì¦‰ì‹œ ë°˜ì˜
4. **ì €ì¥/ì·¨ì†Œ**:
   - ğŸ’¾ ì €ì¥: DBì— ì„¤ì • ì €ì¥
   - ì·¨ì†Œ: ì›ë˜ ì„¤ì •ìœ¼ë¡œ ë³µì›

#### ì‹œê°ì  í”¼ë“œë°±
- í¸ì§‘ ëª¨ë“œì—ì„œ ìœ„ì ¯ì— ë³´ë¼ìƒ‰ ì ì„  í…Œë‘ë¦¬
- ìˆ¨ê¹€ ìœ„ì ¯ì€ 50% íˆ¬ëª…ë„
- ìœ„ì ¯ ì œëª© ìƒë‹¨ì— í‘œì‹œ

### ì½”ë“œ ìœ„ì¹˜
- **í¸ì§‘ UI**: `src/pages/ClubDetail.tsx:189-221` (Dashboard Tab)
- **ìœ„ì ¯ ë˜í¼**: `src/pages/ClubDetail.tsx:364-516` (`DashboardWidgetWrapper`)
- **ìƒíƒœ ê´€ë¦¬**: `src/pages/ClubDetail.tsx:129-177` (handleToggleWidgetVisibility, handleMoveWidget, handleSaveWidgets)

---

## ë°ì´í„° íë¦„

```
1. í´ëŸ½ ìƒì„¸ í˜ì´ì§€ ë¡œë“œ
   â†“
2. clubService.getClubDetail(clubId)
   - club ì •ë³´ + dashboard_config ë¡œë“œ
   â†“
3. dashboard_config?.widgets í™•ì¸
   - ìˆìœ¼ë©´: ì €ì¥ëœ ì„¤ì • ì‚¬ìš©
   - ì—†ìœ¼ë©´: DEFAULT_WIDGETS ì‚¬ìš©
   â†“
4. Dashboard íƒ­ ì„ íƒ
   â†“
5. getClubMemberLogs(clubId) í˜¸ì¶œ
   - í´ëŸ½ ë©¤ë²„ë“¤ì˜ ê³µìœ ëœ ìš´ë™ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
   â†“
6. ê° ìœ„ì ¯ì´ memberLogs ë°ì´í„°ë¥¼ ì²˜ë¦¬
   - LiveTicker: generateTickerItems()
   - HallOfFame: calculateTitles()
   - DailySquad: getTodaySquad()
   - Leaderboards: ë©”íŠ¸ë¦­ë³„ ì§‘ê³„ ë° ì •ë ¬
   â†“
7. ìœ„ì ¯ ë Œë”ë§ (visible && order ìˆœì„œëŒ€ë¡œ)
```

---

## Zero-Copy View íŒ¨í„´

í´ëŸ½ ëŒ€ì‹œë³´ë“œëŠ” **Zero-Copy View** ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

- âŒ **ë°ì´í„° ë³µì‚¬ ì—†ìŒ**: `club_feeds` ê°™ì€ ì¤‘ê°„ í…Œì´ë¸”ì— ë°ì´í„° ë³µì‚¬ ì•ˆ í•¨
- âœ… **ì§ì ‘ ì°¸ì¡°**: `workout_logs` í…Œì´ë¸”ì„ ì§ì ‘ ì¡°íšŒ
- âœ… **RLS ë³´ì•ˆ**: Row Level Securityë¡œ ë©¤ë²„ë§Œ ê³µìœ ëœ ë¡œê·¸ ì¡°íšŒ ê°€ëŠ¥
- âœ… **ì‹¤ì‹œê°„ ë°˜ì˜**: ìš´ë™ ë¡œê·¸ ì €ì¥ ì¦‰ì‹œ ëŒ€ì‹œë³´ë“œì— ë°˜ì˜

### ì¥ì 
- ìŠ¤í† ë¦¬ì§€ ì ˆì•½
- ë°ì´í„° ì •í•©ì„± ë³´ì¥
- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸

ìì„¸í•œ ë‚´ìš©: `docs/features/club_dashboard_data_structure.md`

---

## í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„±

### 1. ìƒˆë¡œìš´ ìœ„ì ¯ íƒ€ì… ì¶”ê°€
- ì£¼ê°„ íŠ¸ë Œë“œ ì°¨íŠ¸
- ê°œì¸ ëª©í‘œ ë‹¬ì„±ë¥ 
- ìµœê·¼ PR (Personal Record) ê°¤ëŸ¬ë¦¬
- í´ëŸ½ í†µê³„ ìš”ì•½

### 2. ìœ„ì ¯ ì„¤ì • í™•ì¥
```typescript
config?: {
  metricType?: string;
  timeRange?: 'week' | 'month' | 'all';  // ê¸°ê°„ í•„í„°
  limit?: number;                         // í‘œì‹œ ê°œìˆ˜ ì œí•œ
  theme?: 'light' | 'dark' | 'custom';    // í…Œë§ˆ
}
```

### 3. ìœ„ì ¯ ì»¤ìŠ¤í„°ë§ˆì´ì§•
- ìƒ‰ìƒ í…Œë§ˆ ì„ íƒ
- íƒ€ì´í‹€ ë³€ê²½
- í‘œì‹œ ê°œìˆ˜ ì¡°ì •
- í•„í„° ì¡°ê±´ ì„¤ì •

### 4. ìœ„ì ¯ ë³µì œ ë° ì‚­ì œ
- ê°™ì€ íƒ€ì… ìœ„ì ¯ ì—¬ëŸ¬ ê°œ ìƒì„± (ì˜ˆ: ì—¬ëŸ¬ ë¦¬ë”ë³´ë“œ)
- ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ìœ„ì ¯ ì‚­ì œ

---

## ë””ë²„ê¹… ë° íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ìœ„ì ¯ì´ ì•ˆ ë³´ì¼ ë•Œ
1. `visible: true`ì¸ì§€ í™•ì¸
2. `memberLogs` ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
3. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì—ëŸ¬ í™•ì¸

### ì„¤ì •ì´ ì €ì¥ ì•ˆ ë  ë•Œ
1. DBì— `dashboard_config` ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
   ```sql
   SELECT column_name FROM information_schema.columns
   WHERE table_name = 'clubs' AND column_name = 'dashboard_config';
   ```
2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ í™•ì¸: `docs/database/club_dashboard_widgets_migration.sql`

### ë°ì´í„°ê°€ ì•ˆ ë‚˜ì˜¬ ë•Œ
1. RLS ì •ì±… í™•ì¸: í´ëŸ½ ë©¤ë²„ ê¶Œí•œ
2. `getClubMemberLogs()` í•¨ìˆ˜ ê²°ê³¼ í™•ì¸
3. `workout_logs` í…Œì´ë¸”ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸

---

## ê´€ë ¨ ë¬¸ì„œ

- [í´ëŸ½ ì‹œìŠ¤í…œ ì „ì²´ êµ¬ì¡°](./club_dashboard_data_structure.md)
- [ì±Œë¦°ì§€ ì‹œìŠ¤í…œ](./challenge_system.md) (ì˜ˆì •)
- [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](../database/club_system_migration.sql)

---

**Last Updated**: 2026-01-21
**Version**: 1.0
**Author**: Claude Code
</file>

<file path="docs/features/hall_of_fame_carousel.md">
# Hall of Fame Carousel - ëª…ì˜ˆì˜ ì „ë‹¹ ê°œí¸

**ì‘ì—… ì™„ë£Œì¼**: 2026-01-21
**ì‘ì—…ì**: Claude Code
**ë²„ì „**: 2.0

---

## ğŸ“‹ ì‘ì—… ê°œìš”

í´ëŸ½ ëŒ€ì‹œë³´ë“œì˜ "ëª…ì˜ˆì˜ ì „ë‹¹(Hall of Fame)" ìœ„ì ¯ì„ **Carousel(ìŠ¬ë¼ì´ë“œ)** í˜•íƒœë¡œ ì „ë©´ ê°œí¸í•˜ì—¬:
1. ë‹¤ìˆ˜ ë©¤ë²„ì˜ ì„±ê³¼ë¥¼ ë™ì‹œì— ë³´ì—¬ì£¼ê³ 
2. **ì ‘ì†í•œ ë³¸ì¸(Me)ì˜ ë°°ì§€ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ë…¸ì¶œ**í•˜ì—¬ "ë‚˜ë„ ì£¼ì¸ê³µ"ì´ë¼ëŠ” ëŠë‚Œ ì œê³µ

---

## ğŸ¯ ë¬¸ì œì  ë° í•´ê²°ì±…

### Before (ê¸°ì¡´)

**ë¬¸ì œì **:
- âŒ Grid ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë‹¨ 1ëª…ì˜ 1ë“±ë§Œ í‘œì‹œ
- âŒ ë‹¤ìˆ˜ ìœ ì € ë™ê¸° ë¶€ì—¬ ì‹¤íŒ¨
- âŒ ê³µê°„ ë‚­ë¹„ (í•œ í™”ë©´ì— 1-2ê°œë§Œ ë³´ì„)
- âŒ ë³¸ì¸ì´ 1ë“±ì´ ì•„ë‹ˆë©´ ì†Œì™¸ê°

### After (ê°œì„ )

**í•´ê²°ì±…**:
- âœ… Carousel(ìŠ¬ë¼ì´ë“œ) UIë¡œ ì—¬ëŸ¬ ë°°ì§€ ë™ì‹œ ë…¸ì¶œ
- âœ… í•œ ìœ ì €ê°€ ì—¬ëŸ¬ ë°°ì§€ ë°›ì„ ìˆ˜ ìˆìŒ (6ê°€ì§€ ë°°ì§€)
- âœ… **Me-first Sorting**: ë³¸ì¸ ë°°ì§€ë¥¼ ë§¨ ì•ì— ë°°ì¹˜
- âœ… Snap Scroll + Peekingìœ¼ë¡œ UX í–¥ìƒ

---

## ğŸ† 6ê°€ì§€ ë°°ì§€ ì‹œìŠ¤í…œ

ëª¨ë“  ë°°ì§€ëŠ” **ì£¼ê°„ ë°ì´í„°(ìµœê·¼ 7ì¼)** ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.

| ë°°ì§€ | ì•„ì´ì½˜ | íƒ€ì… | ì¡°ê±´ | ì„¤ëª… |
|------|--------|------|------|------|
| **ì›Œì»¤í™€ë¦­** | ğŸ”¥ | effort | ì´ ìš´ë™ íšŸìˆ˜ 1ìœ„ | "ì£¼ê°„ NíšŒ ìš´ë™" |
| **ë¯¸ë¼í´ ëª¨ë‹** | ğŸŒ… | time | 04-08ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„ | "ìƒˆë²½ NíšŒ ìš´ë™" |
| **ì˜¬ë¹¼ë¯¸ íŒŒìˆ˜ê¾¼** | ğŸ¦‰ | time | 22-03ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„ | "ì‹¬ì•¼ NíšŒ ìš´ë™" |
| **3ëŒ€ 500 ê¿ˆë‚˜ë¬´** | ğŸ‹ï¸ | strength | ì´ ë³¼ë¥¨(kg) 1ìœ„ | "ì´ ë³¼ë¥¨ X.Xt" |
| **ì§€ì¹  ì¤„ ëª¨ë¥´ëŠ” ì‹¬ì¥** | ğŸƒ | cardio | í™˜ì‚° ê±°ë¦¬(km) 1ìœ„ | "ì´ ê±°ë¦¬ X.Xkm" |
| **ì„¤ì›ì˜ ì§€ë°°ì** | ğŸ‚ | consistency | ìŠ¤ë…¸ë³´ë“œ ëŸ° ìˆ˜ 1ìœ„ | "ì´ NëŸ° ì™„ì£¼" |

---

## ğŸ¨ ë°°ì§€ íƒ€ì…ë³„ ìƒ‰ìƒ ì‹œìŠ¤í…œ

| íƒ€ì… | ìƒ‰ìƒ | ì ìš© ë°°ì§€ |
|------|------|-----------|
| `strength` | #ef4444 (Red) | 3ëŒ€ 500 ê¿ˆë‚˜ë¬´ |
| `cardio` | #3b82f6 (Blue) | ì§€ì¹  ì¤„ ëª¨ë¥´ëŠ” ì‹¬ì¥ |
| `effort` | #eab308 (Yellow) | ì›Œì»¤í™€ë¦­ |
| `time` | #f97316 (Orange) | ë¯¸ë¼í´ ëª¨ë‹, ì˜¬ë¹¼ë¯¸ íŒŒìˆ˜ê¾¼ |
| `consistency` | #8b5cf6 (Purple) | ì„¤ì›ì˜ ì§€ë°°ì |

---

## ğŸ”§ êµ¬í˜„ ìƒì„¸

### 1. ë°ì´í„° êµ¬ì¡°

**íŒŒì¼**: `src/utils/dashboardLogic.ts`

#### HofBadge ì¸í„°í˜ì´ìŠ¤

```typescript
export type BadgeType = 'strength' | 'cardio' | 'effort' | 'time' | 'consistency';

export interface HofBadge {
  userId: string;
  userName: string;
  userProfile: string | null;
  type: BadgeType; // ìŠ¤íƒ€ì¼ë§ìš©
  title: string; // ì˜ˆ: "3ëŒ€ 500 ê¿ˆë‚˜ë¬´"
  icon: string; // ì˜ˆ: "ğŸ‹ï¸"
  description: string; // ì˜ˆ: "ì´ ë³¼ë¥¨ 50,000kg ë‹¬ì„±"
  value: string; // í‘œì‹œìš© ê°’ (í¬ë§·íŒ…ëœ ë¬¸ìì—´)
  isMe: boolean; // ì •ë ¬ ìµœìš°ì„ ìˆœìœ„ í”Œë˜ê·¸
  badgeId: string; // ê³ ìœ  ID (userId + type)
}
```

#### calculateHofBadges() í•¨ìˆ˜

```typescript
export const calculateHofBadges = (
  members: WorkoutLog[],
  currentUserId?: string
): HofBadge[]
```

**ì•Œê³ ë¦¬ì¦˜**:
1. ì£¼ê°„ ë°ì´í„° í•„í„°ë§ (ìµœê·¼ 7ì¼)
2. 6ê°€ì§€ ë°°ì§€ ê°ê° ê³„ì‚°
3. ê° ë°°ì§€ì˜ isMe í”Œë˜ê·¸ ì„¤ì • (userId === currentUserId)
4. **Me-first Sorting**: isMeê°€ trueì¸ ë°°ì§€ë¥¼ ë§¨ ì•ìœ¼ë¡œ

---

### 2. UI êµ¬í˜„

**íŒŒì¼**: `src/pages/ClubDetail.tsx:667`

#### Carousel ì»¨í…Œì´ë„ˆ

```typescript
<div
  style={{
    display: 'flex',
    gap: '16px',
    overflowX: 'auto',
    scrollSnapType: 'x mandatory',
    paddingBottom: '8px',
    scrollbarWidth: 'none',
    msOverflowStyle: 'none',
  }}
  className="hall-of-fame-carousel"
>
```

**íŠ¹ì§•**:
- `scrollSnapType: 'x mandatory'`: ì¹´ë“œë³„ Snap Scroll
- `overflowX: 'auto'`: ê°€ë¡œ ìŠ¤í¬ë¡¤
- `scrollbarWidth: 'none'`: ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ (ê¹”ë”í•œ UI)

#### ì¹´ë“œ ë””ìì¸

```typescript
<div
  style={{
    minWidth: '280px',
    maxWidth: '280px',
    scrollSnapAlign: 'start',
    background: badge.isMe
      ? `linear-gradient(135deg, ${color}33 0%, ${color}22 100%)`
      : `linear-gradient(135deg, ${color}22 0%, ${color}11 100%)`,
    border: badge.isMe
      ? `3px solid ${color}`
      : `2px solid ${color}66`,
    boxShadow: badge.isMe ? `0 0 20px ${color}44` : 'none',
  }}
>
```

**ì°¨ë³„í™”**:
- **Me ì¹´ë“œ**: ì§„í•œ ë°°ê²½, ë‘êº¼ìš´ í…Œë‘ë¦¬(3px), ê¸€ë¡œìš° íš¨ê³¼
- **Others ì¹´ë“œ**: ì—°í•œ ë°°ê²½, ì–‡ì€ í…Œë‘ë¦¬(2px), ê¸€ë¡œìš° ì—†ìŒ

#### Me ë±ƒì§€

```typescript
{badge.isMe && (
  <div style={{
    position: 'absolute',
    top: '12px',
    left: '12px',
    background: color,
    color: 'white',
    padding: '4px 10px',
    borderRadius: '12px',
    fontSize: '11px',
    fontWeight: '700',
  }}>
    â­ ME
  </div>
)}
```

---

### 3. CSS ìŠ¤íƒ€ì¼

**íŒŒì¼**: `src/App.css` (ëì— ì¶”ê°€)

```css
/* Hall of Fame Carousel Styles */
.hall-of-fame-carousel {
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
}

/* Hide scrollbar for Chrome, Safari and Opera */
.hall-of-fame-carousel::-webkit-scrollbar {
  display: none;
}

/* Hide scrollbar for IE, Edge and Firefox */
.hall-of-fame-carousel {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}
```

---

## ğŸ“Š ì‚¬ìš©ì ê²½í—˜ íë¦„

### ì‹œë‚˜ë¦¬ì˜¤ 1: ë‚´ê°€ ë°°ì§€ë¥¼ ë°›ì•˜ì„ ë•Œ

```
ì‚¬ìš©ì ë¡œê·¸ì¸ (Alice)
  â†“
Hall of Fame ë¡œë“œ
  â†“
calculateHofBadges(logs, "alice-id")
  â†“
ê²°ê³¼: [
  { userId: "alice-id", title: "ì›Œì»¤í™€ë¦­", isMe: true },  â† ë§¨ ì•
  { userId: "bob-id", title: "3ëŒ€ 500 ê¿ˆë‚˜ë¬´", isMe: false },
  { userId: "alice-id", title: "ë¯¸ë¼í´ ëª¨ë‹", isMe: true }, â† ë‘ ë²ˆì§¸
  ...
]
  â†“
Me-first Sorting ì ìš©
  â†“
ìµœì¢…: [
  { Alice - ì›Œì»¤í™€ë¦­ â­ME },        â† ì²« ì¹´ë“œ (ì§„í•œ ê°•ì¡°)
  { Alice - ë¯¸ë¼í´ ëª¨ë‹ â­ME },     â† ë‘ ë²ˆì§¸ (ì§„í•œ ê°•ì¡°)
  { Bob - 3ëŒ€ 500 ê¿ˆë‚˜ë¬´ },          â† ì„¸ ë²ˆì§¸
  ...
]
```

**UX**:
- âœ¨ ì²« ì¹´ë“œê°€ "ë‚˜"ì˜ ë°°ì§€ â†’ ì¦‰ì‹œ ì„±ì·¨ê°
- âœ¨ ì¢Œìš° ìŠ¤í¬ë¡¤í•˜ë©´ ë‚´ ë‹¤ë¥¸ ë°°ì§€ë„ í™•ì¸
- âœ¨ ì§„í•œ ìƒ‰ìƒ + ê¸€ë¡œìš° íš¨ê³¼ë¡œ ì£¼ì¸ê³µ ëŠë‚Œ

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë‚´ê°€ ë°°ì§€ê°€ ì—†ì„ ë•Œ

```
ì‚¬ìš©ì ë¡œê·¸ì¸ (Charlie, ì‹ ê·œ ë©¤ë²„)
  â†“
calculateHofBadges(logs, "charlie-id")
  â†“
ê²°ê³¼: [
  { Bob - ì›Œì»¤í™€ë¦­ },
  { Alice - 3ëŒ€ 500 ê¿ˆë‚˜ë¬´ },
  { David - ì„¤ì›ì˜ ì§€ë°°ì },
  ...
]
  â†“
Charlieì˜ ë°°ì§€ ì—†ìŒ â†’ ë‹¤ë¥¸ ë©¤ë²„ë“¤ë§Œ í‘œì‹œ
```

**UX**:
- ğŸ“¢ "ë‹¤ë¥¸ ë©¤ë²„ë“¤ì´ ì´ëŸ° ì„±ê³¼ë¥¼ ëƒˆì–´ìš”!"
- ğŸ¯ ë™ê¸° ë¶€ì—¬: "ë‚˜ë„ ë°°ì§€ë¥¼ ë°›ê³  ì‹¶ë‹¤!"

---

## ğŸ¨ ì‹œê°ì  ì°¨ë³„í™”

### Me ì¹´ë“œ vs Others ì¹´ë“œ

| ìš”ì†Œ | Me | Others |
|------|-----|--------|
| **ë°°ê²½ ë¶ˆíˆ¬ëª…ë„** | 33% â†’ 22% | 22% â†’ 11% |
| **í…Œë‘ë¦¬ ë‘ê»˜** | 3px | 2px |
| **í…Œë‘ë¦¬ ë¶ˆíˆ¬ëª…ë„** | 100% | 66% |
| **ê¸€ë¡œìš° íš¨ê³¼** | `0 0 20px ${color}44` | ì—†ìŒ |
| **Me ë±ƒì§€** | â­ ME (í‘œì‹œ) | ì—†ìŒ |

### ë°°ì§€ ì•„ì´ì½˜ í‘œì‹œ

- **ìš°ì¸¡ ìƒë‹¨**: í° ì•„ì´ì½˜ (32px, 30% íˆ¬ëª…ë„) - ë°°ê²½ ì¥ì‹ìš©
- **ìœ ì € ì´ë¦„ ì•„ë˜**: ì‘ì€ ì•„ì´ì½˜ + íƒ€ì´í‹€ í…ìŠ¤íŠ¸ - ì •ë³´ ì „ë‹¬ìš©

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### useMemoë¡œ ì¬ê³„ì‚° ë°©ì§€

```typescript
const currentUserId = useMemo(() => {
  const userStr = localStorage.getItem('current_user');
  if (!userStr) return undefined;
  try {
    const user = JSON.parse(userStr);
    return user.id;
  } catch {
    return undefined;
  }
}, []);

const badges = useMemo(
  () => calculateHofBadges(members, currentUserId),
  [members, currentUserId]
);
```

### CSS Snap Scroll

- JavaScript ì—†ì´ ìˆœìˆ˜ CSSë¡œ êµ¬í˜„
- ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜
- ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” (`-webkit-overflow-scrolling: touch`)

---

## ğŸ“± ë°˜ì‘í˜• ë””ìì¸

### ì¹´ë“œ í¬ê¸°

- **ê³ ì •**: `minWidth: 280px`, `maxWidth: 280px`
- **Peeking**: ë‹¤ìŒ ì¹´ë“œê°€ ìš°ì¸¡ì— 16px ë³´ì„
- **ëª¨ë°”ì¼**: í•œ í™”ë©´ì— 1.2ê°œ ì¹´ë“œ (Peeking íš¨ê³¼)
- **íƒœë¸”ë¦¿/ë°ìŠ¤í¬í†±**: í•œ í™”ë©´ì— 2-3ê°œ ì¹´ë“œ

### ìŠ¤í¬ë¡¤ íŒíŠ¸

```typescript
{badges.length > 1 && !badges[0].isMe && (
  <div style={{ marginTop: '12px', fontSize: '12px', color: '#64748b', textAlign: 'center' }}>
    â† ì¢Œìš°ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ë” ë§ì€ ë°°ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš” â†’
  </div>
)}
```

- ì²« ë²ˆì§¸ ì¹´ë“œê°€ Meê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ
- ì‚¬ìš©ìì—ê²Œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•¨ì„ ì•Œë¦¼

---

## ğŸ”® í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„±

### 1. ë°°ì§€ ì¶”ê°€

```typescript
// ì˜ˆì‹œ: ìƒˆë¡œìš´ ë°°ì§€ ì¶”ê°€
const findConsistencyKing = (logs, currentUserId) => {
  // ì—°ì† ì¶œì„ ì¼ìˆ˜ ê³„ì‚°
  return {
    type: 'consistency',
    title: 'ì² ì¸',
    icon: 'ğŸ›¡ï¸',
    description: '7ì¼ ì—°ì† ì¶œì„',
    ...
  };
};
```

### 2. ë°°ì§€ ë“±ê¸‰ ì‹œìŠ¤í…œ

```typescript
interface HofBadge {
  // ...
  grade?: 'bronze' | 'silver' | 'gold' | 'platinum';
}

// ë“±ê¸‰ë³„ ìƒ‰ìƒ ì°¨ë³„í™”
const getBadgeGradeColor = (grade) => {
  switch (grade) {
    case 'platinum': return '#E5E4E2';
    case 'gold': return '#FFD700';
    case 'silver': return '#C0C0C0';
    case 'bronze': return '#CD7F32';
  }
};
```

### 3. ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼

```css
.hall-of-fame-carousel > div {
  transition: transform 0.3s ease, opacity 0.3s ease;
}

.hall-of-fame-carousel > div:hover {
  transform: scale(1.05);
}
```

### 4. ë°°ì§€ ìƒì„¸ ëª¨ë‹¬

- ì¹´ë“œ í´ë¦­ â†’ ë°°ì§€ ìƒì„¸ ì •ë³´ ëª¨ë‹¬
- ì—­ëŒ€ ìˆ˜ìƒì ëª©ë¡
- ë‹¬ì„± ì¡°ê±´ ë° íŒ

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] HofBadge ì¸í„°í˜ì´ìŠ¤ ì •ì˜
- [x] calculateHofBadges() í•¨ìˆ˜ êµ¬í˜„
- [x] 6ê°€ì§€ ë°°ì§€ ë¡œì§ êµ¬í˜„
- [x] Me-first Sorting êµ¬í˜„
- [x] Carousel UI êµ¬í˜„
- [x] Snap Scroll ì ìš©
- [x] ë°°ì§€ íƒ€ì…ë³„ ìƒ‰ìƒ ì°¨ë³„í™”
- [x] Me ì¹´ë“œ ê°•ì¡° ìŠ¤íƒ€ì¼
- [x] CSS ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ ì²˜ë¦¬
- [x] ìŠ¤í¬ë¡¤ íŒíŠ¸ í…ìŠ¤íŠ¸
- [x] useMemo ìµœì í™”
- [x] ë¹Œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼
- [x] ë¬¸ì„œ ì‘ì„±

---

## ğŸ“ ë³€ê²½ëœ íŒŒì¼

### 1. src/utils/dashboardLogic.ts
- `HofBadge` ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€
- `calculateHofBadges()` í•¨ìˆ˜ ì¶”ê°€
- 6ê°€ì§€ Helper í•¨ìˆ˜ ì¶”ê°€:
  - `findWorkaholic()`
  - `findEarlyBirdBadge()`
  - `findNightOwl()`
  - `findVolumeKingBadge()`
  - `findCardioKing()`
  - `findSlopeMaster()`

### 2. src/pages/ClubDetail.tsx
- import ë³€ê²½: `calculateTitles` â†’ `calculateHofBadges`
- `HallOfFame` ì»´í¬ë„ŒíŠ¸ ì „ë©´ ë¦¬íŒ©í† ë§:
  - Grid â†’ Carousel
  - currentUserId ë¡œì§ ì¶”ê°€
  - Me ë±ƒì§€ í‘œì‹œ
  - ë°°ì§€ íƒ€ì…ë³„ ìƒ‰ìƒ
  - Snap Scroll ì ìš©

### 3. src/App.css
- `.hall-of-fame-carousel` í´ë˜ìŠ¤ ì¶”ê°€
- ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ ì²˜ë¦¬

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- [í´ëŸ½ ëŒ€ì‹œë³´ë“œ ìœ„ì ¯ ì‹œìŠ¤í…œ](./club_dashboard_widgets.md)
- [Smart Active Squad êµ¬í˜„](./smart_active_squad_implementation.md)

---

**Status**: âœ… ì™„ë£Œ
**Build**: âœ… í†µê³¼ (719.73 kB)
**Type Check**: âœ… í†µê³¼
**ì£¼ìš” ê°œì„ **: ë‹¨ì¼ 1ë“± í‘œì‹œ â†’ 6ê°€ì§€ ë°°ì§€ Carousel + Me-first Sorting
</file>

<file path="docs/features/smart_active_squad_implementation.md">
# Smart Active Squad Implementation

**ì‘ì—… ì™„ë£Œì¼**: 2026-01-21
**ì‘ì—…ì**: Claude Code
**ë²„ì „**: 1.0

---

## ğŸ“‹ ì‘ì—… ê°œìš”

í´ëŸ½ ëŒ€ì‹œë³´ë“œì˜ "Daily Squad" ìœ„ì ¯ì„ "Smart Active Squad"ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì—¬ ì˜¤ëŠ˜+ì–´ì œ ìš´ë™í•œ ë©¤ë²„ë¥¼ í•¨ê»˜ í‘œì‹œí•˜ë„ë¡ ê°œì„ í–ˆìŠµë‹ˆë‹¤.

### ë¬¸ì œì 
- ê¸°ì¡´: ì˜¤ëŠ˜ë§Œ í‘œì‹œ â†’ ì˜¤ì „ ì‹œê°„ëŒ€ë‚˜ í™œë™ ì ì€ ë‚  Empty State ë°œìƒ
- ì‚¬ìš©ìì˜ ìš´ë™ ì˜ìš• ì €í•˜ ê°€ëŠ¥ì„±

### í•´ê²°ì±…
- Smart Mix ì•Œê³ ë¦¬ì¦˜: ì˜¤ëŠ˜ + ì–´ì œ + ìµœê·¼ í™œë™ ë©¤ë²„ í‘œì‹œ
- ì‹œê°ì  êµ¬ë¶„: ë±ƒì§€ì™€ ìŠ¤íƒ€ì¼ë¡œ í™œë™ ì‹œì  êµ¬ë¶„

---

## ğŸ”§ êµ¬í˜„ ë‚´ìš©

### 1. íƒ€ì… ì •ì˜ ë³€ê²½

**íŒŒì¼**: `src/utils/dashboardLogic.ts`

#### SquadMember ì¸í„°í˜ì´ìŠ¤ í™•ì¥
```typescript
export interface SquadMember {
  userId: string;
  displayName: string;
  profileImage: string | null;
  mainActivity: string;
  memo: string | null;
  workoutCount: number;
  activityType: 'today' | 'yesterday' | 'recent'; // âœ¨ ì¶”ê°€
  lastActiveDate: string;                          // âœ¨ ì¶”ê°€ (YYYY-MM-DD)
}
```

---

### 2. ë¡œì§ êµ¬í˜„: getSmartSquad()

**íŒŒì¼**: `src/utils/dashboardLogic.ts:456`

#### ì•Œê³ ë¦¬ì¦˜ í”Œë¡œìš°

```
ì…ë ¥: WorkoutLog[]
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ë‚ ì§œë³„ ë¶„ë¥˜                      â”‚
â”‚   - ì˜¤ëŠ˜(Today)                     â”‚
â”‚   - ì–´ì œ(Yesterday)                 â”‚
â”‚   - ìµœê·¼(Recent)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ìœ ì €ë³„ ìµœì‹  í™œë™ ì§‘ê³„            â”‚
â”‚   - ì¤‘ë³µ ì œê±° (ìµœì‹  ê¸°ë¡ë§Œ)         â”‚
â”‚   - activityType ê²°ì •               â”‚
â”‚   - workoutCount í•©ì‚°               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Smart Mix ì •ë ¬                   â”‚
â”‚   A. ì˜¤ëŠ˜ ë©¤ë²„ ì¶”ê°€ (workoutCountâ†“) â”‚
â”‚   B. ì˜¤ëŠ˜ < 4ëª…? â†’ ì–´ì œ ë©¤ë²„ ì¶”ê°€   â”‚
â”‚   C. ì˜¤ëŠ˜+ì–´ì œ = 0? â†’ ìµœê·¼ 3ëª…      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
ì¶œë ¥: SquadMember[]
```

#### í•µì‹¬ ë¡œì§

```typescript
// Smart Mix ë¡œì§
const result: SquadMember[] = [];

// 1. ì˜¤ëŠ˜ ìš´ë™í•œ ë©¤ë²„ ì¶”ê°€
result.push(...todayMembers);

// 2. ì˜¤ëŠ˜ ë©¤ë²„ê°€ 4ëª… ë¯¸ë§Œì´ë©´ ì–´ì œ ë©¤ë²„ ì¶”ê°€
if (result.length < 4) {
  result.push(...yesterdayMembers);
}

// 3. ì˜¤ëŠ˜+ì–´ì œ ëª¨ë‘ ì—†ìœ¼ë©´ ìµœê·¼ ë©¤ë²„ ì¶”ê°€
if (result.length === 0) {
  result.push(...recentMembers);
}
```

---

### 3. UI êµ¬í˜„: DailySquad ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/pages/ClubDetail.tsx:800`

#### ìŠ¤íƒ€ì¼ ì°¨ë³„í™”

| ìš”ì†Œ | Today | Yesterday | Recent |
|------|-------|-----------|--------|
| **ë±ƒì§€** | ğŸ”¥ Today | âš¡ Yesterday | ì—†ìŒ |
| **ë±ƒì§€ ìƒ‰ìƒ** | #8b5cf6 (ë³´ë¼) | #64748b (íšŒìƒ‰) | - |
| **í…Œë‘ë¦¬** | 2px solid #8b5cf6 | 2px dashed #64748b | 2px solid #475569 |
| **ë°°ê²½** | rgba(139,92,246,0.15) | rgba(255,255,255,0.05) | rgba(71,85,105,0.3) |
| **ë¶ˆíˆ¬ëª…ë„** | 100% | 85% | 70% |
| **í”„ë¡œí•„ í…Œë‘ë¦¬** | 3px solid #8b5cf6 | 2px solid #64748b | 2px solid #64748b |
| **ë©”ëª¨ ìƒ‰ìƒ** | #8b5cf6 | #64748b | #64748b |

#### ë™ì  ì„œë¸Œíƒ€ì´í‹€

```typescript
// ì˜ˆì‹œ
"ì˜¤ëŠ˜ 3ëª…, ì–´ì œ 2ëª…ì´ ìš´ë™í–ˆìŠµë‹ˆë‹¤"  // ì˜¤ëŠ˜+ì–´ì œ í˜¼í•©
"5ëª…ì´ ì˜¤ëŠ˜ ìš´ë™í–ˆìŠµë‹ˆë‹¤"            // ì˜¤ëŠ˜ë§Œ
"3ëª…ì´ ì–´ì œ ìš´ë™í–ˆìŠµë‹ˆë‹¤"            // ì–´ì œë§Œ
"3ëª…ì˜ í™œì„± ë©¤ë²„"                    // ìµœê·¼ í™œë™
```

---

## ğŸ“Š ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

### Before (ê¸°ì¡´)

```
ì˜¤ì „ 8ì‹œ ì ‘ì†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¥ ì˜¤ëŠ˜ì˜ ìŠ¤ì¿¼ë“œ        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚ ì˜¤ëŠ˜ ìš´ë™í•œ ë©¤ë²„ê°€      â”‚
â”‚ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¢           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After (ê°œì„ )

```
ì˜¤ì „ 8ì‹œ ì ‘ì†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¥ Active Squad                     â”‚
â”‚ ì–´ì œ 5ëª…ì´ ìš´ë™í–ˆìŠµë‹ˆë‹¤             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ [âš¡Yesterday] [âš¡Yesterday] ...      â”‚
â”‚  Alice          Bob                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì˜¤í›„ 2ì‹œ - Charlie ìš´ë™ ì™„ë£Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¥ Active Squad                     â”‚
â”‚ ì˜¤ëŠ˜ 1ëª…, ì–´ì œ 5ëª…ì´ ìš´ë™í–ˆìŠµë‹ˆë‹¤   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ [ğŸ”¥Today]   [âš¡Yesterday] ...        â”‚
â”‚  Charlie     Alice                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ê¸°ëŒ€ íš¨ê³¼

### 1. Empty State ìµœì†Œí™”
- ì˜¤ì „ ì‹œê°„ëŒ€ì—ë„ ì–´ì œ ë©¤ë²„ í‘œì‹œë¡œ í™œê¸°ì°¬ ëŒ€ì‹œë³´ë“œ
- í™œë™ì´ ì ì€ ë‚ ì—ë„ ìµœê·¼ ë©¤ë²„ í‘œì‹œë¡œ ê³µí—ˆí•¨ ë°©ì§€

### 2. ì‹¤ì‹œê°„ ë™ê¸°ë¶€ì—¬
- ì˜¤ëŠ˜ ìš´ë™í•˜ë©´ ì¦‰ì‹œ "ğŸ”¥ Today" ë±ƒì§€ë¡œ ìµœìƒë‹¨ ë°°ì¹˜
- ë™ë£Œë“¤ì˜ ìµœê·¼ í™œë™ í™•ì¸ìœ¼ë¡œ ìš´ë™ ì˜ìš• ìƒìŠ¹

### 3. ëª…í™•í•œ ì‹œê°ì  êµ¬ë¶„
- ë±ƒì§€ì™€ ìƒ‰ìƒìœ¼ë¡œ í™œë™ ì‹œì  ì§ê´€ì  íŒŒì•…
- ë¶ˆíˆ¬ëª…ë„ë¡œ ìš°ì„ ìˆœìœ„ ìì—°ìŠ¤ëŸ½ê²Œ ì „ë‹¬

### 4. ìœ ì—°í•œ í™•ì¥ì„±
- activityType í•„ë“œë¡œ í–¥í›„ ë‹¤ì–‘í•œ ê¸°ê°„ ì¶”ê°€ ê°€ëŠ¥
  - 'this_week', 'last_week', 'this_month' ë“±

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì˜¤ì „ ì‹œê°„ëŒ€
- **Given**: ì˜¤ì „ 8ì‹œ, ì˜¤ëŠ˜ ìš´ë™í•œ ì‚¬ëŒ 0ëª…, ì–´ì œ 5ëª…
- **When**: ëŒ€ì‹œë³´ë“œ ì ‘ì†
- **Then**: ì–´ì œ 5ëª…ì´ âš¡ Yesterday ë±ƒì§€ì™€ í•¨ê»˜ í‘œì‹œë¨

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì²« ìš´ë™ ê¸°ë¡
- **Given**: ì˜¤ì „ 10ì‹œ, Charlieê°€ ì²« ìš´ë™ ê¸°ë¡
- **When**: ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
- **Then**: Charlieê°€ ğŸ”¥ Today ë±ƒì§€ë¡œ ìµœìƒë‹¨ì— í‘œì‹œë¨

### ì‹œë‚˜ë¦¬ì˜¤ 3: ì˜¤ëŠ˜ ë©¤ë²„ 4ëª… ì´ìƒ
- **Given**: ì˜¤ëŠ˜ ìš´ë™í•œ ì‚¬ëŒ 6ëª…, ì–´ì œ 3ëª…
- **When**: ëŒ€ì‹œë³´ë“œ ì ‘ì†
- **Then**: ì˜¤ëŠ˜ 6ëª…ë§Œ í‘œì‹œ (ì–´ì œ ë©¤ë²„ ìˆ¨ê¹€)

### ì‹œë‚˜ë¦¬ì˜¤ 4: ìµœê·¼ í™œë™ ì—†ìŒ
- **Given**: ì˜¤ëŠ˜+ì–´ì œ í™œë™ 0ëª…, ì¼ì£¼ì¼ ì „ í™œë™ 5ëª…
- **When**: ëŒ€ì‹œë³´ë“œ ì ‘ì†
- **Then**: ê°€ì¥ ìµœê·¼ í™œë™í•œ 3ëª… í‘œì‹œ

---

## ğŸ“ ë³€ê²½ëœ íŒŒì¼

### 1. src/utils/dashboardLogic.ts
- `SquadMember` ì¸í„°í˜ì´ìŠ¤ í™•ì¥
- `getSmartSquad()` í•¨ìˆ˜ ì¶”ê°€ (456ì¤„)
- `getTodaySquad()` í•¨ìˆ˜ deprecated í‘œì‹œ

### 2. src/pages/ClubDetail.tsx
- import ë³€ê²½: `getTodaySquad` â†’ `getSmartSquad`
- `DailySquad` ì»´í¬ë„ŒíŠ¸ ë¦¬íŒ©í† ë§ (800ì¤„)
  - ìŠ¤íƒ€ì¼ ì°¨ë³„í™”
  - ë±ƒì§€ ì‹œìŠ¤í…œ
  - ë™ì  ì„œë¸Œíƒ€ì´í‹€

### 3. docs/features/club_dashboard_widgets.md
- Daily Squad ì„¹ì…˜ ì—…ë°ì´íŠ¸
- Smart Active Squad ì•Œê³ ë¦¬ì¦˜ ì„¤ëª… ì¶”ê°€

---

## ğŸ”® í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„±

### 1. ì¶”ê°€ ê¸°ê°„ ì˜µì…˜
```typescript
activityType: 'today' | 'yesterday' | 'this_week' | 'last_week' | 'this_month'
```

### 2. ìŠ¤íŠ¸ë¦­(Streak) í‘œì‹œ
```typescript
interface SquadMember {
  // ...
  streakDays?: number; // ì—°ì† ìš´ë™ ì¼ìˆ˜
  streakIcon?: string; // ğŸ”¥ğŸ”¥ğŸ”¥ (3ì¼ ì—°ì†)
}
```

### 3. í™œë™ ê°•ë„ í‘œì‹œ
```typescript
interface SquadMember {
  // ...
  intensityLevel?: 'light' | 'moderate' | 'intense';
  totalVolume?: number;    // ì´ ë³¼ë¥¨
  totalDistance?: number;  // ì´ ê±°ë¦¬
}
```

### 4. ì†Œì…œ ê¸°ëŠ¥
- ë©¤ë²„ ì¹´ë“œ í´ë¦­ â†’ ìƒì„¸ í”„ë¡œí•„
- ì‘ì› ë©”ì‹œì§€ ì „ì†¡
- í•¨ê»˜ ìš´ë™ ì´ˆëŒ€

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] SquadMember íƒ€ì… í™•ì¥
- [x] getSmartSquad() í•¨ìˆ˜ êµ¬í˜„
- [x] ì˜¤ëŠ˜+ì–´ì œ+ìµœê·¼ í•„í„°ë§ ë¡œì§
- [x] ì¤‘ë³µ ì œê±° ë° ìµœì‹  ê¸°ë¡ ìš°ì„ 
- [x] DailySquad ì»´í¬ë„ŒíŠ¸ ë¦¬íŒ©í† ë§
- [x] Today/Yesterday ë±ƒì§€ êµ¬í˜„
- [x] ìŠ¤íƒ€ì¼ ì°¨ë³„í™” (ìƒ‰ìƒ, í…Œë‘ë¦¬, ë¶ˆíˆ¬ëª…ë„)
- [x] ë™ì  ì„œë¸Œíƒ€ì´í‹€
- [x] ë¹Œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼
- [x] ë¬¸ì„œ ì—…ë°ì´íŠ¸

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- [í´ëŸ½ ëŒ€ì‹œë³´ë“œ ìœ„ì ¯ ì‹œìŠ¤í…œ](./club_dashboard_widgets.md)
- [í´ëŸ½ ë°ì´í„° êµ¬ì¡°](./club_dashboard_data_structure.md)

---

**Status**: âœ… ì™„ë£Œ
**Build**: âœ… í†µê³¼ (717.75 kB)
**Type Check**: âœ… í†µê³¼
</file>

<file path="docs/guides/how_to_add_new_badge.md">
# ìƒˆë¡œìš´ ëª…ì˜ˆì˜ ì „ë‹¹ ë°°ì§€ ì¶”ê°€ ê°€ì´ë“œ

**ë‚œì´ë„**: â­â­ (ì¤‘ê¸‰)
**ì†Œìš” ì‹œê°„**: 10-15ë¶„
**ìˆ˜ì • íŒŒì¼**: `src/utils/dashboardLogic.ts` (1ê°œë§Œ!)

---

## ğŸ“‹ ê°œìš”

ëª…ì˜ˆì˜ ì „ë‹¹(Hall of Fame)ì— ìƒˆë¡œìš´ ë°°ì§€ë¥¼ ì¶”ê°€í•˜ëŠ” ë°©ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.
ëª¨ë“  ë¡œì§ì€ **`src/utils/dashboardLogic.ts`** íŒŒì¼ì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.

---

## ğŸ¯ 3ë‹¨ê³„ ì‘ì—… íë¦„

```
1. Helper í•¨ìˆ˜ ì‘ì„± (ë°°ì§€ ê³„ì‚° ë¡œì§)
   â†“
2. calculateHofBadges()ì— ì¶”ê°€ (ë©”ì¸ í•¨ìˆ˜ì— ë“±ë¡)
   â†“
3. í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
```

---

## ğŸ“ Step 1: Helper í•¨ìˆ˜ ì‘ì„±

### ìœ„ì¹˜
`src/utils/dashboardLogic.ts` íŒŒì¼ **ë ë¶€ë¶„**ì— ì¶”ê°€

### í…œí”Œë¦¿

```typescript
// Helper: [ë°°ì§€ ì´ë¦„] ([ì¡°ê±´ ì„¤ëª…])
const find[BadgeName] = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  // 1. ìœ ì €ë³„ ë°ì´í„° ì§‘ê³„ìš© Map ìƒì„±
  const userStats = new Map<
    string,
    { userName: string; userProfile: string | null; [metric]: number }
  >();

  // 2. ë¡œê·¸ë¥¼ ìˆœíšŒí•˜ë©° ìœ ì €ë³„ í†µê³„ ê³„ì‚°
  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userStats.get(log.userId) || {
      userName: log.userDisplayName,
      userProfile: log.userProfileImage || null,
      [metric]: 0,
    };

    // 3. ë°°ì§€ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë§Œ ì§‘ê³„
    // [ì—¬ê¸°ì— ì¡°ê±´ ë¡œì§ ì‘ì„±]

    userStats.set(log.userId, existing);
  });

  // 4. ìˆœìœ„ ê³„ì‚° (ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬)
  const rankings = Array.from(userStats.entries())
    .filter(([_, data]) => data.[metric] > 0)
    .sort((a, b) => b[1].[metric] - a[1].[metric]);

  if (rankings.length === 0) return null;

  // 5. 1ìœ„ ìœ ì € ì„ ì •
  const [userId, data] = rankings[0];

  // 6. HofBadge ê°ì²´ ë°˜í™˜
  return {
    userId,
    userName: data.userName,
    userProfile: data.userProfile,
    type: '[badge_type]', // 'strength' | 'cardio' | 'effort' | 'time' | 'consistency'
    title: '[ë°°ì§€ ì´ë¦„]',
    icon: '[ì´ëª¨ì§€]',
    description: `[ì„¤ëª… í…œí”Œë¦¿ ${data.[metric]}]`,
    value: `${data.[metric]}[ë‹¨ìœ„]`,
    isMe: userId === currentUserId,
    badgeId: `${userId}-[badge_id]`,
  };
};
```

---

## ğŸ’¡ ì‹¤ì „ ì˜ˆì‹œ: "ì£¼ë§ ì „ì‚¬" ë°°ì§€ ì¶”ê°€

### ìš”êµ¬ì‚¬í•­
- **ì¡°ê±´**: ì£¼ë§(í† ìš”ì¼+ì¼ìš”ì¼)ì— ê°€ì¥ ë§ì´ ìš´ë™í•œ ì‚¬ëŒ
- **íƒ€ì…**: `effort`
- **ì•„ì´ì½˜**: ğŸ–ï¸
- **ì„¤ëª…**: "ì£¼ë§ NíšŒ ìš´ë™"

### êµ¬í˜„ ì½”ë“œ

```typescript
// Helper: WeekendWarrior (ì£¼ë§ ìš´ë™ íšŸìˆ˜ 1ìœ„)
const findWeekendWarrior = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  const userWeekendCounts = new Map<
    string,
    { userName: string; userProfile: string | null; count: number }
  >();

  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    // ì£¼ë§ ì²´í¬ (0 = ì¼ìš”ì¼, 6 = í† ìš”ì¼)
    const dayOfWeek = new Date(log.createdAt).getDay();
    if (dayOfWeek !== 0 && dayOfWeek !== 6) return; // ì£¼ë§ ì•„ë‹ˆë©´ ìŠ¤í‚µ

    const existing = userWeekendCounts.get(log.userId) || {
      userName: log.userDisplayName,
      userProfile: log.userProfileImage || null,
      count: 0,
    };

    existing.count += log.workouts.length;
    userWeekendCounts.set(log.userId, existing);
  });

  const rankings = Array.from(userWeekendCounts.entries())
    .filter(([_, data]) => data.count > 0)
    .sort((a, b) => b[1].count - a[1].count);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    userName: data.userName,
    userProfile: data.userProfile,
    type: 'effort',
    title: 'ì£¼ë§ ì „ì‚¬',
    icon: 'ğŸ–ï¸',
    description: `ì£¼ë§ ${data.count}íšŒ ìš´ë™`,
    value: `${data.count}íšŒ`,
    isMe: userId === currentUserId,
    badgeId: `${userId}-weekendwarrior`,
  };
};
```

---

## ğŸ“ Step 2: calculateHofBadges()ì— ì¶”ê°€

### ìœ„ì¹˜
`src/utils/dashboardLogic.ts`ì˜ `calculateHofBadges()` í•¨ìˆ˜ ë‚´ë¶€

### ì¶”ê°€ ë°©ë²•

ê¸°ì¡´ ì½”ë“œ:
```typescript
export const calculateHofBadges = (
  members: WorkoutLog[],
  currentUserId?: string
): HofBadge[] => {
  // ì£¼ê°„ ë°ì´í„° í•„í„°ë§
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
  const weeklyLogs = members.filter((log) => new Date(log.createdAt) >= sevenDaysAgo);

  const badges: HofBadge[] = [];

  // 1. Workaholic
  const workaholic = findWorkaholic(weeklyLogs, currentUserId);
  if (workaholic) badges.push(workaholic);

  // ... ê¸°ì¡´ ë°°ì§€ë“¤ ...

  // 6. SlopeMaster
  const slopeMaster = findSlopeMaster(weeklyLogs, currentUserId);
  if (slopeMaster) badges.push(slopeMaster);

  // Me-first sorting
  return badges.sort((a, b) => {
    if (a.isMe && !b.isMe) return -1;
    if (!a.isMe && b.isMe) return 1;
    return 0;
  });
};
```

**ì—¬ê¸°ì— ì¶”ê°€:**
```typescript
  // 7. WeekendWarrior (ìƒˆë¡œ ì¶”ê°€!)
  const weekendWarrior = findWeekendWarrior(weeklyLogs, currentUserId);
  if (weekendWarrior) badges.push(weekendWarrior);
```

---

## ğŸ¨ ë°°ì§€ íƒ€ì…ë³„ ìƒ‰ìƒ ê°€ì´ë“œ

UIì—ì„œ ìë™ìœ¼ë¡œ íƒ€ì…ì— ë§ëŠ” ìƒ‰ìƒì´ ì ìš©ë©ë‹ˆë‹¤:

| type | ìƒ‰ìƒ | Hex | ìš©ë„ |
|------|------|-----|------|
| `strength` | Red | #ef4444 | ê·¼ë ¥ ê´€ë ¨ ë°°ì§€ |
| `cardio` | Blue | #3b82f6 | ìœ ì‚°ì†Œ ê´€ë ¨ ë°°ì§€ |
| `effort` | Yellow | #eab308 | ë…¸ë ¥/íšŸìˆ˜ ê´€ë ¨ ë°°ì§€ |
| `time` | Orange | #f97316 | ì‹œê°„ëŒ€ ê´€ë ¨ ë°°ì§€ |
| `consistency` | Purple | #8b5cf6 | ê¾¸ì¤€í•¨ ê´€ë ¨ ë°°ì§€ |

**ì„ íƒ ê°€ì´ë“œ**:
- ê·¼ë ¥ ìš´ë™ ì¤‘ì‹¬ â†’ `strength`
- ìœ ì‚°ì†Œ ìš´ë™ ì¤‘ì‹¬ â†’ `cardio`
- ìš´ë™ íšŸìˆ˜/ë¹ˆë„ â†’ `effort`
- íŠ¹ì • ì‹œê°„ëŒ€ â†’ `time`
- ì—°ì†ì„±/ìŠµê´€ â†’ `consistency`

---

## ğŸ“ Step 3: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ

### ë¹Œë“œ í…ŒìŠ¤íŠ¸

```bash
npm run build
```

**í™•ì¸ ì‚¬í•­**:
- âœ… TypeScript ì—ëŸ¬ ì—†ìŒ
- âœ… ë¹Œë“œ ì„±ê³µ

### ì‹¤í–‰ í…ŒìŠ¤íŠ¸

```bash
npm run dev
```

**í™•ì¸ ì‚¬í•­**:
1. í´ëŸ½ ëŒ€ì‹œë³´ë“œ ì ‘ì†
2. Hall of Fame ìœ„ì ¯ í™•ì¸
3. ìƒˆ ë°°ì§€ê°€ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
4. Me ì¹´ë“œê°€ ë§¨ ì•ì— ì˜¤ëŠ”ì§€ í™•ì¸

---

## ğŸ” ë””ë²„ê¹… íŒ

### ë°°ì§€ê°€ ì•ˆ ë‚˜ì˜¬ ë•Œ

```typescript
// Helper í•¨ìˆ˜ì— ì½˜ì†” ë¡œê·¸ ì¶”ê°€
const findWeekendWarrior = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  console.log('[WeekendWarrior] ë¡œê·¸ ìˆ˜:', logs.length);

  const userWeekendCounts = new Map();

  logs.forEach((log) => {
    const dayOfWeek = new Date(log.createdAt).getDay();
    console.log('[WeekendWarrior] ìš”ì¼:', dayOfWeek, log.userDisplayName);
    // ...
  });

  console.log('[WeekendWarrior] ì§‘ê³„ ê²°ê³¼:', Array.from(userWeekendCounts.entries()));
  // ...
};
```

### ì£¼ê°„ ë°ì´í„°ê°€ ë¶€ì¡±í•  ë•Œ

```typescript
// í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ê¸°ê°„ í™•ì¥
const thirtyDaysAgo = new Date();
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); // 7 â†’ 30ì¼ë¡œ ë³€ê²½
const weeklyLogs = members.filter((log) => new Date(log.createdAt) >= thirtyDaysAgo);
```

---

## ğŸ’¡ ë°°ì§€ ì•„ì´ë””ì–´ ëª¨ìŒ

### 1. í‰ì¼ ì „ì‚¬
- **ì¡°ê±´**: í‰ì¼(ì›”-ê¸ˆ) ìš´ë™ íšŸìˆ˜ 1ìœ„
- **type**: `effort`
- **icon**: ğŸ’¼

### 2. ì ì‹¬ ì‹œê°„ íŒŒì´í„°
- **ì¡°ê±´**: 12-14ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„
- **type**: `time`
- **icon**: ğŸ±

### 3. ì² ì¸
- **ì¡°ê±´**: 7ì¼ ì—°ì† ì¶œì„
- **type**: `consistency`
- **icon**: ğŸ›¡ï¸

### 4. ë§ˆë¼í† ë„ˆ
- **ì¡°ê±´**: ì´ ê±°ë¦¬ 42.195km ì´ìƒ ë‹¬ì„±
- **type**: `cardio`
- **icon**: ğŸ…

### 5. íŒŒì›Œë¦¬í”„í„°
- **ì¡°ê±´**: ë‹¨ì¼ ì„¸íŠ¸ ìµœëŒ€ ë¬´ê²Œ
- **type**: `strength`
- **icon**: âš¡

### 6. ë‹¤ì¬ë‹¤ëŠ¥
- **ì¡°ê±´**: 5ê°€ì§€ ì´ìƒ ì¹´í…Œê³ ë¦¬ ìš´ë™
- **type**: `effort`
- **icon**: ğŸ¨

### 7. ìŠ¤í”¼ë“œìŠ¤í„°
- **ì¡°ê±´**: ê°€ì¥ ë¹ ë¥¸ í˜ì´ìŠ¤(min/km)
- **type**: `cardio`
- **icon**: ğŸ’¨

### 8. ê·¼ì„±ì™•
- **ì¡°ê±´**: ê°€ì¥ ê¸´ ìš´ë™ ì‹œê°„ (ë‹¨ì¼ ì„¸ì…˜)
- **type**: `consistency`
- **icon**: ğŸ’ª

---

## ğŸ“Š ë³µì¡í•œ ì¡°ê±´ ì˜ˆì‹œ

### ì˜ˆì‹œ 1: ë³µí•© ì¡°ê±´ (AND)

"ìƒˆë²½ + ì£¼ë§" ë°°ì§€:

```typescript
const findEarlyWeekend = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  const userCounts = new Map();

  logs.forEach((log) => {
    const hour = new Date(log.createdAt).getHours();
    const dayOfWeek = new Date(log.createdAt).getDay();

    // ìƒˆë²½(4-8ì‹œ) AND ì£¼ë§(í† ìš”ì¼ ë˜ëŠ” ì¼ìš”ì¼)
    if ((hour >= 4 && hour < 8) && (dayOfWeek === 0 || dayOfWeek === 6)) {
      // ì§‘ê³„ ë¡œì§
    }
  });
  // ...
};
```

### ì˜ˆì‹œ 2: ìµœëŒ“ê°’ ì°¾ê¸°

"ê°€ì¥ ë¬´ê±°ìš´ ì„¸íŠ¸" ë°°ì§€:

```typescript
const findHeaviestLift = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  let heaviest = { userId: '', userName: '', userProfile: null, weight: 0 };

  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    log.workouts.forEach((workout) => {
      if (workout.type === 'strength' && workout.weight_kg) {
        if (workout.weight_kg > heaviest.weight) {
          heaviest = {
            userId: log.userId!,
            userName: log.userDisplayName!,
            userProfile: log.userProfileImage || null,
            weight: workout.weight_kg,
          };
        }
      }
    });
  });

  if (heaviest.weight === 0) return null;

  return {
    userId: heaviest.userId,
    userName: heaviest.userName,
    userProfile: heaviest.userProfile,
    type: 'strength',
    title: 'ì›í€ë§¨',
    icon: 'ğŸ‘Š',
    description: `ìµœëŒ€ ${heaviest.weight}kg ë¦¬í”„íŒ…`,
    value: `${heaviest.weight}kg`,
    isMe: heaviest.userId === currentUserId,
    badgeId: `${heaviest.userId}-heaviest`,
  };
};
```

### ì˜ˆì‹œ 3: ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„

"ì¢…ëª© ë§ˆìŠ¤í„°" ë°°ì§€ (ê°€ì¥ ë§ì€ ì¹´í…Œê³ ë¦¬ ìš´ë™):

```typescript
const findCategoryMaster = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  const userCategories = new Map<string, {
    userName: string;
    userProfile: string | null;
    categories: Set<string>
  }>();

  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userCategories.get(log.userId) || {
      userName: log.userDisplayName,
      userProfile: log.userProfileImage || null,
      categories: new Set<string>(),
    };

    log.workouts.forEach((workout) => {
      existing.categories.add(workout.category);
    });

    userCategories.set(log.userId, existing);
  });

  const rankings = Array.from(userCategories.entries())
    .filter(([_, data]) => data.categories.size > 0)
    .sort((a, b) => b[1].categories.size - a[1].categories.size);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    userName: data.userName,
    userProfile: data.userProfile,
    type: 'effort',
    title: 'ì¢…ëª© ë§ˆìŠ¤í„°',
    icon: 'ğŸ¯',
    description: `${data.categories.size}ê°€ì§€ ì¢…ëª© ì •ë³µ`,
    value: `${data.categories.size}ì¢…ëª©`,
    isMe: userId === currentUserId,
    badgeId: `${userId}-categorymaster`,
  };
};
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

ë°°ì§€ ì¶”ê°€ ì‹œ ë‹¤ìŒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”:

- [ ] Helper í•¨ìˆ˜ ì‘ì„± (`find[BadgeName]`)
- [ ] `calculateHofBadges()`ì— ì¶”ê°€
- [ ] ì ì ˆí•œ `type` ì„ íƒ (ìƒ‰ìƒ ë§¤í•‘)
- [ ] ê³ ìœ í•œ `badgeId` ìƒì„±
- [ ] `isMe` í”Œë˜ê·¸ ì„¤ì •
- [ ] ê°’ì´ 0ì¸ ê²½ìš° `null` ë°˜í™˜
- [ ] TypeScript íƒ€ì… ì—ëŸ¬ ì—†ìŒ
- [ ] ë¹Œë“œ ì„±ê³µ (`npm run build`)
- [ ] ì‹¤ì œ í…ŒìŠ¤íŠ¸ (dev í™˜ê²½)

---

## ğŸš¨ ì£¼ì˜ì‚¬í•­

### 1. ê³ ìœ  badgeId ì‚¬ìš©

```typescript
// âŒ ì˜ëª»ëœ ì˜ˆ
badgeId: `${userId}-workaholic` // ê¸°ì¡´ ë°°ì§€ì™€ ì¤‘ë³µ ê°€ëŠ¥

// âœ… ì˜¬ë°”ë¥¸ ì˜ˆ
badgeId: `${userId}-weekendwarrior` // ê³ ìœ í•œ ID
```

### 2. null ì²´í¬

```typescript
// âŒ ê°’ì´ 0ì´ì–´ë„ ë°°ì§€ ë°˜í™˜
if (rankings.length === 0) return null;
const [userId, data] = rankings[0];
return { ... }; // data.countê°€ 0ì¼ ìˆ˜ ìˆìŒ!

// âœ… ê°’ì´ 0ì´ë©´ ë°°ì§€ ë°˜í™˜ ì•ˆ í•¨
const rankings = Array.from(userStats.entries())
  .filter(([_, data]) => data.count > 0) // 0 ì œì™¸
  .sort(...);
```

### 3. ì£¼ê°„ ë°ì´í„° í•„í„°ë§

```typescript
// calculateHofBadges()ì—ì„œ ì´ë¯¸ í•„í„°ë§ë¨
const weeklyLogs = members.filter(log => ...);

// Helper í•¨ìˆ˜ì—ì„œëŠ” weeklyLogsë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
const findMyBadge = (logs: WorkoutLog[], ...) => {
  // logsëŠ” ì´ë¯¸ ì£¼ê°„ ë°ì´í„°ì„!
};
```

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- [Hall of Fame Carousel êµ¬í˜„](../features/hall_of_fame_carousel.md)
- [í´ëŸ½ ëŒ€ì‹œë³´ë“œ ìœ„ì ¯ ì‹œìŠ¤í…œ](../features/club_dashboard_widgets.md)
- [ë°ì´í„° êµ¬ì¡° ë¬¸ì„œ](../features/club_dashboard_data_structure.md)

---

## ğŸ¤ ê¸°ì—¬ ê°€ì´ë“œ

ìƒˆë¡œìš´ ë°°ì§€ë¥¼ ì¶”ê°€í–ˆë‹¤ë©´:

1. ì´ ê°€ì´ë“œ ë¬¸ì„œì˜ "ë°°ì§€ ì•„ì´ë””ì–´ ëª¨ìŒ"ì— ì¶”ê°€
2. êµ¬í˜„ ì˜ˆì‹œ ì‘ì„±
3. Pull Request ìƒì„±

---

**Last Updated**: 2026-01-21
**Difficulty**: â­â­ (Intermediate)
</file>

<file path="docs/PROJECT_OVERVIEW.md">
# Voice Workout Log - Project Overview

## í”„ë¡œì íŠ¸ ê°œìš”

Voice Workout LogëŠ” **ìŒì„± ì¸ì‹ ê¸°ë°˜ ìš´ë™ ê¸°ë¡ ê´€ë¦¬ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜**ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìŒì„±ìœ¼ë¡œ ìš´ë™ ë‚´ì—­ì„ ì…ë ¥í•˜ë©´ AIê°€ ì´ë¥¼ íŒŒì‹±í•˜ì—¬ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¡œ ì €ì¥í•˜ê³ , í†µê³„ ë° ì¶”ì²œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

### í•µì‹¬ ê°€ì¹˜ ì œì•ˆ
- **ë¹ ë¥¸ ì…ë ¥**: ìŒì„±ìœ¼ë¡œ ìš´ë™ì„ ê¸°ë¡í•˜ì—¬ ì…ë ¥ ì‹œê°„ ë‹¨ì¶•
- **AI íŒŒì‹±**: ìì—°ì–´ë¥¼ êµ¬ì¡°í™”ëœ ìš´ë™ ë°ì´í„°ë¡œ ìë™ ë³€í™˜
- **ê°œì¸í™”**: ì‚¬ìš©ìë³„ ìš´ë™ ëª©í‘œ ë° ì¶”ì²œ ì‹œìŠ¤í…œ
- **ì¹´ì¹´ì˜¤ í†µí•©**: ê°„í¸í•œ ì†Œì…œ ë¡œê·¸ì¸

---

## ì£¼ìš” ê¸°ëŠ¥

### 1. ìŒì„± ì…ë ¥ ë° AI íŒŒì‹±
- **Web Speech API**: ë¸Œë¼ìš°ì € ë‚´ì¥ ìŒì„± ì¸ì‹ (ê¸°ë³¸)
- **Whisper API**: OpenAI Whisperë¥¼ í†µí•œ ê³ ê¸‰ ìŒì„± ì¸ì‹ (ì˜µì…˜)
- **AI í…ìŠ¤íŠ¸ íŒŒì‹±**: GPT ë˜ëŠ” Geminiê°€ ìì—°ì–´ë¥¼ ìš´ë™ ë°ì´í„°ë¡œ ë³€í™˜
  - ì˜ˆ: "ë²¤ì¹˜í”„ë ˆìŠ¤ 80í‚¤ë¡œ 10ê°œì”© 3ì„¸íŠ¸ í–ˆì–´" â†’ êµ¬ì¡°í™”ëœ Workout ê°ì²´

### 2. ìš´ë™ ê¸°ë¡ ê´€ë¦¬
- ìš´ë™ ê¸°ë¡ ì €ì¥ ë° ì¡°íšŒ (CRUD)
- ë‚ ì§œë³„ ìš´ë™ ë‚´ì—­ ì¡°íšŒ
- ìš´ë™ íƒ€ì…ë³„ ë¶„ë¥˜ (ê·¼ë ¥, ìœ ì‚°ì†Œ, ìŠ¤íŠ¸ë ˆì¹­, ìŠ¤í¬ì¸ )

### 3. ëŒ€ì‹œë³´ë“œ ë° í†µê³„
- ì›”ë³„ ìš´ë™ í†µê³„ (ì´ ìš´ë™ ì¼ìˆ˜, ì‹œê°„, ë³¼ë¥¨ ë“±)
- ìº˜ë¦°ë” ë·°: ìš´ë™í•œ ë‚ ì§œ ì‹œê°í™”
- ìš´ë™ íƒ€ì…ë³„ ë¶„í¬ ì°¨íŠ¸

### 4. AI ê¸°ë°˜ ìš´ë™ ì¶”ì²œ
- ì‚¬ìš©ìì˜ ìš´ë™ ì´ë ¥ ë° ëª©í‘œë¥¼ ê¸°ë°˜ìœ¼ë¡œ AIê°€ ë§ì¶¤ ì¶”ì²œ
- ì˜¤ëŠ˜ì˜ ì¶”ì²œ ìš´ë™ ë£¨í‹´ ìƒì„±

### 5. ì¼ì¼ ìš´ë™ ëª©í‘œ ê´€ë¦¬ (Todo List)
- AI ì¶”ì²œ ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì˜¤ëŠ˜ì˜ ìš´ë™ ëª©í‘œ ì„¤ì •
- ìš´ë™ ì™„ë£Œ ì²´í¬ ë° ì§„í–‰ë¥  ì¶”ì 

### 6. ì¸ì¦ ì‹œìŠ¤í…œ
- Kakao OAuth ê¸°ë°˜ ì†Œì…œ ë¡œê·¸ì¸
- íšŒì›ê°€ì… ì‹œ ì„±ë³„, ìš´ë™ ëª©í‘œ ì…ë ¥
- Supabase Auth í†µí•©

---

## ê¸°ìˆ  ìŠ¤íƒ

### í”„ë¡ íŠ¸ì—”ë“œ
- **React 19.2.0**: UI ë¼ì´ë¸ŒëŸ¬ë¦¬
- **TypeScript**: íƒ€ì… ì•ˆì •ì„±
- **Vite**: ë¹Œë“œ ë„êµ¬ ë° ê°œë°œ ì„œë²„
- **React Router v7**: SPA ë¼ìš°íŒ…

### ë°±ì—”ë“œ & ì¸í”„ë¼
- **Supabase**:
  - PostgreSQL ë°ì´í„°ë² ì´ìŠ¤
  - Row Level Security (RLS) ê¸°ë°˜ ë³´ì•ˆ
  - Auth (ì†Œì…œ ë¡œê·¸ì¸ í†µí•©)
  - Real-time ê¸°ëŠ¥ (í˜„ì¬ ë¯¸ì‚¬ìš©, í–¥í›„ í´ëŸ½ ê¸°ëŠ¥ì— í™œìš© ê°€ëŠ¥)

### AI & ìŒì„± ì¸ì‹
- **Google Generative AI (Gemini)**: í…ìŠ¤íŠ¸ íŒŒì‹± ë° ìš´ë™ ì¶”ì²œ
- **OpenAI API**:
  - GPT-4: í…ìŠ¤íŠ¸ íŒŒì‹± (ëŒ€ì²´ ì˜µì…˜)
  - Whisper: ìŒì„±-í…ìŠ¤íŠ¸ ë³€í™˜ (ê³ ê¸‰ ê¸°ëŠ¥)
- **Web Speech API**: ë¸Œë¼ìš°ì € ë‚´ì¥ ìŒì„± ì¸ì‹ (ê¸°ë³¸ ê¸°ëŠ¥)

### ì¸ì¦
- **Kakao OAuth 2.0**: ì†Œì…œ ë¡œê·¸ì¸

---

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
voice-workout-log/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/         # ì¬ì‚¬ìš© ê°€ëŠ¥í•œ UI ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”œâ”€â”€ BottomNav.tsx   # í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°”
â”‚   â”‚   â”œâ”€â”€ Header.tsx      # ìƒë‹¨ í—¤ë” (í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´)
â”‚   â”‚   â”œâ”€â”€ KakaoLogin.tsx  # ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼
â”‚   â”‚   â””â”€â”€ KakaoCallback.tsx # ì¹´ì¹´ì˜¤ OAuth ì½œë°± í•¸ë“¤ëŸ¬
â”‚   â”‚
â”‚   â”œâ”€â”€ pages/              # ë¼ìš°íŠ¸ë³„ í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”œâ”€â”€ Login.tsx       # ë¡œê·¸ì¸ í˜ì´ì§€
â”‚   â”‚   â”œâ”€â”€ Signup.tsx      # íšŒì›ê°€ì… í˜ì´ì§€
â”‚   â”‚   â”œâ”€â”€ Dashboard.tsx   # ëŒ€ì‹œë³´ë“œ (í†µê³„ + ìº˜ë¦°ë”)
â”‚   â”‚   â”œâ”€â”€ History.tsx     # ìš´ë™ ê¸°ë¡ ì´ë ¥ ë° ì¶”ê°€
â”‚   â”‚   â”œâ”€â”€ TodoList.tsx    # ì¼ì¼ ìš´ë™ ëª©í‘œ ê´€ë¦¬
â”‚   â”‚   â”œâ”€â”€ Recommend.tsx   # AI ìš´ë™ ì¶”ì²œ
â”‚   â”‚   â”œâ”€â”€ PrivacyPolicy.tsx
â”‚   â”‚   â””â”€â”€ TermsOfService.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ features/           # ê¸°ëŠ¥ë³„ ëª¨ë“ˆ
â”‚   â”‚   â”œâ”€â”€ speech/         # ìŒì„± ì¸ì‹ ê´€ë ¨
â”‚   â”‚   â”‚   â”œâ”€â”€ useSpeechRecognition.ts  # Web Speech API í›…
â”‚   â”‚   â”‚   â””â”€â”€ useWhisperRecording.ts   # Whisper ë…¹ìŒ í›…
â”‚   â”‚   â”œâ”€â”€ parse/          # AI í…ìŠ¤íŠ¸ íŒŒì‹±
â”‚   â”‚   â”‚   â”œâ”€â”€ parseWorkoutText.ts      # ë©”ì¸ íŒŒì‹± ë¡œì§
â”‚   â”‚   â”‚   â””â”€â”€ parseWithGPT.ts          # GPT/Gemini íŒŒì‹±
â”‚   â”‚   â””â”€â”€ normalize/
â”‚   â”‚       â””â”€â”€ normalizeText.ts         # í…ìŠ¤íŠ¸ ì •ê·œí™”
â”‚   â”‚
â”‚   â”œâ”€â”€ services/           # ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™
â”‚   â”‚   â””â”€â”€ authService.ts  # ì¸ì¦ ì„œë¹„ìŠ¤ (Kakao + Supabase)
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/            # ë°ì´í„° ì €ì¥ì†Œ ê³„ì¸µ
â”‚   â”‚   â”œâ”€â”€ supabaseStorage.ts  # Supabase CRUD ì‘ì—…
â”‚   â”‚   â””â”€â”€ logStorage.ts       # (ë ˆê±°ì‹œ/ë¡œì»¬) ìŠ¤í† ë¦¬ì§€
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/              # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
â”‚   â”‚   â”œâ”€â”€ ai.ts           # AI ê³µí†µ ìœ í‹¸
â”‚   â”‚   â”œâ”€â”€ gemini.ts       # Gemini API ë˜í¼
â”‚   â”‚   â””â”€â”€ openai.ts       # OpenAI API ë˜í¼
â”‚   â”‚
â”‚   â”œâ”€â”€ contexts/           # React Context
â”‚   â”‚   â””â”€â”€ AuthContext.tsx # ì¸ì¦ ìƒíƒœ ê´€ë¦¬
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                # ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ˆê¸°í™”
â”‚   â”‚   â””â”€â”€ supabase.ts     # Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
â”‚   â”‚
â”‚   â”œâ”€â”€ types/              # TypeScript íƒ€ì… ì •ì˜
â”‚   â”‚   â”œâ”€â”€ index.ts        # ì£¼ìš” ë„ë©”ì¸ íƒ€ì…
â”‚   â”‚   â””â”€â”€ speech.d.ts     # Web Speech API íƒ€ì…
â”‚   â”‚
â”‚   â”œâ”€â”€ config/             # ì„¤ì • íŒŒì¼
â”‚   â”‚   â””â”€â”€ features.ts     # ê¸°ëŠ¥ í”Œë˜ê·¸
â”‚   â”‚
â”‚   â”œâ”€â”€ App.tsx             # ë©”ì¸ ì•± ì»´í¬ë„ŒíŠ¸ (ë¼ìš°íŒ…)
â”‚   â””â”€â”€ main.tsx            # ì•± ì§„ì…ì 
â”‚
â”œâ”€â”€ docs/                   # í”„ë¡œì íŠ¸ ë¬¸ì„œ
â”‚   â”œâ”€â”€ README.md           # ë¬¸ì„œ ë„¤ë¹„ê²Œì´ì…˜
â”‚   â”œâ”€â”€ PROJECT_OVERVIEW.md # ì´ íŒŒì¼
â”‚   â”œâ”€â”€ ARCHITECTURE.md     # ì•„í‚¤í…ì²˜ ìƒì„¸ ì„¤ëª…
â”‚   â””â”€â”€ database/
â”‚       â”œâ”€â”€ schema.sql      # ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ
â”‚       â””â”€â”€ migrations/     # ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
â”‚
â”œâ”€â”€ public/                 # ì •ì  íŒŒì¼
â”œâ”€â”€ .env                    # í™˜ê²½ ë³€ìˆ˜ (API í‚¤ ë“±)
â””â”€â”€ package.json            # í”„ë¡œì íŠ¸ ì˜ì¡´ì„±
```

---

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### ì£¼ìš” í…Œì´ë¸”

#### 1. users
ì‚¬ìš©ì ì •ë³´ (Supabase Authì™€ ì—°ë™)
- `id` (UUID, PK): Supabase Auth ì‚¬ìš©ì ID
- `kakao_id` (BIGINT, UNIQUE): ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ID
- `email` (TEXT): ì´ë©”ì¼
- `name` (TEXT): ì´ë¦„
- `gender` (TEXT): ì„±ë³„ (male/female/other)
- `created_at` (TIMESTAMPTZ): ê°€ì…ì¼

#### 2. workout_logs
ìš´ë™ ê¸°ë¡ ë¡œê·¸ (ì¼ë³„ ë‹¨ìœ„)
- `id` (UUID, PK): ë¡œê·¸ ID
- `user_id` (UUID, FK â†’ users): ì‚¬ìš©ì ID
- `date` (DATE): ìš´ë™ ë‚ ì§œ
- `raw_text` (TEXT): ì›ë³¸ ì…ë ¥ í…ìŠ¤íŠ¸
- `normalized_text` (TEXT): ì •ê·œí™”ëœ í…ìŠ¤íŠ¸
- `memo` (TEXT): ë©”ëª¨
- `created_at` (TIMESTAMPTZ): ìƒì„±ì¼

#### 3. workouts
ê°œë³„ ìš´ë™ ìƒì„¸ ì •ë³´ (ìš´ë™ ë¡œê·¸ ë‚´ ê° ìš´ë™)
- `id` (UUID, PK): ìš´ë™ ID
- `log_id` (UUID, FK â†’ workout_logs): ë¡œê·¸ ID
- `name` (TEXT): ìš´ë™ ì´ë¦„ (ì˜ˆ: ë²¤ì¹˜í”„ë ˆìŠ¤)
- `type` (TEXT): ìš´ë™ íƒ€ì… (strength/cardio/stretching/sports)
- `sets` (INT): ì„¸íŠ¸ ìˆ˜
- `reps` (INT): ë°˜ë³µ íšŸìˆ˜
- `weight_kg` (DECIMAL): ì¤‘ëŸ‰ (kg)
- `duration_min` (INT): ìš´ë™ ì‹œê°„ (ë¶„)
- `note` (TEXT): ìš´ë™ë³„ ë…¸íŠ¸
- `created_at` (TIMESTAMPTZ): ìƒì„±ì¼

#### 4. user_profiles
ì‚¬ìš©ì ìš´ë™ ëª©í‘œ ë° í”„ë¡œí•„
- `user_id` (UUID, PK, FK â†’ users): ì‚¬ìš©ì ID
- `goals` (TEXT): ìš´ë™ ëª©í‘œ
- `current_weight_kg` (DECIMAL): í˜„ì¬ ì²´ì¤‘
- `target_weight_kg` (DECIMAL): ëª©í‘œ ì²´ì¤‘
- `height_cm` (DECIMAL): í‚¤
- `weekly_workout_days` (INT): ì£¼ê°„ ëª©í‘œ ìš´ë™ì¼
- `updated_at` (TIMESTAMPTZ): ìˆ˜ì •ì¼

### ë³´ì•ˆ: Row Level Security (RLS)
ëª¨ë“  í…Œì´ë¸”ì— RLS ì •ì±… ì ìš©:
- ì‚¬ìš©ìëŠ” **ìì‹ ì˜ ë°ì´í„°ë§Œ** ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
- `auth.uid() = user_id` ì¡°ê±´ìœ¼ë¡œ ê²©ë¦¬

ìƒì„¸ ìŠ¤í‚¤ë§ˆëŠ” `docs/database/schema.sql` ì°¸ì¡°

---

## ì£¼ìš” ë°ì´í„° í”Œë¡œìš°

### 1. ìš´ë™ ê¸°ë¡ ì…ë ¥ í”Œë¡œìš°
```
ì‚¬ìš©ì ìŒì„± ì…ë ¥
  â†“
ìŒì„± ì¸ì‹ (Web Speech API / Whisper)
  â†“
í…ìŠ¤íŠ¸ ë³€í™˜
  â†“
í…ìŠ¤íŠ¸ ì •ê·œí™” (normalizeText)
  â†“
AI íŒŒì‹± (Gemini/GPT) â†’ êµ¬ì¡°í™”ëœ Workout ê°ì²´ ë°°ì—´
  â†“
Supabase ì €ì¥ (workout_logs + workouts)
```

### 2. ìš´ë™ ì¶”ì²œ í”Œë¡œìš°
```
ì‚¬ìš©ì ìš”ì²­
  â†“
ì‚¬ìš©ì í”„ë¡œí•„ + ìµœê·¼ ìš´ë™ ì´ë ¥ ì¡°íšŒ
  â†“
Gemini/GPTì— ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬
  â†“
AIê°€ ë§ì¶¤ ìš´ë™ ë£¨í‹´ ìƒì„±
  â†“
ì‚¬ìš©ìì—ê²Œ í‘œì‹œ (Todoë¡œ ì €ì¥ ê°€ëŠ¥)
```

### 3. ì¸ì¦ í”Œë¡œìš°
```
Kakao ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
  â†“
Kakao OAuth ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
  â†“
ì‚¬ìš©ì ë™ì˜ í›„ ì½œë°±
  â†“
Access Tokenìœ¼ë¡œ Kakao ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
  â†“
Supabaseì— ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  â†“
ì‹ ê·œ ì‚¬ìš©ì â†’ íšŒì›ê°€ì… í˜ì´ì§€
ê¸°ì¡´ ì‚¬ìš©ì â†’ Supabase ì„¸ì…˜ ìƒì„± í›„ ëŒ€ì‹œë³´ë“œ
```

---

## í™˜ê²½ ë³€ìˆ˜ (.env)

```env
# Supabase
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# Kakao OAuth
VITE_KAKAO_CLIENT_ID=your-kakao-client-id
VITE_KAKAO_REDIRECT_URI=http://localhost:5173/auth/kakao/callback

# AI APIs
VITE_GEMINI_API_KEY=your-gemini-api-key
VITE_OPENAI_API_KEY=your-openai-api-key
```

---

## API ì—”ë“œí¬ì¸íŠ¸ (Supabase)

### Storage Layer (supabaseStorage.ts)

#### ìš´ë™ ê¸°ë¡ ê´€ë ¨
- `getAllLogs(userId: string)`: ì‚¬ìš©ìì˜ ëª¨ë“  ìš´ë™ ê¸°ë¡ ì¡°íšŒ
- `getLogById(logId: string)`: íŠ¹ì • ë¡œê·¸ ìƒì„¸ ì¡°íšŒ
- `saveLog(log: WorkoutLog)`: ìš´ë™ ê¸°ë¡ ì €ì¥ (log + workouts)
- `deleteLog(logId: string)`: ìš´ë™ ê¸°ë¡ ì‚­ì œ

#### ì‚¬ìš©ì í”„ë¡œí•„ ê´€ë ¨
- `getUserProfile(userId: string)`: ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ
- `saveUserProfile(profile: UserProfile)`: í”„ë¡œí•„ ì €ì¥/ìˆ˜ì •
- `deleteUserProfile(userId: string)`: í”„ë¡œí•„ ì‚­ì œ

### Auth Service (authService.ts)

- `getKakaoUserInfo(accessToken: string)`: Kakao APIë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
- `checkUserExistsByKakaoId(kakaoId: string)`: ì¹´ì¹´ì˜¤ IDë¡œ ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- `registerKakaoUser(userData: KakaoUserData)`: ì¹´ì¹´ì˜¤ ì‚¬ìš©ì íšŒì›ê°€ì…
- `getUserByKakaoId(kakaoId: string)`: ì¹´ì¹´ì˜¤ IDë¡œ ì‚¬ìš©ì ì¡°íšŒ
- `updateUserProfile(userId: string, updates: Partial<User>)`: ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •

---

## ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤

### ë„¤ë¹„ê²Œì´ì…˜ êµ¬ì¡°
í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” (BottomNav):
1. **ëŒ€ì‹œë³´ë“œ**: í†µê³„ + ìº˜ë¦°ë”
2. **ê¸°ë¡**: ìš´ë™ ê¸°ë¡ ì¶”ê°€ ë° ì¡°íšŒ
3. **íˆ¬ë‘**: ì˜¤ëŠ˜ì˜ ìš´ë™ ëª©í‘œ
4. **ì¶”ì²œ**: AI ìš´ë™ ì¶”ì²œ

### ì£¼ìš” í™”ë©´

#### Login.tsx
- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼
- ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ / ì´ìš©ì•½ê´€ ë§í¬

#### Signup.tsx
- ì¹´ì¹´ì˜¤ ì¸ì¦ í›„ ì¶”ê°€ ì •ë³´ ì…ë ¥
- ì„±ë³„, ìš´ë™ ëª©í‘œ ì…ë ¥ í›„ íšŒì›ê°€ì… ì™„ë£Œ

#### Dashboard.tsx
- ì´ë²ˆ ë‹¬ ìš´ë™ í†µê³„ (ì¼ìˆ˜, ì‹œê°„, ë³¼ë¥¨ ë“±)
- ìº˜ë¦°ë”: ìš´ë™í•œ ë‚ ì§œ í‘œì‹œ
- ìš´ë™ íƒ€ì…ë³„ ë¶„í¬ ì°¨íŠ¸

#### History.tsx
- ë‚ ì§œë³„ ìš´ë™ ê¸°ë¡ ëª©ë¡
- ìŒì„± ì…ë ¥ ë²„íŠ¼ (Web Speech / Whisper ì„ íƒ ê°€ëŠ¥)
- ê¸°ë¡ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ

#### TodoList.tsx
- ì˜¤ëŠ˜ì˜ ìš´ë™ ëª©í‘œ ëª©ë¡
- AI ì¶”ì²œìœ¼ë¡œ ìë™ ìƒì„± ë˜ëŠ” ìˆ˜ë™ ì¶”ê°€
- ì™„ë£Œ ì²´í¬ ê¸°ëŠ¥

#### Recommend.tsx
- AIê°€ ìƒì„±í•œ ë§ì¶¤ ìš´ë™ ë£¨í‹´
- ë£¨í‹´ì„ íˆ¬ë‘ë¡œ ì¶”ê°€ ê°€ëŠ¥

---

## ì½”ë“œ ì»¨ë²¤ì…˜ ë° íŒ¨í„´

### íƒ€ì… ì •ì˜
ëª¨ë“  ë„ë©”ì¸ ëª¨ë¸ì€ `src/types/index.ts`ì— ì •ì˜:
- `User`, `WorkoutLog`, `Workout`, `UserProfile`, `DailyTodo` ë“±

### ìƒíƒœ ê´€ë¦¬
- React Context (AuthContext): ì¸ì¦ ìƒíƒœ ì „ì—­ ê´€ë¦¬
- ë¡œì»¬ ìƒíƒœ: `useState`, `useEffect`
- ì„œë²„ ìƒíƒœ: Supabase ì§ì ‘ í˜¸ì¶œ (í–¥í›„ React Query ë„ì… ê³ ë ¤ ê°€ëŠ¥)

### ì—ëŸ¬ ì²˜ë¦¬
- ì£¼ìš” API í˜¸ì¶œì€ try-catchë¡œ ê°ì‹¸ê¸°
- ì‚¬ìš©ìì—ê²Œ ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
- ì½˜ì†”ì— ìƒì„¸ ì—ëŸ¬ ë¡œê·¸

### ì½”ë“œ ìŠ¤íƒ€ì¼
- ESLint + TypeScript ESLint ì‚¬ìš©
- í•¨ìˆ˜í˜• ì»´í¬ë„ŒíŠ¸ + Hooks
- ëª…í™•í•œ ë³€ìˆ˜ëª… ë° í•¨ìˆ˜ëª… ì‚¬ìš©

---

## í˜„ì¬ êµ¬í˜„ ìƒíƒœ

### âœ… ì™„ë£Œëœ ê¸°ëŠ¥
- [x] Kakao OAuth ë¡œê·¸ì¸/íšŒì›ê°€ì…
- [x] ìŒì„± ì¸ì‹ ìš´ë™ ì…ë ¥ (Web Speech + Whisper)
- [x] AI í…ìŠ¤íŠ¸ íŒŒì‹± (Gemini/GPT)
- [x] ìš´ë™ ê¸°ë¡ CRUD
- [x] ëŒ€ì‹œë³´ë“œ í†µê³„ ë° ìº˜ë¦°ë”
- [x] AI ê¸°ë°˜ ìš´ë™ ì¶”ì²œ
- [x] ì¼ì¼ ìš´ë™ ëª©í‘œ ê´€ë¦¬
- [x] ë°˜ì‘í˜• UI
- [x] RLS ë³´ì•ˆ ì •ì±…

### ğŸš§ ì§„í–‰ ì¤‘ / ê³„íš
- [ ] **í´ëŸ½/ë™í˜¸íšŒ ì‹œìŠ¤í…œ** (ë©€í‹°í…Œë„ŒíŠ¸)
  - í´ëŸ½ ìƒì„± ë° ê°€ì…
  - í´ëŸ½ì› ê°„ ìš´ë™ ë‚´ì—­ ê³µìœ 
  - í•©ì‚° ì±Œë¦°ì§€ (ê·¸ë£¹ ëª©í‘œ ë‹¬ì„±)
  - ë¦¬ë”ë³´ë“œ
- [ ] ì†Œì…œ ê¸°ëŠ¥
  - ìš´ë™ ê¸°ë¡ í”¼ë“œ
  - ì¢‹ì•„ìš”/ëŒ“ê¸€
  - íŒ”ë¡œìš° ì‹œìŠ¤í…œ
- [ ] ê³ ê¸‰ í†µê³„
  - PR (Personal Record) ì¶”ì 
  - ìš´ë™ë³„ ì„±ì¥ ê·¸ë˜í”„
  - ì£¼ê°„/ì›”ê°„ ë¦¬í¬íŠ¸
- [ ] í‘¸ì‹œ ì•Œë¦¼
  - ìš´ë™ ëª©í‘œ ë¦¬ë§ˆì¸ë”
  - í´ëŸ½ í™œë™ ì•Œë¦¼
- [ ] PWA (Progressive Web App)
  - ì˜¤í”„ë¼ì¸ ì§€ì›
  - ëª¨ë°”ì¼ ì•±ì²˜ëŸ¼ ì„¤ì¹˜ ê°€ëŠ¥

---

## í´ëŸ½ ì‹œìŠ¤í…œ ê³„íš (í–¥í›„ ê°œë°œ)

### ëª©í‘œ
ì‚¬ìš©ìë“¤ì´ **ë™í˜¸íšŒ/í´ëŸ½**ì„ ë§Œë“¤ì–´ ìš´ë™ ë‚´ì—­ì„ ê³µìœ í•˜ê³ , í•¨ê»˜ ì±Œë¦°ì§€ë¥¼ ìˆ˜í–‰í•˜ëŠ” ì†Œì…œ í”¼íŠ¸ë‹ˆìŠ¤ í”Œë«í¼ìœ¼ë¡œ í™•ì¥.

### í•µì‹¬ ê¸°ëŠ¥ (ì˜ˆì •)
1. **í´ëŸ½ ê´€ë¦¬**
   - í´ëŸ½ ìƒì„± (ì´ë¦„, ì„¤ëª…, ê³µê°œ/ë¹„ê³µê°œ)
   - ë©¤ë²„ ì´ˆëŒ€ ë° ìŠ¹ì¸
   - ì—­í•  ê´€ë¦¬ (ì˜¤ë„ˆ, ê´€ë¦¬ì, ë©¤ë²„)

2. **ìš´ë™ ë‚´ì—­ ê³µìœ **
   - í´ëŸ½ í”¼ë“œ: ë©¤ë²„ë“¤ì˜ ìš´ë™ ê¸°ë¡ íƒ€ì„ë¼ì¸
   - ë°˜ì‘ (ì¢‹ì•„ìš”, ì‘ì› ë©”ì‹œì§€)

3. **í•©ì‚° ì±Œë¦°ì§€**
   - ê·¸ë£¹ ëª©í‘œ ì„¤ì • (ì˜ˆ: ì´ë²ˆ ë‹¬ ì´ 1,000km ë‹¬ë¦¬ê¸°)
   - ê°œì¸ ê¸°ì—¬ë„ ì¶”ì 
   - ì‹¤ì‹œê°„ ì§„í–‰ë¥  ëŒ€ì‹œë³´ë“œ
   - ì±Œë¦°ì§€ ì™„ë£Œ ì‹œ ë°°ì§€/ë³´ìƒ

4. **ë¦¬ë”ë³´ë“œ**
   - í´ëŸ½ ë‚´ ê°œì¸ ìˆœìœ„
   - ê¸°ê°„ë³„ (ì£¼ê°„/ì›”ê°„) ë­í‚¹
   - ìš´ë™ íƒ€ì…ë³„ ìˆœìœ„

### ê¸°ìˆ ì  ê³ ë ¤ì‚¬í•­
- **ë©€í‹°í…Œë„ŒíŠ¸ RLS**: í´ëŸ½ ë©¤ë²„ë§Œ í•´ë‹¹ í´ëŸ½ ë°ì´í„° ì ‘ê·¼
- **Real-time ì—…ë°ì´íŠ¸**: Supabase Realtimeìœ¼ë¡œ ì±Œë¦°ì§€ ì§„í–‰ë¥  ë™ê¸°í™”
- **ì•Œë¦¼ ì‹œìŠ¤í…œ**: í´ëŸ½ í™œë™ ë° ì±Œë¦°ì§€ ë§ˆì¼ìŠ¤í†¤ ì•Œë¦¼
- **í™•ì¥ì„±**: í´ëŸ½ ê·œëª¨ í™•ëŒ€ ì‹œ ì¸ë±ì‹± ë° ì¿¼ë¦¬ ìµœì í™”

---

## ë°°í¬ ë° ìš´ì˜

### ê°œë°œ í™˜ê²½
```bash
npm install
npm run dev  # http://localhost:5173
```

### í”„ë¡œë•ì…˜ ë¹Œë“œ
```bash
npm run build
npm run preview
```

### ë°°í¬ í”Œë«í¼ (ì˜ˆì‹œ)
- **Vercel** / **Netlify**: ì •ì  í˜¸ìŠ¤íŒ…
- **Supabase**: ë°±ì—”ë“œ ë° ë°ì´í„°ë² ì´ìŠ¤
- **Kakao Developers**: OAuth ì•± ë“±ë¡

---

## ë¬¸ì„œ ë„¤ë¹„ê²Œì´ì…˜

- [í”„ë¡œì íŠ¸ ê°œìš”](./PROJECT_OVERVIEW.md) â† í˜„ì¬ ë¬¸ì„œ
- [ì•„í‚¤í…ì²˜ ìƒì„¸](./ARCHITECTURE.md)
- [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](./database/schema.sql)
- [ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ](./database/migrations/MIGRATION_GUIDE.md)

---

## ê¸°ì—¬ ë° ë¬¸ì˜

ì´ í”„ë¡œì íŠ¸ëŠ” ê°œì¸ í”„ë¡œì íŠ¸ì´ë©°, AI (Gemini, GPT)ì™€ì˜ í˜‘ì—…ì„ í†µí•´ ê¸°íš ë° ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.

í–¥í›„ ì˜¤í”ˆì†ŒìŠ¤í™”ë¥¼ ê³ ë ¤ ì¤‘ì…ë‹ˆë‹¤.
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])
</file>

<file path="KAKAO_LOGIN_GUIDE.md">
# ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ êµ¬í˜„ ê°€ì´ë“œ

## ê°œìš”
Voice Workout Log ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì¹´ì¹´ì˜¤ OAuth ë¡œê·¸ì¸ì´ êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.

## ì„œë¹„ìŠ¤ ì •ë³´
- **ì„œë¹„ìŠ¤ ì£¼ì†Œ**: https://undong.lunagd.com
- **ë¦¬ë‹¤ì´ë ‰íŠ¸ URI**: https://undong.lunagd.com/auth/kakao/callback

## 1. ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†” ì„¤ì •

### 1.1 ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±
1. [ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†”](https://developers.kakao.com) ì ‘ì†
2. "ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜" > "ì• í”Œë¦¬ì¼€ì´ì…˜ ì¶”ê°€í•˜ê¸°" í´ë¦­
3. ì•± ì´ë¦„: `Voice Workout Log` (ë˜ëŠ” ì›í•˜ëŠ” ì´ë¦„)
4. ì‚¬ì—…ìëª…: `jh308(ì œì´ì—ì´ì¹˜308)`

### 1.2 í”Œë«í¼ ì„¤ì •
1. "í”Œë«í¼" íƒ­ ì„ íƒ
2. "Web í”Œë«í¼ ë“±ë¡" í´ë¦­
3. ì‚¬ì´íŠ¸ ë„ë©”ì¸: `https://undong.lunagd.com` ì…ë ¥

### 1.3 ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í™œì„±í™”
1. "ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸" ë©”ë‰´ ì„ íƒ
2. "ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í™œì„±í™”" ON
3. **Redirect URI ë“±ë¡**:
   - `https://undong.lunagd.com/auth/kakao/callback`
   - `http://localhost:5173/auth/kakao/callback` (ê°œë°œìš©)

### 1.4 ë™ì˜ í•­ëª© ì„¤ì •
"ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸" > "ë™ì˜ í•­ëª©" ì—ì„œ ë‹¤ìŒ í•­ëª© ì„¤ì •:

#### í•„ìˆ˜ ë™ì˜ í•­ëª©
- **ë‹‰ë„¤ì„**: í•„ìˆ˜ ë™ì˜
- **í”„ë¡œí•„ ì‚¬ì§„**: í•„ìˆ˜ ë™ì˜

#### ì„ íƒ ë™ì˜ í•­ëª©
- **ì¹´ì¹´ì˜¤ê³„ì • ì´ë©”ì¼**: ì„ íƒ ë™ì˜
- **ì´ë¦„**: ì„ íƒ ë™ì˜ (ì‹¤ëª… í•„ìš” ì‹œ)
- **ì „í™”ë²ˆí˜¸**: ì„ íƒ ë™ì˜
- **ìƒë…„ì›”ì¼**: ì„ íƒ ë™ì˜
- **ì„±ë³„**: ì„ íƒ ë™ì˜

### 1.5 ë³´ì•ˆ ì„¤ì •
1. "ë³´ì•ˆ" íƒ­ ì„ íƒ
2. **Client Secret** ë°œê¸‰ (ê¶Œì¥)
   - "Client Secret" ìƒì„± í´ë¦­
   - "í™œì„±í™” ìƒíƒœ" ON

### 1.6 ë¹„ì¦ˆë‹ˆìŠ¤ ì •ë³´ ë“±ë¡ (ì„ íƒ)
"ë¹„ì¦ˆë‹ˆìŠ¤" íƒ­ì—ì„œ ì‚¬ì—…ì ì •ë³´ ë“±ë¡:
- ì‚¬ì—…ìëª…: jh308(ì œì´ì—ì´ì¹˜308)
- ëŒ€í‘œì: ì–‘ì„í™˜
- ì‚¬ì—…ìë²ˆí˜¸: 188-17-02548

## 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

`.env` íŒŒì¼ì— ì¹´ì¹´ì˜¤ API í‚¤ ì¶”ê°€:

```env
# Kakao OAuth
VITE_KAKAO_REST_API_KEY=your_kakao_rest_api_key_here
VITE_KAKAO_CLIENT_SECRET=your_kakao_client_secret_here
```

### í™˜ê²½ ë³€ìˆ˜ ê°’ í™•ì¸
- **REST API í‚¤**: ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†” > ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ > ì•± ì„¤ì • > ì•± í‚¤ > "REST API í‚¤"
- **Client Secret**: ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†” > ë‚´ ì• í”Œë¦¬ì¼€ì´ì…˜ > ë³´ì•ˆ > Client Secret

## 3. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

Supabaseì—ì„œ ë‹¤ìŒ SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ users í…Œì´ë¸”ì— ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì»¬ëŸ¼ ì¶”ê°€:

```bash
# SQL íŒŒì¼ ì‹¤í–‰
psql -h your_supabase_host -d postgres -U postgres -f supabase_kakao_login_migration.sql
```

ë˜ëŠ” Supabase ëŒ€ì‹œë³´ë“œ > SQL Editorì—ì„œ `supabase_kakao_login_migration.sql` íŒŒì¼ ë‚´ìš© ì‹¤í–‰

ì¶”ê°€ë˜ëŠ” ì»¬ëŸ¼:
- `kakao_id`: ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ê³ ìœ  ID (UNIQUE)
- `provider`: ë¡œê·¸ì¸ ì œê³µì ('local', 'kakao')
- `profile_image`: í”„ë¡œí•„ ì´ë¯¸ì§€ URL
- `phone_number`: ì „í™”ë²ˆí˜¸
- `birthyear`: ì¶œìƒë…„ë„
- `gender`: ì„±ë³„
- `nickname`: ì¹´ì¹´ì˜¤ ë‹‰ë„¤ì„

## 4. êµ¬í˜„ íŒŒì¼ êµ¬ì¡°

```
voice-workout-log/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ authService.ts          # ì¹´ì¹´ì˜¤ ì¸ì¦ ì„œë¹„ìŠ¤ (Supabase ì—°ë™)
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ KakaoLogin.tsx          # ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â””â”€â”€ KakaoCallback.tsx       # ì¹´ì¹´ì˜¤ ì½œë°± ì²˜ë¦¬ ì»´í¬ë„ŒíŠ¸
â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â””â”€â”€ AuthContext.tsx         # ì¸ì¦ ì»¨í…ìŠ¤íŠ¸ (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì§€ì›)
â”‚   â””â”€â”€ pages/
â”‚       â”œâ”€â”€ Login.tsx               # ë¡œê·¸ì¸ í˜ì´ì§€ (ì¹´ì¹´ì˜¤ ë²„íŠ¼ í¬í•¨)
â”‚       â””â”€â”€ Signup.tsx              # íšŒì›ê°€ì… í˜ì´ì§€ (ì¹´ì¹´ì˜¤ ì •ë³´ ìë™ ì…ë ¥)
â””â”€â”€ supabase_kakao_login_migration.sql  # DB ë§ˆì´ê·¸ë ˆì´ì…˜ SQL
```

## 5. ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í”Œë¡œìš°

### 5.1 ë¡œê·¸ì¸ í”„ë¡œì„¸ìŠ¤
1. ì‚¬ìš©ìê°€ "ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸" ë²„íŠ¼ í´ë¦­
2. ì¹´ì¹´ì˜¤ ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
3. ì‚¬ìš©ìê°€ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë° ë™ì˜
4. `/auth/kakao/callback`ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì¸ê°€ ì½”ë“œ í¬í•¨)
5. ì¸ê°€ ì½”ë“œë¡œ ì•¡ì„¸ìŠ¤ í† í° êµí™˜
6. ì•¡ì„¸ìŠ¤ í† í°ìœ¼ë¡œ ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ

### 5.2 ì‹ ê·œ ì‚¬ìš©ì (íšŒì›ê°€ì…)
7. Supabaseì—ì„œ `kakao_id`ë¡œ ì‚¬ìš©ì ì¡°íšŒ
8. ì‚¬ìš©ì ì—†ìŒ â†’ íšŒì›ê°€ì… í˜ì´ì§€ë¡œ ì´ë™
9. ì¹´ì¹´ì˜¤ ì •ë³´ë¡œ í¼ ìë™ ì…ë ¥
10. ì•½ê´€ ë™ì˜ í›„ íšŒì›ê°€ì… ì™„ë£Œ
11. Supabase users í…Œì´ë¸”ì— ì €ì¥
12. ìë™ ë¡œê·¸ì¸ ë° ë©”ì¸ í˜ì´ì§€ ì´ë™

### 5.3 ê¸°ì¡´ ì‚¬ìš©ì (ë¡œê·¸ì¸)
7. Supabaseì—ì„œ `kakao_id`ë¡œ ì‚¬ìš©ì ì¡°íšŒ
8. ì‚¬ìš©ì ì¡´ì¬ â†’ í”„ë¡œí•„ ì •ë³´ ìµœì‹ í™”
9. ë¡œê·¸ì¸ ì²˜ë¦¬ (localStorageì— ì‚¬ìš©ì ì •ë³´ ì €ì¥)
10. ë©”ì¸ í˜ì´ì§€ ì´ë™

## 6. ë¡œì»¬ ê°œë°œ í™˜ê²½ í…ŒìŠ¤íŠ¸

### 6.1 ê°œë°œ ì„œë²„ ì‹¤í–‰
```bash
npm run dev
```

### 6.2 ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†” ì„¤ì •
ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© Redirect URI ì¶”ê°€:
- `http://localhost:5173/auth/kakao/callback`

### 6.3 í…ŒìŠ¤íŠ¸ ì ˆì°¨
1. http://localhost:5173/login ì ‘ì†
2. "ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸í•˜ê¸°" ë²„íŠ¼ í´ë¦­
3. ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì§„í–‰
4. ì‹ ê·œ ì‚¬ìš©ì: íšŒì›ê°€ì… í˜ì´ì§€ì—ì„œ ì •ë³´ í™•ì¸ í›„ ê°€ì…
5. ê¸°ì¡´ ì‚¬ìš©ì: ìë™ ë¡œê·¸ì¸ í›„ ë©”ì¸ í˜ì´ì§€ ì´ë™

## 7. ë°°í¬ ì‹œ ì£¼ì˜ì‚¬í•­

### 7.1 í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- Netlify/Vercel ë“± ë°°í¬ í”Œë«í¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í•„ìˆ˜
- `VITE_KAKAO_REST_API_KEY`
- `VITE_KAKAO_CLIENT_SECRET`

### 7.2 ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†” ì„¤ì •
- ì‹¤ì œ ì„œë¹„ìŠ¤ ë„ë©”ì¸(`https://undong.lunagd.com`)ìœ¼ë¡œ Redirect URI ë“±ë¡ í™•ì¸
- í”Œë«í¼ì— ì„œë¹„ìŠ¤ ë„ë©”ì¸ ë“±ë¡ í™•ì¸

### 7.3 ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
- Client Secretì€ ë°˜ë“œì‹œ í™˜ê²½ ë³€ìˆ˜ë¡œ ê´€ë¦¬ (ì½”ë“œì— ë…¸ì¶œ ê¸ˆì§€)
- HTTPS ì‚¬ìš© í•„ìˆ˜ (ì¹´ì¹´ì˜¤ ì •ì±…)
- í”„ë¡œë•ì…˜ì—ì„œëŠ” localhost Redirect URI ì œê±°

## 8. ë¬¸ì œ í•´ê²°

### 8.1 "Redirect URI mismatch" ì˜¤ë¥˜
- ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†”ì—ì„œ Redirect URI ì •í™•íˆ ë“±ë¡ í™•ì¸
- í”„ë¡œí† ì½œ(http/https), ë„ë©”ì¸, ê²½ë¡œ ëª¨ë‘ ì¼ì¹˜í•´ì•¼ í•¨
- ì˜ˆ: `https://undong.lunagd.com/auth/kakao/callback`

### 8.2 "Invalid client_id" ì˜¤ë¥˜
- `.env` íŒŒì¼ì— `VITE_KAKAO_REST_API_KEY` í™•ì¸
- ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†”ì—ì„œ REST API í‚¤ ë³µì‚¬ í™•ì¸
- ê°œë°œ ì„œë²„ ì¬ì‹œì‘ (í™˜ê²½ ë³€ìˆ˜ ë³€ê²½ ì‹œ)

### 8.3 "ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨"
- ì¹´ì¹´ì˜¤ ê°œë°œì ì½˜ì†” > ë™ì˜ í•­ëª© ì„¤ì • í™•ì¸
- í•„ìˆ˜ ë™ì˜ í•­ëª© í™œì„±í™” í™•ì¸
- ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì¦ í•„ìš”í•œ í•­ëª©(ì´ë¦„, ì „í™”ë²ˆí˜¸ ë“±)ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë“±ë¡ í›„ ì‚¬ìš© ê°€ëŠ¥

### 8.4 ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜
- Supabaseì—ì„œ `supabase_kakao_login_migration.sql` ì‹¤í–‰ í™•ì¸
- users í…Œì´ë¸”ì— `kakao_id` ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸
- RLS(Row Level Security) ì •ì±… í™•ì¸

## 9. API ì°¸ê³  ë¬¸ì„œ

- [ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ REST API](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api)
- [ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°](https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api#req-user-info)
- [Supabase ë¬¸ì„œ](https://supabase.com/docs)

## 10. ë‹´ë‹¹ì ì •ë³´

**ì„œë¹„ìŠ¤ ìš´ì˜ì**
- ì‚¬ì—…ìëª…: jh308(ì œì´ì—ì´ì¹˜308)
- ëŒ€í‘œì: ì–‘ì„í™˜
- ì´ë©”ì¼: shy@lunagarden.co.kr
- ì „í™”: 010-3114-8626
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/components/Footer.css">
.footer {
  background-color: #f8f9fa;
  border-top: 1px solid #e0e0e0;
  padding: 1rem;
  margin-top: auto;
}

.footer-content {
  max-width: 1200px;
  margin: 0 auto;
  text-align: center;
}

.business-info {
  margin: 0;
  font-size: 0.875rem;
  color: #666;
  line-height: 1.5;
}

.company-name {
  font-weight: 500;
  color: #333;
}

.separator {
  margin: 0 0.5rem;
  color: #ccc;
}

/* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 768px) {
  .footer {
    padding: 0.75rem;
    margin-bottom: 60px; /* BottomNav ê³µê°„ í™•ë³´ */
  }

  .business-info {
    font-size: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .separator {
    display: none;
  }
}
</file>

<file path="src/components/Footer.tsx">
import './Footer.css';

export function Footer() {
  return (
    <footer className="footer">
      <div className="footer-content">
        <p className="business-info">
          <span className="company-name">jh308(ì œì´ì—ì´ì¹˜308)</span>
          <span className="separator">|</span>
          <span>ëŒ€í‘œì: ì–‘ì„í™˜</span>
          <span className="separator">|</span>
          <span>ì‚¬ì—…ìë²ˆí˜¸: 188-17-02548</span>
        </p>
      </div>
    </footer>
  );
}
</file>

<file path="src/components/KakaoCallback.tsx">
// src/components/KakaoCallback.tsx
import { useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import authService from '../services/authService';

const KakaoCallback = () => {
  const navigate = useNavigate();
  const { loginWithKakao } = useAuth();

  // React 18 ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
  const once = useRef(false);

  useEffect(() => {
    (async () => {
      if (once.current) return;
      once.current = true;

      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const stateStr = url.searchParams.get('state');

      const from = (() => {
        try {
          return JSON.parse(decodeURIComponent(stateStr || ''))?.from || '/';
        } catch {
          return '/';
        }
      })();

      // ì½”ë“œ ì¤‘ë³µ ì‚¬ìš© ë°©ì§€
      if (code && sessionStorage.getItem(`kakao_code_used_${code}`) === '1') {
        navigate(from, { replace: true });
        return;
      }

      try {
        if (!code) throw new Error('ì¸ê°€ ì½”ë“œ(code)ê°€ ì—†ìŠµë‹ˆë‹¤.');

        // 1. ì¹´ì¹´ì˜¤ë¡œë¶€í„° ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userInfo = await authService.getKakaoUserInfo(code);
        console.log('âœ… ì¹´ì¹´ì˜¤ ìœ ì € ì •ë³´ ë°›ìŒ:', userInfo);

        // 2. ê¸°ì¡´ ì‚¬ìš©ì í™•ì¸
        const exists = await authService.checkUserExistsByKakaoId(userInfo.id);
        console.log('ğŸ” ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€:', exists);

        if (!exists) {
          // ì‹ ê·œ ì‚¬ìš©ì - íšŒì›ê°€ì… í˜ì´ì§€ë¡œ ì´ë™
          console.log('ğŸ†• ë¯¸ë“±ë¡ ì‚¬ìš©ì - íšŒì›ê°€ì… í˜ì´ì§€ë¡œ ì´ë™');
          if (code) sessionStorage.setItem(`kakao_code_used_${code}`, '1');

          navigate('/signup', {
            replace: true,
            state: {
              kakaoUserInfo: userInfo,
              from,
            },
          });
          return;
        }

        // 3. ê¸°ì¡´ ì‚¬ìš©ì - í”„ë¡œí•„ ì—…ë°ì´íŠ¸ í›„ ë¡œê·¸ì¸
        console.log('ğŸ‘¤ ê¸°ì¡´ ì‚¬ìš©ì - ë¡œê·¸ì¸ ì²˜ë¦¬');

        await authService.updateUserProfile(userInfo.id, {
          displayName: userInfo.displayName,
          nickname: userInfo.nickname,
          profileImage: userInfo.profileImage,
          email: userInfo.email,
          phoneNumber: userInfo.phoneNumber || '',
          birthyear: userInfo.birthyear || '',
          gender: userInfo.gender || '',
        });

        // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        const userData = await authService.getUserByKakaoId(userInfo.id);
        await loginWithKakao(userData);

        if (code) sessionStorage.setItem(`kakao_code_used_${code}`, '1');
        navigate(from, { replace: true });
      } catch (e) {
        console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', e);
        alert(`ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n${e instanceof Error ? e.message : ''}`);

        if (code) sessionStorage.setItem(`kakao_code_used_${code}`, '1');
        navigate('/login', { replace: true });
      }
    })();
  }, [navigate, loginWithKakao]);

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="loading-screen">
        <div className="spinner"></div>
        <p>ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</p>
      </div>
    </div>
  );
};

export default KakaoCallback;
</file>

<file path="src/components/KakaoLogin.tsx">
// src/components/KakaoLogin.tsx
export const KakaoLogin = () => {
  const handleLogin = () => {
    const REST_API_KEY = import.meta.env.VITE_KAKAO_REST_API_KEY;

    if (!REST_API_KEY) {
      alert('ì¹´ì¹´ì˜¤ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }

    // í˜„ì¬ ì ‘ì† ì¤‘ì¸ í˜¸ìŠ¤íŠ¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ URI ë™ì  ìƒì„±
    const currentOrigin = window.location.origin;
    const REDIRECT_URI = `${currentOrigin}/auth/kakao/callback`;

    // í˜„ì¬ ê²½ë¡œë¥¼ stateë¡œ ì „ë‹¬
    const currentPath = window.location.pathname;
    const state = encodeURIComponent(JSON.stringify({ from: currentPath }));

    console.log('ğŸ”‘ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë¦¬ë‹¤ì´ë ‰íŠ¸ URI:', REDIRECT_URI);
    console.log('ğŸ”‘ ì›ë˜ ê²½ë¡œ (state):', currentPath);

    const kakaoURL =
      `https://kauth.kakao.com/oauth/authorize?client_id=${REST_API_KEY}` +
      `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
      `&response_type=code` +
      `&state=${state}`;

    window.location.href = kakaoURL;
  };

  return (
    <button
      type="button"
      onClick={handleLogin}
      className="kakao-login-button"
    >
      <span className="kakao-icon">ğŸ’¬</span>
      ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸í•˜ê¸°
    </button>
  );
};

export default KakaoLogin;
</file>

<file path="src/config/features.ts">
// ê¸°ëŠ¥ í† ê¸€ ì„¤ì •
export const FEATURES = {
  // Footer í‘œì‹œ ì—¬ë¶€ (true: í‘œì‹œ, false: ìˆ¨ê¹€)
  SHOW_FOOTER: true,
};
</file>

<file path="src/features/parse/aiParserSchema.ts">
import { z } from "zod";

// ==========================================
// AI Parser Zod Schemas (from test-parser)
// ==========================================

// Internal category enum (maps to Workout.type)
export const InternalCategoryEnum = z.enum(["cardio", "strength", "snowboard"]);

// Cardio exercise names
export const CardioNames = z.enum([
  "running",    // ëŸ¬ë‹, íŠ¸ë ˆë“œë°€, ì¡°ê¹…
  "stepmill",   // ì²œêµ­ì˜ ê³„ë‹¨, ìŠ¤í…ë°€, ë§ˆì´ë§ˆìš´í‹´
  "rowing",     // ë¡œì‰ë¨¸ì‹ 
  "cycle",      // ì‚¬ì´í´, ìì „ê±°, ë”°ë¦‰ì´, ìŠ¤í”¼ë‹
  "swimming",   // ìˆ˜ì˜
  "hiking",     // ë“±ì‚°
  "jump_rope",  // ì¤„ë„˜ê¸°
  "elliptical", // ì—˜ë¦½í‹°ì»¬
  "other",      // ê·¸ ì™¸
]);

// ==========================================
// Shredder (Input Splitter) Schema
// ==========================================
export const ShreddedSegmentSchema = z.object({
  original_text: z.string().describe("ìš´ë™ë³„ë¡œ ë¶„ë¦¬ëœ ë¬¸ì¥ (ì˜ˆ: 'ë²¤ì¹˜ 60 10 5')"),
  category: InternalCategoryEnum.describe("í•´ë‹¹ ë¬¸ì¥ì„ ì²˜ë¦¬í•  ë‹´ë‹¹ ë¶€ì„œ"),
  item_name_hint: z.string().describe("ìš´ë™ ì´ë¦„ íŒíŠ¸ (ì˜ì–´). ì˜ˆ: bench_press, running"),
});

export const ShredderResponseSchema = z.object({
  segments: z.array(ShreddedSegmentSchema),
});

// ==========================================
// Cardio Specialist Schema
// ==========================================
export const CardioResultSchema = z.object({
  reasoning: z.string().describe("ê°’ ì¶”ì¶œ ê·¼ê±° (ì˜ˆ: '~ë¡œ' ì¡°ì‚¬ ì‚¬ìš©ìœ¼ë¡œ ì†ë„ë¡œ íŒë‹¨)"),
  name: CardioNames.describe("í‘œì¤€í™”ëœ ìš´ë™ ì´ë¦„"),

  // Null handling - NEVER use 0
  distance_km: z.union([z.number(), z.null()]).describe("ê±°ë¦¬(km). ì—†ìœ¼ë©´ null."),
  duration_min: z.union([z.number(), z.null()]).describe("ì‹œê°„(ë¶„). ì—†ìœ¼ë©´ null."),
  speed_kph: z.union([z.number(), z.null()]).describe("ì†ë„(km/h). ì—†ìœ¼ë©´ null."),
  pace: z.string().nullable().describe("í˜ì´ìŠ¤ (ì˜ˆ: '6:30'). ì—†ìœ¼ë©´ null."),
  floors: z.union([z.number(), z.null()]).describe("ì¸µìˆ˜(ìŠ¤í…ë°€ ì „ìš©). ì—†ìœ¼ë©´ null."),
});

// ==========================================
// Strength Specialist Schema
// ==========================================
export const StrengthResultSchema = z.object({
  reasoning: z.string().describe("ê°’ ì¶”ì¶œ ê·¼ê±°"),
  name: z.string().describe("ìš´ë™ ì´ë¦„ (ì˜ì–´)"),

  weight_kg: z.union([z.number(), z.null()]).describe("ë¬´ê²Œ(kg). ë§¨ëª¸ìš´ë™ì´ê±°ë‚˜ ì—†ìœ¼ë©´ null."),
  sets: z.union([z.number(), z.null()]).describe("ì„¸íŠ¸ ìˆ˜. ì—†ìœ¼ë©´ null."),
  reps: z.union([z.number(), z.null()]).describe("íšŒìˆ˜. ì—†ìœ¼ë©´ null."),
});

// ==========================================
// Snowboard Specialist Schema (Simple)
// ==========================================
export const SnowboardResultSchema = z.object({
  name: z.string().describe("ìŠ¤ë…¸ë³´ë“œ í™œë™ ì´ë¦„"),
  duration_min: z.union([z.number(), z.null()]).describe("ì‹œê°„(ë¶„). ì—†ìœ¼ë©´ null."),
  run_count: z.union([z.number(), z.null()]).describe("ëŸ° ìˆ˜ (ëª‡ë²ˆ íƒ”ëŠ”ì§€). ì—†ìœ¼ë©´ null."),
  note: z.string().nullable().describe("ì¶”ê°€ ë©”ëª¨ (ìŠ¤íƒ€ì¼, ê°•ë„ ë“±)"),
});

// Types
export type InternalCategory = z.infer<typeof InternalCategoryEnum>;
export type CardioResult = z.infer<typeof CardioResultSchema>;
export type StrengthResult = z.infer<typeof StrengthResultSchema>;
export type SnowboardResult = z.infer<typeof SnowboardResultSchema>;
export type ShreddedSegment = z.infer<typeof ShreddedSegmentSchema>;
</file>

<file path="src/features/parse/normalizeCardio.ts">
/**
 * Cardio Normalization - ìœ ì‚°ì†Œ ìš´ë™ì˜ ê³µì •ì„±ì„ ìœ„í•œ í™˜ì‚° ë¹„ìœ¨ ì ìš©
 *
 * ğŸ“Œ ì¤‘ìš”: ê¸°ë¡ì€ ê·¸ëŒ€ë¡œ ì €ì¥í•˜ê³ , ì§‘ê³„ ì‹œì—ë§Œ ë¹„ìœ¨ ì ìš©
 * - ì›ë³¸ ë°ì´í„°ëŠ” ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
 * - ë¹ˆ í•„ë“œ(ê±°ë¦¬, ì†ë„ ë“±)ê°€ ìˆìœ¼ë©´ ê³„ì‚°í•´ì„œ ì±„ì›€
 * - ëŒ€ì‹œë³´ë“œ ì§‘ê³„ ë¡œì§ì—ì„œë§Œ í™˜ì‚° ë¹„ìœ¨(multiplier) ì ìš©
 * - UIì—ì„œ ì•„ì´ì½˜ìœ¼ë¡œ í™˜ì‚° ë¹„ìœ¨ ëª…ì‹œ
 */

import type { Workout } from '../../types';

// ìœ ì‚°ì†Œ ìš´ë™ í‘œì¤€ ì¹´í…Œê³ ë¦¬
export type CardioCategory = 'running' | 'stepmill' | 'rowing' | 'cycle' | 'other';

// ì¢…ëª©ë³„ ì¸ì • ë¹„ìœ¨ (Multiplier) - ì§‘ê³„ ì‹œì—ë§Œ ì‚¬ìš©
export const CARDIO_MULTIPLIERS: Record<CardioCategory, number> = {
  running: 1.0,   // 100% - ëŸ¬ë‹, íŠ¸ë ˆë“œë°€
  stepmill: 1.0,  // 100% - ì²œêµ­ì˜ê³„ë‹¨, ìŠ¤í…ë°€, ë“±ì‚°
  rowing: 0.6,    // 60%  - ë¡œì‰ë¨¸ì‹ , ì¡°ì •
  cycle: 0.4,     // 40%  - ì‚¬ì´í´, ì‹¤ë‚´ìì „ê±°, ìŠ¤í”¼ë‹
  other: 0.3,     // 30%  - ì—˜ë¦½í‹°ì»¬, ì¤„ë„˜ê¸°, ìˆ˜ì˜, ê¸°íƒ€
};

// ì¢…ëª©ëª… â†’ í‘œì¤€ ì¹´í…Œê³ ë¦¬ ë§¤í•‘ í‚¤ì›Œë“œ
const CARDIO_KEYWORDS: Record<CardioCategory, string[]> = {
  running: [
    'ëŸ¬ë‹', 'íŠ¸ë ˆë“œë°€', 'ë‹¬ë¦¬ê¸°', 'ì¡°ê¹…', 'ë§ˆë¼í†¤', 'ì•¼ì™¸ëŸ¬ë‹',
    'ëŸ°ë‹', 'ë›°ê¸°', 'running', 'treadmill', 'jogging'
  ],
  stepmill: [
    'ì²œêµ­ì˜ê³„ë‹¨', 'ìŠ¤í…ë°€', 'ë§ˆì´ë§ˆìš´í‹´', 'ë“±ì‚°', 'ìŠ¤í…Œí¼',
    'ê³„ë‹¨', 'ìŠ¤í…ë¨¸ì‹ ', 'stepmill', 'stairmaster', 'stepper'
  ],
  rowing: [
    'ë¡œì‰', 'ë¡œì‰ë¨¸ì‹ ', 'ì¡°ì •', 'ë…¸ì “ê¸°', 'rowing', 'rower'
  ],
  cycle: [
    'ì‚¬ì´í´', 'ì‹¤ë‚´ìì „ê±°', 'ë”°ë¦‰ì´', 'ìŠ¤í”¼ë‹', 'ë°”ì´í¬',
    'ìì „ê±°', 'cycle', 'bike', 'spinning'
  ],
  other: [
    'ì—˜ë¦½í‹°ì»¬', 'ì¤„ë„˜ê¸°', 'ìˆ˜ì˜', 'ì›Œí‚¹', 'ê±·ê¸°',
    'elliptical', 'swimming', 'walking'
  ],
};

/**
 * ìš´ë™ëª…ì„ í‘œì¤€ Cardio ì¹´í…Œê³ ë¦¬ë¡œ ë§¤í•‘
 */
export const mapToCardioCategory = (workoutName: string): CardioCategory => {
  const lowerName = workoutName.toLowerCase();

  for (const [category, keywords] of Object.entries(CARDIO_KEYWORDS)) {
    if (keywords.some(kw => lowerName.includes(kw.toLowerCase()))) {
      return category as CardioCategory;
    }
  }

  return 'other'; // ì•Œ ìˆ˜ ì—†ìœ¼ë©´ 'other'ë¡œ ì²˜ë¦¬
};

/**
 * ì¹´í…Œê³ ë¦¬ë³„ í™˜ì‚° ë¹„ìœ¨ ê°€ì ¸ì˜¤ê¸°
 */
export const getCardioMultiplier = (workoutName: string): number => {
  const category = mapToCardioCategory(workoutName);
  return CARDIO_MULTIPLIERS[category];
};

/**
 * í™˜ì‚° ê±°ë¦¬ ê³„ì‚° (ì§‘ê³„ ì‹œ ì‚¬ìš©)
 *
 * 1ìˆœìœ„: adjusted_dist_km (ì¸í´ë¼ì¸ ë³´ì •ëœ ê±°ë¦¬)
 * 2ìˆœìœ„: distance_km (ì›ë³¸ ê±°ë¦¬)
 * ê·¸ í›„ cardio category multiplier ì ìš©
 *
 * @param distance_km - ì›ë³¸ ê±°ë¦¬ (km)
 * @param adjusted_dist_km - ì¸í´ë¼ì¸ ë³´ì •ëœ ê±°ë¦¬ (km)
 * @param workoutName - ìš´ë™ ì´ë¦„
 * @returns í™˜ì‚° ê±°ë¦¬ (km)
 */
export const calculateAdjustedDistance = (
  distance_km: number | null,
  adjusted_dist_km: number | null,
  workoutName: string
): number => {
  // ì¸í´ë¼ì¸ ë³´ì •ëœ ê±°ë¦¬ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë³¸ ê±°ë¦¬
  const baseDistance = adjusted_dist_km ?? distance_km ?? 0;

  if (baseDistance === 0) return 0;

  const multiplier = getCardioMultiplier(workoutName);
  return Number((baseDistance * multiplier).toFixed(2));
};

/**
 * ë¹ˆ í•„ë“œ ì±„ìš°ê¸° (ê±°ë¦¬, ì†ë„ ë“± ê³„ì‚°)
 * ì›ë³¸ ë°ì´í„°ì— ëˆ„ë½ëœ í•„ë“œë¥¼ ê³„ì‚°í•´ì„œ ì±„ì›€
 */
export const fillMissingCardioFields = (workout: Workout): Workout => {
  if (workout.type !== 'cardio') {
    return workout;
  }

  const result = { ...workout };

  // ê±°ë¦¬ê°€ ì—†ê³  ì†ë„+ì‹œê°„ì´ ìˆìœ¼ë©´ ê±°ë¦¬ ê³„ì‚°
  if (!result.distance_km && result.speed_kph && result.duration_min) {
    result.distance_km = Number((result.speed_kph * (result.duration_min / 60)).toFixed(2));
  }

  // ì†ë„ê°€ ì—†ê³  ê±°ë¦¬+ì‹œê°„ì´ ìˆìœ¼ë©´ ì†ë„ ê³„ì‚°
  if (!result.speed_kph && result.distance_km && result.duration_min && result.duration_min > 0) {
    result.speed_kph = Number((result.distance_km / (result.duration_min / 60)).toFixed(2));
  }

  return result;
};

/**
 * ì¹´í…Œê³ ë¦¬ë³„ UI í‘œì‹œìš© ì•„ì´ì½˜
 */
export const getCardioIcon = (workoutName: string): string => {
  const category = mapToCardioCategory(workoutName);
  const icons: Record<CardioCategory, string> = {
    running: 'ğŸƒ',
    stepmill: 'ğŸªœ',
    rowing: 'ğŸš£',
    cycle: 'ğŸš´',
    other: 'ğŸ’¨',
  };
  return icons[category];
};

/**
 * í™˜ì‚° ë¹„ìœ¨ UI í‘œì‹œìš© í…ìŠ¤íŠ¸
 */
export const getMultiplierText = (workoutName: string): string => {
  const multiplier = getCardioMultiplier(workoutName);
  return multiplier === 1.0 ? '' : `Ã—${multiplier}`;
};

/**
 * ì¹´í…Œê³ ë¦¬ë³„ í•œê¸€ ì´ë¦„
 */
export const getCardioCategoryName = (workoutName: string): string => {
  const category = mapToCardioCategory(workoutName);
  const names: Record<CardioCategory, string> = {
    running: 'ëŸ¬ë‹',
    stepmill: 'ìŠ¤í…ë°€',
    rowing: 'ë¡œì‰',
    cycle: 'ì‚¬ì´í´',
    other: 'ê¸°íƒ€ ìœ ì‚°ì†Œ',
  };
  return names[category];
};
</file>

<file path="src/features/speech/useSpeechRecognition.ts">
import { useState, useEffect, useRef, useCallback } from 'react';
import type { SpeechRecognitionHookResult } from '../../types';

export const useSpeechRecognition = (): SpeechRecognitionHookResult => {
  const [isListening, setIsListening] = useState(false);
  const [transcript, setTranscript] = useState('');
  const [interimTranscript, setInterimTranscript] = useState('');
  const [error, setError] = useState<string | null>(null);
  const recognitionRef = useRef<SpeechRecognition | null>(null);

  const isSupported =
    typeof window !== 'undefined' &&
    ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window);

  useEffect(() => {
    if (!isSupported) return;

    const SpeechRecognitionAPI =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognitionAPI();

    recognition.lang = 'ko-KR';
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      setIsListening(true);
      setError(null);
    };

    recognition.onresult = (event: SpeechRecognitionEvent) => {
      let interim = '';
      let final = '';

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcriptPiece = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          final += transcriptPiece + ' ';
        } else {
          interim += transcriptPiece;
        }
      }

      if (final) {
        setTranscript((prev) => prev + final);
      }
      setInterimTranscript(interim);
    };

    recognition.onerror = (event: SpeechRecognitionErrorEvent) => {
      console.error('Speech recognition error:', event.error);

      let errorMessage = '';
      switch (event.error) {
        case 'not-allowed':
        case 'service-not-allowed':
          errorMessage = 'ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
          break;
        case 'no-speech':
          errorMessage = 'ìŒì„±ì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
          break;
        case 'network':
          errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          break;
        case 'aborted':
          errorMessage = 'ìŒì„± ì¸ì‹ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
          break;
        default:
          errorMessage = `ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}`;
      }

      setError(errorMessage);
      setIsListening(false);
    };

    recognition.onend = () => {
      setIsListening(false);
      setInterimTranscript('');
    };

    recognitionRef.current = recognition;

    return () => {
      if (recognitionRef.current) {
        recognitionRef.current.abort();
      }
    };
  }, [isSupported]);

  const startListening = useCallback(() => {
    if (!isSupported) {
      setError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ë˜ëŠ” Edgeë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
      return;
    }

    if (recognitionRef.current && !isListening) {
      setError(null);
      setInterimTranscript('');
      try {
        recognitionRef.current.start();
      } catch (err) {
        console.error('Failed to start recognition:', err);
        setError('ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    }
  }, [isListening, isSupported]);

  const stopListening = useCallback(() => {
    if (recognitionRef.current && isListening) {
      recognitionRef.current.stop();
    }
  }, [isListening]);

  const resetTranscript = useCallback(() => {
    setTranscript('');
    setInterimTranscript('');
    setError(null);
  }, []);

  return {
    isListening,
    transcript,
    interimTranscript,
    error,
    isSupported,
    startListening,
    stopListening,
    resetTranscript,
  };
};
</file>

<file path="src/index.css">
body {
  margin: 0;
  min-width: 320px;
}

#root {
  min-height: 100vh;
}
</file>

<file path="src/lib/supabase.ts">
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseKey = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;

if (!supabaseUrl || !supabaseKey) {
  throw new Error('Missing Supabase environment variables');
}

export const supabase = createClient(supabaseUrl, supabaseKey);
</file>

<file path="src/pages/ChallengeDetail.tsx">
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import challengeService from '../services/challengeService';
import type { ChallengeDetailWithContributors } from '../types';

export const ChallengeDetailPage = () => {
  const { clubId, challengeId } = useParams<{ clubId: string; challengeId: string }>();
  const navigate = useNavigate();
  const [challenge, setChallenge] = useState<ChallengeDetailWithContributors | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (challengeId) {
      loadChallenge();
    }
  }, [challengeId]);

  const loadChallenge = async () => {
    if (!challengeId) return;

    setLoading(true);
    try {
      const data = await challengeService.getChallengeDetail(challengeId);
      setChallenge(data);

      // Auto-update status
      await challengeService.checkAndUpdateChallengeStatus(challengeId);
    } catch (error) {
      console.error('ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
      alert('ì±Œë¦°ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      navigate(`/club/${clubId}`);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="container">
        <div className="loading-screen">ë¡œë”© ì¤‘...</div>
      </div>
    );
  }

  if (!challenge) {
    return (
      <div className="container">
        <div className="empty-state">
          <p>ì±Œë¦°ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    );
  }

  const progress = challengeService.calculateProgress(
    challenge.current_value,
    challenge.target_value
  );

  const getChallengeTypeLabel = (type: string) => {
    switch (type) {
      case 'total_workouts':
        return 'ì´ ìš´ë™ ìˆ˜';
      case 'total_volume':
        return 'ì´ ë³¼ë¥¨ (kg)';
      case 'total_duration':
        return 'ì´ ì‹œê°„ (ë¶„)';
      case 'total_distance':
        return 'ì´ ê±°ë¦¬ (km)';
      default:
        return type;
    }
  };

  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'active':
        return { text: 'ì§„í–‰ ì¤‘', color: 'var(--primary-color)' };
      case 'completed':
        return { text: 'ì™„ë£Œ', color: '#4CAF50' };
      case 'failed':
        return { text: 'ì‹¤íŒ¨', color: '#F44336' };
      default:
        return { text: status, color: 'var(--text-secondary)' };
    }
  };

  const statusBadge = getStatusBadge(challenge.status);

  return (
    <div className="container">
      <div className="header">
        <button className="back-button" onClick={() => navigate(`/club/${clubId}`)}>
          â† ë’¤ë¡œ
        </button>
        <h2>ì±Œë¦°ì§€ ìƒì„¸</h2>
      </div>

      {/* Challenge Info */}
      <div className="section">
        <div
          style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '12px',
          }}
        >
          <h3 style={{ fontSize: '20px', fontWeight: '700', margin: 0 }}>
            {challenge.title}
          </h3>
          <span
            style={{
              fontSize: '12px',
              padding: '4px 12px',
              background: statusBadge.color,
              color: 'white',
              borderRadius: '6px',
              fontWeight: '600',
            }}
          >
            {statusBadge.text}
          </span>
        </div>
        {challenge.description && (
          <p
            style={{
              fontSize: '14px',
              color: 'var(--text-secondary)',
              marginBottom: '16px',
            }}
          >
            {challenge.description}
          </p>
        )}
        <div className="log-meta" style={{ marginBottom: '16px' }}>
          <span>{getChallengeTypeLabel(challenge.challenge_type)}</span>
          <span>
            {challenge.start_date} ~ {challenge.end_date}
          </span>
        </div>

        {/* Progress */}
        <div className="progress-bar-container" style={{ marginBottom: '8px' }}>
          <div className="progress-bar" style={{ width: `${progress}%` }} />
        </div>
        <div
          className="progress-text"
          style={{ fontSize: '18px', fontWeight: '700', textAlign: 'center' }}
        >
          {challenge.current_value} / {challenge.target_value} ({progress}%)
        </div>
      </div>

      {/* Leaderboard */}
      <div className="section">
        <h3>ê¸°ì—¬ ìˆœìœ„ ğŸ†</h3>
        {challenge.contributors.length === 0 ? (
          <p
            style={{
              textAlign: 'center',
              color: 'var(--text-secondary)',
              padding: '20px',
            }}
          >
            ì•„ì§ ê¸°ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.
          </p>
        ) : (
          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
            {challenge.contributors.map((contributor, idx) => (
              <div
                key={contributor.user.id}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  padding: '16px',
                  background: idx === 0 ? 'rgba(255, 215, 0, 0.1)' : 'var(--input-bg)',
                  border: `1px solid ${idx === 0 ? 'gold' : 'var(--border-color)'}`,
                  borderRadius: '8px',
                }}
              >
                <div
                  style={{
                    fontSize: '20px',
                    fontWeight: '700',
                    minWidth: '30px',
                  }}
                >
                  {idx === 0 && 'ğŸ¥‡'}
                  {idx === 1 && 'ğŸ¥ˆ'}
                  {idx === 2 && 'ğŸ¥‰'}
                  {idx > 2 && `${idx + 1}`}
                </div>
                <div
                  className="profile-avatar"
                  style={{ width: '40px', height: '40px', fontSize: '16px' }}
                >
                  {contributor.user.display_name[0]}
                </div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: '15px', fontWeight: '600' }}>
                    {contributor.user.display_name}
                  </div>
                  <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                    @{contributor.user.username}
                  </div>
                </div>
                <div
                  style={{
                    fontSize: '18px',
                    fontWeight: '700',
                    color: 'var(--primary-color)',
                  }}
                >
                  {contributor.total_contribution.toLocaleString()}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Contribute Button */}
      {challenge.status === 'active' && (
        <button
          className="primary-button"
          onClick={() => {
            // Navigate to History page
            navigate('/', { state: { contributeChallengeId: challengeId } });
          }}
        >
          ğŸ’ª ìš´ë™ ê¸°ë¡í•˜ê³  ê¸°ì—¬í•˜ê¸°
        </button>
      )}
    </div>
  );
};
</file>

<file path="src/pages/Club.tsx">
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import clubService from '../services/clubService';
import type { ClubWithMemberInfo, Club } from '../types';

export const ClubPage = () => {
  const navigate = useNavigate();
  const [view, setView] = useState<'my' | 'public'>('my');
  const [myClubs, setMyClubs] = useState<ClubWithMemberInfo[]>([]);
  const [publicClubs, setPublicClubs] = useState<Club[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadClubs();
  }, [view]);

  const loadClubs = async () => {
    setLoading(true);
    try {
      if (view === 'my') {
        const clubs = await clubService.getMyClubs();
        setMyClubs(clubs);
      } else {
        const clubs = await clubService.searchPublicClubs(searchQuery);
        setPublicClubs(clubs);
      }
    } catch (error) {
      console.error('í´ëŸ½ ë¡œë“œ ì‹¤íŒ¨:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = async () => {
    if (view === 'public') {
      await loadClubs();
    }
  };

  const getRoleBadge = (role: string) => {
    switch (role) {
      case 'owner':
        return 'ğŸ‘‘ ì†Œìœ ì';
      case 'admin':
        return 'â­ ê´€ë¦¬ì';
      default:
        return 'ğŸ‘¤ ë©¤ë²„';
    }
  };

  return (
    <div className="container">
      <div className="header">
        <h1>í´ëŸ½</h1>
        <button className="add-button" onClick={() => navigate('/club/create')}>
          + ë§Œë“¤ê¸°
        </button>
      </div>

      {/* Tab Selector */}
      <div className="mode-selector">
        <button
          className={`mode-button ${view === 'my' ? 'active' : ''}`}
          onClick={() => setView('my')}
        >
          ë‚´ í´ëŸ½
        </button>
        <button
          className={`mode-button ${view === 'public' ? 'active' : ''}`}
          onClick={() => setView('public')}
        >
          ê³µê°œ í´ëŸ½
        </button>
      </div>

      {/* Search (public clubs) */}
      {view === 'public' && (
        <div className="section" style={{ marginBottom: '20px' }}>
          <div style={{ display: 'flex', gap: '8px' }}>
            <input
              type="text"
              className="text-input-area"
              placeholder="í´ëŸ½ ì´ë¦„ ê²€ìƒ‰..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
              style={{ flex: 1, minHeight: 'auto', padding: '12px' }}
            />
            <button className="primary-button" onClick={handleSearch}>
              ê²€ìƒ‰
            </button>
          </div>
        </div>
      )}

      {/* Loading */}
      {loading ? (
        <div className="loading-screen">ë¡œë”© ì¤‘...</div>
      ) : (
        <>
          {/* My Clubs */}
          {view === 'my' && (
            <>
              {myClubs.length === 0 ? (
                <div className="empty-state">
                  <p>ì•„ì§ ê°€ì…í•œ í´ëŸ½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                  <button className="primary-button" onClick={() => navigate('/club/create')}>
                    ì²« í´ëŸ½ ë§Œë“¤ê¸°
                  </button>
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                  {myClubs.map((club) => (
                    <div
                      key={club.id}
                      className="log-item"
                      onClick={() => navigate(`/club/${club.id}`)}
                      style={{ cursor: 'pointer' }}
                    >
                      <div
                        style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          marginBottom: '8px',
                        }}
                      >
                        <h3 style={{ fontSize: '18px', fontWeight: '600', margin: 0 }}>
                          {club.name}
                        </h3>
                        <span
                          style={{
                            fontSize: '12px',
                            padding: '4px 10px',
                            background: 'var(--primary-color)',
                            color: 'white',
                            borderRadius: '6px',
                          }}
                        >
                          {getRoleBadge(club.my_role)}
                        </span>
                      </div>
                      {club.description && (
                        <p
                          style={{
                            fontSize: '14px',
                            color: 'var(--text-secondary)',
                            marginBottom: '8px',
                          }}
                        >
                          {club.description}
                        </p>
                      )}
                      <div className="log-meta">
                        <span>{club.is_public ? 'ğŸŒ ê³µê°œ' : 'ğŸ”’ ë¹„ê³µê°œ'}</span>
                        <span>ê°€ì…ì¼: {new Date(club.joined_at).toLocaleDateString()}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </>
          )}

          {/* Public Clubs */}
          {view === 'public' && (
            <>
              {publicClubs.length === 0 ? (
                <div className="empty-state">
                  <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                  {publicClubs.map((club) => (
                    <div
                      key={club.id}
                      className="log-item"
                      onClick={() => navigate(`/club/${club.id}`)}
                      style={{ cursor: 'pointer' }}
                    >
                      <h3 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '8px' }}>
                        {club.name}
                      </h3>
                      {club.description && (
                        <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>
                          {club.description}
                        </p>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </>
          )}
        </>
      )}
    </div>
  );
};
</file>

<file path="src/pages/CreateClub.tsx">
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import clubService from '../services/clubService';

export const CreateClubPage = () => {
  const navigate = useNavigate();
  const [name, setName] = useState('');
  const [description, setDescription] = useState('');
  const [isPublic, setIsPublic] = useState(false);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async () => {
    if (!name.trim()) {
      alert('í´ëŸ½ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    setLoading(true);
    try {
      const club = await clubService.createClub({
        name: name.trim(),
        description: description.trim() || undefined,
        is_public: isPublic,
      });
      alert('í´ëŸ½ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
      navigate(`/club/${club.id}`);
    } catch (error) {
      alert(error instanceof Error ? error.message : 'í´ëŸ½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container">
      <div className="header">
        <button className="back-button" onClick={() => navigate('/club')}>
          â† ë’¤ë¡œ
        </button>
        <h2>í´ëŸ½ ë§Œë“¤ê¸°</h2>
      </div>

      <div className="section">
        <h3>í´ëŸ½ ì •ë³´</h3>
        <div className="form-group">
          <label>í´ëŸ½ëª… *</label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="ì˜ˆ: í—¬ìŠ¤ì¥ ì¹œêµ¬ë“¤"
            maxLength={50}
            style={{
              width: '100%',
              padding: '12px',
              fontSize: '16px',
              border: '1px solid var(--border-color)',
              borderRadius: '8px',
              background: 'var(--input-bg)',
            }}
          />
          <div className="field-hint">{name.length}/50ì</div>
        </div>

        <div className="form-group">
          <label>ì„¤ëª…</label>
          <textarea
            className="text-input-area"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            placeholder="í´ëŸ½ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)"
            rows={4}
            maxLength={200}
          />
          <div className="field-hint">{description.length}/200ì</div>
        </div>

        <div className="form-group">
          <label className="checkbox-label">
            <input
              type="checkbox"
              checked={isPublic}
              onChange={(e) => setIsPublic(e.target.checked)}
            />
            <span>
              ê³µê°œ í´ëŸ½ìœ¼ë¡œ ë§Œë“¤ê¸°
              <div className="field-hint" style={{ marginTop: '4px' }}>
                ê³µê°œ í´ëŸ½ì€ ëˆ„êµ¬ë‚˜ ê²€ìƒ‰í•˜ê³  ê°€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
            </span>
          </label>
        </div>
      </div>

      <div className="action-buttons">
        <button className="cancel-button" onClick={() => navigate('/club')}>
          ì·¨ì†Œ
        </button>
        <button
          className="primary-button"
          onClick={handleSubmit}
          disabled={loading || !name.trim()}
        >
          {loading ? 'ìƒì„± ì¤‘...' : 'í´ëŸ½ ë§Œë“¤ê¸°'}
        </button>
      </div>
    </div>
  );
};
</file>

<file path="src/pages/JoinClub.tsx">
import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import clubService from '../services/clubService';
import type { Club } from '../types';

export const JoinClubPage = () => {
  const { inviteCode } = useParams<{ inviteCode: string }>();
  const navigate = useNavigate();
  const [club, setClub] = useState<Club | null>(null);
  const [loading, setLoading] = useState(true);
  const [joining, setJoining] = useState(false);

  useEffect(() => {
    if (inviteCode) {
      loadClub();
    }
  }, [inviteCode]);

  const loadClub = async () => {
    if (!inviteCode) return;

    setLoading(true);
    try {
      const clubData = await clubService.getClubByInviteCode(inviteCode);
      if (!clubData) {
        alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ë§í¬ì…ë‹ˆë‹¤.');
        navigate('/club');
        return;
      }
      setClub(clubData);
    } catch (error) {
      console.error('í´ëŸ½ ì¡°íšŒ ì‹¤íŒ¨:', error);
      alert('í´ëŸ½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      navigate('/club');
    } finally {
      setLoading(false);
    }
  };

  const handleJoin = async () => {
    if (!club) return;

    setJoining(true);
    try {
      await clubService.joinClub(club.id);
      alert('í´ëŸ½ì— ê°€ì…í–ˆìŠµë‹ˆë‹¤!');
      navigate(`/club/${club.id}`);
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setJoining(false);
    }
  };

  if (loading) {
    return (
      <div className="container">
        <div className="loading-screen">ë¡œë”© ì¤‘...</div>
      </div>
    );
  }

  if (!club) {
    return (
      <div className="container">
        <div className="empty-state">
          <p>í´ëŸ½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          <button className="primary-button" onClick={() => navigate('/club')}>
            í´ëŸ½ ëª©ë¡ìœ¼ë¡œ
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="container">
      <div className="header">
        <button className="back-button" onClick={() => navigate('/club')}>
          â† ë’¤ë¡œ
        </button>
        <h2>í´ëŸ½ ê°€ì…</h2>
      </div>

      <div className="section">
        <h3 style={{ fontSize: '22px', fontWeight: '700', marginBottom: '12px' }}>
          {club.name}
        </h3>
        {club.description && (
          <p
            style={{
              fontSize: '15px',
              color: 'var(--text-secondary)',
              marginBottom: '16px',
              lineHeight: '1.6',
            }}
          >
            {club.description}
          </p>
        )}
        <div style={{ display: 'flex', gap: '8px', marginBottom: '24px' }}>
          <div className="stat-chip">{club.is_public ? 'ğŸŒ ê³µê°œ' : 'ğŸ”’ ë¹„ê³µê°œ'}</div>
        </div>

        <p
          style={{
            fontSize: '14px',
            color: 'var(--text-secondary)',
            marginBottom: '20px',
          }}
        >
          ì´ í´ëŸ½ì— ê°€ì…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
        </p>

        <div className="action-buttons">
          <button className="cancel-button" onClick={() => navigate('/club')}>
            ì·¨ì†Œ
          </button>
          <button className="primary-button" onClick={handleJoin} disabled={joining}>
            {joining ? 'ê°€ì… ì¤‘...' : 'ê°€ì…í•˜ê¸°'}
          </button>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/services/authService.ts">
// src/services/authService.ts
import { supabase } from '../lib/supabase';

export interface KakaoUserInfo {
  id: string;
  email: string;
  displayName: string;
  nickname: string;
  profileImage: string;
  birthyear?: string;
  gender?: string;
  phoneNumber?: string;
}

class AuthService {
  private readonly KAUTH_BASE = 'https://kauth.kakao.com';
  private readonly KAPI_BASE = 'https://kapi.kakao.com';

  // í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
  private requireEnv(key: string): string {
    const value = import.meta.env[key];
    if (!value) {
      throw new Error(`í™˜ê²½ë³€ìˆ˜ ${key}ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.`);
    }
    return value;
  }

  // POST ìš”ì²­ í—¬í¼
  private async postForm(url: string, params: Record<string, string>): Promise<Response> {
    const body = new URLSearchParams(params).toString();
    return fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body,
    });
  }

  // ì‘ë‹µ ê²€ì¦
  private async assertOk(res: Response, label: string): Promise<void> {
    if (!res.ok) {
      let text = '';
      try {
        text = await res.text();
      } catch {}
      throw new Error(`${label} ì‹¤íŒ¨(${res.status}). ${text || ''}`.trim());
    }
  }

  // 1. ì¹´ì¹´ì˜¤ ì¸ê°€ ì½”ë“œ â†’ í† í° â†’ ì‚¬ìš©ì ì •ë³´
  async getKakaoUserInfo(code: string): Promise<KakaoUserInfo> {
    if (!code) {
      throw new Error('ì¸ê°€ ì½”ë“œ(code)ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }

    const REST_API_KEY = this.requireEnv('VITE_KAKAO_REST_API_KEY');
    const currentOrigin = window.location.origin;
    const REDIRECT_URI = `${currentOrigin}/auth/kakao/callback`;
    const CLIENT_SECRET = import.meta.env.VITE_KAKAO_CLIENT_SECRET || '';

    console.log('ğŸ”‘ í† í° êµí™˜ìš© ë¦¬ë‹¤ì´ë ‰íŠ¸ URI:', REDIRECT_URI);

    const tokenParams: Record<string, string> = {
      grant_type: 'authorization_code',
      client_id: REST_API_KEY,
      redirect_uri: REDIRECT_URI,
      code,
    };

    if (CLIENT_SECRET) {
      tokenParams.client_secret = CLIENT_SECRET;
    }

    const tokenRes = await this.postForm(`${this.KAUTH_BASE}/oauth/token`, tokenParams);
    await this.assertOk(tokenRes, 'í† í° êµí™˜');
    const tokenJson = await tokenRes.json();
    const accessToken = tokenJson?.access_token;

    if (!accessToken) {
      throw new Error('í† í° êµí™˜ì€ ì„±ê³µí–ˆìœ¼ë‚˜ access_tokenì´ ì—†ìŠµë‹ˆë‹¤.');
    }

    return await this.getKakaoUserInfoFromAccessToken(accessToken);
  }

  // 2. Access Tokenìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
  async getKakaoUserInfoFromAccessToken(accessToken: string): Promise<KakaoUserInfo> {
    if (!accessToken) {
      throw new Error('access_tokenì´ ì—†ìŠµë‹ˆë‹¤.');
    }

    const meRes = await fetch(`${this.KAPI_BASE}/v2/user/me`, {
      headers: { Authorization: `Bearer ${accessToken}` },
    });

    await this.assertOk(meRes, 'ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ');
    const data = await meRes.json();

    const id = data?.id;
    if (!id) {
      throw new Error('ì¹´ì¹´ì˜¤ ì‘ë‹µì— ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤.');
    }

    const account = data?.kakao_account || {};
    const profile = account?.profile || {};

    const name = account?.name || '';
    const nickname = profile?.nickname || '';
    const gender = account?.gender || '';
    const birthyear = account?.birthyear || '';
    const phoneNumber = account?.phone_number || '';

    return {
      id: String(id),
      email: account?.email || '',
      displayName: name || nickname || 'ì‚¬ìš©ì',
      nickname,
      gender,
      birthyear,
      phoneNumber,
      profileImage: profile?.profile_image_url || '',
    };
  }

  // 3. Supabase: ì¹´ì¹´ì˜¤ IDë¡œ ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  async checkUserExistsByKakaoId(kakaoId: string): Promise<boolean> {
    const { data, error } = await supabase
      .from('users')
      .select('id')
      .eq('kakao_id', kakaoId)
      .maybeSingle();

    if (error && error.code !== 'PGRST116') {
      console.error('ì‚¬ìš©ì ì¡´ì¬ í™•ì¸ ì‹¤íŒ¨:', error);
      throw error;
    }

    return !!data;
  }

  // 4. Supabase: ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ë¡œ íšŒì›ê°€ì…
  async registerKakaoUser(kakaoInfo: KakaoUserInfo) {
    const { data, error } = await supabase
      .from('users')
      .insert({
        username: `kakao_${kakaoInfo.id}`,
        display_name: kakaoInfo.displayName,
        email: kakaoInfo.email,
        kakao_id: kakaoInfo.id,
        provider: 'kakao',
        profile_image: kakaoInfo.profileImage,
        phone_number: kakaoInfo.phoneNumber || null,
        birthyear: kakaoInfo.birthyear || null,
        gender: kakaoInfo.gender || null,
      })
      .select()
      .single();

    if (error) {
      console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
      throw error;
    }

    return data;
  }

  // 5. Supabase: ì¹´ì¹´ì˜¤ IDë¡œ ì‚¬ìš©ì ì¡°íšŒ
  async getUserByKakaoId(kakaoId: string) {
    const { data, error } = await supabase
      .from('users')
      .select('id, username, display_name, email, kakao_id, provider, profile_image')
      .eq('kakao_id', kakaoId)
      .single();

    if (error) {
      console.error('ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨:', error);
      throw error;
    }

    return data;
  }

  // 6. Supabase: ì‚¬ìš©ì í”„ë¡œí•„ ì—…ë°ì´íŠ¸
  async updateUserProfile(kakaoId: string, profileData: Partial<KakaoUserInfo>) {
    const updates: Record<string, any> = {};

    if (profileData.displayName !== undefined) {
      updates.display_name = profileData.displayName;
    }
    if (profileData.nickname !== undefined) {
      updates.nickname = profileData.nickname;
    }
    if (profileData.profileImage !== undefined) {
      updates.profile_image = profileData.profileImage;
    }
    if (profileData.email !== undefined) {
      updates.email = profileData.email;
    }
    if (profileData.phoneNumber !== undefined) {
      updates.phone_number = profileData.phoneNumber;
    }
    if (profileData.birthyear !== undefined) {
      updates.birthyear = profileData.birthyear;
    }
    if (profileData.gender !== undefined) {
      updates.gender = profileData.gender;
    }

    if (Object.keys(updates).length === 0) return;

    const { error } = await supabase
      .from('users')
      .update(updates)
      .eq('kakao_id', kakaoId);

    if (error) {
      console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
      throw error;
    }
  }
}

export default new AuthService();
</file>

<file path="src/services/clubService.ts">
import * as clubStorage from '../storage/clubStorage';
import type {
  Club,
  ClubWithMemberInfo,
  ClubDetail,
  ClubMemberWithUser,
  ClubFeedWithDetails,
} from '../types';

class ClubService {
  // ===== Club Management =====

  async createClub(data: {
    name: string;
    description?: string;
    is_public: boolean;
  }): Promise<Club> {
    // Validation: club name length
    if (data.name.trim().length < 2) {
      throw new Error('í´ëŸ½ëª…ì€ ìµœì†Œ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    }
    if (data.name.length > 50) {
      throw new Error('í´ëŸ½ëª…ì€ ìµœëŒ€ 50ìê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    }

    return await clubStorage.createClub(data);
  }

  async getMyClubs(): Promise<ClubWithMemberInfo[]> {
    return await clubStorage.getMyClubs();
  }

  async searchPublicClubs(query?: string): Promise<Club[]> {
    return await clubStorage.searchPublicClubs(query);
  }

  async getClubDetail(clubId: string): Promise<ClubDetail> {
    return await clubStorage.getClubDetail(clubId);
  }

  async updateClub(
    clubId: string,
    updates: Partial<Pick<Club, 'name' | 'description' | 'is_public'>>
  ): Promise<void> {
    if (updates.name && updates.name.trim().length < 2) {
      throw new Error('í´ëŸ½ëª…ì€ ìµœì†Œ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    }
    return await clubStorage.updateClub(clubId, updates);
  }

  async deleteClub(clubId: string): Promise<void> {
    // Optional: check if club has members other than owner
    const members = await clubStorage.getClubMembers(clubId);
    if (members.length > 1) {
      throw new Error('ë©¤ë²„ê°€ ìˆëŠ” í´ëŸ½ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë©¤ë²„ë¥¼ í‡´ì¶œí•´ì£¼ì„¸ìš”.');
    }
    return await clubStorage.deleteClub(clubId);
  }

  // ===== Invite Link =====

  getInviteLink(inviteCode: string): string {
    const origin = window.location.origin;
    return `${origin}/club/join/${inviteCode}`;
  }

  async getClubByInviteCode(inviteCode: string): Promise<Club | null> {
    return await clubStorage.getClubByInviteCode(inviteCode);
  }

  // ===== Member Management =====

  async joinClub(clubId: string): Promise<void> {
    return await clubStorage.joinClub(clubId);
  }

  async leaveClub(clubId: string): Promise<void> {
    return await clubStorage.leaveClub(clubId);
  }

  async getClubMembers(clubId: string): Promise<ClubMemberWithUser[]> {
    return await clubStorage.getClubMembers(clubId);
  }

  async updateMemberRole(memberId: string, newRole: 'admin' | 'member'): Promise<void> {
    return await clubStorage.updateMemberRole(memberId, newRole);
  }

  async removeMember(memberId: string): Promise<void> {
    return await clubStorage.removeMember(memberId);
  }

  // ===== Feed Management =====

  async shareWorkoutToClub(clubId: string, workoutLogId: string): Promise<void> {
    return await clubStorage.shareWorkoutToClub(clubId, workoutLogId);
  }

  async getClubFeeds(
    clubId: string,
    limit?: number,
    offset?: number
  ): Promise<ClubFeedWithDetails[]> {
    return await clubStorage.getClubFeeds(clubId, limit, offset);
  }

  async unshareWorkout(feedId: string): Promise<void> {
    return await clubStorage.unshareWorkout(feedId);
  }

  // ===== Kakao Share =====

  shareToKakao(club: Club): void {
    const inviteLink = this.getInviteLink(club.invite_code);

    // Check if Kakao SDK is available and initialized
    if (window.Kakao && window.Kakao.isInitialized()) {
      window.Kakao.Share.sendDefault({
        objectType: 'feed',
        content: {
          title: `${club.name} í´ëŸ½ì— ì´ˆëŒ€í•©ë‹ˆë‹¤!`,
          description: club.description || 'í•¨ê»˜ ìš´ë™í•˜ë©° ì±Œë¦°ì§€ë¥¼ ì™„ë£Œí•´ë³´ì„¸ìš”!',
          imageUrl: 'https://via.placeholder.com/300x200.png?text=Workout+Club',
          link: {
            mobileWebUrl: inviteLink,
            webUrl: inviteLink,
          },
        },
        buttons: [
          {
            title: 'í´ëŸ½ ê°€ì…í•˜ê¸°',
            link: {
              mobileWebUrl: inviteLink,
              webUrl: inviteLink,
            },
          },
        ],
      });
    } else {
      // Fallback: copy to clipboard
      navigator.clipboard.writeText(inviteLink);
      alert('ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
  }
}

export default new ClubService();
</file>

<file path="src/storage/challengeStorage.ts">
import type {
  Challenge,
  ChallengeScope,
  ChallengeGoalMetric,
  ChallengeStatus,
  ChallengeDetailWithContributors,
} from '../types';
import { supabase } from '../lib/supabase';

// Get current user ID from localStorage
const getCurrentUserId = (): string => {
  const userStr = localStorage.getItem('current_user');
  if (!userStr) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  const user = JSON.parse(userStr);
  return user.id;
};

// ============================================
// Challenge CRUD Functions (Two-Track)
// ============================================

export const createChallenge = async (data: {
  scope: ChallengeScope;
  club_id?: string;
  title: string;
  description?: string;
  goal_metric: ChallengeGoalMetric;
  goal_value: number;
  start_date: string;
  end_date: string;
  meta_data?: Record<string, any>;
}): Promise<Challenge> => {
  try {
    const userId = getCurrentUserId();

    const { data: challenge, error } = await supabase
      .from('challenges')
      .insert({
        scope: data.scope,
        club_id: data.club_id || null,
        title: data.title,
        description: data.description || null,
        goal_metric: data.goal_metric,
        goal_value: data.goal_value,
        start_date: data.start_date,
        end_date: data.end_date,
        meta_data: data.meta_data || {},
        created_by: userId,
      })
      .select()
      .single();

    if (error) throw error;
    return challenge;
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ìƒì„± ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ê¸€ë¡œë²Œ ì±Œë¦°ì§€ ì¡°íšŒ
export const getGlobalChallenges = async (
  statusFilter?: ChallengeStatus
): Promise<Challenge[]> => {
  try {
    let query = supabase
      .from('challenges')
      .select('*')
      .eq('scope', 'global');

    if (statusFilter) {
      query = query.eq('status', statusFilter);
    }

    const { data, error } = await query.order('created_at', { ascending: false });

    if (error) throw error;
    return data || [];
  } catch (error) {
    console.error('ê¸€ë¡œë²Œ ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// í´ëŸ½ ì±Œë¦°ì§€ ì¡°íšŒ
export const getClubChallenges = async (
  clubId: string,
  statusFilter?: ChallengeStatus
): Promise<Challenge[]> => {
  try {
    let query = supabase
      .from('challenges')
      .select('*')
      .eq('scope', 'club')
      .eq('club_id', clubId);

    if (statusFilter) {
      query = query.eq('status', statusFilter);
    }

    const { data, error } = await query.order('created_at', { ascending: false });

    if (error) throw error;
    return data || [];
  } catch (error) {
    console.error('í´ëŸ½ ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// í™œì„± ì±Œë¦°ì§€ ì¡°íšŒ (Activeë§Œ)
export const getActiveChallenges = async (clubId?: string): Promise<Challenge[]> => {
  try {
    let query = supabase
      .from('challenges')
      .select('*')
      .eq('status', 'active');

    if (clubId) {
      // íŠ¹ì • í´ëŸ½ì˜ active ì±Œë¦°ì§€ë§Œ
      query = query.eq('scope', 'club').eq('club_id', clubId);
    }

    const { data, error } = await query.order('end_date', { ascending: true });

    if (error) throw error;
    return data || [];
  } catch (error) {
    console.error('í™œì„± ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ì±Œë¦°ì§€ ìƒì„¸ ì¡°íšŒ
export const getChallengeDetail = async (
  challengeId: string
): Promise<ChallengeDetailWithContributors> => {
  try {
    // 1. Get challenge info
    const { data: challenge, error: challengeError } = await supabase
      .from('challenges')
      .select('*')
      .eq('id', challengeId)
      .single();

    if (challengeError) throw challengeError;

    // 2. Get contributor rankings
    const { data: contributions, error: contributionError } = await supabase
      .from('challenge_participants')
      .select(`
        user_id,
        users (
          id,
          username,
          display_name,
          profile_image
        ),
        contribution_value
      `)
      .eq('challenge_id', challengeId);

    if (contributionError) throw contributionError;

    // Aggregate by user and sort
    const contributorMap = new Map<string, any>();
    (contributions || []).forEach((item: any) => {
      const userId = item.user_id;
      if (!contributorMap.has(userId)) {
        contributorMap.set(userId, {
          user: item.users,
          total_contribution: 0,
        });
      }
      const contributor = contributorMap.get(userId);
      contributor.total_contribution += item.contribution_value;
    });

    const contributors = Array.from(contributorMap.values()).sort(
      (a, b) => b.total_contribution - a.total_contribution
    );

    return {
      ...challenge,
      // Map new field names to old for compatibility
      challenge_type: challenge.goal_metric,
      target_value: challenge.goal_value,
      contributors,
    } as any;
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ì±Œë¦°ì§€ ìˆ˜ì •
export const updateChallenge = async (
  challengeId: string,
  updates: Partial<Pick<Challenge, 'title' | 'description' | 'status' | 'meta_data'>>
): Promise<void> => {
  try {
    const { error } = await supabase
      .from('challenges')
      .update(updates)
      .eq('id', challengeId);

    if (error) throw error;
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ì±Œë¦°ì§€ ì‚­ì œ
export const deleteChallenge = async (challengeId: string): Promise<void> => {
  try {
    const { error } = await supabase
      .from('challenges')
      .delete()
      .eq('id', challengeId);

    if (error) throw error;
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ì‚­ì œ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ============================================
// One Log, Multi Hit Logic
// ============================================

/**
 * ìš´ë™ ë¡œê·¸ê°€ ì €ì¥ë˜ì—ˆì„ ë•Œ, ìë™ìœ¼ë¡œ ê´€ë ¨ëœ ëª¨ë“  ì±Œë¦°ì§€ì— ê¸°ì—¬í•©ë‹ˆë‹¤.
 * @param workoutLogId ìš´ë™ ê¸°ë¡ ID
 * @returns ì—…ë°ì´íŠ¸ëœ ì±Œë¦°ì§€ ëª©ë¡
 */
export const contributeToAllRelevantChallenges = async (
  workoutLogId: string
): Promise<Challenge[]> => {
  try {
    const userId = getCurrentUserId();

    // 1. Get workout log data
    const { data: workoutLog, error: logError } = await supabase
      .from('workout_logs')
      .select(`
        id,
        user_id,
        workouts (
          sets,
          reps,
          weight_kg,
          duration_min
        )
      `)
      .eq('id', workoutLogId)
      .single();

    if (logError) throw logError;

    // 2. Get all active challenges (global + my clubs)
    // 2-1. Global challenges
    const { data: globalChallenges } = await supabase
      .from('challenges')
      .select('*')
      .eq('scope', 'global')
      .eq('status', 'active')
      .lte('start_date', new Date().toISOString().split('T')[0])
      .gte('end_date', new Date().toISOString().split('T')[0]);

    // 2-2. My club challenges
    const { data: myClubs } = await supabase
      .from('club_members')
      .select('club_id')
      .eq('user_id', userId);

    const clubIds = (myClubs || []).map((m: any) => m.club_id);

    let clubChallenges: any[] = [];
    if (clubIds.length > 0) {
      const { data } = await supabase
        .from('challenges')
        .select('*')
        .eq('scope', 'club')
        .in('club_id', clubIds)
        .eq('status', 'active')
        .lte('start_date', new Date().toISOString().split('T')[0])
        .gte('end_date', new Date().toISOString().split('T')[0]);

      clubChallenges = data || [];
    }

    const allChallenges = [...(globalChallenges || []), ...clubChallenges];

    // 3. Calculate contribution for each challenge
    const updatedChallenges: Challenge[] = [];
    const workouts = workoutLog.workouts || [];

    for (const challenge of allChallenges) {
      let contributionValue = 0;

      switch (challenge.goal_metric) {
        case 'total_workouts':
          contributionValue = workouts.length;
          break;
        case 'total_volume':
          contributionValue = workouts.reduce(
            (sum: number, w: any) => sum + ((w.sets || 0) * (w.reps || 0) * (w.weight_kg || 0)),
            0
          );
          break;
        case 'total_duration':
          contributionValue = workouts.reduce((sum: number, w: any) => sum + (w.duration_min || 0), 0);
          break;
        case 'total_distance':
          // distance_km field would be needed
          contributionValue = 0;
          break;
      }

      if (contributionValue === 0) continue;

      // 4. Add contribution record
      const { error: contributionError } = await supabase
        .from('challenge_participants')
        .insert({
          challenge_id: challenge.id,
          user_id: userId,
          workout_log_id: workoutLogId,
          contribution_value: contributionValue,
        });

      if (contributionError) {
        // Already contributed (duplicate), skip
        if (contributionError.code === '23505') continue;
        throw contributionError;
      }

      // 5. Update challenge current_value
      const newValue = (challenge.current_value || 0) + contributionValue;
      const { error: updateError } = await supabase
        .from('challenges')
        .update({ current_value: newValue })
        .eq('id', challenge.id);

      if (!updateError) {
        updatedChallenges.push({ ...challenge, current_value: newValue });
      }
    }

    return updatedChallenges;
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ìë™ ê¸°ì—¬ ì‹¤íŒ¨:', error);
    // Don't throw - this is a background process
    return [];
  }
};

// ê°œë³„ ì±Œë¦°ì§€ì— ìˆ˜ë™ ê¸°ì—¬ (ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€)
export const contributeToChallenge = async (
  challengeId: string,
  workoutLogId: string
): Promise<void> => {
  try {
    const userId = getCurrentUserId();

    // 1. Get workout log
    const { data: workoutLog, error: logError } = await supabase
      .from('workout_logs')
      .select(`
        id,
        workouts (
          sets,
          reps,
          weight_kg,
          duration_min
        )
      `)
      .eq('id', workoutLogId)
      .single();

    if (logError) throw logError;

    // 2. Get challenge type
    const { data: challenge } = await supabase
      .from('challenges')
      .select('goal_metric')
      .eq('id', challengeId)
      .single();

    let contributionValue = 0;
    const workouts = workoutLog.workouts || [];

    switch (challenge?.goal_metric) {
      case 'total_workouts':
        contributionValue = workouts.length;
        break;
      case 'total_volume':
        contributionValue = workouts.reduce(
          (sum: number, w: any) => sum + ((w.sets || 0) * (w.reps || 0) * (w.weight_kg || 0)),
          0
        );
        break;
      case 'total_duration':
        contributionValue = workouts.reduce((sum: number, w: any) => sum + (w.duration_min || 0), 0);
        break;
      case 'total_distance':
        contributionValue = 0;
        break;
    }

    if (contributionValue === 0) {
      throw new Error('ê¸°ì—¬í•  ìˆ˜ ìˆëŠ” ê°’ì´ ì—†ìŠµë‹ˆë‹¤.');
    }

    // 3. Add contribution record
    const { error: contributionError } = await supabase
      .from('challenge_participants')
      .insert({
        challenge_id: challengeId,
        user_id: userId,
        workout_log_id: workoutLogId,
        contribution_value: contributionValue,
      });

    if (contributionError) throw contributionError;

    // 4. Update challenge current_value
    const { data: currentChallenge } = await supabase
      .from('challenges')
      .select('current_value')
      .eq('id', challengeId)
      .single();

    await supabase
      .from('challenges')
      .update({
        current_value: (currentChallenge?.current_value || 0) + contributionValue,
      })
      .eq('id', challengeId);
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ê¸°ì—¬ ì‹¤íŒ¨:', error);
    throw error instanceof Error ? error : new Error('ì±Œë¦°ì§€ ê¸°ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// Date formatter (YYYY-MM-DD)
export const formatDate = (date: Date = new Date()): string => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};
</file>

<file path="src/types/challenge.ts">
/**
 * Challenge Maker - Type Definitions
 * Quest Builderìš© íƒ€ì… ì •ì˜
 */

import type { WorkoutCategory, WorkoutType } from './index';

// ì¶”ì í•  ì§€í‘œ íƒ€ì…
export type MetricType =
  | 'volume_kg' // ë³¼ë¥¨ (ê·¼ë ¥)
  | 'adjusted_dist_km' // ê±°ë¦¬ (ìœ ì‚°ì†Œ)
  | 'duration_min' // ì‹œê°„ (ì§€êµ¬ë ¥)
  | 'run_count' // ëŸ° ìˆ˜ (ìŠ¤ë…¸ë³´ë“œ/ê¸°ìˆ )
  | 'workout_count' // ìš´ë™ íšŸìˆ˜
  | 'attendance_days'; // ì¶œì„ ì¼ìˆ˜

// ì±Œë¦°ì§€ í…Œë§ˆ (Step 1)
export type QuestTheme = 'strength' | 'endurance' | 'skill' | 'consistency';

// ì§‘ê³„ ë°©ì‹
export type AggregationType = 'sum' | 'count';

// ì±Œë¦°ì§€ ê·œì¹™ (JSONB êµ¬ì¡°)
export interface ChallengeRules {
  target_metric: MetricType; // ì¶”ì í•  ì»¬ëŸ¼
  filter: {
    category?: WorkoutCategory[]; // ì¹´í…Œê³ ë¦¬ í•„í„° (ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´)
    type?: WorkoutType[]; // íƒ€ì… í•„í„° (ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´)
    keyword_include?: string[]; // ìš´ë™ ì´ë¦„ì— í¬í•¨ë˜ì–´ì•¼ í•˜ëŠ” í‚¤ì›Œë“œ
    keyword_exclude?: string[]; // ìš´ë™ ì´ë¦„ì— í¬í•¨ë˜ë©´ ì•ˆë˜ëŠ” í‚¤ì›Œë“œ
  };
  aggregation: AggregationType; // í•©ì‚° ë°©ì‹
  goal_value: number; // ëª©í‘œ ìˆ˜ì¹˜
  unit: string; // í‘œì‹œ ë‹¨ìœ„ (kg, km, ë¶„, íšŒ, ì¼)
}

// ì±Œë¦°ì§€ ìƒì„± DTO
export interface CreateChallengeDTO {
  club_id: string;
  title: string;
  description?: string;
  rules: ChallengeRules;
  start_date: string;
  end_date: string;
  theme_color?: string; // í…Œë§ˆ ìƒ‰ìƒ
}

// ì±Œë¦°ì§€ í…œí”Œë¦¿
export interface ChallengeTemplate {
  id: string;
  name: string;
  description: string;
  emoji: string;
  theme: QuestTheme;
  rules: ChallengeRules;
  recommended_duration_days: number; // ê¶Œì¥ ê¸°ê°„
}

// ì°¸ì¡° ê°€ì´ë“œ (ëª©í‘œ ìˆ˜ì¹˜ ë„ìš°ë¯¸)
export interface ReferenceGuide {
  value: number;
  description: string;
  emoji: string;
}

// ì¸ê¸° í…œí”Œë¦¿ ëª©ë¡
export const CHALLENGE_TEMPLATES: ChallengeTemplate[] = [
  {
    id: 'powerlifting_500',
    name: '3ëŒ€ 500 ë‹¬ì„±',
    description: 'ìŠ¤ì¿¼íŠ¸+ë²¤ì¹˜í”„ë ˆìŠ¤+ë°ë“œë¦¬í”„íŠ¸ ì´ ë³¼ë¥¨ 500kg',
    emoji: 'ğŸ‹ï¸',
    theme: 'strength',
    rules: {
      target_metric: 'volume_kg',
      filter: {
        category: ['gym', 'home'],
        type: ['strength'],
        keyword_include: ['squat', 'bench', 'deadlift', 'ìŠ¤ì¿¼íŠ¸', 'ë²¤ì¹˜', 'ë°ë“œ'],
      },
      aggregation: 'sum',
      goal_value: 500000, // 500í†¤
      unit: 'kg',
    },
    recommended_duration_days: 90,
  },
  {
    id: 'seoul_busan',
    name: 'ì„œìš¸-ë¶€ì‚° ì™„ì£¼',
    description: 'ì´ ê±°ë¦¬ 400km ëˆ„ì ',
    emoji: 'ğŸƒ',
    theme: 'endurance',
    rules: {
      target_metric: 'adjusted_dist_km',
      filter: {
        category: ['running', 'gym'],
        type: ['cardio'],
      },
      aggregation: 'sum',
      goal_value: 400,
      unit: 'km',
    },
    recommended_duration_days: 60,
  },
  {
    id: 'everest_climb',
    name: 'ì—ë² ë ˆìŠ¤íŠ¸ ë“±ì •',
    description: 'ìŠ¤ë…¸ë³´ë“œ ëŸ° 8,848íšŒ ë‹¬ì„±',
    emoji: 'ğŸ‚',
    theme: 'skill',
    rules: {
      target_metric: 'run_count',
      filter: {
        category: ['snowboard'],
      },
      aggregation: 'sum',
      goal_value: 8848,
      unit: 'íšŒ',
    },
    recommended_duration_days: 120,
  },
  {
    id: 'perfect_attendance',
    name: 'ê°œê·¼ìƒ',
    description: '30ì¼ ì—°ì† ì¶œì„',
    emoji: 'ğŸ“…',
    theme: 'consistency',
    rules: {
      target_metric: 'attendance_days',
      filter: {},
      aggregation: 'count',
      goal_value: 30,
      unit: 'ì¼',
    },
    recommended_duration_days: 30,
  },
  {
    id: 'squat_titan',
    name: 'ìŠ¤ì¿¼íŠ¸ 100í†¤',
    description: 'ìŠ¤ì¿¼íŠ¸ ìš´ë™ë§Œ 100í†¤ ëˆ„ì ',
    emoji: 'ğŸ¦µ',
    theme: 'strength',
    rules: {
      target_metric: 'volume_kg',
      filter: {
        category: ['gym', 'home'],
        type: ['strength'],
        keyword_include: ['squat', 'ìŠ¤ì¿¼íŠ¸'],
      },
      aggregation: 'sum',
      goal_value: 100000,
      unit: 'kg',
    },
    recommended_duration_days: 60,
  },
];

// ëª©í‘œ ìˆ˜ì¹˜ ì°¸ì¡° ê°€ì´ë“œ
export const REFERENCE_GUIDES: Record<MetricType, ReferenceGuide[]> = {
  volume_kg: [
    { value: 1000, description: 'ê²½ì°¨ 1ëŒ€', emoji: 'ğŸš—' },
    { value: 10000, description: 'ë¤í”„íŠ¸ëŸ­ 1ëŒ€', emoji: 'ğŸš›' },
    { value: 100000, description: 'ê³ ë˜ 1ë§ˆë¦¬', emoji: 'ğŸ‹' },
    { value: 500000, description: 'ë³´ì‰ 747 ê¸°ì²´', emoji: 'âœˆï¸' },
  ],
  adjusted_dist_km: [
    { value: 42.195, description: 'ë§ˆë¼í†¤ í’€ì½”ìŠ¤', emoji: 'ğŸƒ' },
    { value: 100, description: 'ìš¸íŠ¸ë¼ ë§ˆë¼í†¤', emoji: 'ğŸ¦¸' },
    { value: 400, description: 'ì„œìš¸-ë¶€ì‚° ê±°ë¦¬', emoji: 'ğŸš„' },
    { value: 10000, description: 'ì„œìš¸-ë‰´ìš• í¸ë„', emoji: 'âœˆï¸' },
  ],
  duration_min: [
    { value: 60, description: '1ì‹œê°„', emoji: 'â°' },
    { value: 600, description: '10ì‹œê°„', emoji: 'â³' },
    { value: 3000, description: '50ì‹œê°„ (2ì¼)', emoji: 'ğŸŒ™' },
    { value: 10000, description: '1ì£¼ì¼', emoji: 'ğŸ“…' },
  ],
  run_count: [
    { value: 100, description: 'ì´ˆë³´ ë³´ë”', emoji: 'ğŸ‚' },
    { value: 500, description: 'ì¤‘ê¸‰ ë¼ì´ë”', emoji: 'â›·ï¸' },
    { value: 1000, description: 'í”„ë¡œ ìˆ˜ì¤€', emoji: 'ğŸ†' },
    { value: 8848, description: 'ì—ë² ë ˆìŠ¤íŠ¸ ê³ ë„', emoji: 'ğŸ”ï¸' },
  ],
  workout_count: [
    { value: 50, description: 'ê¾¸ì¤€í•œ ì‹œì‘', emoji: 'ğŸ’ª' },
    { value: 100, description: 'ìŠµê´€ í˜•ì„±', emoji: 'ğŸ¯' },
    { value: 500, description: 'ì² ì¸ ìˆ˜ì¤€', emoji: 'ğŸ¦¾' },
    { value: 1000, description: 'ë ˆì „ë“œ', emoji: 'ğŸ‘‘' },
  ],
  attendance_days: [
    { value: 7, description: '1ì£¼ì¼ ê°œê·¼', emoji: 'ğŸ“…' },
    { value: 30, description: 'í•œ ë‹¬ ê°œê·¼', emoji: 'ğŸ—“ï¸' },
    { value: 100, description: '100ì¼ ì±Œë¦°ì§€', emoji: 'ğŸ’¯' },
    { value: 365, description: '1ë…„ ê°œê·¼', emoji: 'ğŸ†' },
  ],
};
</file>

<file path="src/types/speech.d.ts">
interface SpeechRecognition extends EventTarget {
  continuous: boolean;
  interimResults: boolean;
  lang: string;
  maxAlternatives: number;
  onaudioend: ((this: SpeechRecognition, ev: Event) => any) | null;
  onaudiostart: ((this: SpeechRecognition, ev: Event) => any) | null;
  onend: ((this: SpeechRecognition, ev: Event) => any) | null;
  onerror: ((this: SpeechRecognition, ev: SpeechRecognitionErrorEvent) => any) | null;
  onnomatch: ((this: SpeechRecognition, ev: SpeechRecognitionEvent) => any) | null;
  onresult: ((this: SpeechRecognition, ev: SpeechRecognitionEvent) => any) | null;
  onsoundend: ((this: SpeechRecognition, ev: Event) => any) | null;
  onsoundstart: ((this: SpeechRecognition, ev: Event) => any) | null;
  onspeechend: ((this: SpeechRecognition, ev: Event) => any) | null;
  onspeechstart: ((this: SpeechRecognition, ev: Event) => any) | null;
  onstart: ((this: SpeechRecognition, ev: Event) => any) | null;
  abort(): void;
  start(): void;
  stop(): void;
}

interface SpeechRecognitionErrorEvent extends Event {
  error: string;
  message: string;
}

interface SpeechRecognitionEvent extends Event {
  resultIndex: number;
  results: SpeechRecognitionResultList;
}

interface SpeechRecognitionResultList {
  length: number;
  item(index: number): SpeechRecognitionResult;
  [index: number]: SpeechRecognitionResult;
}

interface SpeechRecognitionResult {
  isFinal: boolean;
  length: number;
  item(index: number): SpeechRecognitionAlternative;
  [index: number]: SpeechRecognitionAlternative;
}

interface SpeechRecognitionAlternative {
  confidence: number;
  transcript: string;
}

declare var SpeechRecognition: {
  prototype: SpeechRecognition;
  new (): SpeechRecognition;
};

declare var webkitSpeechRecognition: {
  prototype: SpeechRecognition;
  new (): SpeechRecognition;
};

interface Window {
  SpeechRecognition: typeof SpeechRecognition;
  webkitSpeechRecognition: typeof webkitSpeechRecognition;
}
</file>

<file path="src/utils/ai.ts">
import { generateText as generateWithGemini } from './gemini';
import { generateTextWithGPT } from './openai';

export type AIProvider = 'gemini' | 'openai';

interface GenerateTextOptions {
  temperature?: number;
  maxTokens?: number;
  provider?: AIProvider;
  model?: string;
}

/**
 * í†µí•© AI í…ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜
 * ì—¬ëŸ¬ AI ì œê³µìë¥¼ ì„ íƒí•´ì„œ ì‚¬ìš© ê°€ëŠ¥
 */
export const generateTextWithAI = async (
  systemPrompt: string,
  userPrompt: string,
  options?: GenerateTextOptions
): Promise<string> => {
  const provider = options?.provider || getDefaultProvider();

  try {
    if (provider === 'openai') {
      return await generateTextWithGPT(systemPrompt, userPrompt, {
        temperature: options?.temperature,
        maxTokens: options?.maxTokens,
        model: options?.model as any,
      });
    } else {
      // Gemini (default)
      return await generateWithGemini(systemPrompt, userPrompt, {
        temperature: options?.temperature,
        maxOutputTokens: options?.maxTokens,
      });
    }
  } catch (error) {
    console.error(`[AI] ${provider} ì‹¤íŒ¨:`, error);
    // Fallback: ë‹¤ë¥¸ ì œê³µì ì‹œë„
    const fallbackProvider: AIProvider = provider === 'openai' ? 'gemini' : 'openai';
    console.log(`[AI] Fallback to ${fallbackProvider}`);

    if (fallbackProvider === 'openai') {
      return await generateTextWithGPT(systemPrompt, userPrompt, {
        temperature: options?.temperature,
        maxTokens: options?.maxTokens,
      });
    } else {
      return await generateWithGemini(systemPrompt, userPrompt, {
        temperature: options?.temperature,
        maxOutputTokens: options?.maxTokens,
      });
    }
  }
};

/**
 * ì‚¬ìš© ê°€ëŠ¥í•œ AI ì œê³µì í™•ì¸
 */
export const getAvailableProviders = (): AIProvider[] => {
  const providers: AIProvider[] = [];

  if (import.meta.env.VITE_GEMINI_API_KEY) {
    providers.push('gemini');
  }

  if (import.meta.env.VITE_OPENAI_API_KEY) {
    providers.push('openai');
  }

  return providers;
};

/**
 * ê¸°ë³¸ AI ì œê³µì ê²°ì •
 */
export const getDefaultProvider = (): AIProvider => {
  // OpenAI í‚¤ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
  if (import.meta.env.VITE_OPENAI_API_KEY) {
    return 'openai';
  }

  return 'gemini';
};

/**
 * ë°”ì´ë¸Œì½”ë”©: ì—¬ëŸ¬ AIë¡œë¶€í„° ê²°ê³¼ë¥¼ ë°›ì•„ ì¢…í•©
 * (ì„ íƒì  ê³ ê¸‰ ê¸°ëŠ¥)
 */
export const generateWithMultipleAI = async (
  systemPrompt: string,
  userPrompt: string,
  options?: Omit<GenerateTextOptions, 'provider'>
): Promise<{
  gemini?: string;
  openai?: string;
  combined?: string;
}> => {
  const results: {
    gemini?: string;
    openai?: string;
    combined?: string;
  } = {};

  const availableProviders = getAvailableProviders();

  // ë³‘ë ¬ë¡œ ëª¨ë“  ì œê³µìì—ê²Œ ìš”ì²­
  const promises = availableProviders.map(async (provider) => {
    try {
      const result = await generateTextWithAI(systemPrompt, userPrompt, {
        ...options,
        provider,
      });
      return { provider, result };
    } catch (error) {
      console.error(`[Multi-AI] ${provider} ì‹¤íŒ¨:`, error);
      return { provider, result: null };
    }
  });

  const responses = await Promise.all(promises);

  responses.forEach(({ provider, result }) => {
    if (result) {
      if (provider === 'gemini') results.gemini = result;
      if (provider === 'openai') results.openai = result;
    }
  });

  // ê²°ê³¼ ì¢…í•© (ì˜µì…˜)
  if (results.gemini && results.openai) {
    results.combined = `=== Gemini ì¶”ì²œ ===\n${results.gemini}\n\n=== OpenAI ì¶”ì²œ ===\n${results.openai}`;
  } else {
    results.combined = results.gemini || results.openai;
  }

  return results;
};
</file>

<file path="src/utils/calculateMetrics.ts">
import type { Workout } from '../types';

/**
 * Typeë³„ ì „ìš© ì§€í‘œ ê³„ì‚° ìœ í‹¸ë¦¬í‹°
 *
 * ì² í•™: "ì‚¬ê³¼ëŠ” ì‚¬ê³¼ë¼ë¦¬, ì˜¤ë Œì§€ëŠ” ì˜¤ë Œì§€ë¼ë¦¬"
 * - ì¹´ë””ì˜¤ëŠ” ì¹´ë””ì˜¤ë¼ë¦¬ ë¹„êµ (adjusted_dist_km)
 * - ê·¼ë ¥ì€ ê·¼ë ¥ë¼ë¦¬ ë¹„êµ (volume_kg)
 * - ìŠ¤í‚¬ì€ ìŠ¤í‚¬ë¼ë¦¬ ë¹„êµ (run_count)
 */

/**
 * ëª¨ë“  Typeë³„ ì§€í‘œë¥¼ í•œë²ˆì— ê³„ì‚°
 */
export const calculateAllMetrics = (workout: Workout): {
  adjusted_dist_km: number | null;
  volume_kg: number | null;
  run_count: number | null;
} => {
  return {
    adjusted_dist_km: calculateAdjustedDistance(workout),
    volume_kg: calculateVolume(workout),
    run_count: calculateRunCount(workout),
  };
};

/**
 * ğŸƒ ì¹´ë””ì˜¤: í‰ì§€ í™˜ì‚° ê±°ë¦¬ (Flat Equivalent Distance)
 *
 * ê³µì‹: Distance + (Distance Ã— Incline% Ã— 0.1)
 *
 * ë…¼ë¦¬:
 * - ê²½ì‚¬ë„ 1%ë‹¹ ì•½ 10%ì˜ ë¶€í•˜ê°€ ë” ê±¸ë¦°ë‹¤ê³  ê°€ì •
 * - GAP (Grade Adjusted Pace) ëª¨ë¸ì˜ ê°„ì†Œí™” ë²„ì „
 *
 * ì˜ˆì‹œ:
 * - í‰ì§€ 5km â†’ 5.0 km
 * - ì¸í´ë¼ì¸ 10% 5km â†’ 5 + (5 * 10 * 0.1) = 10.0 km
 * - ì¸í´ë¼ì¸ 15% 2.5km â†’ 2.5 + (2.5 * 15 * 0.1) = 6.25 km
 *
 * ê±°ë¦¬ê°€ ì—†ê³  ì‹œê°„ë§Œ ìˆì„ ê²½ìš°:
 * - duration_min * 0.167 (ì‹œê°„ë‹¹ 10km ê¸°ì¤€)
 */
export const calculateAdjustedDistance = (workout: Workout): number | null => {
  if (workout.type !== 'cardio') return null;

  const { distance_km, duration_min, incline_percent, resistance_level } = workout;

  // ê±°ë¦¬ ê¸°ë°˜ ê³„ì‚°
  if (distance_km) {
    let adjusted = distance_km;

    // ì¸í´ë¼ì¸ ë³´ì •
    if (incline_percent) {
      adjusted += distance_km * incline_percent * 0.1;
    }

    // ì €í•­ ë ˆë²¨ ë³´ì • (ì‚¬ì´í´, ë¡œì‰)
    // ë ˆë²¨ë‹¹ 5% ì¶”ê°€ ë¶€í•˜ ì¸ì •
    if (resistance_level) {
      adjusted *= 1 + resistance_level * 0.05;
    }

    return Number(adjusted.toFixed(2));
  }

  // ì‹œê°„ ê¸°ë°˜ ëŒ€ëµì  í™˜ì‚° (ê±°ë¦¬ê°€ ì—†ì„ ë•Œ)
  if (duration_min) {
    // 1ì‹œê°„ = 10km ê¸°ì¤€ (6ë¶„/km í˜ì´ìŠ¤)
    let adjusted = (duration_min / 60) * 10;

    // ì €í•­ ë ˆë²¨ ë³´ì •
    if (resistance_level) {
      adjusted *= 1 + resistance_level * 0.05;
    }

    return Number(adjusted.toFixed(2));
  }

  return null;
};

/**
 * ğŸ‹ï¸ ê·¼ë ¥: ì´ ë³¼ë¥¨ (Total Volume)
 *
 * ê³µì‹: Weight(kg) Ã— Reps Ã— Sets
 *
 * ê°€ì¥ ì •ì§í•œ ì§€í‘œ. ë“¤ì–´ ì˜¬ë¦° ì´ ë¬´ê²Œ.
 *
 * ì˜ˆì‹œ:
 * - ë²¤ì¹˜í”„ë ˆìŠ¤ 80kg Ã— 10íšŒ Ã— 3ì„¸íŠ¸ = 2,400 kg
 * - ìŠ¤ì¿¼íŠ¸ 100kg Ã— 5íšŒ Ã— 5ì„¸íŠ¸ = 2,500 kg
 */
export const calculateVolume = (workout: Workout): number | null => {
  if (workout.type !== 'strength') return null;

  const { weight_kg, sets, reps } = workout;

  if (!weight_kg || !sets || !reps) return null;

  const volume = weight_kg * sets * reps;
  return Number(volume.toFixed(1));
};

/**
 * ğŸ‚ ìŠ¤í‚¬/ìŠ¤ë…¸ë³´ë“œ: ëŸ° ìˆ˜ / ì‹œë„ íšŸìˆ˜
 *
 * reps ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
 *
 * ì˜ˆì‹œ:
 * - ìŠ¤ë…¸ë³´ë“œ 25 Runs â†’ 25
 * - ê³¨í”„ ìŠ¤ìœ™ ì—°ìŠµ 100íšŒ â†’ 100
 * - íŠ¸ë¦­ 10íšŒ ì„±ê³µ â†’ 10
 */
export const calculateRunCount = (workout: Workout): number | null => {
  if (workout.type !== 'skill' && workout.category !== 'snowboard') return null;

  return workout.reps || null;
};

/**
 * Workout ë°°ì—´ì˜ Typeë³„ ì´í•© ê³„ì‚°
 */
export const calculateTotalMetrics = (workouts: Workout[]): {
  totalAdjustedDistance: number;
  totalVolume: number;
  totalRunCount: number;
} => {
  let totalAdjustedDistance = 0;
  let totalVolume = 0;
  let totalRunCount = 0;

  workouts.forEach((workout) => {
    const adjustedDist = calculateAdjustedDistance(workout);
    const volume = calculateVolume(workout);
    const runCount = calculateRunCount(workout);

    if (adjustedDist) totalAdjustedDistance += adjustedDist;
    if (volume) totalVolume += volume;
    if (runCount) totalRunCount += runCount;
  });

  return {
    totalAdjustedDistance: Number(totalAdjustedDistance.toFixed(2)),
    totalVolume: Number(totalVolume.toFixed(1)),
    totalRunCount,
  };
};

/**
 * ë¦¬ë”ë³´ë“œìš© í¬ë§·íŒ…
 */
export const formatMetric = (value: number, type: 'distance' | 'volume' | 'count'): string => {
  switch (type) {
    case 'distance':
      return `${value.toFixed(1)} km`;
    case 'volume':
      // 1000 ì´ìƒì€ í†¤(t) ë‹¨ìœ„ë¡œ
      if (value >= 1000) {
        return `${(value / 1000).toFixed(1)} t`;
      }
      return `${value.toFixed(0)} kg`;
    case 'count':
      return `${value} íšŒ`;
    default:
      return String(value);
  }
};

/**
 * Typeë³„ ìš´ë™ë§Œ í•„í„°ë§
 */
export const filterWorkoutsByType = (
  workouts: Workout[],
  type: 'strength' | 'cardio' | 'skill' | 'flexibility'
): Workout[] => {
  return workouts.filter((w) => w.type === type);
};

/**
 * Categoryë³„ ìš´ë™ë§Œ í•„í„°ë§
 */
export const filterWorkoutsByCategory = (
  workouts: Workout[],
  category: string
): Workout[] => {
  return workouts.filter((w) => w.category === category);
};
</file>

<file path="src/utils/gemini.ts">
import { GoogleGenerativeAI } from '@google/generative-ai';

let genAI: GoogleGenerativeAI | null = null;

export const getGeminiClient = () => {
  const apiKey = import.meta.env.VITE_GEMINI_API_KEY;

  if (!apiKey) {
    throw new Error('Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  if (!genAI) {
    genAI = new GoogleGenerativeAI(apiKey);
  }

  return genAI;
};

export const generateText = async (
  systemPrompt: string,
  userPrompt: string,
  options?: {
    temperature?: number;
    maxOutputTokens?: number;
  }
): Promise<string> => {
  const client = getGeminiClient();
  const model = client.getGenerativeModel({
    model: 'gemini-2.5-flash',
    systemInstruction: systemPrompt,
  });

  const result = await model.generateContent({
    contents: [{ role: 'user', parts: [{ text: userPrompt }] }],
    generationConfig: {
      temperature: options?.temperature ?? 0.7,
      maxOutputTokens: options?.maxOutputTokens ?? 2048,
    },
  });

  const response = result.response;
  return response.text();
};

export const transcribeAudio = async (audioBlob: Blob): Promise<string> => {
  const client = getGeminiClient();
  const model = client.getGenerativeModel({
    model: 'gemini-2.5-flash',
  });

  // Convert blob to base64
  const base64Audio = await new Promise<string>((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      const base64 = reader.result as string;
      // Remove data:audio/webm;base64, prefix
      resolve(base64.split(',')[1]);
    };
    reader.readAsDataURL(audioBlob);
  });

  const result = await model.generateContent({
    contents: [
      {
        role: 'user',
        parts: [
          {
            text: 'ì´ ìŒì„±ì„ í•œêµ­ì–´ë¡œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”. ìš´ë™ ê´€ë ¨ ë‚´ìš©ì…ë‹ˆë‹¤. ë³€í™˜ëœ í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ ìƒëµí•˜ì„¸ìš”.',
          },
          {
            inlineData: {
              mimeType: 'audio/webm',
              data: base64Audio,
            },
          },
        ],
      },
    ],
  });

  return result.response.text();
};
</file>

<file path="src/utils/openai.ts">
import OpenAI from 'openai';

let openaiClient: OpenAI | null = null;

export const getOpenAIClient = () => {
  const apiKey = import.meta.env.VITE_OPENAI_API_KEY;

  if (!apiKey) {
    throw new Error('OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
  }

  if (!openaiClient) {
    openaiClient = new OpenAI({
      apiKey,
      dangerouslyAllowBrowser: true, // ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì‚¬ìš© (í”„ë¡œë•ì…˜ì—ì„œëŠ” ë°±ì—”ë“œ ê¶Œì¥)
    });
  }

  return openaiClient;
};

export const generateTextWithGPT = async (
  systemPrompt: string,
  userPrompt: string,
  options?: {
    temperature?: number;
    maxTokens?: number;
    model?: 'gpt-4o' | 'gpt-4o-mini' | 'gpt-4-turbo';
  }
): Promise<string> => {
  const client = getOpenAIClient();

  const completion = await client.chat.completions.create({
    model: options?.model || 'gpt-4o-mini',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt },
    ],
    temperature: options?.temperature ?? 0.7,
    max_tokens: options?.maxTokens ?? 2048,
  });

  return completion.choices[0]?.message?.content || '';
};
</file>

<file path="supabase_kakao_login_migration.sql">
-- Add Kakao login support columns to users table
-- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì§€ì›ì„ ìœ„í•œ users í…Œì´ë¸” ì»¬ëŸ¼ ì¶”ê°€

-- Add new columns
ALTER TABLE users
ADD COLUMN IF NOT EXISTS kakao_id TEXT UNIQUE,
ADD COLUMN IF NOT EXISTS provider TEXT DEFAULT 'local',
ADD COLUMN IF NOT EXISTS profile_image TEXT,
ADD COLUMN IF NOT EXISTS phone_number TEXT,
ADD COLUMN IF NOT EXISTS birthyear TEXT,
ADD COLUMN IF NOT EXISTS gender TEXT,
ADD COLUMN IF NOT EXISTS nickname TEXT;

-- Create index for faster Kakao ID lookups
CREATE INDEX IF NOT EXISTS idx_users_kakao_id ON users(kakao_id);

-- Create index for provider lookups
CREATE INDEX IF NOT EXISTS idx_users_provider ON users(provider);

-- Add comments for documentation
COMMENT ON COLUMN users.kakao_id IS 'ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ê³ ìœ  ID';
COMMENT ON COLUMN users.provider IS 'ë¡œê·¸ì¸ ì œê³µì (local, kakao)';
COMMENT ON COLUMN users.profile_image IS 'í”„ë¡œí•„ ì´ë¯¸ì§€ URL';
COMMENT ON COLUMN users.phone_number IS 'ì „í™”ë²ˆí˜¸';
COMMENT ON COLUMN users.birthyear IS 'ì¶œìƒë…„ë„';
COMMENT ON COLUMN users.gender IS 'ì„±ë³„ (male, female)';
COMMENT ON COLUMN users.nickname IS 'ì¹´ì¹´ì˜¤ ë‹‰ë„¤ì„';
</file>

<file path="supabase_user_profiles.sql">
-- Create user_profiles table to store user workout goals and background
CREATE TABLE IF NOT EXISTS user_profiles (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  goals TEXT NOT NULL,
  raw_input TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id)
);

-- Create index for faster lookups
CREATE INDEX IF NOT EXISTS idx_user_profiles_user_id ON user_profiles(user_id);

-- Add RLS (Row Level Security) policies
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Policy: Users can view their own profile
CREATE POLICY "Users can view their own profile"
  ON user_profiles
  FOR SELECT
  USING (user_id = auth.uid());

-- Policy: Users can insert their own profile
CREATE POLICY "Users can insert their own profile"
  ON user_profiles
  FOR INSERT
  WITH CHECK (user_id = auth.uid());

-- Policy: Users can update their own profile
CREATE POLICY "Users can update their own profile"
  ON user_profiles
  FOR UPDATE
  USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());

-- Policy: Users can delete their own profile
CREATE POLICY "Users can delete their own profile"
  ON user_profiles
  FOR DELETE
  USING (user_id = auth.uid());

-- Create function to automatically update updated_at timestamp
CREATE OR REPLACE FUNCTION update_user_profiles_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger to call the function
DROP TRIGGER IF EXISTS trigger_update_user_profiles_updated_at ON user_profiles;
CREATE TRIGGER trigger_update_user_profiles_updated_at
  BEFORE UPDATE ON user_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_user_profiles_updated_at();
</file>

<file path="tmpclaude-25ef-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-2bc3-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-3174-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-3b66-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-40b2-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-67b8-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-910b-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-a1b0-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-ab04-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-af09-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-cb16-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-d783-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tmpclaude-ee76-cwd">
/d/dev/undong/voice-workout-log
</file>

<file path="tsconfig.app.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
</file>

<file path="tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})
</file>

<file path="docs/database/matrix_classification_migration.sql">
-- Matrix Classification Migration
-- 1ì°¨ì› type â†’ 2ì¶• (category + type) ë¶„ë¥˜ë¡œ ì „í™˜
--
-- í•µì‹¬ ê°œë…:
-- - Category: ì–´ë””ì„œ/ì–´ë–¤ íŒì—ì„œ (gym, snowboard, running, sports, home, other)
-- - Type: ì–´ë–¤ íš¨ê³¼ (strength, cardio, skill, flexibility, unknown)
--
-- ì‘ì„±ì¼: 2026-01-20

-- ============================================
-- 1. workouts í…Œì´ë¸”ì— category ì»¬ëŸ¼ ì¶”ê°€
-- ============================================

-- category ì»¬ëŸ¼ ì¶”ê°€ (ê¸°ë³¸ê°’: 'other')
ALTER TABLE workouts
ADD COLUMN IF NOT EXISTS category TEXT DEFAULT 'other' CHECK (
  category IN ('gym', 'snowboard', 'running', 'sports', 'home', 'other')
);

-- ì¸ë±ìŠ¤ ì¶”ê°€ (ì¹´í…Œê³ ë¦¬ë³„ ì¡°íšŒ ì„±ëŠ¥ í–¥ìƒ)
CREATE INDEX IF NOT EXISTS idx_workouts_category ON workouts(category);

-- ì½”ë©˜íŠ¸
COMMENT ON COLUMN workouts.category IS 'ìš´ë™ ì¹´í…Œê³ ë¦¬ (gym: í—¬ìŠ¤ì¥, snowboard: ìŠ¤ë…¸ë³´ë“œ, running: ëŸ¬ë‹, sports: êµ¬ê¸°/ë¼ì¼“, home: í™ˆíŠ¸, other: ê¸°íƒ€)';

-- ============================================
-- 2. ê¸°ì¡´ CHECK ì œì•½ì¡°ê±´ ì‚­ì œ
-- ============================================

-- ê¸°ì¡´ type ì»¬ëŸ¼ì˜ CHECK ì œì•½ì¡°ê±´ ì‚­ì œ
DO $$
DECLARE
  constraint_name text;
BEGIN
  -- type ì»¬ëŸ¼ì˜ CHECK ì œì•½ì¡°ê±´ ì°¾ê¸°
  SELECT conname INTO constraint_name
  FROM pg_constraint
  WHERE conrelid = 'workouts'::regclass
    AND contype = 'c'
    AND pg_get_constraintdef(oid) LIKE '%type%';

  -- ì œì•½ì¡°ê±´ì´ ì¡´ì¬í•˜ë©´ ì‚­ì œ
  IF constraint_name IS NOT NULL THEN
    EXECUTE 'ALTER TABLE workouts DROP CONSTRAINT ' || constraint_name;
    RAISE NOTICE 'Dropped constraint: %', constraint_name;
  END IF;
END $$;

-- ============================================
-- 3. ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (ì œì•½ì¡°ê±´ ì¶”ê°€ ì „ì— ë¨¼ì €!)
-- ============================================

-- ê¸°ì¡´ type ê°’ì„ categoryì™€ typeìœ¼ë¡œ ë¶„ë¦¬
-- ì „ëµ: ê¸°ì¡´ 'snowboard'ëŠ” categoryë¡œ ì´ë™, typeì€ ì¶”ë¡ 

-- Step 1: 'snowboard' typeì„ ê°€ì§„ ë°ì´í„° ì²˜ë¦¬
UPDATE workouts
SET
  category = 'snowboard',
  type = CASE
    -- durationì´ ìˆìœ¼ë©´ cardio (ê´€ê´‘ë³´ë”©, ì§€êµ¬ë ¥)
    WHEN duration_min IS NOT NULL AND duration_min > 0 THEN 'cardio'
    -- íŠ¹ì • í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ skill (íŠ¸ë¦­, ê¸°ë¬¼)
    WHEN name ~* '(íŠ¸ë¦­|ê¸°ë¬¼|ì§€ë¹™|ë°•ìŠ¤|ë ˆì¼|ì í”„|í‚¥ì»¤)' THEN 'skill'
    -- ê¸°ë³¸ê°’: cardio (ëŒ€ë¶€ë¶„ ë³´ë”©ì€ ì‹¬í ìš´ë™)
    ELSE 'cardio'
  END
WHERE type = 'snowboard';

-- Step 2: 'core' typeì„ 'strength'ë¡œ ë³€ê²½ (ì½”ì–´ëŠ” ê·¼ë ¥ ìš´ë™)
UPDATE workouts
SET type = 'strength'
WHERE type = 'core';

-- Step 3: 'mobility' typeì„ 'flexibility'ë¡œ ë³€ê²½
UPDATE workouts
SET type = 'flexibility'
WHERE type = 'mobility';

-- Step 4: ë‚˜ë¨¸ì§€ ìš´ë™ì€ ì´ë¦„ ê¸°ë°˜ìœ¼ë¡œ category ì¶”ë¡ 
UPDATE workouts
SET category = CASE
  -- Gym ê´€ë ¨ í‚¤ì›Œë“œ
  WHEN name ~* '(ë²¤ì¹˜|ìŠ¤ì¿¼íŠ¸|ë°ë“œ|í’€ì—…|ì¹œì—…|ë¤ë²¨|ë°”ë²¨|ëŸ°ì§€|ë ˆê·¸í”„ë ˆìŠ¤|ìˆ„ë”í”„ë ˆìŠ¤|ë«í’€|ë¡œìš°|ì»¬|ìµìŠ¤í…ì…˜|í”Œë¼ì´|ë ˆì´ì¦ˆ|í”„ë ˆìŠ¤|íŠ¸ë ˆë“œë°€|ëŸ¬ë‹ë¨¸ì‹ |ì‚¬ì´í´|ë¡œì‰)' THEN 'gym'

  -- Running ê´€ë ¨ í‚¤ì›Œë“œ
  WHEN name ~* '(ëŸ¬ë‹|ë‹¬ë¦¬ê¸°|ì¡°ê¹…|ë§ˆë¼í†¤|íŠ¸ë™|í˜ì´ìŠ¤)' THEN 'running'

  -- Sports ê´€ë ¨ í‚¤ì›Œë“œ
  WHEN name ~* '(ì¶•êµ¬|ë†êµ¬|ë°°êµ¬|í…Œë‹ˆìŠ¤|ë°°ë“œë¯¼í„´|íƒêµ¬|ê³¨í”„|ì•¼êµ¬|ìˆ˜ì˜)' THEN 'sports'

  -- Home ê´€ë ¨ í‚¤ì›Œë“œ
  WHEN name ~* '(í™ˆíŠ¸|ë§¨ëª¸|í‘¸ì‰¬ì—…|í”Œë­í¬|ë²„í”¼|ì í•‘ì­|ìŠ¤ì¿¼íŠ¸ì í”„|ìŠ¤íŠ¸ë ˆì¹­)' THEN 'home'

  -- ê¸°ë³¸ê°’: gym (í—¬ìŠ¤ì¥ ìš´ë™ì´ ê°€ì¥ ë§ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ)
  ELSE 'gym'
END
WHERE category = 'other';

-- ============================================
-- 4. type ì»¬ëŸ¼ ì œì•½ì¡°ê±´ ì¶”ê°€ (ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í›„!)
-- ============================================

-- ìƒˆë¡œìš´ type ì œì•½ì¡°ê±´ ì¶”ê°€
ALTER TABLE workouts
ADD CONSTRAINT workouts_type_check CHECK (
  type IN ('strength', 'cardio', 'skill', 'flexibility', 'unknown')
);

-- ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
COMMENT ON COLUMN workouts.type IS 'íŠ¸ë ˆì´ë‹ íƒ€ì… (strength: ê·¼ë ¥, cardio: ì‹¬í, skill: ê¸°ìˆ , flexibility: ìœ ì—°ì„±, unknown: ë¯¸ë¶„ë¥˜)';

-- ============================================
-- 5. í™•ì¸ ì¿¼ë¦¬
-- ============================================

-- ì¹´í…Œê³ ë¦¬ë³„ ìš´ë™ ìˆ˜ í™•ì¸
SELECT
  category,
  type,
  COUNT(*) as count,
  ARRAY_AGG(DISTINCT name) as sample_names
FROM workouts
GROUP BY category, type
ORDER BY category, type;

-- ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼ í™•ì¸
SELECT
  'Total workouts' as metric,
  COUNT(*) as value
FROM workouts
UNION ALL
SELECT
  'Workouts with category = other' as metric,
  COUNT(*) as value
FROM workouts
WHERE category = 'other'
UNION ALL
SELECT
  'Workouts with type = unknown' as metric,
  COUNT(*) as value
FROM workouts
WHERE type = 'unknown';
</file>

<file path="docs/README.md">
# Voice Workout Log - Documentation

ì´ í´ë”ëŠ” Voice Workout Log í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ë¬¸ì„œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

---

## ğŸ“š ë¬¸ì„œ ëª©ë¡

### 1. í”„ë¡œì íŠ¸ ì´í•´í•˜ê¸°
- **[PROJECT_OVERVIEW.md](./PROJECT_OVERVIEW.md)** â­
  - í”„ë¡œì íŠ¸ ì „ì²´ ê°œìš” ë° í•µì‹¬ ê¸°ëŠ¥ ì„¤ëª…
  - AIê°€ ì´í•´í•˜ê¸° ì¢‹ì€ í¬ë§·ìœ¼ë¡œ ì‘ì„±
  - ê¸°ìˆ  ìŠ¤íƒ, ë°ì´í„° í”Œë¡œìš°, ì£¼ìš” í™”ë©´ ì„¤ëª…
  - **ìƒˆë¡œìš´ ê°œë°œì ë˜ëŠ” AIê°€ í”„ë¡œì íŠ¸ë¥¼ ì´í•´í•˜ë ¤ë©´ ì´ ë¬¸ì„œë¶€í„° ì½ìœ¼ì„¸ìš”**

- **[ARCHITECTURE.md](./ARCHITECTURE.md)**
  - ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ìƒì„¸ ì„¤ëª…
  - ë ˆì´ì–´ êµ¬ì¡°, ë””ìì¸ íŒ¨í„´, ë³´ì•ˆ ì •ì±…
  - ì„±ëŠ¥ ìµœì í™” ë° í™•ì¥ì„± ê³ ë ¤ì‚¬í•­

### 2. ë°ì´í„°ë² ì´ìŠ¤
- **[database/schema.sql](./database/schema.sql)**
  - Supabase PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì „ì²´ ìŠ¤í‚¤ë§ˆ
  - í…Œì´ë¸” ì •ì˜, ì¸ë±ìŠ¤, RLS ì •ì±…
  - ìµœì‹  í”„ë¡œë•ì…˜ ìŠ¤í‚¤ë§ˆ

- **[database/migrations/](./database/migrations/)**
  - ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë ¨ íŒŒì¼
  - `MIGRATION_GUIDE.md`: ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ
  - `migrate-user-data.ts`: ì‚¬ìš©ì ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
  - `migrate_test01_to_kakao.sql`: í…ŒìŠ¤íŠ¸ DB â†’ Kakao í†µí•© ë§ˆì´ê·¸ë ˆì´ì…˜

### 3. API ë¬¸ì„œ (í–¥í›„ ì¶”ê°€ ì˜ˆì •)
- REST API ì—”ë“œí¬ì¸íŠ¸ ëª…ì„¸
- Supabase í•¨ìˆ˜ ì‚¬ìš©ë²•
- ì¸ì¦ í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

### 4. í–¥í›„ ê³„íš (í–¥í›„ ì¶”ê°€ ì˜ˆì •)
- í´ëŸ½ ì‹œìŠ¤í…œ ì„¤ê³„ ë¬¸ì„œ
- ì±Œë¦°ì§€ ê¸°ëŠ¥ ê¸°íš
- ì†Œì…œ í”¼ë“œ ì„¤ê³„

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

1. **í”„ë¡œì íŠ¸ê°€ ì²˜ìŒì´ë¼ë©´**: [PROJECT_OVERVIEW.md](./PROJECT_OVERVIEW.md)ë¥¼ ì½ìœ¼ì„¸ìš”
2. **ê¸°ìˆ ì  êµ¬ì¡°ë¥¼ ì´í•´í•˜ë ¤ë©´**: [ARCHITECTURE.md](./ARCHITECTURE.md)ë¥¼ ì½ìœ¼ì„¸ìš”
3. **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ë³´ë ¤ë©´**: [database/schema.sql](./database/schema.sql)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”
4. **ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•˜ë ¤ë©´**: [database/migrations/MIGRATION_GUIDE.md](./database/migrations/MIGRATION_GUIDE.md)ë¥¼ ë”°ë¥´ì„¸ìš”

---

## ğŸ“ ë¬¸ì„œ ì‘ì„± ì›ì¹™

### AI ì¹œí™”ì  ì‘ì„±
ì´ ë¬¸ì„œë“¤ì€ AI (Gemini, GPT)ê°€ í”„ë¡œì íŠ¸ë¥¼ ì´í•´í•˜ê³  í˜‘ì—…í•˜ê¸° ì‰½ë„ë¡ ë‹¤ìŒ ì›ì¹™ì„ ë”°ë¦…ë‹ˆë‹¤:

1. **êµ¬ì¡°í™”ëœ ì •ë³´**: ê³„ì¸µì  êµ¬ì¡°ë¡œ ì •ë³´ ì¡°ì§
2. **ëª…í™•í•œ ì»¨í…ìŠ¤íŠ¸**: ê° ì„¹ì…˜ì´ ë…ë¦½ì ìœ¼ë¡œ ì´í•´ ê°€ëŠ¥
3. **ì½”ë“œ ì˜ˆì œ í¬í•¨**: ì¶”ìƒì  ì„¤ëª…ë³´ë‹¤ êµ¬ì²´ì  ì˜ˆì œ ì œê³µ
4. **ìµœì‹  ìƒíƒœ ìœ ì§€**: ì½”ë“œ ë³€ê²½ ì‹œ ë¬¸ì„œë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
5. **íƒ€ì…ê³¼ ì¸í„°í˜ì´ìŠ¤ ëª…ì‹œ**: TypeScript íƒ€ì… ì •ë³´ í¬í•¨

### ì¸ê°„ ì¹œí™”ì  ì‘ì„±
- ì „ë¬¸ ìš©ì–´ ì‚¬ìš© ì‹œ ê°„ë‹¨í•œ ì„¤ëª… ì¶”ê°€
- ë‹¤ì´ì–´ê·¸ë¨ ë° í”Œë¡œìš°ì°¨íŠ¸ í™œìš© (ê°€ëŠ¥í•œ ê²½ìš°)
- ì‹¤ì œ ì‚¬ìš© ì‚¬ë¡€ ë° ì‹œë‚˜ë¦¬ì˜¤ í¬í•¨

---

## ğŸ”„ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ê°€ì´ë“œ

### ì–¸ì œ ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•˜ë‚˜ìš”?
- ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì¶”ê°€í•  ë•Œ
- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ë³€ê²½í•  ë•Œ
- API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì¶”ê°€/ìˆ˜ì •í•  ë•Œ
- ì•„í‚¤í…ì²˜ ê²°ì •ì„ ë‚´ë¦´ ë•Œ
- ì¤‘ìš”í•œ ë²„ê·¸ ìˆ˜ì • í›„ (ë§Œì•½ ë¬¸ì„œì— ì˜í–¥ì„ ì¤€ë‹¤ë©´)

### ë¬¸ì„œ ì‘ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ë³€ê²½ ì‚¬í•­ì„ PROJECT_OVERVIEW.mdì— ë°˜ì˜í–ˆë‚˜ìš”?
- [ ] ìƒˆë¡œìš´ í…Œì´ë¸”/ì»¬ëŸ¼ì„ schema.sqlì— ì¶”ê°€í–ˆë‚˜ìš”?
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í–ˆë‚˜ìš”?
- [ ] ì½”ë“œ ì˜ˆì œê°€ ìµœì‹  ë²„ì „ì¸ê°€ìš”?
- [ ] íƒ€ì… ì •ì˜ê°€ ì •í™•í•œê°€ìš”?

---

## ğŸ“‚ í´ë” êµ¬ì¡°

```
docs/
â”œâ”€â”€ README.md                    # ì´ íŒŒì¼ (ë¬¸ì„œ ë„¤ë¹„ê²Œì´ì…˜)
â”œâ”€â”€ PROJECT_OVERVIEW.md          # í”„ë¡œì íŠ¸ ì „ì²´ ê°œìš” â­
â”œâ”€â”€ ARCHITECTURE.md              # ì•„í‚¤í…ì²˜ ìƒì„¸ ì„¤ëª…
â”‚
â””â”€â”€ database/                    # ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ë¬¸ì„œ
    â”œâ”€â”€ schema.sql               # í˜„ì¬ DB ìŠ¤í‚¤ë§ˆ
    â””â”€â”€ migrations/              # ë§ˆì´ê·¸ë ˆì´ì…˜ íˆìŠ¤í† ë¦¬
        â”œâ”€â”€ MIGRATION_GUIDE.md   # ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ
        â”œâ”€â”€ migrate-user-data.ts # ì‚¬ìš©ì ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
        â””â”€â”€ migrate_test01_to_kakao.sql
```

---

## ğŸ’¡ ì°¸ê³ 

### ì™¸ë¶€ ë¬¸ì„œ
- [Supabase Docs](https://supabase.com/docs)
- [React Router v7](https://reactrouter.com/)
- [Kakao Developers](https://developers.kakao.com/)
- [Google Generative AI](https://ai.google.dev/)
- [OpenAI API](https://platform.openai.com/docs)

### í”„ë¡œì íŠ¸ ë£¨íŠ¸ íŒŒì¼
- `package.json`: ì˜ì¡´ì„± ë° ìŠ¤í¬ë¦½íŠ¸
- `.env`: í™˜ê²½ ë³€ìˆ˜ (ë¯¼ê° ì •ë³´, Gitì— ì»¤ë°‹ë˜ì§€ ì•ŠìŒ)
- `tsconfig.json`: TypeScript ì„¤ì •
- `vite.config.ts`: Vite ë¹Œë“œ ì„¤ì •

---

## ğŸ¤ ê¸°ì—¬

ë¬¸ì„œ ê°œì„  ì œì•ˆì´ë‚˜ ì˜¤ë¥˜ë¥¼ ë°œê²¬í•˜ë©´:
1. ì´ìŠˆë¥¼ ìƒì„±í•˜ê±°ë‚˜
2. PRì„ ì œì¶œí•˜ê±°ë‚˜
3. í”„ë¡œì íŠ¸ ê´€ë¦¬ìì—ê²Œ ì§ì ‘ ì•Œë ¤ì£¼ì„¸ìš”a

**ì¢‹ì€ ë¬¸ì„œëŠ” ì¢‹ì€ ì½”ë“œë§Œí¼ ì¤‘ìš”í•©ë‹ˆë‹¤!**
</file>

<file path="index.html">
<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Workout Log</title>

    <!-- Kakao SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"
      integrity="sha384-l+xbElFSnPZ2rOaPrU//2FF5B4LB8FiX5q4fXYTlfcG4PGpMkE1vcL7kNXI6Cci0"
      crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="netlify/functions/parse-workout.ts">
import type { Handler, HandlerEvent } from "@netlify/functions";
import OpenAI from "openai";
import { zodResponseFormat } from "openai/helpers/zod";
import { z } from "zod";

// ==========================================
// Inline Schemas (to avoid import issues)
// ==========================================

const InternalCategoryEnum = z.enum(["cardio", "strength", "snowboard"]);

const ShreddedSegmentSchema = z.object({
  original_text: z.string().describe("ìš´ë™ë³„ë¡œ ë¶„ë¦¬ëœ ë¬¸ì¥"),
  category: InternalCategoryEnum.describe("ë‹´ë‹¹ ë¶€ì„œ"),
  item_name_hint: z.string().describe("ìš´ë™ ì´ë¦„ íŒíŠ¸"),
});

const ShredderResponseSchema = z.object({
  segments: z.array(ShreddedSegmentSchema),
});

const CardioNames = z.enum([
  "running", "stepmill", "rowing", "cycle", "swimming",
  "hiking", "jump_rope", "elliptical", "other"
]);

const CardioResultSchema = z.object({
  reasoning: z.string(),
  name: CardioNames,
  distance_km: z.union([z.number(), z.null()]),
  duration_min: z.union([z.number(), z.null()]),
  speed_kph: z.union([z.number(), z.null()]),
  pace: z.string().nullable(),
  floors: z.union([z.number(), z.null()]),
});

const StrengthResultSchema = z.object({
  reasoning: z.string(),
  name: z.string(),
  weight_kg: z.union([z.number(), z.null()]),
  sets: z.union([z.number(), z.null()]),
  reps: z.union([z.number(), z.null()]),
});

const SnowboardResultSchema = z.object({
  name: z.string(),
  duration_min: z.union([z.number(), z.null()]),
  run_count: z.union([z.number(), z.null()]),
  note: z.string().nullable(),
});

type ShreddedSegment = z.infer<typeof ShreddedSegmentSchema>;
type InternalCategory = z.infer<typeof InternalCategoryEnum>;

// ==========================================
// OpenAI Client
// ==========================================

// NOTE: Use OPENAI_API_KEY (backend env var), NOT VITE_OPENAI_API_KEY (frontend)
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY!,
});

const MODEL = "gpt-4o-mini";

// ==========================================
// Shredder
// ==========================================

async function shredInput(input: string): Promise<ShreddedSegment[]> {
  const completion = await openai.beta.chat.completions.parse({
    model: MODEL,
    messages: [
      {
        role: "system",
        content: `
You are a Text Shredder. Split workout logs into distinct segments.

[RULES]
1. Split by Activity: "Run 30m and Bench 60kg" -> 2 segments
2. Keep numbers with exercise: "Squat 100kg 5 sets" is ONE segment
3. Assign Category: 'strength' for weights, 'cardio' for running/cycling, 'snowboard' for snowboard

[EXAMPLES]
In: "ëŸ°ë‹ 20ë¶„ ë›°ê³  ë²¤ì¹˜ 60 5ì„¸íŠ¸"
Out: [
  { original_text: "ëŸ°ë‹ 20ë¶„", category: "cardio", item_name_hint: "running" },
  { original_text: "ë²¤ì¹˜ 60 5ì„¸íŠ¸", category: "strength", item_name_hint: "bench_press" }
]
`
      },
      { role: "user", content: input },
    ],
    response_format: zodResponseFormat(ShredderResponseSchema, "shredder_output"),
  });

  return completion.choices[0].message.parsed?.segments || [];
}

// ==========================================
// Specialists
// ==========================================

async function parseCardio(text: string, hint: string) {
  const completion = await openai.beta.chat.completions.parse({
    model: MODEL,
    messages: [
      {
        role: "system",
        content: `
You are a Cardio Specialist.

[RULES]
1. "~ë¡œ" -> Speed (e.g. "6kmë¡œ" -> speed_kph: 6)
2. "~ë¥¼" -> Distance (e.g. "6kmë¥¼" -> distance_km: 6)
3. Stepmill: Use 'floors' field, NOT distance
4. Use NULL for missing data, NEVER 0
`
      },
      { role: "user", content: `Hint: ${hint}\nInput: ${text}` },
    ],
    response_format: zodResponseFormat(CardioResultSchema, "cardio_result"),
  });
  return completion.choices[0].message.parsed || null;
}

async function parseStrength(text: string, hint: string) {
  const completion = await openai.beta.chat.completions.parse({
    model: MODEL,
    messages: [
      {
        role: "system",
        content: `
You are a Strength Specialist.

[RULES]
1. "kg/í‚¤ë¡œ" -> weight_kg
2. "ì„¸íŠ¸" -> sets
3. "íšŒ/ê°œ" -> reps
4. Bodyweight exercises: weight_kg = NULL
`
      },
      { role: "user", content: `Hint: ${hint}\nInput: ${text}` },
    ],
    response_format: zodResponseFormat(StrengthResultSchema, "strength_result"),
  });
  return completion.choices[0].message.parsed || null;
}

async function parseSnowboard(text: string) {
  const durationMatch = text.match(/(\d+)\s*(ì‹œê°„|ë¶„)/);
  const runCountMatch = text.match(/(\d+)\s*(íšŒ|ë²ˆ|ëŸ°)/);

  return {
    name: "ìŠ¤ë…¸ë³´ë“œ",
    duration_min: durationMatch ? (durationMatch[2] === 'ì‹œê°„' ? parseInt(durationMatch[1]) * 60 : parseInt(durationMatch[1])) : null,
    run_count: runCountMatch ? parseInt(runCountMatch[1]) : null,
    note: text.includes('ë¹¡ì„¸ê²Œ') ? 'ë¹¡ì„¸ê²Œ' : text.includes('ê°€ë³ê²Œ') ? 'ê°€ë³ê²Œ' : null,
  };
}

// ==========================================
// Mapper
// ==========================================

function mapToWorkout(seg: ShreddedSegment, parsed: any) {
  const category = seg.category === 'cardio' ? 'gym' :
                   seg.category === 'strength' ? 'gym' :
                   seg.category === 'snowboard' ? 'snowboard' : 'other';

  const type = seg.category === 'cardio' ? 'cardio' :
               seg.category === 'strength' ? 'strength' :
               seg.category === 'snowboard' ? 'cardio' : 'unknown';

  const target = type === 'strength' ? determineTarget(parsed.name || '') : undefined;

  return {
    name: parsed.name || seg.item_name_hint,
    category,
    type,
    target,
    distance_km: parsed.distance_km ?? null,
    duration_min: parsed.duration_min ?? null,
    speed_kph: parsed.speed_kph ?? null,
    pace: parsed.pace ?? null,
    sets: parsed.sets ?? null,
    reps: parsed.reps ?? null,
    weight_kg: parsed.weight_kg ?? null,
    run_count: parsed.run_count ?? null,
    incline_percent: null,
    resistance_level: null,
    note: parsed.note ?? null,
  };
}

function determineTarget(name: string) {
  const lowerName = name.toLowerCase();
  if (['plank', 'crunch', 'core'].some(kw => lowerName.includes(kw))) return 'core';
  if (['bench', 'press', 'pull', 'row', 'lat', 'shoulder', 'chest'].some(kw => lowerName.includes(kw))) return 'upper';
  if (['squat', 'deadlift', 'leg', 'lunge', 'calf'].some(kw => lowerName.includes(kw))) return 'lower';
  if (['burpee', 'clean', 'snatch', 'kettlebell'].some(kw => lowerName.includes(kw))) return 'full';
  return 'none';
}

// ==========================================
// Main Handler
// ==========================================

export const handler: Handler = async (event: HandlerEvent) => {
  // 1. Check Method
  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      body: JSON.stringify({ error: "Method Not Allowed" }),
    };
  }

  // 2. Check API Key (Fail fast)
  if (!process.env.OPENAI_API_KEY) {
    console.error("ğŸ”¥ FATAL: OPENAI_API_KEY is missing in Netlify environment variables.");
    return {
      statusCode: 500,
      body: JSON.stringify({
        error: "Server Configuration Error",
        details: "Missing OPENAI_API_KEY in environment variables"
      }),
    };
  }

  try {
    // 3. Parse Request Body
    const { text } = JSON.parse(event.body || "{}");

    if (!text || typeof text !== "string") {
      return {
        statusCode: 400,
        body: JSON.stringify({ error: "Missing or invalid 'text' field" }),
      };
    }

    console.log("[parse-workout] Processing text:", text.substring(0, 50) + "...");

    // 4. Shred Input
    const segments = await shredInput(text);
    console.log("[parse-workout] Shredded into", segments.length, "segments");

    // 5. Parse Each Segment
    const results = await Promise.all(segments.map(async (seg) => {
      let parsed: any = null;

      switch (seg.category) {
        case 'cardio':
          parsed = await parseCardio(seg.original_text, seg.item_name_hint);
          break;
        case 'strength':
          parsed = await parseStrength(seg.original_text, seg.item_name_hint);
          break;
        case 'snowboard':
          parsed = await parseSnowboard(seg.original_text);
          break;
      }

      return parsed ? mapToWorkout(seg, parsed) : null;
    }));

    const workouts = results.filter(w => w !== null);
    console.log("[parse-workout] Successfully parsed", workouts.length, "workouts");

    return {
      statusCode: 200,
      body: JSON.stringify({ workouts }),
    };
  } catch (error) {
    console.error("ğŸ”¥ [parse-workout] Error:", error);

    // Return detailed error for debugging
    return {
      statusCode: 500,
      body: JSON.stringify({
        error: "AI Processing Failed",
        details: error instanceof Error ? error.message : String(error),
        stack: error instanceof Error ? error.stack : undefined
      }),
    };
  }
};
</file>

<file path="src/main.tsx">
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

// Kakao SDK global type
declare global {
  interface Window {
    Kakao: any;
  }
}

// Initialize Kakao SDK
if (window.Kakao && !window.Kakao.isInitialized()) {
  const kakaoKey = import.meta.env.VITE_KAKAO_JAVASCRIPT_KEY;
  if (kakaoKey) {
    window.Kakao.init(kakaoKey);
    console.log('Kakao SDK initialized:', window.Kakao.isInitialized());
  } else {
    console.warn('VITE_KAKAO_JAVASCRIPT_KEY is not set');
  }
}

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
</file>

<file path="src/pages/PrivacyPolicy.tsx">
export const PrivacyPolicy = () => {
  return (
    <div className="container">
      <div className="policy-container">
        <h1>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h1>
        <p className="policy-date">ì‹œí–‰ì¼ì: 2026ë…„ 1ì›” 15ì¼</p>

        <section className="policy-section">
          <h2>1. ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ë° ì´ìš© ëª©ì </h2>
          <p>
            jh308(ì œì´ì—ì´ì¹˜308)(ì´í•˜ "íšŒì‚¬")ëŠ” ë‹¤ìŒì˜ ëª©ì ì„ ìœ„í•˜ì—¬ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            ì²˜ë¦¬í•˜ê³  ìˆëŠ” ê°œì¸ì •ë³´ëŠ” ë‹¤ìŒì˜ ëª©ì  ì´ì™¸ì˜ ìš©ë„ë¡œëŠ” ì´ìš©ë˜ì§€ ì•Šìœ¼ë©°,
            ì´ìš© ëª©ì ì´ ë³€ê²½ë˜ëŠ” ê²½ìš°ì—ëŠ” ê°œì¸ì •ë³´ ë³´í˜¸ë²• ì œ18ì¡°ì— ë”°ë¼ ë³„ë„ì˜ ë™ì˜ë¥¼ ë°›ëŠ” ë“±
            í•„ìš”í•œ ì¡°ì¹˜ë¥¼ ì´í–‰í•  ì˜ˆì •ì…ë‹ˆë‹¤.
          </p>
          <ul>
            <li>íšŒì› ê°€ì… ë° ê´€ë¦¬: íšŒì› ê°€ì… ì˜ì‚¬ í™•ì¸, íšŒì›ì œ ì„œë¹„ìŠ¤ ì œê³µ, ë³¸ì¸ ì‹ë³„Â·ì¸ì¦</li>
            <li>ì„œë¹„ìŠ¤ ì œê³µ: ìš´ë™ ê¸°ë¡ ê´€ë¦¬, AI ê¸°ë°˜ ìš´ë™ ë¶„ì„ ë° ì¶”ì²œ, ë§ì¶¤í˜• ì½˜í…ì¸  ì œê³µ</li>
            <li>ì„œë¹„ìŠ¤ ê°œì„ : ì‹ ê·œ ì„œë¹„ìŠ¤ ê°œë°œ ë° ë§ì¶¤ ì„œë¹„ìŠ¤ ì œê³µ, ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒ</li>
            <li>ê³ ê° ì§€ì›: ë¬¸ì˜ ì‘ëŒ€, ê³µì§€ì‚¬í•­ ì „ë‹¬, ë¶ˆë§Œ ì²˜ë¦¬ ë“± íšŒì› ê´€ë¦¬</li>
          </ul>
        </section>

        <section className="policy-section">
          <h2>2. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ í•­ëª©</h2>
          <p>íšŒì‚¬ëŠ” íšŒì›ê°€ì…, ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>

          <h3>í•„ìˆ˜ í•­ëª©</h3>
          <ul>
            <li>ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸</li>
            <li>ì´ë¦„</li>
            <li>ì´ë©”ì¼ ì£¼ì†Œ</li>
            <li>ì „í™”ë²ˆí˜¸</li>
            <li>ìƒë…„ (ë‚˜ì´ëŒ€ë³„ ìš´ë™ ì¶”ì²œì„ ìœ„í•œ ì •ë³´)</li>
          </ul>

          <h3>ì„œë¹„ìŠ¤ ì´ìš© ê³¼ì •ì—ì„œ ìˆ˜ì§‘ë˜ëŠ” ì •ë³´</h3>
          <ul>
            <li>ìš´ë™ ê¸°ë¡ (ìš´ë™ ì¢…ë¥˜, ì„¸íŠ¸, íšŸìˆ˜, ë¬´ê²Œ ë“±)</li>
            <li>AI ì¶”ì²œ ëŒ€í™” ë‚´ì—­</li>
            <li>ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´ (ìš´ë™ ëª©í‘œ, ì„ í˜¸ë„ ë“±)</li>
            <li>ì„œë¹„ìŠ¤ ì´ìš© ê¸°ë¡, ì ‘ì† ë¡œê·¸, ì¿ í‚¤, ì ‘ì† IP ì •ë³´</li>
          </ul>

          <h3>ë¯¼ê°ì •ë³´(ê±´ê°•ì •ë³´)</h3>
          <p>
            íšŒì‚¬ëŠ” ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•˜ì—¬ ì´ìš©ìì˜ ì‹ ì²´í™œë™ ë° ê±´ê°•ê³¼ ê´€ë ¨ëœ ì •ë³´ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë©°,
            ì´ëŠ” ã€Œê°œì¸ì •ë³´ ë³´í˜¸ë²•ã€ ì œ23ì¡°ì— ë”°ë¥¸ ë¯¼ê°ì •ë³´ì— í•´ë‹¹í•©ë‹ˆë‹¤.
            í•´ë‹¹ ì •ë³´ëŠ” ì´ìš©ìì˜ ëª…ì‹œì  ë™ì˜ë¥¼ ë°›ì€ ê²½ìš°ì—ë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
          </p>
          <ul>
            <li>ìš´ë™ ê¸°ë¡(ìš´ë™ ì¢…ë¥˜, ê°•ë„, ì„¸íŠ¸, ë°˜ë³µ íšŸìˆ˜, ë¬´ê²Œ ë“±)</li>
            <li>ìš´ë™ ìˆ˜í–‰ íŒ¨í„´, í”¼ë¡œë„ ë° íšŒë³µ ê´€ë ¨ ì •ë³´</li>
            <li>ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ìŒì„±ìœ¼ë¡œ ì œê³µí•œ ì‹ ì²´ ìƒíƒœ ì •ë³´</li>
          </ul>
        </section>

        <section className="policy-section">
          <h2>3. ê°œì¸ì •ë³´ì˜ ë³´ìœ  ë° ì´ìš© ê¸°ê°„</h2>
          <p>
            íšŒì‚¬ëŠ” ë²•ë ¹ì— ë”°ë¥¸ ê°œì¸ì •ë³´ ë³´ìœ Â·ì´ìš©ê¸°ê°„ ë˜ëŠ” ì •ë³´ì£¼ì²´ë¡œë¶€í„° ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘ ì‹œì—
            ë™ì˜ë°›ì€ ê°œì¸ì •ë³´ ë³´ìœ Â·ì´ìš©ê¸°ê°„ ë‚´ì—ì„œ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬Â·ë³´ìœ í•©ë‹ˆë‹¤.
          </p>

          <h3>íšŒì› ì •ë³´</h3>
          <ul>
            <li>ë³´ìœ  ê¸°ê°„: íšŒì› íƒˆí‡´ ì‹œê¹Œì§€</li>
            <li>
              íƒˆí‡´ í›„ ì²˜ë¦¬: íšŒì› íƒˆí‡´ í›„ 1ë…„ê°„ ë³´ê´€ í›„ ì¦‰ì‹œ íŒŒê¸°
              <ul>
                <li>ë³´ê´€ ì‚¬ìœ : ì„œë¹„ìŠ¤ ë¶€ì • ì´ìš© ë°©ì§€, ë¯¼ì› ì²˜ë¦¬</li>
                <li>ë³´ê´€ë˜ëŠ” ì •ë³´: ì•„ì´ë””, ì´ë¦„, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸, íƒˆí‡´ì¼</li>
              </ul>
            </li>
          </ul>

          <h3>ìš´ë™ ê¸°ë¡ ë° ì„œë¹„ìŠ¤ ì´ìš© ì •ë³´</h3>
          <ul>
            <li>ë³´ìœ  ê¸°ê°„: íšŒì› íƒˆí‡´ ì‹œê¹Œì§€</li>
            <li>íƒˆí‡´ í›„ ì²˜ë¦¬: ì¦‰ì‹œ íŒŒê¸°</li>
          </ul>

          <h3>ë²•ë ¹ì— ë”°ë¥¸ ë³´ê´€</h3>
          <ul>
            <li>ê³„ì•½ ë˜ëŠ” ì²­ì•½ì² íšŒ ë“±ì— ê´€í•œ ê¸°ë¡: 5ë…„ (ì „ììƒê±°ë˜ë²•)</li>
            <li>ëŒ€ê¸ˆê²°ì œ ë° ì¬í™” ë“±ì˜ ê³µê¸‰ì— ê´€í•œ ê¸°ë¡: 5ë…„ (ì „ììƒê±°ë˜ë²•)</li>
            <li>ì†Œë¹„ìì˜ ë¶ˆë§Œ ë˜ëŠ” ë¶„ìŸì²˜ë¦¬ì— ê´€í•œ ê¸°ë¡: 3ë…„ (ì „ììƒê±°ë˜ë²•)</li>
            <li>ì›¹ì‚¬ì´íŠ¸ ë°©ë¬¸ ê¸°ë¡: 3ê°œì›” (í†µì‹ ë¹„ë°€ë³´í˜¸ë²•)</li>
          </ul>
        </section>

        <section className="policy-section">
          <h2>4. ê°œì¸ì •ë³´ì˜ ì œ3ì ì œê³µ</h2>
          <p>
            íšŒì‚¬ëŠ” ì •ë³´ì£¼ì²´ì˜ ê°œì¸ì •ë³´ë¥¼ ì œ1ì¡°(ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ë° ì´ìš© ëª©ì )ì—ì„œ ëª…ì‹œí•œ ë²”ìœ„ ë‚´ì—ì„œë§Œ
            ì²˜ë¦¬í•˜ë©°, ì •ë³´ì£¼ì²´ì˜ ë™ì˜, ë²•ë¥ ì˜ íŠ¹ë³„í•œ ê·œì • ë“± ê°œì¸ì •ë³´ ë³´í˜¸ë²• ì œ17ì¡°ì— í•´ë‹¹í•˜ëŠ”
            ê²½ìš°ì—ë§Œ ê°œì¸ì •ë³´ë¥¼ ì œ3ìì—ê²Œ ì œê³µí•©ë‹ˆë‹¤.
          </p>
          <p>
            íšŒì‚¬ëŠ” ì›ì¹™ì ìœ¼ë¡œ ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì™¸ë¶€ì— ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            ë‹¤ë§Œ, AI ê¸°ë°˜ ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•˜ì—¬ OpenAI ë° Googleê³¼ ê°œì¸ì •ë³´ ì²˜ë¦¬ì—…ë¬´ë¥¼ ìœ„íƒí•˜ê³  ìˆìœ¼ë©°,
            ì´ëŠ” ê°œì¸ì •ë³´ ë³´í˜¸ë²•ìƒ ì œ3ì ì œê³µì´ ì•„ë‹Œ ì²˜ë¦¬ìœ„íƒì— í•´ë‹¹í•©ë‹ˆë‹¤.
          </p>
        </section>

        <section className="policy-section">
          <h2>5. ê°œì¸ì •ë³´ ì²˜ë¦¬ì˜ ìœ„íƒ</h2>
          <p>íšŒì‚¬ëŠ” ì›í™œí•œ ê°œì¸ì •ë³´ ì—…ë¬´ì²˜ë¦¬ë¥¼ ìœ„í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ê°œì¸ì •ë³´ ì²˜ë¦¬ì—…ë¬´ë¥¼ ìœ„íƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
          <ul>
            <li>
              Supabase: ë°ì´í„°ë² ì´ìŠ¤ í˜¸ìŠ¤íŒ… ë° ê´€ë¦¬
              <ul>
                <li>ìœ„íƒì—…ë¬´: íšŒì›ì •ë³´ ë° ìš´ë™ ê¸°ë¡ ì €ì¥</li>
              </ul>
            </li>
            <li>
              Google (Gemini API): AI ìš´ë™ ì¶”ì²œ ì„œë¹„ìŠ¤
              <ul>
                <li>ìœ„íƒì—…ë¬´: ìš´ë™ ë°ì´í„° ë¶„ì„ ë° ì¶”ì²œ ìƒì„±</li>
              </ul>
            </li>
            <li>
              OpenAI: AI ëŒ€í™” ì„œë¹„ìŠ¤
              <ul>
                <li>ìœ„íƒì—…ë¬´: ì‚¬ìš©ì ëŒ€í™” ì²˜ë¦¬ ë° ì‘ë‹µ ìƒì„±</li>
              </ul>
            </li>
          </ul>
          <p>
            íšŒì‚¬ëŠ” OpenAI ë° Google(Gemini API)ì´ ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼
            ìì²´ ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì˜ í•™ìŠµ, ì¬ì‚¬ìš© ë˜ëŠ” ì„œë¹„ìŠ¤ ê°œì„  ëª©ì ì˜ ë°ì´í„°ë¡œ
            í™œìš©í•˜ì§€ ì•Šë„ë¡ ê³„ì•½ ë° ì •ì±…ì— ë”°ë¼ ì œí•œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
          </p>
        </section>

        <section className="policy-section">
          <h2>5-1. ê°œì¸ì •ë³´ì˜ êµ­ì™¸ ì´ì „</h2>
          <p>
            íšŒì‚¬ëŠ” AI ê¸°ë°˜ ìš´ë™ ë¶„ì„ ë° ëŒ€í™”í˜• ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•˜ì—¬,
            ì´ìš©ìì˜ ì¼ë¶€ ê°œì¸ì •ë³´ë¥¼ êµ­ì™¸ì— ì†Œì¬í•œ ìˆ˜íƒì—…ì²´ì— ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>

          <table>
            <thead>
              <tr>
                <th>ì´ì „ë°›ëŠ” ì</th>
                <th>ì´ì „ êµ­ê°€</th>
                <th>ì´ì „ í•­ëª©</th>
                <th>ì´ì „ ëª©ì </th>
                <th>ë³´ìœ Â·ì´ìš© ê¸°ê°„</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>OpenAI, Inc.</td>
                <td>ë¯¸êµ­</td>
                <td>ìš´ë™ê¸°ë¡, ì‚¬ìš©ì ì…ë ¥ í…ìŠ¤íŠ¸, AI ë¶„ì„ìš© ë°ì´í„°</td>
                <td>ìš´ë™ ìš”ì•½ ë° AI ì½”ì¹­ ì œê³µ</td>
                <td>ì²˜ë¦¬ ëª©ì  ë‹¬ì„± ì‹œê¹Œì§€</td>
              </tr>
              <tr>
                <td>Google LLC (Gemini API)</td>
                <td>ë¯¸êµ­</td>
                <td>ìš´ë™ê¸°ë¡, ì‚¬ìš©ì ì…ë ¥ ë°ì´í„°</td>
                <td>AI ê¸°ë°˜ ìš´ë™ ë¶„ì„ ë° ì¶”ì²œ</td>
                <td>ì²˜ë¦¬ ëª©ì  ë‹¬ì„± ì‹œê¹Œì§€</td>
              </tr>
            </tbody>
          </table>

          <p>
            ì´ìš©ìëŠ” ê°œì¸ì •ë³´ì˜ êµ­ì™¸ ì´ì „ì„ ê±°ë¶€í•  ìˆ˜ ìˆìœ¼ë©°,
            ì´ ê²½ìš° AI ë¶„ì„ ë° ì¶”ì²œ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </section>

        <section className="policy-section">
          <h2>6. ì •ë³´ì£¼ì²´ì˜ ê¶Œë¦¬Â·ì˜ë¬´ ë° í–‰ì‚¬ ë°©ë²•</h2>
          <p>ì •ë³´ì£¼ì²´ëŠ” íšŒì‚¬ì— ëŒ€í•´ ì–¸ì œë“ ì§€ ë‹¤ìŒ ê° í˜¸ì˜ ê°œì¸ì •ë³´ ë³´í˜¸ ê´€ë ¨ ê¶Œë¦¬ë¥¼ í–‰ì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <ul>
            <li>ê°œì¸ì •ë³´ ì—´ëŒ ìš”êµ¬</li>
            <li>ê°œì¸ì •ë³´ ì •ì •Â·ì‚­ì œ ìš”êµ¬</li>
            <li>ê°œì¸ì •ë³´ ì²˜ë¦¬ì •ì§€ ìš”êµ¬</li>
            <li>íšŒì› íƒˆí‡´ (ê°œì¸ì •ë³´ ì‚­ì œ)</li>
          </ul>
          <p>
            ê¶Œë¦¬ í–‰ì‚¬ëŠ” ì„œë¹„ìŠ¤ ë‚´ ì„¤ì • ë©”ë‰´ë¥¼ í†µí•´ ì§ì ‘ í•˜ì‹¤ ìˆ˜ ìˆìœ¼ë©°,
            ê°œì¸ì •ë³´ ë³´í˜¸ì±…ì„ìì—ê²Œ ì„œë©´, ì „í™”, ì´ë©”ì¼ë¡œ ì—°ë½í•˜ì…”ë„ ì§€ì²´ ì—†ì´ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.
          </p>
        </section>

        <section className="policy-section">
          <h2>7. ê°œì¸ì •ë³´ì˜ íŒŒê¸°</h2>
          <p>
            íšŒì‚¬ëŠ” ê°œì¸ì •ë³´ ë³´ìœ ê¸°ê°„ì˜ ê²½ê³¼, ì²˜ë¦¬ëª©ì  ë‹¬ì„± ë“± ê°œì¸ì •ë³´ê°€ ë¶ˆí•„ìš”í•˜ê²Œ ë˜ì—ˆì„ ë•Œì—ëŠ”
            ì§€ì²´ ì—†ì´ í•´ë‹¹ ê°œì¸ì •ë³´ë¥¼ íŒŒê¸°í•©ë‹ˆë‹¤.
          </p>

          <h3>íŒŒê¸° ì ˆì°¨</h3>
          <p>
            ì´ìš©ìê°€ ì…ë ¥í•œ ì •ë³´ëŠ” ëª©ì  ë‹¬ì„± í›„ ë³„ë„ì˜ DBì— ì˜®ê²¨ì ¸(ì¢…ì´ì˜ ê²½ìš° ë³„ë„ì˜ ì„œë¥˜)
            ë‚´ë¶€ ë°©ì¹¨ ë° ê¸°íƒ€ ê´€ë ¨ ë²•ë ¹ì— ë”°ë¼ ì¼ì •ê¸°ê°„ ì €ì¥ëœ í›„ í˜¹ì€ ì¦‰ì‹œ íŒŒê¸°ë©ë‹ˆë‹¤.
          </p>

          <h3>íŒŒê¸° ë°©ë²•</h3>
          <ul>
            <li>ì „ìì  íŒŒì¼ í˜•íƒœ: ê¸°ë¡ì„ ì¬ìƒí•  ìˆ˜ ì—†ë„ë¡ ë¡œìš°ë ˆë°¸í¬ë§·(Low Level Format) ë“±ì„ ì´ìš©í•˜ì—¬ íŒŒê¸°</li>
            <li>ì¢…ì´ ë¬¸ì„œ: ë¶„ì‡„ê¸°ë¡œ ë¶„ì‡„í•˜ê±°ë‚˜ ì†Œê°</li>
          </ul>
        </section>

        <section className="policy-section">
          <h2>8. ê°œì¸ì •ë³´ ë³´í˜¸ì±…ì„ì</h2>
          <p>
            íšŒì‚¬ëŠ” ê°œì¸ì •ë³´ ì²˜ë¦¬ì— ê´€í•œ ì—…ë¬´ë¥¼ ì´ê´„í•´ì„œ ì±…ì„ì§€ê³ , ê°œì¸ì •ë³´ ì²˜ë¦¬ì™€ ê´€ë ¨í•œ
            ì •ë³´ì£¼ì²´ì˜ ë¶ˆë§Œì²˜ë¦¬ ë° í”¼í•´êµ¬ì œë¥¼ ìœ„í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ê°œì¸ì •ë³´ ë³´í˜¸ì±…ì„ìë¥¼ ì§€ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤.
          </p>
          <div className="contact-info">
            <p><strong>ê°œì¸ì •ë³´ ë³´í˜¸ì±…ì„ì</strong></p>
            <p>ì„±ëª…: ì–‘ì„í™˜</p>
            <p>ì´ë©”ì¼: shy@lunagarden.co.kr</p>
            <p>ì „í™”: 010-3114-8626</p>
          </div>
        </section>

        <section className="policy-section">
          <h2>9. ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì˜ ë³€ê²½</h2>
          <p>
            ì´ ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì€ ì‹œí–‰ì¼ë¡œë¶€í„° ì ìš©ë˜ë©°, ë²•ë ¹ ë° ë°©ì¹¨ì— ë”°ë¥¸ ë³€ê²½ë‚´ìš©ì˜ ì¶”ê°€,
            ì‚­ì œ ë° ì •ì •ì´ ìˆëŠ” ê²½ìš°ì—ëŠ” ë³€ê²½ì‚¬í•­ì˜ ì‹œí–‰ 7ì¼ ì „ë¶€í„° ê³µì§€ì‚¬í•­ì„ í†µí•˜ì—¬ ê³ ì§€í•  ê²ƒì…ë‹ˆë‹¤.
          </p>
        </section>

        <section className="policy-section">
          <h2>10. ì¿ í‚¤ì˜ ìš´ì˜ ë° ê±°ë¶€</h2>
          <p>
            íšŒì‚¬ëŠ” ì´ìš©ìì—ê²Œ ê°œë³„ì ì¸ ë§ì¶¤ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ ì´ìš©ì •ë³´ë¥¼ ì €ì¥í•˜ê³ 
            ìˆ˜ì‹œë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” 'ì¿ í‚¤(cookie)'ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          </p>
          <ul>
            <li>ì¿ í‚¤ì˜ ì‚¬ìš© ëª©ì : ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€, ì„œë¹„ìŠ¤ ì´ìš© í†µê³„</li>
            <li>
              ì¿ í‚¤ì˜ ì„¤ì¹˜Â·ìš´ì˜ ë° ê±°ë¶€: ì›¹ë¸Œë¼ìš°ì € ì˜µì…˜ ì„¤ì •ì„ í†µí•´ ì¿ í‚¤ í—ˆìš©, ì¿ í‚¤ ì°¨ë‹¨ ë“±ì˜
              ì„¤ì •ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </li>
          </ul>
        </section>
      </div>
    </div>
  );
};
</file>

<file path="src/pages/TermsOfService.tsx">
export const TermsOfService = () => {
  return (
    <div className="container">
      <div className="policy-container">
        <h1>ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</h1>
        <p className="policy-date">ì‹œí–‰ì¼ì: 2026ë…„ 1ì›” 15ì¼</p>

        <section className="policy-section">
          <h2>ì œ1ì¡° (ëª©ì )</h2>
          <p>
            ë³¸ ì•½ê´€ì€ jh308(ì œì´ì—ì´ì¹˜308)(ì´í•˜ "íšŒì‚¬")ê°€ ì œê³µí•˜ëŠ” Voice Workout Log ìš´ë™ ê¸°ë¡ ë° AI ì¶”ì²œ ì„œë¹„ìŠ¤(ì´í•˜ "ì„œë¹„ìŠ¤")ì˜
            ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ íšŒì‚¬ì™€ íšŒì› ê°„ì˜ ê¶Œë¦¬, ì˜ë¬´ ë° ì±…ì„ì‚¬í•­, ê¸°íƒ€ í•„ìš”í•œ ì‚¬í•­ì„ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.
          </p>
        </section>

        <section className="policy-section">
          <h2>ì œ2ì¡° (ì •ì˜)</h2>
          <ol>
            <li>
              "ì„œë¹„ìŠ¤"ë€ íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” ìš´ë™ ê¸°ë¡ ê´€ë¦¬, AI ê¸°ë°˜ ìš´ë™ ì¶”ì²œ, ìš´ë™ íˆìŠ¤í† ë¦¬ ë¶„ì„ ë“±ì˜
              ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
            </li>
            <li>
              "íšŒì›"ì´ë€ ë³¸ ì•½ê´€ì— ë™ì˜í•˜ê³  íšŒì‚¬ì™€ ì„œë¹„ìŠ¤ ì´ìš©ê³„ì•½ì„ ì²´ê²°í•œ ìë¥¼ ë§í•©ë‹ˆë‹¤.
            </li>
            <li>
              "ì•„ì´ë””(ID)"ë€ íšŒì›ì˜ ì‹ë³„ê³¼ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•˜ì—¬ íšŒì›ì´ ì„¤ì •í•˜ê³  íšŒì‚¬ê°€ ìŠ¹ì¸í•˜ëŠ”
              ë¬¸ì ë˜ëŠ” ìˆ«ìì˜ ì¡°í•©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
            </li>
            <li>
              "ë¹„ë°€ë²ˆí˜¸"ë€ íšŒì›ì˜ ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ íšŒì› ìì‹ ì´ ì„¤ì •í•œ ë¬¸ì, ìˆ«ì ë˜ëŠ” íŠ¹ìˆ˜ë¬¸ìì˜
              ì¡°í•©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ3ì¡° (ì•½ê´€ì˜ íš¨ë ¥ ë° ë³€ê²½)</h2>
          <ol>
            <li>
              ë³¸ ì•½ê´€ì€ ì„œë¹„ìŠ¤ í™”ë©´ì— ê²Œì‹œí•˜ê±°ë‚˜ ê¸°íƒ€ì˜ ë°©ë²•ìœ¼ë¡œ ê³µì§€í•¨ìœ¼ë¡œì¨ íš¨ë ¥ì´ ë°œìƒí•©ë‹ˆë‹¤.
            </li>
            <li>
              íšŒì‚¬ëŠ” í•„ìš”í•œ ê²½ìš° ê´€ë ¨ ë²•ë ¹ì„ ìœ„ë°°í•˜ì§€ ì•ŠëŠ” ë²”ìœ„ ë‚´ì—ì„œ ë³¸ ì•½ê´€ì„ ë³€ê²½í•  ìˆ˜ ìˆìœ¼ë©°,
              ì•½ê´€ì´ ë³€ê²½ë˜ëŠ” ê²½ìš° ë³€ê²½ì‚¬í•­ì„ ì„œë¹„ìŠ¤ ë‚´ì— ê³µì§€í•©ë‹ˆë‹¤.
            </li>
            <li>
              íšŒì›ì€ ë³€ê²½ëœ ì•½ê´€ì— ë™ì˜í•˜ì§€ ì•Šì„ ê²½ìš° ì„œë¹„ìŠ¤ ì´ìš©ì„ ì¤‘ë‹¨í•˜ê³  íƒˆí‡´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              ì•½ê´€ ë³€ê²½ ê³µì§€ í›„ 7ì¼ ì´ë‚´ì— ì´ì˜ë¥¼ ì œê¸°í•˜ì§€ ì•Šìœ¼ë©´ ì•½ê´€ì— ë™ì˜í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ4ì¡° (íšŒì›ê°€ì…)</h2>
          <ol>
            <li>
              íšŒì›ê°€ì…ì€ ì´ìš©ìê°€ ë³¸ ì•½ê´€ ë° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•œ í›„ íšŒì›ê°€ì… ì‹ ì²­ì„ í•˜ê³ ,
              íšŒì‚¬ê°€ ì´ë¥¼ ìŠ¹ë‚™í•¨ìœ¼ë¡œì¨ ì²´ê²°ë©ë‹ˆë‹¤.
            </li>
            <li>
              íšŒì›ê°€ì… ì‹œ ì œê³µí•´ì•¼ í•˜ëŠ” ì •ë³´ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
              <ul>
                <li>ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸</li>
                <li>ì´ë¦„, ì´ë©”ì¼ ì£¼ì†Œ</li>
                <li>ì „í™”ë²ˆí˜¸, ìƒë…„</li>
              </ul>
            </li>
            <li>
              íšŒì‚¬ëŠ” ë‹¤ìŒ ê° í˜¸ì— í•´ë‹¹í•˜ëŠ” ê²½ìš° íšŒì›ê°€ì…ì„ ê±°ë¶€í•˜ê±°ë‚˜ ì‚¬í›„ì— ì´ìš©ê³„ì•½ì„ í•´ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
              <ul>
                <li>íƒ€ì¸ì˜ ëª…ì˜ë¥¼ ë„ìš©í•œ ê²½ìš°</li>
                <li>í—ˆìœ„ ì •ë³´ë¥¼ ê¸°ì¬í•œ ê²½ìš°</li>
                <li>ë§Œ 14ì„¸ ë¯¸ë§Œì¸ ê²½ìš°</li>
                <li>ê¸°íƒ€ íšŒì‚¬ê°€ ì •í•œ ì´ìš© ì‹ ì²­ ìš”ê±´ì„ ì¶©ì¡±í•˜ì§€ ëª»í•œ ê²½ìš°</li>
              </ul>
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ5ì¡° (ì„œë¹„ìŠ¤ì˜ ì œê³µ)</h2>
          <ol>
            <li>
              íšŒì‚¬ëŠ” íšŒì›ì—ê²Œ ë‹¤ìŒê³¼ ê°™ì€ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤:
              <ul>
                <li>ìŒì„± ë˜ëŠ” í…ìŠ¤íŠ¸ë¥¼ í†µí•œ ìš´ë™ ê¸°ë¡ ì…ë ¥</li>
                <li>AI ê¸°ë°˜ ìš´ë™ ë°ì´í„° ë¶„ì„ ë° ë§ì¶¤ ì¶”ì²œ</li>
                <li>ìš´ë™ íˆìŠ¤í† ë¦¬ ê´€ë¦¬ ë° í†µê³„</li>
                <li>ì˜¤ëŠ˜ì˜ ìš´ë™ Todo ê´€ë¦¬</li>
                <li>ê¸°íƒ€ íšŒì‚¬ê°€ ì¶”ê°€ ê°œë°œí•˜ê±°ë‚˜ ì œíœ´ê³„ì•½ ë“±ì„ í†µí•´ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤</li>
              </ul>
            </li>
            <li>
              ì„œë¹„ìŠ¤ëŠ” ì—°ì¤‘ë¬´íœ´, 1ì¼ 24ì‹œê°„ ì œê³µí•¨ì„ ì›ì¹™ìœ¼ë¡œ í•©ë‹ˆë‹¤. ë‹¤ë§Œ, ì‹œìŠ¤í…œ ì •ê¸°ì ê²€,
              ì¦ì„¤ ë° êµì²´ë¥¼ ìœ„í•´ íšŒì‚¬ê°€ ì •í•œ ë‚ ì´ë‚˜ ì‹œê°„ì—ëŠ” ì„œë¹„ìŠ¤ê°€ ì¼ì‹œ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ6ì¡° (ì„œë¹„ìŠ¤ì˜ ë³€ê²½ ë° ì¤‘ë‹¨)</h2>
          <ol>
            <li>
              íšŒì‚¬ëŠ” ìš´ì˜ìƒ, ê¸°ìˆ ìƒì˜ í•„ìš”ì— ë”°ë¼ ì œê³µí•˜ê³  ìˆëŠ” ì„œë¹„ìŠ¤ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </li>
            <li>
              íšŒì‚¬ëŠ” ë‹¤ìŒ ê° í˜¸ì— í•´ë‹¹í•˜ëŠ” ê²½ìš° ì„œë¹„ìŠ¤ì˜ ì „ë¶€ ë˜ëŠ” ì¼ë¶€ë¥¼ ì œí•œí•˜ê±°ë‚˜ ì¤‘ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
              <ul>
                <li>ì„œë¹„ìŠ¤ìš© ì„¤ë¹„ì˜ ë³´ìˆ˜ ë“± ê³µì‚¬ë¡œ ì¸í•œ ë¶€ë“ì´í•œ ê²½ìš°</li>
                <li>íšŒì›ì´ íšŒì‚¬ì˜ ì˜ì—…í™œë™ì„ ë°©í•´í•˜ëŠ” ê²½ìš°</li>
                <li>ì •ì „, ì œë°˜ ì„¤ë¹„ì˜ ì¥ì•  ë˜ëŠ” ì´ìš©ëŸ‰ì˜ í­ì£¼ ë“±ìœ¼ë¡œ ì •ìƒì ì¸ ì„œë¹„ìŠ¤ ì´ìš©ì— ì§€ì¥ì´ ìˆëŠ” ê²½ìš°</li>
                <li>ê¸°íƒ€ ì²œì¬ì§€ë³€, êµ­ê°€ë¹„ìƒì‚¬íƒœ ë“± ë¶ˆê°€í•­ë ¥ì  ì‚¬ìœ ê°€ ìˆëŠ” ê²½ìš°</li>
              </ul>
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ7ì¡° (íšŒì›ì˜ ì˜ë¬´)</h2>
          <ol>
            <li>
              íšŒì›ì€ ë‹¤ìŒ í–‰ìœ„ë¥¼ í•˜ì—¬ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤:
              <ul>
                <li>íšŒì›ê°€ì… ì‹ ì²­ ë˜ëŠ” ë³€ê²½ ì‹œ í—ˆìœ„ë‚´ìš©ì„ ë“±ë¡í•˜ëŠ” í–‰ìœ„</li>
                <li>íƒ€ì¸ì˜ ì •ë³´ë¥¼ ë„ìš©í•˜ëŠ” í–‰ìœ„</li>
                <li>íšŒì‚¬ê°€ ê²Œì‹œí•œ ì •ë³´ë¥¼ ë³€ê²½í•˜ëŠ” í–‰ìœ„</li>
                <li>íšŒì‚¬ê°€ ì •í•œ ì •ë³´ ì´ì™¸ì˜ ì •ë³´(ì»´í“¨í„° í”„ë¡œê·¸ë¨ ë“±) ë“±ì„ ì†¡ì‹  ë˜ëŠ” ê²Œì‹œí•˜ëŠ” í–‰ìœ„</li>
                <li>íšŒì‚¬ì™€ ê¸°íƒ€ ì œ3ìì˜ ì €ì‘ê¶Œ ë“± ì§€ì ì¬ì‚°ê¶Œì„ ì¹¨í•´í•˜ëŠ” í–‰ìœ„</li>
                <li>íšŒì‚¬ ë° ê¸°íƒ€ ì œ3ìì˜ ëª…ì˜ˆë¥¼ ì†ìƒì‹œí‚¤ê±°ë‚˜ ì—…ë¬´ë¥¼ ë°©í•´í•˜ëŠ” í–‰ìœ„</li>
                <li>ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ì–»ì€ ì •ë³´ë¥¼ íšŒì‚¬ì˜ ì‚¬ì „ ìŠ¹ë‚™ ì—†ì´ ë³µì œ, ìœ í†µ, ìƒì—…ì ìœ¼ë¡œ ì´ìš©í•˜ëŠ” í–‰ìœ„</li>
              </ul>
            </li>
            <li>
              íšŒì›ì€ ê´€ê³„ë²•ë ¹, ë³¸ ì•½ê´€, ì´ìš©ì•ˆë‚´ ë° ì„œë¹„ìŠ¤ì™€ ê´€ë ¨í•˜ì—¬ ê³µì§€í•œ ì£¼ì˜ì‚¬í•­ ë“±ì„ ì¤€ìˆ˜í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ8ì¡° (íšŒì› íƒˆí‡´ ë° ìê²© ìƒì‹¤)</h2>
          <ol>
            <li>
              íšŒì›ì€ ì–¸ì œë“ ì§€ ì„œë¹„ìŠ¤ ë‚´ ì„¤ì • ë©”ë‰´ë¥¼ í†µí•´ íšŒì› íƒˆí‡´ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìœ¼ë©°,
              íšŒì‚¬ëŠ” ì¦‰ì‹œ íšŒì›íƒˆí‡´ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            </li>
            <li>
              íšŒì› íƒˆí‡´ ì‹œ íšŒì›ì˜ ëª¨ë“  ë°ì´í„°ëŠ” ì‚­ì œë˜ë©°, ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
              ë‹¨, ê´€ë ¨ ë²•ë ¹ ë° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì— ë”°ë¼ ì¼ì • ê¸°ê°„ ë³´ê´€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </li>
            <li>
              íšŒì‚¬ëŠ” íšŒì›ì´ ë‹¤ìŒ ê° í˜¸ì˜ ì‚¬ìœ ì— í•´ë‹¹í•˜ëŠ” ê²½ìš°, ì‚¬ì „ í†µì§€ ì—†ì´ íšŒì›ìê²©ì„ ì œí•œ ë˜ëŠ”
              ì •ì§€ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
              <ul>
                <li>ê°€ì… ì‹ ì²­ ì‹œ í—ˆìœ„ ë‚´ìš©ì„ ë“±ë¡í•œ ê²½ìš°</li>
                <li>ë‹¤ë¥¸ ì‚¬ëŒì˜ ì„œë¹„ìŠ¤ ì´ìš©ì„ ë°©í•´í•˜ê±°ë‚˜ ì •ë³´ë¥¼ ë„ìš©í•˜ëŠ” ë“± ì§ˆì„œë¥¼ ìœ„í˜‘í•˜ëŠ” ê²½ìš°</li>
                <li>ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ë²•ë ¹ ë˜ëŠ” ë³¸ ì•½ê´€ì´ ê¸ˆì§€í•˜ëŠ” í–‰ìœ„ë¥¼ í•˜ëŠ” ê²½ìš°</li>
              </ul>
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ9ì¡° (ê°œì¸ì •ë³´ë³´í˜¸)</h2>
          <ol>
            <li>
              íšŒì‚¬ëŠ” íšŒì›ì˜ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•˜ì—¬ ê°œì¸ì •ë³´ë³´í˜¸ë²• ë“± ê´€ë ¨ ë²•ë ¹ì´ ì •í•˜ëŠ” ë°”ë¥¼
              ì¤€ìˆ˜í•©ë‹ˆë‹¤.
            </li>
            <li>
              íšŒì‚¬ì˜ ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì€ ì„œë¹„ìŠ¤ ë‚´ì— ë³„ë„ë¡œ ê²Œì‹œë˜ë©°, íšŒì›ì€ ì–¸ì œë“ ì§€ ì´ë¥¼ ì—´ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ10ì¡° (íšŒì‚¬ì˜ ì˜ë¬´)</h2>
          <ol>
            <li>
              íšŒì‚¬ëŠ” ë²•ë ¹ê³¼ ë³¸ ì•½ê´€ì´ ê¸ˆì§€í•˜ê±°ë‚˜ ê³µì„œì–‘ì†ì— ë°˜í•˜ëŠ” í–‰ìœ„ë¥¼ í•˜ì§€ ì•Šìœ¼ë©°,
              ë³¸ ì•½ê´€ì´ ì •í•˜ëŠ” ë°”ì— ë”°ë¼ ì§€ì†ì ì´ê³  ì•ˆì •ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ ë…¸ë ¥í•©ë‹ˆë‹¤.
            </li>
            <li>
              íšŒì‚¬ëŠ” íšŒì›ì´ ì•ˆì „í•˜ê²Œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆë„ë¡ ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•œ ë³´ì•ˆì‹œìŠ¤í…œì„
              ê°–ì¶”ì–´ì•¼ í•˜ë©° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì„ ê³µì‹œí•˜ê³  ì¤€ìˆ˜í•©ë‹ˆë‹¤.
            </li>
            <li>
              íšŒì‚¬ëŠ” ì„œë¹„ìŠ¤ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ íšŒì›ìœ¼ë¡œë¶€í„° ì œê¸°ëœ ì˜ê²¬ì´ë‚˜ ë¶ˆë§Œì´ ì •ë‹¹í•˜ë‹¤ê³  ì¸ì •í•  ê²½ìš°
              ì´ë¥¼ ì²˜ë¦¬í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ11ì¡° (ë©´ì±…ì¡°í•­)</h2>
          <ol>
            <li>
              íšŒì‚¬ëŠ” ì²œì¬ì§€ë³€ ë˜ëŠ” ì´ì— ì¤€í•˜ëŠ” ë¶ˆê°€í•­ë ¥ìœ¼ë¡œ ì¸í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•  ìˆ˜ ì—†ëŠ” ê²½ìš°ì—ëŠ”
              ì„œë¹„ìŠ¤ ì œê³µì— ê´€í•œ ì±…ì„ì´ ë©´ì œë©ë‹ˆë‹¤.
            </li>
            <li>
              íšŒì‚¬ëŠ” íšŒì›ì˜ ê·€ì±…ì‚¬ìœ ë¡œ ì¸í•œ ì„œë¹„ìŠ¤ ì´ìš©ì˜ ì¥ì• ì— ëŒ€í•˜ì—¬ ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </li>
            <li>
              íšŒì‚¬ëŠ” íšŒì›ì´ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ê¸°ëŒ€í•˜ëŠ” ìš´ë™ íš¨ê³¼ë‚˜ ê²°ê³¼ë¥¼ ì–»ì§€ ëª»í•œ ê²ƒì— ëŒ€í•˜ì—¬
              ì±…ì„ì„ ì§€ì§€ ì•Šìœ¼ë©°, ì„œë¹„ìŠ¤ ì´ìš©ìœ¼ë¡œ ì¸í•œ ë¶€ìƒì´ë‚˜ ê±´ê°•ìƒì˜ ë¬¸ì œì— ëŒ€í•´ì„œë„ ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </li>
            <li>
              íšŒì‚¬ëŠ” AIê°€ ì œê³µí•˜ëŠ” ìš´ë™ ì¶”ì²œì˜ ì •í™•ì„±ì´ë‚˜ ì í•©ì„±ì„ ë³´ì¥í•˜ì§€ ì•Šìœ¼ë©°,
              íšŒì›ì€ ìì‹ ì˜ ê±´ê°• ìƒíƒœì™€ ëŠ¥ë ¥ì„ ê³ ë ¤í•˜ì—¬ ìš´ë™ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
            </li>
            <li>
              íšŒì›ì€ ìš´ë™ ìˆ˜í–‰ ì „ ì „ë¬¸ì˜ì™€ ìƒë‹´í•˜ì—¬ ìì‹ ì˜ ê±´ê°• ìƒíƒœë¥¼ í™•ì¸í•  ê²ƒì„ ê¶Œì¥í•˜ë©°,
              ì„œë¹„ìŠ¤ëŠ” ì˜ë£Œì  ì¡°ì–¸ì´ë‚˜ ì§„ë‹¨ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ12ì¡° (ì†í•´ë°°ìƒ)</h2>
          <p>
            íšŒì‚¬ ë˜ëŠ” íšŒì›ì€ ë³¸ ì•½ê´€ì„ ìœ„ë°˜í•˜ì—¬ ìƒëŒ€ë°©ì—ê²Œ ì†í•´ë¥¼ ì…íŒ ê²½ìš°ì—ëŠ” ê·¸ ì†í•´ë¥¼ ë°°ìƒí• 
            ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ê³ ì˜ ë˜ëŠ” ê³¼ì‹¤ì´ ì—†ëŠ” ê²½ìš°ì—ëŠ” ê·¸ëŸ¬í•˜ì§€ ì•„ë‹ˆí•©ë‹ˆë‹¤.
          </p>
        </section>

        <section className="policy-section">
          <h2>ì œ13ì¡° (ë¶„ìŸì˜ í•´ê²°)</h2>
          <ol>
            <li>
              íšŒì‚¬ì™€ íšŒì›ì€ ì„œë¹„ìŠ¤ì™€ ê´€ë ¨í•˜ì—¬ ë°œìƒí•œ ë¶„ìŸì„ ì›ë§Œí•˜ê²Œ í•´ê²°í•˜ê¸° ìœ„í•˜ì—¬ í•„ìš”í•œ ëª¨ë“  ë…¸ë ¥ì„
              í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.
            </li>
            <li>
              ì œ1í•­ì˜ ë…¸ë ¥ì—ë„ ë¶ˆêµ¬í•˜ê³ , ë¶„ìŸìœ¼ë¡œ ì¸í•œ ì†Œì†¡ì´ ì œê¸°ë  ê²½ìš° ì†Œì†¡ì€ íšŒì‚¬ì˜ ë³¸ì‚¬ ì†Œì¬ì§€ë¥¼
              ê´€í• í•˜ëŠ” ë²•ì›ì„ ì „ì† ê´€í• ë²•ì›ìœ¼ë¡œ í•©ë‹ˆë‹¤.
            </li>
          </ol>
        </section>

        <section className="policy-section">
          <h2>ì œ14ì¡° (ë¬¸ì˜ ë° ê³ ê°ì„¼í„°)</h2>
          <p>
            ì„œë¹„ìŠ¤ ì´ìš©ê³¼ ê´€ë ¨í•œ ë¬¸ì˜ ì‚¬í•­ì´ë‚˜ ë¶ˆë§Œ ì‚¬í•­ì´ ìˆëŠ” ê²½ìš° ì•„ë˜ì˜ ì—°ë½ì²˜ë¡œ ë¬¸ì˜í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
          <div className="contact-info">
            <p><strong>ê³ ê°ì„¼í„°</strong></p>
            <p>ì‚¬ì—…ìëª…: jh308(ì œì´ì—ì´ì¹˜308)</p>
            <p>ëŒ€í‘œì: ì–‘ì„í™˜</p>
            <p>ì‚¬ì—…ìë²ˆí˜¸: 188-17-02548</p>
            <p>ì´ë©”ì¼: shy@lunagarden.co.kr</p>
            <p>ì „í™”: 010-3114-8626</p>
          </div>
        </section>

        <section className="policy-section">
          <h2>ë¶€ì¹™</h2>
          <p>ë³¸ ì•½ê´€ì€ 2026ë…„ 1ì›” 15ì¼ë¶€í„° ì‹œí–‰ë©ë‹ˆë‹¤.</p>
        </section>
      </div>
    </div>
  );
};
</file>

<file path="src/services/challengeService.ts">
import * as clubStorage from '../storage/clubStorage';
import { formatDate } from '../storage/clubStorage';
import type { ClubChallenge, ChallengeDetailWithContributors } from '../types';
import type { CreateChallengeDTO } from '../types/challenge';

class ChallengeService {
  async createChallenge(data: CreateChallengeDTO): Promise<ClubChallenge> {
    // Business logic validation
    if (data.title.trim().length < 3) {
      throw new Error('ì±Œë¦°ì§€ ì œëª©ì€ ìµœì†Œ 3ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    }
    if (data.rules.goal_value <= 0) {
      throw new Error('ëª©í‘œ ê°’ì€ 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
    }

    const startDate = new Date(data.start_date);
    const endDate = new Date(data.end_date);
    if (endDate <= startDate) {
      throw new Error('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
    }

    return await clubStorage.createChallenge(data);
  }

  async getActiveChallenges(clubId: string): Promise<ClubChallenge[]> {
    return await clubStorage.getActiveChallenges(clubId);
  }

  async getChallengeDetail(challengeId: string): Promise<ChallengeDetailWithContributors> {
    return await clubStorage.getChallengeDetail(challengeId);
  }

  async contributeToChallenge(challengeId: string, workoutLogId: string): Promise<void> {
    return await clubStorage.contributeToChallenge(challengeId, workoutLogId);
  }

  async updateChallenge(
    challengeId: string,
    updates: Partial<Pick<ClubChallenge, 'title' | 'description' | 'status'>>
  ): Promise<void> {
    if (updates.title && updates.title.trim().length < 3) {
      throw new Error('ì±Œë¦°ì§€ ì œëª©ì€ ìµœì†Œ 3ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    }
    return await clubStorage.updateChallenge(challengeId, updates);
  }

  async deleteChallenge(challengeId: string): Promise<void> {
    return await clubStorage.deleteChallenge(challengeId);
  }

  // Calculate progress percentage
  calculateProgress(current: number, target: number): number {
    if (target === 0) return 0;
    return Math.min(Math.round((current / target) * 100), 100);
  }

  // Check and auto-update challenge status
  async checkAndUpdateChallengeStatus(challengeId: string): Promise<void> {
    const challenge = await clubStorage.getChallengeDetail(challengeId);

    const today = formatDate(new Date());
    const endDate = challenge.end_date;

    if (challenge.status === 'active') {
      // Goal achieved
      if (challenge.current_value >= challenge.target_value) {
        await clubStorage.updateChallenge(challengeId, { status: 'completed' });
      }
      // Period ended
      else if (today > endDate) {
        await clubStorage.updateChallenge(challengeId, { status: 'failed' });
      }
    }
  }
}

export default new ChallengeService();
</file>

<file path="src/storage/logStorage.ts">
import type { WorkoutLog, UserProfile, DailyTodo } from '../types';

const STORAGE_KEY = 'vwl_logs';
const PROFILE_KEY = 'vwl_profile';
const TODO_KEY = 'vwl_todos';

export const getAllLogs = (): WorkoutLog[] => {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return [];
    return JSON.parse(data) as WorkoutLog[];
  } catch (error) {
    console.error('Failed to load logs:', error);
    return [];
  }
};

export const saveLog = (log: WorkoutLog): void => {
  try {
    const logs = getAllLogs();
    const existingIndex = logs.findIndex((l) => l.id === log.id);

    if (existingIndex >= 0) {
      logs[existingIndex] = log;
    } else {
      logs.push(log);
    }

    logs.sort((a, b) => b.createdAt - a.createdAt);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
  } catch (error) {
    console.error('Failed to save log:', error);
    throw new Error('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const deleteLog = (id: string): void => {
  try {
    const logs = getAllLogs();
    const filtered = logs.filter((l) => l.id !== id);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
  } catch (error) {
    console.error('Failed to delete log:', error);
    throw new Error('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const getLogById = (id: string): WorkoutLog | null => {
  const logs = getAllLogs();
  return logs.find((l) => l.id === id) || null;
};

export const generateId = (): string => {
  return `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
};

export const formatDate = (date: Date = new Date()): string => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// User Profile Management
export const getUserProfile = (): UserProfile | null => {
  try {
    const data = localStorage.getItem(PROFILE_KEY);
    if (!data) return null;
    return JSON.parse(data) as UserProfile;
  } catch (error) {
    console.error('Failed to load profile:', error);
    return null;
  }
};

export const saveUserProfile = (profile: UserProfile): void => {
  try {
    localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
  } catch (error) {
    console.error('Failed to save profile:', error);
    throw new Error('í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const deleteUserProfile = (): void => {
  try {
    localStorage.removeItem(PROFILE_KEY);
  } catch (error) {
    console.error('Failed to delete profile:', error);
    throw new Error('í”„ë¡œí•„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// Daily Todo Management
export const getTodayTodo = (): DailyTodo | null => {
  try {
    const today = formatDate();
    const todos = getAllTodos();
    return todos.find((t) => t.date === today) || null;
  } catch (error) {
    console.error('Failed to load today todo:', error);
    return null;
  }
};

export const getAllTodos = (): DailyTodo[] => {
  try {
    const data = localStorage.getItem(TODO_KEY);
    if (!data) return [];
    return JSON.parse(data) as DailyTodo[];
  } catch (error) {
    console.error('Failed to load todos:', error);
    return [];
  }
};

export const saveTodo = (todo: DailyTodo): void => {
  try {
    const todos = getAllTodos();
    const existingIndex = todos.findIndex((t) => t.id === todo.id);

    if (existingIndex >= 0) {
      todos[existingIndex] = todo;
    } else {
      todos.push(todo);
    }

    todos.sort((a, b) => b.createdAt - a.createdAt);
    localStorage.setItem(TODO_KEY, JSON.stringify(todos));
  } catch (error) {
    console.error('Failed to save todo:', error);
    throw new Error('Todo ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const deleteTodo = (id: string): void => {
  try {
    const todos = getAllTodos();
    const filtered = todos.filter((t) => t.id !== id);
    localStorage.setItem(TODO_KEY, JSON.stringify(filtered));
  } catch (error) {
    console.error('Failed to delete todo:', error);
    throw new Error('Todo ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};
</file>

<file path="src/utils/ai/parseWorkoutAPI.ts">
import type { Workout } from '../../types';

/**
 * Call the Netlify Function to parse workout text using OpenAI
 * This replaces the insecure browser-side OpenAI calls
 */
export async function parseWorkoutAPI(text: string): Promise<Workout[]> {
  if (!text.trim()) {
    return [];
  }

  try {
    console.log('[parseWorkoutAPI] Calling Netlify Function with text:', text);

    const response = await fetch('/.netlify/functions/parse-workout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ text }),
    });

    console.log('[parseWorkoutAPI] Response status:', response.status);

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
      console.error('[parseWorkoutAPI] Error response:', errorData);

      // Show detailed error from backend
      const errorMsg = errorData.details
        ? `${errorData.error}: ${errorData.details}`
        : errorData.error || response.statusText;

      throw new Error(`API Error (${response.status}): ${errorMsg}`);
    }

    const data = await response.json();
    console.log('[parseWorkoutAPI] Success, parsed workouts:', data.workouts);
    return data.workouts || [];
  } catch (error) {
    console.error('[parseWorkoutAPI] Failed to parse workout:', error);
    throw new Error('ìš´ë™ íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error instanceof Error ? error.message : 'Unknown error'));
  }
}
</file>

<file path="src/utils/workoutDisplay.ts">
import type { WorkoutCategory, WorkoutType } from '../types';

/**
 * Matrix Classification ì‹œê°í™” ìœ í‹¸ë¦¬í‹°
 *
 * ì•„ì´ì½˜ (Category) + ìƒ‰ìƒ (Type) ì¡°í•©ìœ¼ë¡œ ìš´ë™ì„ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„
 */

// Categoryë³„ ì•„ì´ì½˜ ë§¤í•‘
export const getCategoryIcon = (category: WorkoutCategory): string => {
  const iconMap: Record<WorkoutCategory, string> = {
    gym: 'ğŸ‹ï¸',
    snowboard: 'ğŸ‚',
    running: 'ğŸƒ',
    sports: 'âš½',
    home: 'ğŸ ',
    other: 'ğŸ’ª',
  };
  return iconMap[category] || 'ğŸ’ª';
};

// Categoryë³„ ë¼ë²¨
export const getCategoryLabel = (category: WorkoutCategory): string => {
  const labelMap: Record<WorkoutCategory, string> = {
    gym: 'í—¬ìŠ¤ì¥',
    snowboard: 'ìŠ¤ë…¸ë³´ë“œ',
    running: 'ëŸ¬ë‹',
    sports: 'ìŠ¤í¬ì¸ ',
    home: 'í™ˆíŠ¸',
    other: 'ê¸°íƒ€',
  };
  return labelMap[category] || 'ê¸°íƒ€';
};

// Typeë³„ ìƒ‰ìƒ ë§¤í•‘ (í…Œë‘ë¦¬/ë°°ê²½ìš©)
export const getTypeColor = (type: WorkoutType): string => {
  const colorMap: Record<WorkoutType, string> = {
    strength: '#EF4444', // ë¹¨ê°• (ê°•ë ¬í•¨, ê·¼ë ¥)
    cardio: '#3B82F6',   // íŒŒë‘ (ìˆ¨ì°¸, ì§€êµ¬ë ¥)
    skill: '#A855F7',    // ë³´ë¼ (ê³ ê¸‰, í…Œí¬ë‹‰)
    flexibility: '#10B981', // ì´ˆë¡ (ìœ ì—°ì„±, í¸ì•ˆí•¨)
    unknown: '#6B7280',  // íšŒìƒ‰ (ë¯¸ë¶„ë¥˜)
  };
  return colorMap[type] || '#6B7280';
};

// Typeë³„ ë¼ë²¨
export const getTypeLabel = (type: WorkoutType): string => {
  const labelMap: Record<WorkoutType, string> = {
    strength: 'ê·¼ë ¥',
    cardio: 'ì‹¬í',
    skill: 'ê¸°ìˆ ',
    flexibility: 'ìœ ì—°ì„±',
    unknown: 'ë¯¸ë¶„ë¥˜',
  };
  return labelMap[type] || 'ë¯¸ë¶„ë¥˜';
};

// Typeë³„ ë°ì€ ë°°ê²½ìƒ‰ (ì¹´ë“œ ë°°ê²½ìš©)
export const getTypeLightColor = (type: WorkoutType): string => {
  const lightColorMap: Record<WorkoutType, string> = {
    strength: '#FEE2E2',   // ë¹¨ê°• ë°ì€ìƒ‰
    cardio: '#DBEAFE',     // íŒŒë‘ ë°ì€ìƒ‰
    skill: '#F3E8FF',      // ë³´ë¼ ë°ì€ìƒ‰
    flexibility: '#D1FAE5', // ì´ˆë¡ ë°ì€ìƒ‰
    unknown: '#F3F4F6',    // íšŒìƒ‰ ë°ì€ìƒ‰
  };
  return lightColorMap[type] || '#F3F4F6';
};

// ìš´ë™ ì¹´ë“œ ìŠ¤íƒ€ì¼ ìƒì„± (ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ê°ì²´)
export const getWorkoutCardStyle = (
  _category: WorkoutCategory,
  type: WorkoutType
): React.CSSProperties => {
  return {
    border: `2px solid ${getTypeColor(type)}`,
    backgroundColor: getTypeLightColor(type),
    borderRadius: '8px',
    padding: '12px',
    position: 'relative',
    transition: 'all 0.2s ease',
  };
};

// ìš´ë™ ì¹´ë“œ í—¤ë” ìŠ¤íƒ€ì¼ (ì•„ì´ì½˜ + ì´ë¦„)
export const getWorkoutCardHeader = (
  category: WorkoutCategory,
  name: string
): string => {
  const icon = getCategoryIcon(category);
  return `${icon} ${name}`;
};

// Type ë±ƒì§€ ìŠ¤íƒ€ì¼
export const getTypeBadgeStyle = (type: WorkoutType): React.CSSProperties => {
  return {
    display: 'inline-block',
    padding: '2px 8px',
    borderRadius: '4px',
    fontSize: '11px',
    fontWeight: '600',
    backgroundColor: getTypeColor(type),
    color: 'white',
    marginLeft: '8px',
  };
};
</file>

<file path="netlify.toml">
[build]
  command = "npm run build"
  publish = "dist"
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "22"
  SECRETS_SCAN_SMART_DETECTION_ENABLED = "false"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
</file>

<file path="README.md">
# Voice Workout Log

ìš´ë™ í›„ "ë§ë¡œ" ê¸°ë¡í•˜ëŠ” ëª¨ë°”ì¼ ìš°ì„  ì›¹ì•±ì…ë‹ˆë‹¤.

## ë‘ ê°€ì§€ ëª¨ë“œ ì§€ì›

### ê¸°ë³¸ ëª¨ë“œ (ë¬´ë£Œ)
- ë¸Œë¼ìš°ì € Web Speech API ìŒì„± ì¸ì‹
- ë£° ê¸°ë°˜ íŒŒì‹±
- ì™„ì „ ë¬´ë£Œ, ë¡œê·¸ì¸ ë¶ˆí•„ìš”

### AI ëª¨ë“œ (ìœ ë£Œ)
- Google Gemini 2.0 Flash ìŒì„± ì¸ì‹ (ì •í™•ë„ í–¥ìƒ)
- Gemini 2.0 Flash ìŠ¤ë§ˆíŠ¸ íŒŒì‹± (ìì—°ì–´ ì´í•´)
- ë¬´ë£Œ ë˜ëŠ” ì €ë¹„ìš© (ê°œì¸ ì‚¬ìš© ê¸°ì¤€)

## ê¸°ëŠ¥

- ìŒì„± ì¸ì‹ì„ í†µí•œ ìš´ë™ ê¸°ë¡ ì…ë ¥
- ì‹¤ì‹œê°„ ìë§‰ í‘œì‹œ (ê¸°ë³¸ ëª¨ë“œ)
- ìš´ë™ ìš©ì–´ ìë™ ì •ê·œí™”
- ìŠ¤ë§ˆíŠ¸ íŒŒì‹± (ì„¸íŠ¸, íšŸìˆ˜, ì‹œê°„, ë©”ëª¨ ìë™ ì¶”ì¶œ)
- ê¸°ë¡ í¸ì§‘ ë° ì¬ì •ë¦¬
- ë‚ ì§œë³„ íˆìŠ¤í† ë¦¬ ì¡°íšŒ
- localStorage ê¸°ë°˜ ì˜¤í”„ë¼ì¸ ì €ì¥

## ê¸°ìˆ  ìŠ¤íƒ

- React 18
- TypeScript
- Vite
- React Router
- Web Speech API
- Google Gemini API (Gemini 2.0 Flash)

## ì‹¤í–‰ ë°©ë²•

### 1. ì„¤ì¹˜

```bash
npm install
```

### 2. AI ëª¨ë“œ ì„¤ì • (ì„ íƒì‚¬í•­)

AI ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ Google Gemini API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.

1. [Google AI Studio](https://aistudio.google.com/apikey)ì—ì„œ API í‚¤ ë°œê¸‰
2. `.env` íŒŒì¼ ìƒì„±:

```bash
cp .env.example .env
```

3. `.env` íŒŒì¼ì— API í‚¤ ì…ë ¥:

```
VITE_GEMINI_API_KEY=your-api-key
```

### 3. ê°œë°œ ì„œë²„ ì‹¤í–‰

```bash
npm run dev
```

ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:5173` ì ‘ì†

### ë¹Œë“œ

```bash
npm run build
```

### í”„ë¦¬ë·°

```bash
npm run preview
```

## ë¸Œë¼ìš°ì € ì§€ì›

Web Speech APIëŠ” ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### ì§€ì›ë˜ëŠ” ë¸Œë¼ìš°ì €

- âœ… Chrome (ë°ìŠ¤í¬í†±/ëª¨ë°”ì¼)
- âœ… Edge (ë°ìŠ¤í¬í†±/ëª¨ë°”ì¼)
- âœ… Safari (iOS 14.5+)
- âœ… Samsung Internet

### ë¯¸ì§€ì› ë¸Œë¼ìš°ì €

- âŒ Firefox (Web Speech API ë¯¸ì§€ì›)
- âŒ Opera (ì¼ë¶€ ë²„ì „ ë¯¸ì§€ì›)

**ê¶Œì¥ ë¸Œë¼ìš°ì €**: Chrome ë˜ëŠ” Edge

## ì‚¬ìš© ë°©ë²•

### 1. ìŒì„±ìœ¼ë¡œ ìš´ë™ ê¸°ë¡í•˜ê¸°

1. í™ˆ í™”ë©´ì˜ ë§ˆì´í¬ ë²„íŠ¼ì„ íƒ­í•˜ì—¬ ë…¹ìŒ ì‹œì‘
2. ìš´ë™ ë‚´ìš©ì„ ë§í•˜ê¸° (ì˜ˆ: "í‘¸ì‹œì—… 12íšŒ 3ì„¸íŠ¸, í”Œë­í¬ 1ë¶„")
3. ë§ˆì´í¬ ë²„íŠ¼ì„ ë‹¤ì‹œ íƒ­í•˜ì—¬ ë…¹ìŒ ì¢…ë£Œ
4. ìë™ìœ¼ë¡œ íŒŒì‹±ëœ ê²°ê³¼ í™•ì¸

### 2. ê¸°ë¡ í¸ì§‘ ë° ì €ì¥

1. ì›ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ì • ê°€ëŠ¥
2. "ì¬ì •ë¦¬" ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ íŒŒì‹±
3. "ì €ì¥" ë²„íŠ¼ìœ¼ë¡œ localStorageì— ì €ì¥

### 3. íˆìŠ¤í† ë¦¬ ì¡°íšŒ

1. íˆìŠ¤í† ë¦¬ í˜ì´ì§€ì—ì„œ ë‚ ì§œë³„ ê¸°ë¡ í™•ì¸
2. í•­ëª© í´ë¦­ìœ¼ë¡œ ìƒì„¸ ë‚´ìš© ë³´ê¸°
3. í•„ìš”ì‹œ ê¸°ë¡ ì‚­ì œ

## ì •ê·œí™” ê·œì¹™

ìŒì„± ì¸ì‹ ê²°ê³¼ë¥¼ ìš´ë™ ìš©ì–´ë¡œ ìë™ ì¹˜í™˜í•©ë‹ˆë‹¤:

- "ì‚¬ë ˆë ˆ", "ì‚¬ë¡€ë¥¼", "ì‚¬ë ˆ" â†’ "ì‚¬ì´ë“œ ë ˆí„°ëŸ´ ë ˆì´ì¦ˆ"
- "ë°ë“œ ë²„ê·¸", "ë°ë“œë¶" â†’ "ë°ë“œë²„ê·¸"
- "ì²œêµ­ì˜ ê³„ë‹¨" â†’ "ìŠ¤í…ë°€"
- "ë« í’€ë‹¤ìš´", "ë«í’€" â†’ "ë«í’€ë‹¤ìš´"
- "í‘¸ì‰¬ì—…", "íŒ”êµ½í˜€" â†’ "í‘¸ì‹œì—…"
- "í”Œë­í¬" â†’ "í”Œë­í¬"
- "ì‚¬ì´ë“œ í”Œë­í¬", "ì‚¬í”Œ" â†’ "ì‚¬ì´ë“œí”Œë­í¬"
- "ì¹´í”„", "ì¹´í”„ ë ˆì´ì¦ˆ" â†’ "ì¹´í”„ë ˆì´ì¦ˆ"
- "ë¡œìš°", "ë¡œì‰" â†’ "ë¡œìš°"
- "ëŸ°ë‹", "ëŸ¬ë‹" â†’ "ëŸ¬ë‹"

## íŒŒì‹± ë¡œì§

ë£° ê¸°ë°˜ìœ¼ë¡œ í…ìŠ¤íŠ¸ì—ì„œ ìš´ë™ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤:

- `Xë¶„`, `Xë¶„ê°„` â†’ duration_min
- `Xì„¸íŠ¸` â†’ sets
- `XíšŒ`, `Xê°œ` â†’ reps
- `XxY` í˜•íƒœ (ì˜ˆ: 12x3) â†’ reps=12, sets=3
- ìš´ë™ëª…ì€ ì•Œë ¤ì§„ ìš©ì–´ ì‚¬ì „ê³¼ ë§¤ì¹­

## ë°ì´í„° êµ¬ì¡°

### WorkoutLog

```typescript
{
  id: string;              // UUID
  date: string;            // YYYY-MM-DD
  rawText: string;         // ì›ë¬¸
  normalizedText: string;  // ì •ê·œí™”ëœ í…ìŠ¤íŠ¸
  workouts: Workout[];     // íŒŒì‹±ëœ ìš´ë™ ëª©ë¡
  memo: string | null;     // ì „ì²´ ë©”ëª¨
  createdAt: number;       // ìƒì„± ì‹œê° (timestamp)
}
```

### Workout

```typescript
{
  name: string;
  sets: number | null;
  reps: number | null;
  duration_min: number | null;
  type: 'strength' | 'cardio' | 'core' | 'mobility' | 'unknown';
  note: string | null;
}
```

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
src/
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ speech/
â”‚   â”‚   â”œâ”€â”€ useSpeechRecognition.ts      # Web Speech API í›…
â”‚   â”‚   â””â”€â”€ useWhisperRecording.ts       # Gemini ìŒì„± ì¸ì‹ í›…
â”‚   â”œâ”€â”€ normalize/
â”‚   â”‚   â””â”€â”€ normalizeText.ts             # í…ìŠ¤íŠ¸ ì •ê·œí™”
â”‚   â””â”€â”€ parse/
â”‚       â”œâ”€â”€ parseWorkoutText.ts          # ë£° ê¸°ë°˜ íŒŒì‹±
â”‚       â””â”€â”€ parseWithGPT.ts              # Gemini íŒŒì‹±
â”œâ”€â”€ storage/
â”‚   â””â”€â”€ logStorage.ts                    # localStorage ê´€ë¦¬
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ gemini.ts                        # Gemini API ìœ í‹¸ë¦¬í‹°
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ Home.tsx                         # í™ˆ/ë…¹ìŒ í˜ì´ì§€
â”‚   â”œâ”€â”€ History.tsx                      # íˆìŠ¤í† ë¦¬ í˜ì´ì§€
â”‚   â””â”€â”€ Recommend.tsx                    # AI ìš´ë™ ì¶”ì²œ í˜ì´ì§€
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ index.ts                         # TypeScript íƒ€ì… ì •ì˜
â”‚   â””â”€â”€ speech.d.ts                      # Web Speech API íƒ€ì…
â”œâ”€â”€ App.tsx                              # ë©”ì¸ ì•± ì»´í¬ë„ŒíŠ¸
â”œâ”€â”€ App.css                              # ìŠ¤íƒ€ì¼
â””â”€â”€ main.tsx                             # ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸
```

## AI ëª¨ë“œ ë¹„ìš©

Google Gemini APIëŠ” ë¬´ë£Œ í‹°ì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤:
- Gemini 2.0 Flash: ë¬´ë£Œ í‹°ì–´ì—ì„œ ì›” 1,500 ìš”ì²­ ê°€ëŠ¥
- ê°œì¸ ì‚¬ìš© ê¸°ì¤€ (ì›” 30~60íšŒ ê¸°ë¡)ì€ ë¬´ë£Œ í‹°ì–´ ë‚´ì—ì„œ ì¶©ë¶„íˆ ì‚¬ìš© ê°€ëŠ¥
- ë¬´ë£Œ í‹°ì–´ ì´ˆê³¼ ì‹œì—ë„ ë¹„ìš©ì´ ë§¤ìš° ì €ë ´í•¨

ìì„¸í•œ ì •ë³´: [Google AI Studio Pricing](https://ai.google.dev/pricing)

## í–¥í›„ ê°œì„  í¬ì¸íŠ¸

### AI ê¸°ëŠ¥ í™•ì¥

- ìš´ë™ ë£¨í‹´ ì¶”ì²œ (GPT)
- ìŒì„± ëª…ë ¹ (ì‹œì‘/ì¢…ë£Œ/ì €ì¥ ë“±)
- ìš´ë™ í¼ ë¶„ì„ (ì´ë¯¸ì§€/ì˜ìƒ + Vision API)

### ê¸°ëŠ¥ í™•ì¥

- ë°±ì—”ë“œ ì„œë²„ + ì¸ì¦ (ë¡œê·¸ì¸/íšŒì›ê°€ì…)
- ë‹¤ì¤‘ ê¸°ê¸° ë™ê¸°í™”
- í†µê³„ ë° ì°¨íŠ¸ (ì£¼ê°„/ì›”ê°„ ë¶„ì„)
- ìš´ë™ ëª©í‘œ ì„¤ì • ë° ì¶”ì 
- ì´ë¯¸ì§€/ë™ì˜ìƒ ì²¨ë¶€

### UX ê°œì„ 

- PWA (Progressive Web App) ë³€í™˜
- ì˜¤í”„ë¼ì¸ ì§€ì› ê°•í™”
- ë‹¤í¬ ëª¨ë“œ
- ë‹¤êµ­ì–´ ì§€ì›

## ë¼ì´ì„ ìŠ¤

MIT

## ê¸°ì—¬

ì´ìŠˆ ë° PRì€ ì–¸ì œë“  í™˜ì˜í•©ë‹ˆë‹¤!
</file>

<file path="src/components/BottomNav.tsx">
import { useNavigate, useLocation } from 'react-router-dom';

export const BottomNav = () => {
  const navigate = useNavigate();
  const location = useLocation();

  const isActive = (path: string) => {
    if (path === '/') {
      return location.pathname === '/';
    }
    return location.pathname.startsWith(path);
  };

  return (
    <nav className="bottom-nav bottom-nav-5">
      <button
        className={`nav-item ${isActive('/') && location.pathname === '/' ? 'active' : ''}`}
        onClick={() => navigate('/')}
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
        </svg>
        <span>íˆìŠ¤í† ë¦¬</span>
      </button>

      <button
        className={`nav-item ${isActive('/dashboard') ? 'active' : ''}`}
        onClick={() => navigate('/dashboard')}
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
        </svg>
        <span>ëŒ€ì‹œë³´ë“œ</span>
      </button>

      {/* Club Tab (Middle, Emphasized) */}
      <button
        className={`nav-item ${isActive('/club') ? 'active' : ''}`}
        onClick={() => navigate('/club')}
      >
        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
          <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
        </svg>
        <span style={{ fontWeight: '700' }}>í´ëŸ½</span>
      </button>

      <button
        className={`nav-item ${isActive('/todo') ? 'active' : ''}`}
        onClick={() => navigate('/todo')}
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
        </svg>
        <span>Todo</span>
      </button>

      <button
        className={`nav-item ${isActive('/recommend') ? 'active' : ''}`}
        onClick={() => navigate('/recommend')}
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
        <span>AI ì¶”ì²œ</span>
      </button>
    </nav>
  );
};
</file>

<file path="src/components/challenge/ChallengeWizard.tsx">
/**
 * Challenge Wizard - Quest Builder
 * 3-Step ì±Œë¦°ì§€ ìƒì„± ë§ˆë²•ì‚¬
 */

import { useState } from 'react';
import type {
  QuestTheme,
  ChallengeRules,
  MetricType,
  CreateChallengeDTO,
  ChallengeTemplate,
} from '../../types/challenge';
import { CHALLENGE_TEMPLATES, REFERENCE_GUIDES } from '../../types/challenge';
import type { WorkoutCategory, WorkoutType } from '../../types';
import * as clubStorage from '../../storage/clubStorage';

interface ChallengeWizardProps {
  clubId: string;
  onClose: () => void;
  onSuccess: () => void;
}

type WizardStep = 1 | 2 | 3;

export const ChallengeWizard = ({ clubId, onClose, onSuccess }: ChallengeWizardProps) => {
  const [step, setStep] = useState<WizardStep>(1);
  const [loading, setLoading] = useState(false);

  // Step 1: Quest Theme ì„ íƒ
  const [theme, setTheme] = useState<QuestTheme | null>(null);

  // Step 2: Rules ì„¤ì •
  const [rules, setRules] = useState<ChallengeRules>({
    target_metric: 'volume_kg',
    filter: {},
    aggregation: 'sum',
    goal_value: 0,
    unit: 'kg',
  });

  // Step 3: ë©”íƒ€ë°ì´í„°
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');
  const [themeColor, setThemeColor] = useState('#8b5cf6');

  // í…œí”Œë¦¿ ì ìš©
  const applyTemplate = (template: ChallengeTemplate) => {
    setTheme(template.theme);
    setRules(template.rules);
    setTitle(template.name);
    setDescription(template.description);
    setThemeColor(getThemeColor(template.theme));

    // ê¶Œì¥ ê¸°ê°„ ì„¤ì •
    const start = new Date();
    const end = new Date();
    end.setDate(end.getDate() + template.recommended_duration_days);
    setStartDate(start.toISOString().split('T')[0]);
    setEndDate(end.toISOString().split('T')[0]);

    setStep(3); // ë°”ë¡œ Step 3ë¡œ ì´ë™
  };

  const handleSubmit = async () => {
    // Validation
    if (!title.trim()) {
      alert('ì±Œë¦°ì§€ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    if (rules.goal_value <= 0) {
      alert('ëª©í‘œ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    if (!startDate || !endDate) {
      alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    setLoading(true);
    try {
      const dto: CreateChallengeDTO = {
        club_id: clubId,
        title: title.trim(),
        description: description.trim() || undefined,
        rules,
        start_date: startDate,
        end_date: endDate,
        theme_color: themeColor,
      };

      await clubStorage.createChallenge(dto);
      alert('ì±Œë¦°ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
      onSuccess();
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ì±Œë¦°ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div
      style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0, 0, 0, 0.7)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000,
        padding: '20px',
      }}
      onClick={onClose}
    >
      <div
        style={{
          background: 'var(--card-bg)',
          borderRadius: '16px',
          maxWidth: '900px',
          width: '100%',
          maxHeight: '90vh',
          overflow: 'auto',
          display: 'flex',
          flexDirection: 'column',
        }}
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div
          style={{
            padding: '24px',
            borderBottom: '1px solid var(--border-color)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
          }}
        >
          <div>
            <h2 style={{ fontSize: '24px', fontWeight: '700', marginBottom: '8px' }}>
              ğŸ¯ Quest Builder
            </h2>
            <div style={{ display: 'flex', gap: '12px', fontSize: '14px' }}>
              <span style={{ color: step === 1 ? 'var(--primary-color)' : 'var(--text-secondary)' }}>
                1. í…Œë§ˆ ì„ íƒ
              </span>
              <span style={{ color: step === 2 ? 'var(--primary-color)' : 'var(--text-secondary)' }}>
                2. ê·œì¹™ ì„¤ì •
              </span>
              <span style={{ color: step === 3 ? 'var(--primary-color)' : 'var(--text-secondary)' }}>
                3. ê¾¸ë¯¸ê¸°
              </span>
            </div>
          </div>
          <button
            onClick={onClose}
            style={{
              fontSize: '24px',
              background: 'none',
              border: 'none',
              cursor: 'pointer',
              color: 'var(--text-secondary)',
            }}
          >
            Ã—
          </button>
        </div>

        {/* Body */}
        <div style={{ flex: 1, padding: '24px', overflow: 'auto' }}>
          {step === 1 && (
            <Step1ThemeSelect
              selectedTheme={theme}
              onSelectTheme={(t) => {
                setTheme(t);
                setStep(2);
              }}
              onApplyTemplate={applyTemplate}
            />
          )}

          {step === 2 && theme && (
            <Step2RulesConfig
              theme={theme}
              rules={rules}
              onUpdateRules={setRules}
              onNext={() => setStep(3)}
              onBack={() => setStep(1)}
            />
          )}

          {step === 3 && (
            <Step3MetaData
              title={title}
              description={description}
              startDate={startDate}
              endDate={endDate}
              themeColor={themeColor}
              rules={rules}
              onUpdateTitle={setTitle}
              onUpdateDescription={setDescription}
              onUpdateStartDate={setStartDate}
              onUpdateEndDate={setEndDate}
              onUpdateThemeColor={setThemeColor}
              onBack={() => setStep(2)}
              onSubmit={handleSubmit}
              loading={loading}
            />
          )}
        </div>
      </div>
    </div>
  );
};

// ============================================
// Step 1: Theme Selection
// ============================================

interface Step1Props {
  selectedTheme: QuestTheme | null;
  onSelectTheme: (theme: QuestTheme) => void;
  onApplyTemplate: (template: ChallengeTemplate) => void;
}

const Step1ThemeSelect = ({ selectedTheme, onSelectTheme, onApplyTemplate }: Step1Props) => {
  const themes: Array<{ id: QuestTheme; name: string; emoji: string; color: string; desc: string }> = [
    { id: 'strength', name: 'ê·¼ë ¥', emoji: 'ğŸ’ª', color: '#ef4444', desc: 'ë” ë¬´ê²ê²Œ!' },
    { id: 'endurance', name: 'ì§€êµ¬ë ¥', emoji: 'ğŸƒ', color: '#3b82f6', desc: 'ë” ë©€ë¦¬, ë” ì˜¤ë˜!' },
    { id: 'skill', name: 'ê¸°ìˆ /íšŸìˆ˜', emoji: 'ğŸ‚', color: '#8b5cf6', desc: 'ë” ë§ì´!' },
    { id: 'consistency', name: 'ê¾¸ì¤€í•¨', emoji: 'ğŸ“…', color: '#eab308', desc: 'ë¹ ì§€ì§€ ì•Šê³ !' },
  ];

  return (
    <div>
      <h3 style={{ fontSize: '20px', fontWeight: '700', marginBottom: '8px' }}>
        ë¬´ì—‡ìœ¼ë¡œ ìŠ¹ë¶€í• ê¹Œìš”?
      </h3>
      <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '24px' }}>
        ì±Œë¦°ì§€ í…Œë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš”. ë˜ëŠ” ì•„ë˜ ì¸ê¸° í…œí”Œë¦¿ì„ ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>

      {/* Theme Cards */}
      <div
        style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
          gap: '16px',
          marginBottom: '32px',
        }}
      >
        {themes.map((t) => (
          <div
            key={t.id}
            onClick={() => onSelectTheme(t.id)}
            style={{
              background: selectedTheme === t.id ? `${t.color}22` : 'var(--input-bg)',
              border: `2px solid ${selectedTheme === t.id ? t.color : 'var(--border-color)'}`,
              borderRadius: '12px',
              padding: '20px',
              cursor: 'pointer',
              textAlign: 'center',
              transition: 'all 0.2s',
            }}
          >
            <div style={{ fontSize: '48px', marginBottom: '12px' }}>{t.emoji}</div>
            <div style={{ fontSize: '18px', fontWeight: '700', marginBottom: '4px' }}>{t.name}</div>
            <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>{t.desc}</div>
          </div>
        ))}
      </div>

      {/* Template Quick Apply */}
      <div style={{ marginTop: '32px' }}>
        <h4 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '16px' }}>
          âš¡ ì¸ê¸° í…œí”Œë¦¿ (ë°”ë¡œ ì ìš©)
        </h4>
        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
          {CHALLENGE_TEMPLATES.map((template) => (
            <div
              key={template.id}
              onClick={() => onApplyTemplate(template)}
              style={{
                background: 'var(--input-bg)',
                border: '1px solid var(--border-color)',
                borderRadius: '8px',
                padding: '16px',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '16px',
                transition: 'all 0.2s',
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.borderColor = 'var(--primary-color)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.borderColor = 'var(--border-color)';
              }}
            >
              <div style={{ fontSize: '32px' }}>{template.emoji}</div>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: '16px', fontWeight: '600', marginBottom: '4px' }}>
                  {template.name}
                </div>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                  {template.description}
                </div>
              </div>
              <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                ê¶Œì¥ {template.recommended_duration_days}ì¼
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

// ============================================
// Step 2: Rules Configuration
// ============================================

interface Step2Props {
  theme: QuestTheme;
  rules: ChallengeRules;
  onUpdateRules: (rules: ChallengeRules) => void;
  onNext: () => void;
  onBack: () => void;
}

const Step2RulesConfig = ({ theme, rules, onUpdateRules, onNext, onBack }: Step2Props) => {
  const updateFilter = (key: keyof ChallengeRules['filter'], value: any) => {
    onUpdateRules({
      ...rules,
      filter: { ...rules.filter, [key]: value },
    });
  };

  const getMetricOptions = (): Array<{ value: MetricType; label: string; unit: string }> => {
    switch (theme) {
      case 'strength':
        return [{ value: 'volume_kg', label: 'ë³¼ë¥¨ (ë¬´ê²Œ Ã— ì„¸íŠ¸ Ã— íšŸìˆ˜)', unit: 'kg' }];
      case 'endurance':
        return [
          { value: 'adjusted_dist_km', label: 'ê±°ë¦¬ (í‰ì§€ í™˜ì‚°)', unit: 'km' },
          { value: 'duration_min', label: 'ì‹œê°„', unit: 'ë¶„' },
        ];
      case 'skill':
        return [
          { value: 'run_count', label: 'ëŸ° ìˆ˜ / ì‹œë„ íšŸìˆ˜', unit: 'íšŒ' },
          { value: 'workout_count', label: 'ìš´ë™ íšŸìˆ˜', unit: 'íšŒ' },
        ];
      case 'consistency':
        return [{ value: 'attendance_days', label: 'ì¶œì„ ì¼ìˆ˜', unit: 'ì¼' }];
    }
  };

  const categoryOptions: Array<{ value: WorkoutCategory; label: string; emoji: string }> = [
    { value: 'gym', label: 'í—¬ìŠ¤ì¥', emoji: 'ğŸ‹ï¸' },
    { value: 'running', label: 'ëŸ¬ë‹', emoji: 'ğŸƒ' },
    { value: 'snowboard', label: 'ìŠ¤ë…¸ë³´ë“œ', emoji: 'ğŸ‚' },
    { value: 'sports', label: 'êµ¬ê¸°/ë¼ì¼“', emoji: 'âš½' },
    { value: 'home', label: 'í™ˆíŠ¸', emoji: 'ğŸ ' },
    { value: 'other', label: 'ê¸°íƒ€', emoji: 'ğŸ’ª' },
  ];

  const typeOptions: Array<{ value: WorkoutType; label: string }> = [
    { value: 'strength', label: 'ê·¼ë ¥' },
    { value: 'cardio', label: 'ìœ ì‚°ì†Œ' },
    { value: 'skill', label: 'ê¸°ìˆ ' },
    { value: 'flexibility', label: 'ìœ ì—°ì„±' },
  ];

  const selectedMetric = getMetricOptions().find((m) => m.value === rules.target_metric) || getMetricOptions()[0];

  const handleMetricChange = (metric: MetricType) => {
    const option = getMetricOptions().find((m) => m.value === metric);
    onUpdateRules({
      ...rules,
      target_metric: metric,
      unit: option?.unit || '',
    });
  };

  const referenceGuides = REFERENCE_GUIDES[rules.target_metric] || [];

  return (
    <div>
      <h3 style={{ fontSize: '20px', fontWeight: '700', marginBottom: '24px' }}>
        ìƒì„¸ ê·œì¹™ ì„¤ì •
      </h3>

      {/* Metric Type */}
      <div style={{ marginBottom: '24px' }}>
        <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
          ì¶”ì  ì§€í‘œ *
        </label>
        <select
          value={rules.target_metric}
          onChange={(e) => handleMetricChange(e.target.value as MetricType)}
          style={{
            width: '100%',
            padding: '12px',
            fontSize: '16px',
            border: '1px solid var(--border-color)',
            borderRadius: '8px',
            background: 'var(--input-bg)',
          }}
        >
          {getMetricOptions().map((opt) => (
            <option key={opt.value} value={opt.value}>
              {opt.label}
            </option>
          ))}
        </select>
      </div>

      {/* Category Filter */}
      <div style={{ marginBottom: '24px' }}>
        <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
          ì¢…ëª© í•„í„° (ì„ íƒ ì•ˆí•˜ë©´ ì „ì²´)
        </label>
        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
          {categoryOptions.map((cat) => {
            const isSelected = rules.filter.category?.includes(cat.value);
            return (
              <div
                key={cat.value}
                onClick={() => {
                  const current = rules.filter.category || [];
                  const updated = isSelected
                    ? current.filter((c) => c !== cat.value)
                    : [...current, cat.value];
                  updateFilter('category', updated.length > 0 ? updated : undefined);
                }}
                style={{
                  padding: '8px 16px',
                  border: `2px solid ${isSelected ? 'var(--primary-color)' : 'var(--border-color)'}`,
                  borderRadius: '20px',
                  cursor: 'pointer',
                  background: isSelected ? 'var(--primary-color)22' : 'transparent',
                  fontSize: '14px',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px',
                  transition: 'all 0.2s',
                }}
              >
                <span>{cat.emoji}</span>
                <span>{cat.label}</span>
              </div>
            );
          })}
        </div>
      </div>

      {/* Type Filter */}
      {rules.target_metric !== 'attendance_days' && (
        <div style={{ marginBottom: '24px' }}>
          <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
            ìš´ë™ íƒ€ì… í•„í„° (ì„ íƒ ì•ˆí•˜ë©´ ì „ì²´)
          </label>
          <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
            {typeOptions.map((type) => {
              const isSelected = rules.filter.type?.includes(type.value);
              return (
                <div
                  key={type.value}
                  onClick={() => {
                    const current = rules.filter.type || [];
                    const updated = isSelected
                      ? current.filter((t) => t !== type.value)
                      : [...current, type.value];
                    updateFilter('type', updated.length > 0 ? updated : undefined);
                  }}
                  style={{
                    padding: '8px 16px',
                    border: `2px solid ${isSelected ? 'var(--primary-color)' : 'var(--border-color)'}`,
                    borderRadius: '20px',
                    cursor: 'pointer',
                    background: isSelected ? 'var(--primary-color)22' : 'transparent',
                    fontSize: '14px',
                    fontWeight: '600',
                    transition: 'all 0.2s',
                  }}
                >
                  {type.label}
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Keyword Filter */}
      {rules.target_metric !== 'attendance_days' && (
        <div style={{ marginBottom: '24px' }}>
          <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
            í‚¤ì›Œë“œ í•„í„° (ê³ ê¸‰) - ìš´ë™ ì´ë¦„ì— í¬í•¨ë˜ì–´ì•¼ í•˜ëŠ” ë‹¨ì–´
          </label>
          <input
            type="text"
            placeholder="ì˜ˆ: squat, ìŠ¤ì¿¼íŠ¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)"
            value={rules.filter.keyword_include?.join(', ') || ''}
            onChange={(e) => {
              const keywords = e.target.value
                .split(',')
                .map((k) => k.trim())
                .filter(Boolean);
              updateFilter('keyword_include', keywords.length > 0 ? keywords : undefined);
            }}
            style={{
              width: '100%',
              padding: '12px',
              fontSize: '14px',
              border: '1px solid var(--border-color)',
              borderRadius: '8px',
              background: 'var(--input-bg)',
            }}
          />
        </div>
      )}

      {/* Goal Value */}
      <div style={{ marginBottom: '24px' }}>
        <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
          ëª©í‘œ ìˆ˜ì¹˜ *
        </label>
        <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>
          <div style={{ flex: 1 }}>
            <input
              type="number"
              value={rules.goal_value || ''}
              onChange={(e) => onUpdateRules({ ...rules, goal_value: Number(e.target.value) })}
              placeholder="ëª©í‘œ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”"
              min="1"
              style={{
                width: '100%',
                padding: '12px',
                fontSize: '16px',
                border: '1px solid var(--border-color)',
                borderRadius: '8px',
                background: 'var(--input-bg)',
              }}
            />
          </div>
          <div
            style={{
              padding: '12px 16px',
              background: 'var(--input-bg)',
              border: '1px solid var(--border-color)',
              borderRadius: '8px',
              fontSize: '16px',
              fontWeight: '600',
              minWidth: '60px',
              textAlign: 'center',
            }}
          >
            {selectedMetric.unit}
          </div>
        </div>

        {/* Reference Guide */}
        {rules.goal_value > 0 && referenceGuides.length > 0 && (
          <div style={{ marginTop: '12px', fontSize: '13px', color: 'var(--text-secondary)' }}>
            <div style={{ marginBottom: '8px', fontWeight: '600' }}>ğŸ’¡ ì°¸ê³ :</div>
            {referenceGuides.map((guide) => (
              <div
                key={guide.value}
                style={{
                  padding: '8px 12px',
                  background: 'var(--input-bg)',
                  borderRadius: '6px',
                  marginBottom: '6px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                }}
              >
                <span style={{ fontSize: '16px' }}>{guide.emoji}</span>
                <span>
                  {guide.value.toLocaleString()} {selectedMetric.unit} = {guide.description}
                </span>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Navigation */}
      <div style={{ display: 'flex', gap: '12px', marginTop: '32px' }}>
        <button className="cancel-button" onClick={onBack} style={{ flex: 1 }}>
          â† ì´ì „
        </button>
        <button
          className="primary-button"
          onClick={onNext}
          disabled={rules.goal_value <= 0}
          style={{ flex: 1 }}
        >
          ë‹¤ìŒ â†’
        </button>
      </div>
    </div>
  );
};

// ============================================
// Step 3: Meta Data & Preview
// ============================================

interface Step3Props {
  title: string;
  description: string;
  startDate: string;
  endDate: string;
  themeColor: string;
  rules: ChallengeRules;
  onUpdateTitle: (title: string) => void;
  onUpdateDescription: (desc: string) => void;
  onUpdateStartDate: (date: string) => void;
  onUpdateEndDate: (date: string) => void;
  onUpdateThemeColor: (color: string) => void;
  onBack: () => void;
  onSubmit: () => void;
  loading: boolean;
}

const Step3MetaData = ({
  title,
  description,
  startDate,
  endDate,
  themeColor,
  rules,
  onUpdateTitle,
  onUpdateDescription,
  onUpdateStartDate,
  onUpdateEndDate,
  onUpdateThemeColor,
  onBack,
  onSubmit,
  loading,
}: Step3Props) => {
  const themeColors = [
    { value: '#ef4444', label: 'Fire' },
    { value: '#3b82f6', label: 'Ocean' },
    { value: '#8b5cf6', label: 'Purple' },
    { value: '#eab308', label: 'Gold' },
    { value: '#10b981', label: 'Forest' },
    { value: '#1e293b', label: 'Dark' },
  ];

  return (
    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
      {/* Left: Form */}
      <div>
        <h3 style={{ fontSize: '20px', fontWeight: '700', marginBottom: '24px' }}>
          ì±Œë¦°ì§€ ê¾¸ë¯¸ê¸°
        </h3>

        {/* Title */}
        <div style={{ marginBottom: '20px' }}>
          <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
            ì œëª© *
          </label>
          <input
            type="text"
            value={title}
            onChange={(e) => onUpdateTitle(e.target.value)}
            placeholder="ì˜ˆ: ìŠ¤ì¿¼íŠ¸ 100í†¤ ì±Œë¦°ì§€"
            maxLength={50}
            style={{
              width: '100%',
              padding: '12px',
              fontSize: '16px',
              border: '1px solid var(--border-color)',
              borderRadius: '8px',
              background: 'var(--input-bg)',
            }}
          />
        </div>

        {/* Description */}
        <div style={{ marginBottom: '20px' }}>
          <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
            ì„¤ëª…
          </label>
          <textarea
            value={description}
            onChange={(e) => onUpdateDescription(e.target.value)}
            placeholder="ì°¸ì—¬ ë…ë ¤ ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”"
            rows={3}
            maxLength={200}
            style={{
              width: '100%',
              padding: '12px',
              fontSize: '14px',
              border: '1px solid var(--border-color)',
              borderRadius: '8px',
              background: 'var(--input-bg)',
              resize: 'vertical',
            }}
          />
        </div>

        {/* Dates */}
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '20px' }}>
          <div>
            <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
              ì‹œì‘ì¼ *
            </label>
            <input
              type="date"
              value={startDate}
              onChange={(e) => onUpdateStartDate(e.target.value)}
              style={{
                width: '100%',
                padding: '12px',
                fontSize: '14px',
                border: '1px solid var(--border-color)',
                borderRadius: '8px',
                background: 'var(--input-bg)',
              }}
            />
          </div>
          <div>
            <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
              ì¢…ë£Œì¼ *
            </label>
            <input
              type="date"
              value={endDate}
              onChange={(e) => onUpdateEndDate(e.target.value)}
              style={{
                width: '100%',
                padding: '12px',
                fontSize: '14px',
                border: '1px solid var(--border-color)',
                borderRadius: '8px',
                background: 'var(--input-bg)',
              }}
            />
          </div>
        </div>

        {/* Theme Color */}
        <div style={{ marginBottom: '20px' }}>
          <label style={{ fontSize: '14px', fontWeight: '600', marginBottom: '8px', display: 'block' }}>
            í…Œë§ˆ ìƒ‰ìƒ
          </label>
          <div style={{ display: 'flex', gap: '8px' }}>
            {themeColors.map((color) => (
              <div
                key={color.value}
                onClick={() => onUpdateThemeColor(color.value)}
                style={{
                  width: '48px',
                  height: '48px',
                  borderRadius: '8px',
                  background: color.value,
                  cursor: 'pointer',
                  border: themeColor === color.value ? '3px solid white' : '2px solid var(--border-color)',
                  boxShadow: themeColor === color.value ? '0 0 0 2px var(--primary-color)' : 'none',
                  transition: 'all 0.2s',
                }}
                title={color.label}
              />
            ))}
          </div>
        </div>

        {/* Navigation */}
        <div style={{ display: 'flex', gap: '12px', marginTop: '32px' }}>
          <button className="cancel-button" onClick={onBack} style={{ flex: 1 }}>
            â† ì´ì „
          </button>
          <button
            className="primary-button"
            onClick={onSubmit}
            disabled={loading || !title.trim() || !startDate || !endDate}
            style={{ flex: 1 }}
          >
            {loading ? 'ìƒì„± ì¤‘...' : 'ì±Œë¦°ì§€ ë§Œë“¤ê¸° ğŸ¯'}
          </button>
        </div>
      </div>

      {/* Right: Live Preview */}
      <div>
        <h3 style={{ fontSize: '20px', fontWeight: '700', marginBottom: '24px' }}>
          ë¯¸ë¦¬ë³´ê¸°
        </h3>
        <ChallengeCardPreview
          title={title || 'ì±Œë¦°ì§€ ì œëª©'}
          description={description || 'ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'}
          rules={rules}
          startDate={startDate}
          endDate={endDate}
          themeColor={themeColor}
        />
      </div>
    </div>
  );
};

// ============================================
// Challenge Card Preview
// ============================================

interface PreviewProps {
  title: string;
  description: string;
  rules: ChallengeRules;
  startDate: string;
  endDate: string;
  themeColor: string;
}

const ChallengeCardPreview = ({
  title,
  description,
  rules,
  startDate,
  endDate,
  themeColor,
}: PreviewProps) => {
  const currentValue = Math.floor(rules.goal_value * 0.35); // ì„ì‹œ ì§„í–‰ë„ 35%
  const progress = (currentValue / rules.goal_value) * 100;

  return (
    <div
      style={{
        background: `linear-gradient(135deg, ${themeColor}22 0%, ${themeColor}11 100%)`,
        border: `2px solid ${themeColor}66`,
        borderRadius: '12px',
        padding: '20px',
        position: 'relative',
        overflow: 'hidden',
      }}
    >
      {/* Title */}
      <h4 style={{ fontSize: '18px', fontWeight: '700', marginBottom: '8px' }}>{title}</h4>
      {description && (
        <p style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '16px' }}>
          {description}
        </p>
      )}

      {/* Progress Bar */}
      <div
        style={{
          width: '100%',
          height: '28px',
          background: 'rgba(0, 0, 0, 0.2)',
          borderRadius: '14px',
          overflow: 'hidden',
          marginBottom: '12px',
        }}
      >
        <div
          style={{
            width: `${Math.min(progress, 100)}%`,
            height: '100%',
            background: themeColor,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'flex-end',
            paddingRight: '12px',
            fontSize: '12px',
            fontWeight: '700',
            color: 'white',
          }}
        >
          {progress.toFixed(0)}%
        </div>
      </div>

      {/* Stats */}
      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px' }}>
        <div>
          <span style={{ fontSize: '20px', fontWeight: '700', color: themeColor }}>
            {currentValue.toLocaleString()}
          </span>
          <span style={{ color: 'var(--text-secondary)' }}> / {rules.goal_value.toLocaleString()}</span>
          <span style={{ marginLeft: '6px', fontSize: '14px', color: 'var(--text-secondary)' }}>
            {rules.unit}
          </span>
        </div>
      </div>

      {/* Date */}
      {startDate && endDate && (
        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
          {startDate} ~ {endDate}
        </div>
      )}

      {/* Rules Summary */}
      <div
        style={{
          marginTop: '16px',
          padding: '12px',
          background: 'rgba(0, 0, 0, 0.1)',
          borderRadius: '8px',
          fontSize: '12px',
        }}
      >
        <div style={{ fontWeight: '600', marginBottom: '6px' }}>ğŸ“‹ ê·œì¹™:</div>
        <div style={{ color: 'var(--text-secondary)' }}>
          {rules.filter.category && rules.filter.category.length > 0 && (
            <div>â€¢ ì¢…ëª©: {rules.filter.category.join(', ')}</div>
          )}
          {rules.filter.type && rules.filter.type.length > 0 && (
            <div>â€¢ íƒ€ì…: {rules.filter.type.join(', ')}</div>
          )}
          {rules.filter.keyword_include && rules.filter.keyword_include.length > 0 && (
            <div>â€¢ í‚¤ì›Œë“œ: {rules.filter.keyword_include.join(', ')}</div>
          )}
          {!rules.filter.category && !rules.filter.type && !rules.filter.keyword_include && (
            <div>â€¢ ëª¨ë“  ìš´ë™ ì¸ì •</div>
          )}
        </div>
      </div>
    </div>
  );
};

// Helper: Get theme color by quest theme
const getThemeColor = (theme: QuestTheme): string => {
  switch (theme) {
    case 'strength':
      return '#ef4444';
    case 'endurance':
      return '#3b82f6';
    case 'skill':
      return '#8b5cf6';
    case 'consistency':
      return '#eab308';
  }
};
</file>

<file path="src/components/Header.tsx">
import { useState, useRef, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';

export const Header = () => {
  const { user, logout } = useAuth();
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsDropdownOpen(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleLogout = () => {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      logout();
    }
  };

  if (!user) return null;

  const getInitials = (name: string) => {
    return name
      .split(' ')
      .map((n) => n[0])
      .join('')
      .toUpperCase()
      .substring(0, 2);
  };

  return (
    <header className="app-header">
      <div className="header-content">
        <div className="header-logo">
          <h1>ğŸ’ª Workout Log</h1>
          
        </div>

        <div className="header-profile" ref={dropdownRef}>
          <button
            className="profile-button"
            onClick={() => setIsDropdownOpen(!isDropdownOpen)}
          >
            <div className="profile-avatar">
              {getInitials(user.display_name || user.username)}
            </div>
            <span className="profile-name">{user.display_name || user.username}</span>
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="currentColor"
              className={`dropdown-arrow ${isDropdownOpen ? 'open' : ''}`}
            >
              <path d="M7 10l5 5 5-5z" />
            </svg>
          </button>

          {isDropdownOpen && (
            <div className="profile-dropdown">
              <div className="dropdown-header">
                <div className="dropdown-user-info">
                  <div className="dropdown-avatar">
                    {getInitials(user.display_name || user.username)}
                  </div>
                  <div className="dropdown-user-details">
                    <div className="dropdown-name">{user.display_name || user.username}</div>
                    {user.email && <div className="dropdown-email">{user.email}</div>}
                  </div>
                </div>
              </div>

              <div className="dropdown-divider"></div>

              <button className="dropdown-item" onClick={handleLogout}>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
                </svg>
                ë¡œê·¸ì•„ì›ƒ
              </button>
            </div>
          )}
        </div>
      </div>
    </header>
  );
};
</file>

<file path="src/features/normalize/normalizeText.ts">
interface NormalizationRule {
  pattern: RegExp;
  replacement: string;
}

const normalizationRules: NormalizationRule[] = [
  // ìŠ¤í¬ì¸  í™œë™
  { pattern: /ìŠ¤ë…¸ìš°\s*ë³´ë“œ|ìŠ¤ë…¸\s*ë³´ë”©|ë³´ë“œ\s*íƒ€ê¸°|ë³´ë”©/g, replacement: 'ìŠ¤ë…¸ë³´ë“œ' },

  // ìœ ì‚°ì†Œ ìš´ë™
  { pattern: /ëŸ°ë‹|ëŸ¬ë‹|ì¡°ê¹…/g, replacement: 'ë‹¬ë¦¬ê¸°' },
  { pattern: /ì‚¬ì´í´|ìì „ê±°/g, replacement: 'ì‚¬ì´í´' },
  { pattern: /ë¡œì‰|ë¡œìš°ì‰/g, replacement: 'ë¡œì‰' },

  // ì›¨ì´íŠ¸ íŠ¸ë ˆì´ë‹
  { pattern: /ì‚¬ë ˆë ˆ|ì‚¬ë¡€ë¥¼|ì‚¬ë ˆ/g, replacement: 'ì‚¬ì´ë“œ ë ˆí„°ëŸ´ ë ˆì´ì¦ˆ' },
  { pattern: /ë°ë“œ\s*ë²„ê·¸|ë°ë“œë¶/g, replacement: 'ë°ë“œë²„ê·¸' },
  { pattern: /ì²œêµ­ì˜\s*ê³„ë‹¨/g, replacement: 'ìŠ¤í…ë°€' },
  { pattern: /ë«\s*í’€ë‹¤ìš´|ë«í’€/g, replacement: 'ë«í’€ë‹¤ìš´' },
  { pattern: /í‘¸ì‰¬ì—…|íŒ”êµ½í˜€/g, replacement: 'í‘¸ì‹œì—…' },
  { pattern: /í”Œë­í¬/g, replacement: 'í”Œë­í¬' },
  { pattern: /ì‚¬ì´ë“œ\s*í”Œë­í¬|ì‚¬í”Œ/g, replacement: 'ì‚¬ì´ë“œí”Œë­í¬' },
  { pattern: /ì¹´í”„(\s*ë ˆì´ì¦ˆ)?/g, replacement: 'ì¹´í”„ë ˆì´ì¦ˆ' },
  { pattern: /ë¡œìš°/g, replacement: 'ë¡œìš°' },

  // ê°•ë„/ìŠ¤íƒ€ì¼ í‘œí˜„ ì •ê·œí™”
  { pattern: /ë¹¡ì„¸ê²Œ|í•˜ë“œí•˜ê²Œ|ë¹¡ì‹œê²Œ/g, replacement: 'ë¹¡ì„¸ê²Œ' },
  { pattern: /ê°€ë³ê²Œ|ë¼ì´íŠ¸í•˜ê²Œ|ì—¬ìœ ë¡­ê²Œ/g, replacement: 'ê°€ë³ê²Œ' },
];

export const normalizeText = (text: string): string => {
  let normalized = text.trim();

  for (const rule of normalizationRules) {
    normalized = normalized.replace(rule.pattern, rule.replacement);
  }

  return normalized;
};

export const getKnownExercises = (): string[] => {
  return [
    // ìŠ¤í¬ì¸  í™œë™
    'ìŠ¤ë…¸ë³´ë“œ',

    // ìœ ì‚°ì†Œ ìš´ë™
    'ë‹¬ë¦¬ê¸°',
    'ì‚¬ì´í´',
    'ë¡œì‰',

    // ê·¼ë ¥ ìš´ë™
    'ì‚¬ì´ë“œ ë ˆí„°ëŸ´ ë ˆì´ì¦ˆ',
    'ë°ë“œë²„ê·¸',
    'ìŠ¤í…ë°€',
    'ë«í’€ë‹¤ìš´',
    'í‘¸ì‹œì—…',
    'í”Œë­í¬',
    'ì‚¬ì´ë“œí”Œë­í¬',
    'ì¹´í”„ë ˆì´ì¦ˆ',
    'ë¡œìš°',
    'ë²¤ì¹˜í”„ë ˆìŠ¤',
    'ìŠ¤ì¿¼íŠ¸',
    'ë°ë“œë¦¬í”„íŠ¸',
    'í’€ì—…',
    'ì¹œì—…',
    'ë¤ë²¨ì»¬',
    'íŠ¸ë¼ì´ì…‰ìŠ¤',
    'ë ˆê·¸í”„ë ˆìŠ¤',
    'ë ˆê·¸ì»¬',
    'ë ˆê·¸ìµìŠ¤í…ì…˜',
    'ìˆ„ë”í”„ë ˆìŠ¤',

    // ìœ ì‚°ì†Œ/ê¸°ëŠ¥ì„± ìš´ë™
    'ë²„í”¼',
    'ë§ˆìš´í‹´í´ë¼ì´ë¨¸',
    'ì í•‘ì­',
  ];
};
</file>

<file path="src/pages/TodoList.tsx">
import { useState, useEffect } from 'react';
import { getTodayTodo, saveTodo, generateId, formatDate } from '../storage/logStorage';
import type { DailyTodo, TodoWorkout, RecordingState } from '../types';
import { useSpeechRecognition } from '../features/speech/useSpeechRecognition';
import { useWhisperRecording } from '../features/speech/useWhisperRecording';
import { parseWorkoutText } from '../features/parse/parseWorkoutText';
import { parseWithGPT } from '../features/parse/parseWithGPT';
import { normalizeText } from '../features/normalize/normalizeText';

type AddMode = 'web-speech' | 'ai';

export const TodoList = () => {
  const [todo, setTodo] = useState<DailyTodo | null>(null);
  const [isAdding, setIsAdding] = useState(false);
  const [addMode, setAddMode] = useState<AddMode>('web-speech');
  const [recordingState, setRecordingState] = useState<RecordingState>('idle');
  const [isRecommendationExpanded, setIsRecommendationExpanded] = useState(false);

  const webSpeech = useSpeechRecognition();
  const whisper = useWhisperRecording();

  useEffect(() => {
    loadTodo();
  }, []);

  const loadTodo = () => {
    const todayTodo = getTodayTodo();
    setTodo(todayTodo);
  };

  const toggleWorkoutComplete = (index: number) => {
    if (!todo) return;

    const updatedWorkouts = [...todo.workouts];
    updatedWorkouts[index] = {
      ...updatedWorkouts[index],
      completed: !updatedWorkouts[index].completed,
    };

    const updatedTodo: DailyTodo = {
      ...todo,
      workouts: updatedWorkouts,
    };

    saveTodo(updatedTodo);
    setTodo(updatedTodo);
  };

  const handleMicClick = async () => {
    console.log('[TodoList] handleMicClick - State:', recordingState, 'Mode:', addMode);

    if (recordingState === 'idle') {
      webSpeech.resetTranscript();
      setRecordingState('listening');

      if (addMode === 'web-speech') {
        webSpeech.startListening();
      } else {
        webSpeech.startListening();
        await whisper.startRecording();
      }
    } else if (recordingState === 'listening') {
      setRecordingState('transcribing');

      if (addMode === 'web-speech') {
        webSpeech.stopListening();
        setTimeout(() => {
          const finalText = webSpeech.transcript.trim();
          console.log('[TodoList] Web Speech final text:', finalText);
          handleParse(finalText, false);
        }, 500);
      } else {
        webSpeech.stopListening();
        const whisperResult = await whisper.stopRecording();
        console.log('[TodoList] Whisper final text:', whisperResult);
        handleParse(whisperResult, true);
      }
    }
  };

  const handleParse = async (text: string, useAI: boolean) => {
    console.log('[TodoList] handleParse - useAI:', useAI, 'text:', text);
    setRecordingState('parsing');

    try {
      let newWorkouts: TodoWorkout[] = [];

      if (useAI) {
        console.log('[TodoList] Using AI mode (GPT parsing)');
        const parsed = await parseWithGPT(text);
        newWorkouts = parsed.map((w) => ({
          name: w.name,
          sets: w.sets || undefined,
          reps: w.reps || undefined,
          weight_kg: w.weight_kg || undefined,
          duration_min: w.duration_min || undefined,
          distance_km: w.distance_km || undefined,
          pace: w.pace || undefined,
          note: w.note || undefined,
          completed: false,
        }));
      } else {
        console.log('[TodoList] Using rule-based parsing');
        setTimeout(() => {
          const normalized = normalizeText(text);
          console.log('[TodoList] Normalized text:', normalized);
          const parsed = parseWorkoutText(normalized);
          console.log('[TodoList] Rule-based parsing result:', parsed);

          newWorkouts = parsed.map((w) => ({
            name: w.name,
            sets: w.sets || undefined,
            reps: w.reps || undefined,
            weight_kg: w.weight_kg || undefined,
            duration_min: w.duration_min || undefined,
            distance_km: w.distance_km || undefined,
            pace: w.pace || undefined,
            note: w.note || undefined,
            completed: false,
          }));

          addWorkoutsToTodo(newWorkouts);
        }, 300);
        return;
      }

      addWorkoutsToTodo(newWorkouts);
    } catch (err) {
      console.error('[TodoList] Parsing error:', err);
      alert(`íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${err instanceof Error ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
      setRecordingState('idle');
    }
  };

  const addWorkoutsToTodo = (newWorkouts: TodoWorkout[]) => {
    const existingTodo = getTodayTodo();

    if (existingTodo) {
      // ê¸°ì¡´ Todoì— ì¶”ê°€
      const updatedTodo: DailyTodo = {
        ...existingTodo,
        workouts: [...existingTodo.workouts, ...newWorkouts],
      };
      saveTodo(updatedTodo);
      setTodo(updatedTodo);
    } else {
      // ìƒˆ Todo ìƒì„±
      const newTodo: DailyTodo = {
        id: generateId(),
        date: formatDate(),
        source: 'manual',
        workouts: newWorkouts,
        createdAt: Date.now(),
      };
      saveTodo(newTodo);
      setTodo(newTodo);
    }

    setRecordingState('idle');
    setIsAdding(false);
    alert(`${newWorkouts.length}ê°œì˜ ìš´ë™ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  };

  const handleCancelAdding = () => {
    if (recordingState === 'listening') {
      webSpeech.stopListening();
      if (addMode === 'ai') {
        whisper.stopRecording();
      }
    }
    setIsAdding(false);
    setRecordingState('idle');
    webSpeech.resetTranscript();
  };

  const formatDateDisplay = (dateStr: string) => {
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const weekday = weekdays[date.getDay()];
    return `${month}ì›” ${day}ì¼ (${weekday})`;
  };

  const completedCount = todo?.workouts.filter((w) => w.completed).length || 0;
  const totalCount = todo?.workouts.length || 0;
  const progress = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

  // Adding Mode
  if (isAdding) {
    return (
      <div className="container">
        <div className="header">
          <h1>Todo ì¶”ê°€</h1>
          <button className="cancel-button" onClick={handleCancelAdding}>
            ì·¨ì†Œ
          </button>
        </div>

        {recordingState === 'idle' && (
          <>
            <div className="mode-selector">
              <button
                className={`mode-button ${addMode === 'web-speech' ? 'active' : ''}`}
                onClick={() => setAddMode('web-speech')}
              >
                ê¸°ë³¸ (ë¬´ë£Œ)
              </button>
              <button
                className={`mode-button ${addMode === 'ai' ? 'active' : ''}`}
                onClick={() => setAddMode('ai')}
              >
                AI (ìœ ë£Œ)
              </button>
            </div>
            <div className="mode-description">
              {addMode === 'web-speech' ? (
                <p>ë¸Œë¼ìš°ì € ë‚´ì¥ ìŒì„± ì¸ì‹ + ë£° ê¸°ë°˜ íŒŒì‹±</p>
              ) : (
                <p>Whisper ìŒì„± ì¸ì‹ + GPT ìŠ¤ë§ˆíŠ¸ íŒŒì‹±</p>
              )}
            </div>
          </>
        )}

        {recordingState === 'idle' && (
          <div className="recording-section">
            <div className="status-text">ì¶”ê°€í•  ìš´ë™ì„ ë§ì”€í•´ì£¼ì„¸ìš”</div>
            <button className="mic-button" onClick={handleMicClick}>
              <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
              </svg>
            </button>
            <div className="hint-text">íƒ­í•˜ì—¬ ë…¹ìŒ ì‹œì‘</div>
          </div>
        )}

        {recordingState === 'listening' && (
          <div className="recording-section">
            <div className="status-text listening">
              {addMode === 'ai' ? 'ğŸ¤ AI ë…¹ìŒ ì¤‘...' : 'ë“£ëŠ” ì¤‘...'}
            </div>
            <button className="mic-button active" onClick={handleMicClick}>
              <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="6" width="12" height="12" />
              </svg>
            </button>
            <div className="hint-text">íƒ­í•˜ì—¬ ë…¹ìŒ ì¢…ë£Œ</div>

            {(webSpeech.transcript || webSpeech.interimTranscript) && (
              <div className="transcript-box">
                {addMode === 'ai' && (
                  <div className="ai-preview-label">
                    ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° (AIê°€ ë‹¤ì‹œ ì²˜ë¦¬í•©ë‹ˆë‹¤)
                  </div>
                )}
                <div className="transcript-final">{webSpeech.transcript}</div>
                {webSpeech.interimTranscript && (
                  <div className="transcript-interim">{webSpeech.interimTranscript}</div>
                )}
              </div>
            )}
          </div>
        )}

        {(recordingState === 'transcribing' || recordingState === 'parsing') && (
          <div className="recording-section">
            <div className="status-text">
              {recordingState === 'transcribing' ? 'í…ìŠ¤íŠ¸ ì²˜ë¦¬ ì¤‘...' : 'ìš´ë™ ê¸°ë¡ ë¶„ì„ ì¤‘...'}
            </div>
            <div className="spinner"></div>
          </div>
        )}
      </div>
    );
  }

  // Empty State
  if (!todo) {
    return (
      <div className="container">
        <div className="header">
          <h1>ì˜¤ëŠ˜ì˜ Todo</h1>
        </div>

        <div className="empty-state">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor" opacity="0.3">
            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
          </svg>
          <p>ì˜¤ëŠ˜ì˜ Todoê°€ ì—†ìŠµë‹ˆë‹¤</p>
          <p className="hint-text">ìŒì„±ìœ¼ë¡œ Todoë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ AI ì¶”ì²œì„ ë°›ìœ¼ì„¸ìš”</p>
          <button className="primary-button" onClick={() => setIsAdding(true)}>
            ìŒì„±ìœ¼ë¡œ Todo ì¶”ê°€
          </button>
        </div>
      </div>
    );
  }

  // Todo List View
  return (
    <div className="container">
      <div className="header">
        <h1>ì˜¤ëŠ˜ì˜ Todo</h1>
        <button className="add-todo-button" onClick={() => setIsAdding(true)}>
          + ì¶”ê°€
        </button>
      </div>

      <div className="todo-header-card">
        <div className="todo-date">{formatDateDisplay(todo.date)}</div>
        <div className="todo-progress-section">
          <div className="progress-bar-container">
            <div className="progress-bar" style={{ width: `${progress}%` }}></div>
          </div>
          <div className="progress-text">
            {completedCount} / {totalCount} ì™„ë£Œ
          </div>
        </div>
        {todo.source === 'ai_recommendation' && (
          <div className="todo-source-badge">AI ì¶”ì²œ</div>
        )}
      </div>

      {todo.aiRecommendation && (
        <div className="ai-recommendation-preview">
          <div className="recommendation-header" onClick={() => setIsRecommendationExpanded(!isRecommendationExpanded)}>
            <h3>AI ì¶”ì²œ ë©”ì‹œì§€</h3>
            <button className="expand-button">
              {isRecommendationExpanded ? 'ì ‘ê¸° â–²' : 'í¼ì¹˜ê¸° â–¼'}
            </button>
          </div>
          <div className={`ai-recommendation-text ${isRecommendationExpanded ? 'expanded' : 'collapsed'}`}>
            {(() => {
              const aiRec = todo.aiRecommendation as any; // Runtime check for backward compatibility

              // ìƒˆ í˜•ì‹ (ê°ì²´)
              if (aiRec && typeof aiRec === 'object' && 'finalRecommendation' in aiRec) {
                const recommendation = aiRec.finalRecommendation;
                if (isRecommendationExpanded) {
                  return (
                    <>
                      {recommendation}
                      {aiRec.userFeedback && (
                        <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid var(--border-color)', fontSize: '14px', color: 'var(--text-secondary)' }}>
                          <strong>ì‚¬ìš©ì í”¼ë“œë°±:</strong> {aiRec.userFeedback}
                        </div>
                      )}
                    </>
                  );
                } else {
                  return recommendation.split('\n').slice(0, 3).join('\n') + (recommendation.split('\n').length > 3 ? '...' : '');
                }
              }
              // êµ¬ í˜•ì‹ (ë¬¸ìì—´) - í•˜ìœ„ í˜¸í™˜ì„±
              else if (typeof aiRec === 'string') {
                return isRecommendationExpanded
                  ? aiRec
                  : aiRec.split('\n').slice(0, 3).join('\n') +
                    (aiRec.split('\n').length > 3 ? '...' : '');
              }
              return '';
            })()}
          </div>
        </div>
      )}

      <div className="todo-workout-list">
        <h3>ìš´ë™ ëª©ë¡</h3>
        {todo.workouts.map((workout, index) => (
          <div
            key={index}
            className={`todo-workout-item ${workout.completed ? 'completed' : ''}`}
            onClick={() => toggleWorkoutComplete(index)}
          >
            <div className="todo-checkbox">
              {workout.completed && (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                </svg>
              )}
            </div>
            <div className="todo-workout-info">
              <div className="todo-workout-name">{workout.name}</div>
              <div className="todo-workout-specs">
                {workout.distance_km && <span className="spec-distance">{workout.distance_km}km</span>}
                {workout.pace && <span className="spec-pace">{workout.pace}/km</span>}
                {workout.weight_kg && <span className="spec-weight">{workout.weight_kg}kg</span>}
                {workout.sets && workout.reps && (
                  <span>
                    {workout.sets}ì„¸íŠ¸ Ã— {workout.reps}íšŒ
                  </span>
                )}
                {!workout.sets && workout.reps && <span>{workout.reps}íšŒ</span>}
                {workout.duration_min && <span>{workout.duration_min}ë¶„</span>}
              </div>
              {workout.note && <div className="todo-workout-note">{workout.note}</div>}
            </div>
          </div>
        ))}
      </div>

      {completedCount === totalCount && totalCount > 0 && (
        <div className="todo-completion-message">
          <div className="completion-icon">ğŸ‰</div>
          <div className="completion-text">
            <h3>ì˜¤ëŠ˜ì˜ ìš´ë™ ì™„ë£Œ!</h3>
            <p>í›Œë¥­í•©ë‹ˆë‹¤! ëª¨ë“  ìš´ë™ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="src/utils/dashboardLogic.ts">
import type { WorkoutLog, WorkoutCategory } from '../types';

/**
 * í´ëŸ½ ëŒ€ì‹œë³´ë“œ ê³„ì‚° ë¡œì§
 * MMORPG ê¸¸ë“œ ë¡œë¹„ ìŠ¤íƒ€ì¼ì˜ ê²Œì´ë° UIë¥¼ ìœ„í•œ ìœ í‹¸ë¦¬í‹°
 */

// ============================================
// íƒ€ì´í‹€ ì‹œìŠ¤í…œ
// ============================================

export interface MemberTitle {
  userId: string;
  displayName: string;
  profileImage: string | null;
  title: string;
  icon: string;
  value: number | string;
  description: string;
}

// ============================================
// Hall of Fame Badge System (New)
// ============================================

export type BadgeType = 'strength' | 'cardio' | 'effort' | 'time' | 'consistency';

export interface HofBadge {
  userId: string;
  userName: string;
  userProfile: string | null;
  type: BadgeType; // ìŠ¤íƒ€ì¼ë§ìš©
  title: string; // ì˜ˆ: "3ëŒ€ 500 ê¿ˆë‚˜ë¬´"
  icon: string; // ì˜ˆ: "ğŸ‹ï¸"
  description: string; // ì˜ˆ: "ì´ ë³¼ë¥¨ 50,000kg ë‹¬ì„±"
  value: string; // í‘œì‹œìš© ê°’ (í¬ë§·íŒ…ëœ ë¬¸ìì—´)
  isMe: boolean; // ì •ë ¬ ìµœìš°ì„ ìˆœìœ„ í”Œë˜ê·¸
  badgeId: string; // ê³ ìœ  ID (userId + type)
}

/**
 * íƒ€ì´í‹€ ë¶€ì—¬ ë¡œì§ (Legacy)
 * @deprecated Use calculateHofBadges instead for carousel UI
 */
export const calculateTitles = (members: WorkoutLog[]): MemberTitle[] => {
  const titles: MemberTitle[] = [];

  // ğŸŒ… ìƒˆë²½ íŠ¸ë ˆì´ë„ˆ (04:00-07:00 ìµœì´ˆ ìš´ë™)
  const earlyBird = findEarlyBird(members);
  if (earlyBird) titles.push(earlyBird);

  // ğŸ‹ï¸ ë³¼ë¥¨ í‚¹ (ì´ ë³¼ë¥¨ 1ìœ„)
  const volumeKing = findVolumeKing(members);
  if (volumeKing) titles.push(volumeKing);

  // ğŸƒ ê±°ë¦¬ í‚¹ (ì´ ê±°ë¦¬ 1ìœ„)
  const distanceKing = findDistanceKing(members);
  if (distanceKing) titles.push(distanceKing);

  // ğŸ‚ ëŸ° í‚¹ (ì´ ëŸ° ìˆ˜ 1ìœ„)
  const runKing = findRunKing(members);
  if (runKing) titles.push(runKing);

  // âš¡ ì—°ì† ì¶œì„ (ì£¼ê°„ ìš´ë™ íšŸìˆ˜ ìµœë‹¤)
  const streakKing = findStreakKing(members);
  if (streakKing) titles.push(streakKing);

  return titles;
};

/**
 * Hall of Fame Badge Calculation (New Carousel System)
 *
 * 6ê°€ì§€ ë°°ì§€ë¥¼ ê³„ì‚°í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤:
 * - Workaholic: ì´ ìš´ë™ íšŸìˆ˜ 1ìœ„
 * - EarlyBird: 04-08ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„
 * - NightOwl: 22-03ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„
 * - VolumeKing: ì´ ë³¼ë¥¨(kg) 1ìœ„
 * - CardioKing: í™˜ì‚° ê±°ë¦¬(km) 1ìœ„
 * - SlopeMaster: ìŠ¤ë…¸ë³´ë“œ ëŸ° ìˆ˜ 1ìœ„
 *
 * @param members - í´ëŸ½ ë©¤ë²„ë“¤ì˜ ìš´ë™ ë¡œê·¸
 * @param currentUserId - í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ID (Me-first sortingìš©)
 */
export const calculateHofBadges = (
  members: WorkoutLog[],
  currentUserId?: string
): HofBadge[] => {
  // ì£¼ê°„ ë°ì´í„° í•„í„°ë§ (ìµœê·¼ 30ì¼) - í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ í™•ì¥
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const weeklyLogs = members.filter((log) => new Date(log.createdAt) >= thirtyDaysAgo);

  console.log('[calculateHofBadges] ì „ì²´ ë¡œê·¸:', members.length);
  console.log('[calculateHofBadges] 30ì¼ ì´ë‚´ ë¡œê·¸:', weeklyLogs.length);

  const badges: HofBadge[] = [];

  // 1. Workaholic: ì´ ìš´ë™ íšŸìˆ˜ 1ìœ„
  const workaholic = findWorkaholic(weeklyLogs, currentUserId);
  if (workaholic) badges.push(workaholic);

  // 2. EarlyBird: 04-08ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„
  const earlyBird = findEarlyBirdBadge(weeklyLogs, currentUserId);
  if (earlyBird) badges.push(earlyBird);

  // 3. NightOwl: 22-03ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„
  const nightOwl = findNightOwl(weeklyLogs, currentUserId);
  if (nightOwl) badges.push(nightOwl);

  // 4. VolumeKing: ì´ ë³¼ë¥¨(kg) 1ìœ„
  const volumeKing = findVolumeKingBadge(weeklyLogs, currentUserId);
  if (volumeKing) badges.push(volumeKing);

  // 5. CardioKing: í™˜ì‚° ê±°ë¦¬(km) 1ìœ„
  const cardioKing = findCardioKing(weeklyLogs, currentUserId);
  if (cardioKing) badges.push(cardioKing);

  // 6. SlopeMaster: ìŠ¤ë…¸ë³´ë“œ ëŸ° ìˆ˜ 1ìœ„
  const slopeMaster = findSlopeMaster(weeklyLogs, currentUserId);
  if (slopeMaster) badges.push(slopeMaster);

  // Me-first sorting: isMeê°€ trueì¸ ë°°ì§€ë¥¼ ë§¨ ì•ìœ¼ë¡œ
  return badges.sort((a, b) => {
    if (a.isMe && !b.isMe) return -1;
    if (!a.isMe && b.isMe) return 1;
    return 0; // ë‚˜ë¨¸ì§€ëŠ” ìˆœì„œ ìœ ì§€ (ëœë¤ì€ UIì—ì„œ ì²˜ë¦¬)
  });
};

// Helper: Workaholic (ì´ ìš´ë™ íšŸìˆ˜ 1ìœ„)
const findWorkaholic = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  const userWorkoutCounts = new Map<
    string,
    { userName: string; userProfile: string | null; count: number }
  >();

  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userWorkoutCounts.get(log.userId) || {
      userName: log.userDisplayName,
      userProfile: log.userProfileImage || null,
      count: 0,
    };

    existing.count += log.workouts.length;
    userWorkoutCounts.set(log.userId, existing);
  });

  const rankings = Array.from(userWorkoutCounts.entries())
    .filter(([_, data]) => data.count > 0)
    .sort((a, b) => b[1].count - a[1].count);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    userName: data.userName,
    userProfile: data.userProfile,
    type: 'effort',
    title: 'ì›Œì»¤í™€ë¦­',
    icon: 'ğŸ”¥',
    description: `ì£¼ê°„ ${data.count}íšŒ ìš´ë™`,
    value: `${data.count}íšŒ`,
    isMe: userId === currentUserId,
    badgeId: `${userId}-workaholic`,
  };
};

// Helper: EarlyBird (04-08ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„)
const findEarlyBirdBadge = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  const userEarlyCounts = new Map<
    string,
    { userName: string; userProfile: string | null; count: number }
  >();

  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const hour = new Date(log.createdAt).getHours();
    if (hour >= 4 && hour < 8) {
      const existing = userEarlyCounts.get(log.userId) || {
        userName: log.userDisplayName,
        userProfile: log.userProfileImage || null,
        count: 0,
      };

      existing.count += 1;
      userEarlyCounts.set(log.userId, existing);
    }
  });

  const rankings = Array.from(userEarlyCounts.entries())
    .filter(([_, data]) => data.count > 0)
    .sort((a, b) => b[1].count - a[1].count);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    userName: data.userName,
    userProfile: data.userProfile,
    type: 'time',
    title: 'ë¯¸ë¼í´ ëª¨ë‹',
    icon: 'ğŸŒ…',
    description: `ìƒˆë²½ ${data.count}íšŒ ìš´ë™`,
    value: `${data.count}íšŒ`,
    isMe: userId === currentUserId,
    badgeId: `${userId}-earlybird`,
  };
};

// Helper: NightOwl (22-03ì‹œ ìš´ë™ íšŸìˆ˜ 1ìœ„)
const findNightOwl = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  const userNightCounts = new Map<
    string,
    { userName: string; userProfile: string | null; count: number }
  >();

  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const hour = new Date(log.createdAt).getHours();
    if (hour >= 22 || hour < 3) {
      const existing = userNightCounts.get(log.userId) || {
        userName: log.userDisplayName,
        userProfile: log.userProfileImage || null,
        count: 0,
      };

      existing.count += 1;
      userNightCounts.set(log.userId, existing);
    }
  });

  const rankings = Array.from(userNightCounts.entries())
    .filter(([_, data]) => data.count > 0)
    .sort((a, b) => b[1].count - a[1].count);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    userName: data.userName,
    userProfile: data.userProfile,
    type: 'time',
    title: 'ì˜¬ë¹¼ë¯¸ íŒŒìˆ˜ê¾¼',
    icon: 'ğŸ¦‰',
    description: `ì‹¬ì•¼ ${data.count}íšŒ ìš´ë™`,
    value: `${data.count}íšŒ`,
    isMe: userId === currentUserId,
    badgeId: `${userId}-nightowl`,
  };
};

// Helper: VolumeKing (ì´ ë³¼ë¥¨ 1ìœ„)
const findVolumeKingBadge = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  console.log('[VolumeKing] ë¡œê·¸ ìˆ˜:', logs.length);
  console.log('[VolumeKing] ì²« ë²ˆì§¸ ë¡œê·¸ ìƒ˜í”Œ:', logs[0]);

  const userVolumes = new Map<
    string,
    { userName: string; userProfile: string | null; volume: number }
  >();

  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userVolumes.get(log.userId) || {
      userName: log.userDisplayName,
      userProfile: log.userProfileImage || null,
      volume: 0,
    };

    log.workouts.forEach((workout) => {
      // volume_kgê°€ ì—†ìœ¼ë©´ ì¦‰ì„ì—ì„œ ê³„ì‚° (ê¸°ì¡´ ë°ì´í„° ëŒ€ì‘)
      let calculatedVolume = workout.volume_kg;
      if (!calculatedVolume && workout.sets && workout.reps && workout.weight_kg) {
        calculatedVolume = workout.sets * workout.reps * workout.weight_kg;
      }

      console.log('[VolumeKing] Workout:', {
        name: workout.name,
        type: workout.type,
        category: workout.category,
        volume_kg: workout.volume_kg,
        calculatedVolume,
        sets: workout.sets,
        reps: workout.reps,
        weight_kg: workout.weight_kg,
      });

      // typeì´ 'strength'ì´ê±°ë‚˜ categoryê°€ 'gym', 'home'ì´ê³  ë³¼ë¥¨ì´ ìˆìœ¼ë©´ ì§‘ê³„
      const isStrengthWorkout = workout.type === 'strength' ||
                                ['gym', 'home'].includes(workout.category);

      if (isStrengthWorkout && calculatedVolume) {
        existing.volume += calculatedVolume;
        console.log('[VolumeKing] ë³¼ë¥¨ ì¶”ê°€:', calculatedVolume, 'ëˆ„ì :', existing.volume);
      }
    });

    userVolumes.set(log.userId, existing);
  });

  console.log('[VolumeKing] ìœ ì €ë³„ ë³¼ë¥¨:', Array.from(userVolumes.entries()));

  const rankings = Array.from(userVolumes.entries())
    .filter(([_, data]) => data.volume > 0)
    .sort((a, b) => b[1].volume - a[1].volume);

  console.log('[VolumeKing] ìˆœìœ„:', rankings);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];
  const volumeInTons = (data.volume / 1000).toFixed(1);

  return {
    userId,
    userName: data.userName,
    userProfile: data.userProfile,
    type: 'strength',
    title: '3ëŒ€ 500 ê¿ˆë‚˜ë¬´',
    icon: 'ğŸ‹ï¸',
    description: `ì´ ë³¼ë¥¨ ${volumeInTons}í†¤`,
    value: `${volumeInTons}t`,
    isMe: userId === currentUserId,
    badgeId: `${userId}-volumeking`,
  };
};

// Helper: CardioKing (í™˜ì‚° ê±°ë¦¬ 1ìœ„)
const findCardioKing = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  const userDistances = new Map<
    string,
    { userName: string; userProfile: string | null; distance: number }
  >();

  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userDistances.get(log.userId) || {
      userName: log.userDisplayName,
      userProfile: log.userProfileImage || null,
      distance: 0,
    };

    log.workouts.forEach((workout) => {
      // typeì´ 'cardio'ì´ê±°ë‚˜ categoryê°€ 'running'ì´ê³  ê±°ë¦¬ê°€ ìˆìœ¼ë©´ ì§‘ê³„
      const isCardioWorkout = workout.type === 'cardio' ||
                              (workout.category === 'running' && workout.adjusted_dist_km);

      if (isCardioWorkout && workout.adjusted_dist_km) {
        existing.distance += workout.adjusted_dist_km;
      }
    });

    userDistances.set(log.userId, existing);
  });

  const rankings = Array.from(userDistances.entries())
    .filter(([_, data]) => data.distance > 0)
    .sort((a, b) => b[1].distance - a[1].distance);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    userName: data.userName,
    userProfile: data.userProfile,
    type: 'cardio',
    title: 'ì§€ì¹  ì¤„ ëª¨ë¥´ëŠ” ì‹¬ì¥',
    icon: 'ğŸƒ',
    description: `ì´ ê±°ë¦¬ ${data.distance.toFixed(1)}km`,
    value: `${data.distance.toFixed(1)}km`,
    isMe: userId === currentUserId,
    badgeId: `${userId}-cardioking`,
  };
};

// Helper: SlopeMaster (ìŠ¤ë…¸ë³´ë“œ ëŸ° ìˆ˜ 1ìœ„)
const findSlopeMaster = (logs: WorkoutLog[], currentUserId?: string): HofBadge | null => {
  const userRuns = new Map<
    string,
    { userName: string; userProfile: string | null; runs: number }
  >();

  logs.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userRuns.get(log.userId) || {
      userName: log.userDisplayName,
      userProfile: log.userProfileImage || null,
      runs: 0,
    };

    log.workouts.forEach((workout) => {
      if (workout.category === 'snowboard' && workout.run_count) {
        existing.runs += workout.run_count;
      }
    });

    userRuns.set(log.userId, existing);
  });

  const rankings = Array.from(userRuns.entries())
    .filter(([_, data]) => data.runs > 0)
    .sort((a, b) => b[1].runs - a[1].runs);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    userName: data.userName,
    userProfile: data.userProfile,
    type: 'consistency',
    title: 'ì„¤ì›ì˜ ì§€ë°°ì',
    icon: 'ğŸ‚',
    description: `ì´ ${data.runs}ëŸ° ì™„ì£¼`,
    value: `${data.runs}ëŸ°`,
    isMe: userId === currentUserId,
    badgeId: `${userId}-slopemaster`,
  };
};

const findEarlyBird = (members: WorkoutLog[]): MemberTitle | null => {
  const today = new Date().toISOString().split('T')[0];

  let earliest: { userId: string; displayName: string; profileImage: string | null; time: number } | null = null;

  members.forEach((log) => {
    if (log.date !== today) return;
    if (!log.userId || !log.userDisplayName) return;

    const createdTime = new Date(log.createdAt);
    const hour = createdTime.getHours();

    if (hour >= 4 && hour < 7) {
      if (!earliest || createdTime.getTime() < earliest.time) {
        earliest = {
          userId: log.userId,
          displayName: log.userDisplayName,
          profileImage: log.userProfileImage || null,
          time: createdTime.getTime(),
        };
      }
    }
  });

  if (!earliest) return null;

  const { userId, displayName, profileImage, time: timestamp } = earliest;
  const time = new Date(timestamp);
  return {
    userId,
    displayName,
    profileImage,
    title: 'ìƒˆë²½ íŠ¸ë ˆì´ë„ˆ',
    icon: 'ğŸŒ…',
    value: `${time.getHours()}:${String(time.getMinutes()).padStart(2, '0')}`,
    description: 'ì˜¤ëŠ˜ ê°€ì¥ ë¨¼ì € ìš´ë™ ì‹œì‘',
  };
};

const findVolumeKing = (members: WorkoutLog[]): MemberTitle | null => {
  const userVolumes = new Map<string, { displayName: string; profileImage: string | null; volume: number }>();

  members.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userVolumes.get(log.userId) || {
      displayName: log.userDisplayName,
      profileImage: log.userProfileImage || null,
      volume: 0,
    };

    log.workouts.forEach((workout) => {
      if (workout.type === 'strength' && workout.volume_kg) {
        existing.volume += workout.volume_kg;
      }
    });

    userVolumes.set(log.userId, existing);
  });

  const rankings = Array.from(userVolumes.entries())
    .filter(([_, data]) => data.volume > 0)
    .sort((a, b) => b[1].volume - a[1].volume);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];
  const volumeInTons = data.volume / 1000;

  return {
    userId,
    displayName: data.displayName,
    profileImage: data.profileImage,
    title: 'ë³¼ë¥¨ í‚¹',
    icon: 'ğŸ‹ï¸',
    value: `${volumeInTons.toFixed(1)}t`,
    description: 'ì´ ë³¼ë¥¨ 1ìœ„',
  };
};

const findDistanceKing = (members: WorkoutLog[]): MemberTitle | null => {
  const userDistances = new Map<string, { displayName: string; profileImage: string | null; distance: number }>();

  members.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userDistances.get(log.userId) || {
      displayName: log.userDisplayName,
      profileImage: log.userProfileImage || null,
      distance: 0,
    };

    log.workouts.forEach((workout) => {
      if (workout.type === 'cardio' && workout.adjusted_dist_km) {
        existing.distance += workout.adjusted_dist_km;
      }
    });

    userDistances.set(log.userId, existing);
  });

  const rankings = Array.from(userDistances.entries())
    .filter(([_, data]) => data.distance > 0)
    .sort((a, b) => b[1].distance - a[1].distance);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    displayName: data.displayName,
    profileImage: data.profileImage,
    title: 'ê±°ë¦¬ í‚¹',
    icon: 'ğŸƒ',
    value: `${data.distance.toFixed(1)}km`,
    description: 'ì´ ê±°ë¦¬ 1ìœ„',
  };
};

const findRunKing = (members: WorkoutLog[]): MemberTitle | null => {
  const userRuns = new Map<string, { displayName: string; profileImage: string | null; runs: number }>();

  members.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userRuns.get(log.userId) || {
      displayName: log.userDisplayName,
      profileImage: log.userProfileImage || null,
      runs: 0,
    };

    log.workouts.forEach((workout) => {
      if (workout.category === 'snowboard' && workout.run_count) {
        existing.runs += workout.run_count;
      }
    });

    userRuns.set(log.userId, existing);
  });

  const rankings = Array.from(userRuns.entries())
    .filter(([_, data]) => data.runs > 0)
    .sort((a, b) => b[1].runs - a[1].runs);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    displayName: data.displayName,
    profileImage: data.profileImage,
    title: 'ëŸ° í‚¹',
    icon: 'ğŸ‚',
    value: `${data.runs}íšŒ`,
    description: 'ì´ ëŸ° ìˆ˜ 1ìœ„',
  };
};

const findStreakKing = (members: WorkoutLog[]): MemberTitle | null => {
  const sevenDaysAgo = new Date();
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

  const userFrequency = new Map<string, { displayName: string; profileImage: string | null; count: number }>();

  members.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;
    if (new Date(log.createdAt) < sevenDaysAgo) return;

    const existing = userFrequency.get(log.userId) || {
      displayName: log.userDisplayName,
      profileImage: log.userProfileImage || null,
      count: 0,
    };

    existing.count += 1;
    userFrequency.set(log.userId, existing);
  });

  const rankings = Array.from(userFrequency.entries())
    .filter(([_, data]) => data.count > 0)
    .sort((a, b) => b[1].count - a[1].count);

  if (rankings.length === 0) return null;

  const [userId, data] = rankings[0];

  return {
    userId,
    displayName: data.displayName,
    profileImage: data.profileImage,
    title: 'ì—°ì† ì¶œì„',
    icon: 'âš¡',
    value: `${data.count}ì¼`,
    description: 'ì£¼ê°„ ìš´ë™ íšŸìˆ˜ ìµœë‹¤',
  };
};

// ============================================
// ë¯¸ì…˜ ì‹œìŠ¤í…œ
// ============================================

export interface Mission {
  title: string;
  current: number;
  target: number;
  progress: number;
  unit: string;
  category: WorkoutCategory;
}

/**
 * í´ëŸ½ ë¯¸ì…˜ ê³„ì‚°
 * í´ëŸ½ì˜ ì£¼ìš” ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ëª©í‘œ ìë™ ì„¤ì •
 */
export const calculateMission = (members: WorkoutLog[], mainCategory: WorkoutCategory): Mission => {
  let current = 0;
  let target = 0;
  let unit = '';
  let title = '';

  switch (mainCategory) {
    case 'gym':
      // ì´ ë³¼ë¥¨ ëª©í‘œ: 100í†¤
      members.forEach((log) => {
        log.workouts.forEach((workout) => {
          if (workout.type === 'strength' && workout.volume_kg) {
            current += workout.volume_kg;
          }
        });
      });
      target = 100000; // kg
      unit = 't';
      title = 'ë³¼ë¥¨ ëª©í‘œ';
      current = current / 1000; // í†¤ìœ¼ë¡œ ë³€í™˜
      target = target / 1000;
      break;

    case 'running':
      // ì´ ê±°ë¦¬ ëª©í‘œ: 400km (ì„œìš¸-ë¶€ì‚°)
      members.forEach((log) => {
        log.workouts.forEach((workout) => {
          if (workout.type === 'cardio' && workout.adjusted_dist_km) {
            current += workout.adjusted_dist_km;
          }
        });
      });
      target = 400;
      unit = 'km';
      title = 'ê±°ë¦¬ ëª©í‘œ';
      break;

    case 'snowboard':
      // ì´ ëŸ° ëª©í‘œ: 8,848m (ì—ë² ë ˆìŠ¤íŠ¸ ë†’ì´)
      members.forEach((log) => {
        log.workouts.forEach((workout) => {
          if (workout.category === 'snowboard' && workout.run_count) {
            current += workout.run_count;
          }
        });
      });
      target = 8848;
      unit = 'm';
      title = 'ê³ ë„ ëª©í‘œ';
      break;

    default:
      // ê¸°ë³¸: ì´ ìš´ë™ íšŸìˆ˜
      members.forEach((log) => {
        current += log.workouts.length;
      });
      target = 1000;
      unit = 'íšŒ';
      title = 'ìš´ë™ ëª©í‘œ';
  }

  const progress = target > 0 ? Math.min((current / target) * 100, 100) : 0;

  return {
    title,
    current: Number(current.toFixed(1)),
    target: Number(target.toFixed(1)),
    progress: Number(progress.toFixed(1)),
    unit,
    category: mainCategory,
  };
};

// ============================================
// ì˜¤ëŠ˜ì˜ ì¶œì„ë¶€
// ============================================

export interface SquadMember {
  userId: string;
  displayName: string;
  profileImage: string | null;
  mainActivity: string; // ğŸ‚, ğŸ‹ï¸, ğŸƒ
  memo: string | null;
  workoutCount: number;
  activityType: 'today' | 'yesterday' | 'recent'; // Smart Squad: í™œë™ ì‹œì  êµ¬ë¶„
  lastActiveDate: string; // YYYY-MM-DD format
}

/**
 * ì˜¤ëŠ˜ ìš´ë™í•œ ë©¤ë²„ í•„í„°ë§ (Legacy)
 * @deprecated Use getSmartSquad instead
 */
export const getTodaySquad = (members: WorkoutLog[]): SquadMember[] => {
  const today = new Date().toISOString().split('T')[0];

  const squadMap = new Map<string, SquadMember>();

  members.forEach((log) => {
    if (log.date !== today) return;
    if (!log.userId || !log.userDisplayName) return;

    const existing = squadMap.get(log.userId) || {
      userId: log.userId,
      displayName: log.userDisplayName,
      profileImage: log.userProfileImage || null,
      mainActivity: 'ğŸ’ª',
      memo: log.memo || null,
      workoutCount: 0,
      activityType: 'today' as const,
      lastActiveDate: today,
    };

    // ê°€ì¥ ë¹„ì¤‘ì´ ë†’ì€ ìš´ë™ íƒ€ì… ì°¾ê¸°
    const typeCounts = new Map<string, number>();
    log.workouts.forEach((workout) => {
      const icon = getActivityIcon(workout.category, workout.type);
      typeCounts.set(icon, (typeCounts.get(icon) || 0) + 1);
    });

    const maxIcon = Array.from(typeCounts.entries()).sort((a, b) => b[1] - a[1])[0]?.[0] || 'ğŸ’ª';
    existing.mainActivity = maxIcon;
    existing.workoutCount += log.workouts.length;

    squadMap.set(log.userId, existing);
  });

  return Array.from(squadMap.values()).sort((a, b) => b.workoutCount - a.workoutCount);
};

/**
 * Smart Active Squad - ì˜¤ëŠ˜ + ì–´ì œ ìš´ë™í•œ ë©¤ë²„ë¥¼ í•¨ê»˜ í‘œì‹œ
 *
 * ì•Œê³ ë¦¬ì¦˜:
 * 1. ì˜¤ëŠ˜ ìš´ë™í•œ ë©¤ë²„ë¥¼ ìµœìƒë‹¨ì— ë°°ì¹˜ (activityType: 'today')
 * 2. ì˜¤ëŠ˜ ìš´ë™í•œ ë©¤ë²„ê°€ 4ëª… ë¯¸ë§Œì´ë©´ ì–´ì œ ìš´ë™í•œ ë©¤ë²„ ì¶”ê°€ (activityType: 'yesterday')
 * 3. ì˜¤ëŠ˜+ì–´ì œ ëª¨ë‘ ì—†ìœ¼ë©´ ê°€ì¥ ìµœê·¼ í™œë™í•œ ë©¤ë²„ 3ëª… í‘œì‹œ (activityType: 'recent')
 * 4. ì¤‘ë³µ ì œê±°: í•œ ìœ ì €ì˜ ìµœì‹  ê¸°ë¡ë§Œ í‘œì‹œ
 */
export const getSmartSquad = (members: WorkoutLog[]): SquadMember[] => {
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];

  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().split('T')[0];

  // ìœ ì €ë³„ ìµœì‹  í™œë™ ì •ë³´ë¥¼ ì €ì¥
  interface UserActivity {
    userId: string;
    displayName: string;
    profileImage: string | null;
    mainActivity: string;
    memo: string | null;
    workoutCount: number;
    activityType: 'today' | 'yesterday' | 'recent';
    lastActiveDate: string;
    lastActiveTimestamp: number;
  }

  const userActivityMap = new Map<string, UserActivity>();

  // ëª¨ë“  ë¡œê·¸ë¥¼ ìˆœíšŒí•˜ë©° ìœ ì €ë³„ ìµœì‹  í™œë™ ì§‘ê³„
  members.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    const existing = userActivityMap.get(log.userId);

    // ì´ë¯¸ ë“±ë¡ëœ ìœ ì €ë¼ë©´, ë” ìµœê·¼ í™œë™ë§Œ ë°˜ì˜
    if (existing && log.createdAt <= existing.lastActiveTimestamp) {
      // ê°™ì€ ë‚ ì§œì˜ ì¶”ê°€ ìš´ë™ì´ë©´ ì¹´ìš´íŠ¸ë§Œ ì¦ê°€
      if (log.date === existing.lastActiveDate) {
        existing.workoutCount += log.workouts.length;
      }
      return;
    }

    // í™œë™ íƒ€ì… ê²°ì •
    let activityType: 'today' | 'yesterday' | 'recent';
    if (log.date === todayStr) {
      activityType = 'today';
    } else if (log.date === yesterdayStr) {
      activityType = 'yesterday';
    } else {
      activityType = 'recent';
    }

    // ê°€ì¥ ë¹„ì¤‘ì´ ë†’ì€ ìš´ë™ íƒ€ì… ì°¾ê¸°
    const typeCounts = new Map<string, number>();
    log.workouts.forEach((workout) => {
      const icon = getActivityIcon(workout.category, workout.type);
      typeCounts.set(icon, (typeCounts.get(icon) || 0) + 1);
    });

    const maxIcon = Array.from(typeCounts.entries()).sort((a, b) => b[1] - a[1])[0]?.[0] || 'ğŸ’ª';

    userActivityMap.set(log.userId, {
      userId: log.userId,
      displayName: log.userDisplayName,
      profileImage: log.userProfileImage || null,
      mainActivity: maxIcon,
      memo: log.memo || null,
      workoutCount: log.workouts.length,
      activityType,
      lastActiveDate: log.date,
      lastActiveTimestamp: log.createdAt,
    });
  });

  // ìš°ì„ ìˆœìœ„ë³„ë¡œ ì •ë ¬
  const allMembers = Array.from(userActivityMap.values());

  // ì˜¤ëŠ˜ ìš´ë™í•œ ë©¤ë²„
  const todayMembers = allMembers
    .filter((m) => m.activityType === 'today')
    .sort((a, b) => b.workoutCount - a.workoutCount);

  // ì–´ì œ ìš´ë™í•œ ë©¤ë²„
  const yesterdayMembers = allMembers
    .filter((m) => m.activityType === 'yesterday')
    .sort((a, b) => b.workoutCount - a.workoutCount);

  // ìµœê·¼ í™œë™ ë©¤ë²„
  const recentMembers = allMembers
    .filter((m) => m.activityType === 'recent')
    .sort((a, b) => b.lastActiveTimestamp - a.lastActiveTimestamp)
    .slice(0, 3);

  // Smart Mix ë¡œì§
  const result: SquadMember[] = [];

  // 1. ì˜¤ëŠ˜ ìš´ë™í•œ ë©¤ë²„ ì¶”ê°€
  result.push(...todayMembers);

  // 2. ì˜¤ëŠ˜ ë©¤ë²„ê°€ 4ëª… ë¯¸ë§Œì´ë©´ ì–´ì œ ë©¤ë²„ ì¶”ê°€
  if (result.length < 4) {
    result.push(...yesterdayMembers);
  }

  // 3. ì˜¤ëŠ˜+ì–´ì œ ëª¨ë‘ ì—†ìœ¼ë©´ ìµœê·¼ ë©¤ë²„ ì¶”ê°€
  if (result.length === 0) {
    result.push(...recentMembers);
  }

  return result;
};

const getActivityIcon = (category: WorkoutCategory, type: string): string => {
  if (category === 'snowboard') return 'ğŸ‚';
  if (type === 'cardio') return 'ğŸƒ';
  if (type === 'strength') return 'ğŸ‹ï¸';
  if (type === 'skill') return 'ğŸ¯';
  return 'ğŸ’ª';
};

// ============================================
// Live Ticker
// ============================================

export interface TickerItem {
  id: string;
  icon: string;
  text: string;
  timestamp: number;
}

/**
 * ìµœì‹  í™œë™ í”¼ë“œ ìƒì„±
 */
export const generateTickerItems = (members: WorkoutLog[], limit: number = 10): TickerItem[] => {
  const items: TickerItem[] = [];

  // ìµœì‹ ìˆœ ì •ë ¬
  const sorted = [...members].sort((a, b) => b.createdAt - a.createdAt).slice(0, limit);

  sorted.forEach((log) => {
    if (!log.userId || !log.userDisplayName) return;

    // ëŒ€í‘œ ìš´ë™ ì„ íƒ (ê°€ì¥ ì¸ìƒì ì¸ ê²ƒ)
    const bestWorkout = log.workouts.reduce((best, current) => {
      const currentScore = getWorkoutScore(current);
      const bestScore = getWorkoutScore(best);
      return currentScore > bestScore ? current : best;
    }, log.workouts[0]);

    if (!bestWorkout) return;

    const icon = getActivityIcon(bestWorkout.category, bestWorkout.type);
    const text = formatTickerText(log.userDisplayName, bestWorkout);

    items.push({
      id: log.id,
      icon,
      text,
      timestamp: log.createdAt,
    });
  });

  return items;
};

const getWorkoutScore = (workout: any): number => {
  // ì¸ìƒì ì¸ ìš´ë™ì¼ìˆ˜ë¡ ë†’ì€ ì ìˆ˜
  if (workout.volume_kg) return workout.volume_kg / 100;
  if (workout.adjusted_dist_km) return workout.adjusted_dist_km * 10;
  if (workout.run_count) return workout.run_count * 5;
  return 1;
};

const formatTickerText = (displayName: string, workout: any): string => {
  const name = workout.name;

  if (workout.volume_kg && workout.volume_kg > 1000) {
    const tons = (workout.volume_kg / 1000).toFixed(1);
    return `${displayName}ë‹˜ ${name} ${tons}t ë‹¬ì„±`;
  }

  if (workout.adjusted_dist_km && workout.adjusted_dist_km > 10) {
    return `${displayName}ë‹˜ ${workout.adjusted_dist_km.toFixed(1)}km ì™„ì£¼`;
  }

  if (workout.run_count && workout.run_count > 20) {
    return `${displayName}ë‹˜ ${workout.run_count}ëŸ° ì™„ë£Œ`;
  }

  return `${displayName}ë‹˜ ${name} ì™„ë£Œ`;
};
</file>

<file path=".env.example">
VITE_SUPABASE_URL=your_supabase_url_here
VITE_SUPABASE_PUBLISHABLE_KEY=your_publishable_key_here
VITE_GEMINI_API_KEY=your_gemini_api_key_here
VITE_OPENAI_API_KEY=your_openai_api_key_here

# Kakao OAuth
VITE_KAKAO_REST_API_KEY=your_kakao_rest_api_key_here
VITE_KAKAO_CLIENT_SECRET=your_kakao_client_secret_here
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Environment variables
.env
.env.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

# Local Netlify folder
.netlify

# Test environment (temporary)
test-parser/
</file>

<file path="docs/database/two_track_challenge_migration.sql">
-- Two-Track Challenge System Migration
-- ê¸°ì¡´ club_challengesë¥¼ challengesë¡œ í†µí•©í•˜ì—¬ Global + Club ì±Œë¦°ì§€ë¥¼ ëª¨ë‘ ì§€ì›

-- ============================================
-- 1. ìƒˆë¡œìš´ challenges í…Œì´ë¸” ìƒì„±
-- ============================================

CREATE TABLE IF NOT EXISTS challenges (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 1. ì‹ë³„ ë° ë²”ìœ„ (Scope)
  scope TEXT NOT NULL CHECK (scope IN ('global', 'club')),
  club_id UUID REFERENCES clubs(id) ON DELETE CASCADE, -- globalì´ë©´ NULL, clubì´ë©´ í•„ìˆ˜
  created_by UUID REFERENCES users(id) ON DELETE CASCADE,

  -- 2. ê¸°ë³¸ ì •ë³´
  title TEXT NOT NULL,
  description TEXT,

  -- 3. ìŠ¹ë¦¬ ì¡°ê±´ (Core Logic) - ì¿¼ë¦¬ í•„í„°ë§ìš©
  -- ì¸¡ì • ì§€í‘œëŠ” ë¬´ì—‡ì¸ê°€?
  goal_metric TEXT NOT NULL CHECK (goal_metric IN ('total_workouts', 'total_volume', 'total_duration', 'total_distance')),
  -- ëª©í‘œ ê°’ì€ ì–¼ë§ˆì¸ê°€?
  goal_value INTEGER NOT NULL,
  -- í˜„ì¬ ë‹¬ì„± ê°’
  current_value INTEGER DEFAULT 0,

  -- 4. ê¸°ê°„ ì„¤ì •
  start_date TEXT NOT NULL, -- YYYY-MM-DD
  end_date TEXT NOT NULL,   -- YYYY-MM-DD

  -- 5. ìƒíƒœ
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'completed', 'failed')),

  -- 6. ì»¨í…ìŠ¤íŠ¸ & ë°ˆ (JSONB í™œìš©)
  -- Global: { "season": "2026-Winter", "tier": "gold", "badge_url": "..." }
  -- Club: { "bet_mode": true, "penalty": "ëŒ„ìŠ¤ì˜ìƒ ì˜¬ë¦¬ê¸°", "meme_image": "..." }
  meta_data JSONB DEFAULT '{}',

  -- 7. í™•ì¥ì„± (Forking)
  origin_challenge_id UUID REFERENCES challenges(id) ON DELETE SET NULL,

  -- 8. íƒ€ì„ìŠ¤íƒ¬í”„
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ë¬´ê²°ì„± ì œì•½ì¡°ê±´: club ìŠ¤ì½”í”„ì¸ë° club_idê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
ALTER TABLE challenges
ADD CONSTRAINT check_club_scope
CHECK (
  (scope = 'global' AND club_id IS NULL) OR
  (scope = 'club' AND club_id IS NOT NULL)
);

-- ============================================
-- 2. ì¸ë±ìŠ¤ ìƒì„± (ë¶€ë¶„ ì¸ë±ìŠ¤ë¡œ ìµœì í™”)
-- ============================================

-- ê¸€ë¡œë²Œ ì±Œë¦°ì§€ìš© ì¸ë±ìŠ¤
CREATE INDEX IF NOT EXISTS idx_challenges_global
ON challenges(start_date, end_date, status)
WHERE scope = 'global';

-- í´ëŸ½ ì±Œë¦°ì§€ìš© ì¸ë±ìŠ¤ (í´ëŸ½ IDë¡œ íŒŒí‹°ì…”ë‹ íš¨ê³¼)
CREATE INDEX IF NOT EXISTS idx_challenges_club
ON challenges(club_id, start_date, end_date, status)
WHERE scope = 'club';

-- ë²”ìœ„ ê²€ìƒ‰ìš©
CREATE INDEX IF NOT EXISTS idx_challenges_scope ON challenges(scope);

-- ìƒíƒœ ê²€ìƒ‰ìš©
CREATE INDEX IF NOT EXISTS idx_challenges_status ON challenges(status);

-- ============================================
-- 3. ì±Œë¦°ì§€ ì°¸ê°€ì í…Œì´ë¸” (ê¸°ì¡´ challenge_contributionsì™€ í†µí•©)
-- ============================================

-- ê¸°ì¡´ challenge_contributions í…Œì´ë¸”ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë˜,
-- í…Œì´ë¸”ëª…ì„ challenge_participantsë¡œ ë³€ê²½í•˜ì—¬ ì˜ë¯¸ë¥¼ ëª…í™•íˆ í•¨
CREATE TABLE IF NOT EXISTS challenge_participants (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  challenge_id UUID NOT NULL REFERENCES challenges(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  workout_log_id UUID NOT NULL REFERENCES workout_logs(id) ON DELETE CASCADE,
  contribution_value INTEGER NOT NULL,
  contributed_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(challenge_id, workout_log_id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX IF NOT EXISTS idx_challenge_participants_challenge_id ON challenge_participants(challenge_id);
CREATE INDEX IF NOT EXISTS idx_challenge_participants_user_id ON challenge_participants(user_id);
CREATE INDEX IF NOT EXISTS idx_challenge_participants_workout_log_id ON challenge_participants(workout_log_id);

-- ============================================
-- 4. ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
-- ============================================

-- ê¸°ì¡´ club_challenges ë°ì´í„°ë¥¼ challengesë¡œ ë³µì‚¬
INSERT INTO challenges (
  id,
  scope,
  club_id,
  created_by,
  title,
  description,
  goal_metric,
  goal_value,
  current_value,
  start_date,
  end_date,
  status,
  created_at,
  updated_at
)
SELECT
  id,
  'club' as scope, -- ëª¨ë“  ê¸°ì¡´ ì±Œë¦°ì§€ëŠ” club ìŠ¤ì½”í”„
  club_id,
  created_by,
  title,
  description,
  challenge_type as goal_metric,
  target_value as goal_value,
  current_value,
  start_date,
  end_date,
  status,
  created_at,
  updated_at
FROM club_challenges
WHERE NOT EXISTS (SELECT 1 FROM challenges WHERE challenges.id = club_challenges.id);

-- ê¸°ì¡´ challenge_contributions ë°ì´í„°ë¥¼ challenge_participantsë¡œ ë³µì‚¬
INSERT INTO challenge_participants (
  id,
  challenge_id,
  user_id,
  workout_log_id,
  contribution_value,
  contributed_at
)
SELECT
  id,
  challenge_id,
  user_id,
  workout_log_id,
  contribution_value,
  contributed_at
FROM challenge_contributions
WHERE NOT EXISTS (SELECT 1 FROM challenge_participants WHERE challenge_participants.id = challenge_contributions.id);

-- ============================================
-- 5. íŠ¸ë¦¬ê±° ì„¤ì •
-- ============================================

DROP TRIGGER IF EXISTS update_challenges_updated_at ON challenges;
CREATE TRIGGER update_challenges_updated_at
  BEFORE UPDATE ON challenges
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ============================================
-- 6. RLS (Row Level Security) ì •ì±…
-- ============================================

ALTER TABLE challenges ENABLE ROW LEVEL SECURITY;
ALTER TABLE challenge_participants ENABLE ROW LEVEL SECURITY;

-- ê¸°ì¡´ ì •ì±… ì œê±°
DROP POLICY IF EXISTS "Anyone can view global challenges" ON challenges;
DROP POLICY IF EXISTS "Club members can view club challenges" ON challenges;
DROP POLICY IF EXISTS "Owners and admins can create club challenges" ON challenges;
DROP POLICY IF EXISTS "Owners and admins can update club challenges" ON challenges;
DROP POLICY IF EXISTS "Owners and admins can delete club challenges" ON challenges;

-- ì¡°íšŒ ì •ì±…
CREATE POLICY "Anyone can view global challenges"
ON challenges FOR SELECT
USING (scope = 'global');

CREATE POLICY "Club members can view club challenges"
ON challenges FOR SELECT
USING (
  scope = 'club' AND
  EXISTS (
    SELECT 1 FROM club_members cm
    WHERE cm.club_id = challenges.club_id
    AND cm.user_id = auth.uid()
  )
);

-- ìƒì„± ì •ì±… (ê¸€ë¡œë²Œì€ DBì—ì„œ ì§ì ‘ ìƒì„±, í´ëŸ½ owner/adminì€ club ìƒì„± ê°€ëŠ¥)
-- Note: Global challenges are created directly in DB by developers
-- CREATE POLICY "Admins can create global challenges"
-- ON challenges FOR INSERT
-- WITH CHECK (scope = 'global' AND false); -- Prevent client-side creation

CREATE POLICY "Club owners and admins can create club challenges"
ON challenges FOR INSERT
WITH CHECK (
  scope = 'club' AND
  EXISTS (
    SELECT 1 FROM club_members cm
    WHERE cm.club_id = challenges.club_id
    AND cm.user_id = auth.uid()
    AND cm.role IN ('owner', 'admin')
  )
);

-- ìˆ˜ì • ì •ì±…
-- Note: Global challenges can only be updated via DB by developers
-- CREATE POLICY "Admins can update global challenges"
-- ON challenges FOR UPDATE
-- USING (scope = 'global' AND false);

CREATE POLICY "Club owners and admins can update club challenges"
ON challenges FOR UPDATE
USING (
  scope = 'club' AND
  EXISTS (
    SELECT 1 FROM club_members cm
    WHERE cm.club_id = challenges.club_id
    AND cm.user_id = auth.uid()
    AND cm.role IN ('owner', 'admin')
  )
);

-- ì‚­ì œ ì •ì±…
-- Note: Global challenges can only be deleted via DB by developers
-- CREATE POLICY "Admins can delete global challenges"
-- ON challenges FOR DELETE
-- USING (scope = 'global' AND false);

CREATE POLICY "Club owners and admins can delete club challenges"
ON challenges FOR DELETE
USING (
  scope = 'club' AND
  EXISTS (
    SELECT 1 FROM club_members cm
    WHERE cm.club_id = challenges.club_id
    AND cm.user_id = auth.uid()
    AND cm.role IN ('owner', 'admin')
  )
);

-- Participants ì •ì±…
CREATE POLICY "Users can view their own participations"
ON challenge_participants FOR SELECT
USING (user_id = auth.uid());

CREATE POLICY "Users can contribute to challenges"
ON challenge_participants FOR INSERT
WITH CHECK (user_id = auth.uid());

CREATE POLICY "Users can delete their own participations"
ON challenge_participants FOR DELETE
USING (user_id = auth.uid());

-- ============================================
-- 7. ì½”ë©˜íŠ¸
-- ============================================

COMMENT ON TABLE challenges IS 'Two-Track ì±Œë¦°ì§€ ì‹œìŠ¤í…œ: Global(ì•± ì „ì²´) + Club(í´ëŸ½ë³„)';
COMMENT ON COLUMN challenges.scope IS 'ë²”ìœ„: global(ì•± ì „ì²´) ë˜ëŠ” club(í´ëŸ½ ì „ìš©)';
COMMENT ON COLUMN challenges.club_id IS 'club ìŠ¤ì½”í”„ì¼ ë•Œë§Œ í•„ìˆ˜, globalì€ NULL';
COMMENT ON COLUMN challenges.goal_metric IS 'ì¸¡ì • ì§€í‘œ: total_workouts, total_volume, total_duration, total_distance';
COMMENT ON COLUMN challenges.meta_data IS 'ì»¨í…ìŠ¤íŠ¸ ë°ì´í„° (JSONB): season, tier, badge_url (global) / bet_mode, penalty, meme_image (club)';
COMMENT ON COLUMN challenges.origin_challenge_id IS 'ì›ë³¸ ì±Œë¦°ì§€ ID (í¬í¬ëœ ê²½ìš°)';

COMMENT ON TABLE challenge_participants IS 'ì±Œë¦°ì§€ ì°¸ê°€ ê¸°ë¡ ë° ê¸°ì—¬ ë‚´ì—­';

-- ============================================
-- 8. ìƒ˜í”Œ ê¸€ë¡œë²Œ ì±Œë¦°ì§€ ë°ì´í„°
-- ============================================

-- ì›°ì»´ ì±Œë¦°ì§€: ê°€ì… í›„ 3ì¼ ì—°ì† ì¶œì„
-- Note: created_byëŠ” ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜, ì²« ë²ˆì§¸ ì‚¬ìš©ì ID ì‚¬ìš©
INSERT INTO challenges (
  scope, title, description, goal_metric, goal_value,
  start_date, end_date, status,
  meta_data, created_by
) VALUES (
  'global',
  'ğŸ‰ ì›°ì»´ ì±Œë¦°ì§€: ì‘ì‹¬ì‚¼ì¼ íƒ€íŒŒ!',
  'ê°€ì… í›„ 3ì¼ ì—°ì† ìš´ë™ ê¸°ë¡í•˜ê¸°',
  'total_workouts',
  3,
  '2026-01-01',
  '2026-12-31',
  'active',
  '{"badge_url": "welcome_badge.png", "reward": "í”„ë¡œí•„ ë°°ì§€", "tier": "bronze"}'::jsonb,
  (SELECT id FROM users ORDER BY created_at LIMIT 1)
) ON CONFLICT DO NOTHING;

-- ì‹œì¦Œ ì±Œë¦°ì§€: 2026 ìœˆí„° ì‹œì¦Œ
INSERT INTO challenges (
  scope, title, description, goal_metric, goal_value,
  start_date, end_date, status,
  meta_data, created_by
) VALUES (
  'global',
  'â„ï¸ 2026 ìœˆí„° ì‹œì¦Œ: ì„¤êµ­ì—´ì°¨',
  '1ì›” í•œ ë‹¬ê°„ ì´ ë³¼ë¥¨ 10í†¤ ë‹¬ì„±í•˜ê¸°',
  'total_volume',
  10000,
  '2026-01-01',
  '2026-01-31',
  'active',
  '{"season": "2026-Winter", "badge_url": "winter_badge.png", "tier": "silver"}'::jsonb,
  (SELECT id FROM users ORDER BY created_at LIMIT 1)
) ON CONFLICT DO NOTHING;

-- ============================================
-- 9. ê¸°ì¡´ í…Œì´ë¸” ì²˜ë¦¬ ë° í˜¸í™˜ì„± ë·° ìƒì„±
-- ============================================

-- ê¸°ì¡´ í…Œì´ë¸”ì´ ìˆìœ¼ë©´ DROP (ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„)
-- ì£¼ì˜: í”„ë¡œë•ì…˜ì—ì„œëŠ” ë°˜ë“œì‹œ ë°ì´í„° ë°±ì—… í›„ ì§„í–‰í•˜ì„¸ìš”!
DROP TABLE IF EXISTS club_challenges CASCADE;
DROP TABLE IF EXISTS challenge_contributions CASCADE;

-- í˜¸í™˜ì„±ì„ ìœ„í•œ ë·° ìƒì„±
CREATE OR REPLACE VIEW club_challenges AS
SELECT
  id,
  club_id,
  title,
  description,
  goal_metric as challenge_type,
  goal_value as target_value,
  current_value,
  start_date,
  end_date,
  status,
  created_by,
  created_at,
  updated_at
FROM challenges
WHERE scope = 'club';

CREATE OR REPLACE VIEW challenge_contributions AS
SELECT * FROM challenge_participants;
</file>

<file path="src/contexts/AuthContext.tsx">
import { createContext, useContext, useState, useEffect } from 'react';
import type { ReactNode } from 'react';
import { supabase } from '../lib/supabase';

interface User {
  id: string;
  username: string;
  display_name: string;
  email?: string;
  kakao_id?: string;
  provider?: string;
  profile_image?: string;
}

interface AuthContextType {
  user: User | null;
  loading: boolean;
  login: (username: string) => Promise<void>;
  loginWithKakao: (userData: User) => Promise<void>;
  logout: () => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider = ({ children }: { children: ReactNode }) => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì •ë³´ ë³µì›
    const savedUser = localStorage.getItem('current_user');
    if (savedUser) {
      setUser(JSON.parse(savedUser));
    }
    setLoading(false);
  }, []);

  const login = async (username: string) => {
    try {
      // Supabaseì—ì„œ ì‚¬ìš©ì ì¡°íšŒ
      const { data, error } = await supabase
        .from('users')
        .select('id, username, display_name, email')
        .eq('username', username)
        .single();

      if (error) throw error;
      if (!data) throw new Error('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

      setUser(data);
      localStorage.setItem('current_user', JSON.stringify(data));
    } catch (err) {
      console.error('Login error:', err);
      throw err;
    }
  };

  const loginWithKakao = async (userData: User) => {
    try {
      // 1. Supabase Auth ì„¸ì…˜ ìƒì„± (RLSë¥¼ ìœ„í•´ í•„ìˆ˜)
      // ì¹´ì¹´ì˜¤ ID ê¸°ë°˜ìœ¼ë¡œ ê³ ìœ í•œ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ìƒì„±
      const authEmail = `kakao_${userData.kakao_id}@internal.app`;
      const authPassword = `kakao_${userData.kakao_id}_secret`;

      // ë¨¼ì € signIn ì‹œë„
      const { error: signInError } = await supabase.auth.signInWithPassword({
        email: authEmail,
        password: authPassword,
      });

      // ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ (ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´) signUp
      if (signInError) {
        const { error: signUpError } = await supabase.auth.signUp({
          email: authEmail,
          password: authPassword,
          options: {
            data: {
              user_id: userData.id, // users í…Œì´ë¸” ID ë§¤í•‘
            },
          },
        });

        if (signUpError) {
          console.error('Supabase Auth signUp ì‹¤íŒ¨:', signUpError);
          // Auth ì‹¤íŒ¨í•´ë„ ì•± ë¡œê·¸ì¸ì€ ì§„í–‰ (RLSë§Œ ì‘ë™ ì•ˆ í•¨)
        }
      }

      // 2. localStorageì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
      setUser(userData);
      localStorage.setItem('current_user', JSON.stringify(userData));
    } catch (err) {
      console.error('Kakao login error:', err);
      throw err;
    }
  };

  const logout = async () => {
    // Supabase Auth ë¡œê·¸ì•„ì›ƒ
    await supabase.auth.signOut();

    setUser(null);
    localStorage.removeItem('current_user');
  };

  return (
    <AuthContext.Provider value={{ user, loading, login, loginWithKakao, logout }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};
</file>

<file path="src/features/speech/useWhisperRecording.ts">
import { useState, useRef, useCallback } from 'react';
import { transcribeAudio as geminiTranscribeAudio } from '../../utils/gemini';

interface WhisperRecordingResult {
  isRecording: boolean;
  transcript: string;
  error: string | null;
  startRecording: () => void;
  stopRecording: () => Promise<string>;
  resetTranscript: () => void;
}

export const useWhisperRecording = (): WhisperRecordingResult => {
  const [isRecording, setIsRecording] = useState(false);
  const [transcript, setTranscript] = useState('');
  const [error, setError] = useState<string | null>(null);

  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const chunksRef = useRef<Blob[]>([]);
  const resolveTranscriptionRef = useRef<((text: string) => void) | null>(null);

  const startRecording = useCallback(async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);

      chunksRef.current = [];

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
          chunksRef.current.push(e.data);
        }
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(chunksRef.current, { type: 'audio/webm' });
        await transcribeAudio(audioBlob);

        stream.getTracks().forEach((track) => track.stop());
      };

      mediaRecorder.start();
      mediaRecorderRef.current = mediaRecorder;
      setIsRecording(true);
      setError(null);
    } catch (err) {
      console.error('Failed to start recording:', err);
      setError('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
      setIsRecording(false);
    }
  }, []);

  const stopRecording = useCallback(async (): Promise<string> => {
    return new Promise((resolve) => {
      if (mediaRecorderRef.current && isRecording) {
        resolveTranscriptionRef.current = resolve;
        mediaRecorderRef.current.stop();
        setIsRecording(false);
      } else {
        resolve('');
      }
    });
  }, [isRecording]);

  const transcribeAudio = async (audioBlob: Blob) => {
    console.log('[Gemini] Audio blob size:', audioBlob.size);

    try {
      console.log('[Gemini] Sending audio transcription request...');

      const text = await geminiTranscribeAudio(audioBlob);
      console.log('[Gemini] Transcription result:', text);
      setTranscript(text);

      // Promise resolve
      if (resolveTranscriptionRef.current) {
        resolveTranscriptionRef.current(text);
        resolveTranscriptionRef.current = null;
      }
    } catch (err) {
      console.error('[Gemini] Transcription error:', err);
      setError(`ìŒì„± ì¸ì‹ ì‹¤íŒ¨: ${err instanceof Error ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);

      // Promise resolve with error
      if (resolveTranscriptionRef.current) {
        resolveTranscriptionRef.current('');
        resolveTranscriptionRef.current = null;
      }
    }
  };

  const resetTranscript = useCallback(() => {
    setTranscript('');
    setError(null);
  }, []);

  return {
    isRecording,
    transcript,
    error,
    startRecording,
    stopRecording,
    resetTranscript,
  };
};
</file>

<file path="src/pages/Signup.tsx">
import { useState, useEffect } from 'react';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import authService from '../services/authService';

export const Signup = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const { loginWithKakao } = useAuth();

  const kakaoUserInfo = location.state?.kakaoUserInfo;
  const fromPath = location.state?.from || '/';

  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    birthYear: '',
    gender: '',
    nickname: '',
  });
  const [agreedToTerms, setAgreedToTerms] = useState(false);
  const [agreedToPrivacy, setAgreedToPrivacy] = useState(false);
  const [agreedToSensitiveInfo, setAgreedToSensitiveInfo] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ ì•„ë‹ˆë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  useEffect(() => {
    if (!kakaoUserInfo) {
      alert('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì„ í†µí•´ íšŒì›ê°€ì…ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
      navigate('/login', { replace: true });
    }
  }, [kakaoUserInfo, navigate]);

  // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ë©´ í¼ ìë™ ì…ë ¥
  useEffect(() => {
    if (kakaoUserInfo) {
      setFormData({
        name: kakaoUserInfo.displayName || '',
        email: kakaoUserInfo.email || '',
        phone: kakaoUserInfo.phoneNumber || '',
        birthYear: kakaoUserInfo.birthyear || '',
        gender: kakaoUserInfo.gender || '',
        nickname: kakaoUserInfo.nickname || '',
      });
    }
  }, [kakaoUserInfo]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    if (!agreedToTerms || !agreedToPrivacy || !agreedToSensitiveInfo) {
      setError('í•„ìˆ˜ ì•½ê´€ì— ëª¨ë‘ ë™ì˜í•´ì£¼ì„¸ìš”.');
      return;
    }

    // í•„ìˆ˜ ì •ë³´ í™•ì¸
    if (!formData.name || !formData.phone || !formData.birthYear || !formData.gender) {
      setError('ëª¨ë“  í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ì¹´ì¹´ì˜¤ íšŒì›ê°€ì…
    if (kakaoUserInfo) {
      setLoading(true);
      try {
        // ì…ë ¥ë°›ì€ ì •ë³´ë¡œ kakaoUserInfo ì—…ë°ì´íŠ¸
        const updatedKakaoInfo = {
          ...kakaoUserInfo,
          displayName: formData.name,
          phoneNumber: formData.phone,
          birthyear: formData.birthYear,
          gender: formData.gender,
          email: formData.email,
          nickname: formData.nickname,
        };

        const userData = await authService.registerKakaoUser(updatedKakaoInfo);
        await loginWithKakao(userData);
        alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        navigate(fromPath, { replace: true });
      } catch (err) {
        console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', err);
        setError(err instanceof Error ? err.message : 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        setLoading(false);
      }
      return;
    }
  };

  // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ ì—†ìœ¼ë©´ null ë°˜í™˜ (ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬ë¨)
  if (!kakaoUserInfo) {
    return null;
  }

  return (
    <div className="container">
      <div className="signup-container">
        <h1>íšŒì›ê°€ì…</h1>
        <p className="signup-subtitle">ì¹´ì¹´ì˜¤ ê³„ì • ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</p>

        {error && (
          <div className="error-message" style={{ marginBottom: '20px' }}>
            {error}
          </div>
        )}

        <form onSubmit={handleSubmit} className="signup-form">
          <div className="form-group">
            <label htmlFor="kakaoId">ì¹´ì¹´ì˜¤ ê³„ì •</label>
            <input
              id="kakaoId"
              type="text"
              value={`ì¹´ì¹´ì˜¤ ID: ${kakaoUserInfo.id}`}
              readOnly
              disabled
              style={{ backgroundColor: '#f5f5f5', cursor: 'not-allowed' }}
            />
            <p className="field-hint">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ìœ¼ë¡œ ìŠ¹ì¸ëœ ê³„ì •ì…ë‹ˆë‹¤</p>
          </div>

          {formData.nickname && (
            <div className="form-group">
              <label htmlFor="nickname">ë‹‰ë„¤ì„</label>
              <input
                id="nickname"
                type="text"
                value={formData.nickname}
                readOnly
                disabled
                style={{ backgroundColor: '#f5f5f5', cursor: 'not-allowed' }}
              />
            </div>
          )}

          {kakaoUserInfo.profileImage && (
            <div className="form-group">
              <label>í”„ë¡œí•„ ì‚¬ì§„</label>
              <img
                src={kakaoUserInfo.profileImage}
                alt="í”„ë¡œí•„"
                style={{ width: '80px', height: '80px', borderRadius: '50%', objectFit: 'cover' }}
              />
            </div>
          )}

          <div className="form-group">
            <label htmlFor="name">ì´ë¦„ *</label>
            <input
              id="name"
              type="text"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              placeholder="ì‹¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
              required
              readOnly={!!kakaoUserInfo?.displayName}
              disabled={!!kakaoUserInfo?.displayName}
              style={kakaoUserInfo?.displayName ? { backgroundColor: '#f5f5f5', cursor: 'not-allowed' } : {}}
            />
            {kakaoUserInfo?.displayName && (
              <p className="field-hint">ì¹´ì¹´ì˜¤ì—ì„œ ì œê³µëœ ì •ë³´ì…ë‹ˆë‹¤</p>
            )}
          </div>

          {formData.email && (
            <div className="form-group">
              <label htmlFor="email">ì´ë©”ì¼</label>
              <input
                id="email"
                type="email"
                value={formData.email}
                readOnly
                disabled
                style={{ backgroundColor: '#f5f5f5', cursor: 'not-allowed' }}
              />
              <p className="field-hint">ì¹´ì¹´ì˜¤ì—ì„œ ì œê³µëœ ì •ë³´ì…ë‹ˆë‹¤</p>
            </div>
          )}

          <div className="form-group">
            <label htmlFor="phone">ì „í™”ë²ˆí˜¸ *</label>
            <input
              id="phone"
              type="tel"
              value={formData.phone}
              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
              placeholder="010-1234-5678"
              required
              readOnly={!!kakaoUserInfo?.phoneNumber}
              disabled={!!kakaoUserInfo?.phoneNumber}
              style={kakaoUserInfo?.phoneNumber ? { backgroundColor: '#f5f5f5', cursor: 'not-allowed' } : {}}
            />
            {kakaoUserInfo?.phoneNumber ? (
              <p className="field-hint">ì¹´ì¹´ì˜¤ì—ì„œ ì œê³µëœ ì •ë³´ì…ë‹ˆë‹¤</p>
            ) : (
              <p className="field-hint">ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            )}
          </div>

          <div className="form-group">
            <label htmlFor="birthYear">ì¶œìƒì—°ë„ *</label>
            <input
              id="birthYear"
              type="number"
              value={formData.birthYear}
              onChange={(e) => setFormData({ ...formData, birthYear: e.target.value })}
              placeholder="1990"
              min="1900"
              max={new Date().getFullYear()}
              required
              readOnly={!!kakaoUserInfo?.birthyear}
              disabled={!!kakaoUserInfo?.birthyear}
              style={kakaoUserInfo?.birthyear ? { backgroundColor: '#f5f5f5', cursor: 'not-allowed' } : {}}
            />
            {kakaoUserInfo?.birthyear ? (
              <p className="field-hint">ì¹´ì¹´ì˜¤ì—ì„œ ì œê³µëœ ì •ë³´ì…ë‹ˆë‹¤</p>
            ) : (
              <p className="field-hint">ë‚˜ì´ëŒ€ë³„ ë§ì¶¤ ìš´ë™ ì¶”ì²œì— í™œìš©ë©ë‹ˆë‹¤</p>
            )}
          </div>

          <div className="form-group">
            <label htmlFor="gender">ì„±ë³„ *</label>
            <select
              id="gender"
              value={formData.gender}
              onChange={(e) => setFormData({ ...formData, gender: e.target.value })}
              required
              disabled={!!kakaoUserInfo?.gender}
              style={kakaoUserInfo?.gender ? { backgroundColor: '#f5f5f5', cursor: 'not-allowed' } : {}}
            >
              <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
              <option value="male">ë‚¨ì„±</option>
              <option value="female">ì—¬ì„±</option>
            </select>
            {kakaoUserInfo?.gender && (
              <p className="field-hint">ì¹´ì¹´ì˜¤ì—ì„œ ì œê³µëœ ì •ë³´ì…ë‹ˆë‹¤</p>
            )}
          </div>

          <div className="agreements-section">
            <div className="agreement-item">
              <label className="checkbox-label">
                <input
                  type="checkbox"
                  checked={agreedToTerms}
                  onChange={(e) => setAgreedToTerms(e.target.checked)}
                  required
                />
                <span>
                  <Link to="/terms" target="_blank" className="link-text">
                    ì´ìš©ì•½ê´€
                  </Link>
                  ì— ë™ì˜í•©ë‹ˆë‹¤ (í•„ìˆ˜)
                </span>
              </label>
            </div>

            <div className="agreement-item">
              <label className="checkbox-label">
                <input
                  type="checkbox"
                  checked={agreedToPrivacy}
                  onChange={(e) => setAgreedToPrivacy(e.target.checked)}
                  required
                />
                <span>
                  <Link to="/privacy" target="_blank" className="link-text">
                    ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨
                  </Link>
                  ì— ë™ì˜í•©ë‹ˆë‹¤ (í•„ìˆ˜)
                </span>
              </label>
            </div>

            <div className="agreement-item">
              <label className="checkbox-label">
                <input
                  type="checkbox"
                  checked={agreedToSensitiveInfo}
                  onChange={(e) => setAgreedToSensitiveInfo(e.target.checked)}
                  required
                />
                <span>
                  ë¯¼ê°ì •ë³´(ê±´ê°•ì •ë³´) ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤ (í•„ìˆ˜)
                </span>
              </label>
            </div>
            <p className="field-hint" style={{ marginTop: '12px', textAlign: 'left' }}>
              ìš´ë™ ê¸°ë¡, ì‹ ì²´ í™œë™ ì •ë³´ ë“± ê±´ê°• ê´€ë ¨ ë¯¼ê°ì •ë³´ê°€ ìˆ˜ì§‘ë©ë‹ˆë‹¤.
            </p>
          </div>

          <button
            type="submit"
            className="primary-button"
            disabled={!agreedToTerms || !agreedToPrivacy || !agreedToSensitiveInfo || loading}
          >
            {loading ? 'íšŒì›ê°€ì… ì¤‘...' : 'íšŒì›ê°€ì…'}
          </button>
        </form>

        <div className="signup-footer">
          <p>
            ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?{' '}
            <Link to="/login" className="link-text">
              ë¡œê·¸ì¸
            </Link>
          </p>
        </div>

        <div className="login-business-info">
          <p>jh308(ì œì´ì—ì´ì¹˜308) | ëŒ€í‘œì: ì–‘ì„í™˜ | ì‚¬ì—…ìë²ˆí˜¸: 188-17-02548</p>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="tmp.txt">
tmpSFDy
</file>

<file path="src/pages/Login.tsx">
import { Link } from 'react-router-dom';
import KakaoLogin from '../components/KakaoLogin';

export const Login = () => {
  return (
    <div className="container">
      <div className="login-container">
        <h1>ğŸ‹ï¸ Voice Workout Log</h1>
        <p className="login-subtitle">ìš´ë™ ê¸°ë¡ ì•±</p>

        <KakaoLogin />

        <div className="login-footer">
          <p>
            ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?{' '}
            <Link to="/signup" className="link-text">
              íšŒì›ê°€ì…
            </Link>
          </p>
        </div>

        <div className="login-business-info">
          <p>jh308(ì œì´ì—ì´ì¹˜308) | ëŒ€í‘œì: ì–‘ì„í™˜ | ì‚¬ì—…ìë²ˆí˜¸: 188-17-02548</p>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/features/parse/parseWorkoutText.ts">
import type { Workout, WorkoutType, WorkoutCategory, WorkoutTarget } from '../../types';
import { getKnownExercises } from '../normalize/normalizeText';

// Category keywords
const SNOWBOARD_KEYWORDS = ['ìŠ¤ë…¸ë³´ë“œ', 'ìŠ¤ë…¸ìš°ë³´ë“œ', 'ë³´ë“œ', 'ë³´ë”©'];
const RUNNING_KEYWORDS = ['ëŸ¬ë‹', 'ë‹¬ë¦¬ê¸°', 'ì¡°ê¹…', 'ë§ˆë¼í†¤'];
const SPORTS_KEYWORDS = ['ì¶•êµ¬', 'ë†êµ¬', 'ë°°êµ¬', 'í…Œë‹ˆìŠ¤', 'ë°°ë“œë¯¼í„´', 'ê³¨í”„', 'ìˆ˜ì˜'];
const HOME_KEYWORDS = ['í™ˆíŠ¸', 'ì§‘ì—ì„œ', 'ë§¨ëª¸'];

// Type keywords
const CARDIO_KEYWORDS = ['ëŸ¬ë‹', 'ìŠ¤í…ë°€', 'ì‚¬ì´í´', 'ë¡œì‰', 'ì¡°ê¹…', 'ë‹¬ë¦¬ê¸°', 'íŠ¸ë ˆë“œë°€'];
const STRENGTH_KEYWORDS = ['í”Œë­í¬', 'ë°ë“œë²„ê·¸', 'í‘¸ì‰¬ì—…', 'í’€ì—…', 'ìŠ¤ì¿¼íŠ¸', 'ë²¤ì¹˜', 'ë°ë“œ'];
const FLEXIBILITY_KEYWORDS = ['ìŠ¤íŠ¸ë ˆì¹­', 'ìš”ê°€', 'í¼ë¡¤ë§'];
const SKILL_KEYWORDS = ['íŠ¸ë¦­', 'ê¸°ë¬¼', 'ì§€ë¹™', 'ë°•ìŠ¤', 'ë ˆì¼', 'ìŠ¤ìœ™ ì—°ìŠµ'];

/**
 * 2ì¶• ë¶„ë¥˜: Categoryì™€ Typeì„ ë¶„ë¦¬í•´ì„œ ê²°ì •
 */
const determineWorkoutCategory = (name: string): WorkoutCategory => {
  const lowerName = name.toLowerCase();

  if (SNOWBOARD_KEYWORDS.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'snowboard';
  }
  if (RUNNING_KEYWORDS.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'running';
  }
  if (SPORTS_KEYWORDS.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'sports';
  }
  if (HOME_KEYWORDS.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'home';
  }

  // ê¸°ë³¸ê°’: gym (í—¬ìŠ¤ì¥ ìš´ë™ì´ ê°€ì¥ ì¼ë°˜ì )
  return 'gym';
};

const determineWorkoutType = (name: string): WorkoutType => {
  const lowerName = name.toLowerCase();

  if (SKILL_KEYWORDS.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'skill';
  }
  if (CARDIO_KEYWORDS.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'cardio';
  }
  if (FLEXIBILITY_KEYWORDS.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'flexibility';
  }
  if (STRENGTH_KEYWORDS.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'strength';
  }

  const knownExercises = getKnownExercises();
  if (knownExercises.some((ex) => name.includes(ex))) {
    return 'strength';
  }

  return 'unknown';
};

/**
 * Target ê²°ì • (ê·¼ë ¥ ìš´ë™ë§Œ í•´ë‹¹)
 */
const determineWorkoutTarget = (name: string): WorkoutTarget => {
  const lowerName = name.toLowerCase();

  // Core ìš´ë™
  const coreKeywords = ['í”Œë­í¬', 'í¬ëŸ°ì¹˜', 'ë ˆê·¸ë ˆì´ì¦ˆ', 'ë°ë“œë²„ê·¸', 'íí„°ì¹˜', 'ì‹œí‹°ë“œ ë‹ˆì—…', 'ëŸ¬ì‹œì•ˆ íŠ¸ìœ„ìŠ¤íŠ¸'];
  if (coreKeywords.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'core';
  }

  // Upper ìš´ë™
  const upperKeywords = ['ë²¤ì¹˜', 'í”„ë ˆìŠ¤', 'í’€ì—…', 'ì¹œì—…', 'í‘¸ì‰¬ì—…', 'ë¤ë²¨', 'ìˆ„ë”', 'ë ˆí„°ëŸ´', 'ë°”ë²¨ë¡œìš°', 'ë«í’€'];
  if (upperKeywords.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'upper';
  }

  // Lower ìš´ë™
  const lowerKeywords = ['ìŠ¤ì¿¼íŠ¸', 'ë°ë“œë¦¬í”„íŠ¸', 'ë ˆê·¸í”„ë ˆìŠ¤', 'ë ˆê·¸ì»¬', 'ë ˆê·¸ìµìŠ¤í…ì…˜', 'ëŸ°ì§€', 'ì¹¼í”„'];
  if (lowerKeywords.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'lower';
  }

  // Full ìš´ë™
  const fullKeywords = ['ë²„í”¼', 'í´ë¦°', 'ìŠ¤ë‚´ì¹˜', 'ì¼€í‹€ë²¨', 'ìŠ¤ìœ™'];
  if (fullKeywords.some((kw) => lowerName.includes(kw.toLowerCase()))) {
    return 'full';
  }

  return 'none';
};

interface ParsedNumbers {
  sets: number | null;
  reps: number | null;
  weight_kg: number | null;
  duration_min: number | null;
  distance_km: number | null;
  pace: string | null;
  speed_kph: number | null;
  incline_percent: number | null;
  resistance_level: number | null;
}

const extractNumbers = (segment: string): ParsedNumbers => {
  let sets: number | null = null;
  let reps: number | null = null;
  let weight_kg: number | null = null;
  let duration_min: number | null = null;
  let distance_km: number | null = null;
  let pace: string | null = null;
  let speed_kph: number | null = null;
  let incline_percent: number | null = null;
  let resistance_level: number | null = null;

  const setsMatch = segment.match(/(\d+)\s*ì„¸íŠ¸/);
  if (setsMatch) {
    sets = parseInt(setsMatch[1], 10);
  }

  // "íšŒ", "ê°œ", "ë²ˆ" ëª¨ë‘ repsë¡œ ì¸ì‹
  const repsMatch = segment.match(/(\d+)\s*(íšŒ|ê°œ|ë²ˆ)/);
  if (repsMatch) {
    reps = parseInt(repsMatch[1], 10);
  }

  const weightMatch = segment.match(/(\d+(?:\.\d+)?)\s*(kg|í‚¬ë¡œ|í‚¤ë¡œ)/i);
  if (weightMatch) {
    weight_kg = parseFloat(weightMatch[1]);
  }

  // ê±°ë¦¬ íŒŒì‹±: "2km", "10í‚¬ë¡œ", "5í‚¤ë¡œ"
  const distanceMatch = segment.match(/(\d+(?:\.\d+)?)\s*(km|í‚¬ë¡œ|í‚¤ë¡œ)/i);
  if (distanceMatch && !weightMatch) {
    // weightì™€ êµ¬ë¶„í•˜ê¸° ìœ„í•´ weightMatchê°€ ì—†ì„ ë•Œë§Œ
    distance_km = parseFloat(distanceMatch[1]);
  }

  // í˜ì´ìŠ¤ íŒŒì‹±: "1ë¶„ 30ì´ˆ", "2ë¶„", "5:30"
  const paceMinSecMatch = segment.match(/(\d+)\s*ë¶„\s*(\d+)\s*ì´ˆ/);
  if (paceMinSecMatch) {
    const min = paceMinSecMatch[1];
    const sec = paceMinSecMatch[2];
    pace = `${min}:${sec.padStart(2, '0')}`;
  } else {
    // "2ë¶„" í˜•ì‹
    const paceMinOnlyMatch = segment.match(/(\d+)\s*ë¶„(?!\s*ê°„)/); // "ë¶„ê°„"ì´ ì•„ë‹Œ ê²½ìš°
    if (paceMinOnlyMatch) {
      const min = paceMinOnlyMatch[1];
      // durationê³¼ êµ¬ë¶„: í˜ì´ìŠ¤ëŠ” ë³´í†µ 5ë¶„ ì´í•˜
      if (parseInt(min) <= 10) {
        pace = `${min}:00`;
      }
    }
  }

  // ì½œë¡  í˜•ì‹: "5:30"
  const paceColonMatch = segment.match(/(\d+):(\d+)/);
  if (paceColonMatch) {
    pace = `${paceColonMatch[1]}:${paceColonMatch[2].padStart(2, '0')}`;
  }

  // "ë¶„" íŒ¨í„´ (duration)
  const durationMinMatch = segment.match(/(\d+)\s*ë¶„(ê°„)?/);
  if (durationMinMatch && !pace) {
    duration_min = parseInt(durationMinMatch[1], 10);
  }

  // "ì‹œê°„" íŒ¨í„´ (ì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜)
  const durationHourMatch = segment.match(/(\d+(?:\.\d+)?)\s*ì‹œê°„/);
  if (durationHourMatch) {
    const hours = parseFloat(durationHourMatch[1]);
    duration_min = Math.round(hours * 60);
  }

  const multiplyMatch = segment.match(/(\d+)\s*x\s*(\d+)/i);
  if (multiplyMatch) {
    reps = parseInt(multiplyMatch[1], 10);
    sets = parseInt(multiplyMatch[2], 10);
  }

  // ì†ë„ íŒŒì‹±: "5km ì†ë„ë¡œ", "ì‹œì† 10km", "10km/h"
  const speedMatch = segment.match(/(?:ì‹œì†\s*)?(\d+(?:\.\d+)?)\s*(?:km|í‚¬ë¡œ|í‚¤ë¡œ)\s*(?:ì†ë„ë¡œ|ë¡œ|\/h|í¼ì•„ì›Œ)/i);
  if (speedMatch) {
    speed_kph = parseFloat(speedMatch[1]);

    // ì†ë„ì™€ ì‹œê°„ì´ ìˆìœ¼ë©´ ê±°ë¦¬ ê³„ì‚° (ê±°ë¦¬ê°€ ì—†ì„ ë•Œë§Œ)
    if (duration_min && !distance_km) {
      distance_km = speed_kph * (duration_min / 60);
    }
  }

  // ê²½ì‚¬ë„ íŒŒì‹±: "ì¸í´ë¼ì¸ 10", "ê²½ì‚¬ 15%", "ì˜¤ë¥´ë§‰ 10"
  const inclineMatch = segment.match(/(?:ì¸í´ë¼ì¸|ê²½ì‚¬|ì˜¤ë¥´ë§‰)\s*(\d+)(?:%|ë„)?/i);
  if (inclineMatch) {
    incline_percent = parseInt(inclineMatch[1], 10);
  }

  // ì €í•­ ë ˆë²¨ íŒŒì‹±: "ë ˆë²¨ 5", "ì €í•­ 8", "ê¸°ì–´ 10"
  const resistanceMatch = segment.match(/(?:ë ˆë²¨|ì €í•­|ê¸°ì–´)\s*(\d+)/i);
  if (resistanceMatch) {
    resistance_level = parseInt(resistanceMatch[1], 10);
  }

  return { sets, reps, weight_kg, duration_min, distance_km, pace, speed_kph, incline_percent, resistance_level };
};

const findExerciseName = (segment: string): string | null => {
  const knownExercises = getKnownExercises();

  for (const exercise of knownExercises) {
    if (segment.includes(exercise)) {
      return exercise;
    }
  }

  const cleaned = segment
    .replace(/\d+(?:\.\d+)?\s*ì‹œê°„/g, '')
    .replace(/\d+\s*ë¶„(ê°„)?/g, '')
    .replace(/\d+\s*ì´ˆ/g, '')
    .replace(/\d+:\d+/g, '')
    .replace(/\d+\s*ì„¸íŠ¸/g, '')
    .replace(/\d+\s*(íšŒ|ê°œ|ë²ˆ)/g, '')
    .replace(/\d+(?:\.\d+)?\s*(kg|í‚¬ë¡œ|í‚¤ë¡œ|km)/gi, '')
    .replace(/\d+\s*x\s*\d+/gi, '')
    .replace(/ë¹¡ì„¸ê²Œ|ê°€ë³ê²Œ|í•˜ë“œí•˜ê²Œ|ë¼ì´íŠ¸í•˜ê²Œ|ì¸í„°ë²Œ|ì†ë„|í…œí¬/g, '')
    .trim();

  if (cleaned.length > 1) {
    return cleaned;
  }

  return null;
};

export const parseWorkoutText = (normalizedText: string): Workout[] => {
  if (!normalizedText.trim()) {
    return [];
  }

  const segments = normalizedText.split(/[,.\n]/).filter((s) => s.trim());
  const workouts: Workout[] = [];

  for (const segment of segments) {
    const trimmed = segment.trim();
    if (!trimmed) continue;

    const name = findExerciseName(trimmed);
    if (!name) continue;

    const { sets, reps, weight_kg, duration_min, distance_km, pace, speed_kph, incline_percent, resistance_level } = extractNumbers(trimmed);

    // Matrix Classification: 2ì¶• ë¶„ë¥˜
    const category = determineWorkoutCategory(name);
    const type = determineWorkoutType(name);

    // Target ê²°ì • (ê·¼ë ¥ ìš´ë™ë§Œ)
    const target = type === 'strength' ? determineWorkoutTarget(name) : undefined;

    // note ì¶”ì¶œ: ê´„í˜¸ ì•ˆ ë‚´ìš© ë˜ëŠ” ê°•ë„ í‘œí˜„
    let note: string | null = null;
    const noteMatch = trimmed.match(/\((.*?)\)/);
    if (noteMatch) {
      note = noteMatch[1];
    } else {
      // ê°•ë„/ìŠ¤íƒ€ì¼ í‘œí˜„ ì¶”ì¶œ
      const intensityMatch = trimmed.match(/(ë¹¡ì„¸ê²Œ|ê°€ë³ê²Œ|í•˜ë“œí•˜ê²Œ|ë¼ì´íŠ¸í•˜ê²Œ|ì¸í„°ë²Œ|ì†ë„|í…œí¬|í”„ë¦¬ìŠ¤íƒ€ì¼|ì¹´ë¹™|ê³¤ëŒë¼|ì´ˆê¸‰|ì¤‘ê¸‰|ê³ ê¸‰)/);
      if (intensityMatch) {
        note = intensityMatch[1];
      }
    }

    workouts.push({
      name,
      sets,
      reps,
      weight_kg,
      duration_min,
      distance_km,
      pace,
      category,
      type,
      target,
      speed_kph,
      incline_percent,
      resistance_level,
      note,
    });
  }

  return workouts;
};
</file>

<file path="src/pages/Dashboard.tsx">
import { useState, useEffect } from 'react';
import { getAllLogs } from '../storage/supabaseStorage';
import type { WorkoutLog } from '../types';
import { calculateAdjustedDistance } from '../features/parse/normalizeCardio';

interface MonthlyStats {
  year: number;
  month: number;
  workoutDays: number;
  totalDistance: number; // ì¡°ì •ëœ ê±°ë¦¬
  totalCardioMinutes: number;
  avgPace: number; // í‰ê·  í˜ì´ìŠ¤ (ë¶„/km)

  // Matrix Classification ê¸°ë°˜ í†µê³„
  strengthDays: Set<string>;
  cardioDays: Set<string>;
  skillDays: Set<string>;
  flexibilityDays: Set<string>;

  // Target ê¸°ë°˜ ì½”ì–´ ì¶”ì 
  coreDays: Set<string>;

  // Category ê¸°ë°˜ ì¶”ì 
  snowboardDays: Set<string>;
}

export const Dashboard = () => {
  const [logs, setLogs] = useState<WorkoutLog[]>([]);
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadLogs();
  }, []);

  const loadLogs = async () => {
    setLoading(true);
    const allLogs = await getAllLogs();
    setLogs(allLogs);
    setLoading(false);
  };

  // ìœ ì‚°ì†Œ ê±°ë¦¬ ê³„ì‚° (íŠ¸ë ˆë“œë°€ 100%, ì‚¬ì´í´ 40%, ë¡œì‰ 60%)
  // REMOVED: calculateCardioDistance - now using calculateAdjustedDistance from normalizeCardio.ts

  // ì›”ê°„ í†µê³„ ê³„ì‚°
  const calculateMonthlyStats = (): MonthlyStats => {
    const stats: MonthlyStats = {
      year: selectedYear,
      month: selectedMonth,
      workoutDays: 0,
      totalDistance: 0,
      totalCardioMinutes: 0,
      avgPace: 0,
      strengthDays: new Set<string>(),
      cardioDays: new Set<string>(),
      skillDays: new Set<string>(),
      flexibilityDays: new Set<string>(),
      coreDays: new Set<string>(),
      snowboardDays: new Set<string>(),
    };

    const workoutDates = new Set<string>();

    logs.forEach((log) => {
      const logDate = new Date(log.date);
      if (logDate.getFullYear() === selectedYear && logDate.getMonth() + 1 === selectedMonth) {
        workoutDates.add(log.date);

        log.workouts.forEach((workout) => {
          // Typeë³„ ë‚ ì§œ ì¶”ê°€ (Matrix Classification)
          if (workout.type === 'strength') stats.strengthDays.add(log.date);
          if (workout.type === 'cardio') stats.cardioDays.add(log.date);
          if (workout.type === 'skill') stats.skillDays.add(log.date);
          if (workout.type === 'flexibility') stats.flexibilityDays.add(log.date);

          // Target ê¸°ë°˜ ì½”ì–´ ìš´ë™ ê°ì§€
          if (workout.type === 'strength' && workout.target === 'core') {
            stats.coreDays.add(log.date);
          }

          // Category ê¸°ë°˜ ìŠ¤ë…¸ë³´ë“œ ê°ì§€
          if (workout.category === 'snowboard') {
            stats.snowboardDays.add(log.date);
          }

          // ìœ ì‚°ì†Œ ê±°ë¦¬ ë° ì‹œê°„ ê³„ì‚° (í™˜ì‚° ë¹„ìœ¨ ì ìš©)
          if (workout.type === 'cardio') {
            // ì¹´í…Œê³ ë¦¬ë³„ í™˜ì‚° ë¹„ìœ¨ ì ìš©
            const adjustedDistance = calculateAdjustedDistance(
              workout.distance_km,
              workout.adjusted_dist_km ?? null,
              workout.name
            );

            stats.totalDistance += adjustedDistance;

            if (workout.duration_min) {
              stats.totalCardioMinutes += workout.duration_min;
            }
          }
        });
      }
    });

    stats.workoutDays = workoutDates.size;

    // í‰ê·  í˜ì´ìŠ¤ ê³„ì‚° (ë¶„/km)
    if (stats.totalDistance > 0) {
      stats.avgPace = stats.totalCardioMinutes / stats.totalDistance;
    }

    return stats;
  };

  // ìº˜ë¦°ë” ë°ì´í„° ìƒì„±
  const generateCalendar = () => {
    const year = selectedYear;
    const month = selectedMonth;
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); // 0 = ì¼ìš”ì¼

    const calendar: (number | null)[] = [];

    // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
    for (let i = 0; i < startDayOfWeek; i++) {
      calendar.push(null);
    }

    // ë‚ ì§œ ì±„ìš°ê¸°
    for (let day = 1; day <= daysInMonth; day++) {
      calendar.push(day);
    }

    return calendar;
  };

  // íŠ¹ì • ë‚ ì§œì˜ ìš´ë™ íƒ€ì… í™•ì¸
  const getWorkoutTypesForDate = (day: number): Set<string> => {
    const dateStr = `${selectedYear}-${String(selectedMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const types = new Set<string>();

    logs.forEach((log) => {
      if (log.date === dateStr) {
        log.workouts.forEach((workout) => {
          // Typeë³„ ì¶”ê°€
          types.add(workout.type);

          // Target ê¸°ë°˜ ì½”ì–´ ê°ì§€
          if (workout.type === 'strength' && workout.target === 'core') {
            types.add('core');
          }

          // Category ê¸°ë°˜ ìŠ¤ë…¸ë³´ë“œ ê°ì§€
          if (workout.category === 'snowboard') {
            types.add('snowboard');
          }
        });
      }
    });

    return types;
  };

  const stats = calculateMonthlyStats();
  const calendar = generateCalendar();
  const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

  const handlePrevMonth = () => {
    if (selectedMonth === 1) {
      setSelectedMonth(12);
      setSelectedYear(selectedYear - 1);
    } else {
      setSelectedMonth(selectedMonth - 1);
    }
  };

  const handleNextMonth = () => {
    if (selectedMonth === 12) {
      setSelectedMonth(1);
      setSelectedYear(selectedYear + 1);
    } else {
      setSelectedMonth(selectedMonth + 1);
    }
  };

  if (loading) {
    return (
      <div className="container">
        <div className="loading-screen">ë°ì´í„° ë¡œë”© ì¤‘...</div>
      </div>
    );
  }

  return (
    <div className="container">
      <div className="header">
        <h1>ëŒ€ì‹œë³´ë“œ</h1>
      </div>

      {/* ì›”ê°„ ì„ íƒê¸° */}
      <div className="month-selector">
        <button className="month-nav-button" onClick={handlePrevMonth}>
          â†
        </button>
        <div className="month-display">
          {selectedYear}ë…„ {selectedMonth}ì›”
        </div>
        <button className="month-nav-button" onClick={handleNextMonth}>
          â†’
        </button>
      </div>

      {/* ì›”ê°„ ë¦¬í¬íŠ¸ */}
      <div className="stats-section">
        <h2>ì›”ê°„ ë¦¬í¬íŠ¸</h2>

        <div className="stats-grid">
          <div className="stat-card">
            <div className="stat-label">ìš´ë™ ì¼ìˆ˜</div>
            <div className="stat-value">{stats.workoutDays}ì¼</div>
          </div>

          <div className="stat-card">
            <div className="stat-label">ìœ ì‚°ì†Œ ê±°ë¦¬ (í™˜ì‚°)</div>
            <div className="stat-value">{stats.totalDistance.toFixed(1)} km</div>
            <div className="stat-note" style={{ fontSize: '0.75rem', color: '#888', marginTop: '4px' }}>
              ì¢…ëª©ë³„ ë‚œì´ë„ ë³´ì • ì ìš©<br/>
              ğŸƒÃ—1.0 ğŸªœÃ—1.0 ğŸš£Ã—0.6 ğŸš´Ã—0.4 ğŸ’¨Ã—0.3
            </div>
          </div>

          <div className="stat-card">
            <div className="stat-label">í‰ê·  í˜ì´ìŠ¤</div>
            <div className="stat-value">
              {stats.avgPace > 0 ? `${stats.avgPace.toFixed(1)} ë¶„/km` : '-'}
            </div>
          </div>
        </div>

        <div className="type-stats">
          <div className="type-stat-item">
            <span className="type-badge strength">ê·¼ë ¥</span>
            <span>{stats.strengthDays.size}ì¼</span>
          </div>
          <div className="type-stat-item">
            <span className="type-badge cardio">ìœ ì‚°ì†Œ</span>
            <span>{stats.cardioDays.size}ì¼</span>
          </div>
          <div className="type-stat-item">
            <span className="type-badge core">ì½”ì–´</span>
            <span>{stats.coreDays.size}ì¼</span>
          </div>
          <div className="type-stat-item">
            <span className="type-badge snowboard">ìŠ¤ë…¸ë³´ë“œ</span>
            <span>{stats.snowboardDays.size}ì¼</span>
          </div>
        </div>
      </div>

      {/* ìº˜ë¦°ë” */}
      <div className="calendar-section">
        <h2>ìš´ë™ ìº˜ë¦°ë”</h2>

        <div className="calendar-grid">
          {/* ìš”ì¼ í—¤ë” */}
          {weekdays.map((day) => (
            <div key={day} className="calendar-weekday">
              {day}
            </div>
          ))}

          {/* ë‚ ì§œ */}
          {calendar.map((day, index) => {
            if (day === null) {
              return <div key={`empty-${index}`} className="calendar-day empty"></div>;
            }

            const types = getWorkoutTypesForDate(day);
            const hasWorkout = types.size > 0;

            return (
              <div key={day} className={`calendar-day ${hasWorkout ? 'has-workout' : ''}`}>
                <div className="day-number">{day}</div>
                {hasWorkout && (
                  <div className="workout-indicators">
                    {types.has('strength') && <div className="indicator strength"></div>}
                    {types.has('cardio') && <div className="indicator cardio"></div>}
                    {types.has('core') && <div className="indicator core"></div>}
                    {types.has('snowboard') && <div className="indicator snowboard"></div>}
                  </div>
                )}
              </div>
            );
          })}
        </div>

        {/* ë²”ë¡€ */}
        <div className="calendar-legend">
          <div className="legend-item">
            <div className="legend-dot strength"></div>
            <span>ê·¼ë ¥</span>
          </div>
          <div className="legend-item">
            <div className="legend-dot cardio"></div>
            <span>ìœ ì‚°ì†Œ</span>
          </div>
          <div className="legend-item">
            <div className="legend-dot core"></div>
            <span>ì½”ì–´</span>
          </div>
          <div className="legend-item">
            <div className="legend-dot snowboard"></div>
            <span>ìŠ¤ë…¸ë³´ë“œ</span>
          </div>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/pages/Recommend.tsx">
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { getAllLogs, getUserProfile, saveUserProfile, deleteUserProfile } from '../storage/supabaseStorage';
import { saveTodo, getTodayTodo, getAllTodos, generateId, formatDate } from '../storage/logStorage';
import type { WorkoutLog, UserProfile, DailyTodo, TodoWorkout } from '../types';
import { generateTextWithAI, getAvailableProviders, getDefaultProvider } from '../utils/ai';

type ViewMode = 'profile-chat' | 'ready' | 'loading' | 'recommendation-chat' | 'finalized';

interface ChatMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: number;
}

export const Recommend = () => {
  const navigate = useNavigate();
  const [viewMode, setViewMode] = useState<ViewMode>('ready');
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [todayFeeling, setTodayFeeling] = useState('');
  const [isGeneratingProfile, setIsGeneratingProfile] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [aiInfo, setAiInfo] = useState<string>('');

  // ëŒ€í™”í˜• í”„ë¡œí•„ ì„¤ì •
  const [profileChatMessages, setProfileChatMessages] = useState<ChatMessage[]>([]);
  const [profileChatInput, setProfileChatInput] = useState('');
  const [isProfileChatProcessing, setIsProfileChatProcessing] = useState(false);

  // ëŒ€í™”í˜• ì¶”ì²œ
  const [recommendationChatMessages, setRecommendationChatMessages] = useState<ChatMessage[]>([]);
  const [recommendationChatInput, setRecommendationChatInput] = useState('');
  const [isRecommendationChatProcessing, setIsRecommendationChatProcessing] = useState(false);
  const [currentAnalysis, setCurrentAnalysis] = useState<string>('');
  const [currentRecommendation, setCurrentRecommendation] = useState<string>('');

  useEffect(() => {
    loadProfile();

    // AI ì œê³µì ì •ë³´ í‘œì‹œ
    const providers = getAvailableProviders();
    const defaultProvider = getDefaultProvider();
    const providerNames = {
      gemini: 'Gemini',
      openai: 'OpenAI GPT',
    };

    if (providers.length > 0) {
      const providerList = providers.map(p => providerNames[p]).join(', ');
      setAiInfo(`ì‚¬ìš© ê°€ëŠ¥í•œ AI: ${providerList} (ì¶”ì²œ: ${providerNames[defaultProvider]})`);
    } else {
      setAiInfo('AI ì„¤ì • í•„ìš”');
    }
  }, []);

  const loadProfile = async () => {
    const savedProfile = await getUserProfile();
    setProfile(savedProfile);
    if (!savedProfile) {
      setViewMode('profile-chat');
      // ì²« ë©”ì‹œì§€: AIê°€ ëŒ€í™” ì‹œì‘
      startProfileChat();
    } else {
      setViewMode('ready');
    }
  };

  const startProfileChat = async () => {
    const welcomeMessage: ChatMessage = {
      role: 'assistant',
      content: 'ì•ˆë…•í•˜ì„¸ìš”! ë§ì¶¤ ìš´ë™ ì¶”ì²œì„ ìœ„í•´ ëª‡ ê°€ì§€ ì§ˆë¬¸ì„ ë“œë¦´ê²Œìš”. í¸í•˜ê²Œ ë‹µë³€í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.\n\në¨¼ì €, ìš´ë™ ê²½í—˜ì´ ì–¼ë§ˆë‚˜ ë˜ì…¨ë‚˜ìš”? (ì˜ˆ: ì²˜ìŒì´ì—ìš”, 6ê°œì›” ì •ë„ìš”, 2ë…„ ë„˜ì—ˆì–´ìš” ë“±)',
      timestamp: Date.now(),
    };
    setProfileChatMessages([welcomeMessage]);
  };

  const handleProfileChatSubmit = async () => {
    if (!profileChatInput.trim()) return;

    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    const userMessage: ChatMessage = {
      role: 'user',
      content: profileChatInput,
      timestamp: Date.now(),
    };

    const newMessages = [...profileChatMessages, userMessage];
    setProfileChatMessages(newMessages);
    setProfileChatInput('');
    setIsProfileChatProcessing(true);

    try {
      // AIì—ê²Œ ëŒ€í™” ì´ë ¥ê³¼ í•¨ê»˜ ë‹¤ìŒ ì§ˆë¬¸ ìš”ì²­
      const conversationContext = newMessages
        .map((m) => `${m.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${m.content}`)
        .join('\n');

      const systemPrompt = `ë‹¹ì‹ ì€ ì¹œì ˆí•œ í”¼íŠ¸ë‹ˆìŠ¤ ì½”ì¹˜ì…ë‹ˆë‹¤. ì‚¬ìš©ìì™€ ëŒ€í™”í•˜ë©° ë‹¤ìŒ ì •ë³´ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ìˆ˜ì§‘í•˜ì„¸ìš”:

1. ë‚˜ì´, ì„±ë³„, í‚¤, ì²´ì¤‘
2. ìš´ë™ ê²½í—˜ (ì–¼ë§ˆë‚˜ í–ˆëŠ”ì§€)
3. ìš´ë™ ëª©í‘œ (ê·¼ìœ¡, ì²´ë ¥, ë‹¤ì´ì–´íŠ¸, ìŠ¤í¬ì¸  ë“±)
4. ì„ í˜¸/íšŒí”¼ ìš´ë™
5. ë¶€ìƒ ì´ë ¥
6. ì‚¬ìš© ê°€ëŠ¥ ì¥ë¹„ (ì§‘, í—¬ìŠ¤ì¥ ë“±)
7. ê°€ìš© ì‹œê°„ (ì£¼ ëª‡ íšŒ, íšŒë‹¹ ëª‡ ë¶„)
8. ìƒí™œ íŒ¨í„´ (í™œë™ëŸ‰, ìˆ˜ë©´)

**ëŒ€í™” ê·œì¹™:**
- í•œ ë²ˆì— 1-2ê°€ì§€ë§Œ ë¬¼ì–´ë³´ì„¸ìš”
- ì‚¬ìš©ìê°€ ë‹µí•œ ë‚´ìš©ì„ ìš”ì•½í•´ì£¼ì„¸ìš”
- ì•„ì§ ëª¨ë¥´ëŠ” ì •ë³´ê°€ ìˆìœ¼ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ìŒ ì§ˆë¬¸ì„ í•˜ì„¸ìš”
- ì¶©ë¶„í•œ ì •ë³´ë¥¼ ì–»ì—ˆë‹¤ë©´ "ì¢‹ìŠµë‹ˆë‹¤! ì´ì œ í”„ë¡œí•„ì„ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤." ë¼ê³  ë§í•˜ê³  [COMPLETE] íƒœê·¸ë¥¼ ë¶™ì—¬ì£¼ì„¸ìš”

**ì¶œë ¥ í˜•ì‹:**
- ì¼ë°˜ ì§ˆë¬¸: ê·¸ëƒ¥ ì§ˆë¬¸ ë‚´ìš©
- ì™„ë£Œ: "ì¢‹ìŠµë‹ˆë‹¤! ì´ì œ í”„ë¡œí•„ì„ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤. [COMPLETE]"`;

      const aiResponse = await generateTextWithAI(
        systemPrompt,
        conversationContext,
        { temperature: 0.7, maxTokens: 300 }
      );

      const assistantMessage: ChatMessage = {
        role: 'assistant',
        content: aiResponse,
        timestamp: Date.now(),
      };

      setProfileChatMessages([...newMessages, assistantMessage]);

      // [COMPLETE] íƒœê·¸ê°€ ìˆìœ¼ë©´ í”„ë¡œí•„ ìƒì„±
      if (aiResponse.includes('[COMPLETE]')) {
        await generateProfileFromChat(newMessages);
      }
    } catch (error) {
      console.error('[Profile Chat] Error:', error);
      setError('ëŒ€í™” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsProfileChatProcessing(false);
    }
  };

  const generateProfileFromChat = async (messages: ChatMessage[]) => {
    setIsGeneratingProfile(true);

    try {
      const conversationText = messages
        .filter((m) => m.role !== 'system')
        .map((m) => `${m.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${m.content}`)
        .join('\n');

      const systemPrompt = `ë‹¹ì‹ ì€ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ëŒ€í™” ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ì‚¬ìš©ì í”„ë¡œí•„ì„ JSON í˜•ì‹ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.

**í•„ìš”í•œ ì •ë³´:**
{
  "age": ìˆ«ì ë˜ëŠ” null,
  "gender": "male" | "female" | "other" | null,
  "height": ìˆ«ì(cm) ë˜ëŠ” null,
  "weight": ìˆ«ì(kg) ë˜ëŠ” null,
  "experienceLevel": "beginner" | "intermediate" | "advanced" | null,
  "experienceMonths": ìˆ«ì ë˜ëŠ” null,
  "goals": "ëª©í‘œ ìš”ì•½ ë¬¸ì¥",
  "primaryGoal": "muscle_gain" | "strength" | "endurance" | "weight_loss" | "sport_performance" | "general_fitness" | null,
  "preferredWorkouts": ["ìš´ë™1", "ìš´ë™2"] ë˜ëŠ” [],
  "avoidedWorkouts": ["ìš´ë™1"] ë˜ëŠ” [],
  "injuries": ["ë¶€ìƒ1"] ë˜ëŠ” [],
  "availableEquipment": "home" | "gym" | "bodyweight" | "mixed" | null,
  "availableTime": {"sessionsPerWeek": ìˆ«ì, "minutesPerSession": ìˆ«ì} ë˜ëŠ” null,
  "activityLevel": "sedentary" | "moderate" | "active" | "very_active" | null,
  "sleepHours": ìˆ«ì ë˜ëŠ” null,
  "stressLevel": "low" | "medium" | "high" | null,
  "preferredIntensity": {
    "weight": "conservative" | "moderate" | "progressive",
    "volume": "low" | "medium" | "high"
  } ë˜ëŠ” null
}

ëŒ€í™”ì—ì„œ ì–¸ê¸‰ë˜ì§€ ì•Šì€ í•­ëª©ì€ nullë¡œ ì„¤ì •í•˜ì„¸ìš”. goalsëŠ” ë°˜ë“œì‹œ í¬í•¨í•´ì£¼ì„¸ìš”.
JSONë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ í•˜ì§€ ë§ˆì„¸ìš”.`;

      const profileJson = await generateTextWithAI(
        systemPrompt,
        conversationText,
        { temperature: 0.3, maxTokens: 800 }
      );

      // JSON íŒŒì‹±
      const jsonMatch = profileJson.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('í”„ë¡œí•„ JSON íŒŒì‹± ì‹¤íŒ¨');
      }

      const parsedProfile = JSON.parse(jsonMatch[0]);

      const newProfile: UserProfile = {
        ...parsedProfile,
        conversationHistory: messages
          .filter((m) => m.role !== 'system')
          .map((m) => ({
            question: m.role === 'assistant' ? m.content : '',
            answer: m.role === 'user' ? m.content : '',
            timestamp: m.timestamp,
          })),
        createdAt: Date.now(),
        updatedAt: Date.now(),
      };

      await saveUserProfile(newProfile);
      setProfile(newProfile);
      setViewMode('ready');
      setProfileChatMessages([]);
    } catch (error) {
      console.error('[Generate Profile] Error:', error);
      setError('í”„ë¡œí•„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsGeneratingProfile(false);
    }
  };


  const handleEditProfile = () => {
    setViewMode('profile-chat');
    startProfileChat();
  };

  const handleDeleteProfile = async () => {
    if (confirm('í”„ë¡œí•„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìš´ë™ ê¸°ë¡ì€ ìœ ì§€ë©ë‹ˆë‹¤.')) {
      try {
        await deleteUserProfile();
        setProfile(null);
        setViewMode('profile-chat');
        startProfileChat();
      } catch (err) {
        setError('í”„ë¡œí•„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
  };

  const parseRecommendationToWorkouts = (recommendationText: string): TodoWorkout[] => {
    const workouts: TodoWorkout[] = [];
    const lines = recommendationText.split('\n');

    for (const line of lines) {
      // ìš´ë™ëª…, ì„¸íŠ¸, íšŸìˆ˜, ë¬´ê²Œ ë“±ì„ ì¶”ì¶œí•˜ëŠ” ê°„ë‹¨í•œ íŒŒì‹±
      // ì˜ˆ: "ìŠ¤ì¿¼íŠ¸ 80kg 4ì„¸íŠ¸ 8íšŒ" or "ë²¤ì¹˜í”„ë ˆìŠ¤: 60kg, 3ì„¸íŠ¸ 10íšŒ"
      const workoutMatch = line.match(/([ê°€-í£a-zA-Z\s]+)\s*:?\s*(\d+(?:\.\d+)?)\s*kg/i);
      const setsRepsMatch = line.match(/(\d+)\s*ì„¸íŠ¸\s*[Ã—x]?\s*(\d+)\s*íšŒ/i);
      const durationMatch = line.match(/(\d+)\s*ë¶„/i);

      if (workoutMatch || setsRepsMatch || durationMatch) {
        const name = workoutMatch ? workoutMatch[1].trim() : line.trim().split(/[:\-,]/)[0].trim();
        const weight_kg = workoutMatch ? parseFloat(workoutMatch[2]) : undefined;
        const sets = setsRepsMatch ? parseInt(setsRepsMatch[1]) : undefined;
        const reps = setsRepsMatch ? parseInt(setsRepsMatch[2]) : undefined;
        const duration_min = durationMatch ? parseInt(durationMatch[1]) : undefined;

        if (name && name.length > 0 && name.length < 50) {
          workouts.push({
            name,
            sets,
            reps,
            weight_kg,
            duration_min,
            completed: false,
          });
        }
      }
    }

    return workouts;
  };


  const generateRecommendation = async () => {
    setViewMode('loading');
    setError(null);

    try {
      const logs = await getAllLogs();

      if (logs.length === 0) {
        setError('ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìš´ë™ì„ ê¸°ë¡í•´ì£¼ì„¸ìš”.');
        setViewMode('ready');
        return;
      }

      const recentLogs = logs.slice(0, 10); // ìµœê·¼ 10ì¼ë¡œ í™•ëŒ€
      const workoutSummary = analyzeWorkouts(recentLogs);

      // === ìµœê·¼ 5ì¼ê°„ì˜ ëŒ€í™” íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° ===
      const allTodos = getAllTodos();
      const recentTodosWithChat = allTodos
        .filter(todo => todo.aiRecommendation?.conversationHistory && todo.aiRecommendation.conversationHistory.length > 0)
        .slice(0, 5); // ìµœê·¼ 5ê°œ

      let conversationHistoryContext = '';
      if (recentTodosWithChat.length > 0) {
        conversationHistoryContext = '\n\n**ìµœê·¼ 5ì¼ê°„ì˜ AI ì¶”ì²œ ëŒ€í™” íˆìŠ¤í† ë¦¬:**\n';
        recentTodosWithChat.forEach((todo, index) => {
          const dayNum = index + 1;
          conversationHistoryContext += `\n[${dayNum}ì¼ ì „ - ${todo.date}]\n`;

          if (todo.aiRecommendation?.conversationHistory) {
            const chatSummary = todo.aiRecommendation.conversationHistory
              .map(msg => `${msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${msg.content}`)
              .join('\n');
            conversationHistoryContext += chatSummary + '\n';
          }
        });

        conversationHistoryContext += '\nâ†’ ì´ì „ ëŒ€í™”ì—ì„œ ì‚¬ìš©ìì˜ ì„ í˜¸ë„, ë¶ˆí¸í•¨, í”¼ë“œë°±ì„ ì°¸ê³ í•˜ì—¬ ì˜¤ëŠ˜ì˜ ì¶”ì²œì— ë°˜ì˜í•˜ì„¸ìš”.\n';
      }

      // === STEP 1: ë°ì´í„° ë¶„ì„ AI ===
      const analysisPrompt = `ë‹¹ì‹ ì€ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ìš´ë™ ê¸°ë¡ì„ ë¶„ì„í•˜ê³  í•µì‹¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

**ë¶„ì„ ëª©ì :**
- ìš´ë™ íŒ¨í„´ê³¼ íŠ¸ë Œë“œ íŒŒì•…
- ê°•ì ê³¼ ì•½ì  ì‹ë³„
- ë°œì „ë„ í‰ê°€
- ë°¸ëŸ°ìŠ¤ ë¶„ì„

**ì¶œë ¥ í˜•ì‹ (JSON í˜•íƒœë¡œ êµ¬ì¡°í™”):**
{
  "patterns": "ì£¼ìš” ìš´ë™ íŒ¨í„´ (ì˜ˆ: ì£¼ 3-4íšŒ ìš´ë™, í•˜ì²´ ìœ„ì£¼)",
  "strengths": "ê°•ì  (ì˜ˆ: ìŠ¤ì¿¼íŠ¸ ë¬´ê²Œ ê¾¸ì¤€íˆ ì¦ê°€, ê·œì¹™ì ì¸ ìš´ë™)",
  "weaknesses": "ì•½ì  ë˜ëŠ” ë¶€ì¡±í•œ ë¶€ë¶„ (ì˜ˆ: ìƒì²´ ìš´ë™ ë¶€ì¡±, ìœ ì‚°ì†Œ ìš´ë™ ì—†ìŒ)",
  "trends": "ë°œì „ íŠ¸ë Œë“œ (ì˜ˆ: ì§€ë‚œì£¼ ëŒ€ë¹„ ë¬´ê²Œ ì¦ê°€, ìš´ë™ ë¹ˆë„ ì¦ê°€)",
  "balance": "ìš´ë™ ë°¸ëŸ°ìŠ¤ í‰ê°€ (ì˜ˆ: ê·¼ë ¥ 70% / ìœ ì‚°ì†Œ 30%)",
  "risk": "ì£¼ì˜ì‚¬í•­ (ì˜ˆ: ê°™ì€ ë¶€ìœ„ ì—°ì†, íœ´ì‹ ë¶€ì¡±)"
}

ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ê³ , ë°ì´í„°ì— ê¸°ë°˜í•œ ê°ê´€ì ì¸ ë¶„ì„ì„ ì œê³µí•˜ì„¸ìš”.`;

      console.log('[STEP 1] ë°ì´í„° ë¶„ì„ ì¤‘...');
      const analysisResult = await generateTextWithAI(
        analysisPrompt,
        workoutSummary,
        { temperature: 0.3, maxTokens: 800, provider: 'gemini' } // ë¶„ì„ì€ Gemini ì‚¬ìš©
      );

      console.log('[STEP 1] ë¶„ì„ ì™„ë£Œ:', analysisResult);

      // === STEP 2: ì¶”ì²œ ìƒì„± AI ===
      const feelingContext = todayFeeling.trim()
        ? `\n\n**ì˜¤ëŠ˜ì˜ ì»¨ë””ì…˜:**\n${todayFeeling}\n`
        : '';

      const recommendPrompt = profile
        ? `ë‹¹ì‹ ì€ ì¹œì ˆí•œ í”¼íŠ¸ë‹ˆìŠ¤ ì½”ì¹˜ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ìš´ë™ ëª©í‘œì™€ ë°ì´í„° ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì˜¤ëŠ˜ì˜ ìš´ë™ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.

**ì‚¬ìš©ì ìš´ë™ ëª©í‘œ:**
${profile.goals}${feelingContext}

**ë°ì´í„° ë¶„ì„ ê²°ê³¼:**
${analysisResult}${conversationHistoryContext}

**ì¶”ì²œ ì‘ì„± ê°€ì´ë“œ:**
1. ë¶„ì„ ìš”ì•½ (2-3ë¬¸ì¥): ìµœê·¼ ìš´ë™ì„ ì¹­ì°¬í•˜ê³ , ê°•ì ê³¼ ê°œì„ ì ì„ ì–¸ê¸‰
2. ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì´ìœ : ì™œ ì´ ìš´ë™ë“¤ì„ ì¶”ì²œí•˜ëŠ”ì§€ (ëª©í‘œ, ì»¨ë””ì…˜, ë°¸ëŸ°ìŠ¤ ê³ ë ¤)
3. êµ¬ì²´ì ì¸ ìš´ë™ ë¦¬ìŠ¤íŠ¸:
   - ìš´ë™ëª… ë¬´ê²Œkg ì„¸íŠ¸ìˆ˜ì„¸íŠ¸ íšŸìˆ˜íšŒ í˜•ì‹ìœ¼ë¡œ
   - ê° ìš´ë™ì— ëŒ€í•œ ê°„ë‹¨í•œ íŒ (í•œ ì¤„)
4. ë§ˆë¬´ë¦¬ ê²©ë ¤ (1-2ë¬¸ì¥)

**ì£¼ì˜ì‚¬í•­:**
- ì‚¬ìš©ì ëª©í‘œë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤
- ì˜¤ëŠ˜ ì»¨ë””ì…˜ì— ë§ì¶° ê°•ë„ ì¡°ì ˆ
- ë°œì „ ê°€ëŠ¥í•˜ì§€ë§Œ ë¬´ë¦¬í•˜ì§€ ì•ŠëŠ” ìˆ˜ì¤€
- ì¹œê·¼í•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤

ìš´ë™ ë¦¬ìŠ¤íŠ¸ëŠ” ë°˜ë“œì‹œ ëª…í™•í•œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`
        : `ë‹¹ì‹ ì€ ì¹œì ˆí•œ í”¼íŠ¸ë‹ˆìŠ¤ ì½”ì¹˜ì…ë‹ˆë‹¤. ë°ì´í„° ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì˜¤ëŠ˜ì˜ ìš´ë™ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.${feelingContext}

**ë°ì´í„° ë¶„ì„ ê²°ê³¼:**
${analysisResult}${conversationHistoryContext}

**ì¶”ì²œ ì‘ì„± ê°€ì´ë“œ:**
1. ë¶„ì„ ìš”ì•½ (2-3ë¬¸ì¥): ìµœê·¼ ìš´ë™ì„ ì¹­ì°¬í•˜ê³ , ê°•ì ê³¼ ê°œì„ ì ì„ ì–¸ê¸‰
2. ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì´ìœ : ì™œ ì´ ìš´ë™ë“¤ì„ ì¶”ì²œí•˜ëŠ”ì§€ (ì»¨ë””ì…˜, ë°¸ëŸ°ìŠ¤ ê³ ë ¤)
3. êµ¬ì²´ì ì¸ ìš´ë™ ë¦¬ìŠ¤íŠ¸:
   - ìš´ë™ëª… ë¬´ê²Œkg ì„¸íŠ¸ìˆ˜ì„¸íŠ¸ íšŸìˆ˜íšŒ í˜•ì‹ìœ¼ë¡œ
   - ê° ìš´ë™ì— ëŒ€í•œ ê°„ë‹¨í•œ íŒ (í•œ ì¤„)
4. ë§ˆë¬´ë¦¬ ê²©ë ¤ (1-2ë¬¸ì¥)

**ì£¼ì˜ì‚¬í•­:**
- ì˜¤ëŠ˜ ì»¨ë””ì…˜ì— ë§ì¶° ê°•ë„ ì¡°ì ˆ
- ë°œì „ ê°€ëŠ¥í•˜ì§€ë§Œ ë¬´ë¦¬í•˜ì§€ ì•ŠëŠ” ìˆ˜ì¤€
- ì¹œê·¼í•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤

ìš´ë™ ë¦¬ìŠ¤íŠ¸ëŠ” ë°˜ë“œì‹œ ëª…í™•í•œ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

      console.log('[STEP 2] ì¶”ì²œ ìƒì„± ì¤‘...');
      const aiProvider = getDefaultProvider();
      console.log(`[STEP 2] ì‚¬ìš© AI: ${aiProvider}`);

      const recommendationText = await generateTextWithAI(
        recommendPrompt,
        `ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì˜¤ëŠ˜ì˜ ìš´ë™ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.`,
        {
          temperature: 0.8,
          maxTokens: 1500,
          provider: aiProvider
        }
      );

      console.log('[STEP 2] ì¶”ì²œ ì™„ë£Œ');

      if (recommendationText) {
        // ë¶„ì„ê³¼ ì¶”ì²œ ê²°ê³¼ ì €ì¥
        setCurrentAnalysis(analysisResult);
        setCurrentRecommendation(recommendationText);

        // ëŒ€í™”í˜• ì¶”ì²œ ëª¨ë“œë¡œ ì „í™˜
        const initialMessage: ChatMessage = {
          role: 'assistant',
          content: recommendationText + '\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nì–´ë– ì‹ ê°€ìš”? ğŸ¤”\n\nì¡°ì •ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆìœ¼ë©´ í¸í•˜ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”!\n\nğŸ’¬ ì˜ˆì‹œ:\nâ€¢ "ë‹¤ë¦¬ê°€ ì•„íŒŒì„œ í•˜ì²´ ìš´ë™ ë¹¼ì£¼ì„¸ìš”"\nâ€¢ "ìŠ¤ì¿¼íŠ¸ ë¬´ê²Œ ë„ˆë¬´ ë†’ì•„ìš”"\nâ€¢ "ì‹œê°„ì´ 30ë¶„ë°–ì— ì—†ì–´ìš”"\nâ€¢ "ìœ ì‚°ì†Œ ìš´ë™ ì¶”ê°€í•´ì£¼ì„¸ìš”"\nâ€¢ "ë” ê°•í•˜ê²Œ í•´ì£¼ì„¸ìš”"\n\nì™„ë²½í•˜ì‹œë©´ "í™•ì •" ë˜ëŠ” "ì¢‹ì•„ìš”"ë¼ê³  ë§ì”€í•´ì£¼ì„¸ìš”! âœ…',
          timestamp: Date.now(),
        };

        setRecommendationChatMessages([initialMessage]);
        setViewMode('recommendation-chat');
      } else {
        throw new Error('ì¶”ì²œ ê²°ê³¼ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (err) {
      console.error('Recommendation error:', err);
      setError(`ì¶”ì²œ ìƒì„± ì‹¤íŒ¨: ${err instanceof Error ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
      setViewMode('ready');
    }
  };

  const handleRecommendationChatSubmit = async () => {
    if (!recommendationChatInput.trim()) return;

    const userMessage: ChatMessage = {
      role: 'user',
      content: recommendationChatInput,
      timestamp: Date.now(),
    };

    const newMessages = [...recommendationChatMessages, userMessage];
    setRecommendationChatMessages(newMessages);
    setRecommendationChatInput('');
    setIsRecommendationChatProcessing(true);

    try {
      // ëŒ€í™” ë§¥ë½ êµ¬ì„±
      const conversationContext = newMessages
        .map((m) => `${m.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${m.content}`)
        .join('\n');

      const systemPrompt = `ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ ì „ë¬¸ í¼ìŠ¤ë„ íŠ¸ë ˆì´ë„ˆì…ë‹ˆë‹¤. ì¹œì ˆí•˜ë˜ ê°•ë‹¨ìˆê²Œ, ì‚¬ìš©ìì˜ ëª©í‘œ ë‹¬ì„±ì„ ìµœìš°ì„ ìœ¼ë¡œ ì¡°ì–¸í•©ë‹ˆë‹¤.

**ì›ë˜ ë¶„ì„ ê²°ê³¼:**
${currentAnalysis}

**í˜„ì¬ ì¶”ì²œ:**
${currentRecommendation}

**ì‚¬ìš©ì í”„ë¡œí•„:**
${profile?.goals || 'ì •ë³´ ì—†ìŒ'}

**í•µì‹¬ ì›ì¹™ (ì ˆëŒ€ ì§€ì¼œì•¼ í•¨):**

1. **ì‚¬ìš©ì ëª©í‘œë¥¼ ìµœìš°ì„ ìœ¼ë¡œ!**
   - ëª©í‘œ: ${profile?.goals || 'ì •ë³´ ì—†ìŒ'}
   - ëª¨ë“  ì¡°ì •ì€ ì´ ëª©í‘œ ë‹¬ì„±ì— ë„ì›€ì´ ë˜ì–´ì•¼ í•¨
   - ëª©í‘œì™€ ë§ì§€ ì•ŠëŠ” ìš”ì²­ì€ ì „ë¬¸ê°€ë¡œì„œ ë°˜ëŒ€ ì˜ê²¬ ì œì‹œ
   - ì˜ˆ: ìŠ¤ë…¸ë³´ë“œê°€ ëª©í‘œì¸ë° ìƒì²´ë§Œ í•˜ê² ë‹¤ â†’ "í•˜ì²´ ê·¼ë ¥ì´ ìŠ¤ë…¸ë³´ë“œì— í•„ìˆ˜ì…ë‹ˆë‹¤. ëŒ€ì‹  ë¬´ê²Œë¥¼ ë‚®ì¶°ë³´ë©´ ì–´ë–¨ê¹Œìš”?"

2. **ë°¸ëŸ°ìŠ¤ ìˆëŠ” ì„±ì¥ ê°•ì¡°!**
   - íŠ¹ì • ë¶€ìœ„ë§Œ ê³¼ë„í•˜ê²Œ í•˜ê±°ë‚˜ ë¹¼ëŠ” ê²ƒì€ ê¶Œì¥í•˜ì§€ ì•ŠìŒ
   - ì‚¬ìš©ìê°€ ìš´ë™ì„ ë¹¼ìê³  í•˜ë©´ â†’ ì™œ í•„ìš”í•œì§€ ì„¤ëª… í›„ ëŒ€ì•ˆ ì œì‹œ
   - ì „ì‹  ê· í˜•, ë¶€ìƒ ë°©ì§€, ëª©í‘œ ë‹¬ì„±ì„ ê³ ë ¤í•œ ì¡°ì–¸

3. **ì „ë¬¸ê°€ë‹µê²Œ ê°•ë‹¨ìˆê²Œ!**
   - ë‹¨ìˆœíˆ ìš”ì²­ëŒ€ë¡œ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”
   - ì˜ëª»ëœ ìš”ì²­: "ì´ ìš´ë™ì€ ë‹¹ì‹ ì˜ ëª©í‘œì— ì¤‘ìš”í•©ë‹ˆë‹¤. ëŒ€ì‹  ì´ë ‡ê²Œ ì¡°ì •í•˜ë©´ ì–´ë–¨ê¹Œìš”?"
   - ì˜¬ë°”ë¥¸ ìš”ì²­: ìˆ˜ìš©í•˜ë˜, ì¶”ê°€ ì¡°ì–¸ ì œê³µ
   - ì˜ˆ: "ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ë¡œ ë°”ê¾¸ê³  ì‹¶ì–´ìš”" â†’ "ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ë„ ì¢‹ì§€ë§Œ, ì¼ë°˜ ìŠ¤ì¿¼íŠ¸ê°€ ìŠ¤ë…¸ë³´ë“œì— ë” íš¨ê³¼ì ì…ë‹ˆë‹¤. ë¬´ê²Œë¥¼ ë‚®ì¶°ì„œ ê³„ì†í•˜ì‹œë©´ ì–´ë–¨ê¹Œìš”? ì • ì›í•˜ì‹œë©´ ê³ ë¸”ë¦¿ìœ¼ë¡œë„ ê°€ëŠ¥í•˜ì§€ë§Œ, ë¬´ê²ŒëŠ” ë” ë‚®ì¶°ì•¼ í•©ë‹ˆë‹¤."

4. **ìš´ë™ ì¢…ë¥˜ëŠ” ì‹ ì¤‘í•˜ê²Œ ë³€ê²½!**
   - ì‚¬ìš©ìê°€ ëª…í™•íˆ ìš”ì²­í•´ë„, ëª©í‘œì— ë§ì§€ ì•Šìœ¼ë©´ ë°˜ëŒ€ ì˜ê²¬ ì œì‹œ
   - ë¬´ê²Œ/ì„¸íŠ¸/íšŸìˆ˜ë§Œ ì¡°ì •í•˜ëŠ” ê²ƒì„ ìš°ì„  ì œì•ˆ
   - ì˜ˆ: "ìŠ¤ì¿¼íŠ¸ 60kg ë„ˆë¬´ ë†’ì•„ìš”" â†’ ìŠ¤ì¿¼íŠ¸ 10kgìœ¼ë¡œ ì¡°ì • (ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ë¡œ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”!)

5. **ë¬¸ë§¥ì„ ì •í™•íˆ íŒŒì•…!**
   - ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ìš´ë™ì„ ì–¸ê¸‰í•˜ëŠ” ê²ƒì€ ì¢…ì¢… "ë¹„êµ/ì°¸ê³ "ì…ë‹ˆë‹¤
   - ì˜ˆ: "ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ 12kgë„ í˜ë“¤ì—ˆì–´ìš”" â†’ ì´ê±´ ìŠ¤ì¿¼íŠ¸ ë¬´ê²Œê°€ ê³¼í•˜ë‹¤ëŠ” ê·¼ê±°
     â†’ ì˜¬ë°”ë¥¸ ëŒ€ì‘: ìŠ¤ì¿¼íŠ¸ë¥¼ 10-12kgìœ¼ë¡œ ë‚®ì¶¤ (ë¤ë²¨ ì–‘ì† 5-6kg)
     â†’ ì˜ëª»ëœ ëŒ€ì‘: ìŠ¤ì¿¼íŠ¸ë¥¼ ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ë¡œ ë°”ê¿ˆ âŒ

6. **ë¬´ê²Œ ì¡°ì • ê¸°ì¤€:**
   - ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ìš´ë™ì˜ ë¬´ê²Œë¥¼ ì–¸ê¸‰í•˜ë©´, ê·¸ê²ƒì„ ì°¸ê³ ë¡œ ì ì • ë¬´ê²Œë¥¼ ì¶”ì •
   - "ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ 12kg í˜ë“¤ì—ˆì–´ìš”" â†’ ì¼ë°˜ ìŠ¤ì¿¼íŠ¸ëŠ” 10-15kg ì ë‹¹
   - "ë²¤ì¹˜í”„ë ˆìŠ¤ 40kg ì—¬ìœ ìˆì–´ìš”" â†’ 40kg ì´ìƒ ì œì•ˆ

**ëŒ€í™” ê·œì¹™:**

**1. ë¬´ê²Œ ì¡°ì ˆ í”¼ë“œë°±:**
   - "ë¬´ê²Œ ë„ˆë¬´ ë†’ì•„ìš”" / "XXkgë„ í˜ë“¤ì–´ìš”"
     â†’ í˜„ì¬ ì¶”ì²œ ë¬´ê²Œì—ì„œ 20-30% ë‚®ì¶¤
     â†’ ìš´ë™ ì¢…ë¥˜ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€!
   - "ë„ˆë¬´ ì‰¬ì›Œìš”" / "ë” ë¹¡ì„¸ê²Œ"
     â†’ ë¬´ê²Œ 10-15% ì¦ëŸ‰ ë˜ëŠ” ì„¸íŠ¸ ì¶”ê°€
   - ì‚¬ìš©ìê°€ ì°¸ê³ ë¡œ ë‹¤ë¥¸ ìš´ë™ ë¬´ê²Œë¥¼ ì–¸ê¸‰í•˜ë©´, ê·¸ ë¬´ê²Œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì ì •ì„ ì„ ì°¾ìœ¼ì„¸ìš”

**2. ì‹ ì²´ ë¶ˆí¸ ê´€ë ¨:**
   - "ë‹¤ë¦¬/ë¬´ë¦ ì•„íŒŒìš”" â†’ í•˜ì²´ ìš´ë™ ë¬´ê²Œ 30-40% ë‚®ì¶¤ ë˜ëŠ” ì œì™¸, ëŒ€ì²´ ìš´ë™ ì œì•ˆ
   - "í—ˆë¦¬ ë»ê·¼í•´ìš”" â†’ ìŠ¤ì¿¼íŠ¸/ë°ë“œë¦¬í”„íŠ¸ ì œì™¸í•˜ê±°ë‚˜ ë¬´ê²Œ ëŒ€í­ ë‚®ì¶¤, ì½”ì–´ ìš´ë™ ì¶”ê°€
   - "ì–´ê¹¨ ì•„íŒŒìš”" â†’ ìˆ„ë”í”„ë ˆìŠ¤ ì œì™¸, ê°€ë²¼ìš´ ì‚¬ì´ë“œë ˆí„°ëŸ´ ì œì•ˆ
   - ëª…í™•í•œ ìš”ì²­ì´ ì•„ë‹ˆë©´ ìš´ë™ ì¢…ë¥˜ëŠ” ìœ ì§€í•˜ê³  ë¬´ê²Œë§Œ ì¡°ì •!

**3. ì‹œê°„ ê´€ë ¨:**
   - "ì‹œê°„ì´ 30ë¶„ë°–ì— ì—†ì–´ìš”" â†’ í•µì‹¬ 3-4ê°œë§Œ ë‚¨ê¸°ê³  ìŠˆí¼ì…‹ ì œì•ˆ
   - "ë¹¨ë¦¬ ëë‚´ê³  ì‹¶ì–´ìš”" â†’ HIIT ìŠ¤íƒ€ì¼ ì œì•ˆ

**4. ìš´ë™ ì„ í˜¸ë„ (ëª…í™•í•œ ìš”ì²­ë§Œ):**
   - "ìŠ¤ì¿¼íŠ¸ ì‹«ì–´ìš”" / "ìŠ¤ì¿¼íŠ¸ ë¹¼ì£¼ì„¸ìš”" â†’ ë ˆê·¸í”„ë ˆìŠ¤, ëŸ°ì§€ ë“±ìœ¼ë¡œ ëŒ€ì²´
   - "ìœ ì‚°ì†Œ ì¶”ê°€í•´ì£¼ì„¸ìš”" â†’ ëŸ¬ë‹, ìì „ê±° ì¶”ê°€
   - ëª…í™•í•œ ëŒ€ì²´ ìš”ì²­ì´ ì—†ìœ¼ë©´ ì›ë˜ ìš´ë™ ìœ ì§€!

**5. ì»¨ë””ì…˜ ê´€ë ¨:**
   - "í”¼ê³¤í•´ìš”" â†’ ì „ì²´ ë¬´ê²Œ 20% ë‚®ì¶¤
   - "ì—ë„ˆì§€ ë„˜ì³ìš”" â†’ ë¬´ê²Œ/ì„¸íŠ¸ ì¦ê°€

**ì‘ë‹µ í˜•ì‹ (ì „ë¬¸ê°€ë‹µê²Œ):**
1. í”¼ë“œë°± ì´í•´ í™•ì¸ (ê³µê°í•˜ë˜ ì „ë¬¸ì ìœ¼ë¡œ)
2. ì „ë¬¸ê°€ ì˜ê²¬ ì œì‹œ
   - ìš”ì²­ì´ ëª©í‘œì— ë¶€í•©í•˜ë©´: "ì¢‹ì€ ì„ íƒì…ë‹ˆë‹¤. ~ë•Œë¬¸ì— íš¨ê³¼ì ì…ë‹ˆë‹¤."
   - ìš”ì²­ì´ ëª©í‘œì— ë§ì§€ ì•Šìœ¼ë©´: "ì´í•´í•˜ì§€ë§Œ, ~ë•Œë¬¸ì— ê¶Œì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  ì´ë ‡ê²Œ í•˜ë©´ ì–´ë–¨ê¹Œìš”?"
3. ì¡°ì • ë‚´ìš© ëª…í™•íˆ ì„¤ëª… (ì™œ ì´ë ‡ê²Œ í•˜ëŠ”ì§€)
4. ìˆ˜ì •ëœ ìš´ë™ ëª©ë¡ (í˜•ì‹: "ìš´ë™ëª… ë¬´ê²Œkg ì„¸íŠ¸ìˆ˜ì„¸íŠ¸ íšŸìˆ˜íšŒ")
5. ëª©í‘œ ë‹¬ì„±ì„ ìœ„í•œ ì¶”ê°€ ì¡°ì–¸
6. ê°•ë‹¨ìˆê²Œ ë§ˆë¬´ë¦¬: "ì´ë ‡ê²Œ í•˜ì‹œë©´ ~ëª©í‘œì— ë” ê°€ê¹Œì›Œì§‘ë‹ˆë‹¤. ì–´ë– ì‹ ê°€ìš”?"

**ì˜ëª»ëœ ì˜ˆì‹œ (ìœ ìˆœí•œ ì½”ì¹˜ - í•˜ì§€ ë§ˆì„¸ìš”):**
âŒ ì‚¬ìš©ì: "ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ë¡œ ë°”ê¾¸ê³  ì‹¶ì–´ìš”"
   AI: "ë„¤, ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ 8kgìœ¼ë¡œ ë°”ê¾¸ê² ìŠµë‹ˆë‹¤!"
   (â†’ ëª©í‘œ ê³ ë ¤ ì—†ì´ ë¬´ì¡°ê±´ ìˆ˜ìš©)

âŒ ì‚¬ìš©ì: "í•˜ì²´ ìš´ë™ ë¹¼ì£¼ì„¸ìš”"
   AI: "ì•Œê² ìŠµë‹ˆë‹¤! í•˜ì²´ ìš´ë™ ì œì™¸í•˜ê² ìŠµë‹ˆë‹¤."
   (â†’ ìŠ¤ë…¸ë³´ë“œ ëª©í‘œì— í•„ìˆ˜ì¸ë° ë¹¼ì¤Œ)

**ì˜¬ë°”ë¥¸ ì˜ˆì‹œ (ì „ë¬¸ê°€ ì½”ì¹˜ - ì´ë ‡ê²Œ í•˜ì„¸ìš”):**
âœ… ì‚¬ìš©ì: "ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ë¡œ ë°”ê¾¸ê³  ì‹¶ì–´ìš”"
   AI: "ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ë¡œ ë°”ê¾¸ê³  ì‹¶ìœ¼ì‹  ì´ìœ ë¥¼ ì´í•´í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ìŠ¤ë…¸ë³´ë“œë¥¼ ìœ„í•´ì„œëŠ” ì¼ë°˜ ìŠ¤ì¿¼íŠ¸ê°€ ë” íš¨ê³¼ì ì…ë‹ˆë‹¤. ê³ ë¸”ë¦¿ì€ ì „ë©´ë¶€ ì¤‘ì‹¬ì´ì§€ë§Œ, ìŠ¤ì¿¼íŠ¸ëŠ” í›„ë©´ ì²´ì¸ ì „ì²´ë¥¼ ê°•í™”í•´ ìŠ¤ë…¸ë³´ë“œ í„´ì— í•„ìˆ˜ì ì¸ í˜ì„ ê¸°ë¦…ë‹ˆë‹¤.

   ëŒ€ì‹  ë¬´ê²Œë¥¼ 12kg (ë¤ë²¨ ì–‘ì† 6kg)ìœ¼ë¡œ ë‚®ì¶°ì„œ ìŠ¤ì¿¼íŠ¸ë¥¼ ê³„ì†í•˜ì‹œë©´ ì–´ë–¨ê¹Œìš”? ì • ì›í•˜ì‹œë©´ ê³ ë¸”ë¦¿ìœ¼ë¡œë„ ê°€ëŠ¥í•˜ì§€ë§Œ, ê·¸ëŸ´ ê²½ìš° ë¬´ê²Œë¥¼ 8kgìœ¼ë¡œ ë” ë‚®ì¶°ì•¼ í•˜ê³ , ìŠ¤ë…¸ë³´ë“œ ëª©í‘œ ë‹¬ì„±ì€ ì¡°ê¸ˆ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ í•˜ì‹œê² ì–´ìš”?"

âœ… ì‚¬ìš©ì: "í•˜ì²´ ë„ˆë¬´ í˜ë“¤ì–´ìš”. ë¹¼ì£¼ì„¸ìš”"
   AI: "ìµœê·¼ í•˜ì²´ ìš´ë™ì´ ë§ì•„ì„œ í˜ë“œì‹  ê²ƒ ì´í•´í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ìŠ¤ë…¸ë³´ë“œëŠ” 80%ê°€ í•˜ì²´ ê·¼ë ¥ì…ë‹ˆë‹¤. ì™„ì „íˆ ë¹¼ë©´ ëª©í‘œ ë‹¬ì„±ì´ ì–´ë ¤ì›Œì§‘ë‹ˆë‹¤.

   ëŒ€ì‹  ì´ë ‡ê²Œ ì¡°ì •í•˜ë©´ ì–´ë–¨ê¹Œìš”?
   1. í•˜ì²´ ìš´ë™ ë¬´ê²Œë¥¼ 30% ë‚®ì¶¤
   2. ì„¸íŠ¸ ìˆ˜ë¥¼ ì¤„ì„ (4ì„¸íŠ¸ â†’ 3ì„¸íŠ¸)
   3. íšŒë³µì„ ìœ„í•œ ìŠ¤íŠ¸ë ˆì¹­ ì¶”ê°€

   ì´ë ‡ê²Œ í•˜ë©´ ë¶€ë‹´ì€ ì¤„ì´ë©´ì„œë„ ìŠ¤ë…¸ë³´ë“œì— í•„ìš”í•œ ê·¼ë ¥ì€ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì–´ë– ì‹ ê°€ìš”?"

**í™•ì • ì¡°ê±´:**
"ì¢‹ì•„ìš”", "í™•ì •", "ì´ëŒ€ë¡œ í• ê²Œìš”", "ëì–´ìš”", "ì™„ë²½í•´ìš”", "ê°ˆê²Œìš”", "ì‹œì‘í• ê²Œìš”"
â†’ "ì™„ë²½í•©ë‹ˆë‹¤! ì˜¤ëŠ˜ ìš´ë™ íŒŒì´íŒ…í•˜ì„¸ìš”! ğŸ’ª Todoë¡œ ì €ì¥í•˜ì‹œê² ì–´ìš”? [FINALIZE]"

**ì ˆëŒ€ ì›ì¹™:**
- ìš´ë™ ê¸°ë¡ì˜ ë‹¤ë¥¸ ìš´ë™ ë¬´ê²ŒëŠ” "ì°¸ê³  ì •ë³´"ì…ë‹ˆë‹¤. ìš”ì²­ì´ ì•„ë‹™ë‹ˆë‹¤!
- ëª…í™•í•œ ëŒ€ì²´ ìš”ì²­ì´ ì—†ìœ¼ë©´ ìš´ë™ ì¢…ë¥˜ë¥¼ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”!
- ë¬´ê²Œë§Œ ì¡°ì •í•˜ì„¸ìš”!`;

      const aiResponse = await generateTextWithAI(
        systemPrompt,
        conversationContext,
        { temperature: 0.7, maxTokens: 500 }
      );

      const assistantMessage: ChatMessage = {
        role: 'assistant',
        content: aiResponse,
        timestamp: Date.now(),
      };

      setRecommendationChatMessages([...newMessages, assistantMessage]);

      // ì¶”ì²œ ì—…ë°ì´íŠ¸
      if (!aiResponse.includes('[FINALIZE]')) {
        // ì¡°ì •ëœ ë‚´ìš©ì„ í˜„ì¬ ì¶”ì²œì— ë°˜ì˜
        setCurrentRecommendation(currentRecommendation + '\n\n--- ì¡°ì • ë‚´ìš© ---\n' + aiResponse);
      }
    } catch (error) {
      console.error('[Recommendation Chat] Error:', error);
      setError('ëŒ€í™” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsRecommendationChatProcessing(false);
    }
  };

  const handleFinalizeRecommendation = async () => {
    const existingTodo = getTodayTodo();

    if (existingTodo) {
      if (!confirm('ì˜¤ëŠ˜ì˜ Todoê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
    }

    try {
      // ìµœì¢… ì¶”ì²œì—ì„œ ìš´ë™ íŒŒì‹±
      const parsedWorkouts = parseRecommendationToWorkouts(currentRecommendation);

      if (parsedWorkouts.length === 0) {
        // íŒŒì‹± ì‹¤íŒ¨ ì‹œ AIì—ê²Œ ì¬ìš”ì²­
        const systemPrompt = `ë‹¤ìŒ ìš´ë™ ì¶”ì²œ í…ìŠ¤íŠ¸ì—ì„œ êµ¬ì²´ì ì¸ ìš´ë™ ëª©ë¡ë§Œ ì¶”ì¶œí•´ì£¼ì„¸ìš”.
ê° ì¤„ë§ˆë‹¤ í•˜ë‚˜ì˜ ìš´ë™ì„ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±:
ìš´ë™ëª… ë¬´ê²Œkg ì„¸íŠ¸ìˆ˜ì„¸íŠ¸ íšŸìˆ˜íšŒ

ì˜ˆ:
ìŠ¤ì¿¼íŠ¸ 80kg 4ì„¸íŠ¸ 8íšŒ
ë²¤ì¹˜í”„ë ˆìŠ¤ 60kg 3ì„¸íŠ¸ 10íšŒ
ëŸ¬ë‹ 20ë¶„`;

        const structuredWorkouts = await generateTextWithAI(systemPrompt, currentRecommendation, {
          temperature: 0.3,
          maxTokens: 500,
        });

        const extractedWorkouts = parseRecommendationToWorkouts(structuredWorkouts);

        if (extractedWorkouts.length === 0) {
          setError('ìš´ë™ ëª©ë¡ì„ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¶”ì²œ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          return;
        }

        saveTodoWithRecommendation(extractedWorkouts);
      } else {
        saveTodoWithRecommendation(parsedWorkouts);
      }
    } catch (err) {
      console.error('Finalize error:', err);
      setError('Todo ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  };

  const saveTodoWithRecommendation = (workouts: TodoWorkout[]) => {
    const todo: DailyTodo = {
      id: generateId(),
      date: formatDate(),
      source: 'ai_recommendation',
      aiRecommendation: {
        analysisResult: currentAnalysis,
        initialRecommendation: recommendationChatMessages[0]?.content || '',
        conversationHistory: recommendationChatMessages
          .filter((m) => m.role === 'user' || m.role === 'assistant')
          .map((m) => ({
            role: m.role as 'user' | 'assistant',
            content: m.content,
            timestamp: m.timestamp,
          })),
        finalRecommendation: currentRecommendation,
        userFeedback: recommendationChatMessages
          .filter((m) => m.role === 'user')
          .map((m) => m.content)
          .join('; '),
        finalizedAt: Date.now(),
      },
      workouts,
      createdAt: Date.now(),
    };

    try {
      saveTodo(todo);
      alert('ì˜¤ëŠ˜ì˜ Todoë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

      // ìƒíƒœ ì´ˆê¸°í™”
      setRecommendationChatMessages([]);
      setCurrentAnalysis('');
      setCurrentRecommendation('');
      setViewMode('ready');

      navigate('/todo');
    } catch (err) {
      setError('Todo ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };

  const analyzeWorkouts = (logs: WorkoutLog[]): string => {
    // 1. ê¸°ë³¸ í†µê³„
    const totalWorkouts = logs.reduce((sum, log) => sum + log.workouts.length, 0);
    const totalDays = logs.length;

    // 2. ìš´ë™ë³„ í†µê³„
    const workoutStats = new Map<string, {
      count: number;
      totalSets: number;
      totalReps: number;
      weights: number[];
      durations: number[];
      lastDate: string;
    }>();

    logs.forEach((log) => {
      log.workouts.forEach((workout) => {
        const existing = workoutStats.get(workout.name) || {
          count: 0,
          totalSets: 0,
          totalReps: 0,
          weights: [],
          durations: [],
          lastDate: log.date,
        };

        existing.count++;
        if (workout.sets) existing.totalSets += workout.sets;
        if (workout.reps) existing.totalReps += workout.reps;
        if (workout.weight_kg) existing.weights.push(workout.weight_kg);
        if (workout.duration_min) existing.durations.push(workout.duration_min);
        existing.lastDate = log.date;

        workoutStats.set(workout.name, existing);
      });
    });

    // 3. ìš´ë™ íƒ€ì…ë³„ ë¶„ì„
    const typeCount = new Map<string, number>();
    logs.forEach((log) => {
      log.workouts.forEach((workout) => {
        typeCount.set(workout.type, (typeCount.get(workout.type) || 0) + 1);
      });
    });

    // 4. êµ¬ì¡°í™”ëœ ìš”ì•½ ìƒì„±
    let summary = `=== ìš´ë™ ê¸°ë¡ ë¶„ì„ (ìµœê·¼ ${totalDays}ì¼) ===\n\n`;

    summary += `ğŸ“Š ì „ì²´ í†µê³„:\n`;
    summary += `- ì´ ìš´ë™ ì„¸ì…˜: ${totalDays}ì¼\n`;
    summary += `- ì´ ìš´ë™ ê°œìˆ˜: ${totalWorkouts}ê°œ\n`;
    summary += `- ì¼í‰ê·  ìš´ë™: ${(totalWorkouts / totalDays).toFixed(1)}ê°œ\n\n`;

    summary += `ğŸ’ª ì£¼ìš” ìš´ë™ (ë¹ˆë„ìˆœ):\n`;
    const sortedWorkouts = Array.from(workoutStats.entries())
      .sort((a, b) => b[1].count - a[1].count)
      .slice(0, 5);

    sortedWorkouts.forEach(([name, stats]) => {
      summary += `- ${name}: ${stats.count}íšŒ`;

      if (stats.weights.length > 0) {
        const avgWeight = stats.weights.reduce((a, b) => a + b, 0) / stats.weights.length;
        const maxWeight = Math.max(...stats.weights);
        const minWeight = Math.min(...stats.weights);
        summary += ` | ë¬´ê²Œ ${minWeight}~${maxWeight}kg (í‰ê·  ${avgWeight.toFixed(1)}kg)`;

        // ë°œì „ë„ ë¶„ì„
        if (stats.weights.length >= 3) {
          const recent = stats.weights.slice(-2).reduce((a, b) => a + b, 0) / 2;
          const old = stats.weights.slice(0, 2).reduce((a, b) => a + b, 0) / 2;
          const trend = recent - old;
          if (trend > 0) summary += ` ğŸ“ˆ ${trend.toFixed(1)}kg ì¦ê°€`;
          else if (trend < -1) summary += ` ğŸ“‰ ${Math.abs(trend).toFixed(1)}kg ê°ì†Œ`;
        }
      }

      if (stats.totalSets > 0) {
        summary += ` | í‰ê·  ${(stats.totalSets / stats.count).toFixed(1)}ì„¸íŠ¸`;
      }

      if (stats.durations.length > 0) {
        const avgDuration = stats.durations.reduce((a, b) => a + b, 0) / stats.durations.length;
        summary += ` | í‰ê·  ${avgDuration.toFixed(1)}ë¶„`;
      }

      summary += ` (ë§ˆì§€ë§‰: ${stats.lastDate})\n`;
    });

    summary += `\nğŸ¯ ìš´ë™ íƒ€ì… ë¶„í¬:\n`;
    const sortedTypes = Array.from(typeCount.entries())
      .sort((a, b) => b[1] - a[1]);
    sortedTypes.forEach(([type, count]) => {
      const percentage = ((count / totalWorkouts) * 100).toFixed(0);
      summary += `- ${type}: ${count}íšŒ (${percentage}%)\n`;
    });

    // 5. ìµœê·¼ 3ì¼ ìƒì„¸ ê¸°ë¡
    summary += `\nğŸ“… ìµœê·¼ 3ì¼ ìƒì„¸:\n`;
    logs.slice(0, 3).forEach((log, index) => {
      summary += `${index + 1}. ${log.date}\n`;
      log.workouts.forEach((workout) => {
        summary += `   â€¢ ${workout.name}`;
        if (workout.weight_kg) summary += ` ${workout.weight_kg}kg`;
        if (workout.sets && workout.reps) summary += ` ${workout.sets}ì„¸íŠ¸Ã—${workout.reps}íšŒ`;
        if (workout.duration_min) summary += ` ${workout.duration_min}ë¶„`;
        summary += `\n`;
      });
    });

    return summary;
  };

  // Profile Chat View (ëŒ€í™”í˜• í”„ë¡œí•„ ì„¤ì •)
  if (viewMode === 'profile-chat') {
    return (
      <div className="container">
        <div className="recommend-header">
          <h1>í”„ë¡œí•„ ì„¤ì •</h1>
          <p className="subtitle">AIì™€ ëŒ€í™”í•˜ë©° ë§ì¶¤ í”„ë¡œí•„ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
        </div>

        <div className="chat-container">
          <div className="chat-messages">
            {profileChatMessages.map((msg, idx) => (
              <div key={idx} className={`chat-message ${msg.role}`}>
                <div className="message-content">{msg.content}</div>
              </div>
            ))}
            {isProfileChatProcessing && (
              <div className="chat-message assistant">
                <div className="message-content">
                  <div className="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>
              </div>
            )}
          </div>

          {isGeneratingProfile ? (
            <div className="chat-generating">
              <div className="spinner"></div>
              <p>í”„ë¡œí•„ ìƒì„± ì¤‘...</p>
            </div>
          ) : (
            <div className="chat-input-container">
              <textarea
                className="chat-input"
                value={profileChatInput}
                onChange={(e) => setProfileChatInput(e.target.value)}
                onKeyPress={(e) => {
                  if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleProfileChatSubmit();
                  }
                }}
                placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                rows={2}
                disabled={isProfileChatProcessing}
              />
              <button
                className="chat-send-button"
                onClick={handleProfileChatSubmit}
                disabled={isProfileChatProcessing || !profileChatInput.trim()}
              >
                ì „ì†¡
              </button>
            </div>
          )}
        </div>

        {error && (
          <div className="error-box">
            <p>{error}</p>
          </div>
        )}
      </div>
    );
  }

  // Ready View (í”„ë¡œí•„ ìˆìŒ, ì¶”ì²œ ë°›ì„ ì¤€ë¹„)
  if (viewMode === 'ready') {
    return (
      <div className="container">
        <div className="recommend-header">
          <h1>AI ìš´ë™ ì¶”ì²œ</h1>
          <p className="subtitle">ìµœê·¼ ìš´ë™ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ ì˜¤ëŠ˜ì˜ ìš´ë™ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤</p>
          {aiInfo && <p className="ai-info" style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '8px' }}>{aiInfo}</p>}
        </div>

        {profile && (
          <div className="profile-display">
            <div className="profile-header">
              <h3>ë‚´ ìš´ë™ í”„ë¡œí•„</h3>
              <div className="profile-actions">
                <button className="edit-button" onClick={handleEditProfile}>
                  ìˆ˜ì •
                </button>
                <button className="delete-icon-button" onClick={handleDeleteProfile}>
                  ì‚­ì œ
                </button>
              </div>
            </div>
            <div className="profile-content">{profile.goals}</div>
          </div>
        )}

        <div className="today-feeling-section">
          <h3>ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì€ ì–´ë– ì„¸ìš”?</h3>
          <textarea
            className="feeling-input"
            value={todayFeeling}
            onChange={(e) => setTodayFeeling(e.target.value)}
            placeholder="ì˜ˆ: ì–´ì œ ìš´ë™ í›„ ë‹¤ë¦¬ê°€ ë»ê·¼í•´ìš”. ì»¨ë””ì…˜ì€ ì¢‹ì€ë° í”¼ê³¤í•´ìš”. ì˜¤ëŠ˜ì€ ê°€ë³ê²Œ í•˜ê³  ì‹¶ì–´ìš”."
            rows={4}
          />
          <p className="feeling-hint">
            ì˜¤ëŠ˜ì˜ ì»¨ë””ì…˜, í”¼ë¡œë„, í†µì¦, ê¸°ë¶„ ë“±ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”. AIê°€ ê³ ë ¤í•´ì„œ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.
          </p>
        </div>

        <div className="recommend-cta">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor" opacity="0.3">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
          </svg>
          <p>AIê°€ ë‹¹ì‹ ì˜ ìš´ë™ ê¸°ë¡, ëª©í‘œ, ì»¨ë””ì…˜ì„ ë¶„ì„í•˜ì—¬</p>
          <p>ë§ì¶¤ ìš´ë™ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤</p>
          <button className="primary-button large-button" onClick={generateRecommendation}>
            ì¶”ì²œ ë°›ê¸°
          </button>
        </div>

        {error && (
          <div className="error-box">
            <p>{error}</p>
          </div>
        )}
      </div>
    );
  }

  // Loading View
  if (viewMode === 'loading') {
    return (
      <div className="container">
        <div className="recommend-loading">
          <div className="spinner"></div>
          <p>AIê°€ ìš´ë™ ê¸°ë¡ì„ ë¶„ì„í•˜ëŠ” ì¤‘...</p>
        </div>
      </div>
    );
  }

  // Recommendation Chat View (ëŒ€í™”í˜• ì¶”ì²œ)
  if (viewMode === 'recommendation-chat') {
    return (
      <div className="container">
        <div className="recommend-header">
          <h1>ìš´ë™ ì¶”ì²œ</h1>
          <p className="subtitle">AIì™€ ëŒ€í™”í•˜ë©° ì¶”ì²œì„ ì¡°ì •í•´ë³´ì„¸ìš”</p>
        </div>

        <div className="chat-container">
          <div className="chat-messages">
            {recommendationChatMessages.map((msg, idx) => (
              <div key={idx} className={`chat-message ${msg.role}`}>
                <div className="message-content">
                  {msg.content.split('\n').map((line, i) => (
                    <p key={i}>{line}</p>
                  ))}
                </div>
              </div>
            ))}
            {isRecommendationChatProcessing && (
              <div className="chat-message assistant">
                <div className="message-content">
                  <div className="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>
              </div>
            )}
          </div>

          <div className="chat-input-container">
            <textarea
              className="chat-input"
              value={recommendationChatInput}
              onChange={(e) => setRecommendationChatInput(e.target.value)}
              onKeyPress={(e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault();
                  handleRecommendationChatSubmit();
                }
              }}
              placeholder="í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ìŠ¤ì¿¼íŠ¸ ë¬´ê²Œ ë„ˆë¬´ ë†’ì•„ìš”, ì‹œê°„ ë¶€ì¡±í•´ìš”)"
              rows={2}
              disabled={isRecommendationChatProcessing}
            />
            <div className="chat-buttons">
              <button
                className="chat-finalize-button"
                onClick={handleFinalizeRecommendation}
                disabled={isRecommendationChatProcessing}
              >
                âœ“ í™•ì •í•˜ê³  Todo ì €ì¥
              </button>
              <button
                className="chat-send-button"
                onClick={handleRecommendationChatSubmit}
                disabled={isRecommendationChatProcessing || !recommendationChatInput.trim()}
              >
                ì „ì†¡
              </button>
            </div>
          </div>
        </div>

        {error && (
          <div className="error-box">
            <p>{error}</p>
          </div>
        )}
      </div>
    );
  }

  // ê¸°ë³¸ View (í˜¹ì‹œ ë‹¤ë¥¸ ìƒíƒœì¼ ê²½ìš°)
  return (
    <div className="container">
      <div className="recommend-loading">
        <div className="spinner"></div>
        <p>ë¡œë”© ì¤‘...</p>
      </div>
    </div>
  );
};
</file>

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(gh repo view:*)",
      "Bash(npm install:*)",
      "Bash(npm run dev:*)",
      "Bash(npm run build:*)",
      "Bash(git add:*)",
      "Bash(git restore:*)",
      "Bash(git commit:*)",
      "Bash(git push)",
      "WebSearch",
      "Bash(git fetch:*)",
      "Bash(git ls-tree:*)",
      "Bash(git checkout:*)",
      "Bash(git merge:*)",
      "Bash(git stash:*)",
      "Bash(git push:*)",
      "Bash(ls:*)",
      "Bash(npx tsc:*)",
      "Bash(git rm:*)",
      "Bash(npm uninstall:*)",
      "Bash(schema must be a JSON Schema of 'type: \"\"object\"\"', got 'type: \"\"string\"\"'\"\n\nThis was NOT a schema definition problem - the schema was correct.\nThe issue was Zod v4 incompatibility with OpenAI SDK v4.\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n\\)\")"
    ]
  }
}
</file>

<file path="src/storage/clubStorage.ts">
import type {
  Club,
  ClubWithMemberInfo,
  ClubDetail,
  ClubMemberWithUser,
  ClubFeedWithDetails,
  ClubChallenge,
  ChallengeDetailWithContributors,
  WorkoutLog,
} from '../types';
import type { HofBadge, SquadMember } from '../utils/dashboardLogic';
import { supabase } from '../lib/supabase';

export interface ClubDashboardData {
  badges: HofBadge[];
  squad: SquadMember[];
  leaderboards: {
    cardio: Array<{ userId: string; displayName: string; profileImage: string | null; value: number }>;
    strength: Array<{ userId: string; displayName: string; profileImage: string | null; value: number }>;
    snowboard: Array<{ userId: string; displayName: string; profileImage: string | null; value: number }>;
  };
}

// Get current user ID from localStorage
const getCurrentUserId = (): string => {
  const userStr = localStorage.getItem('current_user');
  if (!userStr) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  const user = JSON.parse(userStr);
  return user.id;
};

// Date formatter (YYYY-MM-DD)
export const formatDate = (date: Date = new Date()): string => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// ============================================
// Club CRUD Functions
// ============================================

export const createClub = async (data: {
  name: string;
  description?: string;
  is_public: boolean;
}): Promise<Club> => {
  try {
    const userId = getCurrentUserId();

    // 1. Create club
    const { data: club, error: clubError } = await supabase
      .from('clubs')
      .insert({
        name: data.name,
        description: data.description || null,
        is_public: data.is_public,
        owner_id: userId,
      })
      .select()
      .single();

    if (clubError) throw clubError;

    // 2. Add owner as member
    const { error: memberError } = await supabase
      .from('club_members')
      .insert({
        club_id: club.id,
        user_id: userId,
        role: 'owner',
      });

    if (memberError) throw memberError;

    return club;
  } catch (error) {
    console.error('í´ëŸ½ ìƒì„± ì‹¤íŒ¨:', error);
    throw new Error('í´ëŸ½ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const getMyClubs = async (): Promise<ClubWithMemberInfo[]> => {
  try {
    const userId = getCurrentUserId();

    const { data, error } = await supabase
      .from('club_members')
      .select(`
        id,
        role,
        joined_at,
        clubs (
          id,
          name,
          description,
          is_public,
          invite_code,
          owner_id,
          created_at,
          updated_at
        )
      `)
      .eq('user_id', userId)
      .order('joined_at', { ascending: false });

    if (error) throw error;

    return (data || []).map((item: any) => ({
      ...(item.clubs as Club),
      my_role: item.role,
      joined_at: item.joined_at,
    }));
  } catch (error) {
    console.error('í´ëŸ½ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('í´ëŸ½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const searchPublicClubs = async (query?: string): Promise<Club[]> => {
  try {
    let queryBuilder = supabase
      .from('clubs')
      .select('*')
      .eq('is_public', true)
      .order('created_at', { ascending: false });

    if (query && query.trim()) {
      queryBuilder = queryBuilder.ilike('name', `%${query}%`);
    }

    const { data, error } = await queryBuilder;

    if (error) throw error;
    return data || [];
  } catch (error) {
    console.error('ê³µê°œ í´ëŸ½ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
    throw new Error('í´ëŸ½ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const getClubByInviteCode = async (inviteCode: string): Promise<Club | null> => {
  try {
    const { data, error } = await supabase
      .from('clubs')
      .select('*')
      .eq('invite_code', inviteCode)
      .single();

    if (error && error.code !== 'PGRST116') throw error;
    return data || null;
  } catch (error) {
    console.error('í´ëŸ½ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('í´ëŸ½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
};

export const getClubDetail = async (clubId: string): Promise<ClubDetail> => {
  try {
    const { data: club, error: clubError } = await supabase
      .from('clubs')
      .select('*')
      .eq('id', clubId)
      .single();

    if (clubError) throw clubError;

    // Get member count
    const { count: memberCount, error: memberError } = await supabase
      .from('club_members')
      .select('*', { count: 'exact', head: true })
      .eq('club_id', clubId);

    if (memberError) throw memberError;

    // Get active challenge count
    const { count: challengeCount, error: challengeError } = await supabase
      .from('club_challenges')
      .select('*', { count: 'exact', head: true })
      .eq('club_id', clubId)
      .eq('status', 'active');

    if (challengeError) throw challengeError;

    return {
      ...club,
      member_count: memberCount || 0,
      active_challenge_count: challengeCount || 0,
    };
  } catch (error) {
    console.error('í´ëŸ½ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('í´ëŸ½ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const updateClub = async (
  clubId: string,
  updates: Partial<Pick<Club, 'name' | 'description' | 'is_public'>>
): Promise<void> => {
  try {
    const { error } = await supabase
      .from('clubs')
      .update(updates)
      .eq('id', clubId);

    if (error) throw error;
  } catch (error) {
    console.error('í´ëŸ½ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    throw new Error('í´ëŸ½ ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const deleteClub = async (clubId: string): Promise<void> => {
  try {
    const { error } = await supabase
      .from('clubs')
      .delete()
      .eq('id', clubId);

    if (error) throw error;
  } catch (error) {
    console.error('í´ëŸ½ ì‚­ì œ ì‹¤íŒ¨:', error);
    throw new Error('í´ëŸ½ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// Update dashboard widget configuration
export const updateDashboardConfig = async (
  clubId: string,
  dashboardConfig: any
): Promise<void> => {
  try {
    const { error } = await supabase
      .from('clubs')
      .update({ dashboard_config: dashboardConfig })
      .eq('id', clubId);

    if (error) throw error;
  } catch (error) {
    console.error('ëŒ€ì‹œë³´ë“œ ì„¤ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    throw new Error('ëŒ€ì‹œë³´ë“œ ì„¤ì • ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ============================================
// Member Management Functions
// ============================================

export const joinClub = async (clubId: string): Promise<void> => {
  try {
    const userId = getCurrentUserId();

    // Check if already joined
    const { data: existing } = await supabase
      .from('club_members')
      .select('id')
      .eq('club_id', clubId)
      .eq('user_id', userId)
      .maybeSingle();

    if (existing) {
      throw new Error('ì´ë¯¸ ê°€ì…í•œ í´ëŸ½ì…ë‹ˆë‹¤.');
    }

    const { error } = await supabase
      .from('club_members')
      .insert({
        club_id: clubId,
        user_id: userId,
        role: 'member',
      });

    if (error) throw error;
  } catch (error) {
    console.error('í´ëŸ½ ê°€ì… ì‹¤íŒ¨:', error);
    throw error instanceof Error ? error : new Error('í´ëŸ½ ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const leaveClub = async (clubId: string): Promise<void> => {
  try {
    const userId = getCurrentUserId();

    // Check if owner
    const { data: membership } = await supabase
      .from('club_members')
      .select('role')
      .eq('club_id', clubId)
      .eq('user_id', userId)
      .single();

    if (membership?.role === 'owner') {
      throw new Error('í´ëŸ½ ì†Œìœ ìëŠ” íƒˆí‡´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í´ëŸ½ì„ ì‚­ì œí•´ì£¼ì„¸ìš”.');
    }

    const { error } = await supabase
      .from('club_members')
      .delete()
      .eq('club_id', clubId)
      .eq('user_id', userId);

    if (error) throw error;
  } catch (error) {
    console.error('í´ëŸ½ íƒˆí‡´ ì‹¤íŒ¨:', error);
    throw error instanceof Error ? error : new Error('í´ëŸ½ íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const getClubMembers = async (clubId: string): Promise<ClubMemberWithUser[]> => {
  try {
    const { data, error } = await supabase
      .from('club_members')
      .select(`
        id,
        role,
        joined_at,
        club_id,
        user_id,
        users (
          id,
          username,
          display_name,
          profile_image
        )
      `)
      .eq('club_id', clubId)
      .order('joined_at', { ascending: true });

    if (error) throw error;

    return (data || []).map((item: any) => ({
      id: item.id,
      club_id: item.club_id,
      user_id: item.user_id,
      role: item.role,
      joined_at: item.joined_at,
      user: item.users,
    }));
  } catch (error) {
    console.error('ë©¤ë²„ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const updateMemberRole = async (
  memberId: string,
  newRole: 'admin' | 'member'
): Promise<void> => {
  try {
    const { error } = await supabase
      .from('club_members')
      .update({ role: newRole })
      .eq('id', memberId);

    if (error) throw error;
  } catch (error) {
    console.error('ì—­í•  ë³€ê²½ ì‹¤íŒ¨:', error);
    throw new Error('ë©¤ë²„ ì—­í•  ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const removeMember = async (memberId: string): Promise<void> => {
  try {
    const { error } = await supabase
      .from('club_members')
      .delete()
      .eq('id', memberId);

    if (error) throw error;
  } catch (error) {
    console.error('ë©¤ë²„ í‡´ì¶œ ì‹¤íŒ¨:', error);
    throw new Error('ë©¤ë²„ í‡´ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ============================================
// Feed Management Functions
// ============================================

export const shareWorkoutToClub = async (
  clubId: string,
  workoutLogId: string
): Promise<void> => {
  try {
    const userId = getCurrentUserId();

    const { error } = await supabase
      .from('club_feeds')
      .insert({
        club_id: clubId,
        user_id: userId,
        workout_log_id: workoutLogId,
      });

    if (error) throw error;
  } catch (error) {
    console.error('ìš´ë™ ê³µìœ  ì‹¤íŒ¨:', error);
    throw new Error('ìš´ë™ ê¸°ë¡ ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const getClubFeeds = async (
  clubId: string,
  limit: number = 20,
  offset: number = 0
): Promise<ClubFeedWithDetails[]> => {
  try {
    const { data, error } = await supabase
      .from('club_feeds')
      .select(`
        id,
        shared_at,
        users!club_feeds_user_id_fkey (
          id,
          username,
          display_name,
          profile_image
        ),
        workout_logs (
          id,
          date,
          raw_text,
          normalized_text,
          memo,
          created_at,
          workouts (
            id,
            name,
            type,
            sets,
            reps,
            weight_kg,
            duration_min,
            note
          )
        )
      `)
      .eq('club_id', clubId)
      .order('shared_at', { ascending: false })
      .range(offset, offset + limit - 1);

    if (error) throw error;

    return (data || []).map((item: any) => ({
      id: item.id,
      club_id: clubId,
      shared_at: item.shared_at,
      user: item.users,
      workout_log: {
        id: item.workout_logs.id,
        date: item.workout_logs.date,
        rawText: item.workout_logs.raw_text,
        normalizedText: item.workout_logs.normalized_text || '',
        memo: item.workout_logs.memo,
        createdAt: new Date(item.workout_logs.created_at).getTime(),
        workouts: item.workout_logs.workouts.map((w: any) => ({
          name: w.name,
          type: w.type,
          sets: w.sets,
          reps: w.reps,
          weight_kg: w.weight_kg,
          duration_min: w.duration_min,
          distance_km: null,
          pace: null,
          note: w.note,
        })),
      },
    }));
  } catch (error) {
    console.error('í”¼ë“œ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('í”¼ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const unshareWorkout = async (feedId: string): Promise<void> => {
  try {
    const { error } = await supabase
      .from('club_feeds')
      .delete()
      .eq('id', feedId);

    if (error) throw error;
  } catch (error) {
    console.error('ê³µìœ  ì·¨ì†Œ ì‹¤íŒ¨:', error);
    throw new Error('ê³µìœ  ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ============================================
// Challenge Functions
// ============================================

export const createChallenge = async (data: {
  club_id: string;
  title: string;
  description?: string;
  rules: any; // ChallengeRules JSONB
  start_date: string;
  end_date: string;
  theme_color?: string;
}): Promise<ClubChallenge> => {
  try {
    const userId = getCurrentUserId();

    const { data: challenge, error } = await supabase
      .from('challenges')
      .insert({
        scope: 'club',
        club_id: data.club_id,
        title: data.title,
        description: data.description,
        rules: data.rules,
        goal_metric: 'custom',
        goal_value: data.rules.goal_value,
        current_value: 0,
        start_date: data.start_date,
        end_date: data.end_date,
        theme_color: data.theme_color,
        status: 'active',
        created_by: userId,
      })
      .select()
      .single();

    if (error) throw error;
    return challenge;
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ìƒì„± ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const getActiveChallenges = async (clubId: string): Promise<ClubChallenge[]> => {
  try {
    const { data, error } = await supabase
      .from('club_challenges')
      .select('*')
      .eq('club_id', clubId)
      .eq('status', 'active')
      .order('end_date', { ascending: true });

    if (error) throw error;
    return data || [];
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const getAllChallenges = async (
  clubId: string,
  statusFilter?: 'active' | 'completed' | 'failed'
): Promise<ClubChallenge[]> => {
  try {
    let query = supabase
      .from('club_challenges')
      .select('*')
      .eq('club_id', clubId);

    if (statusFilter) {
      query = query.eq('status', statusFilter);
    }

    const { data, error } = await query.order('created_at', { ascending: false });

    if (error) throw error;
    return data || [];
  } catch (error) {
    console.error('ì „ì²´ ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const getChallengeDetail = async (
  challengeId: string
): Promise<ChallengeDetailWithContributors> => {
  try {
    // 1. Get challenge info
    const { data: challenge, error: challengeError } = await supabase
      .from('club_challenges')
      .select('*')
      .eq('id', challengeId)
      .single();

    if (challengeError) throw challengeError;

    // 2. Get contributor rankings
    const { data: contributions, error: contributionError } = await supabase
      .from('challenge_contributions')
      .select(`
        user_id,
        users (
          id,
          username,
          display_name,
          profile_image
        ),
        contribution_value
      `)
      .eq('challenge_id', challengeId);

    if (contributionError) throw contributionError;

    // Aggregate by user and sort
    const contributorMap = new Map<string, any>();
    (contributions || []).forEach((item: any) => {
      const userId = item.user_id;
      if (!contributorMap.has(userId)) {
        contributorMap.set(userId, {
          user: item.users,
          total_contribution: 0,
        });
      }
      const contributor = contributorMap.get(userId);
      contributor.total_contribution += item.contribution_value;
    });

    const contributors = Array.from(contributorMap.values()).sort(
      (a, b) => b.total_contribution - a.total_contribution
    );

    return {
      ...challenge,
      contributors,
    };
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const contributeToChallenge = async (
  challengeId: string,
  workoutLogId: string
): Promise<void> => {
  try {
    const userId = getCurrentUserId();

    // 1. Get workout log
    const { data: workoutLog, error: logError } = await supabase
      .from('workout_logs')
      .select(`
        id,
        workouts (
          sets,
          reps,
          weight_kg,
          duration_min
        )
      `)
      .eq('id', workoutLogId)
      .single();

    if (logError) throw logError;

    // 2. Get challenge type
    const { data: challenge } = await supabase
      .from('club_challenges')
      .select('challenge_type')
      .eq('id', challengeId)
      .single();

    let contributionValue = 0;
    const workouts = workoutLog.workouts || [];

    switch (challenge?.challenge_type) {
      case 'total_workouts':
        contributionValue = workouts.length;
        break;
      case 'total_volume':
        contributionValue = workouts.reduce(
          (sum: number, w: any) => sum + ((w.sets || 0) * (w.reps || 0) * (w.weight_kg || 0)),
          0
        );
        break;
      case 'total_duration':
        contributionValue = workouts.reduce((sum: number, w: any) => sum + (w.duration_min || 0), 0);
        break;
      case 'total_distance':
        // distance_km field would be needed
        contributionValue = 0;
        break;
    }

    if (contributionValue === 0) {
      throw new Error('ê¸°ì—¬í•  ìˆ˜ ìˆëŠ” ê°’ì´ ì—†ìŠµë‹ˆë‹¤.');
    }

    // 3. Add contribution record
    const { error: contributionError } = await supabase
      .from('challenge_contributions')
      .insert({
        challenge_id: challengeId,
        user_id: userId,
        workout_log_id: workoutLogId,
        contribution_value: contributionValue,
      });

    if (contributionError) throw contributionError;

    // 4. Update challenge current_value
    const { error: updateError } = await supabase.rpc('increment_challenge_value', {
      p_challenge_id: challengeId,
      p_increment: contributionValue,
    });

    if (updateError) {
      // Fallback: direct update if RPC function doesn't exist
      const { data: currentChallenge } = await supabase
        .from('club_challenges')
        .select('current_value')
        .eq('id', challengeId)
        .single();

      await supabase
        .from('club_challenges')
        .update({
          current_value: (currentChallenge?.current_value || 0) + contributionValue,
        })
        .eq('id', challengeId);
    }
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ê¸°ì—¬ ì‹¤íŒ¨:', error);
    throw error instanceof Error ? error : new Error('ì±Œë¦°ì§€ ê¸°ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const updateChallenge = async (
  challengeId: string,
  updates: Partial<Pick<ClubChallenge, 'title' | 'description' | 'status'>>
): Promise<void> => {
  try {
    const { error } = await supabase
      .from('club_challenges')
      .update(updates)
      .eq('id', challengeId);

    if (error) throw error;
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const deleteChallenge = async (challengeId: string): Promise<void> => {
  try {
    const { error} = await supabase
      .from('club_challenges')
      .delete()
      .eq('id', challengeId);

    if (error) throw error;
  } catch (error) {
    console.error('ì±Œë¦°ì§€ ì‚­ì œ ì‹¤íŒ¨:', error);
    throw new Error('ì±Œë¦°ì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ============================================
// Club Dashboard (Server-Side Aggregation)
// ============================================

/**
 * í´ëŸ½ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì¡°íšŒ (DBì—ì„œ ì§‘ê³„)
 * ë°°ì§€, ìŠ¤ì¿¼ë“œ, ë¦¬ë”ë³´ë“œë¥¼ DB Functionì—ì„œ ê³„ì‚°í•˜ì—¬ ë°˜í™˜
 */
export const getClubDashboard = async (clubId: string): Promise<ClubDashboardData> => {
  try {
    const userStr = localStorage.getItem('current_user');
    const currentUserId = userStr ? JSON.parse(userStr).id : null;

    const { data, error } = await supabase.rpc('get_club_dashboard', {
      p_club_id: clubId,
      p_current_user_id: currentUserId,
    });

    if (error) throw error;

    return {
      badges: data.badges || [],
      squad: data.squad || [],
      leaderboards: data.leaderboards || { cardio: [], strength: [], snowboard: [] },
    };
  } catch (error) {
    console.error('í´ëŸ½ ëŒ€ì‹œë³´ë“œ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw new Error('í´ëŸ½ ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

// ============================================
// Club Member Workout Logs (Zero-Copy View Architecture)
// ============================================

/**
 * í´ëŸ½ ë©¤ë²„ë“¤ì˜ ê³µê°œ ìš´ë™ ë¡œê·¸ ì¡°íšŒ
 * Zero-Copy View Architecture: club_feeds í…Œì´ë¸”ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ ,
 * RLSë¥¼ í†µí•´ workout_logsë¥¼ ì§ì ‘ ì¡°íšŒ
 *
 * @deprecated ëŒ€ì‹œë³´ë“œëŠ” getClubDashboard() ì‚¬ìš© ê¶Œì¥
 */
export const getClubMemberLogs = async (
  clubId: string,
  limit: number = 20,
  offset: number = 0
): Promise<WorkoutLog[]> => {
  try {
    // 1. Get club member user_ids
    const { data: members, error: membersError } = await supabase
      .from('club_members')
      .select('user_id')
      .eq('club_id', clubId);

    if (membersError) throw membersError;
    if (!members || members.length === 0) return [];

    const memberUserIds = members.map((m: any) => m.user_id);

    // 2. Get public workout logs from these members
    // RLS will automatically filter to only show logs from users in the same club
    const { data: logs, error: logsError } = await supabase
      .from('workout_logs')
      .select(`
        id,
        user_id,
        date,
        raw_text,
        normalized_text,
        memo,
        is_private,
        created_at,
        workouts (
          id,
          name,
          category,
          type,
          sets,
          reps,
          weight_kg,
          duration_min,
          note
        ),
        users (
          display_name,
          profile_image
        )
      `)
      .in('user_id', memberUserIds)
      .eq('is_private', false) // Only public logs
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1);

    if (logsError) throw logsError;

    return (logs || []).map((log: any) => ({
      id: log.id,
      userId: log.user_id,
      date: log.date,
      rawText: log.raw_text,
      normalizedText: log.normalized_text || '',
      workouts: (log.workouts || []).map((w: any) => ({
        name: w.name,
        category: w.category || 'gym',
        type: w.type,
        sets: w.sets,
        reps: w.reps,
        weight_kg: w.weight_kg,
        duration_min: w.duration_min,
        distance_km: null,
        pace: null,
        note: w.note,
      })),
      memo: log.memo,
      createdAt: new Date(log.created_at).getTime(),
      isPrivate: log.is_private ?? false,
      // User info for display
      userDisplayName: log.users?.display_name || 'ìµëª…',
      userProfileImage: log.users?.profile_image || null,
    }));
  } catch (error) {
    console.error('í´ëŸ½ ë©¤ë²„ ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
    throw error instanceof Error ? error : new Error('í´ëŸ½ ë©¤ë²„ ë¡œê·¸ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};
</file>

<file path="src/App.tsx">
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './contexts/AuthContext';
import { Login } from './pages/Login';
import { Signup } from './pages/Signup';
import { PrivacyPolicy } from './pages/PrivacyPolicy';
import { TermsOfService } from './pages/TermsOfService';
import { History } from './pages/History';
import { Dashboard } from './pages/Dashboard';
import { TodoList } from './pages/TodoList';
import { Recommend } from './pages/Recommend';
import { ClubPage } from './pages/Club';
import { CreateClubPage } from './pages/CreateClub';
import { ClubDetailPage } from './pages/ClubDetail';
import { JoinClubPage } from './pages/JoinClub';
import { ChallengeDetailPage } from './pages/ChallengeDetail';
import { Header } from './components/Header';
import { BottomNav } from './components/BottomNav';
import KakaoCallback from './components/KakaoCallback';
import './App.css';

function ProtectedRoutes() {
  const { user, loading } = useAuth();

  if (loading) {
    return (
      <div className="container">
        <div className="loading-screen">ë¡œë”© ì¤‘...</div>
      </div>
    );
  }

  if (!user) {
    return <Login />;
  }

  return (
    <>
      <Header />
      <Routes>
        <Route path="/" element={<History />} />
        <Route path="/dashboard" element={<Dashboard />} />
        <Route path="/todo" element={<TodoList />} />
        <Route path="/recommend" element={<Recommend />} />

        {/* Club routes */}
        <Route path="/club" element={<ClubPage />} />
        <Route path="/club/create" element={<CreateClubPage />} />
        <Route path="/club/:clubId" element={<ClubDetailPage />} />
        <Route path="/club/:clubId/challenge/:challengeId" element={<ChallengeDetailPage />} />

        <Route path="*" element={<Navigate to="/" replace />} />
      </Routes>
      <BottomNav />
    </>
  );
}

function App() {
  return (
    <AuthProvider>
      <BrowserRouter>
        <Routes>
          {/* Public routes */}
          <Route path="/signup" element={<Signup />} />
          <Route path="/privacy" element={<PrivacyPolicy />} />
          <Route path="/terms" element={<TermsOfService />} />
          <Route path="/auth/kakao/callback" element={<KakaoCallback />} />

          {/* Club invite link (public) */}
          <Route path="/club/join/:inviteCode" element={<JoinClubPage />} />

          {/* Protected routes */}
          <Route path="/*" element={
            <div className="app-container">
              <ProtectedRoutes />
            </div>
          } />
        </Routes>
      </BrowserRouter>
    </AuthProvider>
  );
}

export default App;
</file>

<file path="src/features/parse/parseWithGPT.ts">
import type { Workout } from '../../types';
import { parseWorkoutAPI } from '../../utils/ai/parseWorkoutAPI';

/**
 * New AI Parser using OpenAI gpt-4o-mini (Shredder + 3 Specialists)
 *
 * This replaces the old Gemini-based parser with a validated, high-accuracy
 * parser developed and tested in test-parser/.
 *
 * NOW RUNS SERVER-SIDE via Netlify Functions for security and stability.
 *
 * Key Features:
 * - Shredder: Splits complex input into individual workout segments
 * - Cardio Specialist: Handles cardio metrics (distance, speed, pace, floors)
 * - Strength Specialist: Handles strength metrics (weight, sets, reps)
 * - Snowboard Specialist: Handles snowboard-specific data
 *
 * @param text - User input text
 * @returns Promise<Workout[]> - Array of parsed workouts
 */
export const parseWithGPT = async (text: string): Promise<Workout[]> => {
  console.log('[AI Parser] Input text:', text);

  if (!text.trim()) {
    console.log('[AI Parser] Empty text, returning empty array');
    return [];
  }

  try {
    console.log('[AI Parser] Calling Netlify Function parse-workout...');
    const workouts = await parseWorkoutAPI(text);
    console.log('[AI Parser] Parsed workouts:', workouts);
    return workouts;
  } catch (err) {
    console.error('[AI Parser] Parsing error:', err);
    throw err;
  }
};
</file>

<file path="src/pages/ClubDetail.tsx">
import { useState, useEffect, useMemo, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import clubService from '../services/clubService';
import challengeService from '../services/challengeService';
import { getClubDashboard, updateDashboardConfig, type ClubDashboardData } from '../storage/clubStorage';
import { formatMetric } from '../utils/calculateMetrics';
import type { HofBadge } from '../utils/dashboardLogic';
import { ChallengeWizard } from '../components/challenge/ChallengeWizard';
import type {
  ClubDetail,
  ClubChallenge,
  ClubMemberWithUser,
  DashboardWidget,
  DashboardConfig,
} from '../types';

type TabType = 'dashboard' | 'challenge' | 'members';

// Default widget configuration
const DEFAULT_WIDGETS: DashboardWidget[] = [
  { id: 'live_ticker', type: 'live_ticker', visible: true, order: 0 },
  { id: 'hall_of_fame', type: 'hall_of_fame', visible: true, order: 1 },
  { id: 'daily_squad', type: 'daily_squad', visible: true, order: 2 },
  { id: 'leaderboard_cardio', type: 'leaderboard', visible: true, order: 3, config: { metricType: 'cardio' } },
  { id: 'leaderboard_strength', type: 'leaderboard', visible: true, order: 4, config: { metricType: 'strength' } },
  { id: 'leaderboard_snowboard', type: 'leaderboard', visible: true, order: 5, config: { metricType: 'snowboard' } },
];

export const ClubDetailPage = () => {
  const { clubId } = useParams<{ clubId: string }>();
  const navigate = useNavigate();

  const [tab, setTab] = useState<TabType>('dashboard');
  const [club, setClub] = useState<ClubDetail | null>(null);
  const [dashboardData, setDashboardData] = useState<ClubDashboardData | null>(null);
  const [challenges, setChallenges] = useState<ClubChallenge[]>([]);
  const [members, setMembers] = useState<ClubMemberWithUser[]>([]);
  const [loading, setLoading] = useState(true);
  const [myRole, setMyRole] = useState<'owner' | 'admin' | 'member' | null>(null);
  const [showCreateChallenge, setShowCreateChallenge] = useState(false);

  // Widget system state
  const [editMode, setEditMode] = useState(false);
  const [widgets, setWidgets] = useState<DashboardWidget[]>(DEFAULT_WIDGETS);
  const [widgetsSaving, setWidgetsSaving] = useState(false);

  useEffect(() => {
    if (clubId) {
      loadClubData();
    }
  }, [clubId]);

  useEffect(() => {
    if (clubId && club) {
      loadTabData();
    }
  }, [tab, club]);

  const loadClubData = async () => {
    if (!clubId) return;

    setLoading(true);
    try {
      const clubData = await clubService.getClubDetail(clubId);
      setClub(clubData);

      // Load dashboard config or use default
      if (clubData.dashboard_config?.widgets) {
        setWidgets(clubData.dashboard_config.widgets);
      } else {
        setWidgets(DEFAULT_WIDGETS);
      }

      // Get my role
      const membersList = await clubService.getClubMembers(clubId);
      const currentUserId = localStorage.getItem('current_user')
        ? JSON.parse(localStorage.getItem('current_user')!).id
        : null;
      const myMembership = membersList.find((m) => m.user_id === currentUserId);
      setMyRole(myMembership?.role || null);
    } catch (error) {
      console.error('í´ëŸ½ ë¡œë“œ ì‹¤íŒ¨:', error);
      alert('í´ëŸ½ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      navigate('/club');
    } finally {
      setLoading(false);
    }
  };

  const loadTabData = async () => {
    if (!clubId) return;

    try {
      switch (tab) {
        case 'dashboard':
          // Server-side aggregation: DBì—ì„œ ì§‘ê³„ëœ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì¡°íšŒ
          const data = await getClubDashboard(clubId);
          setDashboardData(data);
          break;
        case 'challenge':
          const challengeData = await challengeService.getActiveChallenges(clubId);
          setChallenges(challengeData);
          break;
        case 'members':
          const memberData = await clubService.getClubMembers(clubId);
          setMembers(memberData);
          break;
      }
    } catch (error) {
      console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    }
  };

  const handleInvite = () => {
    if (!club) return;
    clubService.shareToKakao(club);
  };

  const handleLeave = async () => {
    if (!clubId || !confirm('ì •ë§ í´ëŸ½ì„ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
      await clubService.leaveClub(clubId);
      alert('í´ëŸ½ì„ íƒˆí‡´í–ˆìŠµë‹ˆë‹¤.');
      navigate('/club');
    } catch (error) {
      alert(error instanceof Error ? error.message : 'íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };

  // Widget management functions
  const handleToggleWidgetVisibility = (widgetId: string) => {
    setWidgets((prev) =>
      prev.map((w) => (w.id === widgetId ? { ...w, visible: !w.visible } : w))
    );
  };

  const handleMoveWidget = (widgetId: string, direction: 'up' | 'down') => {
    setWidgets((prev) => {
      const sortedWidgets = [...prev].sort((a, b) => a.order - b.order);
      const index = sortedWidgets.findIndex((w) => w.id === widgetId);

      if (index === -1) return prev;
      if (direction === 'up' && index === 0) return prev;
      if (direction === 'down' && index === sortedWidgets.length - 1) return prev;

      const newIndex = direction === 'up' ? index - 1 : index + 1;
      [sortedWidgets[index], sortedWidgets[newIndex]] = [sortedWidgets[newIndex], sortedWidgets[index]];

      return sortedWidgets.map((w, i) => ({ ...w, order: i }));
    });
  };

  const handleSaveWidgets = async () => {
    if (!clubId) return;

    setWidgetsSaving(true);
    try {
      const config: DashboardConfig = { widgets };
      await updateDashboardConfig(clubId, config);
      alert('ëŒ€ì‹œë³´ë“œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      setEditMode(false);
      loadClubData();
    } catch (error) {
      alert(error instanceof Error ? error.message : 'ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setWidgetsSaving(false);
    }
  };

  const handleCancelEdit = () => {
    setEditMode(false);
    // Reload original config
    if (club?.dashboard_config?.widgets) {
      setWidgets(club.dashboard_config.widgets);
    } else {
      setWidgets(DEFAULT_WIDGETS);
    }
  };

  if (loading) {
    return (
      <div className="container">
        <div className="loading-screen">ë¡œë”© ì¤‘...</div>
      </div>
    );
  }

  if (!club) {
    return (
      <div className="container">
        <div className="empty-state">
          <p>í´ëŸ½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="container">
      <div className="header">
        <button className="back-button" onClick={() => navigate('/club')}>
          â† ë’¤ë¡œ
        </button>
        <h2>{club.name}</h2>
      </div>

      {/* Club Info Card */}
      <div className="section" style={{ marginBottom: '20px' }}>
        <p
          style={{
            fontSize: '14px',
            color: 'var(--text-secondary)',
            marginBottom: '12px',
          }}
        >
          {club.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}
        </p>
        <div style={{ display: 'flex', gap: '12px', marginBottom: '16px' }}>
          <div className="stat-chip">{club.is_public ? 'ğŸŒ ê³µê°œ' : 'ğŸ”’ ë¹„ê³µê°œ'}</div>
          <div className="stat-chip">ğŸ‘¥ {club.member_count}ëª…</div>
          <div className="stat-chip">ğŸ¯ ì±Œë¦°ì§€ {club.active_challenge_count}ê°œ</div>
        </div>
        <div style={{ display: 'flex', gap: '8px' }}>
          <button className="primary-button" onClick={handleInvite}>
            ğŸ“¤ ì´ˆëŒ€í•˜ê¸°
          </button>
          {myRole !== 'owner' && (
            <button className="cancel-button" onClick={handleLeave}>
              íƒˆí‡´
            </button>
          )}
        </div>
      </div>

      {/* Tabs */}
      <div className="mode-selector">
        <button
          className={`mode-button ${tab === 'dashboard' ? 'active' : ''}`}
          onClick={() => setTab('dashboard')}
        >
          ëŒ€ì‹œë³´ë“œ
        </button>
        <button
          className={`mode-button ${tab === 'challenge' ? 'active' : ''}`}
          onClick={() => setTab('challenge')}
        >
          ì±Œë¦°ì§€
        </button>
        <button
          className={`mode-button ${tab === 'members' ? 'active' : ''}`}
          onClick={() => setTab('members')}
        >
          ë©¤ë²„
        </button>
      </div>

      {/* Dashboard Tab */}
      {tab === 'dashboard' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
          {/* Edit Mode Controls */}
          {(myRole === 'owner' || myRole === 'admin') && (
            <div style={{ display: 'flex', gap: '8px', justifyContent: 'flex-end' }}>
              {!editMode ? (
                <button className="primary-button" onClick={() => setEditMode(true)}>
                  ğŸ¨ ëŒ€ì‹œë³´ë“œ í¸ì§‘
                </button>
              ) : (
                <>
                  <button
                    className="primary-button"
                    onClick={handleSaveWidgets}
                    disabled={widgetsSaving}
                  >
                    {widgetsSaving ? 'ì €ì¥ ì¤‘...' : 'ğŸ’¾ ì €ì¥'}
                  </button>
                  <button className="cancel-button" onClick={handleCancelEdit}>
                    ì·¨ì†Œ
                  </button>
                </>
              )}
            </div>
          )}

          {/* Render Widgets */}
          {widgets
            .sort((a, b) => a.order - b.order)
            .map((widget) => (
              <DashboardWidgetWrapper
                key={widget.id}
                widget={widget}
                editMode={editMode}
                onToggleVisibility={handleToggleWidgetVisibility}
                onMove={handleMoveWidget}
                dashboardData={dashboardData}
              />
            ))}
        </div>
      )}


      {/* Challenge Tab */}
      {tab === 'challenge' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
          {(myRole === 'owner' || myRole === 'admin') && (
            <button
              className="primary-button"
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                setShowCreateChallenge(true);
              }}
              style={{
                cursor: 'pointer',
                pointerEvents: 'auto',
                zIndex: 1,
              }}
            >
              + ì±Œë¦°ì§€ ë§Œë“¤ê¸°
            </button>
          )}
          {challenges.length === 0 ? (
            <div className="empty-state">
              <p>ì§„í–‰ ì¤‘ì¸ ì±Œë¦°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          ) : (
            challenges.map((challenge) => {
              const progress = challengeService.calculateProgress(
                challenge.current_value,
                challenge.target_value
              );
              return (
                <div
                  key={challenge.id}
                  className="section"
                  onClick={() => navigate(`/club/${clubId}/challenge/${challenge.id}`)}
                  style={{ cursor: 'pointer' }}
                >
                  <h3 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '8px' }}>
                    {challenge.title}
                  </h3>
                  {challenge.description && (
                    <p
                      style={{
                        fontSize: '14px',
                        color: 'var(--text-secondary)',
                        marginBottom: '12px',
                      }}
                    >
                      {challenge.description}
                    </p>
                  )}
                  <div className="progress-bar-container">
                    <div className="progress-bar" style={{ width: `${progress}%` }} />
                  </div>
                  <div className="progress-text">
                    {challenge.current_value} / {challenge.target_value} ({progress}%)
                  </div>
                  <div className="log-meta">
                    <span>
                      {challenge.start_date} ~ {challenge.end_date}
                    </span>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}

      {/* Members Tab */}
      {tab === 'members' && (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
          {members.map((member) => (
            <div key={member.id} className="log-item">
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <div
                  className="profile-avatar"
                  style={{ width: '40px', height: '40px', fontSize: '16px' }}
                >
                  {member.user.display_name[0]}
                </div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: '16px', fontWeight: '600' }}>
                    {member.user.display_name}
                  </div>
                  <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                    @{member.user.username}
                  </div>
                </div>
                <div
                  style={{
                    fontSize: '12px',
                    padding: '4px 10px',
                    background: 'var(--primary-color)',
                    color: 'white',
                    borderRadius: '6px',
                  }}
                >
                  {member.role === 'owner' && 'ğŸ‘‘ ì†Œìœ ì'}
                  {member.role === 'admin' && 'â­ ê´€ë¦¬ì'}
                  {member.role === 'member' && 'ğŸ‘¤ ë©¤ë²„'}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Create Challenge Wizard */}
      {showCreateChallenge && (
        <ChallengeWizard
          clubId={clubId!}
          onClose={() => setShowCreateChallenge(false)}
          onSuccess={() => {
            setShowCreateChallenge(false);
            loadTabData();
          }}
        />
      )}
    </div>
  );
};


// ============================================
// Dashboard Widget Wrapper
// ============================================

interface WidgetWrapperProps {
  widget: DashboardWidget;
  editMode: boolean;
  onToggleVisibility: (widgetId: string) => void;
  onMove: (widgetId: string, direction: 'up' | 'down') => void;
  dashboardData: ClubDashboardData | null;
}

const DashboardWidgetWrapper = ({
  widget,
  editMode,
  onToggleVisibility,
  onMove,
  dashboardData,
}: WidgetWrapperProps) => {
  const getWidgetTitle = () => {
    switch (widget.type) {
      case 'live_ticker':
        return 'ğŸ“¡ Live Activity';
      case 'hall_of_fame':
        return 'ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹';
      case 'daily_squad':
        return 'ğŸ‘¥ ì˜¤ëŠ˜ì˜ ìŠ¤ì¿¼ë“œ';
      case 'leaderboard':
        const metricType = widget.config?.metricType;
        if (metricType === 'cardio') return 'ğŸƒ ìœ ì‚°ì†Œ í‚¹';
        if (metricType === 'strength') return 'ğŸ‹ï¸ ìŠ¤íŠ¸ë ìŠ¤ í‚¹';
        if (metricType === 'snowboard') return 'ğŸ‚ ìŠ¬ë¡œí”„ í‚¹';
        return 'ë¦¬ë”ë³´ë“œ';
      default:
        return 'ìœ„ì ¯';
    }
  };

  const renderWidget = () => {
    if (!dashboardData) return <div>ë¡œë”© ì¤‘...</div>;

    switch (widget.type) {
      case 'live_ticker':
        return <LiveTicker badges={dashboardData.badges} squad={dashboardData.squad} />;
      case 'hall_of_fame':
        return <HallOfFame badges={dashboardData.badges} />;
      case 'daily_squad':
        return <DailySquad squad={dashboardData.squad} />;
      case 'leaderboard':
        const metricType = widget.config?.metricType as 'cardio' | 'strength' | 'snowboard';
        let title = '';
        let subtitle = '';
        if (metricType === 'cardio') {
          title = 'ğŸƒ ìœ ì‚°ì†Œ í‚¹';
          subtitle = 'í™˜ì‚° ê±°ë¦¬ ê¸°ì¤€ (ğŸƒÃ—1.0 ğŸªœÃ—1.0 ğŸš£Ã—0.6 ğŸš´Ã—0.4 ğŸ’¨Ã—0.3)';
        } else if (metricType === 'strength') {
          title = 'ğŸ‹ï¸ ìŠ¤íŠ¸ë ìŠ¤ í‚¹';
          subtitle = 'ì´ ë³¼ë¥¨ ê¸°ì¤€';
        } else if (metricType === 'snowboard') {
          title = 'ğŸ‚ ìŠ¬ë¡œí”„ í‚¹';
          subtitle = 'ëŸ° ìˆ˜ ê¸°ì¤€';
        }
        return (
          <LeaderboardSection
            title={title}
            subtitle={subtitle}
            rankings={dashboardData.leaderboards[metricType]}
            metricType={metricType}
          />
        );
      default:
        return null;
    }
  };

  if (!widget.visible && !editMode) {
    return null;
  }

  return (
    <div
      style={{
        position: 'relative',
        opacity: widget.visible ? 1 : 0.5,
        border: editMode ? '2px dashed var(--primary-color)' : 'none',
        borderRadius: editMode ? '12px' : '0',
        padding: editMode ? '8px' : '0',
      }}
    >
      {/* Edit Mode Controls */}
      {editMode && (
        <div
          style={{
            position: 'absolute',
            top: '16px',
            right: '16px',
            display: 'flex',
            gap: '8px',
            zIndex: 10,
            background: 'var(--bg-secondary)',
            padding: '8px',
            borderRadius: '8px',
            border: '1px solid var(--border-color)',
          }}
        >
          <button
            onClick={() => onMove(widget.id, 'up')}
            style={{
              padding: '4px 12px',
              fontSize: '14px',
              background: 'var(--bg-primary)',
              border: '1px solid var(--border-color)',
              borderRadius: '6px',
              cursor: 'pointer',
              color: 'var(--text-primary)',
            }}
            title="ìœ„ë¡œ ì´ë™"
          >
            â†‘
          </button>
          <button
            onClick={() => onMove(widget.id, 'down')}
            style={{
              padding: '4px 12px',
              fontSize: '14px',
              background: 'var(--bg-primary)',
              border: '1px solid var(--border-color)',
              borderRadius: '6px',
              cursor: 'pointer',
              color: 'var(--text-primary)',
            }}
            title="ì•„ë˜ë¡œ ì´ë™"
          >
            â†“
          </button>
          <button
            onClick={() => onToggleVisibility(widget.id)}
            style={{
              padding: '4px 12px',
              fontSize: '14px',
              background: widget.visible ? 'var(--primary-color)' : 'var(--bg-primary)',
              border: '1px solid var(--border-color)',
              borderRadius: '6px',
              cursor: 'pointer',
              color: widget.visible ? 'white' : 'var(--text-primary)',
              fontWeight: '600',
            }}
            title={widget.visible ? 'ìˆ¨ê¸°ê¸°' : 'í‘œì‹œ'}
          >
            {widget.visible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
          </button>
        </div>
      )}

      {/* Widget Label in Edit Mode */}
      {editMode && (
        <div
          style={{
            fontSize: '12px',
            fontWeight: '600',
            color: 'var(--primary-color)',
            marginBottom: '8px',
            textAlign: 'center',
          }}
        >
          {getWidgetTitle()}
        </div>
      )}

      {/* Widget Content */}
      {renderWidget()}
    </div>
  );
};

// ============================================
// Gamified Dashboard Components
// ============================================

// Live Ticker - ì‹¤ì‹œê°„ í™œë™ í”¼ë“œ (ë‰´ìŠ¤ í‹°ì»¤ ìŠ¤íƒ€ì¼)
const LiveTicker = ({ badges, squad }: { badges: Array<any>; squad: Array<any> }) => {
  // ê°„ë‹¨í•œ í‹°ì»¤ ì•„ì´í…œ ìƒì„± (ë°°ì§€ + ìŠ¤ì¿¼ë“œ í™œë™)
  const tickerItems = useMemo(() => {
    const items: Array<{ id: string; icon: string; text: string; timestamp: number }> = [];

    // ë°°ì§€ í‹°ì»¤ (ìµœê·¼ 3ê°œ)
    badges.slice(0, 3).forEach((badge, index) => {
      items.push({
        id: `badge-${badge.userId}-${badge.title}-${index}`,
        icon: badge.icon,
        text: `${badge.userName}ë‹˜ì´ ${badge.title} ë°°ì§€ íšë“!`,
        timestamp: Date.now(),
      });
    });

    // ìŠ¤ì¿¼ë“œ í‹°ì»¤ (ìµœê·¼ 5ëª…)
    squad.slice(0, 5).forEach((member) => {
      items.push({
        id: `squad-${member.userId}`,
        icon: member.activityType === 'today' ? 'ğŸ”¥' : 'âš¡',
        text: `${member.displayName}ë‹˜ì´ ${member.mainActivity} ì™„ë£Œ!`,
        timestamp: Date.now(),
      });
    });

    return items;
  }, [badges, squad]);

  if (tickerItems.length === 0) return null;

  return (
    <div
      style={{
        background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
        border: '2px solid #334155',
        borderRadius: '12px',
        padding: '16px',
        overflow: 'hidden',
        position: 'relative',
      }}
    >
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
          marginBottom: '12px',
        }}
      >
        <div style={{ fontSize: '20px' }}>ğŸ“¡</div>
        <h3 style={{ fontSize: '16px', fontWeight: '700', margin: 0 }}>LIVE ACTIVITY</h3>
      </div>

      <div
        style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          maxHeight: '200px',
          overflowY: 'auto',
        }}
      >
        {tickerItems.map((item) => (
          <div
            key={item.id}
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
              padding: '8px 12px',
              background: 'rgba(255, 255, 255, 0.05)',
              borderRadius: '8px',
              fontSize: '14px',
              borderLeft: '3px solid var(--primary-color)',
            }}
          >
            <div style={{ fontSize: '18px' }}>{item.icon}</div>
            <div style={{ flex: 1, color: '#e2e8f0' }}>{item.text}</div>
            <div style={{ fontSize: '11px', color: '#94a3b8' }}>
              {new Date(item.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit',
              })}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};


// Hall of Fame Carousel - ë°°ì§€ ì‹œìŠ¤í…œ
const HallOfFame = ({ badges }: { badges: Array<any> }) => {

  // Mouse drag scroll for desktop
  const carouselRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);
  const startX = useRef(0);
  const scrollLeft = useRef(0);

  const handleMouseDown = (e: React.MouseEvent) => {
    if (!carouselRef.current) return;
    isDragging.current = true;
    startX.current = e.pageX - carouselRef.current.offsetLeft;
    scrollLeft.current = carouselRef.current.scrollLeft;
    carouselRef.current.style.cursor = 'grabbing';
    carouselRef.current.style.userSelect = 'none';
  };

  const handleMouseLeave = () => {
    isDragging.current = false;
    if (carouselRef.current) {
      carouselRef.current.style.cursor = 'grab';
    }
  };

  const handleMouseUp = () => {
    isDragging.current = false;
    if (carouselRef.current) {
      carouselRef.current.style.cursor = 'grab';
    }
  };

  const handleMouseMove = (e: React.MouseEvent) => {
    if (!isDragging.current || !carouselRef.current) return;
    e.preventDefault();
    const x = e.pageX - carouselRef.current.offsetLeft;
    const walk = (x - startX.current) * 2; // Scroll speed multiplier
    carouselRef.current.scrollLeft = scrollLeft.current - walk;
  };

  if (badges.length === 0) {
    return (
      <div className="section">
        <h3>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3>
        <div className="empty-state">
          <p>ì•„ì§ ë°°ì§€ë¥¼ íšë“í•œ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    );
  }

  // ë°°ì§€ íƒ€ì…ë³„ ìƒ‰ìƒ ë§¤í•‘
  const getBadgeColor = (type: HofBadge['type']): string => {
    switch (type) {
      case 'strength':
        return '#ef4444'; // Red
      case 'cardio':
        return '#3b82f6'; // Blue
      case 'effort':
        return '#eab308'; // Yellow
      case 'time':
        return '#f97316'; // Orange
      case 'consistency':
        return '#8b5cf6'; // Purple
      default:
        return '#64748b'; // Gray
    }
  };

  return (
    <div
      style={{
        background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
        border: '2px solid #334155',
        borderRadius: '12px',
        padding: '20px',
      }}
    >
      <div style={{ marginBottom: '16px' }}>
        <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#e2e8f0', marginBottom: '4px' }}>
          ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹
        </h3>
        <p style={{ fontSize: '13px', color: '#94a3b8', margin: 0 }}>
          ì£¼ê°„ ë² ìŠ¤íŠ¸ ë©¤ë²„ {badges.length}ëª…
        </p>
        <p style={{ fontSize: '11px', color: '#64748b', margin: '4px 0 0 0', lineHeight: 1.4 }}>
          ğŸ’¡ ìœ ì‚°ì†Œ: ì¢…ëª©ë³„ í™˜ì‚° (ğŸƒÃ—1.0 ğŸªœÃ—1.0 ğŸš£Ã—0.6 ğŸš´Ã—0.4 ğŸ’¨Ã—0.3)
        </p>
      </div>

      {/* Carousel Container with Snap Scroll */}
      <div
        ref={carouselRef}
        onMouseDown={handleMouseDown}
        onMouseLeave={handleMouseLeave}
        onMouseUp={handleMouseUp}
        onMouseMove={handleMouseMove}
        style={{
          display: 'flex',
          gap: '16px',
          overflowX: 'auto',
          scrollSnapType: 'x mandatory',
          paddingBottom: '8px',
          cursor: 'grab',
          // Hide scrollbar but keep functionality
          scrollbarWidth: 'none',
          msOverflowStyle: 'none',
        }}
        className="hall-of-fame-carousel"
      >
        {badges.map((badge, index) => {
          const color = getBadgeColor(badge.type);

          return (
            <div
              key={`${badge.userId}-${badge.title}-${index}`}
              style={{
                minWidth: '280px',
                maxWidth: '280px',
                scrollSnapAlign: 'start',
                background: badge.isMe
                  ? `linear-gradient(135deg, ${color}33 0%, ${color}22 100%)`
                  : `linear-gradient(135deg, ${color}22 0%, ${color}11 100%)`,
                border: badge.isMe ? `3px solid ${color}` : `2px solid ${color}66`,
                borderRadius: '16px',
                padding: '20px',
                position: 'relative',
                overflow: 'hidden',
                boxShadow: badge.isMe ? `0 0 20px ${color}44` : 'none',
              }}
            >
              {/* Me Badge (ë‚˜ë§Œ í‘œì‹œ) */}
              {badge.isMe && (
                <div
                  style={{
                    position: 'absolute',
                    top: '12px',
                    left: '12px',
                    background: color,
                    color: 'white',
                    padding: '4px 10px',
                    borderRadius: '12px',
                    fontSize: '11px',
                    fontWeight: '700',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                  }}
                >
                  â­ ME
                </div>
              )}

              {/* Badge Icon (ìš°ì¸¡ ìƒë‹¨) */}
              <div
                style={{
                  position: 'absolute',
                  top: '12px',
                  right: '12px',
                  fontSize: '32px',
                  opacity: 0.3,
                }}
              >
                {badge.icon}
              </div>

              {/* Profile */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px' }}>
                {badge.userProfile ? (
                  <img
                    src={badge.userProfile}
                    alt={badge.userName}
                    style={{
                      width: '56px',
                      height: '56px',
                      borderRadius: '50%',
                      objectFit: 'cover',
                      border: `3px solid ${color}`,
                    }}
                  />
                ) : (
                  <div
                    className="profile-avatar"
                    style={{
                      width: '56px',
                      height: '56px',
                      fontSize: '24px',
                      border: `3px solid ${color}`,
                    }}
                  >
                    {badge.userName[0]}
                  </div>
                )}
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: '16px', fontWeight: '700', color: '#e2e8f0' }}>
                    {badge.userName}
                  </div>
                  <div
                    style={{
                      fontSize: '12px',
                      color: color,
                      fontWeight: '600',
                      marginTop: '4px',
                    }}
                  >
                    {badge.icon} {badge.title}
                  </div>
                </div>
              </div>

              {/* Achievement Value */}
              <div style={{ marginTop: '16px' }}>
                <div
                  style={{
                    fontSize: '36px',
                    fontWeight: '700',
                    color: color,
                    marginBottom: '6px',
                    lineHeight: 1,
                  }}
                >
                  {badge.value}
                </div>
                <div style={{ fontSize: '13px', color: '#94a3b8', lineHeight: 1.4 }}>
                  {badge.description}
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* Scroll Hint (ì²« ë²ˆì§¸ ì¹´ë“œê°€ Meê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ) */}
      {badges.length > 1 && !badges[0].isMe && (
        <div
          style={{
            marginTop: '12px',
            fontSize: '12px',
            color: '#64748b',
            textAlign: 'center',
          }}
        >
          â† ì¢Œìš°ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ë” ë§ì€ ë°°ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš” â†’
        </div>
      )}
    </div>
  );
};

// Smart Active Squad - ì˜¤ëŠ˜ + ì–´ì œ ìš´ë™í•œ ë©¤ë²„ í‘œì‹œ
const DailySquad = ({ squad }: { squad: Array<any> }) => {

  if (squad.length === 0) {
    return (
      <div className="section">
        <h3>ğŸ‘¥ Active Squad</h3>
        <div className="empty-state">
          <p>ìµœê·¼ í™œë™í•œ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    );
  }

  // í†µê³„ ê³„ì‚°
  const todayCount = squad.filter((m) => m.activityType === 'today').length;
  const yesterdayCount = squad.filter((m) => m.activityType === 'yesterday').length;

  const getSubtitle = () => {
    if (todayCount > 0 && yesterdayCount > 0) {
      return `ì˜¤ëŠ˜ ${todayCount}ëª…, ì–´ì œ ${yesterdayCount}ëª…ì´ ìš´ë™í–ˆìŠµë‹ˆë‹¤`;
    } else if (todayCount > 0) {
      return `${todayCount}ëª…ì´ ì˜¤ëŠ˜ ìš´ë™í–ˆìŠµë‹ˆë‹¤`;
    } else if (yesterdayCount > 0) {
      return `${yesterdayCount}ëª…ì´ ì–´ì œ ìš´ë™í–ˆìŠµë‹ˆë‹¤`;
    } else {
      return `${squad.length}ëª…ì˜ í™œì„± ë©¤ë²„`;
    }
  };

  return (
    <div
      style={{
        background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
        border: '2px solid #334155',
        borderRadius: '12px',
        padding: '20px',
      }}
    >
      <div style={{ marginBottom: '16px' }}>
        <h3 style={{ fontSize: '18px', fontWeight: '700', color: '#e2e8f0', marginBottom: '4px' }}>
          ğŸ‘¥ Active Squad
        </h3>
        <p style={{ fontSize: '13px', color: '#94a3b8', margin: 0 }}>{getSubtitle()}</p>
      </div>

      <div
        style={{
          display: 'flex',
          gap: '12px',
          overflowX: 'auto',
          paddingBottom: '8px',
        }}
      >
        {squad.map((member) => {
          // activityTypeì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ê²°ì •
          const isToday = member.activityType === 'today';
          const isYesterday = member.activityType === 'yesterday';

          const cardStyle = {
            minWidth: '160px',
            background: isToday
              ? 'rgba(139, 92, 246, 0.15)' // Today: ë³´ë¼ìƒ‰ ë°°ê²½
              : isYesterday
              ? 'rgba(255, 255, 255, 0.05)' // Yesterday: ê¸°ë³¸ ë°°ê²½
              : 'rgba(71, 85, 105, 0.3)', // Recent: íšŒìƒ‰ì¡°
            border: isToday
              ? '2px solid #8b5cf6' // Today: ë³´ë¼ìƒ‰ í…Œë‘ë¦¬
              : isYesterday
              ? '2px dashed #64748b' // Yesterday: ì ì„  íšŒìƒ‰ í…Œë‘ë¦¬
              : '2px solid #475569',
            borderRadius: '12px',
            padding: '16px',
            textAlign: 'center' as const,
            position: 'relative' as const,
            opacity: isToday ? 1 : isYesterday ? 0.85 : 0.7,
          };

          const getBadge = () => {
            if (isToday) {
              return (
                <div
                  style={{
                    position: 'absolute',
                    top: '8px',
                    left: '8px',
                    background: '#8b5cf6',
                    color: 'white',
                    padding: '2px 8px',
                    borderRadius: '6px',
                    fontSize: '10px',
                    fontWeight: '700',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '2px',
                  }}
                >
                  ğŸ”¥ Today
                </div>
              );
            } else if (isYesterday) {
              return (
                <div
                  style={{
                    position: 'absolute',
                    top: '8px',
                    left: '8px',
                    background: '#64748b',
                    color: 'white',
                    padding: '2px 8px',
                    borderRadius: '6px',
                    fontSize: '10px',
                    fontWeight: '600',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '2px',
                  }}
                >
                  âš¡ Yesterday
                </div>
              );
            }
            return null;
          };

          return (
            <div key={member.userId} style={cardStyle}>
              {/* Period Badge */}
              {getBadge()}

              {/* Activity Icon Badge */}
              <div
                style={{
                  position: 'absolute',
                  top: '8px',
                  right: '8px',
                  fontSize: '20px',
                }}
              >
                {member.mainActivity}
              </div>

              {/* Profile */}
              {member.profileImage ? (
                <img
                  src={member.profileImage}
                  alt={member.displayName}
                  style={{
                    width: '64px',
                    height: '64px',
                    borderRadius: '50%',
                    objectFit: 'cover',
                    marginBottom: '12px',
                    border: isToday ? '3px solid #8b5cf6' : '2px solid #64748b',
                  }}
                />
              ) : (
                <div
                  className="profile-avatar"
                  style={{
                    width: '64px',
                    height: '64px',
                    fontSize: '28px',
                    margin: '0 auto 12px',
                    border: isToday ? '3px solid #8b5cf6' : '2px solid #64748b',
                  }}
                >
                  {member.displayName[0]}
                </div>
              )}

              {/* Name */}
              <div
                style={{
                  fontSize: '14px',
                  fontWeight: '700',
                  color: '#e2e8f0',
                  marginBottom: '8px',
                  whiteSpace: 'nowrap',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                }}
              >
                {member.displayName}
              </div>

              {/* Workout Count */}
              <div
                style={{
                  fontSize: '12px',
                  color: '#94a3b8',
                  marginBottom: '8px',
                }}
              >
                {member.workoutCount}ê°œ ìš´ë™
              </div>

              {/* Memo Speech Bubble */}
              {member.memo && (
                <div
                  style={{
                    background: isToday ? 'rgba(139, 92, 246, 0.2)' : 'rgba(100, 116, 139, 0.2)',
                    border: isToday ? '1px solid #8b5cf6' : '1px solid #64748b',
                    borderRadius: '8px',
                    padding: '8px',
                    fontSize: '12px',
                    color: isToday ? '#c4b5fd' : '#94a3b8',
                    marginTop: '8px',
                    lineHeight: '1.4',
                    maxHeight: '60px',
                    overflow: 'hidden',
                    textOverflow: 'ellipsis',
                  }}
                >
                  ğŸ’¬ {member.memo}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
};

// Leaderboard Section Component
const LeaderboardSection = ({
  title,
  subtitle,
  rankings,
  metricType,
}: {
  title: string;
  subtitle: string;
  rankings: Array<{ userId: string; displayName: string; profileImage: string | null; value: number }>;
  metricType: 'cardio' | 'strength' | 'snowboard';
}) => {

  if (rankings.length === 0) {
    return (
      <div className="section">
        <h3>{title}</h3>
        <p style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>{subtitle}</p>
        <div className="empty-state">
          <p>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    );
  }

  const formatValue = (value: number): string => {
    switch (metricType) {
      case 'cardio':
        return formatMetric(value, 'distance');
      case 'strength':
        return formatMetric(value, 'volume');
      case 'snowboard':
        return formatMetric(value, 'count');
      default:
        return String(value);
    }
  };

  return (
    <div className="section">
      <h3>{title}</h3>
      <p style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '16px' }}>
        {subtitle}
      </p>
      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
        {rankings.map((user, index) => (
          <div
            key={user.userId}
            className="log-item"
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
              background: index < 3 ? 'var(--highlight-bg)' : undefined,
            }}
          >
            {/* ìˆœìœ„ */}
            <div
              style={{
                fontSize: '18px',
                fontWeight: '700',
                width: '30px',
                textAlign: 'center',
                color:
                  index === 0
                    ? '#FFD700'
                    : index === 1
                    ? '#C0C0C0'
                    : index === 2
                    ? '#CD7F32'
                    : 'var(--text-secondary)',
              }}
            >
              {index + 1}
            </div>

            {/* í”„ë¡œí•„ */}
            {user.profileImage ? (
              <img
                src={user.profileImage}
                alt={user.displayName}
                style={{
                  width: '40px',
                  height: '40px',
                  borderRadius: '50%',
                  objectFit: 'cover',
                }}
              />
            ) : (
              <div
                className="profile-avatar"
                style={{ width: '40px', height: '40px', fontSize: '16px' }}
              >
                {user.displayName[0]}
              </div>
            )}

            {/* ì´ë¦„ */}
            <div style={{ flex: 1, fontSize: '16px', fontWeight: '600' }}>
              {user.displayName}
            </div>

            {/* ì ìˆ˜ */}
            <div
              style={{
                fontSize: '18px',
                fontWeight: '700',
                color: 'var(--primary-color)',
              }}
            >
              {formatValue(user.value)}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};
</file>

<file path="src/storage/supabaseStorage.ts">
import type { WorkoutLog, Workout, UserProfile } from '../types';
import { supabase } from '../lib/supabase';
import { calculateAllMetrics } from '../utils/calculateMetrics';

export const formatDate = (date: Date = new Date()): string => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// Get current user ID from localStorage
const getCurrentUserId = (): string => {
  const userStr = localStorage.getItem('current_user');
  if (!userStr) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  const user = JSON.parse(userStr);
  return user.id;
};

export const getAllLogs = async (): Promise<WorkoutLog[]> => {
  try {
    const userId = getCurrentUserId();

    // Get workout logs with workouts
    const { data: logs, error: logsError } = await supabase
      .from('workout_logs')
      .select(`
        id,
        date,
        raw_text,
        normalized_text,
        memo,
        is_private,
        created_at,
        workouts (
          id,
          name,
          category,
          type,
          target,
          sets,
          reps,
          weight_kg,
          duration_min,
          distance_km,
          pace,
          speed_kph,
          incline_percent,
          resistance_level,
          adjusted_dist_km,
          volume_kg,
          run_count,
          note
        )
      `)
      .eq('user_id', userId)
      .order('created_at', { ascending: false });

    if (logsError) throw logsError;

    return (logs || []).map((log: any) => ({
      id: log.id,
      date: log.date,
      rawText: log.raw_text,
      normalizedText: log.normalized_text || '',
      workouts: (log.workouts || []).map((w: any) => ({
        name: w.name,
        category: w.category || 'gym',
        type: w.type,
        target: w.target,
        sets: w.sets,
        reps: w.reps,
        weight_kg: w.weight_kg,
        duration_min: w.duration_min,
        distance_km: w.distance_km,
        pace: w.pace,
        speed_kph: w.speed_kph,
        incline_percent: w.incline_percent,
        resistance_level: w.resistance_level,
        adjusted_dist_km: w.adjusted_dist_km,
        volume_kg: w.volume_kg,
        run_count: w.run_count,
        note: w.note,
      })),
      memo: log.memo,
      createdAt: new Date(log.created_at).getTime(),
      isPrivate: log.is_private ?? false,
    }));
  } catch (error) {
    console.error('Failed to load logs:', error);
    return [];
  }
};

export const saveLog = async (log: Omit<WorkoutLog, 'id'> & { id?: string }): Promise<WorkoutLog | null> => {
  try {
    const userId = getCurrentUserId();

    // Insert workout log
    const { data: logData, error: logError } = await supabase
      .from('workout_logs')
      .insert({
        user_id: userId,
        date: log.date,
        raw_text: log.rawText,
        normalized_text: log.normalizedText,
        memo: log.memo,
        is_private: log.isPrivate ?? false, // ê¸°ë³¸ê°’ì€ ê³µê°œ (false)
      })
      .select()
      .single();

    if (logError) throw logError;
    if (!logData) throw new Error('Failed to create workout log');

    // Insert workouts
    if (log.workouts && log.workouts.length > 0) {
      const workoutsToInsert = log.workouts.map((workout: Workout) => {
        // Typeë³„ ì „ìš© ì§€í‘œ ê³„ì‚°
        const metrics = calculateAllMetrics(workout);

        return {
          workout_log_id: logData.id,
          name: workout.name,
          category: workout.category || 'gym', // ê¸°ë³¸ê°’: gym
          type: workout.type,
          target: workout.target || 'none', // ê¸°ë³¸ê°’: none
          sets: workout.sets,
          reps: workout.reps,
          weight_kg: workout.weight_kg,
          duration_min: workout.duration_min,
          distance_km: workout.distance_km,
          pace: workout.pace,
          speed_kph: workout.speed_kph,
          incline_percent: workout.incline_percent,
          resistance_level: workout.resistance_level,
          adjusted_dist_km: metrics.adjusted_dist_km,
          volume_kg: metrics.volume_kg,
          run_count: metrics.run_count,
          note: workout.note,
        };
      });

      const { error: workoutsError } = await supabase
        .from('workouts')
        .insert(workoutsToInsert);

      if (workoutsError) throw workoutsError;
    }

    // Return saved log
    return {
      id: logData.id,
      date: log.date,
      rawText: log.rawText,
      normalizedText: log.normalizedText,
      workouts: log.workouts,
      memo: log.memo,
      createdAt: log.createdAt,
      isPrivate: log.isPrivate ?? false,
    };
  } catch (error) {
    console.error('Failed to save log:', error);
    throw new Error('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const deleteLog = async (id: string): Promise<void> => {
  try {
    const { error } = await supabase
      .from('workout_logs')
      .delete()
      .eq('id', id);

    if (error) throw error;
  } catch (error) {
    console.error('Failed to delete log:', error);
    throw new Error('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const getLogById = async (id: string): Promise<WorkoutLog | null> => {
  try {
    const { data, error } = await supabase
      .from('workout_logs')
      .select(`
        id,
        date,
        raw_text,
        normalized_text,
        memo,
        is_private,
        created_at,
        workouts (
          id,
          name,
          category,
          type,
          sets,
          reps,
          weight_kg,
          duration_min,
          note
        )
      `)
      .eq('id', id)
      .single();

    if (error) throw error;
    if (!data) return null;

    return {
      id: data.id,
      date: data.date,
      rawText: data.raw_text,
      normalizedText: data.normalized_text || '',
      workouts: (data.workouts || []).map((w: any) => ({
        name: w.name,
        category: w.category || 'gym',
        type: w.type,
        sets: w.sets,
        reps: w.reps,
        weight_kg: w.weight_kg,
        duration_min: w.duration_min,
        distance_km: null,
        pace: null,
        note: w.note,
      })),
      memo: data.memo,
      createdAt: new Date(data.created_at).getTime(),
      isPrivate: data.is_private ?? false,
    };
  } catch (error) {
    console.error('Failed to get log:', error);
    return null;
  }
};

export const generateId = (): string => {
  // Supabaseì—ì„œ UUIDë¥¼ ìë™ ìƒì„±í•˜ë¯€ë¡œ ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ í•„ìš” ì—†ì§€ë§Œ,
  // í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ (ì‹¤ì œë¡œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)
  return `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
};

// User Profile Management
export const getUserProfile = async (): Promise<UserProfile | null> => {
  try {
    const userId = getCurrentUserId();

    const { data, error } = await supabase
      .from('user_profiles')
      .select('*')
      .eq('user_id', userId)
      .maybeSingle();

    if (error) throw error;
    if (!data) return null;

    return {
      goals: data.goals,
      rawInput: data.raw_input || undefined,
      createdAt: new Date(data.created_at).getTime(),
      updatedAt: new Date(data.updated_at).getTime(),
    };
  } catch (error) {
    console.error('Failed to load profile:', error);
    return null;
  }
};

export const saveUserProfile = async (profile: UserProfile): Promise<void> => {
  try {
    const userId = getCurrentUserId();

    // Check if profile already exists
    const { data: existing } = await supabase
      .from('user_profiles')
      .select('id')
      .eq('user_id', userId)
      .maybeSingle();

    if (existing) {
      // Update existing profile
      const { error } = await supabase
        .from('user_profiles')
        .update({
          goals: profile.goals,
          raw_input: profile.rawInput || null,
        })
        .eq('user_id', userId);

      if (error) throw error;
    } else {
      // Insert new profile
      const { error } = await supabase
        .from('user_profiles')
        .insert({
          user_id: userId,
          goals: profile.goals,
          raw_input: profile.rawInput || null,
        });

      if (error) throw error;
    }
  } catch (error) {
    console.error('Failed to save profile:', error);
    throw new Error('í”„ë¡œí•„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const deleteUserProfile = async (): Promise<void> => {
  try {
    const userId = getCurrentUserId();

    const { error } = await supabase
      .from('user_profiles')
      .delete()
      .eq('user_id', userId);

    if (error) throw error;
  } catch (error) {
    console.error('Failed to delete profile:', error);
    throw new Error('í”„ë¡œí•„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};
</file>

<file path="package.json">
{
  "name": "voice-workout-log",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "netlify dev",
    "dev:vite": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview",
    "migrate": "tsx migrate-user-data.ts"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "@supabase/supabase-js": "^2.89.0",
    "openai": "^4.104.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.11.0",
    "zod": "^3.25.76"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@netlify/functions": "^5.1.2",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "netlify-cli": "^23.13.5",
    "tsx": "^4.19.2",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}
</file>

<file path="src/types/index.ts">
export type RecordingState =
  | 'idle'
  | 'listening'
  | 'transcribing'
  | 'parsing'
  | 'review'
  | 'error';

// Matrix Classification: 2ì¶• ë¶„ë¥˜ ì²´ê³„
// ì¶• 1: Category (ì¹´í…Œê³ ë¦¬) - "ì–´ë””ì„œ/ì–´ë–¤ íŒì—ì„œ ë†€ì•˜ëŠ”ê°€?"
export type WorkoutCategory = 'gym' | 'snowboard' | 'running' | 'sports' | 'home' | 'other';

// ì¶• 2: Type (íŠ¸ë ˆì´ë‹ íƒ€ì…) - "ëª¸ì„ ì–´ë–»ê²Œ ì¡°ì¡ŒëŠ”ê°€?"
export type WorkoutType = 'strength' | 'cardio' | 'skill' | 'flexibility' | 'unknown';

// Level 3: Target (íƒ€ê²Ÿ ë¶€ìœ„) - "ì–´ë””ë¥¼ ì¡°ì¡ŒëŠ”ê°€?" (ê·¼ë ¥ ìš´ë™ ìƒì„¸ ë¶„ë¥˜)
export type WorkoutTarget = 'upper' | 'lower' | 'core' | 'full' | 'none';

// Legacy type for backward compatibility
export type LegacyWorkoutType = 'strength' | 'cardio' | 'core' | 'mobility' | 'snowboard' | 'unknown';

export interface Workout {
  name: string;
  sets: number | null;
  reps: number | null;
  weight_kg: number | null;
  duration_min: number | null;
  distance_km: number | null;
  pace: string | null; // "5:30" (5ë¶„ 30ì´ˆ/km)

  // Matrix Classification
  category: WorkoutCategory; // ì¹´í…Œê³ ë¦¬ (ì¥ì†Œ/ì¢…ëª©)
  type: WorkoutType; // íŠ¸ë ˆì´ë‹ íƒ€ì… (ìš´ë™ íš¨ê³¼)
  target?: WorkoutTarget; // íƒ€ê²Ÿ ë¶€ìœ„ (ê·¼ë ¥ ìš´ë™ë§Œ í•´ë‹¹)

  // Cardio ìƒì„¸ ì •ë³´
  speed_kph?: number | null; // ì†ë„ (km/h)
  incline_percent?: number | null; // ê²½ì‚¬ë„ (%)
  resistance_level?: number | null; // ì €í•­ ë ˆë²¨ (ì‚¬ì´í´, ë¡œì‰ ë“±)

  // Typeë³„ ì „ìš© ë¹„êµ ì§€í‘œ (ë¦¬ë”ë³´ë“œìš©)
  adjusted_dist_km?: number | null; // ğŸƒ ì¹´ë””ì˜¤: í‰ì§€ í™˜ì‚° ê±°ë¦¬ (ì¸í´ë¼ì¸ ë³´ì •) - DEPRECATED, ì§‘ê³„ ì‹œ ê³„ì‚°
  volume_kg?: number | null; // ğŸ‹ï¸ ê·¼ë ¥: ì´ ë³¼ë¥¨ (ë¬´ê²Œ * ì„¸íŠ¸ * íšŸìˆ˜)
  run_count?: number | null; // ğŸ‚ ìŠ¤í‚¬/ìŠ¤ë…¸ë³´ë“œ: ëŸ° ìˆ˜ / ì‹œë„ íšŸìˆ˜

  note: string | null;
}

export interface WorkoutLog {
  id: string;
  date: string; // YYYY-MM-DD
  rawText: string;
  normalizedText: string;
  workouts: Workout[];
  memo: string | null;
  createdAt: number;
  isPrivate?: boolean; // ë¹„ê³µê°œ ì—¬ë¶€ (true: ë‚˜ë§Œ ë³´ê¸°, false: í´ëŸ½ ë©¤ë²„ì™€ ê³µìœ )
  // í´ëŸ½ ë©¤ë²„ ë¡œê·¸ ì¡°íšŒ ì‹œ ì¶”ê°€ ì •ë³´
  userId?: string;
  userDisplayName?: string;
  userProfileImage?: string | null;
}

export interface SpeechRecognitionHookResult {
  isListening: boolean;
  transcript: string;
  interimTranscript: string;
  error: string | null;
  isSupported: boolean;
  startListening: () => void;
  stopListening: () => void;
  resetTranscript: () => void;
}

export interface UserProfile {
  // ê¸°ë³¸ ì •ë³´
  age?: number;
  gender?: 'male' | 'female' | 'other';
  height?: number; // cm
  weight?: number; // kg

  // ìš´ë™ ê²½ë ¥ & ìˆ˜ì¤€
  experienceLevel?: 'beginner' | 'intermediate' | 'advanced'; // ì…ë¬¸/ì´ˆê¸‰/ì¤‘ê¸‰/ê³ ê¸‰
  experienceMonths?: number; // ìš´ë™ ê²½ë ¥ (ê°œì›”)

  // ëª©í‘œ & ì„ í˜¸
  goals: string; // AIê°€ ì •ë¦¬í•œ ìš´ë™ ëª©í‘œ ë° ë°°ê²½
  primaryGoal?: 'muscle_gain' | 'strength' | 'endurance' | 'weight_loss' | 'sport_performance' | 'general_fitness';
  preferredWorkouts?: string[]; // ì„ í˜¸ ìš´ë™ ì¢…ë¥˜
  avoidedWorkouts?: string[]; // íšŒí”¼í•  ìš´ë™ (ë¶€ìƒ ë“±)

  // ì œì•½ ì‚¬í•­
  injuries?: string[]; // ë¶€ìƒ ì´ë ¥
  availableEquipment?: 'home' | 'gym' | 'bodyweight' | 'mixed';
  availableTime?: {
    sessionsPerWeek: number;
    minutesPerSession: number;
  };

  // ë¼ì´í”„ìŠ¤íƒ€ì¼
  activityLevel?: 'sedentary' | 'moderate' | 'active' | 'very_active';
  sleepHours?: number;
  stressLevel?: 'low' | 'medium' | 'high';

  // ë‚œì´ë„ ì„ í˜¸ë„
  preferredIntensity?: {
    weight: 'conservative' | 'moderate' | 'progressive'; // ë¬´ê²Œ ì¦ê°€ ì†ë„
    volume: 'low' | 'medium' | 'high'; // ìš´ë™ëŸ‰
  };

  // ë©”íƒ€ ì •ë³´
  rawInput?: string; // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì›ë³¸ í…ìŠ¤íŠ¸ (ì°¸ê³ ìš©)
  conversationHistory?: Array<{
    question: string;
    answer: string;
    timestamp: number;
  }>; // ëŒ€í™” ì´ë ¥
  createdAt: number;
  updatedAt: number;
}

export interface TodoWorkout {
  name: string;
  sets?: number;
  reps?: number;
  weight_kg?: number;
  duration_min?: number;
  distance_km?: number;
  pace?: string;
  note?: string;
  completed: boolean;
}

export interface DailyTodo {
  id: string;
  date: string; // YYYY-MM-DD
  source: 'ai_recommendation' | 'manual'; // AI ì¶”ì²œì¸ì§€ ìˆ˜ë™ ì¶”ê°€ì¸ì§€

  // AI ì¶”ì²œ ìƒì„¸ ì •ë³´
  aiRecommendation?: {
    analysisResult: string;      // STEP 1: ë°ì´í„° ë¶„ì„ ê²°ê³¼
    initialRecommendation: string; // STEP 2: ì´ˆê¸° ì¶”ì²œ
    conversationHistory?: Array<{  // ëŒ€í™” ì´ë ¥
      role: 'user' | 'assistant';
      content: string;
      timestamp: number;
    }>;
    finalRecommendation: string;   // ìµœì¢… í™•ì •ëœ ì¶”ì²œ
    userFeedback?: string;         // ì‚¬ìš©ì í”¼ë“œë°±/ìˆ˜ì • ë‚´ìš©
    finalizedAt?: number;          // í™•ì • ì‹œê°„
  };

  workouts: TodoWorkout[];
  createdAt: number;
}

// ============================================
// Clubs System Types
// ============================================

// Dashboard Widget Types
export type DashboardWidgetType = 'live_ticker' | 'hall_of_fame' | 'daily_squad' | 'leaderboard';

export interface DashboardWidget {
  id: string;
  type: DashboardWidgetType;
  visible: boolean;
  order: number;
  config?: {
    metricType?: 'cardio' | 'strength' | 'snowboard';
    [key: string]: any;
  };
}

export interface DashboardConfig {
  widgets: DashboardWidget[];
}

export interface Club {
  id: string;
  name: string;
  description: string | null;
  is_public: boolean;
  invite_code: string;
  owner_id: string;
  created_at: string;
  updated_at: string;
  dashboard_config?: DashboardConfig;
}

export interface ClubWithMemberInfo extends Club {
  my_role: 'owner' | 'admin' | 'member';
  joined_at: string;
}

export interface ClubDetail extends Club {
  member_count: number;
  active_challenge_count: number;
}

export interface ClubMember {
  id: string;
  club_id: string;
  user_id: string;
  role: 'owner' | 'admin' | 'member';
  joined_at: string;
}

export interface User {
  id: string;
  username: string;
  display_name: string;
  profile_image: string | null;
}

export interface ClubMemberWithUser extends ClubMember {
  user: User;
}

export interface ClubFeed {
  id: string;
  club_id: string;
  user_id: string;
  workout_log_id: string;
  shared_at: string;
}

export interface ClubFeedWithDetails extends Omit<ClubFeed, 'user_id' | 'workout_log_id'> {
  user: User;
  workout_log: WorkoutLog;
}

// ============================================
// Two-Track Challenge System Types
// ============================================

export type ChallengeScope = 'global' | 'club';
export type ChallengeGoalMetric = 'total_workouts' | 'total_volume' | 'total_duration' | 'total_distance';
export type ChallengeStatus = 'active' | 'completed' | 'failed';

// Global ì±Œë¦°ì§€ ë©”íƒ€ë°ì´í„°
export interface GlobalChallengeMetadata {
  season?: string; // "2026-Winter"
  tier?: 'bronze' | 'silver' | 'gold' | 'platinum';
  badge_url?: string;
  reward?: string;
}

// Club ì±Œë¦°ì§€ ë©”íƒ€ë°ì´í„°
export interface ClubChallengeMetadata {
  bet_mode?: boolean;
  penalty?: string; // "ëŒ„ìŠ¤ì˜ìƒ ì˜¬ë¦¬ê¸°"
  meme_image?: string;
  custom_data?: Record<string, any>;
}

export interface Challenge {
  id: string;
  scope: ChallengeScope;
  club_id: string | null; // globalì´ë©´ null, clubì´ë©´ í•„ìˆ˜
  created_by: string;

  title: string;
  description: string | null;

  goal_metric: ChallengeGoalMetric;
  goal_value: number;
  current_value: number;

  start_date: string; // YYYY-MM-DD
  end_date: string;   // YYYY-MM-DD

  status: ChallengeStatus;

  meta_data: GlobalChallengeMetadata | ClubChallengeMetadata | Record<string, any>;

  origin_challenge_id: string | null; // í¬í¬ëœ ê²½ìš° ì›ë³¸ ID

  created_at: string;
  updated_at: string;
}

// ê¸°ì¡´ ClubChallenge íƒ€ì…ì€ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€ (deprecated)
// @deprecated Use Challenge with scope='club' instead
export interface ClubChallenge {
  id: string;
  club_id: string;
  title: string;
  description: string | null;
  challenge_type: ChallengeGoalMetric;
  target_value: number;
  current_value: number;
  start_date: string;
  end_date: string;
  status: ChallengeStatus;
  created_by: string;
  created_at: string;
  updated_at: string;
}

export interface ChallengeContributor {
  user: User;
  total_contribution: number;
}

export interface ChallengeDetailWithContributors extends ClubChallenge {
  contributors: ChallengeContributor[];
}
</file>

<file path="src/App.css">
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

:root {
  /* White Theme with Pink/Blue Gradient Accent */
  --primary-color: #4FC3F7;
  --primary-hover: #29B6F6;
  --secondary-color: #FF6B9D;
  --secondary-hover: #FF4081;
  --danger-color: #FF6B9D;
  --danger-hover: #FF4081;
  --success-color: #66BB6A;
  --bg-color: #FFFFFF;
  --card-bg: #FFFFFF;
  --card-hover-bg: #F5F9FF;
  --text-primary: #2C3E50;
  --text-secondary: #7B8794;
  --border-color: #E1E8ED;
  --input-bg: #F8FAFB;
  --gradient-primary: linear-gradient(135deg, #4FC3F7 0%, #FF6B9D 100%);
  --gradient-light: linear-gradient(135deg, rgba(79, 195, 247, 0.1) 0%, rgba(255, 107, 157, 0.1) 100%);
  --shadow-sm: 0 2px 8px rgba(79, 195, 247, 0.1);
  --shadow-md: 0 4px 16px rgba(79, 195, 247, 0.15);
  --shadow-lg: 0 8px 24px rgba(79, 195, 247, 0.2);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background: linear-gradient(180deg, #FFFFFF 0%, #F8FBFF 50%, #FFF5F8 100%);
  background-attachment: fixed;
  color: var(--text-primary);
  overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
}

html {
  overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ì™„ì „ ë°©ì§€ */
}

.container {
  max-width: 100%;
  margin: 0 auto;
  padding: 16px;
  min-height: 100vh;
  overflow-x: hidden; /* ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë„ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
}

@media (min-width: 768px) {
  .container {
    max-width: 600px;
  }
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
}

.header h1 {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
}

.header h2 {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}

.nav-button,
.back-button {
  background: none;
  border: 1px solid var(--border-color);
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-primary);
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.nav-button:hover,
.back-button:hover {
  background-color: var(--card-hover-bg);
  border-color: var(--primary-color);
}

.mode-selector {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin: 20px 0 8px;
}

.mode-button {
  flex: 1;
  max-width: 180px;
  padding: 12px 24px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background: var(--card-bg);
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  color: var(--text-secondary);
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.mode-button:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--card-hover-bg);
}

.mode-button.active {
  border-color: var(--primary-color);
  background-color: var(--primary-color);
  color: #FFFFFF;
}

.mode-description {
  text-align: center;
  margin-bottom: 20px;
}

.mode-description p {
  font-size: 14px;
  color: var(--text-secondary);
}

/* Input Mode Selector (Voice vs Text) */
.input-mode-selector {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin: 20px 0 24px;
}

.input-mode-button {
  flex: 1;
  max-width: 180px;
  padding: 12px 24px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background: var(--card-bg);
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  color: var(--text-secondary);
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.input-mode-button:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--card-hover-bg);
}

.input-mode-button.active {
  border-color: var(--primary-color);
  background-color: var(--primary-color);
  color: #FFFFFF;
}

/* Text Input Section */
.text-input-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  padding: 20px;
}

.text-input-area {
  width: 100%;
  max-width: 600px;
  min-height: 140px;
  padding: 16px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 15px;
  font-family: 'Noto Sans KR', sans-serif;
  resize: vertical;
  line-height: 1.6;
  transition: border-color 0.2s;
  background: var(--input-bg);
  color: var(--text-primary);
}

.text-input-area:focus {
  outline: none;
  border-color: var(--primary-color);
}

.text-input-area::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
}

/* Add Button */
.add-button {
  background: var(--gradient-primary);
  border: none;
  color: #FFFFFF;
  padding: 10px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
  font-family: 'Noto Sans KR', sans-serif;
  box-shadow: var(--shadow-sm);
}

.add-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.recording-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
  padding: 40px 20px;
}

.status-text {
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}

.status-text.listening {
  color: var(--danger-color);
}

.mic-button {
  width: 140px;
  height: 140px;
  border-radius: 50%;
  border: none;
  background: var(--gradient-primary);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  box-shadow: var(--shadow-lg);
}

.mic-button:hover {
  transform: scale(1.08);
  box-shadow: 0 8px 32px rgba(79, 195, 247, 0.3);
}

.mic-button.active {
  background: linear-gradient(135deg, #FF6B9D 0%, #FF4081 100%);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% {
    box-shadow: 0 0 20px rgba(244, 135, 113, 0.4);
  }
  50% {
    box-shadow: 0 0 40px rgba(244, 135, 113, 0.8);
  }
}

/* Date Selector Section */
.date-selector-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
}

.date-selector-section h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.date-mode-buttons {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.date-mode-button {
  flex: 1;
  padding: 10px 20px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background: var(--input-bg);
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.date-mode-button:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  background: var(--card-hover-bg);
}

.date-mode-button.active {
  border-color: var(--primary-color);
  background-color: var(--primary-color);
  color: #FFFFFF;
}

.date-picker {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 14px;
  font-family: 'Noto Sans KR', sans-serif;
  margin-bottom: 12px;
  cursor: pointer;
  transition: border-color 0.2s;
  background: var(--input-bg);
  color: var(--text-primary);
  color-scheme: dark;
}

.date-picker:focus {
  outline: none;
  border-color: var(--primary-color);
}

.selected-date-display {
  text-align: center;
  padding: 8px;
  background: var(--input-bg);
  border-radius: 6px;
  font-size: 14px;
  color: var(--text-secondary);
}

.selected-date-display strong {
  color: var(--primary-color);
  font-weight: 600;
}

/* Input Guide */
.input-guide {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  gap: 8px;
  max-width: 600px;
  margin: 16px auto 8px;
  padding: 12px 16px;
  background: var(--card-bg);
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.guide-item {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
  padding: 4px 8px;
  background: var(--input-bg);
  border-radius: 4px;
  white-space: nowrap;
}

.guide-separator {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 300;
}

.guide-note {
  font-size: 12px;
  color: var(--text-secondary);
  text-align: center;
  margin-top: 8px;
  font-style: italic;
}

.guide-example {
  font-size: 13px;
  color: var(--primary-color);
  text-align: center;
  margin-top: 4px;
  margin-bottom: 16px;
  font-weight: 500;
}

.hint-text {
  font-size: 14px;
  color: var(--text-secondary);
}

.transcript-box {
  width: 100%;
  max-width: 600px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 20px;
  min-height: 120px;
  max-height: 300px;
  overflow-y: auto;
}

.ai-preview-label {
  font-size: 12px;
  color: var(--primary-color);
  font-weight: 600;
  margin-bottom: 12px;
  padding: 6px 12px;
  background: rgba(0, 122, 204, 0.15);
  border-radius: 6px;
  text-align: center;
}

.transcript-final {
  font-size: 16px;
  line-height: 1.6;
  margin-bottom: 8px;
  color: var(--text-primary);
}

.transcript-interim {
  font-size: 16px;
  line-height: 1.6;
  color: var(--text-secondary);
  font-style: italic;
}

.ai-recording-info {
  text-align: center;
  margin-top: 20px;
  padding: 20px;
  background: var(--card-bg);
  border: 2px dashed var(--primary-color);
  border-radius: 8px;
  max-width: 400px;
}

.ai-recording-info p {
  font-size: 16px;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.ai-recording-note {
  font-size: 14px !important;
  color: var(--text-secondary) !important;
  font-style: italic;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border-color);
  border-top-color: var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.review-section {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow-sm);
}

.section h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.edit-textarea {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 15px;
  font-family: 'Noto Sans KR', sans-serif;
  resize: vertical;
  margin-bottom: 12px;
  background: var(--input-bg);
  color: var(--text-primary);
}

.edit-textarea:focus {
  outline: none;
  border-color: var(--primary-color);
}

.secondary-button {
  background: none;
  border: 1px solid var(--primary-color);
  color: var(--primary-color);
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.secondary-button:hover {
  background-color: var(--primary-color);
  color: #FFFFFF;
}

.workout-cards {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.workout-card {
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 20px;
  position: relative;
  border-left-width: 4px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s;
}

.workout-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.workout-card.strength {
  border-left-color: #3b82f6;
}

.workout-card.cardio {
  border-left-color: #ef4444;
}

.workout-card.core {
  border-left-color: #f59e0b;
}

.workout-card.mobility {
  border-left-color: #10b981;
}

.workout-card.snowboard {
  border-left-color: #8b5cf6;
}

.workout-card.unknown {
  border-left-color: var(--text-secondary);
}

.workout-name {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text-primary);
}

.workout-details {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 14px;
  color: var(--text-secondary);
}

.workout-details span {
  background: var(--card-bg);
  padding: 4px 10px;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.workout-details span.weight {
  background: var(--primary-color);
  color: #FFFFFF;
  border-color: var(--primary-color);
  font-weight: 600;
}

.no-details {
  font-style: italic;
}

.workout-note {
  margin-top: 8px;
  font-size: 13px;
  color: var(--text-secondary);
  font-style: italic;
}

.workout-type-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  font-size: 11px;
  text-transform: uppercase;
  color: var(--text-secondary);
  background: var(--card-bg);
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.empty-message {
  text-align: center;
  color: var(--text-secondary);
  padding: 20px;
}

.action-buttons {
  display: flex;
  gap: 12px;
  margin-top: 8px;
}

.primary-button {
  flex: 1;
  background: var(--gradient-primary);
  color: #FFFFFF;
  border: none;
  padding: 16px 28px;
  border-radius: 16px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.3s;
  font-family: 'Noto Sans KR', sans-serif;
  box-shadow: var(--shadow-sm);
}

.primary-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.cancel-button {
  flex: 1;
  background: none;
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  padding: 14px 24px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 500;
  transition: all 0.3s;
  font-family: 'Noto Sans KR', sans-serif;
}

.cancel-button:hover {
  background-color: var(--card-hover-bg);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.complete-button {
  background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 100%);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 14px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  transition: all 0.3s;
  font-family: 'Noto Sans KR', sans-serif;
  box-shadow: var(--shadow-sm);
}

.complete-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.error-message {
  text-align: center;
  padding: 40px 20px;
}

.error-message h2 {
  margin-bottom: 16px;
  color: var(--danger-color);
}

.error-message p {
  margin-bottom: 12px;
  color: var(--text-secondary);
}

.error-message button {
  margin-top: 20px;
  background-color: var(--primary-color);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  font-family: 'Noto Sans KR', sans-serif;
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.date-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.date-header {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
}

.log-item {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: var(--shadow-sm);
}

.log-item:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-4px);
  border-color: var(--primary-color);
}

.log-preview {
  font-size: 15px;
  line-height: 1.5;
  margin-bottom: 8px;
  color: var(--text-primary);
}

.log-meta {
  display: flex;
  gap: 12px;
  font-size: 13px;
  color: var(--text-secondary);
}

.log-count {
  font-weight: 500;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
}

.empty-state p {
  font-size: 16px;
  color: var(--text-secondary);
  margin-bottom: 24px;
}

.detail-section {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.detail-date {
  font-size: 20px;
  font-weight: 600;
  color: var(--primary-color);
  margin-bottom: 8px;
}

.detail-text {
  font-size: 15px;
  line-height: 1.6;
  white-space: pre-wrap;
  color: var(--text-primary);
}

.delete-button {
  background-color: var(--danger-color);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
  margin-top: 12px;
  font-family: 'Noto Sans KR', sans-serif;
}

.delete-button:hover {
  background-color: var(--danger-hover);
}

/* Bottom Navigation */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 0 8px;
  z-index: 1000;
  box-shadow: 0 -2px 16px rgba(79, 195, 247, 0.1);
}

.bottom-nav .nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 8px;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-secondary);
  transition: all 0.2s;
  border-radius: 8px;
  min-width: 60px;
  font-family: 'Noto Sans KR', sans-serif;
}

.bottom-nav .nav-item:hover {
  background-color: var(--card-hover-bg);
}

.bottom-nav .nav-item.active {
  background: var(--gradient-light);
  color: var(--primary-color);
}

.bottom-nav .nav-item.active svg {
  transform: scale(1.1);
}

.bottom-nav .nav-item span {
  font-size: 12px;
  font-weight: 500;
}

/* 3-tab layout - equal spacing */
.bottom-nav-3 .nav-item {
  max-width: 140px;
}

/* Layout with BottomNav */
.app-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  padding-top: 60px;
  padding-bottom: 70px;
}

/* Header */
.app-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border-color);
  z-index: 1000;
  box-shadow: var(--shadow-sm);
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
}

.header-logo h1 {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.business-info-header {
  font-size: 10px;
  color: #999;
  margin-top: 4px;
  font-weight: 400;
}

@media (max-width: 768px) {
  .business-info-header {
    font-size: 8px;
    margin-top: 2px;
  }
}

.header-profile {
  position: relative;
}

.profile-button {
  display: flex;
  align-items: center;
  gap: 10px;
  background: none;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.profile-button:hover {
  background-color: var(--card-hover-bg);
  border-color: var(--primary-color);
}

.profile-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 600;
}

.profile-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
}

.dropdown-arrow {
  transition: transform 0.2s;
  color: var(--text-secondary);
}

.dropdown-arrow.open {
  transform: rotate(180deg);
}

.profile-dropdown {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  min-width: 250px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  overflow: hidden;
  animation: dropdownFadeIn 0.2s ease;
}

@keyframes dropdownFadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.dropdown-header {
  padding: 16px;
  background: var(--input-bg);
}

.dropdown-user-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.dropdown-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 600;
}

.dropdown-user-details {
  flex: 1;
}

.dropdown-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 2px;
}

.dropdown-email {
  font-size: 12px;
  color: var(--text-secondary);
}

.dropdown-divider {
  height: 1px;
  background: var(--border-color);
}

.dropdown-item {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-primary);
  transition: all 0.2s;
  text-align: left;
  font-family: 'Noto Sans KR', sans-serif;
}

.dropdown-item:hover {
  background: var(--card-hover-bg);
}

.dropdown-item svg {
  color: var(--text-secondary);
}

/* Recommend Page */
.recommend-header {
  text-align: center;
  margin-bottom: 32px;
}

.recommend-header h1 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--text-primary);
}

.recommend-header .subtitle {
  font-size: 14px;
  color: var(--text-secondary);
}

.recommend-empty {
  text-align: center;
  padding: 60px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.recommend-empty p {
  color: var(--text-secondary);
  margin: 0;
}

.recommend-empty svg {
  margin-bottom: 20px;
  color: var(--primary-color);
}

.recommend-loading {
  text-align: center;
  padding: 60px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.recommend-loading p {
  color: var(--text-secondary);
}

.recommend-result {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.recommend-content {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 24px;
  line-height: 1.8;
}

.recommend-content p {
  margin-bottom: 12px;
  white-space: pre-wrap;
  color: var(--text-primary);
}

.recommend-content p:last-child {
  margin-bottom: 0;
}

.error-box {
  background: rgba(244, 135, 113, 0.1);
  border: 1px solid var(--danger-color);
  border-radius: 8px;
  padding: 20px;
  text-align: center;
}

.error-box p {
  color: var(--danger-color);
  margin-bottom: 16px;
}

/* Profile Setup */
.profile-setup {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.setup-instruction {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 20px;
}

.setup-instruction h3 {
  font-size: 17px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.instruction-text {
  font-size: 14px;
  color: var(--text-secondary);
  line-height: 1.6;
}

.profile-input {
  width: 100%;
  min-height: 180px;
  padding: 16px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-size: 15px;
  font-family: 'Noto Sans KR', sans-serif;
  resize: vertical;
  line-height: 1.6;
  background: var(--input-bg);
  color: var(--text-primary);
}

.profile-input:focus {
  outline: none;
  border-color: var(--primary-color);
}

.setup-buttons {
  display: flex;
  gap: 12px;
}

.setup-buttons .primary-button:disabled {
  background-color: var(--text-secondary);
  cursor: not-allowed;
  opacity: 0.5;
}

.setup-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
  padding: 20px;
}

.setup-loading p {
  color: var(--text-secondary);
  font-size: 14px;
}

/* Profile Display */
.profile-display {
  background: var(--gradient-light);
  border: 2px solid transparent;
  background-clip: padding-box;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
  position: relative;
}

.profile-display::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 16px;
  padding: 2px;
  background: var(--gradient-primary);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  z-index: -1;
}

.profile-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.profile-header h3 {
  font-size: 16px;
  font-weight: 600;
  color: var(--primary-color);
  margin: 0;
}

.profile-actions {
  display: flex;
  gap: 8px;
}

.edit-button {
  background: none;
  border: 1px solid var(--primary-color);
  color: var(--primary-color);
  padding: 6px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.edit-button:hover {
  background-color: var(--primary-color);
  color: white;
}

.delete-icon-button {
  background: none;
  border: 1px solid var(--danger-color);
  color: var(--danger-color);
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.delete-icon-button:hover {
  background-color: var(--danger-color);
  color: white;
}

.profile-content {
  font-size: 15px;
  line-height: 1.8;
  color: var(--text-primary);
  white-space: pre-wrap;
}

/* Recommend CTA */
.recommend-cta {
  text-align: center;
  padding: 40px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.recommend-cta svg {
  margin-bottom: 16px;
  color: var(--primary-color);
}

.recommend-cta p {
  color: var(--text-secondary);
  margin: 0;
  font-size: 15px;
}

.large-button {
  margin-top: 16px;
  padding: 16px 40px;
  font-size: 17px;
}

/* Result Actions */
.result-actions {
  display: flex;
  gap: 12px;
  margin-top: 8px;
}

/* Today Feeling Section */
.today-feeling-section {
  background: var(--gradient-light);
  border: 2px solid transparent;
  background-clip: padding-box;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
  position: relative;
}

.today-feeling-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 16px;
  padding: 2px;
  background: var(--gradient-primary);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  z-index: -1;
}

.today-feeling-section h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--primary-color);
}

.feeling-input {
  width: 100%;
  min-height: 100px;
  padding: 14px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 15px;
  font-family: 'Noto Sans KR', sans-serif;
  resize: vertical;
  line-height: 1.6;
  transition: border-color 0.2s;
  margin-bottom: 12px;
  background: var(--input-bg);
  color: var(--text-primary);
}

.feeling-input:focus {
  outline: none;
  border-color: var(--primary-color);
}

.feeling-input::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
}

.feeling-hint {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
  margin: 0;
}

/* History Workout View */
.history-workout-view {
  display: flex;
  flex-direction: column;
  gap: 28px;
}

.history-date-section {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.history-date-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 18px;
  font-weight: 600;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
  color: var(--text-primary);
}

.session-count {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
}

.history-session {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.session-time {
  font-size: 13px;
  font-weight: 500;
  color: var(--primary-color);
}

.session-workouts {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
}

.history-workout-card {
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 12px;
  border-left-width: 4px;
}

.history-workout-card.strength {
  border-left-color: #3b82f6;
}

.history-workout-card.cardio {
  border-left-color: #ef4444;
}

.history-workout-card.core {
  border-left-color: #f59e0b;
}

.history-workout-card.mobility {
  border-left-color: #10b981;
}

.history-workout-card.snowboard {
  border-left-color: #8b5cf6;
}

.history-workout-card.unknown {
  border-left-color: var(--text-secondary);
}

.hw-name {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--text-primary);
}

.hw-details {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 12px;
  color: var(--text-secondary);
}

.hw-weight {
  font-weight: 600;
  color: var(--primary-color);
}

.session-detail-button {
  align-self: flex-start;
  background: none;
  border: 1px solid var(--primary-color);
  color: var(--primary-color);
  padding: 6px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.session-detail-button:hover {
  background: var(--primary-color);
  color: white;
}

/* Todo Page */
.todo-header-card {
  background: var(--gradient-light);
  border: 2px solid transparent;
  background-clip: padding-box;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
  position: relative;
}

.todo-header-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  border-radius: 16px;
  padding: 2px;
  background: var(--gradient-primary);
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  z-index: -1;
}

.todo-date {
  font-size: 20px;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 16px;
}

.todo-progress-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.progress-bar-container {
  width: 100%;
  height: 10px;
  background: var(--border-color);
  border-radius: 5px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color) 0%, var(--success-color) 100%);
  transition: width 0.3s ease;
}

.progress-text {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
}

.todo-source-badge {
  display: inline-block;
  background: var(--primary-color);
  color: white;
  padding: 4px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  margin-top: 8px;
}

.ai-recommendation-preview {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
}

.recommendation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  cursor: pointer;
  user-select: none;
}

.recommendation-header h3 {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.expand-button {
  background: none;
  border: none;
  color: var(--primary-color);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.expand-button:hover {
  background: rgba(0, 122, 204, 0.15);
}

.ai-recommendation-text {
  font-size: 14px;
  line-height: 1.6;
  color: var(--text-secondary);
  white-space: pre-wrap;
  transition: max-height 0.3s ease;
  overflow: hidden;
}

.ai-recommendation-text.collapsed {
  max-height: 80px;
}

.ai-recommendation-text.expanded {
  max-height: none;
}

.add-todo-button {
  background: none;
  border: 1px solid var(--primary-color);
  color: var(--primary-color);
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.add-todo-button:hover {
  background-color: var(--primary-color);
  color: white;
}

.todo-workout-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.todo-workout-list h3 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--text-primary);
}

.todo-workout-item {
  display: flex;
  gap: 14px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s;
  align-items: flex-start;
}

.todo-workout-item:hover {
  box-shadow: 0 0 15px rgba(0, 122, 204, 0.2);
}

.todo-workout-item.completed {
  background: var(--input-bg);
  border-color: var(--success-color);
  opacity: 0.7;
}

.todo-workout-item.completed .todo-workout-name {
  text-decoration: line-through;
  color: var(--text-secondary);
}

.todo-checkbox {
  width: 24px;
  height: 24px;
  border: 2px solid var(--border-color);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  background: var(--input-bg);
  transition: all 0.2s;
}

.todo-workout-item.completed .todo-checkbox {
  background: var(--success-color);
  border-color: var(--success-color);
}

.todo-checkbox svg {
  color: white;
}

.todo-workout-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.todo-workout-name {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.todo-workout-specs {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 14px;
  color: var(--text-secondary);
}

.spec-weight {
  font-weight: 600;
  color: var(--primary-color);
}

.todo-workout-note {
  font-size: 13px;
  color: var(--text-secondary);
  font-style: italic;
}

.todo-completion-message {
  background: rgba(137, 209, 133, 0.1);
  border: 2px solid var(--success-color);
  border-radius: 8px;
  padding: 24px;
  margin-top: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
}

.completion-icon {
  font-size: 48px;
}

.completion-text h3 {
  font-size: 18px;
  font-weight: 700;
  color: var(--success-color);
  margin-bottom: 4px;
}

.completion-text p {
  font-size: 14px;
  color: var(--text-secondary);
}

/* Login & Signup Page */
.login-container,
.signup-container {
  max-width: 500px;
  margin: 80px auto;
  text-align: center;
  padding: 40px 20px;
}

.login-container h1 {
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--text-primary);
}

.login-subtitle,
.signup-subtitle {
  font-size: 16px;
  color: var(--text-secondary);
  margin-bottom: 40px;
}

/* Kakao Login Button */
.kakao-login-button {
  width: 100%;
  max-width: 400px;
  padding: 14px 20px;
  background-color: #FEE500;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  color: #000000;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: background-color 0.2s;
  margin: 0 auto 24px;
}

.kakao-login-button:hover {
  background-color: #FDD835;
}

.kakao-icon {
  font-size: 20px;
}

/* Divider */
.divider {
  display: flex;
  align-items: center;
  text-align: center;
  margin: 24px 0;
  color: var(--text-secondary);
}

.divider::before,
.divider::after {
  content: '';
  flex: 1;
  border-bottom: 1px solid var(--border-color);
}

.divider span {
  padding: 0 16px;
  font-size: 14px;
}

.login-form,
.signup-form {
  display: flex;
  flex-direction: column;
  gap: 20px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 32px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
  text-align: left;
}

.form-group {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 8px;
  text-align: left;
}

.form-group label {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.form-group input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 15px;
  font-family: 'Noto Sans KR', sans-serif;
  transition: border-color 0.2s;
  background: var(--input-bg);
  color: var(--text-primary);
}

.form-group input:focus {
  outline: none;
  border-color: var(--primary-color);
}

.form-group input:disabled {
  background-color: var(--card-hover-bg);
  cursor: not-allowed;
}

.login-hint {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 20px;
}

.login-hint p {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.login-hint p:last-child {
  margin-bottom: 0;
}

/* Signup Page Specific */
.field-hint {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
  font-style: italic;
}

.agreements-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px;
  background: var(--input-bg);
  border-radius: 12px;
  margin-top: 8px;
}

.agreement-item {
  display: flex;
  align-items: flex-start;
}

.checkbox-label {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-primary);
}

.checkbox-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin-top: 2px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.link-text {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 600;
  transition: all 0.2s;
}

.link-text:hover {
  color: var(--primary-hover);
  text-decoration: underline;
}

.signup-footer,
.login-footer {
  text-align: center;
  padding-top: 16px;
  border-top: 1px solid var(--border-color);
}

.signup-footer p,
.login-footer p {
  font-size: 14px;
  color: var(--text-secondary);
}

.login-business-info {
  text-align: center;
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid var(--border-color);
}

.login-business-info p {
  font-size: 11px;
  color: #999;
  margin: 0;
  line-height: 1.5;
}

/* Policy Pages */
.policy-container {
  max-width: 800px;
  margin: 40px auto;
  padding: 40px 20px;
  background: var(--card-bg);
  border-radius: 16px;
  box-shadow: var(--shadow-sm);
}

.policy-container h1 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--text-primary);
  background: var(--gradient-primary);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.policy-date {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 32px;
  font-style: italic;
}

.policy-section {
  margin-bottom: 40px;
}

.policy-section h2 {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text-primary);
  padding-bottom: 8px;
  border-bottom: 2px solid var(--border-color);
}

.policy-section h3 {
  font-size: 16px;
  font-weight: 600;
  margin-top: 20px;
  margin-bottom: 12px;
  color: var(--primary-color);
}

.policy-section p {
  font-size: 15px;
  line-height: 1.8;
  color: var(--text-primary);
  margin-bottom: 16px;
}

.policy-section ul,
.policy-section ol {
  margin-left: 24px;
  margin-bottom: 16px;
}

.policy-section li {
  font-size: 15px;
  line-height: 1.8;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.policy-section ul li {
  list-style-type: disc;
}

.policy-section ol li {
  list-style-type: decimal;
}

.contact-info {
  background: var(--gradient-light);
  padding: 20px;
  border-radius: 12px;
  margin-top: 12px;
}

.contact-info p {
  margin-bottom: 8px;
  font-size: 14px;
}

.contact-info p:last-child {
  margin-bottom: 0;
}

/* Policy Table */
.policy-section table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  background: var(--card-bg);
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--border-color);
}

.policy-section table thead {
  background: var(--gradient-light);
}

.policy-section table th {
  padding: 14px 12px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  color: var(--primary-color);
  border-bottom: 2px solid var(--border-color);
}

.policy-section table td {
  padding: 14px 12px;
  font-size: 13px;
  color: var(--text-primary);
  border-bottom: 1px solid var(--border-color);
  line-height: 1.6;
}

.policy-section table tbody tr:last-child td {
  border-bottom: none;
}

.policy-section table tbody tr:hover {
  background: var(--input-bg);
}

@media (max-width: 768px) {
  .policy-section table {
    font-size: 12px;
  }

  .policy-section table th,
  .policy-section table td {
    padding: 10px 8px;
    font-size: 11px;
  }
}

.loading-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  font-size: 18px;
  color: var(--text-secondary);
}

/* Dashboard Page */
.month-selector {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 24px;
  margin-bottom: 32px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
}

.month-nav-button {
  background: none;
  border: 1px solid var(--border-color);
  width: 40px;
  height: 40px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 20px;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.month-nav-button:hover {
  background-color: var(--card-hover-bg);
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.month-display {
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  min-width: 150px;
  text-align: center;
}

.stats-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 24px;
  margin-bottom: 24px;
}

.stats-section h2 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 20px;
  color: var(--text-primary);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  transition: all 0.2s;
}

.stat-card:hover {
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

.stat-label {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 500;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary-color);
}

.stat-note {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 4px;
  font-style: italic;
}

.type-stats {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
}

.type-stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--input-bg);
  padding: 10px 16px;
  border-radius: 6px;
  border: 1px solid var(--border-color);
}

.type-badge {
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  color: white;
}

.type-badge.strength {
  background-color: #3b82f6;
}

.type-badge.cardio {
  background-color: #ef4444;
}

.type-badge.core {
  background-color: #f59e0b;
}

.type-badge.snowboard {
  background-color: #8b5cf6;
}

.calendar-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 24px;
  margin-bottom: 24px;
}

.calendar-section h2 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 20px;
  color: var(--text-primary);
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}

.calendar-weekday {
  text-align: center;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  padding: 8px;
}

.calendar-day {
  aspect-ratio: 1;
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 8px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  position: relative;
  transition: all 0.2s;
}

.calendar-day.empty {
  background: transparent;
  border: none;
}

.calendar-day.has-workout {
  background: rgba(0, 122, 204, 0.1);
  border-color: var(--primary-color);
  cursor: pointer;
}

.calendar-day.has-workout:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(0, 122, 204, 0.3);
}

.day-number {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.workout-indicators {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  justify-content: center;
}

.indicator {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.indicator.strength {
  background-color: #3b82f6;
}

.indicator.cardio {
  background-color: #ef4444;
}

.indicator.core {
  background-color: #f59e0b;
}

.indicator.snowboard {
  background-color: #8b5cf6;
}

.calendar-legend {
  display: flex;
  gap: 16px;
  justify-content: center;
  flex-wrap: wrap;
  padding: 16px;
  background: var(--input-bg);
  border-radius: 6px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.legend-dot.strength {
  background-color: #3b82f6;
}

.legend-dot.cardio {
  background-color: #ef4444;
}

.legend-dot.core {
  background-color: #f59e0b;
}

.legend-dot.snowboard {
  background-color: #8b5cf6;
}

.legend-item span {
  font-size: 13px;
  color: var(--text-secondary);
}

/* 4-tab layout */
.bottom-nav-4 .nav-item {
  max-width: 100px;
  font-size: 11px;
}

.bottom-nav-4 .nav-item svg {
  width: 22px;
  height: 22px;
}

/* Day Cards - Compact Design */
.history-day-cards {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.day-card-compact {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 18px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s;
  border-left: 5px solid transparent;
  background-image: linear-gradient(var(--card-bg), var(--card-bg)), var(--gradient-primary);
  background-origin: border-box;
  background-clip: padding-box, border-box;
  box-shadow: var(--shadow-sm);
}

.day-card-compact:hover {
  box-shadow: var(--shadow-lg);
  transform: translateX(6px) translateY(-2px);
}

.day-card-top {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.day-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-width: 60px;
  padding: 12px;
  background: var(--gradient-primary);
  border-radius: 14px;
  box-shadow: var(--shadow-sm);
}

.day-date-short {
  font-size: 24px;
  font-weight: 700;
  color: white;
  line-height: 1;
}

.day-month-year {
  font-size: 11px;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.9);
  margin-top: 2px;
}

.day-summary {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.day-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
}

.day-stats-inline {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.stat-chip {
  font-size: 12px;
  padding: 3px 8px;
  background: var(--input-bg);
  border-radius: 4px;
  color: var(--text-secondary);
  font-weight: 500;
}

.day-arrow {
  font-size: 24px;
  color: var(--text-secondary);
  font-weight: 300;
}

.day-workouts-preview {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  padding-top: 12px;
  border-top: 1px solid var(--border-color);
}

.workout-chip {
  font-size: 12px;
  padding: 4px 10px;
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-weight: 500;
}

.workout-chip-more {
  font-size: 12px;
  padding: 4px 10px;
  background: var(--primary-color);
  border-radius: 6px;
  color: white;
  font-weight: 600;
}

/* Detail Stats Summary - Compact */
.detail-stats-summary {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
}

.detail-stat {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--input-bg);
  border-radius: 6px;
  flex: 1;
  min-width: 100px;
}

.detail-stat-label {
  font-size: 13px;
  color: var(--text-secondary);
  font-weight: 500;
}

.detail-stat-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--primary-color);
  margin-left: auto;
}

/* Session Raw Text */
.session-raw-text {
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
}

.session-raw-text:last-child {
  margin-bottom: 0;
}

.session-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.session-time {
  font-size: 13px;
  font-weight: 600;
  color: var(--primary-color);
}

.delete-session-button {
  background: none;
  border: 1px solid var(--danger-color);
  color: var(--danger-color);
  padding: 4px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.2s;
  font-family: 'Noto Sans KR', sans-serif;
}

.delete-session-button:hover {
  background: var(--danger-color);
  color: white;
}

/* Mobile Optimization */
@media (max-width: 640px) {
  .container {
    padding: 8px;
    padding-bottom: 90px;
  }

  /* ë‹¬ë ¥ ì„¹ì…˜ ëª¨ë°”ì¼ ìµœì í™” */
  .calendar-section {
    padding: 12px;
    margin-left: -8px;
    margin-right: -8px;
    border-radius: 0;
    border-left: none;
    border-right: none;
  }

  .calendar-grid {
    gap: 4px;
  }

  .calendar-day {
    padding: 4px;
    font-size: 12px;
  }

  .calendar-weekday {
    padding: 4px;
    font-size: 11px;
  }

  .day-number {
    font-size: 13px;
  }

  .indicators {
    gap: 2px;
    margin-top: 2px;
  }

  .indicator {
    width: 4px;
    height: 4px;
  }

  /* Stats Grid ëª¨ë°”ì¼ */
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .stat-card {
    padding: 12px;
  }

  .stat-value {
    font-size: 22px;
  }

  .stat-label {
    font-size: 12px;
  }

  .header {
    margin-bottom: 20px;
  }

  .header h1 {
    font-size: 20px;
  }

  .header h2 {
    font-size: 18px;
  }

  .mic-button {
    width: 130px;
    height: 130px;
  }

  .workout-cards {
    gap: 14px;
  }

  .workout-card {
    padding: 18px;
  }

  .workout-name {
    font-size: 17px;
    margin-bottom: 10px;
  }

  .primary-button,
  .cancel-button,
  .complete-button {
    padding: 18px 24px;
    font-size: 16px;
    min-height: 56px;
    border-radius: 16px;
  }

  .add-button {
    padding: 12px 24px;
    font-size: 15px;
    min-height: 48px;
  }

  .bottom-nav {
    height: 75px;
    padding: 0 4px;
  }

  .bottom-nav .nav-item {
    min-height: 60px;
    padding: 10px 8px;
    gap: 6px;
  }

  .bottom-nav .nav-item span {
    font-size: 11px;
  }

  /* Compact day cards mobile */
  .history-day-cards {
    gap: 10px;
  }

  .day-card-compact {
    padding: 12px;
    border-radius: 10px;
  }

  .day-info {
    min-width: 50px;
    padding: 6px;
  }

  .day-date-short {
    font-size: 20px;
  }

  .day-month-year {
    font-size: 10px;
  }

  .day-title {
    font-size: 14px;
  }

  .stat-chip {
    font-size: 11px;
    padding: 2px 6px;
  }

  .workout-chip {
    font-size: 11px;
    padding: 3px 8px;
  }

  .workout-chip-more {
    font-size: 11px;
    padding: 3px 8px;
  }

  /* Detail view mobile */
  .detail-stats-summary {
    padding: 12px;
    gap: 6px;
  }

  .detail-stat {
    padding: 6px 10px;
    min-width: 80px;
  }

  .detail-stat-label {
    font-size: 12px;
  }

  .detail-stat-value {
    font-size: 16px;
  }
}

/* Extra small screens */
@media (max-width: 375px) {
  .container {
    padding: 12px;
  }

  .mic-button {
    width: 110px;
    height: 110px;
  }

  .bottom-nav .nav-item span {
    font-size: 10px;
  }
}

/* Chat UI */
.chat-container {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 200px);
  max-height: 600px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: var(--shadow-md);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.chat-message {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.chat-message.user {
  justify-content: flex-end;
}

.chat-message.assistant {
  justify-content: flex-start;
}

.message-content {
  max-width: 80%;
  padding: 14px 18px;
  border-radius: 18px;
  line-height: 1.7;
  box-shadow: var(--shadow-sm);
}

.chat-message.user .message-content {
  background: var(--gradient-primary);
  color: white;
  border-bottom-right-radius: 6px;
}

.chat-message.assistant .message-content {
  background: var(--input-bg);
  color: var(--text-primary);
  border-bottom-left-radius: 6px;
  border: 1px solid var(--border-color);
}

.message-content p {
  margin: 0;
  margin-bottom: 8px;
}

.message-content p:last-child {
  margin-bottom: 0;
}

.typing-indicator {
  display: flex;
  gap: 6px;
  padding: 8px 0;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  background: var(--text-secondary);
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    opacity: 0.3;
    transform: translateY(0);
  }
  30% {
    opacity: 1;
    transform: translateY(-8px);
  }
}

.chat-input-container {
  border-top: 1px solid var(--border-color);
  padding: 16px;
  background: var(--card-bg);
}

.chat-input {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 15px;
  font-family: 'Noto Sans KR', sans-serif;
  resize: none;
  background: var(--input-bg);
  color: var(--text-primary);
  margin-bottom: 12px;
}

.chat-input:focus {
  outline: none;
  border-color: var(--primary-color);
}

.chat-input:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.chat-buttons {
  display: flex;
  gap: 12px;
}

.chat-send-button {
  background: var(--gradient-primary);
  color: white;
  border: none;
  padding: 12px 28px;
  border-radius: 14px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s;
  font-family: 'Noto Sans KR', sans-serif;
  box-shadow: var(--shadow-sm);
}

.chat-send-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.chat-send-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.chat-finalize-button {
  flex: 1;
  background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 100%);
  color: white;
  border: none;
  padding: 14px 28px;
  border-radius: 16px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  transition: all 0.3s;
  font-family: 'Noto Sans KR', sans-serif;
  box-shadow: var(--shadow-sm);
}

.chat-finalize-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.chat-finalize-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.chat-generating {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding: 20px;
  border-top: 1px solid var(--border-color);
}

.chat-generating p {
  font-size: 14px;
  color: var(--text-secondary);
}

/* Mobile Chat */
@media (max-width: 640px) {
  .chat-container {
    height: calc(100vh - 180px);
  }

  .chat-messages {
    padding: 12px;
    gap: 12px;
  }

  .message-content {
    max-width: 85%;
    padding: 10px 14px;
    font-size: 14px;
  }

  .chat-input-container {
    padding: 12px;
  }

  .chat-input {
    font-size: 14px;
  }

  .chat-buttons {
    flex-direction: column;
  }

  .chat-send-button,
  .chat-finalize-button {
    width: 100%;
  }
}

/* ============================================ */
/* Hall of Fame Carousel Styles */
/* ============================================ */

.hall-of-fame-carousel {
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
}

/* Hide scrollbar for Chrome, Safari and Opera */
.hall-of-fame-carousel::-webkit-scrollbar {
  display: none;
}

/* Hide scrollbar for IE, Edge and Firefox */
.hall-of-fame-carousel {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}
</file>

<file path="src/pages/History.tsx">
import { useState, useEffect } from 'react';
import { useLocation } from 'react-router-dom';
import type { WorkoutLog, RecordingState, Workout } from '../types';
import { getAllLogs, deleteLog, saveLog, formatDate } from '../storage/supabaseStorage';
import { useSpeechRecognition } from '../features/speech/useSpeechRecognition';
import { useWhisperRecording } from '../features/speech/useWhisperRecording';
import { normalizeText } from '../features/normalize/normalizeText';
import { parseWorkoutText } from '../features/parse/parseWorkoutText';
import { parseWithGPT } from '../features/parse/parseWithGPT';
import challengeService from '../services/challengeService';
import {
  getCategoryIcon,
  getTypeColor,
  getTypeLabel,
  getTypeLightColor,
} from '../utils/workoutDisplay';

type AddMode = 'web-speech' | 'ai';
type InputMode = 'voice' | 'text';

export const History = () => {
  const location = useLocation();
  const contributeChallengeId = (location.state as any)?.contributeChallengeId;

  const [logs, setLogs] = useState<WorkoutLog[]>([]);
  const [selectedLog, setSelectedLog] = useState<WorkoutLog | null>(null);
  const [selectedDateForDetail, setSelectedDateForDetail] = useState<string | null>(null);
  const [isAdding, setIsAdding] = useState(false);
  const [inputMode, setInputMode] = useState<InputMode>('voice');
  const [addMode, setAddMode] = useState<AddMode>('web-speech');
  const [recordingState, setRecordingState] = useState<RecordingState>('idle');
  const [textInput, setTextInput] = useState('');
  const [editableText, setEditableText] = useState('');
  const [workouts, setWorkouts] = useState<Workout[]>([]);
  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  const [dateMode, setDateMode] = useState<'today' | 'custom'>('today');
  const [isPrivate, setIsPrivate] = useState(false); // ë‚˜ë§Œ ë³´ê¸° ì„¤ì •
  const [isAddingMore, setIsAddingMore] = useState(false); // ë” ì¶”ê°€í•˜ê¸° ëª¨ë“œ

  const webSpeech = useSpeechRecognition();
  const whisper = useWhisperRecording();

  useEffect(() => {
    loadLogs();
    // If coming from challenge page, auto-open add mode
    if (contributeChallengeId) {
      setIsAdding(true);
    }
  }, [contributeChallengeId]);

  const loadLogs = async () => {
    const allLogs = await getAllLogs();
    setLogs(allLogs);
  };

  const handleDelete = async (id: string) => {
    if (confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      try {
        await deleteLog(id);
        await loadLogs();
        if (selectedLog?.id === id) {
          setSelectedLog(null);
        }
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }
  };

  const handleMicClick = async () => {
    console.log('[History] handleMicClick - State:', recordingState, 'Mode:', addMode, 'IsAddingMore:', isAddingMore);

    if (recordingState === 'idle') {
      if (!isAddingMore) {
        // ìƒˆë¡œ ë…¹ìŒ ì‹œì‘ (ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”)
        webSpeech.resetTranscript();
      }
      setRecordingState('listening');

      if (addMode === 'web-speech') {
        webSpeech.startListening();
      } else {
        webSpeech.startListening();
        await whisper.startRecording();
      }
    } else if (recordingState === 'listening') {
      setRecordingState('transcribing');

      if (addMode === 'web-speech') {
        webSpeech.stopListening();
        setTimeout(() => {
          const finalText = webSpeech.transcript.trim();
          console.log('[History] Web Speech final text:', finalText);

          // ë” ì¶”ê°€í•˜ê¸° ëª¨ë“œë©´ ê¸°ì¡´ í…ìŠ¤íŠ¸ì— ì¶”ê°€
          const updatedText = isAddingMore && editableText
            ? `${editableText}, ${finalText}`
            : finalText;

          setEditableText(updatedText);
          setIsAddingMore(false); // ì¶”ê°€ ì™„ë£Œ, ëª¨ë“œ í•´ì œ
          handleParse(updatedText, false);
        }, 500);
      } else {
        webSpeech.stopListening();
        const whisperResult = await whisper.stopRecording();
        console.log('[History] Whisper final text:', whisperResult);

        // ë” ì¶”ê°€í•˜ê¸° ëª¨ë“œë©´ ê¸°ì¡´ í…ìŠ¤íŠ¸ì— ì¶”ê°€
        const updatedText = isAddingMore && editableText
          ? `${editableText}, ${whisperResult}`
          : whisperResult;

        setEditableText(updatedText);
        setIsAddingMore(false); // ì¶”ê°€ ì™„ë£Œ, ëª¨ë“œ í•´ì œ
        handleParse(updatedText, true);
      }
    }
  };

  const handleTextSubmit = () => {
    if (!textInput.trim()) {
      alert('ìš´ë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    setEditableText(textInput);
    handleParse(textInput, addMode === 'ai');
  };

  const handleParse = async (text: string, useAI: boolean) => {
    console.log('[History] handleParse - useAI:', useAI, 'text:', text);
    setRecordingState('parsing');

    try {
      if (useAI) {
        console.log('[History] Using AI mode (GPT parsing)');
        const parsed = await parseWithGPT(text);
        console.log('[History] GPT parsing result:', parsed);
        setWorkouts(parsed);
      } else {
        console.log('[History] Using rule-based parsing');
        setTimeout(() => {
          const normalized = normalizeText(text);
          console.log('[History] Normalized text:', normalized);
          const parsed = parseWorkoutText(normalized);
          console.log('[History] Rule-based parsing result:', parsed);
          setWorkouts(parsed);
          setRecordingState('review');
        }, 300);
        return;
      }
      setRecordingState('review');
    } catch (err) {
      console.error('[History] Parsing error:', err);
      alert(`íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${err instanceof Error ? err.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
      setRecordingState('idle');
    }
  };

  const handleReparse = () => {
    handleParse(editableText, addMode === 'ai');
  };

  const handleRestartRecording = () => {
    // ë‹¤ì‹œ ë§í•˜ê¸°: idle ìƒíƒœë¡œ ëŒì•„ê°€ì„œ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë…¹ìŒ
    setRecordingState('idle');
    setEditableText('');
    setWorkouts([]);
    setIsAddingMore(false);
    webSpeech.resetTranscript();
  };

  const handleAddMore = () => {
    // ë” ì¶”ê°€í•˜ê¸°: ê¸°ì¡´ ë‚´ìš© ìœ ì§€í•˜ê³  idleë¡œ ëŒì•„ê°€ì„œ ì¶”ê°€ ë…¹ìŒ
    setRecordingState('idle');
    setIsAddingMore(true); // ì¶”ê°€ ëª¨ë“œ í™œì„±í™”
    webSpeech.resetTranscript(); // transcriptë§Œ ì´ˆê¸°í™”, editableTextëŠ” ìœ ì§€
  };

  const handleSave = async () => {
    if (!editableText.trim()) {
      alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // Use selected date (or today if in 'today' mode)
    const actualDate = dateMode === 'today' ? new Date() : selectedDate;
    const dateString = formatDate(actualDate);

    const log = {
      date: dateString,
      rawText: editableText,
      normalizedText: addMode === 'ai' ? editableText : normalizeText(editableText),
      workouts,
      memo: null,
      createdAt: Date.now(),
      isPrivate, // ë‚˜ë§Œ ë³´ê¸° ì„¤ì • í¬í•¨
    };

    try {
      const savedLog = await saveLog(log);

      // If coming from challenge page, contribute to challenge
      if (contributeChallengeId && savedLog?.id) {
        try {
          await challengeService.contributeToChallenge(contributeChallengeId, savedLog.id);
          alert('ì €ì¥ë˜ì—ˆê³  ì±Œë¦°ì§€ì— ê¸°ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (error) {
          alert(`ì €ì¥ë˜ì—ˆì§€ë§Œ ì±Œë¦°ì§€ ê¸°ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
      } else {
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }

      // Reset only recording-related states, keep isAdding and selectedDate
      setRecordingState('idle');
      setInputMode('voice');
      setTextInput('');
      setEditableText('');
      setWorkouts([]);
      setIsAddingMore(false);
      webSpeech.resetTranscript();

      await loadLogs();
    } catch (err) {
      alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };

  const handleCompleteAdding = () => {
    setIsAdding(false);
    setRecordingState('idle');
    setInputMode('voice');
    setTextInput('');
    setEditableText('');
    setWorkouts([]);
    setSelectedDate(new Date());
    setDateMode('today');
    setIsPrivate(false);
    setIsAddingMore(false);
    webSpeech.resetTranscript();
  };

  const formatDateDisplay = (dateStr: string) => {
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const weekday = weekdays[date.getDay()];
    return `${year}ë…„ ${month}ì›” ${day}ì¼ (${weekday})`;
  };

  const groupByDate = (logs: WorkoutLog[]) => {
    const grouped: Record<string, WorkoutLog[]> = {};
    logs.forEach((log) => {
      if (!grouped[log.date]) {
        grouped[log.date] = [];
      }
      grouped[log.date].push(log);
    });
    return grouped;
  };

  // ë‚ ì§œë³„ ìš´ë™ í†µê³„ ê³„ì‚°
  const calculateDayStats = (logs: WorkoutLog[]) => {
    const allWorkouts = logs.flatMap(log => log.workouts);
    const totalWorkouts = allWorkouts.length;
    const totalSets = allWorkouts.reduce((sum, w) => sum + (w.sets || 0), 0);
    const totalDuration = allWorkouts.reduce((sum, w) => sum + (w.duration_min || 0), 0);

    // ìš´ë™ ì¢…ë¥˜ë³„ ì¹´ìš´íŠ¸
    const workoutTypes = new Map<string, number>();
    allWorkouts.forEach(w => {
      workoutTypes.set(w.name, (workoutTypes.get(w.name) || 0) + 1);
    });

    // ê°€ì¥ ë§ì´ í•œ ìš´ë™ 3ê°œ
    const topWorkouts = Array.from(workoutTypes.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([name]) => name);

    return {
      totalWorkouts,
      totalSets,
      totalDuration,
      topWorkouts,
      uniqueWorkouts: workoutTypes.size,
    };
  };

  const groupedLogs = groupByDate(logs);
  const dates = Object.keys(groupedLogs).sort((a, b) => b.localeCompare(a));

  // Adding Mode
  if (isAdding) {
    const displayDate = dateMode === 'today' ? new Date() : selectedDate;
    const formattedDisplayDate = `${displayDate.getFullYear()}ë…„ ${displayDate.getMonth() + 1}ì›” ${displayDate.getDate()}ì¼`;

    return (
      <div className="container">
        <div className="header">
          <h1>ìš´ë™ ì¶”ê°€</h1>
          <button className="complete-button" onClick={handleCompleteAdding}>
            âœ“ ì™„ë£Œ
          </button>
        </div>

        {recordingState === 'idle' && (
          <>
            <div className="date-selector-section">
              <h3>ë‚ ì§œ ì„ íƒ</h3>
              <div className="date-mode-buttons">
                <button
                  className={`date-mode-button ${dateMode === 'today' ? 'active' : ''}`}
                  onClick={() => {
                    setDateMode('today');
                    setSelectedDate(new Date());
                  }}
                >
                  ì˜¤ëŠ˜
                </button>
                <button
                  className={`date-mode-button ${dateMode === 'custom' ? 'active' : ''}`}
                  onClick={() => setDateMode('custom')}
                >
                  ë‹¤ë¥¸ ë‚ ì§œ
                </button>
              </div>
              {dateMode === 'custom' && (
                <input
                  type="date"
                  className="date-picker"
                  value={formatDate(selectedDate)}
                  onChange={(e) => setSelectedDate(new Date(e.target.value))}
                />
              )}
              <div className="selected-date-display">
                ì„ íƒëœ ë‚ ì§œ: <strong>{formattedDisplayDate}</strong>
              </div>
            </div>

            <div className="input-mode-selector">
              <button
                className={`input-mode-button ${inputMode === 'voice' ? 'active' : ''}`}
                onClick={() => setInputMode('voice')}
              >
                ğŸ¤ ìŒì„± ì…ë ¥
              </button>
              <button
                className={`input-mode-button ${inputMode === 'text' ? 'active' : ''}`}
                onClick={() => setInputMode('text')}
              >
                âœï¸ í…ìŠ¤íŠ¸ ì…ë ¥
              </button>
            </div>

            <div className="mode-selector">
              <button
                className={`mode-button ${addMode === 'web-speech' ? 'active' : ''}`}
                onClick={() => setAddMode('web-speech')}
              >
                ê¸°ë³¸ (ë¬´ë£Œ)
              </button>
              <button
                className={`mode-button ${addMode === 'ai' ? 'active' : ''}`}
                onClick={() => setAddMode('ai')}
              >
                AI (ìœ ë£Œ)
              </button>
            </div>
            <div className="mode-description">
              {addMode === 'web-speech' ? (
                <p>ë¸Œë¼ìš°ì € ë‚´ì¥ ìŒì„± ì¸ì‹ + ë£° ê¸°ë°˜ íŒŒì‹±</p>
              ) : (
                <p>Whisper ìŒì„± ì¸ì‹ + GPT ìŠ¤ë§ˆíŠ¸ íŒŒì‹±</p>
              )}
            </div>
          </>
        )}

        {inputMode === 'voice' && recordingState === 'idle' && (
          <div className="recording-section">
            <div className="status-text">ìš´ë™ ê¸°ë¡ì„ ë§ì”€í•´ì£¼ì„¸ìš”</div>
            <div className="input-guide">
              <div className="guide-item">ìš´ë™ì´ë¦„</div>
              <div className="guide-separator">/</div>
              <div className="guide-item">ê°•ë„ (ë¬´ê²Œ/ì†ë„/RPM)</div>
              <div className="guide-separator">/</div>
              <div className="guide-item">ì„¸íŠ¸ x íšŒìˆ˜ or ë¶„</div>
              <div className="guide-separator">/</div>
              <div className="guide-item">ë‚œì´ë„ (1~10)</div>
            </div>
            <div className="guide-note">
              â€» ë‚œì´ë„: 1 (ë§¤ìš° ì‰¬ì›€) ~ 10 (ë§¤ìš° ì–´ë ¤ì›€)
            </div>
            <div className="guide-example">
              ì˜ˆ: "ë²¤ì¹˜í”„ë ˆìŠ¤ 60kg 3ì„¸íŠ¸ 10íšŒ ë‚œì´ë„ 7"
            </div>
            <button className="mic-button" onClick={handleMicClick}>
              <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
              </svg>
            </button>
            <div className="hint-text">íƒ­í•˜ì—¬ ë…¹ìŒ ì‹œì‘</div>
          </div>
        )}

        {inputMode === 'text' && recordingState === 'idle' && (
          <div className="text-input-section">
            <div className="status-text">ìš´ë™ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
            <div className="input-guide">
              <div className="guide-item">ìš´ë™ì´ë¦„</div>
              <div className="guide-separator">/</div>
              <div className="guide-item">ê°•ë„ (ë¬´ê²Œ/ì†ë„/RPM)</div>
              <div className="guide-separator">/</div>
              <div className="guide-item">ì„¸íŠ¸ x íšŒìˆ˜ or ë¶„</div>
              <div className="guide-separator">/</div>
              <div className="guide-item">ë‚œì´ë„ (1~10)</div>
            </div>
            <div className="guide-note">
              â€» ë‚œì´ë„: 1 (ë§¤ìš° ì‰¬ì›€) ~ 10 (ë§¤ìš° ì–´ë ¤ì›€)
            </div>
            <textarea
              className="text-input-area"
              value={textInput}
              onChange={(e) => setTextInput(e.target.value)}
              placeholder="ì˜ˆ: ë²¤ì¹˜í”„ë ˆìŠ¤ 60kg 3ì„¸íŠ¸ 10íšŒ ë‚œì´ë„ 7, ìŠ¤ì¿¼íŠ¸ 80kg 4ì„¸íŠ¸ 8íšŒ ë‚œì´ë„ 8"
              rows={6}
            />
            <button className="primary-button" onClick={handleTextSubmit}>
              íŒŒì‹±í•˜ê¸°
            </button>
            <div className="hint-text">ììœ ë¡­ê²Œ ì…ë ¥í•˜ì‹œë©´ AIê°€ ì •ë¦¬í•´ë“œë¦½ë‹ˆë‹¤</div>
          </div>
        )}

        {recordingState === 'listening' && (
          <div className="recording-section">
            <div className="status-text listening">
              {addMode === 'ai' ? 'ğŸ¤ AI ë…¹ìŒ ì¤‘...' : 'ë“£ëŠ” ì¤‘...'}
            </div>
            <button className="mic-button active" onClick={handleMicClick}>
              <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="6" width="12" height="12" />
              </svg>
            </button>
            <div className="hint-text">íƒ­í•˜ì—¬ ë…¹ìŒ ì¢…ë£Œ</div>

            {(webSpeech.transcript || webSpeech.interimTranscript) && (
              <div className="transcript-box">
                {addMode === 'ai' && (
                  <div className="ai-preview-label">
                    ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° (AIê°€ ë‹¤ì‹œ ì²˜ë¦¬í•©ë‹ˆë‹¤)
                  </div>
                )}
                <div className="transcript-final">{webSpeech.transcript}</div>
                {webSpeech.interimTranscript && (
                  <div className="transcript-interim">{webSpeech.interimTranscript}</div>
                )}
              </div>
            )}
          </div>
        )}

        {(recordingState === 'transcribing' || recordingState === 'parsing') && (
          <div className="recording-section">
            <div className="status-text">
              {recordingState === 'transcribing' ? 'í…ìŠ¤íŠ¸ ì²˜ë¦¬ ì¤‘...' : 'ìš´ë™ ê¸°ë¡ ë¶„ì„ ì¤‘...'}
            </div>
            <div className="spinner"></div>
          </div>
        )}

        {recordingState === 'review' && (
          <div className="review-section">
            <h2>ê¸°ë¡ í™•ì¸</h2>
            <div className="selected-date-display">
              ì €ì¥ë  ë‚ ì§œ: <strong>{formattedDisplayDate}</strong>
            </div>

            <div className="section">
              <h3>ì›ë¬¸ (í¸ì§‘ ê°€ëŠ¥)</h3>
              <textarea
                className="edit-textarea"
                value={editableText}
                onChange={(e) => setEditableText(e.target.value)}
                rows={5}
              />
              <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                <button className="secondary-button" onClick={handleReparse}>
                  ğŸ”„ ì¬ì •ë¦¬
                </button>
                <button className="secondary-button" onClick={handleRestartRecording}>
                  ğŸ¤ ë‹¤ì‹œ ë§í•˜ê¸°
                </button>
                {inputMode === 'voice' && (
                  <button className="secondary-button" onClick={handleAddMore}>
                    â• ë” ì¶”ê°€í•˜ê¸°
                  </button>
                )}
              </div>
              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginTop: '8px' }}>
                ğŸ’¡ í…ìŠ¤íŠ¸ ìˆ˜ì • í›„ "ì¬ì •ë¦¬" | ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë…¹ìŒí•˜ë ¤ë©´ "ë‹¤ì‹œ ë§í•˜ê¸°" | ì´ì–´ì„œ ë…¹ìŒí•˜ë ¤ë©´ "ë” ì¶”ê°€í•˜ê¸°"
              </div>
            </div>

            <div className="section">
              <h3>ìš´ë™ ê¸°ë¡ ({workouts.length}ê°œ)</h3>
              {workouts.length === 0 ? (
                <p className="empty-message">ìš´ë™ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
              ) : (
                <div className="workout-cards">
                  {workouts.map((workout, idx) => {
                    const categoryIcon = getCategoryIcon(workout.category);
                    const typeColor = getTypeColor(workout.type);
                    const typeLabel = getTypeLabel(workout.type);
                    const typeLightColor = getTypeLightColor(workout.type);

                    return (
                      <div
                        key={idx}
                        style={{
                          border: `2px solid ${typeColor}`,
                          backgroundColor: typeLightColor,
                          borderRadius: '8px',
                          padding: '12px',
                          position: 'relative',
                          transition: 'all 0.2s ease',
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                          <div style={{ fontSize: '20px' }}>{categoryIcon}</div>
                          <div className="workout-name">{workout.name}</div>
                          <div
                            style={{
                              display: 'inline-block',
                              padding: '2px 8px',
                              borderRadius: '4px',
                              fontSize: '11px',
                              fontWeight: '600',
                              backgroundColor: typeColor,
                              color: 'white',
                              marginLeft: 'auto',
                            }}
                          >
                            {typeLabel}
                          </div>
                        </div>
                        <div className="workout-details">
                          {workout.distance_km && <span className="distance">{workout.distance_km} km</span>}
                          {workout.pace && <span className="pace">{workout.pace} /km</span>}
                          {workout.weight_kg && <span className="weight">{workout.weight_kg} kg</span>}
                          {workout.sets && <span>{workout.sets} ì„¸íŠ¸</span>}
                          {workout.reps && <span>{workout.reps} íšŒ</span>}
                          {workout.duration_min && <span>{workout.duration_min} ë¶„</span>}
                          {!workout.sets && !workout.reps && !workout.duration_min && !workout.weight_kg && !workout.distance_km && !workout.pace && (
                            <span className="no-details">ìƒì„¸ ì •ë³´ ì—†ìŒ</span>
                          )}
                        </div>
                        {workout.note && <div className="workout-note">{workout.note}</div>}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            <div className="section">
              <h3>ê³µìœ  ì„¤ì •</h3>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: 'var(--card-bg)', borderRadius: '8px' }}>
                <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', flex: 1 }}>
                  <input
                    type="checkbox"
                    checked={isPrivate}
                    onChange={(e) => setIsPrivate(e.target.checked)}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span>ğŸ”’ ë‚˜ë§Œ ë³´ê¸°</span>
                </label>
                <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                  {isPrivate ? 'ì´ ê¸°ë¡ì€ ë‚˜ì—ê²Œë§Œ ë³´ì…ë‹ˆë‹¤' : 'í´ëŸ½ ë©¤ë²„ë“¤ì´ ì´ ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤'}
                </div>
              </div>
            </div>

            <div className="action-buttons">
              <button className="primary-button" onClick={handleSave}>
                ğŸ’¾ ì €ì¥í•˜ê³  ê³„ì† ì¶”ê°€
              </button>
            </div>
            <div className="hint-text">ì €ì¥ í›„ ê°™ì€ ë‚ ì§œì— ìš´ë™ì„ ê³„ì† ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
          </div>
        )}
      </div>
    );
  }

  // Detail View - ë‚ ì§œë³„ ìƒì„¸
  if (selectedDateForDetail) {
    const dayLogs = groupedLogs[selectedDateForDetail];
    const stats = calculateDayStats(dayLogs);
    const allWorkouts = dayLogs.flatMap(log => log.workouts);

    return (
      <div className="container">
        <div className="header">
          <button className="back-button" onClick={() => setSelectedDateForDetail(null)}>
            â† ë’¤ë¡œ
          </button>
          <h2>ìš´ë™ ê¸°ë¡ ìƒì„¸</h2>
        </div>

        <div className="detail-section">
          <div className="detail-date">{formatDateDisplay(selectedDateForDetail)}</div>

          {/* í†µê³„ ìš”ì•½ */}
          <div className="detail-stats-summary">
            <div className="detail-stat">
              <span className="detail-stat-label">ì´ ìš´ë™</span>
              <span className="detail-stat-value">{stats.totalWorkouts}ê°œ</span>
            </div>
            <div className="detail-stat">
              <span className="detail-stat-label">ì¢…ëª© ìˆ˜</span>
              <span className="detail-stat-value">{stats.uniqueWorkouts}ê°œ</span>
            </div>
            {stats.totalSets > 0 && (
              <div className="detail-stat">
                <span className="detail-stat-label">ì´ ì„¸íŠ¸</span>
                <span className="detail-stat-value">{stats.totalSets}ì„¸íŠ¸</span>
              </div>
            )}
            {stats.totalDuration > 0 && (
              <div className="detail-stat">
                <span className="detail-stat-label">ì´ ì‹œê°„</span>
                <span className="detail-stat-value">{stats.totalDuration}ë¶„</span>
              </div>
            )}
          </div>

          {/* ëª¨ë“  ìš´ë™ í‘œì‹œ */}
          <div className="section">
            <h3>ìš´ë™ ê¸°ë¡ ({allWorkouts.length}ê°œ)</h3>
            <div className="workout-cards">
              {allWorkouts.map((workout, idx) => {
                const categoryIcon = getCategoryIcon(workout.category);
                const typeColor = getTypeColor(workout.type);
                const typeLabel = getTypeLabel(workout.type);
                const typeLightColor = getTypeLightColor(workout.type);

                return (
                  <div
                    key={idx}
                    style={{
                      border: `2px solid ${typeColor}`,
                      backgroundColor: typeLightColor,
                      borderRadius: '8px',
                      padding: '12px',
                      position: 'relative',
                      transition: 'all 0.2s ease',
                    }}
                  >
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <div style={{ fontSize: '20px' }}>{categoryIcon}</div>
                      <div className="workout-name">{workout.name}</div>
                      <div
                        style={{
                          display: 'inline-block',
                          padding: '2px 8px',
                          borderRadius: '4px',
                          fontSize: '11px',
                          fontWeight: '600',
                          backgroundColor: typeColor,
                          color: 'white',
                          marginLeft: 'auto',
                        }}
                      >
                        {typeLabel}
                      </div>
                    </div>
                    <div className="workout-details">
                      {workout.distance_km && <span className="distance">{workout.distance_km} km</span>}
                      {workout.pace && <span className="pace">{workout.pace} /km</span>}
                      {workout.weight_kg && <span className="weight">{workout.weight_kg} kg</span>}
                      {workout.sets && <span>{workout.sets} ì„¸íŠ¸</span>}
                      {workout.reps && <span>{workout.reps} íšŒ</span>}
                      {workout.duration_min && <span>{workout.duration_min} ë¶„</span>}
                      {!workout.sets && !workout.reps && !workout.duration_min && !workout.weight_kg && !workout.distance_km && !workout.pace && (
                        <span className="no-details">ìƒì„¸ ì •ë³´ ì—†ìŒ</span>
                      )}
                    </div>
                    {workout.note && <div className="workout-note">{workout.note}</div>}
                  </div>
                );
              })}
            </div>
          </div>

          {/* ì„¸ì…˜ë³„ ì›ë¬¸ */}
          <div className="section">
            <h3>ì…ë ¥ ë‚´ìš© ({dayLogs.length}ê°œ ì„¸ì…˜)</h3>
            {dayLogs.map((log) => (
              <div key={log.id} className="session-raw-text">
                <div className="session-header">
                  <span className="session-time">
                    {new Date(log.createdAt).toLocaleTimeString('ko-KR', {
                      hour: '2-digit',
                      minute: '2-digit',
                    })}
                  </span>
                  <button
                    className="delete-session-button"
                    onClick={() => handleDelete(log.id)}
                  >
                    ì‚­ì œ
                  </button>
                </div>
                <div className="detail-text">{log.rawText}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // Detail View - ê°œë³„ ë¡œê·¸ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
  if (selectedLog) {
    return (
      <div className="container">
        <div className="header">
          <button className="back-button" onClick={() => setSelectedLog(null)}>
            â† ë’¤ë¡œ
          </button>
          <h2>ìš´ë™ ê¸°ë¡ ìƒì„¸</h2>
        </div>

        <div className="detail-section">
          <div className="detail-date">{formatDateDisplay(selectedLog.date)}</div>

          <div className="section">
            <h3>ì›ë¬¸</h3>
            <div className="detail-text">{selectedLog.rawText}</div>
          </div>

          {selectedLog.workouts.length > 0 && (
            <div className="section">
              <h3>ìš´ë™ ê¸°ë¡ ({selectedLog.workouts.length}ê°œ)</h3>
              <div className="workout-cards">
                {selectedLog.workouts.map((workout, idx) => {
                  const categoryIcon = getCategoryIcon(workout.category);
                  const typeColor = getTypeColor(workout.type);
                  const typeLabel = getTypeLabel(workout.type);
                  const typeLightColor = getTypeLightColor(workout.type);

                  return (
                    <div
                      key={idx}
                      style={{
                        border: `2px solid ${typeColor}`,
                        backgroundColor: typeLightColor,
                        borderRadius: '8px',
                        padding: '12px',
                        position: 'relative',
                        transition: 'all 0.2s ease',
                      }}
                    >
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                        <div style={{ fontSize: '20px' }}>{categoryIcon}</div>
                        <div className="workout-name">{workout.name}</div>
                        <div
                          style={{
                            display: 'inline-block',
                            padding: '2px 8px',
                            borderRadius: '4px',
                            fontSize: '11px',
                            fontWeight: '600',
                            backgroundColor: typeColor,
                            color: 'white',
                            marginLeft: 'auto',
                          }}
                        >
                          {typeLabel}
                        </div>
                      </div>
                      <div className="workout-details">
                        {workout.weight_kg && <span className="weight">{workout.weight_kg} kg</span>}
                        {workout.sets && <span>{workout.sets} ì„¸íŠ¸</span>}
                        {workout.reps && <span>{workout.reps} íšŒ</span>}
                        {workout.duration_min && <span>{workout.duration_min} ë¶„</span>}
                        {!workout.sets && !workout.reps && !workout.duration_min && !workout.weight_kg && (
                          <span className="no-details">ìƒì„¸ ì •ë³´ ì—†ìŒ</span>
                        )}
                      </div>
                      {workout.note && <div className="workout-note">{workout.note}</div>}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          <button className="delete-button" onClick={() => handleDelete(selectedLog.id)}>
            ì‚­ì œ
          </button>
        </div>
      </div>
    );
  }

  // Main View - ë‚ ì§œ ì¹´ë“œ ì¤‘ì‹¬
  return (
    <div className="container">
      <div className="header">
        <h1>íˆìŠ¤í† ë¦¬</h1>
        <button className="add-button" onClick={() => setIsAdding(true)}>
          + ì¶”ê°€
        </button>
      </div>

      {logs.length === 0 ? (
        <div className="empty-state">
          <p>ì•„ì§ ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          <button className="primary-button" onClick={() => setIsAdding(true)}>
            ìš´ë™ ê¸°ë¡ ì¶”ê°€í•˜ê¸°
          </button>
        </div>
      ) : (
        <div className="history-day-cards">
          {dates.map((date) => {
            const dayLogs = groupedLogs[date];
            const stats = calculateDayStats(dayLogs);

            return (
              <div
                key={date}
                className="day-card-compact"
                onClick={() => setSelectedDateForDetail(date)}
              >
                <div className="day-card-top">
                  <div className="day-info">
                    <div className="day-date-short">
                      {new Date(date).getDate()}
                    </div>
                    <div className="day-month-year">
                      {new Date(date).getMonth() + 1}ì›”
                    </div>
                  </div>
                  <div className="day-summary">
                    <div className="day-title">
                      {['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][new Date(date).getDay()]}ìš”ì¼
                    </div>
                    <div className="day-stats-inline">
                      <span className="stat-chip">{stats.totalWorkouts}ê°œ ìš´ë™</span>
                      <span className="stat-chip">{stats.uniqueWorkouts}ì¢…ëª©</span>
                      {stats.totalSets > 0 && (
                        <span className="stat-chip">{stats.totalSets}ì„¸íŠ¸</span>
                      )}
                    </div>
                  </div>
                  <div className="day-arrow">â€º</div>
                </div>

                <div className="day-workouts-preview">
                  {stats.topWorkouts.slice(0, 4).map((workout, idx) => (
                    <span key={idx} className="workout-chip">
                      {workout}
                    </span>
                  ))}
                  {stats.uniqueWorkouts > 4 && (
                    <span className="workout-chip-more">
                      +{stats.uniqueWorkouts - 4}
                    </span>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
};
</file>

</files>
